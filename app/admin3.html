<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v33.1 (Import Fix)</title>
    <!-- 
      DeliveryMaster Admin App v33.1 (Import Fix)
      
      Changelog:
      - v33.1 (FIX):
        - Changed Firebase SDK import URLs to be protocol-relative (//gstatic.com...) 
          to fix module resolution errors in the preview environment.
      - v33 (Final Upgrade):
        - שדרוג מלא למערכת הזמנה חדשה, כולל שם פרויקט.
        - הטמעה מלאה של שיתוף אוטומטי ל-WhatsApp לאחר יצירת הזמנה.
        - אימות ואיחוד מערכת תקשורת דו-כיוונית (מנהל ↔ לקוח).
        - שימוש בקונפיגורציית Firebase הנכונה (saban94-78949).
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        .tab-link { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-link.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        .panel { display: none; }
        .panel.active { display: block; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1001; }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background-color: #ef4444; /* red-500 */
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            display: none; /* מוסתר כברירת מחדל */
        }
        .message-card.unread {
            background-color: #fefce8; /* yellow-50 */
            border-right: 4px solid #facc15; /* yellow-400 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Modal (Generic) -->
    <div id="modal" class="modal-overlay hidden" onclick="closeModal()">
        <div class="modal-content bg-white w-11/12 md:w-1/2 lg:w-1/3 rounded-lg shadow-xl" onclick="event.stopPropagation()">
            <div id="modal-content-inner">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Modal: שלח תשובה/התראה ללקוח -->
    <div id="reply-modal" class="modal-overlay hidden" onclick="closeReplyModal()">
        <div class="modal-content bg-white w-11/12 md:w-1/2 lg:w-1/3 rounded-lg shadow-xl" onclick="event.stopPropagation()">
            <div class="p-6">
                <h3 class="text-lg font-semibold mb-4">שלח התראה ללקוח</h3>
                <p class="text-sm text-gray-600 mb-2">עבור הזמנה: <strong id="reply-modal-order-id"></strong></p>
                <p class="text-sm text-gray-600 mb-4">לקוח: <strong id="reply-modal-customer-name"></strong></p>
                
                <textarea id="reply-message-text" rows="4" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="הקלד את תוכן ההתראה כאן (למשל: 'ההזמנה אושרה')"></textarea>
                
                <input type="hidden" id="reply-modal-doc-id">
                <input type="hidden" id="reply-modal-msg-id">

                <div class="flex justify-end gap-3 mt-4">
                    <button onclick="closeReplyModal()" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">ביטול</button>
                    <button onclick="sendAdminReply()" class="py-2 px-4 bg-blue-500 text-white rounded-md hover:bg-blue-600">שלח התראה</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-5 left-5 z-[5000]"></div>

    <!-- Header -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">DeliveryMaster v33.1</h1>
        <div class="flex items-center gap-4">
            <!-- כפתור פעמון התראות -->
            <button onclick="showPanelTab('messages-panel')" class="relative text-gray-600 hover:text-blue-500" aria-label="הודעות">
                <i class="fas fa-bell fa-lg"></i>
                <span id="notification-badge" class="notification-badge">0</span>
            </button>
            <button onclick="sendGlobalPing()" class="text-sm bg-blue-500 text-white py-2 px-3 rounded-md hover:bg-blue-600">
                <i class="fas fa-tower-broadcast"></i> Ping
            </button>
            <button onclick="document.location.reload()" class="text-sm bg-gray-200 text-gray-700 py-2 px-3 rounded-md hover:bg-gray-300">
                <i class="fas fa-sync-alt"></i> רענן
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-4 md:p-6">
        
        <!-- Tabs Navigation -->
        <nav class="bg-white rounded-t-lg shadow-sm flex border-b border-gray-200">
            <a id="tab-orders" class="tab-link active" onclick="showPanelTab('orders-panel')">
                <i class="fas fa-shipping-fast"></i> הזמנות (<span id="active-orders-count">0</span>)
            </a>
            <a id="tab-customers" class="tab-link" onclick="showPanelTab('customers-panel')">
                <i class="fas fa-users"></i> לקוחות (<span id="customers-count">0</span>)
            </a>
            <!-- טאב הודעות -->
            <a id="tab-messages" class="tab-link" onclick="showPanelTab('messages-panel')">
                <i class="fas fa-envelope"></i> הודעות מלקוחות
            </a>
            <a id="tab-new-order" class="tab-link" onclick="showPanelTab('new-order-panel')">
                <i class="fas fa-plus-circle"></i> הזמנה חדשה
            </a>
            <a id="tab-logs" class="tab-link" onclick="showPanelTab('logs-panel')">
                <i class="fas fa-clipboard-list"></i> לוגים
            </a>
        </nav>

        <!-- Panels Container -->
        <div class="bg-white rounded-b-lg shadow-lg p-4 md:p-6">
            
            <!-- Panel 1: Orders -->
            <div id="orders-panel" class="panel active">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">הזמנות פעילות</h2>
                    <input type="text" id="orders-search" class="border p-2 rounded-md" placeholder="חיפוש הזמנה..." onkeyup="filterLists()">
                </div>
                <div id="orders-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p id="orders-loading">טוען הזמנות...</p>
                    <!-- Order cards will be injected here -->
                </div>
            </div>

            <!-- Panel 2: Customers -->
            <div id="customers-panel" class="panel">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">רשימת לקוחות</h2>
                    <input type="text" id="customers-search" class="border p-2 rounded-md" placeholder="חיפוש לקוח..." onkeyup="filterLists()">
                </div>
                <div id="customers-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p id="customers-loading">טוען לקוחות...</p>
                    <!-- Customer cards will be injected here -->
                </div>
            </div>

            <!-- Panel 3: הודעות מלקוחות -->
            <div id="messages-panel" class="panel">
                <h2 class="text-xl font-semibold mb-4">הודעות חדשות מלקוחות</h2>
                <div id="messages-list" class="flex flex-col gap-4">
                    <p id="messages-loading">טוען הודעות...</p>
                    <!-- Message cards will be injected here -->
                </div>
            </div>

            <!-- Panel 4: New Order (עם שדות משודרגים) -->
            <div id="new-order-panel" class="panel">
                <h2 class="text-xl font-semibold mb-4">יצירת הזמנה חדשה</h2>
                <form id="new-order-form" class="space-y-4 max-w-lg mx-auto">
                    <div>
                        <label for="order-customer-id" class="block text-sm font-medium text-gray-700">בחר לקוח קיים</label>
                        <select id="order-customer-id" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" onchange="fillCustomerData(this.value)">
                            <option value="">-- בחר לקוח --</option>
                            <!-- Customer options will be injected here -->
                        </select>
                    </div>
                    <div>
                        <label for="order-customer-name" class="block text-sm font-medium text-gray-700">שם לקוח (חובה)</label>
                        <input type="text" id="order-customer-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="order-customer-phone" class="block text-sm font-medium text-gray-700">טלפון</label>
                        <input type="tel" id="order-customer-phone" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="order-customer-address" class="block text-sm font-medium text-gray-700">כתובת (חובה)</label>
                        <input type="text" id="order-customer-address" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="order-delivery-date" class="block text-sm font-medium text-gray-700">תאריך אספקה (חובה)</label>
                        <input type="date" id="order-delivery-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="order-delivery-time" class="block text-sm font-medium text-gray-700">שעת אספקה (רשות)</label>
                        <input type="time" id="order-delivery-time" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    
                    <!-- שדה חדש: שם פרויקט -->
                    <div>
                        <label for="order-project-name" class="block text-sm font-medium text-gray-700">שם פרויקט (רשות)</label>
                        <input type="text" id="order-project-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>

                    <div>
                        <!-- שינוי תווית -->
                        <label for="order-notes" class="block text-sm font-medium text-gray-700">תוכן ההזמנה (פריטים)</label>
                        <textarea id="order-notes" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="לדוגמה: 10 בלוק 20, 5 מלט..."></textarea>
                    </div>

                    <div>
                        <label for="order-warehouse" class="block text-sm font-medium text-gray-700">מחסן (חובה)</label>
                        <select id="order-warehouse" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                            <option value="">-- בחר מחסן --</option>
                            <option value="התלמיד">התלמיד</option>
                            <option value="החרש">החרש</option>
                            <option value="30-שארק">30-שארק</option>
                            <option value="אחר">אחר</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="order-delivery-type" class="block text-sm font-medium text-gray-700">סוג הובלה (חובה)</label>
                        <select id="order-delivery-type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                            <option value="">-- בחר סוג --</option>
                            <option value="משאית">משאית</option>
                            <option value="טריילר">טריילר</option>
                            <option value="מנוף">מנוף</option>
                            <option value="הצבת מכולה">הצבת מכולה</option>
                            <option value="פינוי מכולה">פינוי מכולה</option>
                            <option value="החלפת מכולה">החלפת מכולה</option>
                            <option value="איסוף עצמי">איסוף עצמי</option>
                            <option value="אחר">אחר</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="order-number-custom" class="block text-sm font-medium text-gray-700">מספר הזמנה (אם ריק יווצר אוטומטית)</label>
                        <input type="text" id="order-number-custom" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="למשל 6715504">
                    </div>
                    <div>
                        <label for="order-customer-number-custom" class="block text-sm font-medium text-gray-700">מספר לקוח (רשות)</label>
                        <input type="text" id="order-customer-number-custom" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="למשל 112233">
                    </div>

                    <div class="flex justify-end">
                        <button type="submit" class="py-2 px-6 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600">צור הזמנה ושלח ל-WhatsApp</button>
                    </div>
                </form>
            </div>

            <!-- Panel 5: Logs -->
            <div id="logs-panel" class="panel">
                <h2 class="text-xl font-semibold mb-4">לוג מערכת</h2>
                <div id="logs-list" class="h-96 overflow-y-auto bg-gray-800 text-white p-4 rounded-md font-mono text-sm">
                    <p>טוען לוגים...</p>
                    <!-- Log entries will be injected here -->
                </div>
            </div>

        </div>
    </main>
    
    <!-- 
      ==========================================================
      ===        שדרוג ל-Firebase v9 (Modular SDK)            ===
      ==========================================================
    -->
    <script type="module">
        /*
         ==========================================================
         ===         Firebase SDK v9 Imports (Modular)          ===
         ==========================================================
        */
        
        // --- 🚨 [FIX] Using protocol-relative URLs (//) to avoid module resolution errors ---
        import { initializeApp, getApps, getApp } from "//www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "//www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, 
            collection, query, where, Timestamp, runTransaction, getDocs, orderBy, 
            serverTimestamp, limit, writeBatch, collectionGroup
        } from "//www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { setLogLevel } from "//www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        /*
         ==========================================================
         ===             🚨 אינדקסים נדרשים ב-Firestore             ===
         ==========================================================
         *
         * 1. (Orders)
         * - Collection: orders
         * - Fields:
         * 1. order_id (Ascending)
         *
         * 2. (Messages - Admin Panel)
         * - Collection: messages (Collection Group)
         * - Fields:
         * 1. type (Ascending)
         * 2. readByViewer (Ascending)
         * 3. timestamp (Descending)
         *
         ==========================================================
        */

        // --- Global Variables ---
        let db, auth;
        let allOrders = [];
        let allCustomers = [];
        let logUnsubscribe = null;
        let ordersUnsubscribe = null;
        let customersUnsubscribe = null;
        let messagesUnsubscribe = null;
        let currentUserId = null;

        // --- Firebase Config & Auth ---
        // שדרוג: שימוש בקונפיגורציה של פרויקט saban94-78949
        const fallbackConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949",
          storageBucket: "saban94-78949.firebasestorage.app", 
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a", 
          measurementId: "G-XV6RZDESSB"
        };
        
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(fallbackConfig));
        
        try {
            const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');
            console.log("Firebase Initialized (Project: saban94-78949).");
            
            // --- Authentication ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log("User Signed In:", currentUserId);
                    SmartLog.info("Admin user signed in", "Auth.SignIn");
                    // User is signed in, fetch all data
                    attachAllListeners();
                } else {
                    // No user, try to sign in
                    console.log("No user. Trying auth...");
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        SmartLog.error(error, "Auth.SignInFailed");
                        console.error("Firebase Auth Error:", error);
                    }
                }
            });

        } catch (e) {
            console.error("Firebase Initialization Failed:", e);
            SmartLog.error(e, "App.Init");
            showToast('שגיאת התחברות חמורה ל-Firebase', 'error');
        }

        // --- Smart Logging Utility ---
        const SmartLog = {
            async info(message, category = "General", context = {}) {
                console.log(`[INFO | ${category}]: ${message}`, context);
                await this._logToFirestore("info", message, category, context);
            },
            async warn(message, category = "General", context = {}) {
                console.warn(`[WARN | ${category}]: ${message}`, context);
                await this._logToFirestore("warn", message, category, context);
            },
            async error(error, category = "General", context = {}) {
                console.error(`[ERROR | ${category}]:`, error, context);
                await this._logToFirestore("error", error.message || "Unknown error", category, { ...context, stack: error.stack });
            },
            async _logToFirestore(level, message, category, context) {
                if (!db) return; // Don't log if DB isn't ready
                try {
                    await addDoc(collection(db, "system_logs_v3"), {
                        timestamp: serverTimestamp(),
                        level: level,
                        message: message,
                        category: `AdminPanel.${category}`,
                        context: context,
                        userId: currentUserId || "unknown"
                    });
                } catch (e) {
                    console.error("Failed to write log to Firestore:", e);
                }
            }
        };
        window.SmartLog = SmartLog; // Make global for debugging

        // --- Data Fetching & Listeners ---
        function attachAllListeners() {
            listenForActiveOrders();
            listenForCustomers();
            listenForLogs();
            listenForNewMessages();
        }

        // 1. Listen for Orders
        function listenForActiveOrders() {
            if (ordersUnsubscribe) ordersUnsubscribe();
            
            const q = query(
                collection(db, 'orders'), 
                where('status', 'not-in', ['סופק', 'מבוטל']),
                limit(100)
            );
            
            ordersUnsubscribe = onSnapshot(q, (snapshot) => {
                const loadingEl = document.getElementById('orders-loading');
                if (loadingEl) loadingEl.style.display = 'none';
                
                allOrders = [];
                snapshot.forEach(doc => allOrders.push({ id: doc.id, ...doc.data() }));
                
                allOrders.sort((a, b) => {
                    const statusA = a.status;
                    const statusB = b.status;
                    if (statusA === 'בטיפול' && statusB !== 'בטיפול') return -1;
                    if (statusA !== 'בטיפול' && statusB === 'בטיפול') return 1;
                    if (statusA === 'חדש' && statusB !== 'חדש') return -1;
                    if (statusA !== 'חדש' && statusB === 'חדש') return 1;
                    return 0;
                });
                
                document.getElementById('active-orders-count').innerText = allOrders.length;
                renderOrdersList();
                SmartLog.info(`Loaded ${allOrders.length} active orders`, "Data.Orders");
            }, (error) => {
                SmartLog.error(error, "Data.Orders.ListenFailed");
                document.getElementById('orders-loading').innerText = 'שגיאה בטעינת הזמנות.';
            });
        }

        // 2. Listen for Customers
        function listenForCustomers() {
            if (customersUnsubscribe) customersUnsubscribe();
            
            const q = query(collection(db, 'customers'), orderBy('name'));
            
            customersUnsubscribe = onSnapshot(q, (snapshot) => {
                const loadingEl = document.getElementById('customers-loading');
                if (loadingEl) loadingEl.style.display = 'none';

                allCustomers = [];
                const selectEl = document.getElementById('order-customer-id');
                selectEl.innerHTML = '<option value="">-- בחר לקוח --</option>'; // Clear existing
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // --- [FIX] נרמול שדות ---
                    const customer = {
                        id: doc.id,
                        ...data,
                        // ודא ששני הפורמטים קיימים ומוגדרים, העדף את החדש
                        customerNumber: data.customerNumber || data.customer_id || null,
                        customer_id: data.customer_id || data.customerNumber || null,
                        defaultAddress: data.defaultAddress || data.default_address || null,
                        default_address: data.default_address || data.defaultAddress || null
                    };
                    allCustomers.push(customer);
                    
                    const option = document.createElement('option');
                    option.value = customer.id;
                    // השתמש בשדה המנורמל
                    option.text = `${customer.name} (${customer.customerNumber || 'ללא מספר'})`;
                    selectEl.appendChild(option);
                });
                
                document.getElementById('customers-count').innerText = allCustomers.length;
                renderCustomersList();
                SmartLog.info(`Loaded ${allCustomers.length} customers`, "Data.Customers");
            }, (error) => {
                SmartLog.error(error, "Data.Customers.ListenFailed");
                document.getElementById('customers-loading').innerText = 'שגיאה בטעינת לקוחות.';
            });
        }

        // 3. Listen for Logs
        function listenForLogs() {
            if (logUnsubscribe) logUnsubscribe();
            
            const q = query(
                collection(db, 'system_logs_v3'), 
                orderBy('timestamp', 'desc'), 
                limit(50)
            );
            
            const logsList = document.getElementById('logs-list');
            
            logUnsubscribe = onSnapshot(q, (snapshot) => {
                logsList.innerHTML = ''; // Clear logs
                snapshot.forEach(doc => {
                    const log = doc.data();
                    const logTime = log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleString('he-IL') : '...';
                    const levelColor = log.level === 'error' ? 'text-red-400' : (log.level === 'warn' ? 'text-yellow-400' : 'text-green-400');
                    
                    const logEntry = document.createElement('p');
                    logEntry.className = 'mb-2 border-b border-gray-700 pb-2';
                    logEntry.innerHTML = `
                        <span class="text-gray-500">${logTime}</span><br>
                        <span class="${levelColor} font-bold">[${log.level.toUpperCase()}]</span>
                        <span class="text-cyan-400">[${log.category}]</span><br>
                        <span class="whitespace-pre-wrap">${log.message}</span>
                    `;
                    logsList.appendChild(logEntry);
                });
            }, (error) => {
                SmartLog.error(error, "Data.Logs.ListenFailed");
                logsList.innerHTML = '<p class="text-red-400">שגיאה בטעינת לוגים.</p>';
            });
        }
        
        // 4. האזנה להודעות חדשות מלקוחות
        function listenForNewMessages() {
            if (messagesUnsubscribe) messagesUnsubscribe();
            
            const badge = document.getElementById('notification-badge');
            const list = document.getElementById('messages-list');
            
            // שאילתת Collection Group
            // דורש אינדקס: messages (type ASC, readByViewer ASC, timestamp DESC)
            // --- [FIX] ---
            // הסרנו את המיון לפי זמן כדי למנוע שגיאת אינדקס.
            // המיון הידני בהמשך הקוד יטפל בזה.
            const q = query(
                collectionGroup(db, 'messages'),
                where('type', '==', 'message_to_admin'),
                where('readByViewer', '==', false),
                // orderBy('timestamp', 'desc'), // <-- [FIX] Removed this line
                limit(30)
            );
            
            messagesUnsubscribe = onSnapshot(q, (snapshot) => {
                const loadingEl = document.getElementById('messages-loading');
                if (loadingEl) loadingEl.style.display = 'none';
                
                list.innerHTML = ''; // נקה רשימה ישנה
                const newMessagesCount = snapshot.size;
                updateNotificationBadge(newMessagesCount);
                
                if (snapshot.empty) {
                    list.innerHTML = '<p class="text-gray-500 text-center">אין הודעות חדשות מלקוחות.</p>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const message = doc.data();
                    const orderId = doc.ref.parent.parent.id;
                    const messageId = doc.id;
                    list.appendChild(createMessageCard(message, orderId, messageId));
                });
                
            }, (error) => {
                SmartLog.error(error, "Data.Messages.ListenFailed");
                console.error("Error listening to messages: ", error);
                document.getElementById('messages-loading').innerText = 'שגיאה בטעינת הודעות. ייתכן שנדרש אינדקס ב-Firestore.';
            });
        }

        // --- Rendering Functions ---
        
        function renderOrdersList() {
            const list = document.getElementById('orders-list');
            const search = document.getElementById('orders-search').value.toLowerCase();
            list.innerHTML = '';
            
            const filtered = allOrders.filter(order => 
                (order.customer_name && order.customer_name.toLowerCase().includes(search)) ||
                (order.order_id && order.order_id.includes(search)) ||
                (order.customer_id && order.customer_id.includes(search)) ||
                (order.customer_address && order.customer_address.toLowerCase().includes(search))
            );
            
            if (filtered.length === 0) {
                list.innerHTML = '<p>לא נמצאו הזמנות פעילות.</p>';
                return;
            }
            
            filtered.forEach(order => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow border-l-4 border-blue-500';
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-lg">${order.customer_name}</h3>
                        <span class="text-sm font-mono bg-gray-200 text-gray-700 px-2 py-1 rounded">${order.order_id || order.id}</span>
                    </div>
                    <p class="text-gray-600">${order.customer_address}</p>
                    <p class="text-sm text-gray-500">${order.delivery_date} | ${order.warehouse}</p>
                    <div class="mt-4 flex gap-2 flex-wrap">
                        <select onchange="updateOrderStatus(event, '${order.id}')" class="border p-2 rounded-md bg-gray-50 text-sm">
                            <option value="חדש" ${order.status === 'חדש' ? 'selected' : ''}>חדש</option>
                            <option value="בטיפול" ${order.status === 'בטיפול' ? 'selected' : ''}>בטיפול</option>
                            <option value="בדרך" ${order.status === 'בדרך' ? 'selected' : ''}>בדרך</option>
                            <option value="סופק" ${order.status === 'סופק' ? 'selected' : ''}>סופק</option>
                            <option value="מבוטל" ${order.status === 'מבוטל' ? 'selected' : ''}>מבוטל</option>
                        </select>
                        <button onclick="showAssignDriverModal('${order.id}')" class="text-sm bg-green-500 text-white py-2 px-3 rounded-md hover:bg-green-600"><i class="fas fa-truck"></i> שייך נהג</button>
                        <button onclick="copyCustomerLink('${order.id}')" class="text-sm bg-blue-500 text-white py-2 px-3 rounded-md hover:bg-blue-600"><i class="fas fa-link"></i> לינק ללקוח</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }
        
        function renderCustomersList() {
            const list = document.getElementById('customers-list');
            const search = document.getElementById('customers-search').value.toLowerCase();
            list.innerHTML = '';
            
            const filtered = allCustomers.filter(customer => 
                (customer.name && customer.name.toLowerCase().includes(search)) ||
                (customer.customer_id && customer.customer_id.includes(search)) ||
                (customer.phone && customer.phone.includes(search)) ||
                (customer.default_address && customer.default_address.toLowerCase().includes(search))
            );

            if (filtered.length === 0) {
                list.innerHTML = '<p>לא נמצאו לקוחות.</p>';
                return;
            }
            
            filtered.forEach(customer => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow';
                card.innerHTML = `
                    <h3 class="font-bold text-lg">${customer.name}</h3>
                    <p class="text-gray-600">${customer.customer_id || customer.customerNumber || 'ללא מספר לקוח'}</p>
                    <p class="text-gray-600">${customer.phone || 'ללא טלפון'}</p>
                    <p class="text-sm text-gray-500">${customer.default_address || customer.defaultAddress || 'ללא כתובת'}</p>
                    <div class="mt-4 flex gap-2">
                        <button onclick="showEditCustomerModal('${customer.id}')" class="text-sm bg-yellow-500 text-white py-2 px-3 rounded-md hover:bg-yellow-600"><i class="fas fa-edit"></i> ערוך</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }
        
        // --- UI Functions ---

        function showPanelTab(panelId) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            
            document.getElementById(panelId).classList.add('active');
            const tabId = `tab-${panelId.split('-')[0]}`;
            document.getElementById(tabId).classList.add('active');
        }
        window.showPanelTab = showPanelTab;

        function filterLists() {
            renderOrdersList();
            renderCustomersList();
        }
        window.filterLists = filterLists;
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            let icon = '<i class="fas fa-info-circle"></i>';
            let bgColor = 'bg-blue-500';
            if (type === 'success') {
                icon = '<i class="fas fa-check-circle"></i>';
                bgColor = 'bg-green-500';
            } else if (type === 'error') {
                icon = '<i class="fas fa-times-circle"></i>';
                bgColor = 'bg-red-500';
            }
            
            toast.className = `p-4 rounded-lg shadow-lg text-white ${bgColor} mb-2 transform translate-y-10 opacity-0 transition-all duration-300 ease-out`;
            toast.innerHTML = `<span class="mr-2">${icon}</span> ${message}`;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-y-10');
                toast.classList.remove('opacity-0');
            }, 100);
            
            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.classList.add('-translate-x-full');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }

        // --- CRUD Functions ---

        // 1. New Order Form
        const newOrderForm = document.getElementById('new-order-form');
        newOrderForm.addEventListener('submit', submitNewOrder);

        async function submitNewOrder(e) {
            e.preventDefault();
            const form = e.target;
            
            const customOrderNumber = form['order-number-custom'].value.trim();
            const customCustomerNumber = form['order-customer-number-custom'].value.trim();

            const newOrder = {
                customer_name: form['order-customer-name'].value,
                customer_id: customCustomerNumber || form['order-customer-id'].value,
                customer_phone: form['order-customer-phone'].value,
                customer_address: form['order-customer-address'].value,
                delivery_date: form['order-delivery-date'].value,
                orderTime: form['order-delivery-time'].value,
                projectName: form['order-project-name'].value.trim(), // שדה משודרג
                notes: form['order-notes'].value, // תוכן הזמנה
                warehouse: form['order-warehouse'].value,
                deliveryType: form['order-delivery-type'].value,
                status: "חדש",
                createdAt: serverTimestamp(),
                createdBy: "AdminPanel",
                order_id: customOrderNumber || `AUTO-${Date.now().toString().slice(-6)}`
            };
            
            SmartLog.info("Attempting to create new order...", "CRUD.Order.Create", newOrder);
            
            try {
                const docRef = await addDoc(collection(db, "orders"), newOrder);
                SmartLog.info(`Order created successfully: ${docRef.id}`, "CRUD.Order.CreateSuccess");
                showToast('הזמנה חדשה נוצרה בהצלחה!', 'success');
                form.reset();
                showPanelTab('orders-panel');
                
                // --- שדרוג: הפעלת שיתוף וואטסאפ אוטומטי ---
                await shareToWhatsApp(newOrder);
                // --- סוף שדרוג ---

            } catch (error) {
                SmartLog.error(error, "CRUD.Order.CreateFailed", newOrder);
                showToast('שגיאה ביצירת הזמנה.', 'error');
            }
        }

        /**
         * שדרוג: פונקציית שיתוף לוואטסאפ
         */
        async function shareToWhatsApp(orderData) {
            const phone = "972508860896"; // יש להגדיר מספר טלפון קבוע
            
            const template = `
*✅ הזמנה חדשה נוצרה (מפאנל ניהול):*
-----------------------------
*שם לקוח:* ${orderData.customer_name || 'לא צוין'}
*מספר הזמנה:* ${orderData.order_id || 'טרם נקבע'}
*כתובת:* ${orderData.customer_address || 'לא צוין'}
*תאריך אספקה:* ${orderData.delivery_date || 'לא צוין'}
*שעה:* ${orderData.orderTime || 'לא צוין'}
-----------------------------

*תוכן ההזמנה:*
${orderData.notes || "--- אין תוכן ---"}

*פרויקט:*
${orderData.projectName || "--- אין ---"}
            `;
            
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(template)}`;
            window.open(whatsappUrl, '_blank');
            SmartLog.info("Opened WhatsApp share window", "CRUD.Order.WhatsApp");
        }
        window.shareToWhatsApp = shareToWhatsApp; // חשיפה גלובלית


        function fillCustomerData(customerId) {
            if (!customerId) {
                document.getElementById('order-customer-name').value = '';
                document.getElementById('order-customer-phone').value = '';
                document.getElementById('order-customer-address').value = '';
                document.getElementById('order-customer-number-custom').value = '';
                return;
            }
            const customer = allCustomers.find(c => c.id === customerId);
            if (customer) {
                document.getElementById('order-customer-name').value = customer.name || '';
                document.getElementById('order-customer-phone').value = customer.phone || '';
                document.getElementById('order-customer-address').value = customer.default_address || customer.defaultAddress || '';
                document.getElementById('order-customer-number-custom').value = customer.customer_id || customer.customerNumber || '';
            }
        }
        window.fillCustomerData = fillCustomerData; // חשיפה גלובלית
        
        // 2. Update Order Status
        async function updateOrderStatus(event, orderId) {
            const newStatus = event.target.value;
            const orderRef = doc(db, 'orders', orderId);
            
            SmartLog.info(`Updating status for order ${orderId} to ${newStatus}`, "CRUD.Order.UpdateStatus");
            try {
                await updateDoc(orderRef, {
                    status: newStatus,
                    lastModified: serverTimestamp()
                });
                showToast(`סטטוס הזמנה ${orderId} עודכן ל: ${newStatus}`, 'success');
            } catch (error) {
                SmartLog.error(error, "CRUD.Order.UpdateStatusFailed", { orderId, newStatus });
                showToast('שגיאה בעדכון סטטוס.', 'error');
            }
        }
        window.updateOrderStatus = updateOrderStatus;
        
        // 3. Assign Driver (Placeholder for Modal)
        function showAssignDriverModal(orderId) {
            SmartLog.info(`Opening assign driver modal for order: ${orderId}`, "UI.Modal");
            openModal(
                `<h3>שייך נהג להזמנה ${orderId}</h3>`, 
                `<p>כאן יוצגו רשימת נהגים זמינים...</p><button onclick="closeModal()" class="mt-4 bg-blue-500 text-white py-2 px-4 rounded">סגור</button>`
            );
        }
        window.showAssignDriverModal = showAssignDriverModal;

        // 4. Edit Customer (Modal)
        async function showEditCustomerModal(customerId) {
            const customer = allCustomers.find(c => c.id === customerId);
            if (!customer) {
                showToast('לא ניתן למצוא לקוח', 'error');
                return;
            }
            
            const customer_id = customer.customer_id || customer.customerNumber || '';
            const default_address = customer.default_address || customer.defaultAddress || '';
            
            const content = `
                <div class="p-6">
                    <h3 class="text-lg font-semibold mb-4">עריכת לקוח: ${customer.name}</h3>
                    <form id="edit-customer-form" class="space-y-3">
                        <input type="hidden" id="edit-customer-doc-id" value="${customer.id}">
                        <div>
                            <label class="block text-sm font-medium">שם לקוח (חובה)</label>
                            <input type="text" id="edit-customer-name" class="mt-1 w-full p-2 border rounded" value="${customer.name || ''}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">מספר לקוח (חובה)</label>
                            <input type="text" id="edit-customer-number" class="mt-1 w-full p-2 border rounded" value="${customer_id}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">טלפון</label>
                            <input type="tel" id="edit-customer-phone" class="mt-1 w-full p-2 border rounded" value="${customer.phone || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">כתובת ברירת מחדל</label>
                            <input type="text" id="edit-customer-address" class="mt-1 w-full p-2 border rounded" value="${default_address}">
                        </div>
                        <div class="flex justify-end gap-3 mt-4">
                            <button type="button" onclick="closeModal()" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">ביטול</button>
                            <button type="submit" class="py-2 px-4 bg-green-500 text-white rounded-md hover:bg-green-600">שמור שינויים</button>
                        </div>
                    </form>
                </div>
            `;
            openModal('', content, false);
            
            document.getElementById('edit-customer-form').addEventListener('submit', handleUpdateCustomer);
        }
        window.showEditCustomerModal = showEditCustomerModal;

        async function handleUpdateCustomer(e) {
            e.preventDefault();
            const form = e.target;
            const customerId = form['edit-customer-doc-id'].value;
            const customerRef = doc(db, 'customers', customerId);
            
            const oldData = allCustomers.find(c => c.id === customerId);
            
            const updatedData = {
                name: form['edit-customer-name'].value,
                customer_id: form['edit-customer-number'].value, // שדה מאוחד
                customerNumber: form['edit-customer-number'].value, // שמירה בשני הפורמטים
                phone: form['edit-customer-phone'].value,
                default_address: form['edit-customer-address'].value, // שדה מאוחד
                defaultAddress: form['edit-customer-address'].value, // שמירה בשני הפורמטים
                lastModified: serverTimestamp()
            };

            SmartLog.info(`Updating customer ${customerId}`, "CRUD.Customer.Update", { new: updatedData });

            try {
                await runTransaction(db, async (transaction) => {
                    transaction.update(customerRef, updatedData);
                    
                    // --- [FIX] ודא ששדות קיימים לפני שליחה ללוג ---
                    // השתמש בשדות המנורמלים וספק `null` אם הם לא קיימים
                    const oldName = oldData.name || null;
                    const oldId = oldData.customerNumber || oldData.customer_id || null;
                    const oldPhone = oldData.phone || null;
                    const oldAddress = oldData.defaultAddress || oldData.default_address || null;

                    const logRef = doc(collection(db, 'customers', customerId, 'auditLog'));
                    transaction.set(logRef, {
                        timestamp: serverTimestamp(),
                        action: "ADMIN_UPDATE",
                        userId: currentUserId,
                        changes: {
                            old: { name: oldName, id: oldId, phone: oldPhone, address: oldAddress },
                            new: { name: updatedData.name, id: updatedData.customerNumber, phone: updatedData.phone, address: updatedData.defaultAddress }
                        }
                    });

                    // 3. (v31.6) Check if default address changed, and if so, update active orders
                    if (oldAddress !== updatedData.defaultAddress) {
                        const q = query(
                            collection(db, 'orders'), 
                            where('customer_id', '==', oldId), // חפש לפי המזהה הישן
                            where('status', 'not-in', ['סופק', 'מבוטל'])
                        );
                        
                        const ordersSnap = await getDocs(q);
                        ordersSnap.forEach(orderDoc => {
                            if (orderDoc.data().customer_address === oldAddress) {
                                transaction.update(orderDoc.ref, {
                                    customer_address: updatedData.default_address,
                                    lastModified: serverTimestamp(),
                                    log: `Address auto-updated by admin edit (${new Date().toISOString()})`
                                });
                            }
                        });
                        SmartLog.info(`Found ${ordersSnap.size} active orders to check for address update`, "CRUD.Customer.Update");
                    }
                });
                
                showToast('פרטי לקוח עודכנו בהצלחה', 'success');
                SmartLog.info(`Customer ${customerId} updated successfully`, "CRUD.Customer.UpdateSuccess");
                closeModal();
                
            } catch (error) {
                SmartLog.error(error, "CRUD.Customer.UpdateFailed", { customerId });
                showToast('שגיאה בעדכון פרטי לקוח', 'error');
            }
        }

        // 5. Copy Customer Link
        async function copyCustomerLink(orderId) {
            if (!orderId) {
                showToast('מזהה הזמנה חסר', 'error');
                return;
            }
            
            SmartLog.info(`Fetching order_id for doc: ${orderId}`, "UI.CopyLink");

            try {
                const orderRef = doc(db, "orders", orderId);
                const orderSnap = await getDoc(orderRef);
                
                if (!orderSnap.exists()) {
                    showToast('הזמנה לא נמצאה', 'error');
                    SmartLog.error(new Error("Order document not found"), "UI.CopyLink", { orderId });
                    return;
                }
                
                const orderData = orderSnap.data();
                const shortOrderId = orderData.order_id; 

                if (!shortOrderId) {
                     showToast('שגיאה: להזמנה זו אין "מספר הזמנה" (order_id)', 'error');
                     SmartLog.error(new Error("Order document is missing 'order_id' field"), "UI.CopyLink", { orderId });
                     return;
                }

                // שינוי נתיב בהתאם לבקשת הלקוח
                const baseUrl = window.location.origin + "/sidor/customer.html"; 
                const customerLink = `${baseUrl}?id=${shortOrderId}`;
                
                const tempInput = document.createElement("textarea");
                tempInput.value = customerLink;
                tempInput.style.position = 'absolute';
                tempInput.style.left = '-9999px';
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand("copy");
                document.body.removeChild(tempInput);
                
                showToast('הקישור ללקוח הועתק!', 'success');
                SmartLog.info(`Link copied: ${customerLink}`, "UI.CopyLinkSuccess");

            } catch (error) {
                SmartLog.error(error, "UI.CopyLinkFailed", { orderId });
                showToast('שגיאה בהעתקת הקישור', 'error');
            }
        }
        window.copyCustomerLink = copyCustomerLink;

        // 6. מערכת הודעות
        
        function createMessageCard(message, orderId, messageId) {
            const card = document.createElement('div');
            card.className = 'message-card unread p-4 bg-white rounded-lg shadow border-l-4 border-blue-500';
            
            const time = message.timestamp ? message.timestamp.toDate().toLocaleString('he-IL') : 'לא ידוע';
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span class="font-bold text-lg text-gray-800">${message.senderName || 'לקוח'}</span>
                        <span class="text-sm text-gray-600">(הזמנה: ${orderId.substring(0, 6)})</span>
                    </div>
                    <span class="text-xs text-gray-500">${time}</span>
                </div>
                <p class="text-gray-700 mb-3">${message.text}</p>
                <div class="text-xs text-gray-500 mb-3">
                    מזהה הזמנה: <span class="font-mono">${orderId}</span>
                </div>
                <button onclick="showSendReplyModal(event, '${orderId}', '${messageId}', '${message.senderName || 'לקוח'}')" class="text-sm bg-blue-500 text-white py-1 px-3 rounded-md hover:bg-blue-600">
                    <i class="fas fa-reply"></i> שלח תשובה
                </button>
                <button onclick="markMessageAsRead('${orderId}', '${messageId}')" class="text-sm bg-gray-200 text-gray-700 py-1 px-3 rounded-md hover:bg-gray-300 mr-2">
                    <i class="fas fa-check"></i> סמן כנקרא
                </button>
            `;
            return card;
        }

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notification-badge');
            if (count > 0) {
                badge.innerText = count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function showSendReplyModal(event, orderId, messageId, customerName) {
            event.stopPropagation();
            
            document.getElementById('reply-modal-order-id').innerText = orderId || 'לא ידוע';
            document.getElementById('reply-modal-customer-name').innerText = customerName || 'לקוח';
            document.getElementById('reply-modal-doc-id').value = orderId; // Path is just orderId
            document.getElementById('reply-modal-msg-id').value = messageId;
            document.getElementById('reply-message-text').value = '';
            
            document.getElementById('reply-modal').classList.remove('hidden');
        }
        window.showSendReplyModal = showSendReplyModal;

        function closeReplyModal() {
            document.getElementById('reply-modal').classList.add('hidden');
        }
        window.closeReplyModal = closeReplyModal;

        async function sendAdminReply() {
            const orderId = document.getElementById('reply-modal-doc-id').value;
            const originalMessageId = document.getElementById('reply-modal-msg-id').value;
            const messageText = document.getElementById('reply-message-text').value.trim();
            
            if (!orderId || !originalMessageId || !messageText) {
                showToast('שגיאה: חסרים נתונים לשליחת תשובה', 'error');
                return;
            }
            
            const batch = writeBatch(db);
            
            const msgRef = doc(db, 'orders', orderId, 'messages', originalMessageId);
            batch.update(msgRef, { readByViewer: true });
            
            const newAlertRef = doc(collection(db, 'orders', orderId, 'messages'));
            batch.set(newAlertRef, {
                text: messageText,
                type: "notification_to_customer",
                senderName: "שירות לקוחות",
                timestamp: serverTimestamp(),
                readByViewer: true
            });
            
            SmartLog.info(`Sending reply to ${orderId}`, "CRUD.Message.Reply", { text: messageText });

            try {
                await batch.commit();
                showToast('התראה נשלחה ללקוח בהצלחה', 'success');
                closeReplyModal();
            } catch (error) {
                SmartLog.error(error, "CRUD.Message.ReplyFailed");
                showToast('שגיאה בשליחת התראה', 'error');
            }
        }
        window.sendAdminReply = sendAdminReply;
        
        async function markMessageAsRead(orderId, messageId) {
             const messageRef = doc(db, 'orders', orderId, 'messages', messageId);
             try {
                await updateDoc(messageRef, { readByViewer: true });
                showToast('ההודעה סומנה כנקראה', 'success');
             } catch (error) {
                 SmartLog.error(error, "CRUD.Message.MarkRead");
                 showToast('שגיאה בסימון הודעה', 'error');
             }
        }
        window.markMessageAsRead = markMessageAsRead;

        // 7. Global Ping Function
        async function sendGlobalPing() {
             const message = prompt("הזן הודעה להתראה הגלובלית (למשל: 'דוח למחר מוכן'):");
             if (!message || message.trim() === '') {
                 showToast('שליחת התראה בוטלה', 'info');
                 return;
             }
             
             SmartLog.info("Sending global ping...", "CRUD.Ping", { message });
             try {
                 const pingRef = doc(collection(db, "globalPings"));
                 await setDoc(pingRef, {
                     type: "MANAGER_BROADCAST",
                     message: message.trim(),
                     sender: "Admin",
                     createdAt: serverTimestamp()
                 });
                 showToast('התראה גלובלית נשלחה בהצלחה', 'success');
                 SmartLog.info("Global ping sent successfully", "CRUD.Ping");
             } catch (error) {
                 SmartLog.error(error, "CRUD.Ping", { message });
                 showToast('שגיאה בשליחת התראה גלובלית', 'error');
             }
        }
        window.sendGlobalPing = sendGlobalPing;

        // --- Generic Modal Functions ---
        function openModal(title, content, showHeader = true) {
            const modalContent = `
                ${showHeader ? `
                <div class="flex justify-between items-center p-4 border-b">
                    <h2 class="text-xl font-semibold">${title}</h2>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">&times;</button>
                </div>` : ''}
                <div id="modal-body" class="p-1">${content}</div>
            `;
            document.getElementById('modal-content-inner').innerHTML = modalContent;
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal-content-inner').innerHTML = '';
            document.getElementById('modal').classList.add('hidden');
        }
        window.closeModal = closeModal;

    </script>
</body>
</html>

