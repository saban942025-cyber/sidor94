<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v32 (Full Upgrade)</title>
    <!-- 
      DeliveryMaster Admin App v32 (Full Upgrade)
      
      Changelog:
      - v32 (NEW):
        - 砖专  -Firebase v9 (Modular SDK).
        - 注  砖 注专转 注转 拽转 (驻注, ,  转砖).
        - 砖专 驻拽爪 `copyCustomerLink` 砖砖 -`order_id` (住驻专  拽爪专)
          拽 -Document ID, 驻 砖拽砖转.
      - v31.9.2 (住驻转 住 ):
        - 住驻 驻砖专转 住驻转 砖 '住 ' 驻住  砖.
      - v31.9.1 (住驻转 砖注转 住驻拽):
        - 住祝 砖 <input type="time"> 驻住 爪专转  砖.
      - v31.9: Added Global Ping functionality.
      - v31.8: Added "Copy Link for Customer" feature.
      ... (changelog 拽)
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        .tab-link { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-link.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        .panel { display: none; }
        .panel.active { display: block; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1001; }
        
        /* 住转 砖 注专 注专转 注转 */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background-color: #ef4444; /* red-500 */
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            display: none; /* 住转专 专专转  */
        }
        .message-card.unread {
            background-color: #fefce8; /* yellow-50 */
            border-right: 4px solid #facc15; /* yellow-400 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Modal (Generic) -->
    <div id="modal" class="modal-overlay hidden" onclick="closeModal()">
        <div class="modal-content bg-white w-11/12 md:w-1/2 lg:w-1/3 rounded-lg shadow-xl" onclick="event.stopPropagation()">
            <div id="modal-content-inner">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Modal: 砖 转砖/转专 拽 (砖) -->
    <div id="reply-modal" class="modal-overlay hidden" onclick="closeReplyModal()">
        <div class="modal-content bg-white w-11/12 md:w-1/2 lg:w-1/3 rounded-lg shadow-xl" onclick="event.stopPropagation()">
            <div class="p-6">
                <h3 class="text-lg font-semibold mb-4">砖 转专 拽</h3>
                <p class="text-sm text-gray-600 mb-2">注专 : <strong id="reply-modal-order-id"></strong></p>
                <p class="text-sm text-gray-600 mb-4">拽: <strong id="reply-modal-customer-name"></strong></p>
                
                <textarea id="reply-message-text" rows="4" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="拽 转 转 转专  (砖: ' 砖专')"></textarea>
                
                <input type="hidden" id="reply-modal-doc-id">
                <input type="hidden" id="reply-modal-msg-id">

                <div class="flex justify-end gap-3 mt-4">
                    <button onclick="closeReplyModal()" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300"></button>
                    <button onclick="sendAdminReply()" class="py-2 px-4 bg-blue-500 text-white rounded-md hover:bg-blue-600">砖 转专</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-5 left-5 z-[5000]"></div>

    <!-- Header -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">DeliveryMaster v32</h1>
        <div class="flex items-center gap-4">
            <!-- 驻转专 驻注 转专转 (砖) -->
            <button onclick="showPanelTab('messages-panel')" class="relative text-gray-600 hover:text-blue-500" aria-label="注转">
                <i class="fas fa-bell fa-lg"></i>
                <span id="notification-badge" class="notification-badge">0</span>
            </button>
            <button onclick="sendGlobalPing()" class="text-sm bg-blue-500 text-white py-2 px-3 rounded-md hover:bg-blue-600">
                <i class="fas fa-tower-broadcast"></i> Ping
            </button>
            <button onclick="document.location.reload()" class="text-sm bg-gray-200 text-gray-700 py-2 px-3 rounded-md hover:bg-gray-300">
                <i class="fas fa-sync-alt"></i> 专注
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-4 md:p-6">
        
        <!-- Tabs Navigation -->
        <nav class="bg-white rounded-t-lg shadow-sm flex border-b border-gray-200">
            <a id="tab-orders" class="tab-link active" onclick="showPanelTab('orders-panel')">
                <i class="fas fa-shipping-fast"></i> 转 (<span id="active-orders-count">0</span>)
            </a>
            <a id="tab-customers" class="tab-link" onclick="showPanelTab('customers-panel')">
                <i class="fas fa-users"></i> 拽转 (<span id="customers-count">0</span>)
            </a>
            <!--  注转 (砖) -->
            <a id="tab-messages" class="tab-link" onclick="showPanelTab('messages-panel')">
                <i class="fas fa-envelope"></i> 注转 拽转
            </a>
            <a id="tab-new-order" class="tab-link" onclick="showPanelTab('new-order-panel')">
                <i class="fas fa-plus-circle"></i>  砖
            </a>
            <a id="tab-logs" class="tab-link" onclick="showPanelTab('logs-panel')">
                <i class="fas fa-clipboard-list"></i> 
            </a>
        </nav>

        <!-- Panels Container -->
        <div class="bg-white rounded-b-lg shadow-lg p-4 md:p-6">
            
            <!-- Panel 1: Orders -->
            <div id="orders-panel" class="panel active">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">转 驻注转</h2>
                    <input type="text" id="orders-search" class="border p-2 rounded-md" placeholder="驻砖 ..." onkeyup="filterLists()">
                </div>
                <div id="orders-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p id="orders-loading">注 转...</p>
                    <!-- Order cards will be injected here -->
                </div>
            </div>

            <!-- Panel 2: Customers -->
            <div id="customers-panel" class="panel">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">专砖转 拽转</h2>
                    <input type="text" id="customers-search" class="border p-2 rounded-md" placeholder="驻砖 拽..." onkeyup="filterLists()">
                </div>
                <div id="customers-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p id="customers-loading">注 拽转...</p>
                    <!-- Customer cards will be injected here -->
                </div>
            </div>

            <!-- Panel 3: 注转 拽转 (砖) -->
            <div id="messages-panel" class="panel">
                <h2 class="text-xl font-semibold mb-4">注转 砖转 拽转</h2>
                <div id="messages-list" class="flex flex-col gap-4">
                    <p id="messages-loading">注 注转...</p>
                    <!-- Message cards will be injected here -->
                </div>
            </div>

            <!-- Panel 4: New Order -->
            <div id="new-order-panel" class="panel">
                <h2 class="text-xl font-semibold mb-4">爪专转  砖</h2>
                <form id="new-order-form" class="space-y-4 max-w-lg mx-auto">
                    <div>
                        <label for="order-customer-id" class="block text-sm font-medium text-gray-700">专 拽 拽</label>
                        <select id="order-customer-id" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" onchange="fillCustomerData(this.value)">
                            <option value="">-- 专 拽 --</option>
                            <!-- Customer options will be injected here -->
                        </select>
                    </div>
                    <div>
                        <label for="order-customer-name" class="block text-sm font-medium text-gray-700">砖 拽 ()</label>
                        <input type="text" id="order-customer-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="order-customer-phone" class="block text-sm font-medium text-gray-700">驻</label>
                        <input type="tel" id="order-customer-phone" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="order-customer-address" class="block text-sm font-medium text-gray-700">转转 ()</label>
                        <input type="text" id="order-customer-address" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="order-delivery-date" class="block text-sm font-medium text-gray-700">转专 住驻拽 ()</label>
                        <input type="date" id="order-delivery-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <!-- 砖 砖注转 住驻拽 (注) -->
                    <div>
                        <label for="order-delivery-time" class="block text-sm font-medium text-gray-700">砖注转 住驻拽 (专砖转)</label>
                        <input type="time" id="order-delivery-time" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="order-notes" class="block text-sm font-medium text-gray-700">注专转</label>
                        <textarea id="order-notes" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <div>
                        <label for="order-warehouse" class="block text-sm font-medium text-gray-700">住 ()</label>
                        <select id="order-warehouse" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                            <option value="">-- 专 住 --</option>
                            <option value="转">转</option>
                            <option value="专砖">专砖</option>
                            <option value="30-砖专拽">30-砖专拽</option>
                            <option value="专">专</option>
                        </select>
                    </div>
                    <!-- 砖 住  (注) -->
                    <div>
                        <label for="order-delivery-type" class="block text-sm font-medium text-gray-700">住  ()</label>
                        <select id="order-delivery-type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                            <option value="">-- 专 住 --</option>
                            <option value="砖转">砖转</option>
                            <option value="专专">专专</option>
                            <option value="祝">祝</option>
                            <option value="爪转 ">爪转 </option>
                            <option value="驻 ">驻 </option>
                            <option value="驻转 ">驻转 </option>
                            <option value="住祝 注爪">住祝 注爪</option>
                            <option value="专">专</option>
                        </select>
                    </div>
                    
                    <!-- 砖转 驻爪 -->
                    <div>
                        <label for="order-number-custom" class="block text-sm font-medium text-gray-700">住驻专  ( 专拽 爪专 转)</label>
                        <input type="text" id="order-number-custom" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="砖 6715504">
                    </div>
                    <div>
                        <label for="order-customer-number-custom" class="block text-sm font-medium text-gray-700">住驻专 拽 (专砖转)</label>
                        <input type="text" id="order-customer-number-custom" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="砖 112233">
                    </div>

                    <div class="flex justify-end">
                        <button type="submit" class="py-2 px-6 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600">爪专 </button>
                    </div>
                </form>
            </div>

            <!-- Panel 5: Logs -->
            <div id="logs-panel" class="panel">
                <h2 class="text-xl font-semibold mb-4"> 注专转</h2>
                <div id="logs-list" class="h-96 overflow-y-auto bg-gray-800 text-white p-4 rounded-md font-mono text-sm">
                    <p>注 ...</p>
                    <!-- Log entries will be injected here -->
                </div>
            </div>

        </div>
    </main>
    <script type="module">
        /*
         ==========================================================
         ===         Firebase SDK v9 Imports (Modular)          ===
         ==========================================================
        */
        
        // ---  [FIX] Using protocol-relative URLs (//) to avoid module resolution errors ---
        import { initializeApp, getApps, getApp } from "//www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "//www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, 
            collection, query, where, Timestamp, runTransaction, getDocs, orderBy, 
            serverTimestamp, limit, writeBatch, collectionGroup
        } from "//www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { setLogLevel } from "//www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        /*
         ==========================================================
         ===              拽住 专砖 -Firestore             ===
         ==========================================================
         *
         * 1. (Orders)
         * - Collection: orders
         * - Fields:
         * 1. order_id (Ascending)
         *
         * 2. (Messages - Admin Panel)
         * - Collection: messages (Collection Group)
         * - Fields:
         * 1. type (Ascending)
         * 2. readByViewer (Ascending)
         * 3. timestamp (Descending)
         *
         ==========================================================
        */

        // --- Global Variables ---
        let db, auth;
        let allOrders = [];
        let allCustomers = [];
        let logUnsubscribe = null;
        let ordersUnsubscribe = null;
        let customersUnsubscribe = null;
        let messagesUnsubscribe = null;
        let currentUserId = null;

        // --- Firebase Config & Auth ---
        // 砖专: 砖砖 拽驻专爪 砖 驻专拽 saban94-78949
        const fallbackConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949",
          storageBucket: "saban94-78949.firebasestorage.app", 
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a", 
          measurementId: "G-XV6RZDESSB"
        };        
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(fallbackConfig));
        
        try {
            const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');
            console.log("Firebase Initialized.");
            
            // --- Authentication ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log("User Signed In:", currentUserId);
                    SmartLog.info("Admin user signed in", "Auth.SignIn");
                    // User is signed in, fetch all data
                    attachAllListeners();
                } else {
                    // No user, try to sign in
                    console.log("No user. Trying auth...");
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        SmartLog.error(error, "Auth.SignInFailed");
                        console.error("Firebase Auth Error:", error);
                    }
                }
            });

        } catch (e) {
            console.error("Firebase Initialization Failed:", e);
            SmartLog.error(e, "App.Init");
            showToast('砖转 转专转 专 -Firebase', 'error');
        }

        // --- Smart Logging Utility ---
        const SmartLog = {
            async info(message, category = "General", context = {}) {
                console.log(`[INFO | ${category}]: ${message}`, context);
                await this._logToFirestore("info", message, category, context);
            },
            async warn(message, category = "General", context = {}) {
                console.warn(`[WARN | ${category}]: ${message}`, context);
                await this._logToFirestore("warn", message, category, context);
            },
            async error(error, category = "General", context = {}) {
                console.error(`[ERROR | ${category}]:`, error, context);
                await this._logToFirestore("error", error.message || "Unknown error", category, { ...context, stack: error.stack });
            },
            async _logToFirestore(level, message, category, context) {
                if (!db) return; // Don't log if DB isn't ready
                try {
                    await addDoc(collection(db, "system_logs_v3"), {
                        timestamp: serverTimestamp(),
                        level: level,
                        message: message,
                        category: `AdminPanel.${category}`,
                        context: context,
                        userId: currentUserId || "unknown"
                    });
                } catch (e) {
                    console.error("Failed to write log to Firestore:", e);
                }
            }
        };
        window.SmartLog = SmartLog; // Make global for debugging

        // --- Data Fetching & Listeners ---
        function attachAllListeners() {
            listenForActiveOrders();
            listenForCustomers();
            listenForLogs();
            listenForNewMessages(); // 砖
        }

        // 1. Listen for Orders
        function listenForActiveOrders() {
            if (ordersUnsubscribe) ordersUnsubscribe();
            
            const q = query(
                collection(db, 'orders'), 
                where('status', 'not-in', ['住驻拽', '']),
                limit(100) // Load 100 active orders
            );
            
            ordersUnsubscribe = onSnapshot(q, (snapshot) => {
                const loadingEl = document.getElementById('orders-loading');
                if (loadingEl) loadingEl.style.display = 'none';
                
                allOrders = [];
                snapshot.forEach(doc => allOrders.push({ id: doc.id, ...doc.data() }));
                
                // Sort: '驻' first, then '砖', then others.
                allOrders.sort((a, b) => {
                    const statusA = a.status;
                    const statusB = b.status;
                    if (statusA === '驻' && statusB !== '驻') return -1;
                    if (statusA !== '驻' && statusB === '驻') return 1;
                    if (statusA === '砖' && statusB !== '砖') return -1;
                    if (statusA !== '砖' && statusB === '砖') return 1;
                    return 0;
                });
                
                document.getElementById('active-orders-count').innerText = allOrders.length;
                renderOrdersList();
                SmartLog.info(`Loaded ${allOrders.length} active orders`, "Data.Orders");
            }, (error) => {
                SmartLog.error(error, "Data.Orders.ListenFailed");
                document.getElementById('orders-loading').innerText = '砖 注转 转.';
            });
        }

        // 2. Listen for Customers
        function listenForCustomers() {
            if (customersUnsubscribe) customersUnsubscribe();
            
            const q = query(collection(db, 'customers'), orderBy('name'));
            
            customersUnsubscribe = onSnapshot(q, (snapshot) => {
                const loadingEl = document.getElementById('customers-loading');
                if (loadingEl) loadingEl.style.display = 'none';

                allCustomers = [];
                const selectEl = document.getElementById('order-customer-id');
                selectEl.innerHTML = '<option value="">-- 专 拽 --</option>'; // Clear existing
                
                snapshot.forEach(doc => {
                    const customer = { id: doc.id, ...doc.data() };
                    allCustomers.push(customer);
                    
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.text = `${customer.name} (${customer.customer_id || ' 住驻专'})`;
                    selectEl.appendChild(option);
                });
                
                document.getElementById('customers-count').innerText = allCustomers.length;
                renderCustomersList();
                SmartLog.info(`Loaded ${allCustomers.length} customers`, "Data.Customers");
            }, (error) => {
                SmartLog.error(error, "Data.Customers.ListenFailed");
                document.getElementById('customers-loading').innerText = '砖 注转 拽转.';
            });
        }

        // 3. Listen for Logs
        function listenForLogs() {
            if (logUnsubscribe) logUnsubscribe();
            
            const q = query(
                collection(db, 'system_logs_v3'), 
                orderBy('timestamp', 'desc'), 
                limit(50)
            );
            
            const logsList = document.getElementById('logs-list');
            
            logUnsubscribe = onSnapshot(q, (snapshot) => {
                logsList.innerHTML = ''; // Clear logs
                snapshot.forEach(doc => {
                    const log = doc.data();
                    const logTime = log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleString('he-IL') : '...';
                    const levelColor = log.level === 'error' ? 'text-red-400' : (log.level === 'warn' ? 'text-yellow-400' : 'text-green-400');
                    
                    const logEntry = document.createElement('p');
                    logEntry.className = 'mb-2 border-b border-gray-700 pb-2';
                    logEntry.innerHTML = `
                        <span class="text-gray-500">${logTime}</span><br>
                        <span class="${levelColor} font-bold">[${log.level.toUpperCase()}]</span>
                        <span class="text-cyan-400">[${log.category}]</span><br>
                        <span class="whitespace-pre-wrap">${log.message}</span>
                    `;
                    logsList.appendChild(logEntry);
                });
            }, (error) => {
                SmartLog.error(error, "Data.Logs.ListenFailed");
                logsList.innerHTML = '<p class="text-red-400">砖 注转 .</p>';
            });
        }
        
        // 4.  注转 砖转 拽转 (砖)
        function listenForNewMessages() {
            if (messagesUnsubscribe) messagesUnsubscribe();
            
            const badge = document.getElementById('notification-badge');
            const list = document.getElementById('messages-list');
            
            // 砖转转 Collection Group - 专砖转 拽住
            const q = query(
                collectionGroup(db, 'messages'),
                where('type', '==', 'message_to_admin'),
                where('readByViewer', '==', false)
                // 住专  驻   注 爪专 拽住 住祝.
                //  转爪注 转 -JS 专 拽转 转.
            );
            
            messagesUnsubscribe = onSnapshot(q, (snapshot) => {
                const loadingEl = document.getElementById('messages-loading');
                if (loadingEl) loadingEl.style.display = 'none';
                
                list.innerHTML = ''; // 拽 专砖 拽转
                const newMessages = [];
                
                snapshot.forEach(doc => {
                    const message = { id: doc.id, ...doc.data() };
                    // 转 住 专 ()
                    message.orderDocPath = doc.ref.parent.parent.path;
                    message.orderId = doc.ref.parent.parent.id;
                    newMessages.push(message);
                });
                
                // 注 驻注
                if (newMessages.length > 0) {
                    badge.innerText = newMessages.length;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
                
                //  注转 (砖 转专 注)
                newMessages.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                // 专专 专住转
                if (newMessages.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-center"> 注转 砖转.</p>';
                    return;
                }
                
                newMessages.forEach(msg => {
                    const card = document.createElement('div');
                    card.className = 'message-card unread p-4 bg-white rounded-lg shadow border-l-4 border-blue-500';
                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold text-blue-600">${msg.senderName || '拽'}</span>
                            <span class="text-xs text-gray-500">${msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleString('he-IL') : ''}</span>
                        </div>
                        <p class="text-gray-800 mb-3">${msg.text}</p>
                        <div class="text-xs text-gray-500 mb-3">
                             : <span class="font-mono">${msg.orderId}</span>
                        </div>
                        <button onclick="showSendReplyModal(event, '${msg.orderDocPath}', '${msg.id}', '${msg.senderName || '拽'}', '${msg.orderId}')" class="text-sm bg-blue-500 text-white py-1 px-3 rounded-md hover:bg-blue-600">
                            <i class="fas fa-reply"></i> 砖 转砖
                        </button>
                    `;
                    list.appendChild(card);
                });

            }, (error) => {
                SmartLog.error(error, "Data.Messages.ListenFailed");
                console.error("Error listening to messages: ", error);
                document.getElementById('messages-loading').innerText = '砖 注转 注转. 转 砖专砖 拽住 -Firestore.';
            });
        }

        // --- Rendering Functions ---
        
        function renderOrdersList() {
            const list = document.getElementById('orders-list');
            const search = document.getElementById('orders-search').value.toLowerCase();
            list.innerHTML = '';
            
            const filtered = allOrders.filter(order => 
                (order.customer_name && order.customer_name.toLowerCase().includes(search)) ||
                (order.order_id && order.order_id.includes(search)) ||
                (order.customer_id && order.customer_id.includes(search)) ||
                (order.customer_address && order.customer_address.toLowerCase().includes(search))
            );
            
            if (filtered.length === 0) {
                list.innerHTML = '<p> 爪 转 驻注转.</p>';
                return;
            }
            
            filtered.forEach(order => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow border-l-4 border-blue-500';
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-lg">${order.customer_name}</h3>
                        <span class="text-sm font-mono bg-gray-200 text-gray-700 px-2 py-1 rounded">${order.order_id || order.id}</span>
                    </div>
                    <p class="text-gray-600">${order.customer_address}</p>
                    <p class="text-sm text-gray-500">${order.delivery_date} | ${order.warehouse}</p>
                    <div class="mt-4 flex gap-2 flex-wrap">
                        <select onchange="updateOrderStatus(event, '${order.id}')" class="border p-2 rounded-md bg-gray-50 text-sm">
                            <option value="砖" ${order.status === '砖' ? 'selected' : ''}>砖</option>
                            <option value="驻" ${order.status === '驻' ? 'selected' : ''}>驻</option>
                            <option value="专" ${order.status === '专' ? 'selected' : ''}>专</option>
                            <option value="住驻拽" ${order.status === '住驻拽' ? 'selected' : ''}>住驻拽</option>
                            <option value="" ${order.status === '' ? 'selected' : ''}></option>
                        </select>
                        <button onclick="showAssignDriverModal('${order.id}')" class="text-sm bg-green-500 text-white py-2 px-3 rounded-md hover:bg-green-600"><i class="fas fa-truck"></i> 砖 </button>
                        <button onclick="copyCustomerLink('${order.id}')" class="text-sm bg-blue-500 text-white py-2 px-3 rounded-md hover:bg-blue-600"><i class="fas fa-link"></i> 拽 拽</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }
        
        function renderCustomersList() {
            const list = document.getElementById('customers-list');
            const search = document.getElementById('customers-search').value.toLowerCase();
            list.innerHTML = '';
            
            const filtered = allCustomers.filter(customer => 
                (customer.name && customer.name.toLowerCase().includes(search)) ||
                (customer.customer_id && customer.customer_id.includes(search)) ||
                (customer.phone && customer.phone.includes(search)) ||
                (customer.default_address && customer.default_address.toLowerCase().includes(search))
            );

            if (filtered.length === 0) {
                list.innerHTML = '<p> 爪 拽转.</p>';
                return;
            }
            
            filtered.forEach(customer => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow';
                card.innerHTML = `
                    <h3 class="font-bold text-lg">${customer.name}</h3>
                    <p class="text-gray-600">${customer.customer_id || ' 住驻专 拽'}</p>
                    <p class="text-gray-600">${customer.phone || ' 驻'}</p>
                    <p class="text-sm text-gray-500">${customer.default_address || ' 转转'}</p>
                    <div class="mt-4 flex gap-2">
                        <button onclick="showEditCustomerModal('${customer.id}')" class="text-sm bg-yellow-500 text-white py-2 px-3 rounded-md hover:bg-yellow-600"><i class="fas fa-edit"></i> 注专</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }
        
        // --- UI Functions ---

        function showPanelTab(panelId) {
            // Hide all panels
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            // Deactivate all tabs
            document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            
            // Show selected panel and activate tab
            document.getElementById(panelId).classList.add('active');
            const tabId = `tab-${panelId.split('-')[0]}`;
            document.getElementById(tabId).classList.add('active');
        }
        window.showPanelTab = showPanelTab;

        function filterLists() {
            renderOrdersList();
            renderCustomersList();
        }
        window.filterLists = filterLists;
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            let icon = '<i class="fas fa-info-circle"></i>';
            let bgColor = 'bg-blue-500';
            if (type === 'success') {
                icon = '<i class="fas fa-check-circle"></i>';
                bgColor = 'bg-green-500';
            } else if (type === 'error') {
                icon = '<i class="fas fa-times-circle"></i>';
                bgColor = 'bg-red-500';
            }
            
            toast.className = `p-4 rounded-lg shadow-lg text-white ${bgColor} mb-2 transform translate-y-10 opacity-0 transition-all duration-300 ease-out`;
            toast.innerHTML = `<span class="mr-2">${icon}</span> ${message}`;
            
            container.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-y-10');
                toast.classList.remove('opacity-0');
            }, 100);
            
            // Animate out
            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.classList.add('-translate-x-full');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }

        // --- CRUD Functions ---

        // 1. New Order Form
        const newOrderForm = document.getElementById('new-order-form');
        newOrderForm.addEventListener('submit', submitNewOrder);

        async function submitNewOrder(e) {
            e.preventDefault();
            const form = e.target;
            
            // 抓 住驻专  住驻专 拽 (驻爪)
            const customOrderNumber = form['order-number-custom'].value.trim();
            const customCustomerNumber = form['order-customer-number-custom'].value.trim();

            const newOrder = {
                customer_name: form['order-customer-name'].value,
                customer_id: customCustomerNumber || form['order-customer-id'].value, // 住驻专 拽 转  
                customer_phone: form['order-customer-phone'].value,
                customer_address: form['order-customer-address'].value,
                delivery_date: form['order-delivery-date'].value,
                orderTime: form['order-delivery-time'].value, // (v31.9.1)
                notes: form['order-notes'].value,
                warehouse: form['order-warehouse'].value,
                deliveryType: form['order-delivery-type'].value, // (v31.9.2)
                status: "砖",
                createdAt: serverTimestamp(),
                createdBy: "AdminPanel",
                order_id: customOrderNumber || `AUTO-${Date.now().toString().slice(-6)}` // 住驻专  转  
            };
            
            SmartLog.info("Attempting to create new order...", "CRUD.Order.Create", newOrder);
            
            try {
                const docRef = await addDoc(collection(db, "orders"), newOrder);
                SmartLog.info(`Order created successfully: ${docRef.id}`, "CRUD.Order.CreateSuccess");
                showToast(' 砖 爪专 爪!', 'success');
                form.reset();
                showPanelTab('orders-panel');
            } catch (error) {
                SmartLog.error(error, "CRUD.Order.CreateFailed", newOrder);
                showToast('砖 爪专转 .', 'error');
            }
        }

        function fillCustomerData(customerId) {
            if (!customerId) {
                // Clear form if "select" is chosen
                document.getElementById('order-customer-name').value = '';
                document.getElementById('order-customer-phone').value = '';
                document.getElementById('order-customer-address').value = '';
                document.getElementById('order-customer-number-custom').value = '';
                return;
            }
            const customer = allCustomers.find(c => c.id === customerId);
            if (customer) {
                document.getElementById('order-customer-name').value = customer.name || '';
                document.getElementById('order-customer-phone').value = customer.phone || '';
                document.getElementById('order-customer-address').value = customer.default_address || '';
                document.getElementById('order-customer-number-custom').value = customer.customer_id || '';
            }
        }
        
        // 2. Update Order Status
        async function updateOrderStatus(event, orderId) {
            const newStatus = event.target.value;
            const orderRef = doc(db, 'orders', orderId);
            
            SmartLog.info(`Updating status for order ${orderId} to ${newStatus}`, "CRUD.Order.UpdateStatus");
            try {
                await updateDoc(orderRef, {
                    status: newStatus,
                    lastModified: serverTimestamp()
                });
                showToast(`住住  ${orderId} 注 : ${newStatus}`, 'success');
            } catch (error) {
                SmartLog.error(error, "CRUD.Order.UpdateStatusFailed", { orderId, newStatus });
                showToast('砖 注 住住.', 'error');
            }
        }
        window.updateOrderStatus = updateOrderStatus;
        
        // 3. Assign Driver (Placeholder for Modal)
        function showAssignDriverModal(orderId) {
            // This function would open a modal to assign a driver
            SmartLog.info(`Opening assign driver modal for order: ${orderId}`, "UI.Modal");
            openModal(
                `<h3>砖   ${orderId}</h3>`, 
                `<p> 爪 专砖转  ...</p><button onclick="closeModal()" class="mt-4 bg-blue-500 text-white py-2 px-4 rounded">住专</button>`
            );
        }
        window.showAssignDriverModal = showAssignDriverModal;

        // 4. Edit Customer (Modal)
        async function showEditCustomerModal(customerId) {
            const customer = allCustomers.find(c => c.id === customerId);
            if (!customer) {
                showToast(' 转 爪 拽', 'error');
                return;
            }
            
            const content = `
                <div class="p-6">
                    <h3 class="text-lg font-semibold mb-4">注专转 拽: ${customer.name}</h3>
                    <form id="edit-customer-form" class="space-y-3">
                        <input type="hidden" id="edit-customer-doc-id" value="${customer.id}">
                        <div>
                            <label class="block text-sm font-medium">砖 拽 ()</label>
                            <input type="text" id="edit-customer-name" class="mt-1 w-full p-2 border rounded" value="${customer.name || ''}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">住驻专 拽 ()</label>
                            <input type="text" id="edit-customer-number" class="mt-1 w-full p-2 border rounded" value="${customer.customer_id || ''}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">驻</label>
                            <input type="tel" id="edit-customer-phone" class="mt-1 w-full p-2 border rounded" value="${customer.phone || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">转转 专专转 </label>
                            <input type="text" id="edit-customer-address" class="mt-1 w-full p-2 border rounded" value="${customer.default_address || ''}">
                        </div>
                        <div class="flex justify-end gap-3 mt-4">
                            <button type="button" onclick="closeModal()" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300"></button>
                            <button type="submit" class="py-2 px-4 bg-green-500 text-white rounded-md hover:bg-green-600">砖专 砖</button>
                        </div>
                    </form>
                </div>
            `;
            openModal('', content, false); // No header, content has all
            
            // Attach submit listener
            document.getElementById('edit-customer-form').addEventListener('submit', handleUpdateCustomer);
        }
        window.showEditCustomerModal = showEditCustomerModal;

        async function handleUpdateCustomer(e) {
            e.preventDefault();
            const form = e.target;
            const customerId = form['edit-customer-doc-id'].value;
            const customerRef = doc(db, 'customers', customerId);
            
            const oldData = allCustomers.find(c => c.id === customerId);
            
            const updatedData = {
                name: form['edit-customer-name'].value,
                customer_id: form['edit-customer-number'].value,
                phone: form['edit-customer-phone'].value,
                default_address: form['edit-customer-address'].value,
                lastModified: serverTimestamp()
            };

            SmartLog.info(`Updating customer ${customerId}`, "CRUD.Customer.Update", { old: oldData, new: updatedData });

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Update the customer document
                    transaction.update(customerRef, updatedData);
                    
                    // 2. Log the change in the customer's private audit log
                    const logRef = doc(collection(db, 'customers', customerId, 'auditLog'));
                    transaction.set(logRef, {
                        timestamp: serverTimestamp(),
                        action: "ADMIN_UPDATE",
                        userId: currentUserId,
                        changes: {
                            old: { name: oldData.name, id: oldData.customer_id, phone: oldData.phone, address: oldData.default_address },
                            new: { name: updatedData.name, id: updatedData.customer_id, phone: updatedData.phone, address: updatedData.default_address }
                        }
                    });

                    // 3. (v31.6) Check if default address changed, and if so, update active orders
                    if (oldData.default_address !== updatedData.default_address) {
                        const q = query(
                            collection(db, 'orders'), 
                            where('customer_id', '==', oldData.customer_id),
                            where('status', 'not-in', ['住驻拽', ''])
                        );
                        
                        const ordersSnap = await getDocs(q); // Note: getDocs inside transaction is OK
                        ordersSnap.forEach(orderDoc => {
                            if (orderDoc.data().customer_address === oldData.default_address) {
                                transaction.update(orderDoc.ref, {
                                    customer_address: updatedData.default_address,
                                    lastModified: serverTimestamp(),
                                    log: `Address auto-updated by admin edit (${new Date().toISOString()})`
                                });
                            }
                        });
                        SmartLog.info(`Found ${ordersSnap.size} active orders to check for address update`, "CRUD.Customer.Update");
                    }
                });
                
                showToast('驻专 拽 注 爪', 'success');
                SmartLog.info(`Customer ${customerId} updated successfully`, "CRUD.Customer.UpdateSuccess");
                closeModal();
                
            } catch (error) {
                SmartLog.error(error, "CRUD.Customer.UpdateFailed", { customerId });
                showToast('砖 注 驻专 拽', 'error');
            }
        }

        // 5. Copy Customer Link (转拽: 砖专 砖砖 -order_id)
        async function copyCustomerLink(orderId) {
            // orderId   -Document ID
            if (!orderId) {
                showToast('  住专', 'error');
                return;
            }
            
            SmartLog.info(`Fetching order_id for doc: ${orderId}`, "UI.CopyLink");

            try {
                // 砖 1: 砖祝 转 住  拽 转 砖 "order_id"
                const orderRef = doc(db, "orders", orderId);
                const orderSnap = await getDoc(orderRef);
                
                if (!orderSnap.exists()) {
                    showToast('  爪', 'error');
                    SmartLog.error(new Error("Order document not found"), "UI.CopyLink", { orderId });
                    return;
                }
                
                const orderData = orderSnap.data();
                const shortOrderId = orderData.order_id; //  住驻专  拽爪专, 砖 "6715504"

                if (!shortOrderId) {
                     showToast('砖:    "住驻专 " (order_id)', 'error');
                     SmartLog.error(new Error("Order document is missing 'order_id' field"), "UI.CopyLink", { orderId });
                     return;
                }

                // 砖 2: 拽注 转 转转 住住 砖 驻拽爪转 拽
                // 砖 转 "/app/customer"  转 爪 砖
                const baseUrl = window.location.origin + "/app/customer"; 
                
                // 砖 3: 爪专 转 拽  注 住驻专  拽爪专
                const customerLink = `${baseUrl}?id=${shortOrderId}`;
                
                // 砖 4: 注转拽 
                const tempInput = document.createElement("textarea");
                tempInput.value = customerLink;
                tempInput.style.position = 'absolute';
                tempInput.style.left = '-9999px';
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand("copy");
                document.body.removeChild(tempInput);
                
                showToast('拽砖专 拽 注转拽!', 'success');
                SmartLog.info(`Link copied: ${customerLink}`, "UI.CopyLinkSuccess");

            } catch (error) {
                SmartLog.error(error, "UI.CopyLinkFailed", { orderId });
                showToast('砖 注转拽转 拽砖专', 'error');
            }
        }
        window.copyCustomerLink = copyCustomerLink; // Make global

        // 6. 注专转 注转 (驻拽爪转 砖转)
        
        // 驻转转  转砖
        function showSendReplyModal(event, orderDocPath, messageId, customerName, orderId) {
            event.stopPropagation(); // 注 住专 砖 驻   转 
            
            document.getElementById('reply-modal-order-id').innerText = orderId || ' 注';
            document.getElementById('reply-modal-customer-name').innerText = customerName || '拽';
            document.getElementById('reply-modal-doc-id').value = orderDocPath;
            document.getElementById('reply-modal-msg-id').value = messageId;
            document.getElementById('reply-message-text').value = '';
            
            document.getElementById('reply-modal').classList.remove('hidden');
        }
        window.showSendReplyModal = showSendReplyModal;

        function closeReplyModal() {
            document.getElementById('reply-modal').classList.add('hidden');
        }
        window.closeReplyModal = closeReplyModal;

        // 砖转 转专 拽
        async function sendAdminReply() {
            const orderDocPath = document.getElementById('reply-modal-doc-id').value;
            const originalMessageId = document.getElementById('reply-modal-msg-id').value;
            const messageText = document.getElementById('reply-message-text').value.trim();
            
            if (!orderDocPath || !originalMessageId || !messageText) {
                showToast('砖: 住专 转 砖转 转砖', 'error');
                return;
            }
            
            const batch = writeBatch(db);
            
            // 1. 住 转 注 拽专转 "拽专"
            const msgRef = doc(db, `${orderDocPath}/messages/${originalMessageId}`);
            batch.update(msgRef, { readByViewer: true });
            
            // 2. 住祝 转 转专 砖 拽
            const newAlertRef = doc(collection(db, `${orderDocPath}/messages`));
            batch.set(newAlertRef, {
                text: messageText,
                type: "notification_to_customer", // 住 转专 拽
                senderName: "砖专转 拽转",
                timestamp: serverTimestamp(),
                readByViewer: true //  拽专 转 注 砖 注爪
            });
            
            SmartLog.info(`Sending reply to ${orderDocPath}`, "CRUD.Message.Reply", { text: messageText });

            try {
                await batch.commit();
                showToast('转专 砖 拽 爪', 'success');
                closeReplyModal();
            } catch (error) {
                SmartLog.error(error, "CRUD.Message.ReplyFailed");
                showToast('砖 砖转 转专', 'error');
            }
        }
        window.sendAdminReply = sendAdminReply;
        
        // --- Global Ping Function ---
        async function sendGlobalPing() {
             const message = prompt(" 注 转专 转 (砖: ' 专 '):");
             if (!message || message.trim() === '') {
                 showToast('砖转 转专 ', 'info');
                 return;
             }
             
             SmartLog.info("Sending global ping...", "CRUD.Ping", { message });
             try {
                 const pingRef = doc(collection(db, "globalPings")); // New collection
                 await setDoc(pingRef, {
                     type: "MANAGER_BROADCAST",
                     message: message.trim(),
                     sender: "Admin",
                     createdAt: serverTimestamp()
                 });
                 showToast('转专 转 砖 爪', 'success');
                 SmartLog.info("Global ping sent successfully", "CRUD.Ping");
             } catch (error) {
                 SmartLog.error(error, "CRUD.Ping", { message });
                 showToast('砖 砖转 转专 转', 'error');
             }
        }
        window.sendGlobalPing = sendGlobalPing; // Make global

        // --- Generic Modal Functions ---
        function openModal(title, content, showHeader = true) {
            const modalContent = `
                ${showHeader ? `
                <div class="flex justify-between items-center p-4 border-b">
                    <h2 class="text-xl font-semibold">${title}</h2>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">&times;</button>
                </div>` : ''}
                <div id="modal-body" class="p-1">${content}</div>
            `;
            document.getElementById('modal-content-inner').innerHTML = modalContent;
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal-content-inner').innerHTML = '';
            document.getElementById('modal').classList.add('hidden');
        }
        window.closeModal = closeModal; // Make global

    </script>
</body>
</html>

