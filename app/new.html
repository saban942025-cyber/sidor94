<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v32.6 (拽 驻)</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/feather-icons"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- 住转 CSS -  砖 拽专 -->
    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
        }

        html, body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            direction: rtl;
            background-color: var(--bg-light);
            margin: 0;
            padding: 0;
            scroll-behavior: smooth;
        }

        * { box-sizing: border-box; }

        .mock-header {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .mock-header h1 { margin: 0; font-size: 1.5rem; }
        .nav-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .nav-button:hover { background-color: #2980b9; }

        /* 住转 专  -Toast */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* 住转专 专专转  */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-content {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            width: 500px;
            overflow: hidden;
        }

        /* 住转   转 */
        .eco-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .eco-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .overdue-card {
            border: 2px solid #e74c3c; /* Red border for overdue */
            background-color: #fce7e7;
        }
        .overdue-text {
            color: #e74c3c; /* Red text for overdue days */
            font-weight: 600;
        }
        .normal-text {
            color: #2ecc71; /* Green text for normal days */
            font-weight: 600;
        }

        /* 住 -Toast Notification */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column-reverse; /*  砖砖 驻注  */
            gap: 10px;
        }
        .toast {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { background-color: #2ecc71; }
        .toast.error { background-color: #e74c3c; }
        .toast.info { background-color: #3498db; }
        
        /* Map Styles */
        #map {
            height: 60vh;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        .leaflet-popup-content p {
            margin: 0.25rem 0;
        }
        .leaflet-marker-icon {
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.5));
        }

    </style>
</head>
<body>

    <!-- 注转 Firebase -->
    <script type="module">
        // 注: 砖 专住 9.15.0 住驻转 驻拽爪转 Timestamp, getApps, getApp
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, 
            collection, query, where, Timestamp, runTransaction, getDocs, orderBy, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        // --- Mandatory Firebase Config & Auth (using globals) ---
        // 注: 砖砖 驻转转 砖住驻拽 专专转  (Fallback)
        const fallbackConfig = {
            apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
            authDomain: "saban94-76543.firebaseapp.com", 
            projectId: "saban94-76543",
            storageBucket: "saban94-76543.appspot.com", 
            messagingSenderId: "41553157903", 
            appId: "1:41553157903:web:cc33d252cff023be97a87a", 
            measurementId: "G-XV6RZDESSB"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : fallbackConfig;

        // --- 砖转  ---
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.firebaseAuthReady = false; //  转 住住 注转 Firebase

        // 专转 专转  -Firestore (专 砖-SDK 注)
        setLogLevel('debug');

        // 驻拽爪转 注专 转 砖 住住 专 砖  (砖)
        function calculateOverdueStatus(rentalStartDate, returnDate = null, maxDaysAllowed = 7) {
            if (!rentalStartDate) {
                return { isOverdue: false, daysOverdue: 0, daysLeft: maxDaysAllowed, daysElapsed: 0, returned: false };
            }

            let startDateMs;
            // 驻 -Firebase Timestamp  Date
            if (rentalStartDate.toDate) {
                startDateMs = rentalStartDate.toDate().getTime();
            } else if (rentalStartDate instanceof Date) {
                startDateMs = rentalStartDate.getTime();
            } else if (typeof rentalStartDate === 'number') {
                startDateMs = rentalStartDate;
            } else {
                return { isOverdue: false, daysOverdue: 0, daysLeft: maxDaysAllowed, daysElapsed: 0, returned: false };
            }

            //   专
            if (returnDate) {
                return { isOverdue: false, daysOverdue: 0, daysLeft: 0, daysElapsed: 0, returned: true };
            }

            // 砖  砖 砖注专 (注 驻 注    转)
            const todayMs = new Date().setHours(0, 0, 0, 0); //   爪转
            const startDayMs = new Date(startDateMs).setHours(0, 0, 0, 0); // 转专 转 爪转
            
            //  砖驻 (  转)
            const timeElapsedMs = todayMs - startDayMs;
            const daysElapsed = Math.floor(timeElapsedMs / (1000 * 60 * 60 * 24)) + 1; 

            // 砖 住住
            const daysLeft = maxDaysAllowed - daysElapsed;
            const isOverdue = daysElapsed > maxDaysAllowed;
            const daysOverdue = isOverdue ? daysElapsed - maxDaysAllowed : 0;

            return {
                isOverdue: isOverdue,
                daysOverdue: daysOverdue,
                daysLeft: Math.max(0, daysLeft),
                daysElapsed: daysElapsed,
                returned: false
            };
        }
        window.calculateOverdueStatus = calculateOverdueStatus; // 砖驻 转

        // 驻拽爪转 转
        async function initializeFirebase() {
             
            let app;
            // 注 转 专 砖 驻拽爪 -Hot Reloading
            if (getApps().length) {
                app = getApp();
            } else {
                app = initializeApp(firebaseConfig);
            }

            window.db = getFirestore(app);
            window.auth = getAuth(app);
            
            // 砖驻转 砖专转 Firebase 转
            window.firebaseServices = { 
                db: window.db, 
                auth: window.auth, 
                collection, onSnapshot, query, where, orderBy, 
                addDoc, Timestamp, doc, updateDoc, deleteDoc, serverTimestamp, runTransaction, getDocs 
            };
            
            // 注转 注 注 砖转砖
            onAuthStateChanged(window.auth, async (user) => {
                if (!user) {
                    // 住 爪注转 Custom Token  转
                    try {
                        if (window.initialAuthToken) {
                            await signInWithCustomToken(window.auth, window.initialAuthToken);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    } catch (error) {
                        console.error("Firebase Sign In Failed (Fallback to Anonymous):", error);
                    }
                }
                
                // 住 转 转拽爪,  转 转 驻拽爪
                const currentUser = window.auth.currentUser;
                if (currentUser) {
                    window.userId = currentUser.uid;
                    window.firebaseAuthReady = true;
                    document.dispatchEvent(new CustomEvent('firebaseAuthReady'));
                    console.log(`Firebase Ready. User ID: ${window.userId}`);
                    // 注  砖 -userId 转爪
                    const userIdElement = document.getElementById('current-user-id');
                    if (userIdElement) {
                        userIdElement.textContent = window.userId;
                    }
                }
            });
        }

        initializeFirebase();

        // 驻拽爪转 转 砖驻 专 window.firebaseServices
        // (砖  砖砖  拽 住拽专驻 转转 拽 拽专 砖专 驻拽爪转 砖转)
        
    </script>


    <!-- 专 UI 专 (转专转 ) -->
    <div class="mock-header">
        <h1> DeliveryMaster</h1>
        <div class="flex items-center space-x-4 space-x-reverse">
            <button id="openEcoDashboardButton" class="nav-button">
                 转 (ECO)
            </button>
            <button id="openMapDashboardButton" class="nav-button">
                驻 
            </button>
        </div>
    </div>
    <div class="p-4 bg-gray-200 text-sm text-gray-700">
        <span class="font-bold">砖转砖:</span> <span id="current-user-id" class="ltr inline-block bg-white px-2 py-0.5 rounded shadow-sm text-xs">...注...</span>
    </div>

    <!-- Container Dashboard (  转) -->
    <div id="container-dashboard" class="p-6 hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800"> 转 (8 拽)</h2>
            <button id="openContainerCreateModalButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center">
                <i data-feather="plus-circle" class="w-5 h-5 ml-2"></i>
                住祝 转 
            </button>
        </div>
        
        <!--  住 驻砖 -->
        <div class="mb-6 flex space-x-4 space-x-reverse">
            <input type="text" id="container-search-input" placeholder="驻砖 驻 砖 拽  转转..." 
                   class="flex-grow p-3 border border-gray-300 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150">
            
            <select id="container-status-filter" class="p-3 border border-gray-300 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150 w-48">
                <option value="all"> 住住</option>
                <option value="active">驻注</option>
                <option value="overdue">专</option>
                <option value="pending">专  (转)</option>
            </select>
        </div>

        <!-- 专砖转 转 -->
        <div id="containers-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- 专住 转 注  -->
            <p id="loading-message" class="col-span-full text-center text-gray-500">注 转 转...</p>
        </div>
    </div>

    <!-- Map Dashboard (驻) -->
    <div id="map-dashboard" class="p-6 hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">驻  砖祝</h2>
        <div id="map"></div>
        
        <div class="mt-6 p-4 bg-white rounded-xl shadow-lg">
            <h3 class="text-xl font-semibold mb-3 border-b pb-2">驻注转 拽</h3>
            <div class="flex space-x-4 space-x-reverse">
                <button id="show-pending-route" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center" disabled>
                    <i data-feather="navigation" class="w-5 h-5 ml-2"></i>
                    爪 住 抓 (转)
                </button>
                <button id="show-active-route" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center" disabled>
                    <i data-feather="map" class="w-5 h-5 ml-2"></i>
                    爪 住 抓 (驻注)
                </button>
            </div>
            <p id="map-status" class="mt-3 text-sm text-gray-500">驻 注, 转 转 转...</p>
        </div>
    </div>
    
    <!-- Modal: 爪专转 转  砖 -->
    <div id="container-create-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="p-6">
                <h3 class="text-xl font-bold mb-4 border-b pb-2">转  砖</h3>
                
                <form id="container-create-form" class="space-y-4">
                    <!-- 砖 拽 -->
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-700">砖 拽</label>
                        <input type="text" id="customer-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <!-- 住  -->
                    <div>
                        <label for="container-size" class="block text-sm font-medium text-gray-700">住 </label>
                        <select id="container-size" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="8 拽">8 拽 (注 10 )</option>
                        </select>
                    </div>
                    <!-- 转转 -->
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700">转转 爪</label>
                        <input type="text" id="address" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- 拽专转 (砖) -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="latitude" class="block text-sm font-medium text-gray-700">Latitude (拽 专)</label>
                            <input type="number" step="any" id="latitude" placeholder="32.1867..." required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 ltr text-right">
                        </div>
                        <div>
                            <label for="longitude" class="block text-sm font-medium text-gray-700">Longitude (拽 专)</label>
                            <input type="number" step="any" id="longitude" placeholder="34.9526..." required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 ltr text-right">
                        </div>
                    </div>
                    
                    <!-- 驻转专 Geocode (砖转砖 砖转 拽专转) -->
                    <button type="button" id="geocode-button" class="w-full bg-purple-500 hover:bg-purple-600 text-white text-sm py-2 px-3 rounded-md transition duration-150">
                        转专/转 拽 转转 ( 砖转砖 转 砖)
                    </button>
                    <!-- 住 驻注 -->
                    <div>
                        <label for="delivery-type" class="block text-sm font-medium text-gray-700">住 驻注</label>
                        <select id="delivery-type" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="Delivery">爪</option>
                            <option value="Replace">驻</option>
                            <option value="Removal">爪</option>
                        </select>
                    </div>
                    <!-- 转专/砖注转  转 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="order-date" class="block text-sm font-medium text-gray-700">转专 转</label>
                            <input type="date" id="order-date" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="order-time" class="block text-sm font-medium text-gray-700">砖注转 转</label>
                            <input type="time" id="order-time" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <!-- 注专转 -->
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700">注专转</label>
                        <textarea id="notes" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>

                    <!-- 驻转专 砖  -->
                    <div class="flex justify-end space-x-3 space-x-reverse pt-4">
                        <button type="button" id="close-create-modal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-150">
                            
                        </button>
                        <button type="submit" id="save-new-container-order" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                            砖专 
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: 注专转 转  拽转 -->
    <div id="container-edit-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="p-6">
                <h3 class="text-xl font-bold mb-4 border-b pb-2">注专转 转  <span id="container-edit-id" class="text-sm text-gray-500"></span></h3>
                
                <form id="container-edit-form" class="space-y-4">
                    <!-- 砖 拽专 : 砖 拽 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">砖 拽</label>
                        <p id="container-edit-customer-name" class="mt-1 block w-full p-2 bg-gray-100 border border-gray-300 rounded-md"></p>
                    </div>
                    
                    <!-- 砖 拽专 : 住  转转 -->
                    <div class="grid grid-cols-2 gap-4">
                         <div>
                            <label class="block text-sm font-medium text-gray-700">住 </label>
                            <p id="container-edit-container-size" class="mt-1 block w-full p-2 bg-gray-100 border border-gray-300 rounded-md"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">转转</label>
                            <p id="container-edit-address" class="mt-1 block w-full p-2 bg-gray-100 border border-gray-300 rounded-md"></p>
                        </div>
                    </div>
                    
                    <!-- 拽专转 (拽专  注专, 拽 砖专 爪专) -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Latitude (拽 专)</label>
                            <p id="container-edit-latitude" class="mt-1 block w-full p-2 bg-gray-100 border border-gray-300 rounded-md ltr text-right"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Longitude (拽 专)</label>
                            <p id="container-edit-longitude" class="mt-1 block w-full p-2 bg-gray-100 border border-gray-300 rounded-md ltr text-right"></p>
                        </div>
                    </div>

                    <!-- 住 驻注 (转 注专) -->
                    <div>
                        <label for="container-edit-delivery-type" class="block text-sm font-medium text-gray-700">住 驻注</label>
                        <select id="container-edit-delivery-type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="Delivery">爪</option>
                            <option value="Replace">驻</option>
                            <option value="Removal">爪</option>
                        </select>
                    </div>

                    <!-- 转专/砖注转  转 (转 注专) -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="container-edit-order-date" class="block text-sm font-medium text-gray-700">转专 转</label>
                            <input type="date" id="container-edit-order-date" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="container-edit-order-time" class="block text-sm font-medium text-gray-700">砖注转 转</label>
                            <input type="time" id="container-edit-order-time" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <!-- 转专 转转 砖专转 (专转 "驻注") - 转 注专 -->
                    <div>
                        <label for="container-edit-rental-start-date" class="block text-sm font-medium text-gray-700">转专 转转 砖专转 (专 '驻注')</label>
                        <input type="datetime-local" id="container-edit-rental-start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">拽 转 转专  专 住住 '转'.</p>
                    </div>

                    <!-- 注专转 (转 注专) -->
                    <div>
                        <label for="container-edit-notes" class="block text-sm font-medium text-gray-700">注专转</label>
                        <textarea id="container-edit-notes" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    
                    <!-- 驻转专 砖 拽 -->
                    <div class="flex justify-between items-center pt-4">
                        <button type="button" id="delete-container-order" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                            拽 
                        </button>
                        <div class="flex space-x-3 space-x-reverse">
                             <button type="button" id="close-edit-modal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-150">
                                
                            </button>
                            <button type="submit" id="save-edited-container-order" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                                砖专 砖
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal: 砖专 拽 -->
    <div id="delete-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="p-6 text-center">
                <i data-feather="alert-triangle" class="w-12 h-12 text-red-500 mx-auto mb-4"></i>
                <h3 class="text-xl font-bold mb-2">砖专 拽转 </h3>
                <p id="delete-confirm-message" class="text-gray-700 mb-6"> 转  砖专爪 拽 转  注专 拽 **?  转  驻注 .</p>
                <div class="flex justify-center space-x-4 space-x-reverse">
                    <button id="cancel-delete-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-150">
                        
                    </button>
                    <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                        拽 爪转转
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <!-- 住拽专驻 专砖 -->
    <script>
        // --- Smart Logging Functionality ---
        const SmartLog = {
            info: (message, context, details = {}) => console.log(`[INFO] [${context}] ${message}`, details),
            error: (error, context, details = {}) => console.error(`[ERROR] [${context}] ${error.message || error}`, details, error)
        };
        
        // --- Toast Notification ---
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type} shadow-lg`;
            toast.textContent = message;
            
            // 住驻转 拽住 拽专 (驻 转  注)
            container.appendChild(toast);
            
            // 驻注: 驻   拽 (驻砖专 爪)
            setTimeout(() => toast.classList.add('show'), 10);

            // 住专 转
            setTimeout(() => {
                toast.classList.remove('show');
                // 住专 -DOM 专 住 爪
                setTimeout(() => container.removeChild(toast), 300);
            }, duration);
        }
        window.showToast = showToast; // 砖驻 转
        
        // --- Modal Control Functions ---
        const getModal = (id) => document.getElementById(id);
        const openModal = (id) => getModal(id)?.style.setProperty('display', 'flex');
        const closeModal = (id) => getModal(id)?.style.setProperty('display', 'none');

        // 驻拽爪转 住驻爪驻转
        const openContainerCreateModal = () => openModal('container-create-modal');
        const closeContainerCreateModal = () => closeModal('container-create-modal');
        const openContainerEditModal = () => openModal('container-edit-modal');
        const closeContainerEditModal = () => closeModal('container-edit-modal');
        const openDeleteConfirmModal = () => openModal('delete-confirm-modal');
        const closeDeleteConfirmModal = () => closeModal('delete-confirm-modal');


        // --- Firestore Utilities ---
        /**
         * Generates the collection path for a user's private data.
         * @param {string} collectionName - The name of the collection (e.g., 'container-orders').
         * @returns {string} The full Firestore path.
         */
        function getPrivateCollectionPath(collectionName) {
            if (!window.userId || !window.appId) {
                SmartLog.error("User ID or App ID missing", "Firestore.Path");
                return null;
            }
            // /artifacts/{appId}/users/{userId}/{your_collection_name}
            return `artifacts/${window.appId}/users/${window.userId}/${collectionName}`;
        }

        /**
         * Geocoding (Mock) - Now prioritizes manually entered coordinates.
         * If the address matches a mock city, it returns that city's coordinates.
         * Otherwise, it uses the coordinates already in the Lat/Lng inputs as the source of truth (if valid).
         */
        async function geocodeAddress(address, currentLat, currentLng) {
             SmartLog.info(`Searching/Verifying coordinates for: ${address}`, "Geocoding.Mock");
             
             // 拽专转 专专转   爪 (驻专 住 - 驻 拽砖转 砖转砖)
             const FALLBACK_LAT = 32.186705; 
             const FALLBACK_LNG = 34.952626;

             // Mock Geocoding for Israeli cities 
             const mockLocations = {
                "转 ": { lat: 32.0853, lng: 34.7818 },
                "专砖": { lat: 31.7683, lng: 35.2137 },
                "驻": { lat: 32.7940, lng: 34.9896 },
                "专 砖注": { lat: 31.2518, lng: 34.7913 },
                "专转 ": { lat: 32.0833, lng: 34.8000 },
                "砖": { lat: 31.7900, lng: 34.6530 },
                "转": { lat: 32.3228, lng: 34.8530 },
                "驻专 住": { lat: FALLBACK_LAT, lng: FALLBACK_LNG }, // 住驻转 驻专 住 拽
             };
             
             const city = Object.keys(mockLocations).find(c => address.includes(c));

             return new Promise(resolve => {
                 setTimeout(() => {
                     let lat = currentLat;
                     let lng = currentLng;
                     let source = 'User Input';

                     if (city) {
                         // 爪 注专 转 拽 - 砖砖 拽专转 拽转 转专
                         lat = mockLocations[city].lat;
                         lng = mockLocations[city].lng;
                         source = `Mock: ${city}`;
                         showToast(`拽 爪 (Mock): ${city}`, 'success', 1500);
                     } else if (isNaN(currentLat) || isNaN(currentLng)) {
                         //  转转  爪  拽专转 砖 - 砖砖 驻拽
                         lat = FALLBACK_LAT;
                         lng = FALLBACK_LNG;
                         source = 'Default Fallback (Kfar Saba)';
                         showToast('转转  爪, 注砖 砖砖 拽 专专转  (驻专 住)', 'info', 3000);
                     } else {
                         // 砖砖 拽专转 砖 转 注" 砖转砖 ( 拽转 转拽转)
                         showToast(`砖转砖 拽 砖: Lat ${lat.toFixed(4)}, Lng ${lng.toFixed(4)}`, 'success', 1500);
                     }

                     resolve({ success: true, lat: parseFloat(lat), lng: parseFloat(lng) });

                 }, 500);
             });
        }


        // --- CRUD Operations for Container Orders ---

        /**
         * Adds a new container order to Firestore.
         */
         async function handleCreateContainerOrder(event) {
             event.preventDefault();
             
             const btn = document.getElementById('save-new-container-order');
             btn.disabled = true;
             btn.innerText = '砖专...';

             try {
                 const { db, collection, addDoc, Timestamp } = window.firebaseServices;
                 const collectionPath = getPrivateCollectionPath('container-orders');
                 if (!collectionPath) return;

                 // Read form data
                 const customerName = document.getElementById('customer-name').value.trim();
                 const containerSize = document.getElementById('container-size').value;
                 const address = document.getElementById('address').value.trim();
                 const latInput = document.getElementById('latitude').value;
                 const lngInput = document.getElementById('longitude').value;
                 const deliveryType = document.getElementById('delivery-type').value;
                 const orderDate = document.getElementById('order-date').value;
                 const orderTime = document.getElementById('order-time').value;
                 const notes = document.getElementById('notes').value.trim();
                 
                 const lat = parseFloat(latInput);
                 const lng = parseFloat(lngInput);
                 
                 if (isNaN(lat) || isNaN(lng)) {
                    throw new Error("  砖 拽专转 Lat/Lng 转拽转 驻 砖专.");
                 }
                 
                 // Combine date and time to a Date object, then to Timestamp
                 const scheduledDateTime = new Date(`${orderDate}T${orderTime}:00`);
                 const scheduledTimestamp = Timestamp.fromDate(scheduledDateTime);

                 const newOrderData = {
                     customerName,
                     containerSize,
                     address,
                     location: { lat, lng }, // 砖专转 拽专转 拽转
                     deliveryType,
                     scheduledAt: scheduledTimestamp,
                     orderDate,
                     orderTime,
                     notes,
                     rentalStartDate: null, // Initial status is pending
                     returnDate: null,
                     createdAt: Timestamp.now(),
                     createdBy: window.userId
                 };

                 await addDoc(collection(db, collectionPath), newOrderData);
                 SmartLog.info("New container order created", "CRUD.Container.Create", newOrderData);
                 showToast('转  砖 爪专 爪!', 'success');

                 // Reset form and close modal
                 document.getElementById('container-create-form').reset();
                 closeContainerCreateModal();

             } catch (error) {
                 showToast(`砖 爪专转 转 : ${error.message}`, 'error');
                 SmartLog.error(error, "CRUD.Container.Create");
             } finally {
                 btn.disabled = false;
                 btn.innerText = '砖专 ';
             }
         }
         
         /**
          * Updates an existing container order in Firestore.
          */
         async function handleSaveContainerOrder(event) {
             event.preventDefault();

             const btn = document.getElementById('save-edited-container-order');
             btn.disabled = true;
             btn.innerText = '砖专...';

             try {
                 const { db, doc, updateDoc, serverTimestamp } = window.firebaseServices;
                 const collectionPath = getPrivateCollectionPath('container-orders');
                 if (!collectionPath) return;

                 const orderId = document.getElementById('container-edit-id').dataset.orderId;
                 const orderRef = doc(db, collectionPath, orderId);

                 // Read editable form data
                 const deliveryType = document.getElementById('container-edit-delivery-type').value;
                 const orderDate = document.getElementById('container-edit-order-date').value;
                 const orderTime = document.getElementById('container-edit-order-time').value;
                 const rentalStartDateTimeLocal = document.getElementById('container-edit-rental-start-date').value;

                 let rentalStartDate = null;
                 
                 // Handle Rental Start Date update
                 if (rentalStartDateTimeLocal) {
                     try {
                         const startDateTime = new Date(rentalStartDateTimeLocal);
                         if (isNaN(startDateTime.getTime())) {
                             throw new Error("转专/砖注 转转 砖专转  转拽.");
                         }
                         // If the date is valid, set it as a Firebase Timestamp
                         rentalStartDate = window.firebaseServices.Timestamp.fromDate(startDateTime);
                     } catch(e) {
                         SmartLog.error(e, "CRUD.Container.Edit", { orderId, date: orderDate, time: orderTime });
                         throw new Error("砖 专转 转专/砖注 转转 砖专转.");
                     }
                 }

                 const updatedData = {
                    deliveryType: deliveryType,
                    orderDate: orderDate,
                    orderTime: orderTime,
                    notes: document.getElementById('container-edit-notes').value.trim(),
                    rentalStartDate: rentalStartDate, // Update or clear the field
                    lastModified: serverTimestamp()
                 };

                 await updateDoc(orderRef, updatedData);
                 SmartLog.info("Container order updated", "CRUD.Container.Edit", { orderId, changes: updatedData });
                 showToast('转  注', 'success');
                 closeContainerEditModal();
                 // Listener will automatically refresh the container view if it's active

             } catch (error) {
                 showToast(`砖 注 转 : ${error.message}`, 'error');
                 SmartLog.error(error, "CRUD.Container.Edit", { orderId });
             } finally {
                 btn.disabled = false;
                 btn.innerText = '砖专 砖';
             }
         }
        window.handleSaveContainerOrder = handleSaveContainerOrder;

        /**
         * Deletes a container order from Firestore.
         */
        let orderToDeleteId = null; // 砖转   砖专转 -ID 驻 砖专

        function openDeleteConfirmation(orderId, customerName) {
            orderToDeleteId = orderId;
            const messageElement = document.getElementById('delete-confirm-message');
            messageElement.innerHTML = ` 转  砖专爪 拽 转  注专 拽 <strong>${customerName}</strong>?  转  驻注 .`;
            openDeleteConfirmModal();
        }
        window.openDeleteConfirmation = openDeleteConfirmation; // 砖驻 转

        async function handleDeleteContainerOrder() {
            const btn = document.getElementById('confirm-delete-btn');
            btn.disabled = true;
            btn.innerText = '拽...';

            try {
                if (!orderToDeleteId) {
                    throw new Error(" 专  拽.");
                }

                const { db, doc, deleteDoc } = window.firebaseServices;
                const collectionPath = getPrivateCollectionPath('container-orders');
                if (!collectionPath) return;

                const orderRef = doc(db, collectionPath, orderToDeleteId);
                await deleteDoc(orderRef);

                SmartLog.info("Container order deleted", "CRUD.Container.Delete", { orderId: orderToDeleteId });
                showToast('转  拽 爪', 'success');
                closeDeleteConfirmModal();
                closeContainerEditModal(); // 住专  转  注专  驻转

            } catch (error) {
                 showToast(`砖 拽转 转 : ${error.message}`, 'error');
                 SmartLog.error(error, "CRUD.Container.Delete", { orderId: orderToDeleteId });
            } finally {
                 btn.disabled = false;
                 btn.innerText = '拽 爪转转';
                 orderToDeleteId = null;
            }
        }

        // --- Container Dashboard Logic ---
        
        // 砖转 砖专转 -map instance 转
        let map;
        let markersGroup = null;
        let containerDataCache = []; // 砖专转 转 转 砖砖 专

        /**
         * Initializes and runs the Container Dashboard logic.
         */
        function initializeContainerDashboard() {
            const { db, collection, query, onSnapshot, where, orderBy } = window.firebaseServices;
            const collectionPath = getPrivateCollectionPath('container-orders');
            if (!collectionPath) {
                 document.getElementById('loading-message').textContent = '砖: 驻专 砖转砖/驻拽爪 住专.';
                 return;
            }
            
            const grid = document.getElementById('containers-grid');
            grid.innerHTML = '<p id="loading-message" class="col-span-full text-center text-gray-500">注 转 转...</p>';

            // Query:  转, 住专转 驻 转专 转
            const q = query(collection(db, collectionPath), orderBy("scheduledAt", "desc"));
            
            // Listener: 拽砖 砖  转
            onSnapshot(q, (snapshot) => {
                try {
                    // 注  拽 专砖转
                    containerDataCache = [];
                    grid.innerHTML = '';
                    const containers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    if (containers.length === 0) {
                        grid.innerHTML = '<p class="col-span-full text-center text-gray-500"> 转 . 住祝 转  转!</p>';
                        return;
                    }
                    
                    containers.forEach(container => {
                        containerDataCache.push(container); // 砖专 
                        
                        // 砖 住住 专 爪注转 驻拽爪 转 (砖)
                        const maxDays = container.containerSize === '8 拽' ? 14 : 10; 
                        const status = window.calculateOverdueStatus(container.rentalStartDate, container.returnDate, maxDays);

                        let statusText;
                        let statusClass;
                        let cardClasses = 'eco-card bg-white p-4 rounded-xl shadow-lg flex flex-col space-y-3 border border-gray-200 cursor-pointer';

                        if (status.returned) {
                             statusText = '专';
                             statusClass = 'text-gray-500';
                        } else if (status.isOverdue) {
                            statusText = `专! ${status.daysOverdue} `;
                            statusClass = 'overdue-text'; // Red
                            cardClasses += ' overdue-card';
                        } else if (status.daysElapsed > 0) {
                            statusText = `${status.daysLeft}  转专`;
                            statusClass = 'normal-text'; // Green
                        } else {
                            statusText = '专 ';
                            statusClass = 'text-gray-500';
                        }

                        // 爪专转 专住
                        const card = document.createElement('div');
                        card.className = cardClasses;
                        card.dataset.orderId = container.id;
                        
                        card.innerHTML = `
                            <div class="flex items-start justify-between">
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-gray-200 text-gray-700">${container.containerSize} (${container.deliveryType})</span>
                                <i data-feather="edit-3" class="w-5 h-5 text-gray-400 hover:text-blue-500 transition duration-150 edit-container-btn" data-order-id="${container.id}"></i>
                            </div>
                            
                            <h3 class="text-xl font-bold text-gray-800 eco-customer-name">${container.customerName}</h3>
                            <p class="text-sm text-gray-600 eco-address">${container.address}</p>
                            
                            <div class="border-t pt-3 space-y-2">
                                <p class="text-sm flex justify-between">
                                    <span class="font-medium text-gray-700">转专 转:</span>
                                    <span>${container.orderDate} 砖注 ${container.orderTime}</span>
                                </p>
                                <p class="text-sm flex justify-between">
                                    <span class="font-medium text-gray-700">住住 砖专转:</span>
                                    <span class="${statusClass}">${statusText}</span>
                                </p>
                                ${container.rentalStartDate 
                                    ? `<p class="text-xs text-gray-500"> : ${container.rentalStartDate.toDate().toLocaleDateString('he-IL')}</p>` 
                                    : ''
                                }
                            </div>
                            <div class="flex space-x-2 space-x-reverse pt-2">
                                <button data-order-id="${container.id}" data-type="Replace" class="action-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xs py-1 px-2 rounded-lg transition duration-150">祝</button>
                                <button data-order-id="${container.id}" data-type="Removal" class="action-btn bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded-lg transition duration-150">驻</button>
                                ${!container.rentalStartDate ? `<button data-order-id="${container.id}" data-type="StartRental" class="action-btn bg-green-500 hover:bg-green-600 text-white text-xs py-1 px-2 rounded-lg transition duration-150">转 砖专转</button>` : ''}
                                ${container.rentalStartDate && !container.returnDate ? `<button data-order-id="${container.id}" data-type="CompleteRental" class="action-btn bg-gray-500 hover:bg-gray-600 text-white text-xs py-1 px-2 rounded-lg transition duration-150">住 砖专转</button>` : ''}

                            </div>
                        `;
                        grid.appendChild(card);
                    });

                    // 驻注转 拽 Feather
                    feather.replace();
                    
                    // 专抓 住 驻 住住  (拽专 砖 驻注)
                    filterContainersByStatus(document.getElementById('container-status-filter').value);

                } catch (error) {
                    SmartLog.error(error, "ContainerDashboard.onSnapshot");
                    grid.innerHTML = '<p class="col-span-full text-center text-red-500">砖 注转 转.</p>';
                }
            });
        }
        window.initializeContainerDashboard = initializeContainerDashboard; // 砖驻 转
        
        /**
         * Updates the UI to show the selected container's details in the edit modal.
         */
        function handleEditContainerClick(orderId) {
             const container = containerDataCache.find(c => c.id === orderId);
             if (!container) {
                 showToast('  爪.', 'error');
                 return;
             }

             // 砖转 拽专 
             document.getElementById('container-edit-id').dataset.orderId = orderId;
             document.getElementById('container-edit-id').textContent = `ID: ${orderId}`;
             document.getElementById('container-edit-customer-name').textContent = container.customerName;
             document.getElementById('container-edit-container-size').textContent = container.containerSize;
             document.getElementById('container-edit-address').textContent = container.address;
             // 拽专转 (拽专 )
             document.getElementById('container-edit-latitude').textContent = container.location?.lat?.toFixed(6) || 'N/A';
             document.getElementById('container-edit-longitude').textContent = container.location?.lng?.toFixed(6) || 'N/A';


             // 砖转 注专
             document.getElementById('container-edit-delivery-type').value = container.deliveryType;
             document.getElementById('container-edit-order-date').value = container.orderDate;
             document.getElementById('container-edit-order-time').value = container.orderTime;
             document.getElementById('container-edit-notes').value = container.notes || '';
             
             // 驻 砖 转转 砖专转
             if (container.rentalStartDate && container.rentalStartDate.toDate) {
                 const date = container.rentalStartDate.toDate();
                 // 爪专转 驻专 YYYY-MM-DDTHH:MM 注专 input[type="datetime-local"]
                 const localDateTime = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                 document.getElementById('container-edit-rental-start-date').value = localDateTime;
             } else {
                 document.getElementById('container-edit-rental-start-date').value = '';
             }

             openContainerEditModal();
        }


        // --- Map Dashboard Logic ---
        
        /**
         * Initializes the Leaflet map.
         */
        function initializeMap() {
             if (map) map.remove(); // 注 爪专 驻

             // 专专转 : 转 
             map = L.map('map').setView([32.0853, 34.7818], 13);

             L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                 attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
             }).addTo(map);
             
             markersGroup = L.layerGroup().addTo(map);

             // 驻注转 Listener 注转 转
             loadContainerOrdersForMap();
             document.getElementById('map-status').textContent = '驻 . 注 转...';
        }

        /**
         * Loads container orders and renders map markers.
         */
        function loadContainerOrdersForMap() {
            const { db, collection, query, onSnapshot, where, orderBy } = window.firebaseServices;
            const collectionPath = getPrivateCollectionPath('container-orders');
            if (!collectionPath) return;

            // Query:  专拽 转 砖砖  拽专转 转拽转
            const q = query(collection(db, collectionPath), where('location.lat', '!=', null));

            onSnapshot(q, (snapshot) => {
                try {
                    const containers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderMapMarkers(containers);
                    document.getElementById('map-status').textContent = `爪 ${containers.length} 转 注 拽.`;
                } catch (error) {
                    SmartLog.error(error, "MapDashboard.onSnapshot");
                    document.getElementById('map-status').textContent = '砖 注转 转 驻.';
                }
            });
        }
        
        /**
         * Renders the markers on the map.
         * @param {Array<Object>} containers - Array of container order objects.
         */
        function renderMapMarkers(containers) {
            if (!map || !markersGroup) return;
            markersGroup.clearLayers(); // 拽 住 拽

            containers.forEach(container => {
                if (!container.location || !container.location.lat || !container.location.lng) return;

                const { lat, lng } = container.location;

                // 爪专转 拽 转 砖转 (  专?)
                const maxDays = container.containerSize === '8 拽' ? 7 : 14; 
                const status = window.calculateOverdueStatus(container.rentalStartDate, container.returnDate, maxDays); // 砖砖 驻拽爪 转 (砖)

                let markerColor = 'blue'; // 专专转 : 转
                if (container.rentalStartDate && !container.returnDate) {
                    markerColor = status.isOverdue ? 'red' : 'green'; // 驻注/专
                } else if (container.returnDate) {
                    markerColor = 'gray'; // 专
                } else if (container.deliveryType === 'Removal') {
                    markerColor = 'orange'; // 爪
                }

                const iconHtml = `<div style="background-color: ${markerColor}; width: 1.5rem; height: 1.5rem; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`;
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: iconHtml,
                    iconSize: [24, 24],
                    popupAnchor: [0, -12]
                });

                const marker = L.marker([lat, lng], { icon: customIcon }).addTo(markersGroup);

                // 转 -Popup
                let statusInfo = '';
                if (status.returned) {
                    statusInfo = `<p class="font-bold text-gray-500">住住: 专</p>`;
                } else if (status.isOverdue) {
                    statusInfo = `<p class="font-bold text-red-600">专: ${status.daysOverdue} !</p>`;
                } else if (status.daysElapsed > 0) {
                    statusInfo = `<p class="font-bold text-green-600">转专: ${status.daysLeft} </p>`;
                } else {
                    statusInfo = `<p class="font-bold text-gray-500">住住: 转 爪</p>`;
                }
                
                const scheduledDate = container.scheduledAt?.toDate ? container.scheduledAt.toDate().toLocaleDateString('he-IL') : ' 拽注';
                const scheduledTime = container.scheduledAt?.toDate ? container.scheduledAt.toDate().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '';

                const popupContent = `
                    <div class="text-right">
                        <h4 class="text-lg font-bold text-gray-800">${container.customerName}</h4>
                        <p class="text-sm text-gray-600">${container.address}</p>
                        <p class="text-xs text-gray-400 ltr">Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}</p>
                        <hr class="my-2"/>
                        <p class="text-sm"><strong>:</strong> ${container.containerSize}</p>
                        <p class="text-sm"><strong>驻注:</strong> ${container.deliveryType}</p>
                        <p class="text-sm"><strong>转:</strong> ${scheduledDate} (${scheduledTime})</p>
                        <hr class="my-2"/>
                        ${statusInfo}
                        <button onclick="window.handleEditContainerClick('${container.id}')" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-3 rounded-lg">
                            注专 驻专
                        </button>
                    </div>
                `;

                marker.bindPopup(popupContent, { maxWidth: 300 });
            });
            
            // 转转 驻  住
            if (containers.length > 0) {
                const bounds = markersGroup.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        }
        
        // --- Filtering Logic (Container Dashboard) ---
        function filterContainersByStatus(statusFilter) {
            const grid = document.getElementById('containers-grid');
            const cards = grid.querySelectorAll('.eco-card');

            cards.forEach(card => {
                const orderId = card.dataset.orderId;
                const container = containerDataCache.find(c => c.id === orderId);
                
                if (!container) return;
                
                const maxDays = container.containerSize === '8 拽' ? 7 : 14; 
                const status = window.calculateOverdueStatus(container.rentalStartDate, container.returnDate, maxDays);
                
                let isVisible = false;

                switch (statusFilter) {
                    case 'all':
                        isVisible = true;
                        break;
                    case 'active':
                        isVisible = container.rentalStartDate && !container.returnDate && !status.isOverdue;
                        break;
                    case 'overdue':
                        isVisible = status.isOverdue;
                        break;
                    case 'pending':
                        isVisible = !container.rentalStartDate && !container.returnDate;
                        break;
                    // TODO: 住祝 住 '专'  专砖
                    default:
                        isVisible = true;
                }

                card.style.display = isVisible ? 'flex' : 'none';
            });
        }


        // --- Event Listeners and Main Setup ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // 注转 拽
            feather.replace();

            // --- Geocoding Listener ---
            document.getElementById('geocode-button').addEventListener('click', async () => {
                const addressInput = document.getElementById('address');
                const latInput = document.getElementById('latitude');
                const lngInput = document.getElementById('longitude');

                const address = addressInput.value.trim();
                const currentLat = parseFloat(latInput.value);
                const currentLng = parseFloat(lngInput.value);
                
                if (!address && (isNaN(currentLat) || isNaN(currentLng))) {
                    showToast('  转转  拽专转.', 'error');
                    return;
                }

                const result = await geocodeAddress(address, currentLat, currentLng);
                if (result.success) {
                    latInput.value = result.lat;
                    lngInput.value = result.lng;
                } 
                //  爪专 -else  驻拽爪转 -geocode 转 专 爪 注 拽 砖
            });
            
            // --- Navigation Logic ---
            const containerDashboard = document.getElementById('container-dashboard');
            const mapDashboard = document.getElementById('map-dashboard');
            const openEcoBtn = document.getElementById('openEcoDashboardButton');
            const openMapBtn = document.getElementById('openMapDashboardButton');

            function navigateTo(target) {
                containerDashboard.classList.add('hidden');
                mapDashboard.classList.add('hidden');
                
                if (target === 'container') {
                    containerDashboard.classList.remove('hidden');
                } else if (target === 'map') {
                    mapDashboard.classList.remove('hidden');
                    // 转 驻 专拽 砖注专 
                    if (!map) {
                        initializeMap();
                    } else {
                        //  驻 专 拽转, 砖  砖 注转 转 转爪 砖
                         map.invalidateSize(); 
                    }
                }
            }

            openEcoBtn.addEventListener('click', () => navigateTo('container'));
            openMapBtn.addEventListener('click', () => navigateTo('map'));

            // 专专转 : 爪  转
            navigateTo('container');
            
            // --- Modal Listeners ---
            document.getElementById('openContainerCreateModalButton').addEventListener('click', openContainerCreateModal);
            document.getElementById('close-create-modal').addEventListener('click', closeContainerCreateModal);
            document.getElementById('close-edit-modal').addEventListener('click', closeContainerEditModal);
            document.getElementById('cancel-delete-btn').addEventListener('click', closeDeleteConfirmModal);
            document.getElementById('container-create-form').addEventListener('submit', handleCreateContainerOrder);
            document.getElementById('container-edit-form').addEventListener('submit', handleSaveContainerOrder);
            document.getElementById('delete-container-order').addEventListener('click', (e) => {
                 e.preventDefault();
                 const orderId = document.getElementById('container-edit-id').dataset.orderId;
                 const customerName = document.getElementById('container-edit-customer-name').textContent;
                 openDeleteConfirmation(orderId, customerName);
            });
            document.getElementById('confirm-delete-btn').addEventListener('click', handleDeleteContainerOrder);


            // 住专转  爪 注 专拽注 驻专 
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeModal(overlay.id);
                    }
                });
            });


            // --- Dashboard Event Delegation ---
            
            // 爪转 专注 驻 驻转专 注专 驻转专 驻注
            document.getElementById('containers-grid').addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-container-btn');
                const actionBtn = e.target.closest('.action-btn');

                if (editBtn) {
                    const orderId = editBtn.dataset.orderId;
                    handleEditContainerClick(orderId);
                } else if (actionBtn) {
                    const orderId = actionBtn.dataset.orderId;
                    const actionType = actionBtn.dataset.type;
                    
                    // TODO: implement specific action handlers (Replace, Removal, StartRental, CompleteRental)
                    showToast(`驻注转 ${actionType} 专 注专 ID: ${orderId}`, 'info');

                    // 驻拽爪转 注专 砖转 住住 砖专转 转  转 (爪专 拽)
                    if (actionType === 'StartRental') {
                         window.handleSetRentalStart(orderId, new Date());
                    } else if (actionType === 'CompleteRental') {
                         window.handleSetRentalReturn(orderId, new Date());
                    }
                }
            });
            
            // --- Filtering and Search Listeners ---
            document.getElementById('container-status-filter').addEventListener('change', (e) => {
                filterContainersByStatus(e.target.value);
            });

            document.getElementById('container-search-input').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const cards = document.getElementById('containers-grid').querySelectorAll('.eco-card');
                
                cards.forEach(card => {
                    const customerName = card.querySelector('.eco-customer-name')?.textContent.toLowerCase() || '';
                    const address = card.querySelector('.eco-address')?.textContent.toLowerCase() || '';
                    const isVisible = customerName.includes(searchTerm) || address.includes(searchTerm);
                    
                    // 砖专 注 住住 住  (砖 转 驻砖 注 住)
                    const statusFilter = document.getElementById('container-status-filter').value;
                    const isStatusVisible = card.style.display !== 'none'; //   专 住转专 注  住 住住

                    card.style.display = isVisible && isStatusVisible ? 'flex' : 'none';
                });
                
                // 专抓 住 住住 砖 专 驻砖
                filterContainersByStatus(document.getElementById('container-status-filter').value);
            });

            // --- 住住/驻注转 砖专转 专转 ---
            async function handleSetRentalStart(orderId, date) {
                 const { db, doc, updateDoc, serverTimestamp } = window.firebaseServices;
                 const collectionPath = getPrivateCollectionPath('container-orders');
                 if (!collectionPath) return;

                 try {
                      const rentalStartDate = window.firebaseServices.Timestamp.fromDate(date);
                      await updateDoc(doc(db, collectionPath, orderId), {
                          rentalStartDate: rentalStartDate,
                          returnDate: null, //  砖 转专 专  转 砖专转
                          lastModified: serverTimestamp()
                      });
                      showToast('住住 砖专转 专 "驻注"', 'success');
                 } catch (error) {
                      showToast(`砖 专转 住住: ${error.message}`, 'error');
                      SmartLog.error(error, "CRUD.Rental.Start", { orderId });
                 }
            }
            window.handleSetRentalStart = handleSetRentalStart;

            async function handleSetRentalReturn(orderId, date) {
                 const { db, doc, updateDoc, serverTimestamp } = window.firebaseServices;
                 const collectionPath = getPrivateCollectionPath('container-orders');
                 if (!collectionPath) return;

                 try {
                      const returnDate = window.firebaseServices.Timestamp.fromDate(date);
                      await updateDoc(doc(db, collectionPath, orderId), {
                          returnDate: returnDate,
                          rentalStartDate: window.firebaseServices.Timestamp.now(), //  砖砖 转专 转 驻 住 (拽专 砖   砖)
                          lastModified: serverTimestamp()
                      });
                      showToast('住住 砖专转 专 "专"', 'success');
                 } catch (error) {
                      showToast(`砖 专转 住住: ${error.message}`, 'error');
                      SmartLog.error(error, "CRUD.Rental.Return", { orderId });
                 }
            }
            window.handleSetRentalReturn = handleSetRentalReturn;


            // --- 转转 驻拽爪 ---\
            if (window.firebaseAuthReady) {
                initializeContainerDashboard();
            } else {
                document.addEventListener('firebaseAuthReady', () => {
                    initializeContainerDashboard();
                });
            }

            // TODO: 驻注 转 initializeMap 专拽 爪 注 驻转专 驻
        });
    </script>
</body>
</html>
