<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DeliveryMaster Viewer v50.9 (Final)</title>
    <!-- 
      DeliveryMaster Live Viewer App v50.9
      קובץ מקורי של המשתמש, עם השתלה כירורגית של Firebase v9 ומערכת תקשורת.
      כל המבנה והפונקציות המקוריות נשמרו.
      מותאם לאינדקסים שהוגדרו.
    -->
    
    <!-- External Libraries (Unchanged) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- User's Original CSS (Unchanged) -->
    <style>
        :root {
            --header-height: 140px;
            --nav-height: 60px;
            --map-height-mobile: 35vh;
            --list-height-mobile: calc(65vh - var(--header-height) - var(--nav-height));
            --map-height-desktop: calc(100vh - var(--header-height));
            --list-height-desktop: calc(100vh - var(--header-height));
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* Prevent body scrolling */
        }
        
        #main-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background-color: white;
            z-index: 100;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem;
            padding-top: calc(1rem + env(safe-area-inset-top));
        }

        #main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            padding-top: var(--header-height);
            padding-bottom: var(--nav-height);
            height: calc(100vh - var(--header-height) - var(--nav-height));
        }
        
        #map-container {
            height: var(--map-height-mobile);
            background-color: #e0e0e0;
            position: relative;
        }
        
        #viewer-map-loader {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.8);
            z-index: 10;
        }

        #active-orders-page {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .order-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 0.75rem;
            padding: 1rem;
            transition: all 0.2s ease;
        }
        .order-card.selected {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
            transform: translateY(-2px);
        }

        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(var(--nav-height) + env(safe-area-inset-bottom));
            padding-bottom: env(safe-area-inset-bottom);
            background-color: #ffffff;
            border-top: 1px solid #e0e0e0;
            z-index: 100;
            display: flex;
            justify-content: around;
            align-items: center;
        }
        #bottom-nav button {
            flex: 1;
            text-align: center;
            color: #4b5563;
            padding-top: 0.5rem;
        }
        #bottom-nav button.active {
            color: #2563eb;
            font-weight: 600;
        }
        
        .page-content {
            display: none;
            padding: 1rem;
            height: calc(100vh - var(--header-height) - var(--nav-height));
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .page-content.active {
            display: block;
        }

        #full-page-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(5px);
        }
        #full-page-view.show {
            display: flex;
        }
        
        #modal-content {
            background-color: #f0f2f5;
            width: 100%;
            max-width: 600px;
            height: 90vh;
            max-height: 800px;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #modal-header {
            background-color: white;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #modal-body {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        #modal-body-content {
            padding: 1.5rem;
        }
        #modal-footer {
            background-color: white;
            padding: 1rem 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: none; /* Hidden by default, shown by specific modals */
        }
        
        .toast-container {
            position: fixed;
            top: calc(var(--header-height) + 1rem);
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            width: 90%;
            max-width: 400px;
        }
        .toast {
            background-color: #333;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            text-align: center;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.info { background-color: #17a2b8; }
        
        /* ---------------------------------- */
        /* --- הוספות קוד עבור שדרוג תקשורת --- */
        /* ---------------------------------- */
        
        /* אייקון מנורה מהבהב */
        .pulse-light {
            color: #f59e0b; /* yellow-500 */
            animation: pulse-light 1.5s infinite;
        }
        @keyframes pulse-light {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* בועות צ'אט */
        .chat-bubble {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.75rem;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .chat-bubble-admin {
            background-color: #e2e8f0; /* gray-200 */
            color: #1e293b; /* gray-800 */
            border-bottom-left-radius: 0.25rem;
            align-self: flex-start;
        }
        .chat-bubble-customer {
            background-color: #2563eb; /* blue-600 */
            color: white;
            border-bottom-right-radius: 0.25rem;
            align-self: flex-end;
        }
         .chat-bubble-note {
            background-color: #fef9c3; /* yellow-100 */
            color: #713f12; /* yellow-900 */
            border: 1px solid #fde047; /* yellow-400 */
            align-self: center;
            width: 100%;
            max-width: 100%;
            text-align: right;
            font-style: italic;
        }
        .chat-timestamp {
            font-size: 0.75rem;
            color: #64748b; /* gray-500 */
            margin-top: 0.25rem;
            display: block;
        }
        .chat-bubble-customer .chat-timestamp {
            color: #dbeafe; /* blue-100 */
        }
        /* ---------------------------------- */
        
        @media (min-width: 768px) {
            body {
                flex-direction: row;
            }
            #main-header {
                height: 100vh;
                width: 350px;
                position: fixed;
                padding-top: 1.5rem;
                padding-bottom: env(safe-area-inset-bottom);
                border-bottom: none;
                border-left: 1px solid #e5e7eb;
                display: flex;
                flex-direction: column;
            }
            #main-content {
                padding-top: 0;
                padding-bottom: 0;
                padding-right: 350px; /* Offset for header */
                flex-direction: row;
                height: 100vh;
            }
            #map-container {
                width: 60%;
                height: var(--map-height-desktop);
            }
            #active-orders-page {
                width: 40%;
                height: var(--list-height-desktop);
                border-left: 1px solid #e5e7eb;
            }
            #bottom-nav {
                display: none; /* Hide on desktop */
            }
            .page-content {
                padding: 0; /* Remove padding for desktop full-height sections */
                height: var(--list-height-desktop);
            }
            .page-content.active {
                width: 40%;
            }
            /* Adjust header items for vertical layout */
            #main-header .grid {
                flex-direction: column;
                margin-top: 1rem;
            }
            #main-header .grid button {
                padding: 1rem;
            }
            #main-header .flex-1 {
                flex: 0;
            }
            /* Desktop app-like nav */
            #desktop-nav {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                margin-top: auto; /* Push to bottom */
                padding-top: 1rem;
                border-top: 1px solid #e5e7eb;
            }
             #desktop-nav button {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.75rem 1rem;
                border-radius: 0.5rem;
                font-medium;
                color: #374151;
             }
             #desktop-nav button:hover {
                background-color: #f3f4f6;
             }
             #desktop-nav button.active {
                background-color: #e0e7ff;
                color: #3730a3;
             }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header (Sidebar on Desktop) -->
    <header id="main-header">
        <div class="flex-1 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-gray-800">DeliveryMaster</h1>
                <div id="user-info" class="text-left">
                    <span class="font-semibold block" id="user-name-display">טוען...</span>
                    <span class="text-sm text-gray-500" id="user-role-display">Viewer v50.9</span>
                </div>
            </div>
            
            <input type="text" id="search-box" class="border rounded-full py-2.5 px-4 w-full text-base" placeholder="חפש לקוח, כתובת, מחסן...">
            
            <div class="grid grid-cols-3 gap-2 text-center mt-4">
                <button id="header-active" onclick="showActiveListPage()" class="bg-blue-100 text-blue-800 p-2 rounded-lg">
                    <span class="font-bold text-2xl" id="count-active">0</span>
                    <span class="text-xs block">בסידור</span>
                </button>
                <button id="header-completed" onclick="showCompletedTodayListPage()" class="bg-green-100 text-green-800 p-2 rounded-lg">
                    <span class="font-bold text-2xl" id="count-completed">0</span>
                    <span class="text-xs block">סופקו היום</span>
                </button>
                <button id="header-future" onclick="showFutureListPage()" class="bg-gray-100 text-gray-800 p-2 rounded-lg">
                    <span class="font-bold text-2xl" id="count-future">0</span>
                    <span class="text-xs block">צפי עתידי</span>
                </button>
            </div>
        </div>

        <!-- Desktop Navigation (Replaces Bottom Nav) -->
        <nav id="desktop-nav" class="hidden md:flex">
            <button id="desktop-nav-materials" onclick="showMaterialsPage()" class="active">
                <i class="fas fa-hard-hat fa-lg fa-fw"></i>
                <span>חומרי בנין</span>
            </button>
            <button id="desktop-nav-containers" onclick="showContainersPage()">
                <i class="fas fa-truck-loading fa-lg fa-fw"></i>
                <span>מכולות</span>
            </button>
            <button id="desktop-nav-reports" onclick="showReportsPage()">
                <i class="fas fa-chart-line fa-lg fa-fw"></i>
                <span>דוחות</span>
            </button>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main id="main-content">
        <!-- Page 1: Materials (Default) -->
        <div id="materials-page" class="page-content active !p-0 md:!flex">
            <!-- Map Container -->
            <div id="map-container">
                <iframe id="viewer-map" width="100%" height="100%" frameborder="0" scrolling="no" marginheight="0" marginwidth="0"
                    src="https://maps.google.com/maps?width=100%25&amp;height=100%25&amp;hl=he&amp;q=Saban%20H.%20Building%20Materials%20Ltd,%20%D7%94%D7%AA%D7%9C%D7%9E%D7%99%D7%93%206,%20%D7%94%D7%95%D7%93%20%D7%94%D7%A9%D7%A8%D7%95%D7%9F+(%D7%97.%20%D7%A1%D7%91%D7%9F%20%D7%97%D7%95%D7%9E%D7%A8%D7%99%20%D7%91%D7%A0%D7%99%D7%9F)&amp;t=&amp;z=14&amp;ie=UTF8&amp;iwloc=B&amp;output=embed">
                </iframe>
                <div id="viewer-map-loader">
                    <i class="fas fa-spinner fa-spin fa-3x text-blue-600"></i>
                </div>
            </div>
            <!-- Active Orders List -->
            <div id="active-orders-page" class="p-4 md:p-6">
                 <p id="loading-orders" class="text-center text-gray-600 mt-10">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <span class="block mt-2">טוען הזמנות...</span>
                </p>
                <!-- Order cards will be injected here by JS -->
            </div>
        </div>
        
        <!-- Page 2: Containers -->
        <div id="containers-page" class="page-content">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">ניהול מכולות</h2>
            <p class="text-center text-gray-500">דף ניהול מכולות יפותח כאן.</p>
        </div>
        
        <!-- Page 3: Reports -->
        <div id="reports-page" class="page-content">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">דוחות וניתוחים</h2>
            <!-- Date Filters -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="start-date" class="block text-sm font-medium text-gray-700">מתאריך</label>
                    <input type="date" id="start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="end-date" class="block text-sm font-medium text-gray-700">עד תאריך</label>
                    <input type="date" id="end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
            </div>
            <button onclick="renderReports()" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg mb-6">הצג דוח</button>
            
            <!-- Charts -->
            <div class="space-y-6">
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-2">הזמנות לפי מחסן</h3>
                    <canvas id="warehouse-chart"></canvas>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-2">הזמנות לאורך זמן</h3>
                    <canvas id="time-chart"></canvas>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-2">לקוחות שסופקו (לפי טווח)</h3>
                    <ul id="completed-customers-list" class="divide-y divide-gray-200 max-h-60 overflow-y-auto">
                        <!-- List items will be injected here -->
                    </ul>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Bottom Navigation (Mobile Only) -->
    <nav id="bottom-nav" class="md:hidden">
        <button id="mobile-nav-materials" onclick="showMaterialsPage()" class="active">
            <i class="fas fa-hard-hat fa-lg"></i>
            <span class="block text-xs mt-1">חומרי בנין</span>
        </button>
        <button id="mobile-nav-containers" onclick="showContainersPage()">
            <i class="fas fa-truck-loading fa-lg"></i>
            <span class="block text-xs mt-1">מכולות</span>
        </button>
        <button id="mobile-nav-reports" onclick="showReportsPage()">
            <i class="fas fa-chart-line fa-lg"></i>
            <span class="block text-xs mt-1">דוחות</span>
        </button>
    </nav>
    
    <!-- Full Page Modal (Used by Lists & Reports) -->
    <div id="full-page-view" onclick="hideFullPageView()">
        <div id="modal-content" onclick="event.stopPropagation()">
            <!-- Modal Header -->
            <div id="modal-header">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-800">...</h3>
                <button onclick="hideFullPageView()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            
            <!-- Modal Body (Scrollable) -->
            <div id="modal-body">
                <div id="modal-body-content">
                    <!-- Dynamic Content Injected Here -->
                </div>
            </div>
            
            <!-- Modal Footer (for actions) -->
            <div id="modal-footer">
                <button id="modal-save-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                    שמור
                </button>
            </div>
        </div>
    </div>
    
    <!-- 
      ==========================================================
      ===               תחילת סקריפט ראשי (v50.9)            ===
      ==========================================================
    -->
    <script type="module">
        // ==========================================================
        // ===         השתלת Firebase v9 (Modular) SDK            ===
        // ==========================================================
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, onSnapshot, collection, query, where, 
            orderBy, serverTimestamp, addDoc, limit, doc, getDocs,
            runTransaction, writeBatch
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        // --- Globals for Firebase ---
        let db;
        let auth;
        let unsubscribeActiveOrders = null; // מאזין ראשי
        let messageUnsubscribeListeners = {}; // אובייקט לשמירת מאזיני הודעות
        let unsubscribeModalMessages = null; // מאזין למודל
        // ==========================================================

        // --- User's Original Globals ---
        let allOrders = []; // Cached orders for searching
        let warehouseChartInstance = null;
        let timeChartInstance = null;
        let selectedOrderCard = null; // Track selected card

        // --- User's Original DOMContentLoaded (MODIFIED) ---
        document.addEventListener('DOMContentLoaded', async () => {
            // --- הוספת אתחול Firebase ---
            try {
                const fallbackConfig = {
                    apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
                    authDomain: "saban94-76543.firebaseapp.com", 
                    projectId: "saban94-76543",
                    storageBucket: "saban94-76543.appspot.com", 
                    messagingSenderId: "41553157903", 
                    appId: "1:41553157903:web:cc33d252cff023be97a87a", 
                    measurementId: "G-XV6RZDESSB"
                };

                let firebaseConfig;
                if (typeof __firebase_config !== 'undefined' && __firebase_config !== '{}') {
                    firebaseConfig = JSON.parse(__firebase_config);
                } else {
                    console.warn("Using fallback Firebase config.");
                    firebaseConfig = fallbackConfig;
                }

                if (firebaseConfig.apiKey) {
                    let app = getApps().length > 0 ? getApp() : initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    let userCredential;
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        userCredential = await signInAnonymously(auth);
                    }
                    console.log("Firebase Initialized & User Signed In:", userCredential.user.uid);
                    document.getElementById('user-name-display').innerText = userCredential.user.isAnonymous ? 'סדרן אנונימי' : 'סדרן מחובר';
                    
                    // --- סוף אתחול Firebase ---
                    
                    // User's original init logic
                    showMaterialsPage(); // Show default page
                    setupEventListeners();
                    setInitialDates();
                    
                } else {
                    console.error("Firebase config is missing.");
                    showToast("שגיאת תצורת Firebase", "error");
                    document.getElementById('loading-orders').innerText = "שגיאת תצורה.";
                }
            } catch (e) {
                console.error("Error initializing Firebase:", e);
                showToast("שגיאת אתחול Firebase", "error");
                document.getElementById('loading-orders').innerText = "שגיאת אתחול.";
            }
        });

        // --- User's Original Functions (Unchanged) ---
        function setupEventListeners() {
            document.getElementById('search-box').addEventListener('input', (e) => {
                filterAndRenderOrders(allOrders, e.target.value);
            });
            
            document.getElementById('viewer-map').addEventListener('load', () => {
                hideLoader('viewer-map-loader');
            });
        }
        
        function setInitialDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start-date').value = today;
            document.getElementById('end-date').value = today;
        }

        // --- Page Navigation (Unchanged) ---
        function showMaterialsPage() {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById('materials-page').classList.add('active');
            
            document.querySelectorAll('#bottom-nav button, #desktop-nav button').forEach(b => b.classList.remove('active'));
            document.getElementById('mobile-nav-materials').classList.add('active');
            document.getElementById('desktop-nav-materials').classList.add('active');
            
            // This function now fetches from Firebase
            fetchAndRenderOrders();
        }

        function showContainersPage() {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById('containers-page').classList.add('active');
            
            document.querySelectorAll('#bottom-nav button, #desktop-nav button').forEach(b => b.classList.remove('active'));
            document.getElementById('mobile-nav-containers').classList.add('active');
            document.getElementById('desktop-nav-containers').classList.add('active');
            
            // Stop listening to orders if not needed
            if (unsubscribeActiveOrders) unsubscribeActiveOrders();
        }

        function showReportsPage() {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById('reports-page').classList.add('active');
            
            document.querySelectorAll('#bottom-nav button, #desktop-nav button').forEach(b => b.classList.remove('active'));
            document.getElementById('mobile-nav-reports').classList.add('active');
            document.getElementById('desktop-nav-reports').classList.add('active');
            
            // Stop listening to orders if not needed
            if (unsubscribeActiveOrders) unsubscribeActiveOrders();
            renderReports(); // Initial render for reports
        }
        
        // --- Full Page List Modals (Unchanged) ---
        function showActiveListPage() {
            const activeOrders = allOrders.filter(o => o.status !== 'סופק' && o.status !== 'מבוטל');
            renderListInModal("הזמנות בסידור", activeOrders);
        }
        
        function showCompletedTodayListPage() {
            // Placeholder: Needs logic to fetch completed *today*
            const completedOrders = allOrders.filter(o => o.status === 'סופק');
            renderListInModal("הזמנות שסופקו היום", completedOrders);
        }
        
        function showFutureListPage() {
            // Placeholder: Needs logic to fetch future orders
            const futureOrders = []; // Example
            renderListInModal("צפי הזמנות עתידי", futureOrders);
        }

        function renderListInModal(title, orders) {
            document.getElementById('modal-title').innerText = title;
            const contentDiv = document.getElementById('modal-body-content');
            
            if (orders.length === 0) {
                contentDiv.innerHTML = '<p class="text-center text-gray-500">לא נמצאו הזמנות.</p>';
            } else {
                contentDiv.innerHTML = orders.map(order => createOrderCard(order, true).outerHTML).join('');
            }
            document.getElementById('modal-footer').style.display = 'none';
            showFullPageView();
        }

        // --- MODIFIED: Fetches from Firebase ---
        function fetchAndRenderOrders() {
            console.log("Fetching orders from Firebase...");
            const ordersListDiv = document.getElementById('active-orders-page');
            
            // נתק מאזין קודם אם קיים
            if (unsubscribeActiveOrders) unsubscribeActiveOrders();
            // נקה מאזיני הודעות קודמים
            Object.values(messageUnsubscribeListeners).forEach(unsub => unsub());
            messageUnsubscribeListeners = {};

            // v9 Query:
            // !!! אינדקס נדרש: orders (status ASC, delivery_date DESC)
            const q = query(
                collection(db, 'orders'),
                where('status', 'not-in', ['סופק', 'מבוטל']),
                orderBy('status'), // ממיין לפי סטטוס
                orderBy('delivery_date', 'desc'), // ממיין לפי תאריך (דורש אינדקס)
                limit(50)
            );

            unsubscribeActiveOrders = onSnapshot(q, (querySnapshot) => {
                document.getElementById('loading-orders').style.display = 'none';
                
                if (querySnapshot.empty) {
                    ordersListDiv.innerHTML = '<p class="text-center text-gray-500">לא נמצאו הזמנות פעילות.</p>';
                    allOrders = [];
                    return;
                }
                
                allOrders = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // עדכון ספירות (לוגיקה לדוגמה)
                document.getElementById('count-active').innerText = allOrders.length;
                // כאן תצטרך שאילתות נפרדות עבור "סופקו היום" ו"עתידי"
                // getCountCompletedToday(); 
                
                filterAndRenderOrders(allOrders, document.getElementById('search-box').value);

            }, (error) => {
                console.error("Error fetching orders: ", error);
                document.getElementById('loading-orders').innerHTML = `
                    <p class="text-red-500">שגיאה בטעינת הזמנות.</p>
                    <p class="text-sm text-gray-600 mt-2">ייתכן שנדרש אינדקס ב-Firestore. בדוק ב-Console (F12) אם יש קישור ליצירת אינדקס.</p>`;
                showToast("שגיאה בטעינת הזמנות", "error");
            });
        }
        
        // --- User's Original Functions (Unchanged) ---
        function filterAndRenderOrders(orders, searchTerm) {
            const lowerSearchTerm = searchTerm.toLowerCase();
            const filteredOrders = orders.filter(order => {
                return (order.customer_name?.toLowerCase().includes(lowerSearchTerm) ||
                        order.customer_address?.toLowerCase().includes(lowerSearchTerm) ||
                        order.warehouse?.toLowerCase().includes(lowerSearchTerm) ||
                        order.delivery_date?.includes(lowerSearchTerm)
                       );
            });
            
            renderOrderList(filteredOrders);
        }
        
        function renderOrderList(orders) {
            const ordersListDiv = document.getElementById('active-orders-page');
            ordersListDiv.innerHTML = ''; // Clear list
            
            if (orders.length === 0) {
                 ordersListDiv.innerHTML = '<p class="text-center text-gray-500 mt-10">לא נמצאו הזמנות תואמות לחיפוש.</p>';
                 return;
            }
            
            orders.forEach(order => {
                ordersListDiv.appendChild(createOrderCard(order, false));
            });
        }
        
        // --- MODIFIED: Added Message Icon & Buttons ---
        function createOrderCard(order, isModal) {
            const card = document.createElement('div');
            card.className = 'order-card';
            card.id = `card-${order.id}`;
            
            const orderId = order.order_id || order.id.substring(0, 6);
            const customer = order.customer_name || 'ללא שם';
            const address = order.customer_address || 'ללא כתובת';
            const warehouse = order.warehouse || 'לא ידוע';
            const date = order.delivery_date || 'לא ידוע';
            const time = order.delivery_time || '';

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-lg font-semibold text-blue-600 truncate flex-1" title="${customer}">
                        ${orderId} - ${customer}
                    </h3>
                    <!-- 
                      הוספה: אייקון מנורה מהבהב 
                      ה-ID ייחודי לכל כרטיס
                    -->
                    <i id="msg-icon-${order.id}" class="fas fa-lightbulb fa-lg pulse-light hidden ml-2"></i>
                </div>
                <p class="text-sm text-gray-700 truncate" title="${address}">
                    <i class="fas fa-map-marker-alt fa-fw text-gray-500 ml-2"></i>${address}
                </p>
                <div class="flex justify-between text-sm text-gray-600 mt-3 pt-3 border-t border-gray-100">
                    <span><i class="fas fa-warehouse fa-fw ml-1"></i> ${warehouse}</span>
                    <span><i class="fas fa-calendar-alt fa-fw ml-1"></i> ${date} ${time}</span>
                </div>
                
                <!-- 
                  הוספה: כפתורי תקשורת 
                -->
                <div class="flex gap-2 mt-4">
                    <button onclick="window.showMessagesModal('${order.id}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium py-2 px-3 rounded-lg">
                        <i class="fas fa-comments ml-1"></i> צפה בהודעות
                    </button>
                    <button onclick="window.showAddNoteModal('${order.id}')" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-yellow-900 text-sm font-medium py-2 px-3 rounded-lg">
                        <i class="fas fa-sticky-note ml-1"></i> הוסף הערה
                    </button>
                </div>
            `;
            
            if (!isModal) {
                // הדגשת כרטיס שנבחר
                card.onclick = () => {
                    if (selectedOrderCard) {
                        selectedOrderCard.classList.remove('selected');
                    }
                    card.classList.add('selected');
                    selectedOrderCard = card;
                    // כאן תוסיף לוגיקה לעדכון המפה
                };
                
                // האזן להודעות חדשות רק בכרטיסים שברשימה הראשית
                listenForNewMessages(order.id);
            }
            
            return card;
        }

        // --- Reports Page (MODIFIED to use new index) ---
        async function renderReports() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                showToast("נא לבחור טווח תאריכים", "error");
                return;
            }
            
            // המרה לפורמט תאריך נכון עבור השאילתה
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999); // כל היום
            
            showToast("טוען נתוני דוח...", "info");
            
            // v9 Query:
            // !!! אינדקס נדרש: orders (status ASC, delivery_date ASC)
            const q = query(
                collection(db, 'orders'),
                where('status', '==', 'סופק'),
                where('delivery_date', '>=', startDate),
                where('delivery_date', '<=', endDate),
                orderBy('delivery_date', 'asc') // הוספת מיון שתואם לאינדקס השני
            );
            
            try {
                const querySnapshot = await getDocs(q);
                const completedOrders = querySnapshot.docs.map(doc => doc.data());
                
                if (completedOrders.length === 0) {
                     showToast("לא נמצאו הזמנות שסופקו בטווח התאריכים", "info");
                     // נקה תרשימים קודמים
                     if (warehouseChartInstance) warehouseChartInstance.destroy();
                     if (timeChartInstance) timeChartInstance.destroy();
                     document.getElementById('completed-customers-list').innerHTML = '<li class="p-3 text-center text-gray-500">לא נמצאו לקוחות.</li>';
                     return;
                }
                
                renderWarehouseChart(completedOrders);
                renderTimeChart(completedOrders);
                renderCompletedCustomers(completedOrders);

            } catch (error) {
                 console.error("Error fetching reports data: ", error);
                 showToast("שגיאה בהפקת הדוח", "error");
            }
        }
        
        function renderWarehouseChart(orders) {
            const ctx = document.getElementById('warehouse-chart').getContext('2d');
            const warehouseCounts = orders.reduce((acc, order) => {
                const warehouse = order.warehouse || 'לא ידוע';
                acc[warehouse] = (acc[warehouse] || 0) + 1;
                return acc;
            }, {});
            
            if (warehouseChartInstance) warehouseChartInstance.destroy();
            warehouseChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(warehouseCounts),
                    datasets: [{
                        label: 'הזמנות',
                        data: Object.values(warehouseCounts),
                        backgroundColor: '#3b82f6',
                    }]
                },
                options: { responsive: true, indexAxis: 'y' }
            });
        }
        
        function renderTimeChart(orders) {
            const ctx = document.getElementById('time-chart').getContext('2d');
            const ordersByDate = orders.reduce((acc, order) => {
                const date = order.delivery_date || 'לא ידוע';
                acc[date] = (acc[date] || 0) + 1;
                return acc;
            }, {});
            
            const sortedDates = Object.keys(ordersByDate).sort();
            
            if (timeChartInstance) timeChartInstance.destroy();
            timeChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'הזמנות ליום',
                        data: sortedDates.map(date => ordersByDate[date]),
                        borderColor: '#10b981',
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: { responsive: true }
            });
        }
        
        function renderCompletedCustomers(orders) {
            const listEl = document.getElementById('completed-customers-list');
            // ספירת לקוחות ייחודיים
            const customers = [...new Set(orders.map(o => o.customer_name || 'לקוח אנונימי'))];
            
            if (customers.length === 0) {
                 listEl.innerHTML = '<li class="p-3 text-center text-gray-500">לא נמצאו לקוחות.</li>';
                 return;
            }
            
            listEl.innerHTML = customers.map(customer => `
                <li class="p-3">
                    <span class="font-medium text-gray-800">${customer}</span>
                </li>
            `).join('');
        }

        // --- Utility Functions (Unchanged) ---
        function showFullPageView() {
            document.getElementById('full-page-view').classList.add('show');
        }

        function hideFullPageView() {
            document.getElementById('full-page-view').classList.remove('show');
            // הוספה: נתק מאזין של מודל כשסוגרים
            if (unsubscribeModalMessages) {
                unsubscribeModalMessages();
                unsubscribeModalMessages = null;
            }
        }
        
        function showLoader(elementId) {
            const container = document.getElementById('full-page-view');
            const content = document.getElementById('modal-body-content');
            if (elementId === 'viewer-map-loader') {
                 document.getElementById(elementId).style.display = 'flex';
            } else {
                 content.innerHTML = `<div class="text-center p-10"><i class="fas fa-spinner fa-spin fa-3x text-blue-600"></i></div>`;
                 container.style.display = 'flex';
            }
        }
        
        function hideLoader(elementId) {
             const container = document.getElementById(elementId);
             if (container) {
                 if (elementId === 'viewer-map-loader') {
                     container.style.display = 'none';
                 }
            }
        }
        
        function showToast(message, type = 'info') {
             console.log(`[Toast-${type.toUpperCase()}]: ${message}`);
            
            const container = document.getElementById('toast-container'); 
            if (!container) { 
                 console.error("Toast container not found!");
                 return;
            }
            const toast = document.createElement('div');
            toast.className = `toast ${type}`; 
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => { if (container.contains(toast)) container.removeChild(toast); }, 300);
            }, 5000); 
        }

        // --- User's Original Global Functions (Unchanged) ---
        window.showMaterialsPage = showMaterialsPage;
        window.showContainersPage = showContainersPage;
        window.showReportsPage = showReportsPage;
        window.renderReports = renderReports; // For filter button
        window.hideFullPageView = hideFullPageView;
        window.showActiveListPage = showActiveListPage;
        window.showCompletedTodayListPage = showCompletedTodayListPage;
        window.showFutureListPage = showFutureListPage;

        // ==========================================================
        // ===     פונקציות חדשות עבור מערכת התקשורת (v9)        ===
        // ==========================================================
        
        /**
         * מאזין להודעות חדשות עבור כרטיס הזמנה ספציפי.
         * מדליק את המנורה אם יש הודעה חדשה שלא נקראה.
         * תואם לאינדקס: messages (type ASC, readByViewer ASC)
         */
        function listenForNewMessages(orderId) {
            // נתק מאזין קודם אם קיים עבור ההזמנה הזו
            if (messageUnsubscribeListeners[orderId]) {
                messageUnsubscribeListeners[orderId]();
            }

            const q = query(
                collection(db, 'orders', orderId, 'messages'),
                where('type', '==', 'message_to_admin'),
                where('readByViewer', '==', false), // חפש הודעות שלא נקראו (תואם לאינדקס)
                limit(1)
            );
            
            messageUnsubscribeListeners[orderId] = onSnapshot(q, (snapshot) => {
                const icon = document.getElementById(`msg-icon-${orderId}`);
                if (icon) {
                    if (!snapshot.empty) {
                        icon.classList.remove('hidden'); // הדלק מנורה
                    } else {
                        icon.classList.add('hidden'); // כבה מנורה
                    }
                }
            }, (error) => {
                console.error(`Error listening for messages on ${orderId}:`, error);
            });
        }
        
        /**
         * פותח את המודל הקיים ומציג בו את היסטוריית הצ'אט.
         * וגם מסמן את ההודעות כ"נקראו".
         */
        window.showMessagesModal = async function(orderId) {
            if (!orderId) return;

            // 1. כבה את המנורה (מכיוון שהמשתמש נכנס לראות)
            const icon = document.getElementById(`msg-icon-${orderId}`);
            if (icon) {
                icon.classList.add('hidden');
            }
            
            // 2. עדכן הודעות כ"נקראו" (באצווה)
            await updateMessagesAsRead(orderId);
            
            // 3. הצג את המודל הקיים
            document.getElementById('modal-title').innerText = `תקשורת (הזמנה ${orderId.substring(0,6)})`;
            const contentDiv = document.getElementById('modal-body-content');
            contentDiv.innerHTML = `
                <div id="messages-chat-log" class="h-96 bg-gray-100 rounded-lg p-4 overflow-y-auto flex flex-col space-y-2 mb-4">
                    <p id="loading-messages" class="text-center text-gray-500">טוען הודעות...</p>
                </div>
            `;
            document.getElementById('modal-footer').style.display = 'none'; // הסתר פוטר שמירה
            showFullPageView();
            
            // 4. טען את ההודעות
            loadOrderMessages(orderId);
        }

        /**
         * פונקציה חדשה שמעדכנת את כל ההודעות ללקוח כנקראו
         */
        async function updateMessagesAsRead(orderId) {
            console.log(`Marking messages as read for order ${orderId}...`);
            // 1. מצא את כל ההודעות שטרם נקראו
            const q = query(
                collection(db, 'orders', orderId, 'messages'),
                where('type', '==', 'message_to_admin'),
                where('readByViewer', '==', false)
            );
            
            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    console.log("No new messages to mark as read.");
                    return; // אין מה לעדכן
                }
                
                // 2. צור אצווה (Batch) לעדכון כל ההודעות בבת אחת
                const batch = writeBatch(db);
                snapshot.docs.forEach(docRef => {
                    batch.update(docRef.ref, { readByViewer: true });
                });
                
                // 3. בצע את האצווה
                await batch.commit();
                console.log(`Marked ${snapshot.size} messages as read.`);

            } catch (error) {
                console.error("Error marking messages as read: ", error);
                // אל תחסום את המשתמש, פשוט תרשום שגיאה
            }
        }

        /**
         * טוען את כל ההודעות (לקוח, מנהל, הערות) למודל.
         */
        function loadOrderMessages(orderId) {
            // נתק מאזין מודל קודם
            if (unsubscribeModalMessages) unsubscribeModalMessages();

            const messagesContainer = document.getElementById('messages-chat-log');
            
            const q = query(
                collection(db, 'orders', orderId, 'messages'),
                orderBy('timestamp', 'asc') // הצג מהישן לחדש
            );
            
            unsubscribeModalMessages = onSnapshot(q, (querySnapshot) => {
                const loadingEl = document.getElementById('loading-messages');
                if (loadingEl) loadingEl.remove();
                
                if (querySnapshot.empty) {
                    messagesContainer.innerHTML = '<p class="text-center text-gray-500">אין הודעות או הערות להזמנה זו.</p>';
                    return;
                }
                
                messagesContainer.innerHTML = ''; // נקה
                querySnapshot.forEach((doc) => {
                    messagesContainer.appendChild(createMessageBubble(doc.data()));
                });
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight; // גלול לתחתית
            }, (error) => {
                console.error("Error loading messages: ", error);
                messagesContainer.innerHTML = '<p class="text-center text-red-500">שגיאה בטעינת הודעות.</p>';
            });
        }
        
        /**
         * יוצר בועת צ'אט מעוצבת לפי סוג ההודעה.
         */
        function createMessageBubble(msg) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex flex-col';
            
            let bubbleClass = '';
            let senderName = '';
            
            switch(msg.type) {
                case 'message_to_admin':
                    bubbleClass = 'chat-bubble chat-bubble-customer';
                    senderName = msg.senderName || 'לקוח';
                    wrapper.classList.add('items-end'); // ישר לימין
                    break;
                case 'notification_to_customer':
                    bubbleClass = 'chat-bubble chat-bubble-admin';
                    senderName = msg.senderName || 'מנהל';
                    wrapper.classList.add('items-start'); // ישר לשמאל
                    break;
                case 'internal_note':
                    bubbleClass = 'chat-bubble chat-bubble-note';
                    senderName = `${msg.senderName || 'סדרן'} (הערה פנימית)`;
                    wrapper.classList.add('items-center'); // ישר למרכז
                    break;
                default:
                    bubbleClass = 'chat-bubble chat-bubble-admin';
                    senderName = msg.senderName || 'מערכת';
                    wrapper.classList.add('items-start');
            }
            
            const time = msg.timestamp ? msg.timestamp.toDate().toLocaleString('he-IL') : 'שולח...';
            
            wrapper.innerHTML = `
                <div class="${bubbleClass}">
                    <strong class="font-semibold block">${senderName}</strong>
                    <p class="mt-1">${msg.text}</p>
                    <span class="chat-timestamp text-right mt-2">${time}</span>
                </div>
            `;
            return wrapper;
        }

        /**
         * פותח את המודל הקיים ומציג טופס הוספת הערה.
         */
        window.showAddNoteModal = function(orderId) {
            if (!orderId) return;

            document.getElementById('modal-title').innerText = `הוסף הערה (הזמנה ${orderId.substring(0,6)})`;
            const contentDiv = document.getElementById('modal-body-content');
            
            contentDiv.innerHTML = `
                <input type="hidden" id="current-order-id-for-note" value="${orderId}">
                <div class="mb-4">
                    <label for="note-author" class="block text-sm font-medium text-gray-700 mb-1">שם הכותב:</label>
                    <input type="text" id="note-author" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="השם שלך (לדוגמה: יוסי)">
                </div>
                <div>
                    <label for="note-text" class="block text-sm font-medium text-gray-700 mb-1">תוכן ההערה:</label>
                    <textarea id="note-text" class="w-full p-2 border border-gray-300 rounded-lg" rows="5" placeholder="כתוב כאן הערה פנימית לתיעוד..."></textarea>
                </div>
            `;
            
            // הגדר את כפתור השמירה בפוטר
            const saveButton = document.getElementById('modal-save-button');
            saveButton.innerText = 'שמור הערה';
            saveButton.onclick = saveInternalNote; // חבר פונקציה חדשה
            
            document.getElementById('modal-footer').style.display = 'block'; // הצג פוטר שמירה
            showFullPageView();
        }
        
        /**
         * שומר את ההערה הפנימית ב-Firestore.
         */
        async function saveInternalNote() {
            const orderId = document.getElementById('current-order-id-for-note').value;
            const author = document.getElementById('note-author').value.trim();
            const text = document.getElementById('note-text').value.trim();
            const saveButton = document.getElementById('modal-save-button');

            if (!orderId || !author || !text) {
                showToast("נא למלא שם ותוכן הערה", "error");
                return;
            }
            
            const noteDoc = {
                text: text,
                senderName: author,
                senderId: auth.currentUser ? auth.currentUser.uid : "viewer_user",
                timestamp: serverTimestamp(),
                type: "internal_note" // סוג ההודעה
            };
            
            saveButton.disabled = true;
            saveButton.innerText = 'שומר...';

            try {
                const messagesColRef = collection(db, 'orders', orderId, 'messages');
                await addDoc(messagesColRef, noteDoc);
                
                showToast("ההערה נשמרה בהצלחה!", "success");
                hideFullPageView();

            } catch (error) {
                console.error("Error adding note:", error);
                showToast("שגיאה בשמירת ההערה", "error");
            } finally {
                saveButton.disabled = false;
                saveButton.innerText = 'שמור הערה';
            }
        }
        
        // --- חשיפה גלובלית של פונקציות התקשורת ---
        window.showMessagesModal = showMessagesModal;
        window.showAddNoteModal = showAddNoteModal;

    </script>
</body>
</html>

