<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ח. סבן | הזמנות וצ'אט</title>
    <link rel="manifest" href="manifest.json">
    
    <!-- OneSignal -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        try {
            await OneSignal.init({
              appId: "de3834d3-1e11-40af-96d2-b25eda821c8f",
              safari_web_id: "web.onesignal.auto.00000000-0000-0000-0000-000000000000",
              notifyButton: { enable: false },
              allowLocalhostAsSecureOrigin: true 
            });
        } catch (e) { console.warn("Push Init:", e); }
      });
    </script>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #e5ded8; overflow: hidden; touch-action: manipulation; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .wa-header { background-color: #008069; color: white; }
        .wa-bg { background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); background-repeat: repeat; background-attachment: fixed; }
        .wa-bubble-out { background-color: #d9fdd3; border-radius: 7.5px; border-top-left-radius: 0; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .wa-bubble-in { background-color: #ffffff; border-radius: 7.5px; border-top-right-radius: 0; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .hit-area { min-height: 44px; min-width: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        input:focus { outline: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    <audio id="msg-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, query, orderBy, where, addDoc, serverTimestamp, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949", 
          storageBucket: "saban94-78949.firebasestorage.app", 
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Icons ---
        function Icon({ name, size=20, color="currentColor", className }) {
            useEffect(() => lucide.createIcons(), [name]);
            return <i data-lucide={name} width={size} height={size} stroke={color} className={className}></i>;
        }

        // --- Login Screen ---
        function AuthScreen({ onLogin }) {
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            return (
                <div className="flex h-screen items-center justify-center bg-[#111b21] p-4">
                    <div className="bg-white p-8 rounded-2xl w-full max-w-sm text-center shadow-xl">
                        <div className="w-20 h-20 bg-[#00a884] rounded-full mx-auto mb-6 flex items-center justify-center"><i data-lucide="message-circle" className="text-white w-10 h-10"></i></div>
                        <h2 className="text-2xl font-bold mb-6 text-gray-800">כניסת לקוחות</h2>
                        <form onSubmit={(e)=>{e.preventDefault(); onLogin(email,pass)}} className="space-y-4">
                            <input type="email" placeholder="אימייל" className="w-full p-3 border rounded-lg bg-gray-50" value={email} onChange={e=>setEmail(e.target.value)} required/>
                            <input type="password" placeholder="סיסמה" className="w-full p-3 border rounded-lg bg-gray-50" value={pass} onChange={e=>setPass(e.target.value)} required/>
                            <button className="w-full p-3 bg-[#00a884] text-white rounded-lg font-bold hover:bg-[#008f6f]">התחבר</button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- Catalog ---
        function CatalogModal({ onClose, onSendOrder }) {
            const [cart, setCart] = useState([]);
            const products = [
                { id: 1, name: "לוח גבס לבן", price: 38, unit: "יח'", img: "https://placehold.co/100?text=Gevs" },
                { id: 2, name: "מלט שחור", price: 28, unit: "שק", img: "https://placehold.co/100?text=Cement" },
                { id: 3, name: "חול ים", price: 150, unit: "בלה", img: "https://placehold.co/100?text=Sand" },
                { id: 4, name: "טיט מוכן", price: 25, unit: "שק", img: "https://placehold.co/100?text=Tit" },
            ];

            const addToCart = (p) => {
                setCart(prev => {
                    const existing = prev.find(i => i.id === p.id);
                    if(existing) return prev.map(i => i.id === p.id ? {...i, qty: i.qty + 1} : i);
                    return [...prev, {...p, qty: 1}];
                });
            };

            return (
                <div className="fixed inset-0 bg-white z-50 flex flex-col slide-up">
                    <div className="bg-[#008069] p-4 text-white flex justify-between items-center shadow-md">
                        <h2 className="text-lg font-bold">קטלוג והזמנה</h2>
                        <button onClick={onClose}><Icon name="x" /></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 bg-gray-50 pb-24">
                        <div className="grid grid-cols-2 gap-3 mb-6">
                            {products.map(p => (
                                <div key={p.id} className="bg-white p-3 rounded-xl shadow-sm flex flex-col items-center text-center border border-gray-100 active:scale-95 transition-transform" onClick={()=>addToCart(p)}>
                                    <img src={p.img} className="rounded-lg mb-2 w-full h-20 object-cover"/>
                                    <h4 className="font-bold text-sm line-clamp-1">{p.name}</h4>
                                    <p className="text-xs text-blue-600 font-bold">₪{p.price} / {p.unit}</p>
                                    <button className="mt-2 bg-blue-50 text-blue-600 text-xs px-4 py-1 rounded-full font-bold">+ הוסף</button>
                                </div>
                            ))}
                        </div>
                        {cart.length > 0 && (
                            <div className="bg-white p-4 rounded-xl shadow-lg border border-blue-100 mb-20">
                                <h3 className="font-bold text-lg mb-3 border-b pb-2">העגלה שלך ({cart.length})</h3>
                                <button onClick={() => onSendOrder(cart)} className="w-full bg-[#008069] text-white py-3 rounded-xl font-bold shadow flex justify-center gap-2">שלח הזמנה <Icon name="send"/></button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- Chat ---
        function ChatScreen({ user, profile, room }) {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [menuOpen, setMenuOpen] = useState(false);
            const [showCatalog, setShowCatalog] = useState(false);
            const bottomRef = useRef(null);
            const fileInput = useRef(null);

            useEffect(() => {
                const q = query(collection(db, 'messages'), where('roomId', '==', room.projectId), orderBy('createdAt', 'asc'));
                const unsub = onSnapshot(q, snap => {
                    setMessages(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    // Play sound on new message
                });
                return () => unsub();
            }, [room]);

            useEffect(() => bottomRef.current?.scrollIntoView({ behavior: 'smooth' }), [messages]);

            const sendMessage = async (type = 'TEXT', payload = null) => {
                const msg = {
                    roomId: room.projectId,
                    senderId: user.uid,
                    senderName: profile.name || 'לקוח',
                    senderAvatar: profile.avatarUrl || '',
                    type,
                    createdAt: serverTimestamp(),
                    readByWorker: false,
                    status: 'sent'
                };

                if (type === 'TEXT') { if(!input.trim()) return; msg.text = input; setInput(''); }
                else if (type === 'ORDER') { 
                    msg.text = 'הזמנה חדשה מהקטלוג'; 
                    msg.orderPayload = { items: payload, total: payload.length }; 
                    msg.orderStatus = 'new'; 
                }
                else if (type === 'IMAGE') { msg.text = 'תמונה'; msg.mediaUrl = payload; }

                setShowCatalog(false);
                setMenuOpen(false);
                
                try { await addDoc(collection(db, 'messages'), msg); } catch(e) { alert("שגיאה בשליחה"); }
            };

            const handleFile = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => sendMessage('IMAGE', ev.target.result); 
                reader.readAsDataURL(file);
            };

            return (
                <div className="flex flex-col h-full wa-bg">
                    <div className="wa-header p-3 flex items-center shadow-sm z-10">
                        <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center mr-3 text-white font-bold text-lg">
                            {room.name ? room.name[0] : 'S'}
                        </div>
                        <div className="flex-1">
                            <div className="font-bold text-sm">{room.name}</div>
                            <div className="text-xs opacity-80">מחובר כעת</div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 relative space-y-2">
                        {messages.map(m => {
                            const isMe = m.senderId === user.uid;
                            let content = <span className="text-sm whitespace-pre-wrap">{m.text}</span>;
                            
                            if(m.type === 'ORDER') {
                                content = (
                                    <div className="bg-green-50 p-2 rounded border border-green-100 -mx-1 -mt-1 mb-1">
                                        <div className="font-bold text-xs text-green-800 flex items-center gap-1 mb-2 border-b border-green-200 pb-1">
                                            <i data-lucide="shopping-cart" width="12"></i> הזמנה #{m.id.slice(-4)}
                                        </div>
                                        <ul className="space-y-1">
                                            {m.orderPayload.items.map((item, i) => (
                                                <li key={i} className="flex justify-between text-xs">
                                                    <span>{item.name}</span>
                                                    <span className="font-bold">x{item.qty}</span>
                                                </li>
                                            ))}
                                        </ul>
                                        <div class="mt-2 text-[10px] font-bold text-green-600 bg-white px-2 rounded w-fit">{m.orderStatus || 'חדש'}</div>
                                    </div>
                                );
                            }
                            if(m.type === 'IMAGE') content = <img src={m.mediaUrl} className="rounded-lg max-w-[200px]" />;

                            return (
                                <div key={m.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[80%] p-2 px-3 shadow-sm relative ${isMe ? 'wa-bubble-out rounded-tr-none' : 'wa-bubble-in rounded-tl-none'}`}>
                                        {content}
                                        <div className="text-[10px] text-gray-400 text-end mt-1 flex justify-end gap-1">
                                            {m.createdAt?.toDate ? m.createdAt.toDate().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '...'}
                                            {isMe && <i data-lucide="check-check" width="12"></i>}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                        <div ref={bottomRef}></div>
                    </div>

                    {menuOpen && (
                        <div className="absolute bottom-16 left-4 right-4 bg-white rounded-xl shadow-xl p-4 grid grid-cols-3 gap-4 z-20 slide-up">
                            <div onClick={()=>setShowCatalog(true)} className="flex flex-col items-center gap-1 hit-area"><div className="p-3 bg-purple-100 rounded-full text-purple-600"><i data-lucide="shopping-bag"></i></div><span className="text-xs font-bold">קטלוג</span></div>
                            <div onClick={()=>fileInput.current.click()} className="flex flex-col items-center gap-1 hit-area"><div className="p-3 bg-pink-100 rounded-full text-pink-600"><i data-lucide="image"></i></div><span className="text-xs font-bold">גלריה</span></div>
                        </div>
                    )}

                    <div className="bg-[#f0f2f5] p-2 flex items-center gap-2 z-20">
                        <button onClick={()=>setMenuOpen(!menuOpen)} className={`p-2 rounded-full transition ${menuOpen?'rotate-45 bg-gray-300':''}`}><i data-lucide="plus" className="text-gray-500"></i></button>
                        <input type="file" ref={fileInput} className="hidden" accept="image/*" onChange={handleFile}/>
                        
                        <div className="flex-1 bg-white rounded-2xl px-4 py-2 shadow-sm flex items-center">
                            <input className="w-full bg-transparent text-sm" placeholder="הודעה" value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&sendMessage('TEXT')}/>
                        </div>
                        
                        <button onClick={()=>sendMessage('TEXT')} className="p-3 bg-[#008069] text-white rounded-full shadow-md hit-area"><i data-lucide="send" width="18"></i></button>
                    </div>
                    
                    {showCatalog && <CatalogModal onClose={()=>setShowCatalog(false)} onSendOrder={(cart)=>sendMessage('ORDER', cart)} />}
                </div>
            );
        }

        // --- App Main ---
        function App() {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [project, setProject] = useState(null);

            useEffect(() => {
                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        if(window.OneSignalDeferred) window.OneSignalDeferred.push(OS => OS.login(u.uid));
                        const snap = await getDoc(doc(db, 'customers', u.uid));
                        if (snap.exists()) {
                            const data = snap.data();
                            setProfile(data);
                            setProject(data.projects?.[0] || { projectId: 'room_'+u.uid, name: 'פרויקט ראשי' });
                        } else {
                            const def = { name: u.displayName || 'אורח', projects: [{ projectId: 'room_'+u.uid, name: 'פרויקט ראשי' }] };
                            await setDoc(doc(db, 'customers', u.uid), def);
                            setProfile(def);
                            setProject(def.projects[0]);
                        }
                        setUser(u);
                    } else {
                        setUser(null);
                    }
                });
            }, []);

            const handleLogin = async (email, password) => {
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (e) { alert("שגיאה: " + e.message); }
            };

            if (!user) return <AuthScreen onLogin={handleLogin} />;
            if (!project) return <div className="text-center mt-20">טוען נתונים...</div>;

            return <ChatScreen user={user} profile={profile} room={project} />;
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // Icon Init
        setInterval(() => { if(window.lucide) window.lucide.createIcons(); }, 1000);
    </script>
</body>
</html>
