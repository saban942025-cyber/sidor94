<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול מכולות | DeliveryMaster</title>
    
    <!-- ייבוא Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/feather-icons">

    <!-- ייבוא Firebase - מוגדר כגלובלי לשימוש בפונקציות -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug');
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? initialAuthToken : null;
        
        if (!firebaseConfig) {
            console.error("Firebase config is missing.");
            throw new Error("Firebase config is missing.");
        }

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.serverTimestamp = serverTimestamp;

        onAuthStateChanged(window.auth, async (user) => {
            if (user) {
                window.userId = user.uid;
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                        window.userId = window.auth.currentUser.uid;
                    } else {
                        await signInAnonymously(window.auth);
                        window.userId = window.auth.currentUser.uid;
                    }
                } catch (error) {
                    console.error("Firebase Sign-In Failed:", error);
                }
            }
            
            window.firebaseAuthReady = true;
            document.dispatchEvent(new Event('firebaseAuthReady'));
        });
    </script>

    <style>
        /* הגדרות בסיסיות ל-RTL ולגופן */
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            direction: rtl;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            scroll-behavior: smooth;
        }
        * { box-sizing: border-box; }
        
        /* סגנון כותרת מדומה */
        .mock-header {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .mock-header h1 { margin: 0; font-size: 1.5rem; }
        
        /* כפתור פתיחת הדשבורד (כפתור חזור במימוש אמיתי) */
        #openEcoDashboardButton {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #openEcoDashboardButton:hover {
            background-color: #2980b9;
        }

        /* סגנון כרטיס המכולה */
        .eco-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-right: 5px solid #e74c3c; /* צבע אדום ברירת מחדל */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            height: 100%; /* חשוב לשמירה על גובה אחיד בגריד */
        }
        .eco-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }
        
        /* ספציפי לצבעי סטטוס */
        .status-ready { border-right-color: #2ecc71; } /* ירוק - מוכן */
        .status-in-use { border-right-color: #f1c40f; } /* צהוב - בשימוש */
        .status-problem { border-right-color: #e74c3c; } /* אדום - תקלה */

        .eco-info-line {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            color: #34495e;
        }
        .eco-info-line svg {
            color: #3498db;
            width: 18px;
            height: 18px;
            min-width: 18px;
        }
        
        .eco-customer-name {
            font-size: 1.25rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .eco-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: auto; /* דוחף את הפעולות לתחתית הכרטיס */
            padding-top: 10px;
            border-top: 1px solid #ecf0f1;
        }
        .eco-action-btn {
            flex-grow: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .replace-btn { background-color: #f39c12; color: white; }
        .replace-btn:hover { background-color: #e67e22; }

        .remove-btn { background-color: #e74c3c; color: white; }
        .remove-btn:hover { background-color: #c0392b; }
        
        .map-icon { color: #3498db !important; }

        /* סגנונות סרגל ניווט עליון (NavBar) */
        .eco-navbar {
            background-color: white;
            padding: 15px 30px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }
        
        /* סגנון שדה חיפוש */
        #search-input {
            flex-grow: 1;
            max-width: 400px;
            padding: 10px 15px;
            border: 1px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1rem;
            text-align: right;
            transition: border-color 0.3s;
        }
        #search-input:focus {
            border-color: #3498db;
            outline: none;
        }
        
        /* סגנון כפתור הוספה (מכולה חדשה) - לא רלוונטי כאן, אבל משאיר את ה-CSS הקיים */
        #addContainerButton {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #addContainerButton:hover {
            background-color: #27ae60;
        }

        /* סגנון אזור הרשת (הגריד) - שינוי ל-display: block כדי להכיל כותרות */
        #eco-grid {
            display: block; 
            padding: 20px;
        }
        /* סגנון גריד פנימי עבור הכרטיסים בכל מחסן */
        .warehouse-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* סגנון לסטטוסים מיוחדים */
        .eco-status {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            display: inline-block;
            text-align: center;
        }
        .status-ready .eco-status { background-color: #e6f7ee; color: #2ecc71; }
        .status-in-use .eco-status { background-color: #fff8e1; color: #f1c40f; }
        .status-problem .eco-status { background-color: #fdeded; color: #e74c3c; }

        /* אייקונים מתוך feather-icons */
        .icon-small { width: 16px; height: 16px; }

        /* סגנון לכרטיס ריק/הודעת טעינה */
        .eco-loading, .eco-empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 50px;
            color: #95a5a6;
            font-size: 1.2rem;
        }
    </style>
</head>

<body>
    <!-- כותרת מדומה -->
    <div class="mock-header">
        <h1>מכולות פעילות - ECO-3</h1>
        <button id="openEcoDashboardButton">חזור לדשבורד הראשי</button>
    </div>

    <!-- סרגל ניווט עליון (חיפוש) -->
    <div class="eco-navbar">
        <input type="text" id="search-input" placeholder="חפש לפי שם לקוח, כתובת או תעודת משלוח..." />
        <!-- כפתור הוספת מכולה הוסר מכאן, ההוספה מתבצעת דרך ההזמנות ב-index7.html -->
    </div>

    <!-- רשת הכרטיסים של המכולות - כעת מכילה כותרות ומקטעי רשת פנימיים -->
    <div id="eco-grid">
        <div class="eco-loading">טוען נתוני מכולות...</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const grid = document.getElementById('eco-grid');
            const searchInput = document.getElementById('search-input');
            const openEcoDashboardButton = document.getElementById('openEcoDashboardButton');

            // --- קבועים חדשים לבקשת המשתמש ---
            const CONST_WAREHOUSES = [
                { id: 'W30', name: 'מחסן 30 (שארק)' },
                { id: 'W32', name: 'מחסן 32 (כראדי)' },
                { id: 'W40', name: 'מחסן 40 (שי שרון)' }
            ];
            const getWarehouseName = (id) => CONST_WAREHOUSES.find(w => w.id === id)?.name || 'לא ידוע';

            // נתונים מדומים (למקרה שאין נתונים ב-Firestore)
            const mockContainers = [
                { id: 'C1001', customerName: 'דוד לוי', address: 'רחוב הרצל 5, תל אביב', type: 'פסולת בניין', status: 'in-use', lastService: '2025-10-25', warehouseId: 'W30', deliveryCertificateNumber: '671549601' },
                { id: 'C1002', customerName: 'שירה כהן', address: 'שדרות ירושלים 12, חיפה', type: 'גזם', status: 'ready', lastService: '2025-10-20', warehouseId: 'W32', deliveryCertificateNumber: '671549602' },
                { id: 'C1003', customerName: 'אביגיל מזרחי', address: 'דרך מנחם בגין 7, פתח תקווה', type: 'מעורבת', status: 'problem', lastService: '2025-10-28', warehouseId: 'W40', deliveryCertificateNumber: '671549603' },
                { id: 'C1004', customerName: 'יוסף חדד', address: 'רחוב העצמאות 88, ירושלים', type: 'גזם', status: 'in-use', lastService: '2025-10-26', warehouseId: 'W30', deliveryCertificateNumber: '671549604' },
            ];
            
            // --- פונקציות עזר כלליות ---
            const showToast = (message, type = 'info') => {
                console.log(`[TOAST - ${type.toUpperCase()}]: ${message}`);
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    info: 'bg-blue-500'
                };
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.className = `fixed bottom-5 right-5 z-50 p-4 text-white rounded-lg shadow-xl ${colors[type] || colors.info} transition-opacity duration-300`;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.style.opacity = 0;
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            };

            // --- לוגיקה ספציפית לניהול מכולות ---
            
            const getStatusDisplay = (statusKey) => {
                switch (statusKey) {
                    case 'ready':
                        return { class: 'status-ready', text: 'פנוי' };
                    case 'in-use':
                        return { class: 'status-in-use', text: 'בשימוש' };
                    case 'problem':
                        return { class: 'status-problem', text: 'תקלה/דורש טיפול' };
                    default:
                        return { class: 'status-unknown', text: 'לא ידוע' };
                }
            };

            /**
             * יוצר כרטיס מכולה HTML.
             * @param {Object} container - אובייקט נתוני המכולה.
             */
            const createContainerCard = (container) => {
                const status = getStatusDisplay(container.status);
                const warehouseName = getWarehouseName(container.warehouseId);
                
                const card = document.createElement('div');
                card.className = `eco-card ${status.class}`;
                card.dataset.id = container.id;
                // הוספת נתוני חיפוש מותאמים אישית
                card.dataset.deliveryCert = container.deliveryCertificateNumber || '';

                const lastServiceDate = container.lastService ? new Date(container.lastService).toLocaleDateString('he-IL') : 'לא דווח';
                
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex flex-col gap-1">
                            <div class="eco-customer-name">${container.customerName}</div>
                            <div class="eco-info-line text-sm text-gray-500">
                                ID: ${container.id}
                                <span class="mx-1 text-gray-300">|</span>
                                ${container.type}
                            </div>
                        </div>
                        <div class="eco-status">${status.text}</div>
                    </div>
                    
                    <div class="flex flex-col gap-2 flex-grow">
                        <div class="eco-info-line eco-address">
                            <i data-feather="map-pin" class="map-icon"></i>
                            <span>${container.address}</span>
                        </div>
                        <div class="eco-info-line text-gray-500">
                            <i data-feather="package" class="text-gray-400"></i>
                            <span>מחסן: ${warehouseName}</span>
                        </div>
                        <div class="eco-info-line text-gray-500 font-bold text-sm">
                            <i data-feather="clipboard" class="text-red-500"></i>
                            <span>תעודת משלוח: ${container.deliveryCertificateNumber || 'אין'}</span>
                        </div>
                        <div class="eco-info-line text-gray-500">
                            <i data-feather="clock" class="text-gray-400"></i>
                            <span>תחילת שכירות: ${lastServiceDate}</span>
                        </div>
                    </div>

                    <div class="eco-actions">
                        <button class="eco-action-btn replace-btn" onclick="window.handleReplace('${container.id}', '${container.customerName}')">
                            <i data-feather="refresh-ccw" class="icon-small"></i>
                            החלפה
                        </button>
                        <button class="eco-action-btn remove-btn" onclick="window.handleRemove('${container.id}', '${container.customerName}')">
                            <i data-feather="trash-2" class="icon-small"></i>
                            הוצאה
                        </button>
                    </div>
                `;

                feather.replace();

                return card;
            };

            const handleReplace = (containerId, customerName) => {
                showToast(`עדיין לא מחובר: בקשת החלפה עבור ${customerName} (ID: ${containerId})`, 'info');
            };
            window.handleReplace = handleReplace;

            const handleRemove = (containerId, customerName) => {
                showToast(`עדיין לא מחובר: בקשת הוצאה עבור ${customerName} (ID: ${containerId})`, 'info');
            };
            window.handleRemove = handleRemove;
            
            /**
             * מפעיל את האפליקציה לאחר סיום האימות ב-Firebase
             */
            const initializeEcoApp = () => {
                if (!window.db || !window.auth.currentUser) return;

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // נתיב הנתונים: /artifacts/{appId}/users/{userId}/container-orders
                const collectionPath = `/artifacts/${appId}/users/${window.userId}/container-orders`;
                
                const containersRef = collection(window.db, collectionPath);
                
                // שימוש ב-onSnapshot להאזנה להזמנות פעילות
                const q = query(containersRef, where("status", "==", "פעיל"));
                
                grid.innerHTML = '<div class="eco-loading">טוען נתוני מכולות...</div>';

                onSnapshot(q, (snapshot) => {
                    grid.innerHTML = ''; // ניקוי הגריד
                    let containersByWarehouse = {};
                    let totalContainers = 0;

                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        
                        const containerData = {
                            id: doc.id, 
                            customerName: data.customerName || 'לקוח לא ידוע',
                            address: data.address || 'כתובת לא ידועה',
                            type: data.containerType || 'כללי', 
                            status: 'in-use', // סטטוס קבוע לכל הזמנה פעילה
                            lastService: data.rentalStartDate?.toDate()?.toISOString().split('T')[0] || null,
                            warehouseId: data.warehouseId || 'W_UNKNOWN', 
                            deliveryCertificateNumber: data.deliveryCertificateNumber || null,
                        };
                        
                        const warehouseKey = containerData.warehouseId;
                        if (!containersByWarehouse[warehouseKey]) {
                            containersByWarehouse[warehouseKey] = [];
                        }
                        containersByWarehouse[warehouseKey].push(containerData);
                        totalContainers++;
                    });
                    
                    // --- טיפול במקרה ריק ---
                    if (totalContainers === 0) {
                        grid.innerHTML = '<div class="eco-empty">לא נמצאו הזמנות מכולות פעילות (סטטוס "פעיל") ב-Firestore.</div>';
                        return;
                    }

                    // --- רנדור מקובץ לפי מחסנים ---
                    const sortedWarehouseKeys = CONST_WAREHOUSES.map(w => w.id).filter(id => containersByWarehouse[id]);
                    
                    sortedWarehouseKeys.forEach(warehouseId => {
                        const warehouseName = getWarehouseName(warehouseId);
                        const containers = containersByWarehouse[warehouseId];
                        
                        const section = document.createElement('div');
                        section.className = 'warehouse-section mb-6';
                        section.dataset.warehouseId = warehouseId;

                        section.innerHTML = `
                            <h2 class="text-2xl font-bold mt-4 mb-3 text-gray-700 p-2 border-b-2 border-blue-500 rounded-md bg-white shadow-sm">
                                ${warehouseName} (${containers.length} מכולות פעילות)
                            </h2>
                            <div class="warehouse-grid" id="warehouse-${warehouseId}-grid">
                                <!-- Cards will be appended here -->
                            </div>
                        `;
                        grid.appendChild(section);
                        
                        const warehouseGrid = section.querySelector('.warehouse-grid');
                        
                        containers.sort((a, b) => a.customerName.localeCompare(b.customerName, 'he'));

                        containers.forEach(container => {
                            warehouseGrid.appendChild(createContainerCard(container));
                        });
                    });

                    feather.replace();
                    filterContainers(); // הפעלת פילטר החיפוש
                    showToast(`טעינת נתונים בוצעה בהצלחה (${totalContainers} מכולות פעילות)`, 'success');
                        
                }, (error) => {
                    console.error("Error listening to containers collection:", error);
                    grid.innerHTML = '<div class="eco-empty text-red-600">שגיאה בטעינת הנתונים. נא לבדוק את הגדרות Firebase.</div>';
                });
            };
            
            /**
             * פונקציה לפילטור המכולות על בסיס שדה החיפוש.
             */
            const filterContainers = () => {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const containerSections = grid.querySelectorAll('.warehouse-section');
                
                let resultsFound = 0;
                
                containerSections.forEach(section => {
                    let sectionHasVisibleCards = false;
                    const cards = section.querySelectorAll('.eco-card');
                    
                    cards.forEach(card => {
                        const customerName = card.querySelector('.eco-customer-name')?.textContent?.toLowerCase() || '';
                        const address = card.querySelector('.eco-address span')?.textContent?.toLowerCase() || '';
                        const deliveryCert = card.dataset.deliveryCert?.toLowerCase() || ''; // NEW: חיפוש לפי תעודת משלוח
                        
                        const isVisible = customerName.includes(searchTerm) || 
                                          address.includes(searchTerm) || 
                                          deliveryCert.includes(searchTerm);
                                          
                        card.style.display = isVisible ? 'flex' : 'none';
                        
                        if (isVisible) {
                            sectionHasVisibleCards = true;
                        }
                    });

                    section.style.display = sectionHasVisibleCards ? 'block' : 'none';
                    
                    if (sectionHasVisibleCards) {
                        // מונה רק כרטיסים גלויים בתוך הסקשן
                        resultsFound += Array.from(cards).filter(c => c.style.display !== 'none').length;
                    }
                });
                
                const noResults = grid.querySelector('.no-results-message');
                if (noResults) { noResults.remove(); }
                
                if (searchTerm.length > 0 && resultsFound === 0) {
                    const message = document.createElement('div');
                    message.className = 'eco-empty no-results-message text-gray-700 font-semibold';
                    message.textContent = `לא נמצאו מכולות פעילות עבור החיפוש: "${searchTerm}"`;
                    grid.appendChild(message);
                }
            };
            
            // --- Event Listeners ---
            searchInput.addEventListener('input', filterContainers);
            
            openEcoDashboardButton.addEventListener('click', () => {
                showToast('חזרה לדשבורד הראשי', 'info');
                window.location.href = 'index7.html'; 
            });

            // --- התחלת האפליקציה ---
            if (window.firebaseAuthReady) {
                initializeEcoApp();
            } else {
                document.addEventListener('firebaseAuthReady', () => {
                    initializeEcoApp();
                });
            }

        });
    </script>

</body>
</html>
