<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v32.5 (Stable)</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/feather-icons"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- סגנונות CSS - ללא שינוי מהמקור -->
    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
        }
        html, body {
            font-family: 'Inter', sans-serif;
            direction: rtl;
            background-color: var(--bg-light);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        * { box-sizing: border-box; }

        /* כרטיס הזמנה בסיסי */
        .order-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border-radius: 12px;
            overflow: hidden;
        }
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        /* אייקוני נוצה */
        .icon {
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
        }

        /* מפת ליפלט */
        #map-container {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* מודל */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
        }
        .modal-content {
            max-width: 90%;
            min-width: 320px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            animation: modal-open 0.3s forwards;
            z-index: 101;
        }
        @keyframes modal-open {
            to { transform: scale(1); }
        }

        /* טוסט הודעות */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .toast {
            animation: slide-in 0.3s forwards, fade-out 0.5s 4s forwards;
            opacity: 0;
        }
        @keyframes slide-in {
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fade-out {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* סליידר למיון */
        .sort-slider-track {
            height: 8px;
            background: var(--bg-light);
            border-radius: 4px;
        }
        .sort-slider-thumb {
            width: 16px;
            height: 16px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid var(--bg-white);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 10;
        }

        /* כפתור */
        .btn-primary {
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="toast-container"></div>
    <div class="max-w-7xl mx-auto">
        <!-- כותרת ראשית -->
        <header class="mb-8 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <i data-feather="truck" class="icon ml-2 text-primary-color"></i>
                ניהול הזמנות מכולות
            </h1>
            <div class="flex items-center space-x-4 space-x-reverse">
                <button id="openNewOrderModalButton" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg font-semibold transition shadow-md flex items-center">
                    <i data-feather="plus" class="icon ml-2"></i>
                    הזמנה חדשה
                </button>
                <div class="text-sm text-gray-500" id="user-info">טוען משתמש...</div>
            </div>
        </header>

        <!-- מסננים ומיון -->
        <section class="mb-8 p-6 bg-white rounded-xl shadow-lg flex flex-wrap items-end gap-6">
            <!-- סרגל חיפוש -->
            <div class="flex-grow min-w-[200px]">
                <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">חיפוש מהיר</label>
                <div class="relative">
                    <i data-feather="search" class="icon absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="search-input" placeholder="חפש לקוח, כתובת או סטטוס..." class="w-full p-3 pr-10 border border-gray-300 rounded-lg focus:ring-primary-color focus:border-primary-color">
                </div>
            </div>

            <!-- סינון סטטוס -->
            <div>
                <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">סינון לפי סטטוס</label>
                <select id="status-filter" class="p-3 border border-gray-300 rounded-lg bg-white focus:ring-primary-color focus:border-primary-color min-w-[150px]">
                    <option value="all">כל הסטטוסים</option>
                    <option value="pending">ממתין</option>
                    <option value="scheduled">מתוזמן</option>
                    <option value="active">פעיל</option>
                    <option value="returned">הוחזר</option>
                    <option value="cancelled">בוטל</option>
                </select>
            </div>

            <!-- מיון -->
            <div>
                <label for="sort-by" class="block text-sm font-medium text-gray-700 mb-1">מיון לפי</label>
                <select id="sort-by" class="p-3 border border-gray-300 rounded-lg bg-white focus:ring-primary-color focus:border-primary-color min-w-[150px]">
                    <option value="orderDate">תאריך הזמנה</option>
                    <option value="deliveryType">סוג משלוח</option>
                    <option value="status">סטטוס</option>
                </select>
            </div>
        </section>

        <!-- מפה (יוצג בלחיצה) -->
        <section id="map-section" class="mb-8 hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                <i data-feather="map-pin" class="icon ml-2"></i>
                מפת מיקומים
            </h2>
            <div id="map-container"></div>
            <p id="map-status" class="text-center text-sm text-gray-500 mt-2"></p>
        </section>

        <!-- רשימת ההזמנות -->
        <section>
            <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                <i data-feather="list" class="icon ml-2"></i>
                רשימת ההזמנות הפעילות
            </h2>
            <div id="orders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- כרטיסי הזמנה ייטענו כאן -->
            </div>
            <p id="loading-message" class="text-center text-lg text-gray-500 mt-10">טוען הזמנות, אנא המתן...</p>
            <p id="no-orders-message" class="text-center text-lg text-gray-500 mt-10 hidden">לא נמצאו הזמנות תואמות.</p>
        </section>
    </div>

    <!-- מודל עריכת הזמנה - CONTAINER EDIT MODAL -->
    <div id="container-edit-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-content bg-white p-6 rounded-xl shadow-2xl w-full md:w-1/2 lg:w-1/3">
            <h3 class="text-2xl font-bold mb-4 border-b pb-2 flex justify-between items-center">
                עריכת הזמנת מכולה
                <button onclick="closeContainerEditModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-feather="x" class="icon"></i>
                </button>
            </h3>
            <form id="container-edit-form">
                <input type="hidden" id="container-edit-id">
                <p class="text-sm text-gray-600 mb-4">עדכון עבור הזמנה: <span id="container-edit-order-id" class="font-semibold text-gray-800"></span></p>

                <div class="mb-4">
                    <label for="container-edit-type" class="block text-sm font-medium text-gray-700">סוג משלוח</label>
                    <select id="container-edit-type" class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-primary-color focus:border-primary-color">
                        <option value="drop_off">הורדה</option>
                        <option value="pick_up">איסוף</option>
                        <option value="replace">החלפה</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="container-edit-date" class="block text-sm font-medium text-gray-700">תאריך מבוקש</label>
                        <input type="date" id="container-edit-date" class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-primary-color focus:border-primary-color" required>
                    </div>
                    <div>
                        <label for="container-edit-time" class="block text-sm font-medium text-gray-700">שעת הגעה</label>
                        <input type="time" id="container-edit-time" class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-primary-color focus:border-primary-color">
                    </div>
                </div>

                <div class="mb-4">
                    <label for="container-edit-notes" class="block text-sm font-medium text-gray-700">הערות להזמנה</label>
                    <textarea id="container-edit-notes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-primary-color focus:border-primary-color"></textarea>
                </div>

                <div class="mb-6">
                    <label for="container-edit-rental-start" class="block text-sm font-medium text-gray-700">תאריך התחלת שכירות (למכולות פעילות)</label>
                    <input type="date" id="container-edit-rental-start" class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-primary-color focus:border-primary-color">
                    <p class="text-xs text-gray-500 mt-1">מלא רק אם המכולה כבר בשטח (סטטוס 'פעיל').</p>
                </div>

                <div class="flex justify-end space-x-3 space-x-reverse">
                    <button type="button" onclick="closeContainerEditModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg font-semibold transition">ביטול</button>
                    <button type="submit" id="save-container-order-btn" class="btn-primary bg-primary-color text-white py-2 px-4 rounded-lg font-semibold shadow-md">שמור שינויים</button>
                </div>
            </form>
        </div>
    </div>


    <!-- סקריפטים -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, collection, query, where, onSnapshot, addDoc, serverTimestamp, deleteDoc, Timestamp, orderBy, arrayRemove, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- UI HELPERS ---

        /**
         * מציג הודעת טוסט למשתמש
         * @param {string} message - ההודעה להצגה
         * @param {'success'|'error'|'info'} type - סוג ההודעה
         */
        function showToast(message, type) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const colorMap = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            const toast = document.createElement('div');
            toast.className = `toast p-4 mb-3 rounded-lg text-white shadow-xl ${colorMap[type] || colorMap.info} flex items-center transform translate-x-full`;
            toast.textContent = message;

            container.prepend(toast); // הוספה לראש הרשימה
            setTimeout(() => toast.remove(), 5000); // הסרה לאחר 5 שניות
        }
        window.showToast = showToast;

        /**
         * פתיחת מודל עריכת מכולה
         * @param {string} orderId - ID של ההזמנה
         * @param {object} data - נתוני ההזמנה
         */
        function openContainerEditModal(orderId, data) {
            document.getElementById('container-edit-id').value = orderId;
            document.getElementById('container-edit-order-id').textContent = orderId;
            document.getElementById('container-edit-type').value = data.deliveryType || 'drop_off';
            document.getElementById('container-edit-date').value = data.orderDate || '';
            document.getElementById('container-edit-time').value = data.orderTime || '';
            document.getElementById('container-edit-notes').value = data.notes || '';

            // המרת Timestamp לתאריך input מסוג date
            if (data.rentalStartDate && data.rentalStartDate.toDate) {
                document.getElementById('container-edit-rental-start').value = data.rentalStartDate.toDate().toISOString().substring(0, 10);
            } else {
                document.getElementById('container-edit-rental-start').value = '';
            }

            document.getElementById('container-edit-modal').classList.remove('hidden');
            feather.replace();
        }
        window.openContainerEditModal = openContainerEditModal;

        function closeContainerEditModal() {
            document.getElementById('container-edit-modal').classList.add('hidden');
        }
        window.closeContainerEditModal = closeContainerEditModal;


        // --- FIREBASE AND DATA LOGIC ---

        // Log utility
        const SmartLog = {
            info: (message, context, details) => console.log(`[INFO][${context}] ${message}`, details || ''),
            error: (error, context, details) => console.error(`[ERROR][${context}] ${error.message || error}`, details || error),
        };
        window.SmartLog = SmartLog;

        // Globals for Firebase services
        let db, auth;
        let userId = 'loading'; // Will be updated on auth state change
        window.isAuthReady = false; // Flag to indicate if auth check is complete

        /**
         * בונה נתיב קולקציה פרטי ספציפי למשתמש ולאפליקציה.
         * @param {string} collectionName - שם הקולקציה
         * @returns {string|null} הנתיב המלא או null אם חסר userId
         */
        function getPrivateCollectionPath(collectionName) {
            if (!userId || userId === 'loading') {
                SmartLog.error("Attempt to access private collection before userId is set.", "Auth.Path");
                return null;
            }
            return `artifacts/${window.appId}/users/${userId}/${collectionName}`;
        }
        window.getPrivateCollectionPath = getPrivateCollectionPath;


        document.addEventListener('DOMContentLoaded', () => {

            feather.replace();

            // --- FIREBASE INITIALIZATION ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            window.appId = appId;

            if (Object.keys(firebaseConfig).length === 0) {
                console.error("FATAL ERROR: Firebase config is missing. Application cannot connect to the database.");
                showToast('שגיאה חמורה: הגדרות Firebase חסרות.', 'error');
            } else {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // Added for debugging

                // Store services globally for use in handlers
                window.firebaseServices = { db, auth, doc, updateDoc, collection, query, where, onSnapshot, addDoc, serverTimestamp, deleteDoc, Timestamp, orderBy, arrayRemove, arrayUnion };

                // 1. Initial Sign-in Attempt
                const initialAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token.length > 0) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                            SmartLog.info("Signed in with custom token.", "Auth.Init");
                        } else {
                            await signInAnonymously(auth);
                            SmartLog.info("Signed in anonymously.", "Auth.Init");
                        }
                    } catch (error) {
                        SmartLog.error(error, "Auth.Init", { message: "Failed initial sign-in" });
                    }
                };
                initialAuth();


                // 2. State Change Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        window.isAuthReady = true;
                        window.firebaseAuthReady = true;
                        document.getElementById('user-info').textContent = `מחובר | ID: ${user.uid}`;
                        document.dispatchEvent(new Event('firebaseAuthReady'));
                        SmartLog.info("Auth state ready", "Auth.State", { userId });
                    } else {
                        userId = crypto.randomUUID(); // Fallback ID for anonymous/unauthenticated state
                        window.isAuthReady = false;
                        window.firebaseAuthReady = false;
                        document.getElementById('user-info').textContent = `אורח | ID: ${userId.substring(0, 8)}...`;
                        SmartLog.info("Auth state unauthenticated, using fallback ID.", "Auth.State");
                    }
                });

                // Set up the main application listener only when auth is ready
                document.addEventListener('firebaseAuthReady', initializeOrderDashboard);
            }


            // --- CORE APP LOGIC ---

            let ordersListener;
            let currentOrders = [];

            function initializeOrderDashboard() {
                // Clear previous listener if exists
                if (ordersListener) ordersListener();

                const collectionPath = getPrivateCollectionPath('container-orders');
                if (!collectionPath) return; // Should not happen if auth is ready

                const ordersRef = collection(db, collectionPath);
                // Listen to all changes, then filter/sort in JS
                const q = query(ordersRef);

                SmartLog.info("Setting up real-time listener for orders.", "Firestore.Listen", { path: collectionPath });
                document.getElementById('loading-message').classList.remove('hidden');

                ordersListener = onSnapshot(q, (snapshot) => {
                    currentOrders = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    SmartLog.info(`Received ${currentOrders.length} orders.`, "Firestore.Snapshot");
                    applyFiltersAndSort();
                    document.getElementById('loading-message').classList.add('hidden');
                }, (error) => {
                    SmartLog.error(error, "Firestore.Listener", { message: "Failed to fetch orders" });
                    showToast('שגיאה בטעינת הזמנות בזמן אמת. אנא רענן.', 'error');
                    document.getElementById('loading-message').classList.add('hidden');
                });
            }

            function applyFiltersAndSort() {
                let filteredOrders = [...currentOrders];
                const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
                const statusFilter = document.getElementById('status-filter').value;
                const sortBy = document.getElementById('sort-by').value;

                // 1. Filter
                filteredOrders = filteredOrders.filter(order => {
                    const statusMatch = statusFilter === 'all' || order.status === statusFilter;
                    const searchMatch = !searchTerm ||
                                        (order.customerName && order.customerName.toLowerCase().includes(searchTerm)) ||
                                        (order.address && order.address.toLowerCase().includes(searchTerm)) ||
                                        (order.status && order.status.toLowerCase().includes(searchTerm));
                    return statusMatch && searchMatch;
                });

                // 2. Sort
                filteredOrders.sort((a, b) => {
                    if (sortBy === 'orderDate') {
                        // Sort by date (convert string to comparable format or use Timestamp if available)
                        const dateA = a.orderDate || '0';
                        const dateB = b.orderDate || '0';
                        return dateA.localeCompare(dateB);
                    }
                    if (sortBy === 'deliveryType') {
                        return (a.deliveryType || '').localeCompare(b.deliveryType || '');
                    }
                    if (sortBy === 'status') {
                        return (a.status || '').localeCompare(b.status || '');
                    }
                    return 0;
                });

                renderOrders(filteredOrders);
            }

            function renderOrders(orders) {
                const grid = document.getElementById('orders-grid');
                grid.innerHTML = ''; // Clear existing content

                if (orders.length === 0) {
                    document.getElementById('no-orders-message').classList.remove('hidden');
                    return;
                }
                document.getElementById('no-orders-message').classList.add('hidden');

                orders.forEach(order => {
                    const card = createOrderCard(order);
                    grid.appendChild(card);
                });
                feather.replace(); // Re-render icons after DOM update
            }

            // Map Status Colors and Icons
            const statusMap = {
                pending: { color: 'text-yellow-600 bg-yellow-100', text: 'ממתין', icon: 'clock' },
                scheduled: { color: 'text-blue-600 bg-blue-100', text: 'מתוזמן', icon: 'calendar' },
                active: { color: 'text-red-600 bg-red-100', text: 'פעיל בשטח', icon: 'alert-triangle' },
                returned: { color: 'text-green-600 bg-green-100', text: 'הוחזר', icon: 'check-circle' },
                cancelled: { color: 'text-gray-600 bg-gray-200', text: 'בוטל', icon: 'x-circle' },
                default: { color: 'text-gray-600 bg-gray-200', text: 'לא ידוע', icon: 'help-circle' }
            };

            function createOrderCard(order) {
                const { color, text, icon } = statusMap[order.status] || statusMap.default;
                const statusBadge = `<span class="px-3 py-1 text-xs font-semibold rounded-full ${color} flex items-center"><i data-feather="${icon}" class="icon w-4 h-4 ml-1"></i> ${text}</span>`;

                const card = document.createElement('div');
                card.className = 'order-card bg-white p-5 border border-gray-200 flex flex-col justify-between';
                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-lg font-bold text-gray-900">${order.customerName || 'לקוח לא ידוע'}</h3>
                            ${statusBadge}
                        </div>
                        <p class="text-sm text-gray-700 flex items-center mb-2"><i data-feather="map-pin" class="icon w-4 h-4 ml-2 text-primary-color"></i> ${order.address || 'כתובת לא צוינה'}</p>
                        <p class="text-sm text-gray-700 flex items-center mb-2"><i data-feather="box" class="icon w-4 h-4 ml-2 text-primary-color"></i> סוג: ${order.containerType || 'לא צוין'}</p>
                        <p class="text-sm text-gray-600 flex items-center mb-2"><i data-feather="calendar" class="icon w-4 h-4 ml-2 text-gray-500"></i> מועד: ${order.orderDate || 'לא צוין'} בשעה ${order.orderTime || ''}</p>
                        <p class="text-xs text-gray-500 mt-3 border-t pt-2">מזהה הזמנה: ${order.id.substring(0, 8)}...</p>
                    </div>
                    <div class="mt-4 flex space-x-2 space-x-reverse justify-end">
                        <button onclick="openContainerEditModal('${order.id}', ${JSON.stringify(order).replace(/"/g, '&quot;')})" class="text-primary-color hover:text-primary-dark p-2 rounded-full transition" title="ערוך">
                            <i data-feather="edit" class="icon w-5 h-5"></i>
                        </button>
                        <button onclick="handleDeleteContainerOrder('${order.id}')" class="text-red-500 hover:text-red-600 p-2 rounded-full transition" title="מחק">
                            <i data-feather="trash-2" class="icon w-5 h-5"></i>
                        </button>
                    </div>
                `;
                return card;
            }

            // Event Listeners for Filters/Sort
            document.getElementById('search-input').addEventListener('input', applyFiltersAndSort);
            document.getElementById('status-filter').addEventListener('change', applyFiltersAndSort);
            document.getElementById('sort-by').addEventListener('change', applyFiltersAndSort);

            // --- CRUD Functions ---

            /**
             * טיפול בשמירת עריכת הזמנת מכולה
             */
            async function handleSaveContainerOrder(event) {
                event.preventDefault();
                const btn = document.getElementById('save-container-order-btn');
                btn.disabled = true;
                btn.innerText = 'שומר...';

                const orderId = document.getElementById('container-edit-id').value;
                const deliveryType = document.getElementById('container-edit-type').value;
                const orderDate = document.getElementById('container-edit-date').value.trim();
                const orderTime = document.getElementById('container-edit-time').value.trim();
                const rentalStartDateStr = document.getElementById('container-edit-rental-start').value.trim();
                const { db, doc, updateDoc, serverTimestamp, Timestamp } = window.firebaseServices;

                if (!db || !orderId) {
                    showToast('שגיאה: שירותי בסיס נתונים או ID חסרים.', 'error');
                    SmartLog.error("Missing DB services or Order ID", "CRUD.Container.Edit");
                    btn.disabled = false;
                    btn.innerText = 'שמור שינויים';
                    return;
                }

                try {
                    const collectionPath = getPrivateCollectionPath('container-orders');
                    if (!collectionPath) throw new Error("נתיב קולקציה אינו זמין.");
                    const orderRef = doc(db, collectionPath, orderId);

                    let rentalStartDate = null;
                    if (rentalStartDateStr) {
                         try {
                             // יוצר Timestamp מתאריך ה-HTML
                             rentalStartDate = Timestamp.fromDate(new Date(rentalStartDateStr));
                             SmartLog.info("Rental start date set.", "CRUD.Container.Edit");
                         } catch(e) {
                             SmartLog.error(e, "CRUD.Container.Edit", { date: rentalStartDateStr });
                             throw new Error("שגיאה בהמרת תאריך התחלת שכירות.");
                         }
                    }

                    const updatedData = {
                       deliveryType: deliveryType,
                       orderDate: orderDate,
                       orderTime: orderTime,
                       notes: document.getElementById('container-edit-notes').value.trim(),
                       rentalStartDate: rentalStartDate, // Update or clear the field
                       lastModified: serverTimestamp()
                    };

                    await updateDoc(orderRef, updatedData);
                    SmartLog.info("Container order updated", "CRUD.Container.Edit", { orderId, changes: updatedData });
                    showToast('הזמנת מכולה עודכנה', 'success');
                    closeContainerEditModal();
                    // Listener will automatically refresh the container view if it's active

                } catch (error) {
                    showToast(`שגיאה בעדכון הזמנת מכולה: ${error.message}`, 'error');
                    SmartLog.error(error, "CRUD.Container.Edit", { orderId });
                } finally {
                    btn.disabled = false;
                    btn.innerText = 'שמור שינויים';
                }
            }
            document.getElementById('container-edit-form').addEventListener('submit', handleSaveContainerOrder);
            window.handleSaveContainerOrder = handleSaveContainerOrder;

            /**
             * טיפול במחיקת הזמנת מכולה
             */
            async function handleDeleteContainerOrder(orderId) {
                if (!window.confirm("האם אתה בטוח שברצונך למחוק הזמנה זו?")) return;

                const { db, doc, deleteDoc } = window.firebaseServices;
                if (!db || !orderId) {
                    showToast('שגיאה: שירותי בסיס נתונים או ID חסרים.', 'error');
                    return;
                }

                try {
                    const collectionPath = getPrivateCollectionPath('container-orders');
                    if (!collectionPath) throw new Error("נתיב קולקציה אינו זמין.");

                    await deleteDoc(doc(db, collectionPath, orderId));
                    SmartLog.info("Container order deleted", "CRUD.Container.Delete", { orderId });
                    showToast('הזמנת מכולה נמחקה בהצלחה', 'success');
                } catch (error) {
                    showToast(`שגיאה במחיקת הזמנת מכולה: ${error.message}`, 'error');
                    SmartLog.error(error, "CRUD.Container.Delete", { orderId });
                }
            }
            window.handleDeleteContainerOrder = handleDeleteContainerOrder;

            // --- Map Logic (Stub) ---
            // Simplified placeholder for map logic as it's not the focus of the current request
            function initializeMap() {
                 console.log("Map initialization logic goes here (Leaflet setup).");
                 const mapElement = document.getElementById('map-container');
                 if (mapElement && !mapElement.classList.contains('leaflet-container')) {
                     const map = L.map('map-container').setView([32.0853, 34.7818], 10); // Tel Aviv
                     L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                         attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                     }).addTo(map);
                     document.getElementById('map-status').textContent = 'המפה נטענה. מרקרים יתווספו עם מיקומי הזמנות.';
                 }
            }
            // Bind map initialization to a button click (if one exists)
            // For now, leaving it unattached until required.

        });
    </script>
</body>
</html>
