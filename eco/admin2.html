<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v32.5 (Stable)</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/feather-icons"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- סגנונות CSS - ללא שינוי מהמקור -->
    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
        }

        html, body {
            font-family: 'Inter', sans-serif;
            direction: rtl;
            background-color: var(--bg-light);
        }
        
        .mock-header {
            background: #1f2937; /* gray-800 */
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .mock-header h1 { 
            margin: 0; 
            font-size: 1.5rem; 
            display: flex;
            align-items: center;
        }
        .mock-header .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            font-size: 0.9rem;
        }
        .mock-header .user-info span {
            font-weight: 500;
        }

        /* סגנונות חדשים למפה ולטבלה */
        #map-modal {
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }
        #map { height: 60vh; width: 100%; border-radius: 8px; }
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .data-table th, .data-table td { padding: 12px 16px; text-align: right; }
        .data-table th {
            background-color: var(--bg-white);
            color: #4b5563; /* gray-600 */
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
            border-bottom: 2px solid var(--border-color);
        }
        .data-table tr:hover .data-row {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .data-row {
            background-color: var(--bg-white);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }
        .data-row td {
            border-bottom: none;
            vertical-align: middle;
        }
        .data-row:not(:last-child) { margin-bottom: 8px; }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        .status-on-site { background-color: #fcd34d; color: #92400e; } /* amber-300 / 800 */
        .status-booked { background-color: #93c5fd; color: #1e40af; } /* blue-300 / 800 */
        .status-returned { background-color: #a7f3d0; color: #065f46; } /* emerald-300 / 800 */
        .status-pending { background-color: #fca5a5; color: #7f1d1d; } /* red-300 / 800 */
        .status-unknown { background-color: #d1d5db; color: #4b5563; } /* gray-300 / 600 */

        .action-button {
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .action-edit { background-color: #34d399; color: white; } /* emerald-400 */
        .action-edit:hover { background-color: #10b981; } /* emerald-500 */
        .action-delete { background-color: #f87171; color: white; } /* red-400 */
        .action-delete:hover { background-color: #ef4444; } /* red-500 */
        .action-return { background-color: #60a5fa; color: white; } /* blue-400 */
        .action-return:hover { background-color: #3b82f6; } /* blue-500 */

        /* סגנון ל-Toast (הודעות קופצות) */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 250px;
            transition: opacity 0.3s, transform 0.3s;
        }
        .toast-success { background-color: #10b981; } /* Emerald */
        .toast-error { background-color: #ef4444; } /* Red */
        .toast-info { background-color: #3b82f6; } /* Blue */

        /* סגנון למודלים */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 50;
        }
        .modal-content {
            z-index: 60;
            max-height: 90vh;
            overflow-y: auto;
        }
        
    </style>

</head>
<body class="bg-gray-100 min-h-screen">
    
    <!-- הוספת טעינת Tailwind ו-Feather Icons -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            500: '#3b82f6',
                            600: '#2563eb',
                        }
                    }
                }
            }
        }
    </script>
    <script>
        // הפעלת Feather Icons לאחר טעינת הדף
        window.onload = () => {
            feather.replace();
        };
    </script>
    
    <!-- כותרת ראשית (Mock Header) -->
    <header class="mock-header">
        <div class="flex items-center space-x-3 space-x-reverse">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l-2 2-2-2m4 13h4M12 4v16"></path>
            </svg>
            <h1>DeliveryMaster | לוח מחוונים למכולות</h1>
        </div>
        <div class="user-info text-left">
            <span>משתמש: <strong id="user-display-name">...טוען...</strong></span>
            <span class="text-xs text-gray-400">ID: <span id="user-id-display">טוען...</span></span>
        </div>
    </header>

    <!-- תוכן ראשי -->
    <main class="p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">ניהול הזמנות מכולות</h2>
                <div class="flex space-x-4 space-x-reverse">
                    <button id="openEcoDashboardButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out flex items-center">
                        <i data-feather="truck" class="ml-2 h-5 w-5"></i>
                        מעבר לניהול מכולות
                    </button>
                    <button id="openMapModalButton" class="bg-primary-500 hover:bg-primary-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out flex items-center">
                        <i data-feather="map-pin" class="ml-2 h-5 w-5"></i>
                        הצג מפה
                    </button>
                    <button onclick="window.openContainerAddModal()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out flex items-center">
                        <i data-feather="plus" class="ml-2 h-5 w-5"></i>
                        הוסף הזמנה חדשה
                    </button>
                </div>
            </div>

            <!-- סרגל חיפוש/סינון -->
            <div class="mb-6 bg-white p-4 rounded-xl shadow-lg flex flex-col md:flex-row gap-4">
                <input type="text" id="search-input" placeholder="חפש לפי שם לקוח, כתובת או ID" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150" dir="rtl">
                
                <select id="filter-status" class="p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 w-full md:w-auto">
                    <option value="">כל הסטטוסים</option>
                    <option value="on-site">באתר</option>
                    <option value="booked">הוזמן</option>
                    <option value="returned">הוחזר</option>
                </select>
            </div>

            <!-- טבלת הזמנות מכולות (מוצגת באמצעות JS) -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div id="container-orders-grid" class="space-y-4">
                    <!-- כרטיסי המכולות יוכנסו כאן על ידי JS -->
                    <div class="text-center text-gray-500 p-8" id="loading-indicator">טוען נתונים...</div>
                </div>
            </div>

        </div>
    </main>

    <!-- מודל הוספת מכולה חדשה -->
    <div id="container-add-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">הוספת הזמנת מכולה חדשה</h3>
            <form id="container-add-form">
                <div class="space-y-4">
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-700">שם לקוח*</label>
                        <input type="text" id="customer-name" name="customerName" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-500 focus:border-primary-500" dir="rtl">
                    </div>
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700">כתובת (למשלוח)*</label>
                        <input type="text" id="address" name="address" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-500 focus:border-primary-500" dir="rtl">
                    </div>
                    <div class="flex space-x-4 space-x-reverse">
                        <div class="flex-1">
                            <label for="order-date" class="block text-sm font-medium text-gray-700">תאריך הזמנה*</label>
                            <input type="date" id="order-date" name="orderDate" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div class="flex-1">
                            <label for="order-time" class="block text-sm font-medium text-gray-700">שעת הגעה משוערת*</label>
                            <input type="time" id="order-time" name="orderTime" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-500 focus:border-primary-500">
                        </div>
                    </div>
                    <div>
                        <label for="delivery-type" class="block text-sm font-medium text-gray-700">סוג משלוח</label>
                        <select id="delivery-type" name="deliveryType" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-500 focus:border-primary-500">
                            <option value="delivery">אספקה</option>
                            <option value="collection">איסוף</option>
                            <option value="replacement">החלפה</option>
                        </select>
                    </div>
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700">הערות</label>
                        <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-500 focus:border-primary-500" dir="rtl"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3 space-x-reverse">
                    <button type="button" onclick="window.closeContainerAddModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">ביטול</button>
                    <button type="submit" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition duration-150">שמור הזמנה</button>
                </div>
            </form>
        </div>
    </div>

    <!-- מודל עריכת מכולה קיימת -->
    <div id="container-edit-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">עריכת הזמנת מכולה <span id="container-edit-id-display" class="text-primary-500 text-base font-normal">(ID: )</span></h3>
            <form id="container-edit-form">
                <input type="hidden" id="container-edit-order-id">
                <div class="space-y-4">
                    <p class="text-gray-600">שם לקוח: <strong id="container-edit-customer-name-display"></strong></p>
                    <p class="text-gray-600">כתובת: <strong id="container-edit-address-display"></strong></p>
                    <hr class="my-3">
                    
                    <div>
                        <label for="container-edit-delivery-type" class="block text-sm font-medium text-gray-700">סוג משלוח</label>
                        <select id="container-edit-delivery-type" name="deliveryType" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-500 focus:border-primary-500">
                            <option value="delivery">אספקה</option>
                            <option value="collection">איסוף</option>
                            <option value="replacement">החלפה</option>
                        </select>
                    </div>

                    <div class="flex space-x-4 space-x-reverse">
                        <div class="flex-1">
                            <label for="container-edit-order-date" class="block text-sm font-medium text-gray-700">תאריך הזמנה</label>
                            <input type="date" id="container-edit-order-date" name="orderDate" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div class="flex-1">
                            <label for="container-edit-order-time" class="block text-sm font-medium text-gray-700">שעת הגעה משוערת</label>
                            <input type="time" id="container-edit-order-time" name="orderTime" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-500 focus:border-primary-500">
                        </div>
                    </div>

                    <div id="container-edit-rental-start-container">
                        <label for="container-edit-rental-start-date" class="block text-sm font-medium text-gray-700">תאריך תחילת שכירות (אתר)</label>
                        <input type="date" id="container-edit-rental-start-date" name="rentalStartDate" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-500 focus:border-primary-500">
                        <p class="text-xs text-gray-500 mt-1">שדה זה מתעדכן אוטומטית כשהסטטוס עובר ל"באתר". ניתן לערוך ידנית.</p>
                    </div>

                    <div>
                        <label for="container-edit-notes" class="block text-sm font-medium text-gray-700">הערות</label>
                        <textarea id="container-edit-notes" name="notes" rows="3" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-500 focus:border-primary-500" dir="rtl"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3 space-x-reverse">
                    <button type="button" onclick="window.closeContainerEditModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">ביטול</button>
                    <button type="submit" id="save-edit-button" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition duration-150">שמור שינויים</button>
                </div>
            </form>
        </div>
    </div>

    <!-- מודל מפה (Map Modal) -->
    <div id="map-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl p-6">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">מפת מכולות (באתר)</h3>
            <div id="map" class="h-96 w-full rounded-lg mb-4"></div>
            <p class="text-sm text-gray-500 mb-4">מוצגות הזמנות עם סטטוס "באתר" ומיקום מוגדר.</p>
            <div class="flex justify-end">
                <button type="button" onclick="window.closeMapModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">סגור</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <!-- סקריפטים של Firebase ו-App Logic -->
    <script type="module">
        // ------------------------------------
        // --- 1. הגדרות וייבוא שירותי Firebase ---
        // ------------------------------------

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs, serverTimestamp, setLogLevel, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // הגדרת משתנים גלובליים (כחלק מחלון)
        let app, db, auth;
        let userId = 'loading';
        let unsubscribeContainerOrders = null; // לביטול המאזין של onSnapshot

        // משתני סביבה גלובליים (מוכרזים על ידי המערכת)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // הגדרת שירותי פיירבייס גלובליים לנוחות
        window.firebaseServices = { 
            db, auth, doc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDoc, setDoc, getDocs, serverTimestamp, Timestamp
        };

        // הפעלת לוגיקה של Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug'); // חשוב לניפוי באגים
            window.firebaseServices.db = db;
            window.firebaseServices.auth = auth;
        } else {
             // טיפול במקרה של חוסר ב-Config (בסביבות מסוימות)
             console.error("Firebase Config is missing. App will run in limited mode.");
        }


        // ------------------------------------
        // --- 2. פונקציות עזר גלובליות ---
        // ------------------------------------

        // פונקציית לוג מותאמת אישית
        const SmartLog = {
            info: (msg, context, data = {}) => console.log(`[INFO] ${context}: ${msg}`, data),
            error: (err, context, data = {}) => console.error(`[ERROR] ${context}: ${err.message || err}`, data, err)
        };

        // פונקציה להצגת הודעות קופצות (Toasts)
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast toast-${type} transform translate-y-0 opacity-0 transition duration-300 ease-out`;
            toast.textContent = message;
            container.appendChild(toast);

            // הפעלת אנימציית כניסה
            setTimeout(() => {
                toast.style.opacity = '1';
            }, 10);

            // הפעלת אנימציית יציאה והסרה
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }
        window.showToast = showToast; // חשיפת הפונקציה ל-window

        // פונקציה לבניית נתיב קולקציה פרטית של המשתמש
        function getPrivateCollectionPath(collectionName) {
            if (!userId || userId === 'loading' || appId === 'default-app-id') {
                 SmartLog.error("Missing userId or appId", "System.Path.Creation");
                 return null;
            }
            // הנתיב: /artifacts/{appId}/users/{userId}/{collectionName}
            return `artifacts/${appId}/users/${userId}/${collectionName}`;
        }


        // ------------------------------------
        // --- 3. לוגיקת זהות ושם משתמש קבוע (פרופיל) ---
        // ------------------------------------
        
        // פונקציה לטעינה או יצירת פרופיל משתמש והצגת השם
        async function fetchAndSetUserProfile(currentUserId) {
            const { db, doc, getDoc, setDoc } = window.firebaseServices;
            const profileCollectionPath = `artifacts/${appId}/user-profiles`; // קולקציה גלובלית לפרופילים
            const profileRef = doc(db, profileCollectionPath, currentUserId);
            const nameDisplay = document.getElementById('user-display-name');
            const idDisplay = document.getElementById('user-id-display');
            const defaultName = currentUserId.startsWith('anon_') ? 'משתמש אנונימי' : 'DeliveryMaster Manager';

            idDisplay.textContent = currentUserId;

            try {
                const profileSnap = await getDoc(profileRef);

                if (profileSnap.exists()) {
                    // הפרופיל קיים - קוראים את השם
                    const profileData = profileSnap.data();
                    const displayName = profileData.displayName || defaultName;
                    nameDisplay.textContent = displayName;
                    SmartLog.info(`Loaded user profile: ${displayName}`, "Auth.Profile");
                    return displayName;

                } else {
                    // הפרופיל אינו קיים - יוצרים אותו עם שם ברירת מחדל
                    const newProfile = {
                        displayName: defaultName,
                        createdAt: serverTimestamp(),
                        lastLogin: serverTimestamp(),
                        isAnonymous: currentUserId.startsWith('anon_') 
                    };
                    await setDoc(profileRef, newProfile);
                    nameDisplay.textContent = defaultName;
                    SmartLog.info(`Created new user profile with default name: ${defaultName}`, "Auth.Profile");
                    return defaultName;
                }

            } catch (error) {
                SmartLog.error(error, "Auth.Profile.Error", { currentUserId });
                nameDisplay.textContent = `שגיאת טעינה (ID: ${currentUserId.substring(0, 4)}...)`;
                return defaultName;
            }
        }
        
        // ------------------------------------
        // --- 4. לוגיקת אימות (Authentication) ---
        // ------------------------------------

        async function initializeFirebase() {
             if (!db || !auth) {
                SmartLog.error("Firebase not initialized.", "Init");
                return;
             }

             // האזנה לשינויים בסטטוס האימות
             onAuthStateChanged(auth, async (user) => {
                 if (user) {
                     userId = user.uid;
                     SmartLog.info(`User Authenticated. UID: ${userId}`, "Auth");
                 } else {
                     // אם אין משתמש, יוצרים משתמש אנונימי כדי לקבל UID ולשמור נתונים פרטיים.
                     try {
                         await signInAnonymously(auth);
                         userId = auth.currentUser.uid; // זה יהיה UID קבוע עבור משתמש אנונימי זה
                         SmartLog.info(`Signed in Anonymously. UID: ${userId}`, "Auth");
                     } catch (error) {
                         SmartLog.error(error, "Auth.AnonSignIn");
                         userId = `anon_${crypto.randomUUID()}`; // fallback ID
                         document.getElementById('user-display-name').textContent = "כניסה נכשלה";
                         document.getElementById('user-id-display').textContent = userId;
                         return; // עצירה אם האימות נכשל
                     }
                 }
                 
                 // **שלב חדש: טעינת שם משתמש קבוע**
                 await fetchAndSetUserProfile(userId);

                 // הודעה על סיום תהליך האימות ומוכנות להפעלה
                 window.firebaseAuthReady = true;
                 document.dispatchEvent(new Event('firebaseAuthReady'));
             });


             // ניסיון התחברות עם Custom Token
             if (initialAuthToken && initialAuthToken.length > 0) {
                 try {
                     await signInWithCustomToken(auth, initialAuthToken);
                     SmartLog.info("Signed in with Custom Token", "Auth");
                 } catch (error) {
                     SmartLog.error(error, "Auth.CustomTokenSignIn");
                     showToast('שגיאת התחברות עם אסימון מותאם אישית. מתחבר כאנונימי.', 'error');
                 }
             } else {
                 // אם אין אסימון, ה-onAuthStateChanged יטפל בכניסה אנונימית
                 SmartLog.info("No Custom Token found, relying on onAuthStateChanged to sign in anonymously.", "Auth");
             }
         }

        // ------------------------------------
        // --- 5. לוגיקת לוח המחוונים (Dashboard) ---
        // ------------------------------------

        function initializeContainerDashboard() {
            // אם כבר יש מאזין, בטל אותו לפני יצירת חדש (למקרה של אתחול מחדש)
            if (unsubscribeContainerOrders) {
                unsubscribeContainerOrders();
                unsubscribeContainerOrders = null;
            }

            const collectionPath = getPrivateCollectionPath('container-orders');
            if (!collectionPath) return;

            // יצירת מאזין בזמן אמת (onSnapshot)
            const containerOrdersRef = window.firebaseServices.collection(window.firebaseServices.db, collectionPath);
            const q = window.firebaseServices.query(containerOrdersRef);

            // המאזין בזמן אמת - המנגנון ה"דינמי"
            unsubscribeContainerOrders = window.firebaseServices.onSnapshot(q, (querySnapshot) => {
                SmartLog.info("onSnapshot triggered. Rendering data...", "UI.Update");
                
                const orders = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    orders.push({ id: doc.id, ...data });
                });
                
                window.renderContainerCards(orders);
            }, (error) => {
                SmartLog.error(error, "Firestore.onSnapshot.Error");
                showToast('שגיאה בטעינת הנתונים בזמן אמת', 'error');
            });
            
            // פתיחת כפתור המפה
            document.getElementById('openMapModalButton').addEventListener('click', window.openMapModal);
            document.getElementById('openEcoDashboardButton').addEventListener('click', () => {
                // פותח את קובץ eco3.html בדפדפן
                window.location.href = 'eco3.html'; 
            });

            // הפעלת פילטור
            document.getElementById('search-input').addEventListener('input', applyFilters);
            document.getElementById('filter-status').addEventListener('change', applyFilters);
        }
        window.initializeContainerDashboard = initializeContainerDashboard;


        // פונקציות עזר לתצוגה
        function renderContainerCards(orders) {
            const grid = document.getElementById('container-orders-grid');
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) loadingIndicator.remove();
            
            if (orders.length === 0) {
                grid.innerHTML = '<div class="text-center text-gray-500 p-8 text-lg">אין הזמנות מכולות להצגה. הוסף אחת כדי להתחיל.</div>';
                return;
            }

            const html = orders.map(order => {
                const status = order.rentalStartDate && !order.returnDate ? 'on-site' : 
                               (order.returnDate ? 'returned' : 'booked');
                const statusText = status === 'on-site' ? 'באתר' : 
                                   (status === 'returned' ? 'הוחזר' : 'הוזמן');
                const statusClass = `status-${status}`;
                const notesSnippet = order.notes ? order.notes.substring(0, 50) + (order.notes.length > 50 ? '...' : '') : 'ללא הערות';
                const orderDateStr = order.orderDate ? new Date(order.orderDate).toLocaleDateString('he-IL') : 'לא ידוע';

                // חישוב ימי שכירות
                let rentalDaysHtml = '';
                if (order.rentalStartDate && status === 'on-site') {
                    const start = order.rentalStartDate.toDate();
                    const now = new Date();
                    const diffTime = Math.abs(now - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    rentalDaysHtml = `<p class="text-sm text-yellow-700 font-bold mt-1">ימי שכירות: ${diffDays}</p>`;
                } else if (order.rentalStartDate && order.returnDate) {
                    const start = order.rentalStartDate.toDate();
                    const end = order.returnDate.toDate();
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    rentalDaysHtml = `<p class="text-sm text-gray-500 mt-1">סה"כ ימים: ${diffDays}</p>`;
                }


                return `
                    <div class="data-row flex p-4 items-center justify-between transition duration-200 ease-in-out hover:shadow-xl hover:border-primary-500" 
                         data-status="${status}" 
                         data-search="${order.customerName} ${order.address} ${order.id}">
                        
                        <!-- פרטי הלקוח והזמנה -->
                        <div class="flex-1 min-w-0">
                            <h4 class="text-lg font-bold text-gray-900 truncate">${order.customerName}</h4>
                            <p class="text-sm text-gray-600 truncate flex items-center mt-1">
                                <i data-feather="map-pin" class="ml-1 h-4 w-4 text-primary-500"></i>
                                ${order.address}
                            </p>
                            <p class="text-xs text-gray-400 mt-1">ID: ${order.id.substring(0, 8)}...</p>
                        </div>

                        <!-- תאריכים וסוג משלוח -->
                        <div class="w-40 text-sm text-right px-4 hidden sm:block">
                            <p class="font-medium text-gray-700">תאריך/שעה: ${orderDateStr} (${order.orderTime || '?'})</p>
                            <p class="text-xs text-gray-500 mt-1">סוג: ${order.deliveryType === 'delivery' ? 'אספקה' : order.deliveryType === 'collection' ? 'איסוף' : 'החלפה'}</p>
                            ${rentalDaysHtml}
                        </div>

                        <!-- סטטוס והערות -->
                        <div class="w-56 text-right px-4 hidden md:block">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                            <p class="text-xs text-gray-500 mt-2 truncate" title="${order.notes || ''}">הערות: ${notesSnippet}</p>
                        </div>
                        
                        <!-- פעולות -->
                        <div class="flex space-x-2 space-x-reverse ml-4">
                            ${status !== 'returned' ? 
                                `<button onclick="window.handleSetRentalOnSite('${order.id}')" class="action-button bg-yellow-500 hover:bg-yellow-600 text-white" title="הגדר כבאתר/התחלת שכירות">
                                    <i data-feather="flag" class="h-5 w-5"></i>
                                </button>` 
                                : ''}

                            ${status === 'on-site' ? 
                                `<button onclick="window.openReturnModal('${order.id}', '${order.customerName}')" class="action-button action-return" title="הגדר כהוחזר">
                                    <i data-feather="check-circle" class="h-5 w-5"></i>
                                </button>` 
                                : ''}
                                
                            <button onclick="window.openContainerEditModal('${order.id}')" class="action-button action-edit" title="ערוך">
                                <i data-feather="edit" class="h-5 w-5"></i>
                            </button>
                            <button onclick="window.handleDeleteOrder('${order.id}', '${order.customerName}')" class="action-button action-delete" title="מחק">
                                <i data-feather="trash-2" class="h-5 w-5"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = html;
            feather.replace(); // רענון האייקונים
        }
        window.renderContainerCards = renderContainerCards;

        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            const filterStatus = document.getElementById('filter-status').value;
            const rows = document.querySelectorAll('.data-row');

            rows.forEach(row => {
                const searchText = row.getAttribute('data-search').toLowerCase();
                const status = row.getAttribute('data-status');
                
                const matchesSearch = searchText.includes(searchTerm);
                const matchesStatus = filterStatus === '' || status === filterStatus;
                
                row.style.display = (matchesSearch && matchesStatus) ? 'flex' : 'none';
            });
        }


        // ------------------------------------
        // --- 6. לוגיקת CRUD (יצירה, קריאה, עדכון, מחיקה) ---
        // ------------------------------------
        
        // --- יצירה (Add) ---
        async function handleAddContainerOrder(e) {
            e.preventDefault();
            const btn = e.submitter;
            btn.disabled = true;
            btn.innerText = 'שומר...';

            const form = e.target;
            const { db, addDoc, collection, serverTimestamp, Timestamp } = window.firebaseServices;
            const collectionPath = getPrivateCollectionPath('container-orders');
            if (!collectionPath) { btn.disabled = false; btn.innerText = 'שמור הזמנה'; return; }
            
            // המרה של תאריך ושעה לאובייקט Date
            const orderDateValue = document.getElementById('order-date').value;
            const orderTimeValue = document.getElementById('order-time').value;
            let orderDateTime;

            try {
                 const [year, month, day] = orderDateValue.split('-').map(Number);
                 const [hour, minute] = orderTimeValue.split(':').map(Number);
                 // שימו לב: חודש ב-JavaScript הוא 0-11
                 orderDateTime = new Date(year, month - 1, day, hour, minute);
            } catch (e) {
                 SmartLog.error(e, "CRUD.Container.Add", { orderDateValue, orderTimeValue });
                 showToast('פורמט תאריך/שעה לא תקין.', 'error');
                 btn.disabled = false; btn.innerText = 'שמור הזמנה';
                 return;
            }

            try {
                const newOrder = {
                    customerName: form.elements['customerName'].value.trim(),
                    address: form.elements['address'].value.trim(),
                    orderDate: orderDateValue, // שמירה כ-String לנוחות
                    orderTime: orderTimeValue, // שמירה כ-String לנוחות
                    deliveryType: form.elements['deliveryType'].value,
                    notes: form.elements['notes'].value.trim(),
                    createdAt: serverTimestamp(),
                    lastModified: serverTimestamp(),
                    rentalStartDate: null, // אין תאריך התחלה בעת יצירה
                    returnDate: null,
                    orderTimestamp: Timestamp.fromDate(orderDateTime) // שמירה כ-Timestamp למיון
                };

                const docRef = await addDoc(collection(db, collectionPath), newOrder);
                SmartLog.info("New container order added", "CRUD.Container.Add", { docId: docRef.id });
                showToast('הזמנת מכולה נוספה בהצלחה!', 'success');
                window.closeContainerAddModal();
                form.reset(); // איפוס הטופס

            } catch (error) {
                showToast(`שגיאה בהוספת הזמנה: ${error.message}`, 'error');
                SmartLog.error(error, "CRUD.Container.Add");
            } finally {
                btn.disabled = false;
                btn.innerText = 'שמור הזמנה';
            }
        }
        document.getElementById('container-add-form').addEventListener('submit', handleAddContainerOrder);


        // --- קריאה ואתחול מודל עריכה (Read/Setup Edit) ---
        async function openContainerEditModal(orderId) {
            const { db, doc, getDoc } = window.firebaseServices;
            const collectionPath = getPrivateCollectionPath('container-orders');
            if (!collectionPath) return;
            const orderRef = doc(db, collectionPath, orderId);

            try {
                const docSnap = await getDoc(orderRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // מילוי הנתונים במודל העריכה
                    document.getElementById('container-edit-order-id').value = orderId;
                    document.getElementById('container-edit-id-display').textContent = `(ID: ${orderId.substring(0, 8)}...)`;
                    document.getElementById('container-edit-customer-name-display').textContent = data.customerName;
                    document.getElementById('container-edit-address-display').textContent = data.address;
                    document.getElementById('container-edit-delivery-type').value = data.deliveryType || 'delivery';
                    document.getElementById('container-edit-order-date').value = data.orderDate || '';
                    document.getElementById('container-edit-order-time').value = data.orderTime || '';
                    document.getElementById('container-edit-notes').value = data.notes || '';
                    
                    // טיפול בתאריך התחלת שכירות
                    const rentalStartDateInput = document.getElementById('container-edit-rental-start-date');
                    if (data.rentalStartDate && typeof data.rentalStartDate.toDate === 'function') {
                         const date = data.rentalStartDate.toDate();
                         rentalStartDateInput.value = date.toISOString().split('T')[0];
                    } else {
                         rentalStartDateInput.value = '';
                    }

                    document.getElementById('container-edit-modal').classList.remove('hidden');

                } else {
                    showToast('הזמנה לא נמצאה', 'error');
                }
            } catch (error) {
                showToast(`שגיאה בטעינת נתוני הזמנה: ${error.message}`, 'error');
                SmartLog.error(error, "CRUD.Container.LoadEdit");
            }
        }
        window.openContainerEditModal = openContainerEditModal;

        // --- עדכון (Update) ---
        async function handleSaveContainerOrder(e) {
            e.preventDefault();
            const btn = document.getElementById('save-edit-button');
            btn.disabled = true;
            btn.innerText = 'שומר...';

            const { db, doc, updateDoc, serverTimestamp, Timestamp } = window.firebaseServices;
            const orderId = document.getElementById('container-edit-order-id').value;
            const collectionPath = getPrivateCollectionPath('container-orders');
            if (!collectionPath) { btn.disabled = false; btn.innerText = 'שמור שינויים'; return; }
            const orderRef = doc(db, collectionPath, orderId);

            const deliveryType = document.getElementById('container-edit-delivery-type').value;
            const orderDate = document.getElementById('container-edit-order-date').value;
            const orderTime = document.getElementById('container-edit-order-time').value;
            const rentalStartDateStr = document.getElementById('container-edit-rental-start-date').value;
            
            let rentalStartDate = null;
            let orderTimestamp;

             try {
                 // 1. עדכון Timestamp של תאריך ההזמנה
                 const [year, month, day] = orderDate.split('-').map(Number);
                 const [hour, minute] = orderTime.split(':').map(Number);
                 orderTimestamp = Timestamp.fromDate(new Date(year, month - 1, day, hour, minute));
            } catch(e) {
                 SmartLog.error(e, "CRUD.Container.Edit", { orderId, date: orderDate, time: orderTime });
                 showToast('שגיאה בהמרת תאריך/שעה להזמנה.', 'error');
                 btn.disabled = false; btn.innerText = 'שמור שינויים';
                 return;
            }

            if (rentalStartDateStr) {
                 // 2. עדכון Timestamp של תאריך תחילת שכירות
                 try {
                     const [year, month, day] = rentalStartDateStr.split('-').map(Number);
                     // משתמשים בשעת חצות של אותו יום כדי לקבוע את ההתחלה
                     rentalStartDate = Timestamp.fromDate(new Date(year, month - 1, day, 0, 0, 1)); 
                     SmartLog.info(`Setting rental start: ${rentalStartDateStr}`, "CRUD.Container.Edit");
                 } catch(e) {
                     SmartLog.error(e, "CRUD.Container.Edit", { orderId, rentalStartDateStr });
                     throw new Error("שגיאה בהמרת תאריך/שעה לתחילת שכירות.");
                 }
            }


            try {
                 const updatedData = {
                    deliveryType: deliveryType,
                    orderDate: orderDate,
                    orderTime: orderTime,
                    notes: document.getElementById('container-edit-notes').value.trim(),
                    rentalStartDate: rentalStartDate, // Update or clear the field
                    orderTimestamp: orderTimestamp,
                    lastModified: serverTimestamp()
                 };

                 await updateDoc(orderRef, updatedData);
                 SmartLog.info("Container order updated", "CRUD.Container.Edit", { orderId, changes: updatedData });
                 showToast('הזמנת מכולה עודכנה', 'success');
                 window.closeContainerEditModal();
                 // Listener will automatically refresh the container view if it's active

             } catch (error) {
                 showToast(`שגיאה בעדכון הזמנת מכולה: ${error.message}`, 'error');
                 SmartLog.error(error, "CRUD.Container.Edit", { orderId });
             } finally {
                 btn.disabled = false;
                 btn.innerText = 'שמור שינויים';
             }
         }
        document.getElementById('container-edit-form').addEventListener('submit', handleSaveContainerOrder);


        // --- מחיקה (Delete) ---
        async function handleDeleteOrder(orderId, customerName) {
            if (!window.showConfirmationModal) {
                 SmartLog.error("Missing confirmation modal function.", "CRUD.Container.Delete");
                 showToast('פונקציית אישור חסרה. לא ניתן לבצע מחיקה.', 'error');
                 return;
            }
            
            window.showConfirmationModal({
                title: 'אישור מחיקה',
                message: `האם אתה בטוח שברצונך למחוק לצמיתות את הזמנת המכולה של הלקוח: ${customerName}?`,
                confirmText: 'מחק',
                confirmClass: 'bg-red-600 hover:bg-red-700',
                onConfirm: async () => {
                    const { db, doc, deleteDoc } = window.firebaseServices;
                    const collectionPath = getPrivateCollectionPath('container-orders');
                    if (!collectionPath) return;
                    const orderRef = doc(db, collectionPath, orderId);

                    try {
                        await deleteDoc(orderRef);
                        SmartLog.info("Container order deleted", "CRUD.Container.Delete", { orderId });
                        showToast(`הזמנת מכולה עבור ${customerName} נמחקה`, 'success');
                    } catch (error) {
                        showToast(`שגיאה במחיקת הזמנה: ${error.message}`, 'error');
                        SmartLog.error(error, "CRUD.Container.Delete", { orderId });
                    }
                }
            });
        }
        window.handleDeleteOrder = handleDeleteOrder;

        // --- סטטוס "באתר" (התחלת שכירות) ---
        async function handleSetRentalOnSite(orderId) {
            if (!window.showConfirmationModal) {
                 showToast('פונקציית אישור חסרה. לא ניתן לעדכן סטטוס.', 'error');
                 return;
            }
            
            window.showConfirmationModal({
                title: 'אישור סטטוס "באתר"',
                message: `האם ברצונך לסמן את הזמנה ID: ${orderId.substring(0, 8)} כ"באתר" ולהתחיל את מניין ימי השכירות?`,
                confirmText: 'הגדר כבאתר',
                confirmClass: 'bg-yellow-500 hover:bg-yellow-600',
                onConfirm: async () => {
                    const { db, doc, updateDoc, serverTimestamp, Timestamp } = window.firebaseServices;
                    const collectionPath = getPrivateCollectionPath('container-orders');
                    if (!collectionPath) return;

                    try {
                         await updateDoc(doc(db, collectionPath, orderId), {
                             rentalStartDate: Timestamp.now(),
                             returnDate: null, // מוודא שאין תאריך החזרה אם מחזירים לאתר
                             lastModified: serverTimestamp()
                         });
                         showToast('סטטוס הוגדר ל"באתר". השכירות החלה.', 'success');
                    } catch (error) {
                         showToast(`שגיאה בהגדרת סטטוס: ${error.message}`, 'error');
                         SmartLog.error(error, "CRUD.Rental.OnSite", { orderId });
                    }
                }
            });
        }
        window.handleSetRentalOnSite = handleSetRentalOnSite;
        
        // --- סטטוס "הוחזר" (סיום שכירות) ---
        async function handleSetRentalReturn(orderId) {
            const { db, doc, updateDoc, serverTimestamp, Timestamp } = window.firebaseServices;
            const collectionPath = getPrivateCollectionPath('container-orders');
            if (!collectionPath) return;
            
            // מכיוון שזה מופעל ממודל ה-Return, אנחנו מניחים שהתאריך כבר נלקח משם
            const returnDateValue = document.getElementById('return-date-input').value;

            try {
                 // הוספת זמן כדי ש-Timestamp יהיה מדויק
                 const dateParts = returnDateValue.split('-');
                 const returnDate = Timestamp.fromDate(new Date(dateParts[0], dateParts[1] - 1, dateParts[2], 12, 0, 0)); // צהריים כדי למנוע בעיות אזור זמן

                 await updateDoc(doc(db, collectionPath, orderId), {
                     returnDate: returnDate,
                     // נשמור על rentalStartDate קיים אם יש
                     lastModified: serverTimestamp()
                 });
                 showToast('סטטוס שכירות הוגדר כ"הוחזר"', 'success');
                 window.closeReturnModal();
            } catch (error) {
                 showToast(`שגיאה בהגדרת סטטוס: ${error.message}`, 'error');
                 SmartLog.error(error, "CRUD.Rental.Return", { orderId, date: returnDateValue });
            }
        }
        window.handleSetRentalReturn = handleSetRentalReturn;


        // ------------------------------------
        // --- 7. לוגיקת ממשק משתמש (Modal Handlers) ---
        // ------------------------------------

        // פונקציית Modal כללית לאישור (במקום alert)
        function showConfirmationModal({ title, message, confirmText, confirmClass, onConfirm }) {
            let modal = document.getElementById('confirmation-modal');
            if (!modal) {
                // יצירת המודל אם הוא לא קיים
                modal = document.createElement('div');
                modal.id = 'confirmation-modal';
                modal.className = 'fixed inset-0 modal-overlay hidden flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
                        <h3 id="confirm-title" class="text-xl font-bold mb-4 text-gray-800"></h3>
                        <p id="confirm-message" class="text-gray-700 mb-6"></p>
                        <div class="flex justify-end space-x-3 space-x-reverse">
                            <button id="cancel-button" type="button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">ביטול</button>
                            <button id="confirm-button" type="button" class="px-4 py-2 text-white rounded-lg transition duration-150"></button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // עדכון תוכן המודל
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            
            const confirmBtn = document.getElementById('confirm-button');
            confirmBtn.textContent = confirmText;
            confirmBtn.className = `px-4 py-2 text-white rounded-lg transition duration-150 ${confirmClass}`;

            // הסרת מאזינים קודמים
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            const newCancelBtn = document.getElementById('cancel-button').cloneNode(true);
            document.getElementById('cancel-button').parentNode.replaceChild(newCancelBtn, document.getElementById('cancel-button'));


            // הגדרת מאזינים חדשים
            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                modal.classList.add('hidden');
            });
            newCancelBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });

            modal.classList.remove('hidden');
        }
        window.showConfirmationModal = showConfirmationModal;


        function openContainerAddModal() {
            document.getElementById('container-add-modal').classList.remove('hidden');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('order-date').value = today;
            document.getElementById('order-time').value = new Date().toTimeString().split(' ')[0].substring(0, 5);
        }
        window.openContainerAddModal = openContainerAddModal;
        
        function closeContainerAddModal() {
            document.getElementById('container-add-modal').classList.add('hidden');
        }
        window.closeContainerAddModal = closeContainerAddModal;

        function closeContainerEditModal() {
            document.getElementById('container-edit-modal').classList.add('hidden');
        }
        window.closeContainerEditModal = closeContainerEditModal;
        
        // --- מודל החזרה (Return Modal) ---
        function openReturnModal(orderId, customerName) {
            let modal = document.getElementById('return-modal');
            if (!modal) {
                // יצירת מודל החזרה אם לא קיים
                modal = document.createElement('div');
                modal.id = 'return-modal';
                modal.className = 'fixed inset-0 modal-overlay hidden flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">סיום שכירות (החזרה)</h3>
                        <p class="text-gray-700 mb-4">אישור החזרת מכולה עבור הלקוח: <strong id="return-customer-name"></strong>.</p>
                        <p class="text-gray-700 mb-4">אנא הזן את תאריך ההחזרה בפועל:</p>
                        <input type="date" id="return-date-input" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-500 focus:border-primary-500">
                        <input type="hidden" id="return-order-id">
                        <div class="mt-6 flex justify-end space-x-3 space-x-reverse">
                            <button type="button" id="return-cancel-button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">ביטול</button>
                            <button type="button" id="return-confirm-button" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150">אשר החזרה</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // הגדרת מאזינים למודל שנוצר
                document.getElementById('return-cancel-button').addEventListener('click', closeReturnModal);
                document.getElementById('return-confirm-button').addEventListener('click', () => {
                    const id = document.getElementById('return-order-id').value;
                    handleSetRentalReturn(id);
                });
            }

            // עדכון נתוני המודל
            document.getElementById('return-order-id').value = orderId;
            document.getElementById('return-customer-name').textContent = customerName;
            
            // הגדרת תאריך החזרה להיום כברירת מחדל
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('return-date-input').value = today;

            modal.classList.remove('hidden');
        }
        window.openReturnModal = openReturnModal;

        function closeReturnModal() {
            document.getElementById('return-modal').classList.add('hidden');
        }
        window.closeReturnModal = closeReturnModal;


        // --- לוגיקת מפה ---
        let mapInstance = null;
        function initializeMap(orders) {
            const mapElement = document.getElementById('map');
            if (!mapElement) return;

            // הסר את המפה הישנה אם קיימת
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
            }

            // פילטור הזמנות "באתר" עם כתובת (כדי להציג אותן על המפה)
            const activeOrders = orders.filter(o => o.rentalStartDate && !o.returnDate && o.address && o.address !== 'N/A');
            
            // נקודת מרכז כללית לישראל (כברירת מחדל)
            const defaultCenter = [31.77, 35.21]; 
            mapInstance = L.map('map').setView(defaultCenter, 8); // זום 8

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);
            
            // הצבת סמנים (Markers) - כרגע אנחנו רק מציגים את המפה ללא מיקום מדויק
            if (activeOrders.length > 0) {
                 activeOrders.forEach(order => {
                    // הערה: נדרש שירות geocoding חיצוני (לא זמין בקוד זה) כדי להמיר כתובות לקואורדינטות.
                    // ללא geocoding, נשתמש במיקום דמה או מרכז ברירת מחדל.
                    
                    // דוגמה להצבת סמן במיקום דמה:
                    const dummyLat = defaultCenter[0] + (Math.random() - 0.5) * 0.2; 
                    const dummyLon = defaultCenter[1] + (Math.random() - 0.5) * 0.2; 

                    L.marker([dummyLat, dummyLon])
                        .addTo(mapInstance)
                        .bindPopup(`<b>${order.customerName}</b><br>${order.address}<br>באתר מאז: ${order.rentalStartDate ? order.rentalStartDate.toDate().toLocaleDateString('he-IL') : '?'}`);
                 });
            }

            SmartLog.info("Map initialized (using dummy positions)", "Map.Init");
        }
        window.initializeMap = initializeMap;
        
        // פתיחת מודל המפה וטעינת נתונים
        function openMapModal() {
             document.getElementById('map-modal').classList.remove('hidden');
             // דחיית אתחול המפה עד שהמודל גלוי כדי להבטיח חישוב גודל נכון
             setTimeout(() => {
                 // כדי שהמפה תעבוד, אנחנו צריכים לקבל את הנתונים העדכניים
                 // מכיוון שיש לנו כבר מאזין (onSnapshot) ששומר את הנתונים, 
                 // נפעיל אותו על הנתונים האחרונים אם הם זמינים, או שנקרא שוב.
                 
                 // דרך פשוטה: נקרא שוב את הנתונים במיוחד למפה
                 const { db, collection, query, getDocs } = window.firebaseServices;
                 const collectionPath = getPrivateCollectionPath('container-orders');
                 if (!collectionPath) return;

                 getDocs(query(collection(db, collectionPath))).then(snapshot => {
                      const orders = [];
                      snapshot.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));
                      initializeMap(orders);
                 }).catch(error => {
                      SmartLog.error(error, "Map.DataLoad");
                      showToast('שגיאה בטעינת נתוני מפה', 'error');
                 });

             }, 100);
        }
        window.openMapModal = openMapModal;
        
        function closeMapModal() {
            document.getElementById('map-modal').classList.add('hidden');
            if (mapInstance) {
                // מחיקת המפה משחררת משאבים
                mapInstance.remove();
                mapInstance = null; 
            }
        }
        window.closeMapModal = closeMapModal;
        
        
        // --- התחלת האפליקציה ---
        if (window.firebaseConfig && Object.keys(window.firebaseConfig).length > 0) {
            initializeFirebase().then(() => {
                 if (window.firebaseAuthReady) {
                     initializeContainerDashboard();
                 }
            });
        } else {
             // טיפול בהרצה בסביבה ללא Config (פשוט משתמש ב-ID אנונימי גנרי)
             userId = `anon_${crypto.randomUUID()}`;
             document.getElementById('user-display-name').textContent = "דאשבורד מקומי";
             document.getElementById('user-id-display').textContent = userId;
             window.firebaseAuthReady = true;
             // הערה: במצב זה, Firestore לא יעבוד, אבל האפליקציה לא תקרוס.
             // נצטרך להסיר את קריאת הנתונים במקרה זה.
             document.getElementById('loading-indicator').textContent = 'Firebase לא מחובר - לא ניתן לטעון נתונים.';
        }


    </script>
</body>
</html>
