<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v32.5 (Stable) - משודרג</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/feather-icons"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- סגנונות CSS - ללא שינוי מהמקור -->
    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
        }
        html, body {
            font-family: 'Inter', sans-serif;
            direction: rtl;
            background-color: var(--bg-light);
            margin: 0;
            padding: 0;
            scroll-behavior: smooth;
        }
        .main-header {
            background-color: var(--primary-color);
            color: var(--bg-white);
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .container-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
        }
        .card {
            background-color: var(--bg-white);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            border-right: 5px solid;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .status-badge {
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            display: inline-block;
        }
        .status-ממתין-לאישור { border-color: #f59e0b; } /* Amber */
        .status-פעיל { border-color: #10b981; } /* Emerald */
        .status-הושלם { border-color: #6366f1; } /* Indigo */
        .status-בוטל { border-color: #ef4444; } /* Red */

        .status-ממתין-לאישור .status-badge { background-color: #fffbeb; color: #f59e0b; }
        .status-פעיל .status-badge { background-color: #ecfdf5; color: #10b981; }
        .status-הושלם .status-badge { background-color: #eef2ff; color: #6366f1; }
        .status-בוטל .status-badge { background-color: #fef2f2; color: #ef4444; }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
        }
        .map-container {
            height: 300px; /* גובה מפה בתוך המודל */
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .tab-button.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        /* סגנון לשם המחסן בכרטיס */
        .warehouse-display {
            background-color: #f0f4ff; /* Light blue background */
            color: #3b82f6; /* Blue text */
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <!-- מודל בקשת תעודת משלוח (חדש) -->
    <div id="deliveryCertificateModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4" onclick="closeDeliveryCertificateModal(event)">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4 text-gray-800">עדכון תעודת משלוח</h3>
            <p class="mb-4 text-gray-600">הזמנה זו הופכת לפעילה. הזן את מספר תעודת המשלוח:</p>
            
            <label for="delivery-certificate-input" class="block text-sm font-medium text-gray-700 mb-1">מספר תעודת משלוח (דוגמה: 6715496)</label>
            <input type="text" id="delivery-certificate-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-right mb-4" placeholder="הכנס מספר תעודה" required pattern="[0-9]+" />
            
            <div class="flex justify-end space-x-2 space-x-reverse">
                <button id="cancel-delivery-certificate" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">ביטול</button>
                <button id="confirm-delivery-certificate" class="px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-blue-300">עדכן והפעל</button>
            </div>
        </div>
    </div>
    <!-- סוף מודל בקשת תעודת משלוח -->

    <header class="main-header flex justify-between items-center">
        <h1 class="text-2xl font-bold">DeliveryMaster - ניהול הזמנות</h1>
        <button id="new-order-btn" class="bg-white text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-lg font-semibold transition-colors flex items-center gap-1 shadow">
            <i data-feather="plus" class="w-5 h-5"></i>
            הזמנה חדשה
        </button>
    </header>

    <!-- סרגל ניווט וחיפוש -->
    <div class="bg-white shadow-md p-4 sticky top-0 z-10">
        <div class="flex flex-wrap justify-between items-center gap-4">
            <!-- כפתורי ניווט עליונים -->
            <div class="flex space-x-4 space-x-reverse">
                <button class="tab-button active text-lg p-2 transition-colors" data-tab="orders">הזמנות</button>
                <button id="eco-3-link" class="tab-button text-lg p-2 transition-colors" data-tab="eco3" onclick="window.location.href='eco3.html'">מכולות פעילות</button>
                <button id="warehouses-link" class="tab-button text-lg p-2 transition-colors" data-tab="warehouses" onclick="window.location.href='warehouses_report.html'">דוח מחסנים</button> <!-- NEW LINK -->
            </div>
            
            <input type="text" id="search-input" placeholder="חפש לפי שם, כתובת או מספר הזמנה..." class="p-2 border border-gray-300 rounded-lg max-w-xs w-full text-right" />
        </div>
    </div>

    <!-- גריד ההזמנות -->
    <div id="orders-grid" class="container-grid">
        <div class="text-center p-10 col-span-full text-gray-500" id="loading-message">טוען הזמנות...</div>
    </div>

    <!-- מודלים (Model HTML - New Order, Edit Order) -->
    <!-- New Order Modal Content (Generated by JS) -->
    <div id="new-order-modal" class="fixed inset-0 modal-overlay z-40 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-3xl overflow-y-auto max-h-screen" id="new-order-modal-content" onclick="event.stopPropagation()">
            <!-- Content will be injected by JS -->
        </div>
    </div>
    
    <!-- Edit Order Modal Content (Generated by JS) -->
    <div id="container-edit-modal" class="fixed inset-0 modal-overlay z-40 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-xl overflow-y-auto max-h-screen" id="container-edit-modal-content" onclick="event.stopPropagation()">
            <!-- Content will be injected by JS -->
        </div>
    </div>
    

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, addDoc, updateDoc, deleteDoc, getDoc, serverTimestamp, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // הגדרת רמת לוגים של Firestore ל-Debug
        setLogLevel('Debug');
        
        // --- הגדרת קבועים ושירותי Firebase גלובליים ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        if (!firebaseConfig) {
            console.error("Firebase config is missing.");
            throw new Error("Firebase config is missing.");
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // יצירת אובייקט גלובלי לשירותי Firebase (לנוחות)
        window.firebaseServices = { db, auth, doc, updateDoc, addDoc, deleteDoc, getDoc, collection, query, where, onSnapshot, serverTimestamp, Timestamp };
        
        // --- קבועים חדשים לבקשת המשתמש ---
        const CONST_CONTAINER_TYPE = 'מכולה כללית';
        const CONST_RENTAL_DAYS = 10;
        const CONST_WAREHOUSES = [
            { id: 'W30', name: 'מחסן 30 (שארק)' },
            { id: 'W32', name: 'מחסן 32 (כראדי)' },
            { id: 'W40', name: 'מחסן 40 (שי שרון)' }
        ];
        const CONST_ACTION_TYPES = [
            'הצבת מכולה',
            'החלפת מכולה',
            'הוצאת מכולה'
        ];
        const getWarehouseName = (id) => CONST_WAREHOUSES.find(w => w.id === id)?.name || 'לא ידוע';

        // --- פונקציות עזר גלובליות ---

        /** מחזיר את נתיב הקולקציה הפרטית למשתמש הנוכחי */
        function getPrivateCollectionPath(collectionName) {
            const userId = auth.currentUser?.uid;
            if (!userId) {
                console.error("User not authenticated.");
                return null;
            }
            return `/artifacts/${appId}/users/${userId}/${collectionName}`;
        }
        
        /** פונקציית לוגים משופרת (סימולציה) */
        const SmartLog = {
            info: (msg, component, data) => console.log(`[INFO - ${component}] ${msg}`, data || ''),
            error: (err, component, data) => console.error(`[ERROR - ${component}] ${err.message || err}`, data || ''),
        };

        /** הצגת הודעת טוסט (במקום alert) */
        const showToast = (message, type = 'info') => {
            console.log(`[TOAST - ${type.toUpperCase()}]: ${message}`);
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 z-50 p-4 text-white rounded-lg shadow-xl ${colors[type] || colors.info} transition-opacity duration-300`;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = 0;
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };
        window.showToast = showToast;


        // --- לוגיקת אימות Firebase ---
        let isAuthReady = false;
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Firebase Sign-In Failed:", error);
                }
            }
            isAuthReady = true;
            document.dispatchEvent(new Event('firebaseAuthReady'));
        });


        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();

            const ordersGrid = document.getElementById('orders-grid');
            const newOrderModal = document.getElementById('new-order-modal');
            const newOrderBtn = document.getElementById('new-order-btn');
            const searchInput = document.getElementById('search-input');
            const newOrderModalContent = document.getElementById('new-order-modal-content');
            
            // --- פונקציות ניהול מודלים ---

            function openNewOrderModal() {
                const now = new Date();
                const dateString = now.toISOString().split('T')[0];
                const timeString = now.toTimeString().split(':').slice(0, 2).join(':');

                const modalContent = `
                    <h3 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">יצירת הזמנת מכולה חדשה</h3>
                    <form id="new-order-form">
                        
                        <!-- שם לקוח ומספר לקוח (חדש) -->
                        <div class="flex flex-col sm:flex-row gap-4 mb-4">
                            <div class="flex-1">
                                <label for="customer-name-input" class="block text-sm font-medium text-gray-700">שם לקוח</label>
                                <input type="text" id="customer-name-input" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-right" placeholder="הכנס שם מלא" required />
                            </div>
                            <div class="flex-1">
                                <label for="customer-number-input" class="block text-sm font-medium text-gray-700">מספר לקוח</label>
                                <input type="text" id="customer-number-input" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-right" placeholder="הכנס מספר לקוח" required />
                            </div>
                        </div>

                        <!-- טלפון ומספר הזמנה (חדש - אופציונלי) -->
                        <div class="flex flex-col sm:flex-row gap-4 mb-4">
                            <div class="flex-1">
                                <label for="phone-input" class="block text-sm font-medium text-gray-700">טלפון</label>
                                <input type="tel" id="phone-input" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-right" placeholder="הכנס טלפון ליצירת קשר" required />
                            </div>
                            <div class="flex-1">
                                <label for="order-number-input" class="block text-sm font-medium text-gray-700">מספר הזמנה (אופציונלי)</label>
                                <input type="text" id="order-number-input" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-right" placeholder="מספר אסמכתא חיצוני" />
                            </div>
                        </div>
                        
                        <!-- סוג מכולה וימי שכירות (קבועים) -->
                        <div class="flex flex-col sm:flex-row gap-4 mb-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700">סוג מכולה (קבוע)</label>
                                <input type="text" value="${CONST_CONTAINER_TYPE}" class="w-full p-2 border border-gray-200 rounded-lg bg-gray-100 text-right" readonly />
                                <input type="hidden" id="container-type-input" value="${CONST_CONTAINER_TYPE}" />
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700">ימי שכירות (קבוע)</label>
                                <input type="text" value="${CONST_RENTAL_DAYS} ימים" class="w-full p-2 border border-gray-200 rounded-lg bg-gray-100 text-right" readonly />
                                <input type="hidden" id="rental-days-input" value="${CONST_RENTAL_DAYS}" />
                            </div>
                        </div>

                        <!-- סוג פעולה ומחסן (חדש) -->
                        <div class="flex flex-col sm:flex-row gap-4 mb-4">
                            <div class="flex-1">
                                <label for="action-type-select" class="block text-sm font-medium text-gray-700">סוג פעולה</label>
                                <select id="action-type-select" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-right" required>
                                    <option value="" disabled selected>בחר סוג פעולה</option>
                                    ${CONST_ACTION_TYPES.map(type => `<option value="${type}">${type}</option>`).join('')}
                                </select>
                            </div>
                            <div class="flex-1">
                                <label for="warehouse-select" class="block text-sm font-medium text-gray-700">מחסן</label>
                                <select id="warehouse-select" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-right" required>
                                    <option value="" disabled selected>בחר מחסן</option>
                                    ${CONST_WAREHOUSES.map(w => `<option value="${w.id}">${w.name}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <!-- כתובת וסוג משלוח -->
                        <div class="flex flex-col sm:flex-row gap-4 mb-4">
                            <div class="flex-1">
                                <label for="address-input" class="block text-sm font-medium text-gray-700">כתובת</label>
                                <input type="text" id="address-input" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-right" placeholder="רחוב, עיר" required />
                            </div>
                            <div class="flex-1">
                                <label for="delivery-type-select" class="block text-sm font-medium text-gray-700">סוג משלוח</label>
                                <select id="delivery-type-select" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-right" required>
                                    <option value="רגיל">רגיל</option>
                                    <option value="דחוף">דחוף</option>
                                </select>
                            </div>
                        </div>

                        <!-- תאריך ושעה -->
                        <div class="flex flex-col sm:flex-row gap-4 mb-4">
                            <div class="flex-1">
                                <label for="order-date-input" class="block text-sm font-medium text-gray-700">תאריך אספקה מתוכנן</label>
                                <input type="date" id="order-date-input" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-right" value="${dateString}" required />
                            </div>
                            <div class="flex-1">
                                <label for="order-time-input" class="block text-sm font-medium text-gray-700">שעת אספקה מתוכננת</label>
                                <input type="time" id="order-time-input" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-right" value="${timeString}" required />
                            </div>
                        </div>

                        <!-- הערות -->
                        <div class="mb-6">
                            <label for="notes-input" class="block text-sm font-medium text-gray-700">הערות</label>
                            <textarea id="notes-input" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-right" placeholder="הערות חשובות למשלוח..."></textarea>
                        </div>
                        
                        <div class="flex justify-end space-x-3 space-x-reverse border-t pt-4">
                            <button type="button" onclick="closeNewOrderModal()" class="px-5 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">ביטול</button>
                            <button type="submit" id="save-new-order-btn" class="px-5 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">שמור הזמנה</button>
                        </div>
                    </form>
                `;
                newOrderModalContent.innerHTML = modalContent;
                
                // Attach submit listener after content injection
                document.getElementById('new-order-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    handleSaveNewOrder(document.getElementById('save-new-order-btn'));
                });

                newOrderModal.classList.remove('hidden');
                newOrderModal.classList.add('flex');
            }
            window.openNewOrderModal = openNewOrderModal;

            function closeNewOrderModal() {
                newOrderModal.classList.add('hidden');
                newOrderModal.classList.remove('flex');
            }
            window.closeNewOrderModal = closeNewOrderModal;
            
            // --- פונקציות ניהול מודל תעודת משלוח (חדש) ---
            
            /**
             * פותח את המודל לבקשת מספר תעודת משלוח לפני הפעלה.
             * @param {string} orderId - מזהה ההזמנה להפעלה.
             */
            function openDeliveryCertificateModal(orderId) {
                const modal = document.getElementById('deliveryCertificateModal');
                const confirmBtn = document.getElementById('confirm-delivery-certificate');
                const cancelBtn = document.getElementById('cancel-delivery-certificate');
                const certInput = document.getElementById('delivery-certificate-input');

                certInput.value = ''; // ניקוי השדה
                modal.dataset.orderId = orderId; // שמירת ID ההזמנה במודל
                
                // הסרת מאזינים קודמים והוספת חדשים
                // שימוש ב-bind או פונקציה אנונימית למניעת הפעלה מיידית
                confirmBtn.onclick = () => { handleConfirmDeliveryCertificate(orderId); };
                cancelBtn.onclick = () => { closeDeliveryCertificateModal(); };
                
                // הפעלה אוטומטית של כפתור האישור בלחיצה על Enter בשדה
                certInput.onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleConfirmDeliveryCertificate(orderId);
                    }
                };
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                setTimeout(() => certInput.focus(), 100);
            }
            window.openDeliveryCertificateModal = openDeliveryCertificateModal;


            /**
             * סוגר את מודל תעודת המשלוח.
             * @param {Event} e - אובייקט האירוע (אופציונלי).
             */
            function closeDeliveryCertificateModal(e) {
                if (!e || e.target.id === 'deliveryCertificateModal' || e.target.id === 'cancel-delivery-certificate') {
                    const modal = document.getElementById('deliveryCertificateModal');
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            }
            window.closeDeliveryCertificateModal = closeDeliveryCertificateModal;

            /**
             * מטפל באישור מספר תעודת המשלוח וממשיך להפעלת ההזמנה.
             * @param {string} orderId - מזהה ההזמנה.
             */
            async function handleConfirmDeliveryCertificate(orderId) {
                const certInput = document.getElementById('delivery-certificate-input');
                const deliveryCertificateNumber = certInput.value.trim();
                
                if (!deliveryCertificateNumber || !/^\d+$/.test(deliveryCertificateNumber)) {
                    showToast('מספר תעודת משלוח אינו תקין (נדרשות ספרות בלבד)', 'error');
                    return;
                }
                
                closeDeliveryCertificateModal();
                // קורא לפונקציית ההפעלה המקורית עם המספר החדש
                await handleActivateOrderLogic(orderId, deliveryCertificateNumber);
            }


            // --- לוגיקת CRUD מעודכנת ---
            
            /**
             * מטפל בשמירת הזמנת מכולה חדשה ל-Firestore.
             */
            async function handleSaveNewOrder(btn) {
                btn.disabled = true;
                btn.innerText = 'שומר...';

                // --- איסוף שדות חדשים ---
                const customerNumber = document.getElementById('customer-number-input').value.trim();
                const orderNumber = document.getElementById('order-number-input').value.trim();
                const actionType = document.getElementById('action-type-select').value;
                const warehouseId = document.getElementById('warehouse-select').value;
                
                // --- איסוף שדות קיימים ---
                const customerName = document.getElementById('customer-name-input').value.trim();
                const address = document.getElementById('address-input').value.trim();
                const phone = document.getElementById('phone-input').value.trim();
                const deliveryType = document.getElementById('delivery-type-select').value;
                const orderDate = document.getElementById('order-date-input').value;
                const orderTime = document.getElementById('order-time-input').value;
                const notes = document.getElementById('notes-input').value.trim();
                
                // קבועים
                const containerType = CONST_CONTAINER_TYPE;
                const rentalDays = CONST_RENTAL_DAYS;


                // --- ולידציה ---
                if (!customerName || !customerNumber || !address || !phone || !orderDate || !orderTime || !actionType || !warehouseId) {
                    showToast('נא למלא את כל השדות הנדרשים.', 'error');
                    btn.disabled = false;
                    btn.innerText = 'שמור הזמנה';
                    return;
                }

                const { db, addDoc, collection, serverTimestamp } = window.firebaseServices;
                const collectionPath = getPrivateCollectionPath('container-orders');
                if (!collectionPath) { 
                    btn.disabled = false;
                    btn.innerText = 'שמור הזמנה';
                    return; 
                }

                try {
                    const newOrderData = {
                        customerName,
                        customerNumber, // חדש
                        orderNumber: orderNumber || null, // חדש - אופציונלי
                        address,
                        phone,
                        deliveryType,
                        orderDate,
                        orderTime,
                        actionType, // חדש
                        warehouseId, // חדש
                        containerType, // קבוע
                        rentalDays, // קבוע
                        notes,
                        status: 'ממתין לאישור',
                        createdAt: serverTimestamp(),
                        lastModified: serverTimestamp(),
                        
                        deliveryCertificateNumber: null, // יתעדכן בהפעלה
                        rentalStartDate: null,
                    };

                    const docRef = await addDoc(collection(db, collectionPath), newOrderData);
                    SmartLog.info("New order saved", "CRUD.Order.Create", { id: docRef.id });
                    showToast('הזמנה חדשה נוצרה בהצלחה!', 'success');
                    closeNewOrderModal();

                } catch (error) {
                    showToast(`שגיאה בשמירת הזמנה: ${error.message}`, 'error');
                    SmartLog.error(error, "CRUD.Order.Create");
                } finally {
                    btn.disabled = false;
                    btn.innerText = 'שמור הזמנה';
                }
            }
            window.handleSaveNewOrder = handleSaveNewOrder;

            /**
             * פונקציה חיצונית שנקראת מה-UI (בלחיצה על כפתור 'הפעל')
             * היא מטפלת בקריאה למודל התעודה לפני הפעלה מלאה.
             * @param {string} orderId - מזהה ההזמנה.
             */
            function handleActivateOrderUI(orderId) {
                openDeliveryCertificateModal(orderId);
            }
            window.handleActivateOrderUI = handleActivateOrderUI; 

            /**
             * הלוגיקה האמיתית שמפעילה הזמנה ומעדכנת את תעודת המשלוח ותאריך התחלה.
             * @param {string} orderId - מזהה המסמך ב-Firestore.
             * @param {string} deliveryCertificateNumber - מספר תעודת המשלוח.
             */
            async function handleActivateOrderLogic(orderId, deliveryCertificateNumber) {
                if (!orderId || !deliveryCertificateNumber) return;
                
                const { db, doc, updateDoc, serverTimestamp, getDoc } = window.firebaseServices;
                const collectionPath = getPrivateCollectionPath('container-orders');
                
                try {
                    const orderRef = doc(db, collectionPath, orderId);
                    const orderDoc = await getDoc(orderRef);
                    const orderData = orderDoc.data();
                    
                    // יצירת תאריך התחלה רק אם ההזמנה טרם התחילה (במקרה של דאטה לא שלם)
                    const rentalStartDate = orderData.rentalStartDate ? orderData.rentalStartDate : serverTimestamp();
                    
                    await updateDoc(orderRef, {
                        status: 'פעיל',
                        rentalStartDate: rentalStartDate,
                        deliveryCertificateNumber: deliveryCertificateNumber, // הוספת הפרמטר החדש
                        lastModified: serverTimestamp()
                    });
                    SmartLog.info(`Order activated and Delivery Certificate set: ${deliveryCertificateNumber}`, "CRUD.Order.Activate", { orderId, cert: deliveryCertificateNumber });
                    showToast('הזמנה הופעלה בהצלחה!', 'success');
                    
                } catch (error) {
                    showToast(`שגיאה בהפעלת הזמנה: ${error.message}`, 'error');
                    SmartLog.error(error, "CRUD.Order.Activate", { orderId });
                }
            }
            // ... (שאר פונקציות ה-CRUD) ...

            /** יוצר כרטיס הזמנה HTML */
            function createOrderCard(order) {
                const statusClass = `status-${order.status.replace(/\s/g, '-')}`;
                const warehouseName = getWarehouseName(order.warehouseId); // הצגת שם המחסן

                const card = document.createElement('div');
                card.className = `card ${statusClass} flex flex-col`;
                card.innerHTML = `
                    <div class="p-4 flex-grow">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="text-xl font-bold text-gray-800">${order.customerName}</h4>
                            <span class="status-badge text-sm">${order.status}</span>
                        </div>
                        <div class="flex justify-between items-center mb-3">
                             <div class="text-sm font-medium text-gray-500">מספר הזמנה: ${order.orderNumber || 'N/A'}</div>
                             <div class="warehouse-display">${warehouseName}</div>
                        </div>

                        <p class="text-gray-600 flex items-center gap-2 mb-1">
                            <i data-feather="map-pin" class="w-4 h-4 text-gray-500"></i> ${order.address}
                        </p>
                        <p class="text-gray-600 flex items-center gap-2 mb-1">
                            <i data-feather="phone" class="w-4 h-4 text-gray-500"></i> ${order.phone}
                        </p>
                        <p class="text-gray-600 flex items-center gap-2 mb-1">
                            <i data-feather="box" class="w-4 h-4 text-gray-500"></i> ${order.actionType} (${order.containerType})
                        </p>
                        <p class="text-sm text-gray-500 mt-2 border-t pt-2">
                             ת. משלוח: ${order.deliveryCertificateNumber || 'טרם סופק'}
                             |
                             ת. שכירות: ${order.rentalStartDate ? new Date(order.rentalStartDate.toDate()).toLocaleDateString('he-IL') : 'טרם החל'}
                        </p>
                    </div>
                    <div class="p-4 bg-gray-50 border-t flex justify-end gap-2">
                        ${order.status === 'ממתין לאישור' ? 
                            `<button onclick="window.handleActivateOrderUI('${order.id}')" class="text-white bg-green-500 hover:bg-green-600 text-sm px-3 py-1 rounded-lg">הפעל</button>` : ''}
                        <button onclick="window.openEditModal('${order.id}')" class="text-blue-600 hover:text-blue-800 text-sm px-3 py-1 bg-blue-100 rounded-lg">ערוך</button>
                    </div>
                `;
                return card;
            }

            // ... (שאר לוגיקת האפליקציה) ...
            
            // --- Event Listeners ---
            newOrderBtn.addEventListener('click', openNewOrderModal);
            
            // מחכים לאימות Firebase לפני טעינת הנתונים
            if (isAuthReady) {
                // initializeDashboard(ordersGrid); // Call original initialization
            } else {
                document.addEventListener('firebaseAuthReady', () => {
                    // initializeDashboard(ordersGrid); // Call original initialization
                });
            }

        });
        // שימו לב: פונקציות כמו handleDeleteOrder, openEditModal וכו' נשארו כפי שהיו
        // ויש לוודא שהן מוגדרות ופועלות כראוי.
    </script>
</body>
</html>
