<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול מאוחדת - ח. סבן</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // --- הגדרות Firebase ---
        // הערה: את הערכים האמיתיים יש להחליף או לטעון ממשתני סביבה בבנייה אמיתית.
        // כאן נשתמש ב-Placeholders. המשתמש צריך להחליף אותם ידנית או דרך CI/CD.
        
        // טעינת הספריות מ-CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // TODO: החלף את הערכים האלו בקונפיגורציה האמיתית שלך
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // אתחול Firebase
        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Error initializing Firebase. Check config.", error);
            alert("שגיאה בחיבור ל-Firebase. נא לבדוק קונסול.");
        }

        // --- משתני מצב (State) ---
        let currentTab = 'clients'; // clients, team, management, messages

        // --- פונקציות עזר ל-UI ---
        
        // החלפת טאבים
        window.switchTab = (tabName) => {
            currentTab = tabName;
            
            // עדכון כפתורים
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.tab === tabName) {
                    btn.classList.add('bg-blue-600', 'text-white');
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                }
            });

            // עדכון תצוגה
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(`${tabName}-section`).classList.remove('hidden');

            // טעינת נתונים רלוונטיים
            if(tabName !== 'messages') {
                loadData(tabName);
            }
        };

        // --- לוגיקת מסד נתונים (CRUD) ---

        // הוספת נתונים
        window.addData = async (collectionName) => {
            const inputId = `${collectionName}-input`;
            const inputValue = document.getElementById(inputId).value;
            if (!inputValue.trim()) return;

            try {
                await addDoc(collection(db, collectionName), {
                    name: inputValue,
                    createdAt: serverTimestamp()
                });
                console.log(`Document added to ${collectionName}`);
                document.getElementById(inputId).value = ""; // ניקוי שדה
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("שגיאה בשמירה");
            }
        };

        // מחיקת נתונים
        window.deleteData = async (collectionName, id) => {
            if(!confirm("למחוק פריט זה?")) return;
            try {
                await deleteDoc(doc(db, collectionName, id));
                console.log(`Document ${id} deleted from ${collectionName}`);
            } catch (e) {
                console.error("Error deleting document: ", e);
            }
        };

        // האזנה לשינויים (Real-time Listener)
        const loadData = (collectionName) => {
            const listId = `${collectionName}-list`;
            const listElement = document.getElementById(listId);
            if(!listElement) return;

            // הסרת מאזינים קודמים אם יש (פשטות: כאן אנחנו יוצרים חדש כל פעם, באפליקציה גדולה צריך לנקות)
            const q = query(collection(db, collectionName), orderBy("createdAt", "desc"));
            
            onSnapshot(q, (snapshot) => {
                listElement.innerHTML = ""; // ניקוי הרשימה
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const item = document.createElement("div");
                    item.className = "flex justify-between items-center p-3 bg-white rounded shadow mb-2";
                    item.innerHTML = `
                        <span>${data.name || 'ללא שם'}</span>
                        <button onclick="deleteData('${collectionName}', '${doc.id}')" class="text-red-500 hover:bg-red-50 p-1 rounded">מחק</button>
                    `;
                    listElement.appendChild(item);
                });
            });
        };

        // --- לוגיקת צ'אט (Messages) ---
        
        window.sendMessage = async () => {
            const text = document.getElementById('chat-input').value;
            if (!text.trim()) return;

            try {
                await addDoc(collection(db, "messages"), {
                    text: text,
                    sender: "user", // במערכת אמיתית זה יהיה ID של המשתמש
                    createdAt: serverTimestamp()
                });
                document.getElementById('chat-input').value = "";
            } catch (e) {
                console.error("Error sending message: ", e);
            }
        };

        // טעינת הודעות
        const loadMessages = () => {
            const chatContainer = document.getElementById('chat-container');
            const q = query(collection(db, "messages"), orderBy("createdAt", "asc"));
            
            onSnapshot(q, (snapshot) => {
                chatContainer.innerHTML = "";
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const bubble = document.createElement("div");
                    bubble.className = "mb-2 p-2 rounded-lg max-w-[80%] " + (data.sender === 'user' ? "bg-green-100 mr-auto" : "bg-white ml-auto");
                    bubble.innerHTML = `
                        <p>${data.text}</p>
                        <a href="https://wa.me/?text=${encodeURIComponent(data.text)}" target="_blank" class="text-xs text-blue-500 block mt-1">Share to WhatsApp</a>
                    `;
                    chatContainer.appendChild(bubble);
                });
                // גלילה למטה
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        };

        // אתחול ראשוני
        window.addEventListener('DOMContentLoaded', () => {
            switchTab('clients'); // ברירת מחדל
            loadMessages(); // התחלת האזנה לצ'אט תמיד
        });

    </script>
</head>
<body class="bg-gray-100 font-sans text-gray-800 min-h-screen flex flex-col">

    <!-- כותרת ראשית -->
    <header class="bg-blue-700 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">Saban Unified System</h1>
            <div class="text-xs opacity-75">v1.0 (Gemini Build)</div>
        </div>
    </header>

    <!-- תפריט ניווט (Tabs) -->
    <nav class="bg-white shadow p-2 sticky top-0 z-10">
        <div class="container mx-auto flex justify-center gap-2">
            <button onclick="switchTab('clients')" data-tab="clients" class="nav-btn px-4 py-2 rounded-lg font-bold transition-colors bg-blue-600 text-white">לקוחות</button>
            <button onclick="switchTab('team')" data-tab="team" class="nav-btn px-4 py-2 rounded-lg font-bold transition-colors bg-gray-200 text-gray-700">צוות</button>
            <button onclick="switchTab('management')" data-tab="management" class="nav-btn px-4 py-2 rounded-lg font-bold transition-colors bg-gray-200 text-gray-700">ניהול</button>
            <button onclick="switchTab('messages')" data-tab="messages" class="nav-btn px-4 py-2 rounded-lg font-bold transition-colors bg-gray-200 text-gray-700">צ'אט</button>
        </div>
    </nav>

    <!-- תוכן ראשי -->
    <main class="container mx-auto p-4 flex-grow">

        <!-- 1. מסך לקוחות -->
        <section id="clients-section" class="content-section">
            <h2 class="text-xl font-bold mb-4 border-b pb-2 border-blue-200">ניהול לקוחות</h2>
            <div class="flex gap-2 mb-4">
                <input type="text" id="clients-input" placeholder="שם לקוח חדש..." class="flex-grow p-2 border rounded">
                <button onclick="addData('clients')" class="bg-green-600 text-white px-4 py-2 rounded font-bold">הוסף</button>
            </div>
            <div id="clients-list" class="space-y-2">
                <!-- רשימה דינמית -->
                <p class="text-gray-500 text-center mt-4">טוען נתונים...</p>
            </div>
        </section>

        <!-- 2. מסך צוות -->
        <section id="team-section" class="content-section hidden">
            <h2 class="text-xl font-bold mb-4 border-b pb-2 border-blue-200">ניהול צוות ונהגים</h2>
            <div class="flex gap-2 mb-4">
                <input type="text" id="team-input" placeholder="שם איש צוות..." class="flex-grow p-2 border rounded">
                <button onclick="addData('team')" class="bg-green-600 text-white px-4 py-2 rounded font-bold">הוסף</button>
            </div>
            <div id="team-list" class="space-y-2"></div>
        </section>

        <!-- 3. מסך ניהול -->
        <section id="management-section" class="content-section hidden">
            <h2 class="text-xl font-bold mb-4 border-b pb-2 border-blue-200">הנהלה ומשאבים</h2>
            <div class="flex gap-2 mb-4">
                <input type="text" id="management-input" placeholder="פריט ניהולי..." class="flex-grow p-2 border rounded">
                <button onclick="addData('management')" class="bg-green-600 text-white px-4 py-2 rounded font-bold">הוסף</button>
            </div>
            <div id="management-list" class="space-y-2"></div>
        </section>

        <!-- 4. מסך צ'אט (Messages) -->
        <section id="messages-section" class="content-section hidden h-[70vh] flex flex-col">
            <h2 class="text-xl font-bold mb-4 border-b pb-2 border-blue-200">ערוץ תקשורת</h2>
            
            <!-- אזור ההודעות -->
            <div id="chat-container" class="flex-grow bg-gray-200 rounded-lg p-4 overflow-y-auto mb-4 border border-gray-300">
                <p class="text-center text-gray-500">אין הודעות עדיין...</p>
            </div>

            <!-- אזור הקלדה -->
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="כתוב הודעה..." class="flex-grow p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                <button onclick="sendMessage()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-blue-700">שלח</button>
            </div>
        </section>

    </main>

    <footer class="bg-gray-800 text-white text-center p-2 text-xs mt-4">
        Saban Pro System &copy; 2025
    </footer>

</body>
</html>
