<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban Pro - מערכת מאוחדת</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ייבוא אייקונים של Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="module">
        // --- חיבור ל-Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, serverTimestamp, query, orderBy, where, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // TODO: החלף את זה ב-Config האמיתי שלך מהפרויקט saban94-78949
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // אתחול המערכת
        let app, db, auth;
        let currentUser = null;
        let currentRole = 'guest';

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase connected successfully");
        } catch (e) {
            console.error("Firebase init error:", e);
        }

        // --- ניהול מצב (State) ---
        const state = {
            currentTab: 'login', // login, admin, worker, customer
            users: [],
            products: [],
            orders: [],
            messages: []
        };

        // --- פונקציות עזר ---
        
        // בדיקת התחברות
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // בדיקת תפקיד במסד הנתונים (כמו ב-App.jsx שלך)
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    currentRole = userDoc.data().role || 'customer';
                    console.log("Logged in as:", currentRole);
                    switchTab(currentRole === 'admin' ? 'admin' : currentRole === 'worker' ? 'worker' : 'customer');
                } else {
                    currentRole = 'guest';
                    switchTab('guest_wait');
                }
            } else {
                currentUser = null;
                currentRole = 'guest';
                switchTab('login');
            }
        });

        window.login = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                alert("שגיאה בהתחברות: " + e.message);
            }
        };

        window.logout = () => {
            signOut(auth);
        };

        window.switchTab = (tabName) => {
            document.querySelectorAll('.page').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(`${tabName}-page`);
            if(target) target.classList.remove('hidden');
            
            // טעינת נתונים רלוונטיים לטאב
            if (tabName === 'admin') loadAdminData();
            if (tabName === 'worker') loadWorkerData();
            if (tabName === 'customer') loadCustomerData();
        };

        // --- נתוני אדמין ---
        const loadAdminData = () => {
            // טעינת משתמשים (כמו ב-AdminDashboard.jsx)
            onSnapshot(collection(db, "users"), (snap) => {
                const list = document.getElementById('admin-users-list');
                list.innerHTML = "";
                snap.forEach(doc => {
                    const u = doc.data();
                    list.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-white rounded shadow border-r-4 border-blue-500 mb-2">
                            <div>
                                <div class="font-bold">${u.name || 'ללא שם'}</div>
                                <div class="text-xs text-gray-500">${u.email} - <span class="font-bold">${u.role}</span></div>
                            </div>
                            <button onclick="updateRole('${doc.id}', 'customer')" class="text-xs bg-gray-200 px-2 py-1 rounded">הפוך ללקוח</button>
                        </div>`;
                });
            });

            // טעינת מוצרים (כמו ב-AdminDashboard.jsx)
            onSnapshot(collection(db, "products"), (snap) => {
                const list = document.getElementById('admin-products-list');
                list.innerHTML = "";
                snap.forEach(doc => {
                    const p = doc.data();
                    list.innerHTML += `
                        <div class="p-3 bg-white rounded shadow flex justify-between">
                            <span>${p.name}</span>
                            <span class="text-gray-500">${p.sku || '-'}</span>
                        </div>`;
                });
            });
        };

        // --- נתוני לקוח (צ'אט והזמנות) ---
        const loadCustomerData = () => {
            if (!currentUser) return;
            
            // טעינת צ'אט אישי (כמו ב-CustomerDashboard.jsx)
            const chatQuery = query(collection(db, `chats/${currentUser.uid}/messages`), orderBy("createdAt", "asc"));
            onSnapshot(chatQuery, (snap) => {
                const container = document.getElementById('customer-chat');
                container.innerHTML = "";
                snap.forEach(doc => {
                    const msg = doc.data();
                    const isMe = msg.sender === 'customer';
                    container.innerHTML += `
                        <div class="flex w-full ${isMe ? 'justify-end' : 'justify-start'} mb-2">
                            <div class="${isMe ? 'bg-green-100' : 'bg-white'} p-2 rounded-lg shadow max-w-[80%] text-sm">
                                ${msg.type === 'image' ? `<img src="${msg.url}" class="max-h-32 rounded">` : `<p>${msg.text}</p>`}
                                <div class="text-[10px] text-gray-400 text-left mt-1">${msg.createdAt ? new Date(msg.createdAt.seconds*1000).toLocaleTimeString() : '...'}</div>
                            </div>
                        </div>`;
                });
                container.scrollTop = container.scrollHeight;
            });

            // טעינת קטלוג להזמנה
            onSnapshot(collection(db, "products"), (snap) => {
                const grid = document.getElementById('customer-catalog');
                grid.innerHTML = "";
                snap.forEach(doc => {
                    const p = doc.data();
                    grid.innerHTML += `
                        <div class="bg-white p-2 rounded shadow text-center cursor-pointer hover:bg-blue-50" onclick="addToCart('${p.name}')">
                            <div class="font-bold">${p.name}</div>
                            <div class="text-xs text-gray-500">${p.specs || ''}</div>
                        </div>`;
                });
            });
        };

        // שליחת הודעה (כמו ב-CustomerDashboard)
        window.sendCustomerMessage = async () => {
            const input = document.getElementById('customer-msg-input');
            const text = input.value;
            if (!text.trim()) return;
            
            await addDoc(collection(db, `chats/${currentUser.uid}/messages`), {
                text: text,
                sender: 'customer',
                createdAt: serverTimestamp(),
                type: 'text',
                read: false
            });
            input.value = "";
            
            // עדכון זמן פעילות אחרון (חשוב לסנכרון עם הנציג)
            await updateDoc(doc(db, "users", currentUser.uid), { 
                lastActive: serverTimestamp(), 
                hasUnreadMessages: true 
            });
        };

        // הוספת מוצר לצ'אט (סימולציה של הזמנה)
        window.addToCart = async (productName) => {
            await addDoc(collection(db, `chats/${currentUser.uid}/messages`), {
                text: `מבקש להזמין: ${productName}`,
                sender: 'customer',
                type: 'order_request',
                createdAt: serverTimestamp(),
                read: false
            });
            await updateDoc(doc(db, "users", currentUser.uid), { 
                lastActive: serverTimestamp(), 
                hasUnreadMessages: true 
            });
        };

        // שיתוף ל-WhatsApp (הדרישה שלך)
        window.shareToWhatsapp = () => {
            const text = document.getElementById('customer-msg-input').value;
            if(text) window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        };

        // אתחול אייקונים
        window.addEventListener('load', () => {
            lucide.createIcons();
        });

    </script>
</head>
<body class="bg-gray-100 font-sans text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- מסך כניסה -->
    <div id="login-page" class="page flex h-full items-center justify-center bg-blue-50 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
            <h1 class="text-3xl font-bold text-blue-600 mb-6">Saban Pro</h1>
            <input id="email" type="email" placeholder="אימייל" class="w-full p-3 mb-3 border rounded-lg bg-gray-50" dir="ltr">
            <input id="password" type="password" placeholder="סיסמה" class="w-full p-3 mb-6 border rounded-lg bg-gray-50" dir="ltr">
            <button onclick="login()" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold shadow hover:bg-blue-700">כניסה</button>
        </div>
    </div>

    <!-- מסך המתנה -->
    <div id="guest_wait-page" class="page hidden h-full flex flex-col items-center justify-center p-10 text-center">
        <h2 class="text-2xl font-bold">ממתין לאישור</h2>
        <p class="text-gray-500">החשבון נוצר. המתן לאישור מנהל.</p>
        <button onclick="logout()" class="text-red-500 mt-4 font-bold">יציאה</button>
    </div>

    <!-- ממשק לקוח (Customer Dashboard) -->
    <div id="customer-page" class="page hidden h-full flex flex-col bg-[#efeae2]">
        <!-- Header -->
        <div class="bg-[#075e54] text-white p-3 flex justify-between items-center shadow-md sticky top-0 z-10">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-[#075e54] font-bold text-xs">ח.ס</div>
                <div>
                    <h3 class="font-bold text-sm">מחלקת הזמנות</h3>
                    <p class="text-[10px] opacity-80">מחובר כעת</p>
                </div>
            </div>
            <button onclick="logout()" class="text-xs bg-white/20 px-2 py-1 rounded">יציאה</button>
        </div>

        <!-- Chat Area -->
        <div id="customer-chat" class="flex-1 overflow-y-auto p-3 space-y-2 bg-[url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png')]">
            <!-- הודעות ייטענו כאן דינמית -->
        </div>

        <!-- Catalog Slider -->
        <div class="bg-gray-100 p-2 overflow-x-auto whitespace-nowrap border-t border-gray-200">
            <div id="customer-catalog" class="flex gap-2">
                <!-- מוצרים ייטענו כאן -->
            </div>
        </div>

        <!-- Input Area -->
        <div class="bg-white p-2 flex items-center gap-2 border-t pb-safe">
            <button onclick="shareToWhatsapp()" class="p-2 text-green-600"><i data-lucide="share-2"></i></button>
            <input id="customer-msg-input" type="text" placeholder="הקלד הודעה..." class="flex-1 bg-gray-100 p-2 rounded-full border-none outline-none text-sm">
            <button onclick="sendCustomerMessage()" class="p-2 bg-[#075e54] text-white rounded-full"><i data-lucide="send"></i></button>
        </div>
    </div>

    <!-- ממשק מנהל (Admin Dashboard) -->
    <div id="admin-page" class="page hidden h-full flex flex-col bg-gray-50">
        <header class="bg-white p-4 shadow flex justify-between items-center">
            <h1 class="font-bold text-blue-700">ממשק ניהול</h1>
            <button onclick="logout()" class="text-red-500 text-sm">יציאה</button>
        </header>
        <main class="p-4 overflow-y-auto flex-1">
            <h2 class="font-bold mb-2 text-gray-600">משתמשים</h2>
            <div id="admin-users-list" class="mb-6"></div>
            
            <h2 class="font-bold mb-2 text-gray-600">מוצרים בקטלוג</h2>
            <div id="admin-products-list" class="grid grid-cols-2 gap-2"></div>
        </main>
    </div>

    <!-- ממשק עובד/מוקד (Worker Dashboard) -->
    <div id="worker-page" class="page hidden h-full flex flex-col items-center justify-center bg-blue-50">
        <h1 class="text-2xl text-blue-800 font-bold">מוקד הזמנות פעיל</h1>
        <p class="text-gray-600">כאן תופיע רשימת הלקוחות והצ'אט (בפיתוח)</p>
        <button onclick="logout()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">יציאה</button>
    </div>

</body>
</html>
