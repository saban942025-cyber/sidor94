<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DeliveryMaster Viewer v52 (Nav Fix)</title>
    <!-- 
      DeliveryMaster Live Viewer App v52
      
      Changelog:
      - v52 (Nav Fix):
        - [תיקון קריטי] תוקנה לולאה אינסופית (Maximum call stack size exceeded) 
          במערכת הניווט.
        - הלוגיקה של הניווט רוכזה לפונקציה יחידה `Maps()`.
        - כפתורי הניווט התחתונים קוראים כעת ישירות ל-`Maps()`.
        - הוסרו קריאות `Maps()` כפולות מתוך פונקציות `show...Page()`.
      - v51 (Global Alerts):
        - נוספה מערכת התראות גלובלית (צפצוף + פופאפ)
        - המערכת מאזינה לקולקציית `globalAlerts` החדשה ב-Firestore.
        - נוסף כפתור "התראות" לסרגל הניווט התחתון.
        - נוסף דף "היסטוריית התראות" דינאמי (`#alert-history-view`).
    -->
    
    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="images/icons/icon-192x192.png">
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LeafletJS (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Google Font: Rubik -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
            --text-dark: #1f2937; /* gray-800 */
            --text-light: #6b7280; /* gray-500 */
        }
        
        /* [חדש] אנימציית הבהוב להתראות */
        @keyframes pulse-animation {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .pulse {
            animation: pulse-animation 1.5s infinite;
        }
        
        /* [חדש] סגנון לפופאפ התראה גלובלי */
        #global-alert-container {
            position: fixed;
            top: 5rem; /* מתחת לכותרת */
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            width: 90%;
            max-width: 400px;
        }
        .global-alert {
            background: rgba(239, 68, 68, 0.85); /* red-500 */
            backdrop-filter: blur(5px);
            color: #fff;
            padding: 1rem 1.25rem;
            border-radius: 0.75rem;
            font-weight: 600;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            animation: popIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .global-alert.alert-info {
            background: rgba(59, 130, 246, 0.85); /* blue-500 */
        }
        @keyframes popIn {
          from { transform: translateY(-20px) scale(0.9); opacity: 0; }
          to { transform: translateY(0) scale(1); opacity: 1; }
        }

        /* [חדש] סגנון לדף היסטוריית התראות */
        #alert-history-view .alert-item {
            background-color: var(--bg-white);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border-right: 4px solid var(--primary-color);
        }
        #alert-history-view .alert-item.type-order_modified {
            border-right-color: #f59e0b; /* amber-500 */
        }
        #alert-history-view .alert-item.type-broadcast {
            border-right-color: #ef4444; /* red-500 */
        }
        #alert-history-view .alert-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #alert-history-view .alert-item-title {
            font-weight: 600;
            color: var(--text-dark);
        }
        #alert-history-view .alert-item-time {
            font-size: 0.75rem;
            color: var(--text-light);
        }
        #alert-history-view .alert-item-body {
            font-size: 0.9rem;
            color: var(--text-dark);
            margin-top: 0.25rem;
        }

        /* --- סגנונות בסיס --- */
        html {
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            overscroll-behavior: none;
        }
        /* הסתרת סרגל גלילה */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- פריסה ראשית --- */
        .app-container {
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            height: -webkit-fill-available; /* עבור iOS Safari */
        }
        #main-header {
            background-color: var(--bg-white);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 10;
        }
        
        main {
            overflow-y: auto;
            position: relative;
        }
        
        /* --- סרגל ניווט תחתון --- */
        #bottom-nav {
            display: grid;
            grid-auto-flow: column;
            background-color: var(--bg-white);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -1px 3px rgba(0,0,0,0.05);
            z-index: 10;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            color: var(--text-light);
            font-size: 0.7rem;
            font-weight: 500;
            border-top: 3px solid transparent;
            transition: all 0.2s ease;
            position: relative; /* [v50.11] for badge */
        }
        .nav-button.active {
            color: var(--primary-color);
            border-top-color: var(--primary-color);
            background-color: #eff6ff; /* blue-50 */
        }
        /* [v50.11] Badge for messages */
        .message-badge {
            position: absolute;
            top: 6px;
            right: 20px;
            width: 10px;
            height: 10px;
            background-color: #ef4444; /* red-500 */
            border-radius: 50%;
            border: 2px solid var(--bg-white);
            display: none; /* יופעל ע"י JS */
        }
        .nav-button.has-unread .message-badge {
            display: block;
        }
        /* [v50.15] Flashing animation */
        .nav-button.flashing {
            animation: pulse-animation 1.5s infinite;
        }


        /* --- מסכי "דף מלא" --- */
        .full-page-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-light);
            z-index: 100;
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            overflow-y: auto;
        }
        .full-page-view.visible {
            transform: translateX(0);
        }
        .full-page-header {
            display: flex;
            align-items: center;
            padding: 1rem 1.25rem;
            background-color: var(--bg-white);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 5;
        }
        .full-page-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .full-page-content {
            padding: 1rem;
        }

        /* --- כרטיס הזמנה (ברשימות) --- */
        .order-card-list-item {
            background-color: var(--bg-white);
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px dashed var(--border-color);
        }
        .order-card-header h3 {
            font-weight: 700;
            font-size: 1.1rem;
        }
        .order-card-header .status {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 99px;
            color: white;
        }
        .status-חדש { background-color: #3b82f6; } /* blue-500 */
        .status-בטיפול { background-color: #f59e0b; } /* amber-500 */
        .status-שויך { background-color: #8b5cf6; } /* violet-500 */
        .status-בדרך { background-color: #10b981; } /* emerald-500 */
        .status-מתכונן-ליציאה { background-color: #f97316; } /* orange-500 */
        .status-הושלם { background-color: #6b7280; } /* gray-500 */
        .status-בוטל { background-color: #ef4444; } /* red-500 */
        
        .order-card-body {
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
        }
        .order-card-body .item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }
        .order-card-body .item svg {
            width: 16px;
            height: 16px;
            color: var(--text-light);
            margin-left: 0.5rem;
            flex-shrink: 0;
        }

        /* --- מפה (דשבורד) --- */
        #map-container {
            height: 100%;
            width: 100%;
            position: relative;
        }
        #map {
            height: 100%;
            width: 100%;
            background-color: #e0e0e0;
        }
        #map-loader {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            font-weight: 600;
        }
        /* [FIX] עיצוב פופאפ מפה */
        .leaflet-popup-content {
            font-family: 'Rubik', sans-serif;
            margin: 13px 20px !important;
        }
        .leaflet-popup-content h4 {
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        .leaflet-popup-content p {
            margin: 4px 0;
            color: var(--text-dark);
        }
        .leaflet-popup-content .status {
            font-weight: 600;
        }
        .leaflet-popup-content .chat-btn {
            width: 100%;
            text-align: center;
            padding: 8px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            margin-top: 10px;
            cursor: pointer;
            font-weight: 500;
        }
        .leaflet-popup-content .chat-btn:hover {
            background-color: var(--primary-dark);
        }


        /* --- דף הודעות (מודאל) --- */
        #chat-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 200;
            display: none; /* מוסתר כברירת מחדל */
        }
        .chat-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        .chat-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 85%;
            background-color: var(--bg-light);
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            display: grid;
            grid-template-rows: auto 1fr auto;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
        }
        #chat-modal.visible .chat-container {
            transform: translateY(0);
        }
        .chat-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .chat-modal-header h3 {
            font-weight: 600;
            font-size: 1.1rem;
        }
        #chat-message-list {
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
        }
        #chat-message-list-inner {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .msg-bubble {
            padding: 0.6rem 0.9rem;
            border-radius: 1rem;
            max-width: 80%;
            width: fit-content;
        }
        .msg-incoming {
            background-color: var(--bg-white);
            border-bottom-left-radius: 0.25rem;
            align-self: flex-start;
        }
        .msg-outgoing {
            background-color: #dbeafe; /* blue-100 */
            border-bottom-right-radius: 0.25rem;
            align-self: flex-end;
        }
        .msg-time {
            font-size: 0.65rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }
        #chat-reply-form {
            display: flex;
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-white);
            padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0));
        }
        #reply-input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 99px;
            background-color: var(--bg-light);
        }
        #reply-send-btn {
            border: none;
            background: none;
            padding: 0.5rem;
            margin-right: 0.5rem;
            color: var(--primary-color);
        }
    </style>
</head>
<body class="antialiased">

    <!-- [חדש] מארז להתראות קופצות -->
    <div id="global-alert-container"></div>

    <div class="app-container">
        <!-- כותרת ראשית -->
        <header id="main-header" class="flex justify-between items-center p-4">
            <div>
                <h1 class="text-xl font-bold text-gray-800">DeliveryMaster</h1>
                <p id="auth-status" class="text-xs text-gray-500">מתחבר...</p>
            </div>
            <div class="flex items-center space-x-2 space-x-reverse">
                <input type="text" id="viewer-search-input" onkeyup="filterViewerLists()" placeholder="חפש הזמנה..." class="px-3 py-2 border rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-300">
                <!-- <button class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="settings" class="w-5 h-5 text-gray-600"></i>
                </button> -->
            </div>
        </header>

        <!-- תוכן מרכזי (מפה או דפים) -->
        <main>
            <!-- מפה -->
            <div id="map-container">
                <div id="map"></div>
                <div id="map-loader" class="text-lg font-semibold">טוען מפה...</div>
            </div>

            <!-- דפים במסך מלא (מוסתרים כברירת מחדל) -->
            <div id="materials-page" class="full-page-view no-scrollbar">
                <div class="full-page-header">
                    <button onclick="hideFullPageView()" class="p-2 ml-2 rounded-full hover:bg-gray-100">
                        <i data-feather="arrow-right" class="w-6 h-6"></i>
                    </button>
                    <h2>רשימת חומרים</h2>
                </div>
                <div class="full-page-content">
                    <!-- תוכן יטען ע"י JS -->
                    <p>טוען רשימת חומרים...</p>
                </div>
            </div>
            
            <div id="containers-page" class="full-page-view no-scrollbar">
                <div class="full-page-header">
                    <button onclick="hideFullPageView()" class="p-2 ml-2 rounded-full hover:bg-gray-100">
                        <i data-feather="arrow-right" class="w-6 h-6"></i>
                    </button>
                    <h2>ניהול מכולות</h2>
                </div>
                <div class="full-page-content">
                    <p>טוען נתוני מכולות...</p>
                </div>
            </div>
            
            <div id="reports-page" class="full-page-view no-scrollbar">
                <div class="full-page-header">
                    <button onclick="hideFullPageView()" class="p-2 ml-2 rounded-full hover:bg-gray-100">
                        <i data-feather="arrow-right" class="w-6 h-6"></i>
                    </button>
                    <h2>דוחות וסיכומים</h2>
                </div>
                <div class="full-page-content">
                    <input type="date" id="report-date-input" class="w-full p-2 border rounded-md mb-4" onchange="renderReports()">
                    <div id="reports-content">
                        <p>טוען דוח...</p>
                    </div>
                </div>
            </div>

            <!-- [חדש] דף היסטוריית התראות -->
            <div id="alert-history-view" class="full-page-view no-scrollbar">
                <div class="full-page-header">
                    <button onclick="hideFullPageView()" class="p-2 ml-2 rounded-full hover:bg-gray-100">
                        <i data-feather="arrow-right" class="w-6 h-6"></i>
                    </button>
                    <h2>היסטוריית התראות</h2>
                </div>
                <div id="alert-history-content" class="full-page-content">
                    <!-- רשימת ההתראות תטען לכאן -->
                </div>
            </div>

            <!-- [שינוי] שמות ID של רשימות -->
            <div id="active-list-page" class="full-page-view no-scrollbar">
                <div class="full-page-header">
                    <button onclick="hideFullPageView()" class="p-2 ml-2 rounded-full hover:bg-gray-100">
                        <i data-feather="arrow-right" class="w-6 h-6"></i>
                    </button>
                    <h2>הזמנות פעילות</h2>
                </div>
                <div id="active-list-content" class="full-page-content"></div>
            </div>
            <div id="completed-today-list-page" class="full-page-view no-scrollbar">
                <div class="full-page-header">
                    <button onclick="hideFullPageView()" class="p-2 ml-2 rounded-full hover:bg-gray-100">
                        <i data-feather="arrow-right" class="w-6 h-6"></i>
                    </button>
                    <h2>הזמנות שהושלמו היום</h2>
                </div>
                <div id="completed-today-list-content" class="full-page-content"></div>
            </div>
            <div id="future-list-page" class="full-page-view no-scrollbar">
                <div class="full-page-header">
                    <button onclick="hideFullPageView()" class="p-2 ml-2 rounded-full hover:bg-gray-100">
                        <i data-feather="arrow-right" class="w-6 h-6"></i>
                    </button>
                    <h2>הזמנות עתידיות</h2>
                </div>
                <div id="future-list-content" class="full-page-content"></div>
            </div>
            
            <div id="messages-page" class="full-page-view no-scrollbar">
                <div class="full-page-header">
                    <button onclick="hideFullPageView()" class="p-2 ml-2 rounded-full hover:bg-gray-100">
                        <i data-feather="arrow-right" class="w-6 h-6"></i>
                    </button>
                    <h2>מרכז הודעות</h2>
                </div>
                <div id="messages-list-content" class="full-page-content">
                    <p>טוען שיחות...</p>
                </div>
            </div>
        </main>

        <!-- ניווט תחתון -->
        <nav id="bottom-nav">
            <!-- [תיקון v52] הקריאות שונו ל-navigate() -->
            <button id="nav-orders" class="nav-button active" onclick="navigate('orders')">
                <i data-feather="truck" class="w-6 h-6"></i>
                <span>הזמנות</span>
            </button>
            <button id="nav-materials" class="nav-button" onclick="navigate('materials')">
                <i data-feather="archive" class="w-6 h-6"></i>
                <span>חומרים</span>
            </button>
            <button id="nav-containers" class="nav-button" onclick="navigate('containers')">
                <i data-feather="box" class="w-6 h-6"></i>
                <span>מכולות</span>
            </button>
            <button id="nav-reports" class="nav-button" onclick="navigate('reports')">
                <i data-feather="bar-chart-2" class="w-6 h-6"></i>
                <span>דוחות</span>
            </button>
            <button id="nav-alerts" class="nav-button" onclick="navigate('alerts')">
                <i data-feather="bell" class="w-6 h-6"></i>
                <span>התראות</span>
                <span class="message-badge"></span>
            </button>
            <button id="nav-messages" class="nav-button" onclick="navigate('messages')">
                <i data-feather="message-circle" class="w-6 h-6"></i>
                <span>הודעות</span>
            </button>
        </nav>
    </div>
    
    <!-- מודאל צ'אט (מוסתר) -->
    <div id="chat-modal">
        <div class="chat-overlay" onclick="closeChatModal()"></div>
        <div class="chat-container">
            <header class="chat-modal-header">
                <h3 id="chat-modal-title">טוען...</h3>
                <button onclick="closeChatModal()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </header>
            <div id="chat-message-list" class="no-scrollbar">
                <div id="chat-message-list-inner">
                    <!-- הודעות יטענו לכאן -->
                </div>
            </div>
            <form id="chat-reply-form" onsubmit="sendAdminReply(event)">
                <input type="hidden" id="chat-order-id-input">
                <input type="text" id="reply-input" placeholder="הקלד הודעה..." autocomplete="off">
                <button type="submit" id="reply-send-btn">
                    <i data-feather="send" class="w-5 h-5"></i>
                </button>
            </form>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            query, 
            where, 
            orderBy, 
            limit, 
            Timestamp, 
            serverTimestamp,
            collectionGroup,
            writeBatch // [FIX v50.15]
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        // --- Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949",
          storageBucket: "saban94-78949.firebasestorage.app", 
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a", 
          measurementId: "G-XV6RZDESSB"
        };
        
        // --- Global Variables ---
        let db, auth;
        let map;
        let orderMarkers = {};
        let currentUserId = null;
        let unreadMessagesListener = null;
        let unreadAlertsListener = null;
        let activeOrdersListener = null;
        let activeOrders = [];
        let completedTodayOrders = [];
        let futureOrders = [];
        
        let alertHistory = [];
        let hasLoadedInitialAlerts = false;

        // --- Logger ---
        const SmartLog = {
            info(message, category = "General", context = {}) {
                console.log(`[INFO | ${category}]: ${message}`, context);
                // logToFirestore('info', message, category, context);
            },
            warn(message, category = "General", context = {}) {
                console.warn(`[WARN | ${category}]: ${message}`, context);
                // logToFirestore('warn', message, category, context);
            },
            error(error, category = "General", context = {}) {
                console.error(`[ERROR | ${category}]:`, error, context);
                // logToFirestore('error', error.message, category, { ...context, stack: error.stack });
            }
            // [FIX] Removed logToFirestore to prevent permission errors
        };
        window.SmartLog = SmartLog; // Expose SmartLog

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            initApp();
        });

        function initApp() {
            try {
                const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
                db = getFirestore(app);
                auth = getAuth(app);
                SmartLog.info("Firebase Initialized.", "App.Init", app);

                initMap();
                authenticateUser();
            } catch (e) {
                SmartLog.error(e, "App.InitFailed");
                document.getElementById('map-loader').innerText = 'שגיאת אתחול קריטית.';
            }
        }
        
        function initMap() {
            try {
                map = L.map('map', { zoomControl: false }).setView([32.15, 34.85], 10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);
                L.control.zoom({ position: 'bottomleft' }).addTo(map);
                document.getElementById('map-loader').style.display = 'none';
            } catch (e) {
                SmartLog.error(e, "App.MapInitFailed");
                document.getElementById('map-loader').innerText = 'שגיאה בטעינת המפה.';
            }
        }

        async function authenticateUser() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    document.getElementById('auth-status').innerText = `מחובר: ${user.uid.slice(0, 6)}...`;
                    SmartLog.info(`User Authenticated: ${user.uid}`, "Auth.Success");
                    
                    // Start all real-time data listeners
                    startAllListeners();
                    
                } else {
                    SmartLog.warn("No user. Attempting anonymous sign-in.", "Auth.Attempt");
                    document.getElementById('auth-status').innerText = 'מתחבר...';
                    signInAnonymously(auth).catch((error) => {
                        SmartLog.error(error, "Auth.AnonymousFailed");
                        document.getElementById('auth-status').innerText = 'שגיאת התחברות';
                    });
                }
            });
        }
        
        function startAllListeners() {
            listenForActiveOrders();
            listenToUnreadMessages();
            listenForGlobalAlerts();
        }

        // --- [חדש] Global Alert System ---
        function listenForGlobalAlerts() {
            if (unreadAlertsListener) unreadAlertsListener(); 

            const q = query(
                collection(db, "globalAlerts"), 
                orderBy("timestamp", "desc"), 
                limit(50) 
            );
            
            unreadAlertsListener = onSnapshot(q, (snapshot) => {
                SmartLog.info("GlobalAlerts snapshot received", "Data.Alerts", { size: snapshot.size });
                alertHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (document.getElementById('alert-history-view').classList.contains('visible')) {
                    renderAlertHistory();
                }

                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added" && hasLoadedInitialAlerts) {
                        const alertData = change.doc.data();
                        playAlert(alertData.title || "התראה חדשה", alertData.type);
                        
                        const navButton = document.getElementById('nav-alerts');
                        if (navButton) {
                            navButton.classList.add('flashing');
                            setTimeout(() => navButton.classList.remove('flashing'), 3000); 
                        }
                    }
                });

                if (!hasLoadedInitialAlerts) {
                    hasLoadedInitialAlerts = true;
                    SmartLog.info("Initial alert snapshot loaded. Ready for real-time alerts.", "Data.Alerts");
                }

            }, (error) => {
                SmartLog.error(error, "Data.Alerts.ListenFailed");
            });
        }
        
        function playAlert(message, type = "info") {
            SmartLog.info(`Playing Alert: ${message}`, "UI.Alert");
            
            try {
                const soundUrl = (type === "broadcast")
                    ? "https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" 
                    : "https://actions.google.com/sounds/v1/alarms/beep_short.ogg";
                const audio = new Audio(soundUrl);
                audio.play();
            } catch (e) {
                SmartLog.warn("Audio playback failed.", "UI.Alert", { error: e.message });
            }

            const container = document.getElementById("global-alert-container");
            const alertBox = document.createElement("div");
            alertBox.className = `global-alert ${type === 'broadcast' ? 'alert-broadcast' : 'alert-info'}`;
            
            const icon = (type === "broadcast") ? "volume-2" : "info";
            alertBox.innerHTML = `<i data-feather="${icon}" class="w-5 h-5"></i><span>${message}</span>`;
            
            container.appendChild(alertBox);
            feather.replace();
            
            setTimeout(() => {
                alertBox.style.opacity = '0';
                alertBox.style.transform = 'translateX(100%)';
                setTimeout(() => alertBox.remove(), 300);
            }, 4000);
        }

        // --- Data Listeners (Orders & Messages) ---
        function listenForActiveOrders() {
            if (activeOrdersListener) activeOrdersListener();
            
            const todayStr = new Date().toISOString().split('T')[0];
            const q = query(collection(db, 'orders'), where('orderDate', '>=', todayStr));
            
            activeOrdersListener = onSnapshot(q, (snapshot) => {
                SmartLog.info(`Active/Future orders snapshot received`, "Data.Orders", { size: snapshot.size });
                activeOrders = [];
                completedTodayOrders = [];
                futureOrders = [];
                
                snapshot.forEach(doc => {
                    const order = { id: doc.id, ...doc.data() };
                    const status = order.status || 'חדש';
                    
                    if (status === 'הושלם' || status === 'בוטל') {
                        if (order.orderDate === todayStr) {
                            completedTodayOrders.push(order);
                        }
                    } else if (order.orderDate > todayStr) {
                        futureOrders.push(order);
                    } else {
                        activeOrders.push(order);
                    }
                });
                
                const sortByTime = (a, b) => (a.orderTime || '00:00').localeCompare(b.orderTime || '00:00');
                activeOrders.sort(sortByTime);
                completedTodayOrders.sort(sortByTime);
                futureOrders.sort((a, b) => a.orderDate.localeCompare(b.orderDate) || sortByTime(a, b));

                renderMapMarkers();
                updateActiveLists();
                
            }, (error) => {
                SmartLog.error(error, "Data.Orders.ListenFailed");
            });
        }
        
        function listenToUnreadMessages() {
            if (unreadMessagesListener) unreadMessagesListener();
            
            const q = query(
                collectionGroup(db, 'messages'), 
                where('isUnread', '==', true),
                where('sender', '==', 'customer')
            );
            
            unreadMessagesListener = onSnapshot(q, (snapshot) => {
                const navButton = document.getElementById('nav-messages');
                if (!navButton) return;
                
                if (snapshot.empty) {
                    navButton.classList.remove('has-unread');
                    navButton.classList.remove('flashing');
                } else {
                    SmartLog.info(`Unread messages detected: ${snapshot.size}`, "Data.Messages");
                    navButton.classList.add('has-unread');
                    
                    const isNewMessage = snapshot.docChanges().some(change => change.type === 'added');
                    if (isNewMessage && hasLoadedInitialAlerts) { 
                        navButton.classList.add('flashing');
                        playAlert("הודעה חדשה מלקוח", "info");
                        setTimeout(() => navButton.classList.remove('flashing'), 3000);
                    }
                }
            }, (error) => {
                SmartLog.error(error, "Data.Messages.ListenFailed");
            });
        }

        // --- Map Rendering ---
        function renderMapMarkers() {
            if (!map) return;
            
            Object.values(orderMarkers).forEach(marker => marker.remove());
            orderMarkers = {};
            
            const bounds = L.latLngBounds();
            
            activeOrders.forEach(order => {
                if (order.latitude && order.longitude) {
                    const latLng = [order.latitude, order.longitude];
                    const icon = createMarkerIcon(order.status);
                    
                    const marker = L.marker(latLng, { icon: icon })
                        .addTo(map)
                        .bindPopup(createPopupContent(order));
                    
                    marker.on('click', () => focusViewerMapItem(order.id));
                    orderMarkers[order.id] = marker;
                    bounds.extend(latLng);
                }
            });
            
            if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 });
            } else {
                map.setView([32.15, 34.85], 10);
            }
        }
        
        function createMarkerIcon(status) {
            const colors = {
                'חדש': '#3b82f6',
                'בטיפול': '#f59e0b',
                'שויך': '#8b5cf6',
                'בדרך': '#10b981',
                'מתכונן-ליציאה': '#f97316'
            };
            const color = colors[status] || '#6b7280';
            
            const svgIcon = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${color}" width="32px" height="32px">
                  <path d="M12 0c-4.418 0-8 3.582-8 8 0 6 8 16 8 16s8-10 8-16c0-4.418-3.582-8-8-8zm0 12c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/>
                  <circle cx="12" cy="8" r="3" fill="white"/>
                </svg>
            `;
            return L.divIcon({
                html: svgIcon,
                className: '',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
        }
        
        function createPopupContent(order) {
            const displayId = order.orderNumber || order.order_id || order.id.slice(0,6);
            return `
                <h4>הזמנה: ${displayId}</h4>
                <p><strong>לקוח:</strong> ${order.customer?.name || 'N/A'}</p>
                <p><strong>כתובת:</strong> ${order.address}</p>
                <p><strong>סטטוס:</strong> <span class="status status-${order.status}">${order.status}</span></p>
                <div class="chat-btn" onclick="openChatModal('${order.id}', '${displayId}')">
                    פתח צ'אט
                </div>
            `;
        }
        
        function focusViewerMapItem(orderId) {
            const marker = orderMarkers[orderId];
            if (marker) {
                map.setView(marker.getLatLng(), 16);
                marker.openPopup();
            }
        }
        window.focusViewerMapItem = focusViewerMapItem;


        // --- Page Navigation & Rendering ---
        
        // [תיקון v52] פונקציית ניווט מרכזית
        function navigate(pageId) {
            SmartLog.info(`Navigating to: ${pageId}`, "UI.Navigate");
            
            // 1. עדכון כפתורים
            document.querySelectorAll('#bottom-nav .nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            const navBtn = document.getElementById(`nav-${pageId}`);
            if (navBtn) navBtn.classList.add('active');

            // 2. הסתרת כל הדפים
            document.querySelectorAll('.full-page-view').forEach(page => {
                page.classList.remove('visible');
            });
            
            // 3. הצגת הדף הנכון
            if (pageId === 'orders') {
                // 'orders' הוא דף הבית (מפה), לכן אנחנו פשוט מסתירים את כל הדפים
                hideFullPageView(); 
            } else if (pageId === 'materials') {
                showMaterialsPage();
            } else if (pageId === 'containers') {
                showContainersPage();
            } else if (pageId === 'reports') {
                showReportsPage();
            } else if (pageId === 'messages') {
                showMessagesPage();
            } else if (pageId === 'alerts') {
                showAlertHistoryPage();
            }
        }
        window.navigate = navigate; // חשיפה גלובלית

        function showFullPageView(pageId) {
            const page = document.getElementById(pageId);
            if (page) {
                page.classList.add('visible');
            }
        }
        
        function hideFullPageView() {
            document.querySelectorAll('.full-page-view').forEach(page => {
                page.classList.remove('visible');
            });
            // הפעלת כפתור 'הזמנות' (מפה) כברירת מחדל
            document.querySelectorAll('#bottom-nav .nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            const mapBtn = document.getElementById('nav-orders'); 
            if(mapBtn) mapBtn.classList.add('active');
        }
        window.hideFullPageView = hideFullPageView;

        function updateActiveLists() {
            renderOrderListToPage('active-list-content', activeOrders);
            renderOrderListToPage('completed-today-list-content', completedTodayOrders);
            renderOrderListToPage('future-list-content', futureOrders);
        }

        // --- Specific Page Loaders ---
        function showActiveListPage() {
            updateActiveLists();
            showFullPageView('active-list-page');
            // [תיקון v52] הסרת קריאה ל-navigate
        }
        // [תיקון v52] חשיפה גלובלית
        window.showActiveListPage = showActiveListPage;
        
        function showCompletedTodayListPage() {
            updateActiveLists();
            showFullPageView('completed-today-list-page');
        }
        window.showCompletedTodayListPage = showCompletedTodayListPage;
        
        function showFutureListPage() {
            updateActiveLists();
            showFullPageView('future-list-page');
        }
        window.showFutureListPage = showFutureListPage;
        
        function showMaterialsPage() {
            document.getElementById('materials-page').querySelector('.full-page-content').innerHTML = `
                <p>רשימת חומרים (בבנייה)...</p>
                <button onclick="createTestMessage('TtPodHFNmlplOuP4xbMe')" class="p-2 bg-blue-500 text-white rounded">צור הודעת בדיקה (לדמו)</button>
            `;
            showFullPageView('materials-page');
            // [תיקון v52] הסרת קריאה ל-navigate
        }
        window.showMaterialsPage = showMaterialsPage;
        
        function showContainersPage() {
            document.getElementById('containers-page').querySelector('.full-page-content').innerHTML = "<p>ניהול מכולות (בבנייה)...</p>";
            showFullPageView('containers-page');
            // [תיקון v52] הסרת קריאה ל-navigate
        }
        window.showContainersPage = showContainersPage;

        function showReportsPage() {
            document.getElementById('report-date-input').value = new Date().toISOString().split('T')[0];
            renderReports();
            showFullPageView('reports-page');
            // [תיקון v52] הסרת קריאה ל-navigate
        }
        window.showReportsPage = showReportsPage;
        
        async function showMessagesPage() {
            const contentEl = document.getElementById('messages-list-content');
            contentEl.innerHTML = "<p>טוען שיחות...</p>";
            showFullPageView('messages-page');
            // [תיקון v52] הסרת קריאה ל-navigate
            
            try {
                const q = query(
                    collectionGroup(db, 'messages'), 
                    orderBy('timestamp', 'desc'),
                    limit(100)
                );
                const snapshot = await getDocs(q);
                
                const conversations = new Map();
                snapshot.docs.forEach(doc => {
                    const msg = doc.data();
                    const orderId = doc.ref.parent.parent.id;
                    if (!conversations.has(orderId)) {
                        conversations.set(orderId, {
                            orderId: orderId,
                            customerName: msg.customerName || 'לא ידוע',
                            lastMessage: msg.text,
                            lastTimestamp: msg.timestamp,
                            isUnread: msg.isUnread && msg.sender === 'customer'
                        });
                    }
                });

                const sortedConversations = Array.from(conversations.values())
                    .sort((a, b) => b.lastTimestamp.toMillis() - a.lastTimestamp.toMillis());

                if (sortedConversations.length === 0) {
                    contentEl.innerHTML = "<p>לא נמצאו שיחות.</p>";
                    return;
                }

                contentEl.innerHTML = sortedConversations.map(convo => `
                    <div class="order-card-list-item" onclick="openChatModal('${convo.orderId}', '${convo.orderId.slice(0,6)}')">
                        <div class="order-card-header">
                            <h3>${convo.customerName}</h3>
                            ${convo.isUnread ? '<span class="status status-חדש">חדשה</span>' : ''}
                        </div>
                        <div class="order-card-body">
                            <p class="truncate">${convo.lastMessage}</p>
                            <p class="text-xs text-gray-500 mt-1">${convo.lastTimestamp.toDate().toLocaleString('he-IL')}</p>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                SmartLog.error(error, "UI.MessagesPage.LoadFailed");
                contentEl.innerHTML = "<p class=\"text-red-500\">שגיאה בטעינת השיחות.</p>";
            }
        }
        window.showMessagesPage = showMessagesPage;
        
        function showAlertHistoryPage() {
            renderAlertHistory();
            showFullPageView('alert-history-view');
            // [תיקון v52] הסרת קריאה ל-navigate
            
            const navButton = document.getElementById('nav-alerts');
            if (navButton) navButton.classList.remove('flashing');
        }
        window.showAlertHistoryPage = showAlertHistoryPage;

        // --- Render Functions ---
        
        function renderAlertHistory() {
            const contentEl = document.getElementById('alert-history-content');
            if (!contentEl) return;
            
            if (alertHistory.length === 0) {
                contentEl.innerHTML = "<p>אין התראות בהיסטוריה.</p>";
                return;
            }

            contentEl.innerHTML = alertHistory.map(alert => {
                const alertData = alert.timestamp ? alert.timestamp.toDate() : new Date();
                const time = alertData.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
                const date = alertData.toLocaleDateString('he-IL');
                
                return `
                <div class="alert-item type-${alert.type || 'info'}">
                    <div class="alert-item-header">
                        <span class="alert-item-title">${alert.title || 'התראה'}</span>
                        <span class="alert-item-time">${date} ${time}</span>
                    </div>
                    <p class="alert-item-body">${alert.message || '...'}</p>
                </div>
                `;
            }).join('');
        }

        function renderReports() {
            const contentEl = document.getElementById('reports-content');
            contentEl.innerHTML = "";
            
            const completedCount = completedTodayOrders.length;
            const activeCount = activeOrders.length;
            
            contentEl.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-lg shadow text-center">
                        <h3 class="text-3xl font-bold text-green-500">${completedCount}</h3>
                        <p class="text-sm font-medium text-gray-500">הושלמו היום</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow text-center">
                        <h3 class="text-3xl font-bold text-blue-500">${activeCount}</h3>
                        <p class="text-sm font-medium text-gray-500">הזמנות פעילות</p>
                    </div>
                </div>
                
                <h3 class="font-semibold text-lg mt-6 mb-2">פירוט הזמנות שהושלמו</h3>
                <div id="report-completed-list"></div>
            `;
            
            renderOrderListToPage('report-completed-list', completedTodayOrders);
        }
        window.renderReports = renderReports;
        
        function renderOrderListToPage(elementId, orders) {
            const contentEl = document.getElementById(elementId);
            if (!contentEl) return;
            
            if (orders.length === 0) {
                contentEl.innerHTML = "<p class='text-gray-500 text-center p-4'>לא נמצאו הזמנות.</p>";
                return;
            }
            
            contentEl.innerHTML = orders.map(order => createOrderCardHTML(order)).join('');
            feather.replace();
        }

        function createOrderCardHTML(order) {
            const displayId = order.orderNumber || order.order_id || order.id.slice(0,6);
            
            let deliveryIcon = "truck";
            let deliveryType = order.deliveryType || "משאית";
            if (deliveryType.includes("מנוף")) deliveryIcon = "package";
            if (deliveryType.includes("מכולה")) deliveryIcon = "box";
            if (deliveryType.includes("איסוף")) deliveryIcon = "user";
            
            return `
            <div class="order-card-list-item">
                <div class="order-card-header" onclick="focusViewerMapItem('${order.id}'); hideFullPageView();">
                    <h3>${order.customer?.name || 'N/A'}</h3>
                    <span class="status status-${order.status}">${order.status}</span>
                </div>
                <div class="order-card-body">
                    <div class="item">
                        <i data-feather="hash" class="w-4 h-4"></i>
                        <span>${displayId}</span>
                    </div>
                    <div class="item">
                        <i data-feather="map-pin" class="w-4 h-4"></i>
                        <span>${order.address || 'N/A'}</span>
                    </div>
                    <div class="item">
                        <i data-feather="clock" class="w-4 h-4"></i>
                        <span>${order.orderDate} | ${order.orderTime || 'לא צוינה שעה'}</span>
                    </div>
                    <div class="item">
                        <i data-feather="${deliveryIcon}" class="w-4 h-4"></i>
                        <span>${deliveryType}</span>
                    </div>
                    ${order.notes ? `
                    <div class="item">
                        <i data-feather="file-text" class="w-4 h-4"></i>
                        <span class="truncate">${order.notes}</span>
                    </div>` : ''}
                </div>
                <div class="p-2 bg-gray-50 border-t border-gray-100 flex justify-end">
                    <button class="p-2 text-blue-500" onclick="openChatModal('${order.id}', '${displayId}')">
                        <i data-feather="message-circle" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            `;
        }

        // --- Chat Modal Functions ---
        let messageListener = null;

        async function openChatModal(orderId, displayId) {
            SmartLog.info(`Opening chat for order: ${orderId}`, "UI.Chat");
            const modal = document.getElementById('chat-modal');
            const title = document.getElementById('chat-modal-title');
            const messageList = document.getElementById('chat-message-list-inner');
            const formOrderId = document.getElementById('chat-order-id-input');

            title.innerText = `שיחה (הזמנה ${displayId})`;
            messageList.innerHTML = '<p>טוען הודעות...</p>';
            formOrderId.value = orderId;
            modal.style.display = 'block';
            setTimeout(() => modal.querySelector('.chat-container').classList.add('visible'), 10);
            
            markMessagesAsRead(orderId);

            if (messageListener) messageListener();
            
            const messagesQuery = query(collection(db, 'orders', orderId, 'messages'), orderBy('timestamp', 'desc'), limit(50));
            
            messageListener = onSnapshot(messagesQuery, (snapshot) => {
                messageList.innerHTML = '';
                const messages = [];
                snapshot.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));
                
                if (messages.length === 0) {
                    messageList.innerHTML = '<p class="text-center text-gray-500">אין הודעות בשיחה זו.</p>';
                    return;
                }

                messages.forEach(msg => {
                    messageList.appendChild(createMessageBubble(msg));
                });
                feather.replace();
            });
        }
        window.openChatModal = openChatModal;
        
        function createMessageBubble(msg) {
            const div = document.createElement('div');
            const isOutgoing = msg.sender === 'admin';
            div.className = `msg-bubble ${isOutgoing ? 'msg-outgoing' : 'msg-incoming'}`;
            
            const time = msg.timestamp ? msg.timestamp.toDate().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '';
            div.innerHTML = `
                <p>${msg.text}</p>
                <div class="msg-time">${time}</div>
            `;
            return div;
        }

        function closeChatModal() {
            const modal = document.getElementById('chat-modal');
            modal.querySelector('.chat-container').classList.remove('visible');
            setTimeout(() => modal.style.display = 'none', 300);
            
            if (messageListener) {
                messageListener();
                messageListener = null;
            }
        }
        window.closeChatModal = closeChatModal;

        async function sendAdminReply(event) {
            event.preventDefault();
            const orderId = document.getElementById('chat-order-id-input').value;
            const input = document.getElementById('reply-input');
            const text = input.value.trim();
            
            if (!text || !orderId) return;
            
            const messageData = {
                text: text,
                sender: 'admin',
                timestamp: serverTimestamp(),
                isUnread: true 
            };
            
            input.value = ''; 
            
            try {
                // [FIX v50.15] - שם משתנה שגוי תוקן
                const messagesColRef = collection(db, 'orders', orderId, 'messages');
                await addDoc(messagesColRef, messageData);
            } catch (error) {
                SmartLog.error(error, "UI.Chat.SendFailed", { orderId });
                showToast("שגיאה בשליחת הודעה", "error");
                input.value = text; 
            }
        }
        window.sendAdminReply = sendAdminReply;

        async function markMessagesAsRead(orderId) {
            SmartLog.info(`Marking messages as read for order: ${orderId}`, "UI.Chat.Read");
            const q = query(
                collection(db, 'orders', orderId, 'messages'), 
                where('isUnread', '==', true), 
                where('sender', '==', 'customer')
            );
            
            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) return;
                
                const batch = writeBatch(db);
                snapshot.forEach(doc => {
                    batch.update(doc.ref, { isUnread: false });
                });
                await batch.commit();
                SmartLog.info(`Marked ${snapshot.size} messages as read.`, "UI.Chat.ReadSuccess");
            } catch (error) {
                SmartLog.error(error, "UI.Chat.ReadFailed", { orderId });
            }
        }

        // --- Utils ---
        function filterViewerLists() {
            SmartLog.info("Search triggered (functionality not fully implemented)", "UI.Search");
            showToast("פונקציית החיפוש בבנייה", "info");
        }
        window.filterViewerLists = filterViewerLists;

        async function createTestMessage(orderId) {
            SmartLog.info(`Creating test message for order: ${orderId}`, "Test.Message");
            if (!orderId) {
                showToast("ID הזמנה לא חוקי", "error");
                return;
            }

            const messageData = {
                text: "זוהי הודעת בדיקה אוטומטית מהמערכת.",
                sender: "customer",
                timestamp: serverTimestamp(),
                isUnread: true,
                customerName: "לקוח בדיקה"
            };

            try {
                const messagesColRef = collection(db, 'orders', orderId, 'messages');
                await addDoc(messagesColRef, messageData);
                showToast(`הודעת בדיקה נשלחה עבור הזמנה ${orderId}`, 'success');
            } catch (error) {
                SmartLog.error(error, "Test.MessageFailed", { orderId });
                showToast("שגיאה ביצירת הודעת בדיקה", "error");
            }
        }
        window.createTestMessage = createTestMessage;
        
    </script>
</body>
</html>
