<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Zebulun Delivery Portal – Powered by H.Saban Materials</title>
    <!-- 
      Zebulun CRM Portal v55 (Approval Workflow Update)
      
      Changelog:
      - [NEW v55]:
        - "הזמנות לאישור" - נוספה כרטיסייה חדשה (`nav-pending-orders`) בניווט התחתון והצדדי.
        - "Pending Badge" - נוסף מזהה `pending-badge` לכפתור הניווט להצגת כמות.
        - "Approval Page" - נוסף עמוד חדש (`page-pending-orders`) לטיפול בבקשות.
      - [JS v55]:
        - `listenForPendingOrders`: פונקציה חדשה המאזינה לקולקציית `pending_orders` ומעדכנת את התג והרשימה.
        - `renderApprovalWorkbench`: פונקציה חדשה המציגה את ממשק אישור הבקשה (Workbench).
        - `approveOrder`: פונקציה חדשה שיוצרת הזמנה רשמית ב-`orders` ומעדכנת את הבקשה ב-`pending_orders`.
        - `fetchCatalogData`: פונקציה חדשה לטעינת קטלוג המוצרים עבור יוסי.
        - `handleAdminCatalogSearch`: פונקציה חדשה לחיפוש בקטלוג בתוך ה-Workbench.
    -->
    
    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/ryPT3r29/image.png">
    <link rel="icon" href="https://i.postimg.cc/ryPT3r29/image.png">

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Google Font: Rubik -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- LeafletJS (עבור מעקב עתידי) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* [--- סגנונות בסיס ---] */
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --primary-light: #eff6ff; /* blue-50 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
            --text-dark: #1f2937; /* gray-800 */
            --text-light: #6b7280; /* gray-500 */
            --danger: #ef4444; /* red-500 */
            --warning: #f59e0b; /* amber-500 */
        }
        
        html.dark {
            --primary-color: #60a5fa; /* blue-400 */
            --primary-dark: #3b82f6; /* blue-500 */
            --primary-light: #1e3a8a;
            --bg-light: #0f172a; /* slate-900 */
            --bg-white: #1e293b; /* slate-800 */
            --border-color: #334155; /* slate-700 */
            --text-dark: #f1f5f9; /* slate-100 */
            --text-light: #94a3b8; /* slate-400 */
            --danger: #f87171; /* red-400 */
            --warning: #fbbf24; /* amber-400 */
        }

        html { -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            overscroll-behavior: none;
            overflow: hidden;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* [--- סגנונות גלובליים (Loader, Modal, Forms) ---] */
        #app-loader {
            position: fixed; inset: 0; background-color: var(--bg-light);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10000; transition: opacity 0.3s ease;
        }
        .loader {
            border: 4px solid var(--border-color); border-top: 4px solid var(--primary-color);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        .loader-small {
            border: 2px solid var(--border-color); border-top: 2px solid var(--primary-color);
            border-radius: 50%; width: 16px; height: 16px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #global-alert-container {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 10000; display: flex; flex-direction: column;
            gap: 0.5rem; width: 90%; max-width: 400px;
        }
        .global-alert {
            background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(5px);
            color: #fff; padding: 1rem 1.25rem; border-radius: 0.75rem;
            font-weight: 600; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            animation: popIn 0.3s ease-out; display: flex; align-items: center; gap: 0.75rem;
        }
        @keyframes popIn { from { transform: translateY(20px) scale(0.9); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .global-alert.alert-success { background: rgba(34, 197, 94, 0.85); }
        .global-alert.alert-error { background: rgba(239, 68, 68, 0.85); }

        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px); z-index: 500; opacity: 0;
            transition: opacity 0.2s ease; pointer-events: none;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-container {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background-color: var(--bg-white); border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            z-index: 501; width: 90%; max-width: 500px;
            opacity: 0; transition: all 0.2s ease-out; pointer-events: none;
        }
        .modal-container.visible { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
        .modal-body { padding: 1.5rem; max-height: 70vh; overflow-y: auto; }
        
        .form-label { display: block; font-weight: 500; font-size: 0.9rem; margin-bottom: 0.25rem; color: var(--text-dark); }
        .form-input {
            width: 100%; padding: 0.6rem 0.9rem; border: 1px solid var(--border-color);
            border-radius: 0.5rem; background-color: var(--bg-white); color: var(--text-dark);
        }
        .form-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px var(--primary-light); }
        .btn {
            padding: 0.6rem 1.25rem; border: none; border-radius: 0.5rem;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-primary:disabled { background-color: var(--text-light); cursor: not-allowed; opacity: 0.7; }
        .btn-secondary { background-color: var(--bg-light); color: var(--text-dark); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: var(--border-color); }
        .btn-icon { padding: 0.5rem; border-radius: 0.5rem; background: none; border: none; color: var(--text-light); }
        .btn-icon:hover { background-color: var(--bg-light); color: var(--text-dark); }
        
        .list-item-card {
            background-color: var(--bg-white); border: 1px solid var(--border-color);
            border-radius: 0.5rem; padding: 1rem; transition: all 0.2s; cursor: pointer;
        }
        .list-item-card:hover { border-color: var(--primary-color); box-shadow: 0 0 0 2px var(--primary-light); }
        .list-item-card.active { border-color: var(--primary-color); background-color: var(--primary-light); }
        .list-item-card h4 { font-weight: 600; color: var(--text-dark); }
        .list-item-card p { font-size: 0.9rem; color: var(--text-light); }
        
        /* [--- פריסת דסקטופ ---] */
        #desktop-crm-layout { display: none; }
        #desktop-main-area {
            display: grid; grid-template-columns: 400px 1fr;
            height: 100vh; overflow: hidden;
        }
        #desktop-list-panel {
            background-color: var(--bg-light); border-left: 1px solid var(--border-color);
            height: 100%; display: flex; flex-direction: column;
        }
        #desktop-detail-panel { height: 100%; overflow-y: auto; padding: 1.5rem 2rem; }
        
        /* [--- פריסת מובייל PWA ---] */
        #mobile-pwa-layout { display: grid; grid-template-rows: auto 1fr auto; height: 100vh; height: -webkit-fill-available; }
        #mobile-header {
            background-color: var(--bg-white); box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 10; padding: 1rem 1.25rem;
            padding-top: calc(1rem + env(safe-area-inset-top, 0));
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-logos { display: flex; align-items: center; gap: 0.5rem; }
        .header-logos img { max-height: 32px; width: auto; object-fit: contain; }
        .logo-divider { width: 1px; height: 24px; background-color: var(--border-color); }
        
        #mobile-main-content { overflow-y: auto; position: relative; }
        .app-page { padding: 1rem; display: none; }
        .app-page.active { display: block; }
        
        #bottom-nav {
            display: grid; grid-auto-flow: column;
            background-color: var(--bg-white); border-top: 1px solid var(--border-color);
            z-index: 10; padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .nav-button {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 8px 4px; color: var(--text-light); font-size: 0.7rem; font-weight: 500;
            border-top: 3px solid transparent; transition: all 0.2s ease; position: relative;
        }
        .nav-button.active {
            color: var(--primary-color); border-top-color: var(--primary-color);
            background-color: var(--primary-light);
        }
        
        /* [NEW v55] Badge for Pending Orders */
        .nav-badge {
            position: absolute; top: 4px; right: 10px;
            background-color: var(--danger); color: white;
            font-size: 0.65rem; font-weight: 600;
            width: 18px; height: 18px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            pointer-events: none;
        }

        /* [NEW v55] Approval Workbench Styles */
        .workbench-section {
            background-color: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .workbench-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-light);
            font-weight: 600;
        }
        .workbench-body {
            padding: 1rem;
        }
        .media-link {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem; background-color: var(--primary-light);
            color: var(--primary-dark); border-radius: 0.25rem;
        }
        
        /* --- סגנונות ספציפיים שהועתקו מקובץ הדסקטופ --- */
        @media (min-width: 768px) {
            #desktop-crm-layout { display: grid; }
            #mobile-pwa-layout { display: none; }
            #desktop-nav {
                background-color: var(--bg-white); border-left: 1px solid var(--border-color);
                display: flex; flex-direction: column; padding: 1rem;
            }
            .desktop-nav-header { padding: 0.5rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
            .desktop-nav-header .header-logos { display: flex; align-items: center; gap: 0.75rem; }
            .desktop-nav-header img { max-height: 40px; width: auto; object-fit: contain; margin-bottom: 0.5rem; }
            .desktop-nav-header p { font-weight: 600; color: var(--text-dark); }
            .desktop-nav-link {
                display: flex; align-items: center; gap: 0.75rem;
                padding: 0.75rem 1rem; border-radius: 0.5rem; font-weight: 500;
                color: var(--text-light); transition: all 0.2s; cursor: pointer; position: relative;
            }
            .desktop-nav-link:hover { background-color: var(--bg-light); color: var(--text-dark); }
            .desktop-nav-link.active { background-color: var(--primary-light); color: var(--primary-dark); font-weight: 600; }
            .desktop-list-header { padding: 1rem; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
            #desktop-list-content { flex-grow: 1; overflow-y: auto; }
            .modal-container { max-width: 600px; }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Global Loader -->
    <div id="app-loader">
        <div class="loader"></div>
        <p class="mt-4 font-semibold text-lg" id="loader-text">טוען פורטל...</p>
    </div>

    <!-- Global Alert (Toast) Container -->
    <div id="global-alert-container"></div>

    <!-- Modal (Popup) Structure -->
    <div id="modal-overlay" class="modal-overlay" onclick="closeModal()"></div>
    <div id="main-modal" class="modal-container">
        <!-- תוכן מודאל יוטען ע"י JS -->
    </div>

    <!-- ====================================================== -->
    <!-- ===      DESKTOP CRM LAYOUT (v55)                === -->
    <!-- ====================================================== -->
    <div id="desktop-crm-layout">
        <!-- Desktop Sidebar Navigation -->
        <nav id="desktop-nav">
            <div class="desktop-nav-header">
                <div class="header-logos">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTcYS_xImwWt1fAYIK1UTXHtbCfmt5TOny5UQ&s" alt="Zebulun Logo">
                    <div class="logo-divider"></div>
                    <img src="https://i.postimg.cc/ryPT3r29/image.png" alt="Saban Logo">
                </div>
                <p class="text-sm font-semibold mt-2">Zebulun Delivery Portal</p>
            </div>
            
            <a id="nav-desktop-dashboard" class="desktop-nav-link active" onclick="navigate('dashboard')">
                <i data-feather="home"></i> <span>דשבורד</span>
            </a>
            <!-- [NEW v55] Pending Orders Link -->
            <a id="nav-desktop-pending-orders" class="desktop-nav-link" onclick="navigate('pending-orders')">
                <i data-feather="clock"></i> <span>הזמנות לאישור</span>
                <span id="pending-badge-desktop" class="nav-badge hidden">0</span>
            </a>
            <a id="nav-desktop-new-order" class="desktop-nav-link" onclick="navigate('new-order')">
                <i data-feather="plus-circle"></i> <span>הזמנה חדשה (ידנית)</span>
            </a>
            <a id="nav-desktop-projects" class="desktop-nav-link" onclick="navigate('projects')">
                <i data-feather="briefcase"></i> <span>ניהול פרויקטים</span>
            </a>
            <a id="nav-desktop-history" class="desktop-nav-link" onclick="navigate('orders-history')">
                <i data-feather="archive"></i> <span>היסטוריית הזמנות</span>
            </a>
            
            <div class="mt-auto"> <!-- Footer -->
                <button id="desktop-theme-toggle" class="btn-icon w-full justify-start gap-2 px-3 py-2">
                    <i data-feather="moon"></i> <span>מצב לילה</span>
                </button>
                <div class="text-xs text-gray-400 p-2 mt-2">
                    <p id="desktop-auth-status">מתחבר...</p>
                    <p>Powered by H.Saban</p>
                </div>
            </div>
        </nav>

        <!-- Desktop Main Area (List + Details) -->
        <main id="desktop-main-area">
            <!-- List Panel (for Orders, Projects, etc.) -->
            <div id="desktop-list-panel">
                <div class="desktop-list-header">
                    <input type="text" id="desktop-search-input" placeholder="חפש הזמנות, פרויקטים..." class="form-input">
                </div>
                <div id="desktop-list-content" class="no-scrollbar">
                    <!-- תוכן רשימה דינמי יטען כאן -->
                    <p class="p-4 text-center">טוען תוכן...</p>
                </div>
            </div>
            
            <!-- Detail Panel (Editor, Viewer, etc.) -->
            <div id="desktop-detail-panel" class="no-scrollbar">
                <!-- תוכן פרטים דינמי יטען כאן -->
                <div id="desktop-detail-content">
                    <h2 class="text-2xl font-bold mb-4">ברוך הבא לפורטל ה-CRM</h2>
                    <p>בחר פריט מהרשימה בצד ימין כדי לראות פרטים.</p>
                </div>
            </div>
        </main>
    </div>


    <!-- ====================================================== -->
    <!-- ===       MOBILE PWA LAYOUT (v55)                === -->
    <!-- ====================================================== -->
    <div id="mobile-pwa-layout">
        <!-- Mobile Header -->
        <header id="mobile-header">
            <div class="header-logos">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTcYS_xImwWt1fAYIK1UTXHtbCfmt5TOny5UQ&s" alt="Zebulun Logo">
                <div class="logo-divider"></div>
                <img src="https://i.postimg.cc/ryPT3r29/image.png" alt="Saban Logo">
            </div>
            <div class="flex items-center gap-2">
                <button id="mobile-theme-toggle" class="btn-icon">
                    <i data-feather="moon"></i>
                </button>
            </div>
        </header>

        <!-- Mobile Main Content (Pages) -->
        <main id="mobile-main-content" class="no-scrollbar">
            
            <!-- Page: Dashboard (Home) -->
            <div id="page-dashboard" class="app-page active">
                <!-- Content Injected by JS: renderDashboard() -->
            </div>
            
            <!-- [NEW v55] Page: Pending Orders -->
            <div id="page-pending-orders" class="app-page">
                <!-- Content Injected by JS: renderPendingOrdersPage() -->
            </div>
            
            <!-- Page: New Order (Smart Paste / Manual) -->
            <div id="page-new-order" class="app-page">
                <!-- Content Injected by JS: renderNewOrderPage() -->
            </div>

            <!-- Page: Projects -->
            <div id="page-projects" class="app-page">
                <!-- Content Injected by JS: renderProjectsPage() -->
            </div>
            
            <!-- Page: Orders History -->
            <div id="page-orders-history" class="app-page">
                <!-- Content Injected by JS: renderOrdersHistoryPage() -->
            </div>
            
        </main>

        <!-- Mobile Bottom Navigation -->
        <nav id="bottom-nav" class="grid-cols-4"> <!-- [FIX v55] Changed to 4 columns -->
            <button id="nav-mobile-dashboard" class="nav-button active" onclick="navigate('dashboard')">
                <i data-feather="home" class="w-6 h-6"></i>
                <span>דשבורד</span>
            </button>
            <!-- [NEW v55] Pending Orders Link -->
            <button id="nav-mobile-pending-orders" class="nav-button" onclick="navigate('pending-orders')">
                <span id="pending-badge-mobile" class="nav-badge hidden">0</span>
                <i data-feather="clock" class="w-6 h-6"></i>
                <span>לאישור</span>
            </button>
            <button id="nav-mobile-new-order" class="nav-button" onclick="navigate('new-order')">
                <i data-feather="plus-circle" class="w-6 h-6"></i>
                <span>הזמנה</span>
            </button>
            <button id="nav-mobile-projects" class="nav-button" onclick="navigate('projects')">
                <i data-feather="briefcase" class="w-6 h-6"></i>
                <span>פרויקטים</span>
            </button>
            <!-- [REMOVED v55] History moved to dashboard or projects -->
        </nav>
    </div>


    <!-- 
    ======================================================
    === 2. EMBEDDED JAVASCRIPT (v55)
    ======================================================
    -->
    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Configuration ---
        const fallbackConfig = {
            apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo",
            authDomain: "saban94-78949.firebaseapp.com",
            projectId: "saban94-78949",
            storageBucket: "saban94-78949.appspot.com",
            messagingSenderId: "41553157903",
            appId: "1:41553157903:web:cc33d252cff023be97a87a"
        };
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(fallbackConfig));
        const CATALOG_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwrzg8d2H3p6I4y-cySVgA-6Sj5q1DOEPKOmXumrElIpdVfM3dBx_WuJ6eZu6q-NhI/exec";
        const CLIENT_ID = "zebulun_adiran"; // מזהה לקוח קבוע

        // --- Global App State ---
        let db, auth, storage;
        let app = null;
        let currentUserId = null;
        let appInitialized = false;
        let globalAlertsListener = null;
        let pendingOrdersListener = null; // [NEW v55]

        const state = {
            currentView: 'dashboard',
            theme: 'light',
            filesToUpload: [],
            mockProjects: [
                { id: "proj_1", name: "זבולון-עדירן/דהבני", address: "הגדרות 39, סביון", contact: "עלי (052-3993017)", customerId: "5020317" },
                { id: "proj_2", name: "זבולון-עדירן/חדד", address: "וינגייט 27, כפר שמריהו", contact: "עבד (050-5938716)", customerId: "5020321" },
                { id: "proj_3", name: "זבולון-עדירן/חג'ג'", address: "הנרקיסים 32, כפר שמריהו", contact: "יוסי (050-6610040)", customerId: "620001" }
            ],
            orderHistory: [],
            pendingOrders: [], // [NEW v55]
            catalogData: [], // [NEW v55]
            adminOrderCart: [] // [NEW v55]
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', initApp);

        function initApp() {
            console.log("DOM loaded. Initializing app v55...");
            feather.replace();
            initFirebase();
            initEventListeners();
            setTheme(localStorage.getItem('theme') || 'light');
            navigate('dashboard');
        }

        function initFirebase() {
            try {
                app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                console.log("Firebase Initialized.");
                authenticateUser();
            } catch (error) {
                console.error("Firebase Init Error:", error);
                document.getElementById('loader-text').innerText = "שגיאת התחברות";
            }
        }

        function initEventListeners() {
            // דסקטופ
            document.getElementById('nav-desktop-dashboard').addEventListener('click', () => navigate('dashboard'));
            document.getElementById('nav-desktop-pending-orders').addEventListener('click', () => navigate('pending-orders')); // [NEW v55]
            document.getElementById('nav-desktop-new-order').addEventListener('click', () => navigate('new-order'));
            document.getElementById('nav-desktop-projects').addEventListener('click', () => navigate('projects'));
            document.getElementById('nav-desktop-history').addEventListener('click', () => navigate('orders-history'));

            // מובייל
            document.getElementById('nav-mobile-dashboard').addEventListener('click', () => navigate('dashboard'));
            document.getElementById('nav-mobile-pending-orders').addEventListener('click', () => navigate('pending-orders')); // [NEW v55]
            document.getElementById('nav-mobile-new-order').addEventListener('click', () => navigate('new-order'));
            document.getElementById('nav-mobile-projects').addEventListener('click', () => navigate('projects'));

            // ערכת נושא
            document.getElementById('desktop-theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('mobile-theme-toggle').addEventListener('click', toggleTheme);
            
            // חשיפת פונקציות גלובליות
            window.navigate = navigate;
            window.openProjectModal = openProjectModal;
            window.openNewProjectModal = openNewProjectModal;
            window.saveProject = saveProject;
            window.closeModal = closeModal;
            window.sendSmartOrder = sendSmartOrder;
            window.handlePaste = handlePaste;
            window.triggerFileInput = triggerFileInput;
            window.handleFileSelect = handleFileSelect;
            window.handleDragOver = handleDragOver;
            window.handleDragLeave = handleDragLeave;
            window.handleFileDrop = handleFileDrop;
            window.removeFile = removeFile;
            window.toggleTheme = toggleTheme;
            window.showOrderDetail = showOrderDetail;
            window.renderApprovalWorkbench = renderApprovalWorkbench; // [NEW v55]
            window.approveOrder = approveOrder; // [NEW v55]
            window.handleAdminCatalogSearch = handleAdminCatalogSearch; // [NEW v55]
            window.addAdminCartItem = addAdminCartItem; // [NEW v55]
            window.removeAdminCartItem = removeAdminCartItem; // [NEW v55]
            window.shareSetupLink = shareSetupLink; // [NEW v55]
        }

        function authenticateUser() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log(`User Authenticated: ${currentUserId}`);
                    updateAuthStatus(`מחובר (משתמש: ${currentUserId.slice(0, 6)})`);
                    
                    if (!appInitialized) {
                        appInitialized = true;
                        await loadClientData();
                        listenForPendingOrders(); // [NEW v55]
                        
                        document.getElementById('app-loader').style.opacity = '0';
                        setTimeout(() => document.getElementById('app-loader').style.display = 'none', 300);
                    }
                } else {
                    console.log("No user found. Signing in...");
                    updateAuthStatus("מתחבר...");
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) {
                            await signInWithCustomToken(auth, token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication Error:", error);
                        updateAuthStatus("שגיאת התחברות");
                    }
                }
            });
        }
        
        function updateAuthStatus(message) {
            const el = document.getElementById('desktop-auth-status');
            if(el) el.innerText = message;
        }

        // --- [NEW v55] Data Loading: Catalog ---
        async function fetchCatalogData() {
            if (state.catalogData.length > 0) return; // טען פעם אחת
            try {
                const response = await fetch(CATALOG_SCRIPT_URL);
                state.catalogData = await response.json();
                console.log(`Catalog loaded: ${state.catalogData.length} items.`);
            } catch (e) {
                console.error("Failed to load catalog:", e);
                showToast("שגיאה בטעינת קטלוג המוצרים", "error");
            }
        }

        // --- [NEW v55] Data Listening: Pending Orders ---
        function listenForPendingOrders() {
            if (pendingOrdersListener) pendingOrdersListener();
            
            const q = query(
                collection(db, "pending_orders"),
                where("client_id", "==", CLIENT_ID),
                where("status", "==", "pending")
            );
            
            pendingOrdersListener = onSnapshot(q, (snapshot) => {
                state.pendingOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`Found ${state.pendingOrders.length} pending orders.`);
                
                // Update badge
                const badgeCount = state.pendingOrders.length;
                const badgeDesktop = document.getElementById('pending-badge-desktop');
                const badgeMobile = document.getElementById('pending-badge-mobile');
                
                [badgeDesktop, badgeMobile].forEach(badge => {
                    if (badge) {
                        badge.innerText = badgeCount;
                        badge.classList.toggle('hidden', badgeCount === 0);
                    }
                });
                
                // If view is active, render it
                if (state.currentView === 'pending-orders') {
                    renderPendingOrdersPage();
                }
                
            }, (error) => {
                console.error("Error listening to pending orders:", error);
                showToast("שגיאה בקבלת הזמנות ממתינות", "error");
            });
        }


        // --- Navigation Engine (Updated v55) ---
        function navigate(viewId) {
            console.log(`Navigating to: ${viewId}`);
            state.currentView = viewId;
            
            // מובייל
            document.querySelectorAll('#mobile-main-content .app-page').forEach(page => page.classList.remove('active'));
            const mobilePage = document.getElementById(`page-${viewId}`);
            if (mobilePage) mobilePage.classList.add('active');
            
            document.querySelectorAll('#bottom-nav .nav-button').forEach(btn => btn.classList.remove('active'));
            const mobileBtn = document.getElementById(`nav-mobile-${viewId}`);
            if (mobileBtn) mobileBtn.classList.add('active');

            // דסקטופ
            document.querySelectorAll('#desktop-nav .desktop-nav-link').forEach(link => link.classList.remove('active'));
            const desktopLink = document.getElementById(`nav-desktop-${viewId}`);
            if (desktopLink) desktopLink.classList.add('active');

            // איפוס תוכן דסקטופ
            document.getElementById('desktop-list-content').innerHTML = '';
            document.getElementById('desktop-detail-content').innerHTML = '';

            // טעינת תוכן
            try {
                switch (viewId) {
                    case 'dashboard':
                        renderDashboard();
                        break;
                    case 'pending-orders': // [NEW v55]
                        renderPendingOrdersPage();
                        break;
                    case 'new-order':
                        renderNewOrderPage();
                        break;
                    case 'projects':
                        renderProjectsPage();
                        break;
                    case 'orders-history':
                        renderOrdersHistoryPage();
                        break;
                }
            } catch (error) {
                console.error(`Failed to render page ${viewId}:`, error);
                showToast(`שגיאה בטעינת עמוד: ${viewId}`, 'error');
            }
            
            feather.replace();
        }

        // --- Theme ---
        function toggleTheme() {
            setTheme(document.documentElement.classList.toggle('dark') ? 'dark' : 'light');
        }
        function setTheme(theme) {
            state.theme = theme;
            localStorage.setItem('theme', theme);
            document.documentElement.className = theme;
            const icon = theme === 'dark' ? 'sun' : 'moon';
            document.querySelectorAll('#desktop-theme-toggle i, #mobile-theme-toggle i').forEach(el => el.setAttribute('data-feather', icon));
            const textEl = document.querySelector('#desktop-theme-toggle span');
            if(textEl) textEl.innerText = theme === 'dark' ? 'מצב יום' : 'מצב לילה';
            feather.replace();
        }

        // --- Data Loading ---
        async function loadClientData() {
            // טעינת קטלוג ברקע
            fetchCatalogData();
            
            // טעינת היסטוריית הזמנות
            try {
                const q = query(collection(db, "orders"), where("clientId", "==", CLIENT_ID), orderBy("createdAt", "desc"), limit(20));
                const snapshot = await getDocs(q);
                state.orderHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Failed to load order history:", error);
                state.orderHistory = [];
            }
        }
        
        // --- Page Rendering Functions ---
        
        function renderDashboard() {
            const greeting = "ברוך הבא, יוסי!"; // Placeholder
            // מובייל
            document.getElementById('page-dashboard').innerHTML = `
                <div class="p-4 bg-white rounded-lg shadow mb-4">
                    <h2 class="text-xl font-bold">${greeting}</h2>
                    <p class="text-sm text-gray-600">ברוך הבא לפורטל הניהול שלך.</p>
                </div>
                <!-- תוכן נוסף לדשבורד יבוא כאן -->
            `;
            // דסקטופ
            document.getElementById('desktop-list-content').innerHTML = `<div class="p-4"><h3 class="text-lg font-semibold mb-3">הזמנות אחרונות</h3>${renderOrderHistoryList(10)}</div>`;
            document.getElementById('desktop-detail-content').innerHTML = `<h2 class="text-2xl font-bold mb-4">${greeting}</h2>`;
        }

        // --- [NEW v55] Pending Orders Page ---
        function renderPendingOrdersPage() {
            const listHTML = state.pendingOrders.map(req => `
                <div class="list-item-card" onclick="renderApprovalWorkbench('${req.id}')">
                    <div class="flex justify-between items-center">
                        <h4 class="text-warning">${req.project_name || 'פרויקט לא ידוע'}</h4>
                        <span class="text-xs font-medium">${new Date(req.created_at?.toDate()).toLocaleString('he-IL')}</span>
                    </div>
                    <p>מאת: ${req.site_manager_name || 'לא ידוע'}</p>
                    <p class="truncate text-sm mt-1">
                        ${req.raw_text?.join(', ') || ''}
                        ${req.cart_items?.map(i => i.name).join(', ') || ''}
                    </p>
                </div>
            `).join('');

            const pageHTML = `
                <h2 class="text-xl font-bold mb-4">הזמנות ממתינות לאישור (${state.pendingOrders.length})</h2>
                <div id="pending-list-mobile" class="space-y-3">${listHTML}</div>
                <!-- Workbench יטען כאן במובייל בלחיצה -->
                <div id="workbench-mobile-container" class="mt-4"></div>
            `;
            
            // מובייל
            document.getElementById('page-pending-orders').innerHTML = pageHTML;
            
            // דסקטופ
            document.getElementById('desktop-list-content').innerHTML = `<div class="flex flex-col gap-2 p-2">${listHTML}</div>`;
            document.getElementById('desktop-detail-content').innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <i data-feather="clock" class="w-16 h-16 text-gray-400"></i>
                    <h3 class="text-lg font-semibold mt-4">בחר בקשה לאישור</h3>
                    <p class="text-gray-500">בחר בקשה מהרשימה בצד ימין כדי לטפל בה.</p>
                </div>
            `;
            feather.replace();
        }

        // --- [NEW v55] Approval Workbench ---
        function renderApprovalWorkbench(requestId) {
            const request = state.pendingOrders.find(r => r.id === requestId);
            if (!request) {
                showToast("הבקשה לא נמצאה", "error");
                return;
            }
            
            // איפוס עגלת אדמין
            state.adminOrderCart = request.cart_items || []; 

            const workbenchHTML = `
                <h2 class="text-xl font-bold mb-4">אישור בקשה: ${request.project_name}</h2>
                
                <!-- 1. מידע מהשטח -->
                <div class="workbench-section">
                    <div class="workbench-header">מידע מהשטח (מאת: ${request.site_manager_name})</div>
                    <div class="workbench-body space-y-3">
                        ${request.raw_text?.length > 0 ? `<div><strong>טקסט חופשי:</strong><p class="p-2 bg-gray-100 rounded">${request.raw_text.join('\n')}</p></div>` : ''}
                        ${request.location ? `<div><strong>מיקום:</strong> <a href="https://www.google.com/maps?q=${request.location.latitude},${request.location.longitude}" target="_blank" class="text-blue-500">פתח במפה</a></div>` : ''}
                        ${request.media_files?.length > 0 ? `
                            <div><strong>מדיה:</strong>
                                ${request.media_files.map(f => `<a href="${f.url}" target="_blank" class="media-link"><i data-feather="${f.type === 'image' ? 'camera' : 'mic'}"></i> ${f.name || 'פתח קובץ'}</a>`).join('')}
                            </div>` : ''}
                        ${request.cart_items?.length > 0 ? `
                            <div><strong>פריטים מהשטח:</strong>
                                <ul class="list-disc pr-4 text-sm">
                                ${request.cart_items.map(i => `<li>${i.qty} x ${i.name} (מק"ט: ${i.sku})</li>`).join('')}
                                </ul>
                            </div>` : ''}
                    </div>
                </div>
                
                <!-- 2. הזמנה רשמית (Workbench) -->
                <div class="workbench-section">
                    <div class="workbench-header">הזמנה רשמית (למערכת DeliveryMaster)</div>
                    <div class="workbench-body space-y-4">
                        <div>
                            <label class="form-label">חפש והוסף פריטים מהקטלוג:</label>
                            <input type="text" id="admin-product-search" class="form-input" onkeyup="handleAdminCatalogSearch(this.value)">
                            <div id="admin-catalog-results" class="max-h-48 overflow-y-auto border border-gray-200 rounded-b-md"></div>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">עגלת הזמנה לאישור:</h4>
                            <div id="admin-order-cart" class="space-y-2">
                                <!-- פריטים מעגלת האדמין יטענו כאן -->
                            </div>
                        </div>
                        <div>
                            <label class="form-label">הערות למשלוח (יופיע ב-DeliveryMaster):</label>
                            <textarea id="admin-order-notes" class="form-input" rows="2" placeholder="למשל: כניסה משער אחורי">${request.raw_text?.join('\n') || ''}</textarea>
                        </div>
                    </div>
                </div>
                
                <!-- 3. שליחה -->
                <div class="flex gap-4">
                    <button class="btn btn-primary btn-lg w-full" onclick="approveOrder('${request.id}')">
                        <i data-feather="check-circle"></i>
                        <span>אשר ושלח ל-DeliveryMaster</span>
                    </button>
                    <button class="btn btn-danger" onclick="rejectOrder('${request.id}')">
                        <i data-feather="x-circle"></i>
                    </button>
                </div>
            `;
            
            // טעינה למקום הנכון (מובייל / דסקטופ)
            if (window.innerWidth < 768) {
                document.getElementById('pending-list-mobile').classList.add('hidden');
                document.getElementById('workbench-mobile-container').innerHTML = workbenchHTML;
            } else {
                document.getElementById('desktop-detail-content').innerHTML = workbenchHTML;
                // סמן כפעיל ברשימה
                document.querySelectorAll('#desktop-list-content .list-item-card').forEach(el => el.classList.remove('active'));
                document.querySelector(`#desktop-list-content .list-item-card[onclick*="'${requestId}'"]`).classList.add('active');
            }
            
            renderAdminCart(); // הצג פריטים שכבר הגיעו מהשטח
            feather.replace();
        }
        window.renderApprovalWorkbench = renderApprovalWorkbench;

        function handleAdminCatalogSearch(query) {
            const resultsEl = document.getElementById('admin-catalog-results');
            if (query.length < 2) {
                resultsEl.innerHTML = ''; return;
            }
            resultsEl.innerHTML = state.catalogData
                .filter(p => p.name.toLowerCase().includes(query.toLowerCase()) || p.sku.toString().includes(query))
                .slice(0, 5)
                .map(product => `
                    <div class="p-2 border-b hover:bg-gray-50 cursor-pointer" onclick="addAdminCartItem('${product.sku}')">
                        <p class="font-semibold text-sm">${product.name}</p>
                        <p class="text-xs text-gray-500">מק"ט: ${product.sku}</p>
                    </div>
                `).join('');
        }
        window.handleAdminCatalogSearch = handleAdminCatalogSearch;

        function addAdminCartItem(sku) {
            const product = state.catalogData.find(p => p.sku == sku);
            if (!product) return;
            
            const qty = prompt(`הזן כמות עבור: ${product.name}`, "1");
            if (qty && !isNaN(qty) && qty > 0) {
                // בדוק אם הפריט כבר קיים
                const existingItem = state.adminOrderCart.find(item => item.sku === product.sku);
                if (existingItem) {
                    existingItem.qty += parseInt(qty);
                } else {
                    state.adminOrderCart.push({ ...product, qty: parseInt(qty) });
                }
                renderAdminCart();
            }
            document.getElementById('admin-product-search').value = '';
            document.getElementById('admin-catalog-results').innerHTML = '';
        }
        window.addAdminCartItem = addAdminCartItem;

        function removeAdminCartItem(sku) {
            state.adminOrderCart = state.adminOrderCart.filter(item => item.sku != sku);
            renderAdminCart();
        }
        window.removeAdminCartItem = removeAdminCartItem;

        function renderAdminCart() {
            const cartEl = document.getElementById('admin-order-cart');
            if (!cartEl) return;
            if (state.adminOrderCart.length === 0) {
                cartEl.innerHTML = '<p class="text-sm text-gray-500">העגלה ריקה. הוסף פריטים מהקטלוג.</p>';
                return;
            }
            cartEl.innerHTML = state.adminOrderCart.map(item => `
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                    <div>
                        <p class="font-semibold text-sm">${item.qty} x ${item.name}</p>
                        <p class="text-xs text-gray-500">מק"ט: ${item.sku}</p>
                    </div>
                    <button class="text-red-500" onclick="removeAdminCartItem('${item.sku}')"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            feather.replace();
        }

        async function approveOrder(requestId) {
            const requestDoc = await getDoc(doc(db, "pending_orders", requestId));
            if (!requestDoc.exists()) {
                showToast("הבקשה המקורית לא נמצאה", "error");
                return;
            }
            const requestData = requestDoc.data();
            
            if (state.adminOrderCart.length === 0) {
                showToast("חובה להוסיף לפחות פריט אחד להזמנה הרשמית", "error");
                return;
            }

            const notes = document.getElementById('admin-order-notes').value;
            
            const newOrderPayload = {
                clientId: CLIENT_ID,
                customer: { id: "ZEBULUN_CUSTOMER_ID", name: "זבולון עדירן" }, // Placeholder, יש להתאים
                orderDate: new Date().toISOString().split('T')[0],
                orderTime: new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }),
                createdAt: serverTimestamp(),
                status: "חדש", // סטטוס התחלתי למערכת DeliveryMaster
                
                // הקישור החשוב
                source_request_id: requestId,
                source_project_id: requestData.project_id,
                site_manager_name: requestData.site_manager_name,
                
                // הנתונים שיוסי אישר
                cart_items: state.adminOrderCart, // העגלה שיוסי בנה
                notes: notes,
                address: requestData.location ? `מיקום GPS: ${requestData.location.latitude}, ${requestData.location.longitude}` : requestData.project_address, // Placeholder
                latitude: requestData.location?.latitude || null,
                longitude: requestData.location?.longitude || null,
                
                // פרטים נוספים...
                order_id: `ZEB-${Date.now().toString().slice(-6)}`
            };

            try {
                // 1. צור את ההזמנה הרשמית
                const orderRef = await addDoc(collection(db, "orders"), newOrderPayload);
                
                // 2. עדכן את הבקשה הממתינה כ"מאושרת"
                await updateDoc(doc(db, "pending_orders", requestId), {
                    status: "approved",
                    final_order_id: orderRef.id
                });
                
                showToast("ההזמנה אושרה ונשלחה ל-DeliveryMaster!", "success");
                navigate('pending-orders'); // חזור לרשימת ההמתנה
                
            } catch (e) {
                console.error("Failed to approve order:", e);
                showToast("שגיאה באישור ההזמנה", "error");
            }
        }
        window.approveOrder = approveOrder;
        
        async function rejectOrder(requestId) {
             if (!confirm("האם אתה בטוח שברצונך לדחות בקשה זו?")) return;
             try {
                 await updateDoc(doc(db, "pending_orders", requestId), {
                    status: "rejected"
                 });
                 showToast("הבקשה נדחתה", "info");
                 navigate('pending-orders');
             } catch (e) {
                 showToast("שגיאה בדחיית הבקשה", "error");
             }
        }
        window.rejectOrder = rejectOrder;


        // --- [NEW v55] Share Setup Link ---
        function shareSetupLink(projectId, projectName) {
            const setupKey = `zebulun-adiran-${projectId}`;
            const url = `${window.location.origin}/sidor/site_app.html?setup_key=${setupKey}`;
            
            try {
                navigator.clipboard.writeText(url);
                showToast("לינק התקנה למנהל אתר הועתק!", "success");
            } catch (e) {
                alert(`העתק את הלינק:\n${url}`);
            }
        }
        window.shareSetupLink = shareSetupLink;

        
        // --- פונקציות קיימות (שוחזרו) ---
        
        function renderNewOrderPage() {
            // TODO: להוסיף כאן את חיפוש הקטלוג גם עבור יוסי
            const pageContent = `
                <div class="p-4 bg-white rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-2">הזמנה ידנית חדשה</h2>
                    <p class="text-sm text-gray-600 mb-4">
                        צור הזמנה מהירה שלא הגיעה ממנהל אתר.
                    </p>
                    <form id="smart-order-form" onsubmit="event.preventDefault(); sendSmartOrder();">
                         <!-- TODO: הוסף טופס הזמנה ידנית מלא -->
                         <button type="submit" id="send-order-btn" class="btn btn-primary w-full">
                            שלח הזמנה
                         </button>
                    </form>
                </div>`;
            document.getElementById('page-new-order').innerHTML = pageContent;
            document.getElementById('desktop-detail-content').innerHTML = pageContent;
        }

        function renderProjectsPage() {
            const pageHTML = `
                <h2 class="text-xl font-bold mb-4">ניהול פרויקטים</h2>
                <div class="space-y-3">
                    ${state.mockProjects.map(p => `
                        <div class="list-item-card">
                            <h4>${p.name}</h4>
                            <p>${p.address}</p>
                            <div class="mt-2 pt-2 border-t border-gray-200">
                                <button class="text-sm font-semibold text-blue-600" onclick="shareSetupLink('${p.id}', '${p.name}')">
                                    <i data-feather="share-2" class="w-4 h-4 inline-block"></i>
                                    שתף לינק התקנה למנהל אתר
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('page-projects').innerHTML = pageHTML;
            document.getElementById('desktop-list-content').innerHTML = pageHTML;
            document.getElementById('desktop-detail-content').innerHTML = `<p class="p-4">בחר פרויקט לניהול.</p>`;
            feather.replace();
        }
        
        function renderOrdersHistoryPage() {
             const listHTML = renderOrderHistoryList();
             document.getElementById('page-orders-history').innerHTML = `<h2 class="text-xl font-bold mb-4">היסטוריית הזמנות</h2>${listHTML}`;
             document.getElementById('desktop-list-content').innerHTML = listHTML;
             document.getElementById('desktop-detail-content').innerHTML = `<p class="p-4">בחר הזמנה לצפייה בפרטים.</p>`;
        }

        function renderOrderHistoryList(count = state.orderHistory.length) {
            if (state.orderHistory.length === 0) return '<p>אין היסטוריית הזמנות.</p>';
            return state.orderHistory.slice(0, count).map(order => `
                <div class="list-item-card" onclick="showOrderDetail('${order.id}')">
                    <h4>${order.projectName || order.customer?.name || 'הזמנה'}</h4>
                    <p>${order.status || 'חדש'} - ${new Date(order.createdAt?.toDate ? order.createdAt.toDate() : Date.now()).toLocaleDateString('he-IL')}</p>
                    ${order.site_manager_name ? `<p class="text-xs text-blue-600">מקור: ${order.site_manager_name}</p>` : ''}
                </div>
            `).join('');
        }
        
        function showOrderDetail(orderId) { /* ... */ }
        function openProjectModal(projectId) { /* ... */ }
        function openNewProjectModal() { /* ... */ }
        function saveProject() { /* ... */ }
        function sendSmartOrder() { /* ... */ }
        function handlePaste(event) { /* ... */ }
        function triggerFileInput() { /* ... */ }
        function handleFileSelect(event) { /* ... */ }
        function handleDragOver(event) { /* ... */ }
        function handleDragLeave(event) { /* ... */ }
        function handleFileDrop(event) { /* ... */ }
        function removeFile(index) { /* ... */ }

        // --- Utils ---
        function showToast(message, type = "info") {
            const container = document.getElementById('global-alert-container');
            const alertBox = document.createElement('div');
            alertBox.className = `global-alert ${type === 'error' ? 'alert-error' : (type === 'success' ? 'alert-success' : 'alert-info')}`;
            const icon = (type === "error") ? "alert-triangle" : (type === 'success' ? 'check-circle' : 'info');
            alertBox.innerHTML = `<i data-feather="${icon}" class="w-5 h-5"></i><span>${message}</span>`;
            container.appendChild(alertBox);
            feather.replace();
            setTimeout(() => alertBox.remove(), 4000);
        }
        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('visible');
            document.getElementById('main-modal').classList.remove('visible');
        }
    </script>

</body>
</html>
