<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>קטלוג מוצרים | ח. סבן</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Google Font: Rubik -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- הגדרות בסיס וערכת נושא --- */
        :root {
            --primary-color: #0c4a6e; /* sky-900 */
            --primary-hover: #075985; /* sky-800 */
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.4);
        }
        
        html.dark {
            --glass-bg: rgba(30, 41, 59, 0.7); /* slate-800 */
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Rubik', sans-serif;
            /* רקע פרימיום עדין */
            background-color: #f0f4f8;
            background-image: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- אפקט Glassmorphism --- */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }
        
        /* --- פריסה ראשית --- */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr;
            height: 100vh;
        }
        
        @media (min-width: 1024px) {
            .main-layout {
                /* סל קניות צדדי בדסקטופ */
                grid-template-columns: 3fr 1fr;
            }
        }

        /* --- כותרת וחיפוש --- */
        .catalog-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--glass-border);
            z-index: 10;
        }

        /* --- כרטיס מוצר --- */
        .product-card {
            border-radius: 0.75rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.15);
        }
        
        /* קונטיינר לתמונת זום */
        .product-image-container {
            position: relative;
            overflow: hidden;
            cursor: pointer;
            background-color: #e2e8f0; /* gray-200 */
        }
        
        .product-image-container img {
            transition: transform 0.4s ease-in-out;
        }
        
        .product-card:hover .product-image-container img {
            transform: scale(1.1);
        }
        
        /* אייקון זום */
        .zoom-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .product-card:hover .zoom-overlay {
            opacity: 1;
        }

        /* --- סל קניות --- */
        #cart-sidebar {
            position: fixed;
            top: 0;
            right: -100%; /* מוסתר מחוץ למסך במובייל */
            width: 100%;
            max-width: 400px;
            height: 100vh;
            z-index: 40;
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        
        #cart-sidebar.open {
            transform: translateX(-100%); /* הכנסה מימין לשמאל (בגלל RTL) */
        }
        
        @media (min-width: 1024px) {
            #cart-sidebar {
                position: relative; /* הופך לחלק מהגריד */
                right: auto;
                width: auto;
                transform: none;
                z-index: 1;
                border-right: 1px solid var(--glass-border);
            }
        }
        
        /* כפתור סל צף למובייל */
        #mobile-cart-button {
            position: fixed;
            bottom: 2rem;
            left: 2rem; /* הפוך ב-RTL */
            z-index: 30;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .cart-item-qty {
            width: 60px;
            padding: 0.25rem 0.5rem;
            text-align: center;
            border-radius: 0.375rem;
            border: 1px solid var(--border-color);
        }
        
        /* --- מודאל זום --- */
        #image-zoom-modal {
            position: fixed;
            inset: 0;
            z-index: 50;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #image-zoom-modal.open {
            opacity: 1;
            pointer-events: auto;
        }
        #image-zoom-modal img {
            max-width: 90vw;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 0.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        #image-zoom-modal-caption {
            position: absolute;
            bottom: 2rem;
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
            background-color: rgba(0,0,0,0.5);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }
        #image-zoom-close {
            position: absolute;
            top: 2rem;
            left: 2rem; /* הפוך ב-RTL */
            color: white;
        }

        /* --- לואדר --- */
        #loader-overlay {
            position: fixed;
            inset: 0;
            z-index: 100;
            background-color: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        #loader-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body class="text-gray-900">

    <!-- לואדר גלובלי -->
    <div id="loader-overlay" class="open">
        <div class="loader"></div>
    </div>
    
    <!-- מודאל להגדלת תמונה -->
    <div id="image-zoom-modal" onclick="closeImageModal()">
        <button id="image-zoom-close" class="p-2">
            <i data-feather="x" class="w-8 h-8"></i>
        </button>
        <img id="image-zoom-content" src="" alt="תצוגה מקדימה">
        <div id="image-zoom-modal-caption"></div>
    </div>

    <!-- כפתור סל צף למובייל -->
    <button id="mobile-cart-button" onclick="toggleCart(true)" class="lg:hidden p-4 rounded-full bg-sky-800 text-white shadow-lg">
        <i data-feather="shopping-cart"></i>
        <span id="mobile-cart-badge" class_alias="badge" class="absolute top-0 right-0 block w-5 h-5 text-xs font-bold bg-red-500 text-white rounded-full text-center leading-5 hidden">0</span>
    </button>
    
    <div class="main-layout">

        <!-- =================================== -->
        <!--          אזור תוכן ראשי (קטלוג)      -->
        <!-- =================================== -->
        <main id="main-content" class="h-screen overflow-y-auto no-scrollbar">
            <!-- כותרת וחיפוש -->
            <header class="catalog-header glass-card">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">קטלוג מוצרים</h1>
                        <p class="text-gray-600">זבולון עדירן | ח. סבן חומרי בנין</p>
                    </div>
                    <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                        <!-- פילטר קטגוריות -->
                        <select id="category-filter" class="form-input w-full md:w-48 order-2 md:order-1 rounded-md border-gray-300 shadow-sm focus:border-sky-800 focus:ring-sky-800">
                            <option value="all">כל הקטגוריות</option>
                            <!-- יאוכלס דינמית -->
                        </select>
                        <!-- חיפוש חכם -->
                        <input type="text" id="search-input" placeholder="חפש לפי שם, מק'ט או כינוי..." class="form-input w-full md:w-72 order-1 md:order-2 rounded-md border-gray-300 shadow-sm focus:border-sky-800 focus:ring-sky-800">
                    </div>
                </div>
            </header>

            <!-- רשת מוצרים -->
            <div id="product-grid" class="p-4 md:p-8 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
                <!-- כרטיסי מוצר יוכנסו כאן על ידי JavaScript -->
                <!-- דוגמה ל-Skeleton Loader -->
                <div class="glass-card rounded-xl animate-pulse">
                    <div class="h-40 bg-gray-300 rounded-t-xl"></div>
                    <div class="p-4 space-y-3">
                        <div class="h-4 bg-gray-300 rounded w-1/3"></div>
                        <div class="h-6 bg-gray-300 rounded w-3/4"></div>
                        <div class="h-4 bg-gray-300 rounded w-full"></div>
                        <div class="h-10 bg-gray-300 rounded-lg w-1/2 ml-auto"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- =================================== -->
        <!--          סל קניות צדדי/צף          -->
        <!-- =================================== -->
        <aside id="cart-sidebar" class="glass-card">
            <!-- כותרת סל -->
            <div class="p-4 border-b border-white/30 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">סל קניות</h2>
                <button class="lg:hidden p-1" onclick="toggleCart(false)">
                    <i data-feather="x" class="w-6 h-6 text-gray-700"></i>
                </button>
            </div>

            <!-- רשימת פריטים בסל -->
            <div id="cart-items" class="flex-grow p-4 overflow-y-auto no-scrollbar space-y-4">
                <!-- פריטים יוכנסו כאן -->
                <p id="cart-empty-msg" class="text-gray-600 text-center pt-8">הסל שלך ריק.</p>
            </div>

            <!-- סיכום וסיום הזמנה -->
            <div class="p-4 border-t border-white/30 space-y-4">
                <div>
                    <label for="customer-name-input" class="block text-sm font-medium text-gray-700">שם המזמין</label>
                    <input type="text" id="customer-name-input" class="form-input mt-1 w-full rounded-md border-gray-300 shadow-sm" placeholder="שם מלא (חובה)">
                </div>
                <div>
                    <label for="project-name-input" class="block text-sm font-medium text-gray-700">שם פרויקט</label>
                    <input type="text" id="project-name-input" class="form-input mt-1 w-full rounded-md border-gray-300 shadow-sm" placeholder="לדוגמה: בניין בראשון">
                </div>
                <div>
                    <label for="cart-notes" class="block text-sm font-medium text-gray-700">הערות להזמנה</label>
                    <textarea id="cart-notes" rows="2" class="form-input mt-1 w-full rounded-md border-gray-300 shadow-sm" placeholder="כל דבר שחשוב שהמחסנאי ידע..."></textarea>
                </div>
                <div class="flex justify-between items-center text-lg font-bold">
                    <span>סה"כ פריטים:</span>
                    <span id="cart-total-items-summary">0</span>
                </div>
                <button id="send-order-btn" class="w-full p-3 bg-sky-800 text-white font-bold rounded-lg shadow-md hover:bg-sky-900 transition duration-200 flex items-center justify-center gap-2">
                    <i data-feather="send" class="w-5 h-5"></i>
                    <span>שלח הזמנה למחסן</span>
                </button>
            </div>
        </aside>

    </div>

    <!-- =================================== -->
    <!--            JavaScript             -->
    <!-- =================================== -->
    <script>
        // --- מצב (State) גלובלי ---
        let allProducts = [];
        let cart = []; // { sku, name, quantity, ...}
        
        // --- אתחול ---
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            console.log("DOM loaded. Initializing Catalog App...");
            feather.replace();
            
            // הצג לואדר
            toggleLoader(true);
            
            // הגדרת מאזינים
            setupEventListeners();
            
            // טען נתונים מ-Apps Script
            // זוהי הדרישה שלך להשתמש ב-google.script.run
            // ודא שהקוד הזה רץ בתוך פרויקט Apps Script
            try {
                google.script.run
                    .withSuccessHandler(onCatalogLoaded)
                    .withFailureHandler(onLoadError)
                    .getProducts(); // קורא לפונקציה `getProducts` בקובץ Code.gs
            } catch (e) {
                console.error("שגיאה בקריאה ל-google.script.run:", e);
                onLoadError({ 
                    message: "האם הקובץ רץ בתוך Google Apps Script? " + e.message 
                });
            }
        }
        
        function setupEventListeners() {
            document.getElementById('search-input').addEventListener('input', handleSearchAndFilter);
            document.getElementById('category-filter').addEventListener('change', handleSearchAndFilter);
            document.getElementById('send-order-btn').addEventListener('click', sendOrder);
        }

        // --- טעינת נתונים ---
        
        function onCatalogLoaded(products) {
            console.log("Catalog loaded successfully:", products);
            toggleLoader(false);
            
            // ודא שקיבלנו מערך
            if (!Array.isArray(products)) {
                onLoadError({ message: "הנתונים שהתקבלו אינם מערך." });
                return;
            }

            allProducts = products;
            populateCategories(products);
            renderProductGrid(products);
        }
        
        function onLoadError(error) {
            console.error("========================================================");
            console.error("אחי, שגיאה קריטית בטעינת הקטלוג:", error.message);
            console.error("אם ההודעה כוללת 'This script' או 'Not found' או 'No such function':");
            console.error("1. ודא שפרסמת את Code.gs (Deploy > New Deployment).");
            console.error("2. ודא שההרשאת גישה (Who has access) היא 'Anyone'.");
            console.error("3. ודא ששם הפונקציה ב-Code.gs הוא אכן 'getProducts'.");
            console.error("========================================================");
            
            toggleLoader(false);
            const grid = document.getElementById('product-grid');
            grid.innerHTML = `<div class="col-span-full text-center p-8 bg-red-100 text-red-700 rounded-lg">
                                <h3>שגיאה בטעינת הקטלוג</h3>
                                <p>${error.message}</p>
                              </div>`;
        }

        // --- רנדור (הצגה) ---
        
        function populateCategories(products) {
            const filterSelect = document.getElementById('category-filter');
            // יצירת רשימה ייחודית של קטגוריות
            const categories = [...new Set(products.map(p => p.category || "כללי"))];
            
            categories.sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                filterSelect.appendChild(option);
            });
        }
        
        function renderProductGrid(productsToRender) {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = ''; // נקה תוצאות קודמות
            
            if (productsToRender.length === 0) {
                grid.innerHTML = `<p class="col-span-full text-center text-gray-600">לא נמצאו מוצרים התואמים לחיפוש.</p>`;
                return;
            }

            productsToRender.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card glass-card flex flex-col';
                
                const imageUrl = product.imageUrl || 'https://placehold.co/400x300/e2e8f0/94a3b8?text=N/A';
                
                card.innerHTML = `
                    <!-- תמונה עם זום -->
                    <div class="product-image-container h-48" onclick="showImageModal('${imageUrl}', '${product.name}')">
                        <img src="${imageUrl}" alt="${product.name}" class="w-full h-full object-cover">
                        <div class="zoom-overlay">
                            <i data-feather="zoom-in" class="w-10 h-10 text-white"></i>
                        </div>
                    </div>
                    
                    <!-- פרטי מוצר -->
                    <div class="p-4 flex flex-col flex-grow">
                        <span class="text-xs font-semibold text-sky-800">${product.category}</span>
                        <h3 class="text-lg font-bold text-gray-800 mt-1">${product.name}</h3>
                        <p class="text-sm text-gray-600 mt-1">מק"ט: ${product.sku}</p>
                        <p class="text-sm text-gray-500 mt-2 flex-grow min-h-[40px]">${product.description || 'אין תיאור זמין'}</p>
                        
                        <!-- כפתור הוספה -->
                        <div class="mt-4">
                            <button class="w-full p-2 bg-sky-800 text-white font-semibold rounded-lg shadow hover:bg-sky-900 transition duration-200 flex items-center justify-center gap-2"
                                    onclick="event.stopPropagation(); addToCart('${product.sku}');">
                                <i data-feather="plus" class="w-5 h-5"></i>
                                <span>הוסף לסל</span>
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            
            feather.replace();
        }

        // --- לוגיקת חיפוש ופילטור ---
        
        function handleSearchAndFilter() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            const category = document.getElementById('category-filter').value;

            const filteredProducts = allProducts.filter(product => {
                // פילטור קטגוריה
                const categoryMatch = (category === 'all') || (product.category === category);
                
                // פילטור חיפוש
                const searchMatch = (searchTerm === '') ||
                    (product.name.toLowerCase().includes(searchTerm)) ||
                    (product.sku.toLowerCase().includes(searchTerm)) ||
                    (product.aliases.some(alias => alias.toLowerCase().includes(searchTerm)));
                    
                return categoryMatch && searchMatch;
            });
            
            renderProductGrid(filteredProducts);
        }

        // --- לוגיקת סל קניות ---
        
        function addToCart(sku) {
            const product = allProducts.find(p => p.sku === sku);
            if (!product) return;
            
            const existingItem = cart.find(item => item.sku === sku);
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    sku: product.sku,
                    name: product.name,
                    quantity: 1
                });
            }
            
            console.log("Cart updated:", cart);
            renderCart();
            showToast(`${product.name} נוסף לסל`, 'success');
        }
        
        function renderCart() {
            const cartContainer = document.getElementById('cart-items');
            const emptyMsg = document.getElementById('cart-empty-msg');
            const totalItemsSummary = document.getElementById('cart-total-items-summary');
            const mobileBadge = document.getElementById('mobile-cart-badge');
            
            if (cart.length === 0) {
                cartContainer.innerHTML = '';
                emptyMsg.classList.remove('hidden');
                totalItemsSummary.textContent = '0';
                mobileBadge.classList.add('hidden');
                mobileBadge.textContent = '0';
                return;
            }
            
            emptyMsg.classList.add('hidden');
            cartContainer.innerHTML = cart.map((item, index) => `
                <div class="flex items-center gap-3 py-3 border-b border-gray-200">
                    <div class="flex-grow">
                        <span class="font-semibold block">${item.name}</span>
                        <span class="text-xs text-gray-500">מק"ט: ${item.sku}</span>
                    </div>
                    <input type="number" class="form-input cart-item-qty" value="${item.quantity}" min="1" onchange="updateCartQuantity('${item.sku}', this.value)">
                    <button class="p-1 text-red-500 hover:text-red-700" onclick="removeFromCart('${item.sku}')">
                        <i data-feather="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            totalItemsSummary.textContent = totalItems;
            mobileBadge.textContent = totalItems;
            mobileBadge.classList.remove('hidden');
            
            feather.replace();
        }

        window.updateCartQuantity = function(sku, newQuantity) {
            const qty = parseInt(newQuantity);
            const item = cart.find(i => i.sku === sku);
            
            if (item && qty > 0) {
                item.quantity = qty;
            } else if (item) {
                // הסר אם הכמות היא 0 או לא תקינה
                cart = cart.filter(i => i.sku !== sku);
            }
            renderCart();
        }

        window.removeFromCart = function(sku) {
            cart = cart.filter(i => i.sku !== sku);
            renderCart();
        }
        
        function sendOrder() {
            const customerName = document.getElementById('customer-name-input').value.trim();
            const projectName = document.getElementById('project-name-input').value.trim();
            const notes = document.getElementById('cart-notes').value.trim();
            const sendButton = document.getElementById('send-order-btn');

            if (cart.length === 0) {
                showToast("הסל ריק, אין מה לשלוח.", "error");
                return;
            }
            
            if (!customerName || !projectName) {
                showToast("חובה למלא שם מזמין ושם פרויקט.", "error");
                return;
            }
            
            const orderObject = {
                customerName: customerName,
                projectName: projectName,
                notes: notes,
                cartItems: cart // שולח את מערך הסל המלא
            };
            
            console.log("Sending order:", orderObject);
            toggleLoader(true, "שולח הזמנה...");
            sendButton.disabled = true;

            // קריאה ל-Apps Script ליצירת ההזמנה
            try {
                google.script.run
                    .withSuccessHandler(onOrderSuccess)
                    .withFailureHandler(onLoadError) // אפשר להשתמש באותה פונקציית שגיאה
                    .createOrder(orderObject); // קורא לפונקציה `createOrder` ב-Code.gs
            } catch (e) {
                onLoadError({ message: "שגיאה בשליחת ההזמנה: " + e.message });
            }
        }
        
        function onOrderSuccess(response) {
            toggleLoader(false);
            document.getElementById('send-order-btn').disabled = false;
            
            if (response.status === 'success') {
                console.log("Order created:", response.data);
                showToast(`הזמנה ${response.data.orderId} נשלחה בהצלחה!`, 'success');
                // איפוס
                cart = [];
                renderCart();
                document.getElementById('customer-name-input').value = '';
                document.getElementById('project-name-input').value = '';
                document.getElementById('cart-notes').value = '';
                toggleCart(false); // סגור סל במובייל
            } else {
                // אם ה-Apps Script החזיר שגיאה לוגית
                onLoadError({ message: response.error?.message || "שגיאה לא ידועה מהשרת" });
            }
        }

        // --- פונקציות עזר (UI) ---
        
        function toggleLoader(show, text = 'טוען נתונים...') {
            const loader = document.getElementById('loader-overlay');
            if (show) {
                loader.classList.add('open');
            } else {
                loader.classList.remove('open');
            }
        }

        function showToast(message, type = 'info') {
            const container = document.body; // ניצור טוסט פשוט
            const toast = document.createElement('div');
            toast.className = `fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-lg text-white font-semibold z-[101]`;
            toast.className += type === 'success' ? ' bg-green-500' : (type === 'error' ? ' bg-red-500' : ' bg-sky-800');
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.transition = 'opacity 0.5s ease';
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        window.toggleCart = function(forceOpen = null) {
            const cartSidebar = document.getElementById('cart-sidebar');
            if (forceOpen === true) {
                cartSidebar.classList.add('open');
            } else if (forceOpen === false) {
                cartSidebar.classList.remove('open');
            } else {
                cartSidebar.classList.toggle('open');
            }
        }
        
        // פונקציות מודאל תמונה
        window.showImageModal = function(imageUrl, productName) {
            event.stopPropagation(); // מנע לחיצה על הכרטיס
            document.getElementById('image-zoom-content').src = imageUrl;
            document.getElementById('image-zoom-modal-caption').textContent = productName;
            document.getElementById('image-zoom-modal').classList.add('open');
        }
        
        window.closeImageModal = function() {
            document.getElementById('image-zoom-modal').classList.remove('open');
        }
        
    </script>
</body>
</html>
