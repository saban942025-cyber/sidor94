<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Zebulun Delivery Portal â€“ Powered by H.Saban Materials</title>
    
    <!-- PWA & Mobile -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e5e5e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel.apple-touch-icon href="https://i.postimg.cc/ryPT3r29/image.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- ×”×’×“×¨×•×ª ×‘×¡×™×¡ ×•×¢×™×¦×•×‘ Glassmorphism --- */
        body {
            font-family: 'Rubik', 'Inter', sans-serif;
            background-image: linear-gradient(120deg, #f0f4f8 0%, #e5eaf1 100%);
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 1rem; /* 16px */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        
        .btn-primary {
            @apply bg-blue-600 text-white font-semibold py-3 px-5 rounded-lg shadow-md transition-all duration-200;
        }
        .btn-primary:hover {
            @apply bg-blue-700 shadow-lg;
        }
        .btn-primary:disabled {
            @apply bg-gray-400 cursor-not-allowed;
        }
        
        .btn-secondary {
            @apply bg-white text-gray-700 font-semibold py-3 px-5 rounded-lg shadow-sm border border-gray-200 transition-all duration-200;
        }
        .btn-secondary:hover {
            @apply bg-gray-50 shadow;
        }

        .form-input {
            @apply w-full px-4 py-3 rounded-lg border border-gray-300 bg-white/80 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }

        /* --- Modal (Popup) --- */
        .modal-overlay {
            @apply fixed inset-0 bg-black/50 backdrop-blur-sm z-40 transition-opacity duration-300;
        }
        .modal-content {
            @apply fixed bottom-0 left-0 right-0 w-full max-h-[85vh] bg-white p-5 rounded-t-2xl shadow-lg z-50 transition-transform duration-300;
            transform: translateY(100%);
        }
        .modal-visible .modal-overlay {
            @apply opacity-100;
        }
        .modal-visible .modal-content {
            transform: translateY(0);
        }
        .modal-hidden .modal-overlay {
            @apply opacity-0 pointer-events-none;
        }
        .modal-hidden .modal-content {
            transform: translateY(100%);
            pointer-events-none;
        }
        
        /* --- Toast (App Update) --- */
        #update-toast {
            @apply fixed bottom-5 left-1/2 -translate-x-1/2 bg-green-600 text-white py-3 px-6 rounded-full shadow-lg z-[100];
            transform: translateX(-50%) translateY(200%);
            transition: transform 0.4s ease-out;
        }
        #update-toast.show {
            transform: translateX(-50%) translateY(0);
        }
        
        /* --- Loader --- */
        #loader-overlay {
            @apply fixed inset-0 bg-white/80 backdrop-blur-sm z-[200] flex items-center justify-center;
        }
        .loader {
            @apply w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin;
        }
        
        /* --- Voice Guide --- */
        .voice-guide {
            @apply glass-card p-4 flex items-center justify-between;
        }
        
        /* --- Status Page --- */
        .status-dot {
            @apply w-3 h-3 rounded-full animate-pulse;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- App Wrapper -->
    <div class="max-w-lg mx-auto p-4 pt-6 space-y-6 min-h-screen">
        
        <!-- 1. Header with Dual Logos -->
        <header class="flex items-center justify-between space-x-4">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTcYS_xImwWt1fAYIK1UTXHtbCfmt5TOny5UQ&s" 
                 alt="×œ×•×’×• ×–×‘×•×œ×•×Ÿ ×¢×“×™×¨×Ÿ" class="h-16 w-auto object-contain bg-white rounded-lg p-1 shadow-sm"
                 onerror="this.src='https://placehold.co/150x60/f0f0f0/333?text=Zebulun+Logo'">
            
            <i data-feather="plus" class="text-gray-400"></i>
            
            <img src="https://i.postimg.cc/ryPT3r29/image.png" 
                 alt="×œ×•×’×• ×—.×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×Ÿ" class="h-16 w-auto object-contain"
                 onerror="this.src='https://placehold.co/150x60/f0f0f0/333?text=Saban+Logo'">
        </header>

        <!-- 2. Welcome Greeting -->
        <div class="text-center">
            <h1 id="greeting-text" class="text-3xl font-bold text-gray-800">×˜×•×¢×Ÿ...</h1>
            <p class="text-lg text-gray-600">×‘×¨×•×š ×”×‘× ×œ×¤×•×¨×˜×œ ×”×”×–×× ×•×ª ×”××™×©×™ ×©×œ×š</p>
        </div>

        <!-- 3. Project Buttons -->
        <section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">×”×¤×¨×•×™×§×˜×™× ×©×œ×š</h2>
            <div id="project-buttons" class="space-y-3">
                <!-- Buttons will be rendered here by JS -->
            </div>
            
            <!-- Add New Project Button -->
            <button onclick="openNewProjectModal()" class="w-full flex items-center justify-center py-4 px-5 rounded-lg border-2 border-dashed border-blue-400 text-blue-600 font-semibold transition hover:bg-blue-50">
                <i data-feather="plus" class="ml-2"></i>
                ×”×•×¡×¤×ª ×¤×¨×•×™×§×˜ / ××ª×¨ ×—×“×©
            </button>
        </section>

        <!-- 4. Order Status (Placeholder) -->
        <section class="space-y-3">
            <h2 class="text-xl font-semibold text-gray-700">×¡×˜×˜×•×¡ ×”×–×× ×•×ª ××—×¨×•× ×•×ª</h2>
            <div id="order-status-list" class="glass-card p-4 space-y-3">
                <p class="text-gray-600 text-center p-4">×˜×•×¢×Ÿ ×¡×˜×˜×•×¡ ×”×–×× ×•×ª...</p>
                <!-- Order status items will be rendered here -->
            </div>
        </section>

        <!-- 5. Voice Guide -->
        <section class="voice-guide">
            <div class="flex items-center space-x-3 space-x-reverse">
                <button onclick="playVoiceGuide()" class="p-3 bg-blue-100 rounded-full text-blue-600">
                    <i data-feather="play" class="w-5 h-5"></i>
                </button>
                <div>
                    <p class="font-semibold">×”×™×™ ×™×•×¡×™, ×¦×¨×™×š ×¢×–×¨×”?</p>
                    <p class="text-sm text-gray-600">×©××¢ ×¡×¨×˜×•×Ÿ ×”×“×¨×›×” ×§×¦×¨</p>
                </div>
            </div>
            <i data-feather="chevron-left" class="text-gray-500"></i>
        </section>
        
    </div>

    <!-- Modal (Popup) for Project Details -->
    <div id="project-modal" class="modal-hidden" onclick="closeModal()">
        <!-- Overlay -->
        <div class="modal-overlay"></div>
        
        <!-- Content -->
        <div class="modal-content" onclick="event.stopPropagation()">
            <!-- Handle -->
            <div class="w-16 h-1.5 bg-gray-300 rounded-full mx-auto mb-4"></div>
            
            <h2 id="modal-title" class="text-2xl font-bold text-gray-800 mb-5">×¤×¨×˜×™ ×¤×¨×•×™×§×˜</h2>
            
            <form id="modal-form" onsubmit="handleModalFormSubmit(event)" class="space-y-4">
                <input type="hidden" id="modal-project-id">
                
                <div>
                    <label for="modal-project-name" class="form-label">×©× ×”×¤×¨×•×™×§×˜/××ª×¨</label>
                    <input type="text" id="modal-project-name" class="form-input" placeholder="×œ×“×•×’××”: ×”× ×¨×§×™×¡×™× ×›×¤×¨ ×©××¨×™×”×•" required>
                </div>
                
                <div>
                    <label for="modal-project-address" class="form-label">×›×ª×•×‘×ª ××¡×¤×§×”</label>
                    <input type="text" id="modal-project-address" class="form-input" placeholder="×œ×“×•×’××”: ×”× ×¨×§×™×¡×™× 32, ×›×¤×¨ ×©××¨×™×”×•" required>
                </div>
                
                <div>
                    <label for="modal-project-contact" class="form-label">×”×•×¡×£ ××™×© ×§×©×¨ ×—×“×© (××•×¤×¦×™×•× ×œ×™)</label>
                    <input type="text" id="modal-project-contact" class="form-input" placeholder="×©× + ×˜×œ×¤×•×Ÿ (×œ×“×•×’××”: ×¢×‘×“ 050...)">
                </div>

                <div class="pt-4 flex flex-col sm:flex-row gap-3">
                    <button type="submit" id="modal-save-btn" class="btn-primary w-full">
                        ×©××™×¨×”
                    </button>
                    <button type="button" onclick="closeModal()" class="btn-secondary w-full">
                        ×‘×™×˜×•×œ
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Loader Overlay -->
    <div id="loader-overlay" class="hidden opacity-0 transition-opacity duration-300">
        <div class="loader"></div>
    </div>
    
    <!-- Update Toast -->
    <div id="update-toast">
        ×’×¨×¡×” ×—×“×©×” ×–××™× ×”! ğŸš€ ××¨×¢× ×Ÿ...
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc,
            updateDoc,
            collection,
            query,
            where,
            onSnapshot,
            arrayUnion,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- Firebase Config (Placeholder) ---
        const fallbackConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949",
          storageBucket: "saban94-78949.firebasestorage.app", 
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a", 
          measurementId: "G-XV6RZDESSB"
        };
        
        // --- Global App State ---
        let db, auth, currentUserId;
        let currentEditProjectId = null;
        
        // [×“×¨×™×©×” 2] × ×ª×•× ×™ ×”×¤×¨×•×™×§×˜×™× ×©×œ ×–×‘×•×œ×•×Ÿ ×¢×“×™×¨×Ÿ
        // ×× ×• × ×˜×¢×Ÿ ××•×ª× ×-Firestore ×‘××§×•× ×œ×”×˜××™×¢, ×›×“×™ ×œ××¤×©×¨ ×¢×¨×™×›×”
        let clientProjects = [];
        const CLIENT_ID = "zebulun-adiran"; // ××–×”×” ×™×™×—×•×“×™ ×œ×œ×§×•×— ×–×”

        // --- DOM Elements ---
        const greetingText = document.getElementById('greeting-text');
        const projectButtonsContainer = document.getElementById('project-buttons');
        const orderStatusList = document.getElementById('order-status-list');
        const modal = document.getElementById('project-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalForm = document.getElementById('modal-form');
        const modalProjectId = document.getElementById('modal-project-id');
        const modalProjectName = document.getElementById('modal-project-name');
        const modalProjectAddress = document.getElementById('modal-project-address');
        const modalProjectContact = document.getElementById('modal-project-contact');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const loader = document.getElementById('loader-overlay');
        const updateToast = document.getElementById('update-toast');

        // --- App Initialization ---
        
        function initFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(fallbackConfig));
                const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase Initialized.");
                
                authenticateUser();
            } catch (e) {
                console.error("Firebase Init Failed:", e);
                greetingText.innerText = "×©×’×™××ª ×”×ª×—×‘×¨×•×ª";
            }
        }
        
        async function authenticateUser() {
             onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log("User Signed In:", currentUserId);
                    // ××©×ª××© ××—×•×‘×¨, ×˜×¢×Ÿ ××ª ×”××¤×œ×™×§×¦×™×”
                    startApp();
                } else {
                    console.log("No user. Trying auth...");
                    try {
                        // × ×¡×” ×œ×”×ª×—×‘×¨ ×¢× ×˜×•×§×Ÿ ×§×™×™× ×× ×™×©
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            // ×× ×œ×, ×”×ª×—×‘×¨ ×›××•×¨×—
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth Error:", error);
                        greetingText.innerText = "×©×’×™××ª ××™××•×ª";
                    }
                }
            });
        }

        // --- Core App Logic ---
        
        function startApp() {
            console.log("Starting App...");
            setGreeting();
            registerSW();
            
            // ×˜×¢×™× ×” ×¨××©×•× ×™×ª ×©×œ ×”×¤×¨×•×™×§×˜×™× ×•×”×”×–×× ×•×ª
            // ×‘××§×•× ×”× ×ª×•× ×™× ×”×§×©×™×—×™×, ×× ×• × ××–×™×Ÿ ×œ×¤×¨×•×™×§×˜×™× ×©×œ ×”×œ×§×•×—
            listenForClientProjects();
            listenForClientOrders();
        }

        // [×“×¨×™×©×” 2] ×‘×¨×›×ª ×¤×ª×™×—×” ×œ×¤×™ ×©×¢×”
        function setGreeting() {
            const hour = new Date().getHours();
            let greeting = "×‘×¨×•×š ×”×‘×, ×™×•×¡×™";
            if (hour < 5) {
                greeting = "×œ×™×œ×” ×˜×•×‘, ×™×•×¡×™";
            } else if (hour < 12) {
                greeting = "×‘×•×§×¨ ×˜×•×‘, ×™×•×¡×™";
            } else if (hour < 17) {
                greeting = "×¦×”×¨×™×™× ×˜×•×‘×™×, ×™×•×¡×™";
            } else {
                greeting = "×¢×¨×‘ ×˜×•×‘, ×™×•×¡×™";
            }
            greetingText.innerText = greeting;
        }

        // [×“×¨×™×©×” 2] ×˜×¢×™× ×ª ×›×¤×ª×•×¨×™ ×¤×¨×•×™×§×˜×™×
        function listenForClientProjects() {
            // ×××–×™× ×™× ×œ×›×œ ×”××¡××›×™× ×‘×§×•×œ×§×¦×™×™×ª 'customers' 
            // ×©×©×™×™×›×™× ×œ-"×–×‘×•×œ×•×Ÿ ×¢×“×™×¨×Ÿ" (×œ×¤×™ ×©×“×” ××–×”×” ×©× ×§×‘×¢)
            // (×”×¢×¨×”: ×œ×©× ×”×“×’××”, ×× ×• ××©×ª××©×™× ×‘× ×ª×•× ×™× ×”×§×©×™×—×™×. ×œ××¤×œ×™×§×¦×™×” ×××™×ª×™×ª, × ×—×œ×™×£ ××ª clientProjects ×‘-snapshot)
            
            // --- ×©×™××•×© ×‘× ×ª×•× ×™× ×”×§×©×™×—×™× ×©×”×•×–× ×• ---
             clientProjects = [
              { id: "2sxMp0ibOvAkiaoKvnzQ", name: "×–×‘×•×œ×•×Ÿ-×¢×“×™×¨×Ÿ/×“×”×‘× ×™", address: "×”×’×“×¨×•×ª 39, ×¡×‘×™×•×Ÿ", customerNumber: "5020317" },
              { id: "av14sJE9GzgnVbqzH96H", name: "×–×‘×•×œ×•×Ÿ-×¢×“×™×¨×Ÿ/×—×“×“", address: "×•×™× ×’×™×™×˜ 27, ×›×¤×¨ ×©××¨×™×”×•", customerNumber: "5020321" },
              { id: "LOxXKT1a2khZYbAASRlV", name: "×–×‘×•×œ×•×Ÿ-×¢×“×™×¨×Ÿ/×—×’'×’'", address: "×”× ×¨×§×™×¡×™× 32, ×›×¤×¨ ×©××¨×™×”×•", customerNumber: "#620001" },
              { id: "mhlqAx6RXIUuGnrbSToT", name: "×–×‘×•×œ×•×Ÿ-×¢×“×™×¨×Ÿ/×¡××“×¨×™", address: "× ×™×¦× ×™× 20, ×›×¤×¨ ×¡×‘×", customerNumber: "620003" }
            ];
            renderProjectButtons();

            // --- ×“×•×’××” ×œ×§×•×“ ×××™×ª×™ ×©×™×—×œ×™×£ ××ª ×–×” ---
            // const q = query(collection(db, "customers"), where("clientGroup", "==", CLIENT_ID));
            // onSnapshot(q, (snapshot) => {
            //     clientProjects = [];
            //     snapshot.forEach(doc => clientProjects.push({ id: doc.id, ...doc.data() }));
            //     renderProjectButtons();
            // }, (error) => {
            //     console.error("Error fetching projects:", error);
            //     projectButtonsContainer.innerHTML = `<p class="text-red-500">×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×•×™×§×˜×™×.</p>`;
            // });
        }

        function renderProjectButtons() {
            projectButtonsContainer.innerHTML = ''; // × ×§×” ×›×¤×ª×•×¨×™× ×§×™×™××™×
            if (clientProjects.length === 0) {
                projectButtonsContainer.innerHTML = `<p class="text-gray-500 text-center">×¢×“×™×™×Ÿ ×œ× ×”×•×’×“×¨×• ×¤×¨×•×™×§×˜×™×.</p>`;
                return;
            }
            
            clientProjects.forEach(project => {
                const button = document.createElement('button');
                button.className = "glass-card w-full p-4 text-right flex justify-between items-center transition hover:shadow-md";
                // ×”×©× ×™×•×¦×’ ×œ×œ× ×”×§×™×“×•××ª "×–×‘×•×œ×•×Ÿ-×¢×“×™×¨×Ÿ/"
                const displayName = project.name.replace('×–×‘×•×œ×•×Ÿ-×¢×“×™×¨×Ÿ/', '');
                
                button.innerHTML = `
                    <div>
                        <span class="text-lg font-semibold text-gray-800">${displayName}</span>
                        <p class="text-sm text-gray-600">${project.address}</p>
                    </div>
                    <i data-feather="edit-2" class="w-5 h-5 text-blue-600"></i>
                `;
                button.onclick = () => openProjectModal(project.id);
                projectButtonsContainer.appendChild(button);
            });
            feather.replace();
        }
        
        // [×“×¨×™×©×” 4] ×˜×¢×™× ×ª ×¡×˜×˜×•×¡ ×”×–×× ×•×ª
        function listenForClientOrders() {
            // ×˜×•×¢×Ÿ ××ª 5 ×”×”×–×× ×•×ª ×”××—×¨×•× ×•×ª ×©××©×•×™×›×•×ª ×œ××–×”×™× ×©×œ ×”×œ×§×•×—
            const projectCustomerNumbers = clientProjects.map(p => p.customerNumber).filter(Boolean);
            if (projectCustomerNumbers.length === 0) {
                orderStatusList.innerHTML = `<p class="text-gray-500 text-center p-4">××™×Ÿ ×¤×¨×•×™×§×˜×™× ×œ×”×¦×’×ª ×”×–×× ×•×ª.</p>`;
                return;
            }

            const q = query(
                collection(db, "orders"), 
                where("customer.customerNumber", "in", projectCustomerNumbers),
                orderBy("createdAt", "desc"),
                limit(5)
            );

            onSnapshot(q, (snapshot) => {
                orderStatusList.innerHTML = '';
                if (snapshot.empty) {
                    orderStatusList.innerHTML = `<p class="text-gray-500 text-center p-4">××™×Ÿ ×”×–×× ×•×ª ××—×¨×•× ×•×ª.</p>`;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const order = doc.data();
                    const statusColors = {
                        '×—×“×©': 'bg-blue-500',
                        '×‘×˜×™×¤×•×œ': 'bg-yellow-500',
                        '×©×•×™×š': 'bg-purple-500',
                        '×‘×“×¨×š': 'bg-green-500',
                        '×”×•×©×œ×': 'bg-gray-500',
                        '×‘×•×˜×œ': 'bg-red-500'
                    };
                    const statusColor = statusColors[order.status] || 'bg-gray-400';
                    const orderEl = document.createElement('div');
                    orderEl.className = "flex items-center justify-between p-3";
                    orderEl.innerHTML = `
                        <div class="flex items-center space-x-3 space-x-reverse">
                            <span class="status-dot ${statusColor}"></span>
                            <div>
                                <p class="font-semibold">${order.address}</p>
                                <p class="text-sm text-gray-600">××¡' ${order.order_id || doc.id.slice(0,6)}</p>
                            </div>
                        </div>
                        <span class="font-semibold text-sm">${order.status}</span>
                    `;
                    orderStatusList.appendChild(orderEl);
                });

            }, (error) => {
                console.error("Error fetching orders:", error);
                orderStatusList.innerHTML = `<p class="text-red-500 text-center p-4">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×–×× ×•×ª.</p>`;
            });
        }
        
        // [×“×¨×™×©×” 5] ×”×“×¨×›×” ×§×•×œ×™×ª (×¤×œ×™×™×¡×”×•×œ×“×¨)
        function playVoiceGuide() {
            console.log("Playing voice guide...");
            // Placeholder: ×”×©××¢×ª ×§×•×‘×¥ ××•×“×™×•
            const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
            audio.play();
            alert("×× ×’×Ÿ ×”×“×¨×›×” ×§×•×œ×™×ª (×“××•)...");
        }
        window.playVoiceGuide = playVoiceGuide; // ×—×©×™×¤×” ×œ-HTML

        // --- Modal (Popup) Functions ---
        
        window.openProjectModal = (projectId) => {
            const project = clientProjects.find(p => p.id === projectId);
            if (!project) {
                alert("×©×’×™××”: ×”×¤×¨×•×™×§×˜ ×œ× × ××¦×");
                return;
            }
            
            currentEditProjectId = project.id;
            modalTitle.innerText = "×¢×¨×™×›×ª ×¤×¨×˜×™ ×¤×¨×•×™×§×˜";
            modalProjectName.value = project.name.replace('×–×‘×•×œ×•×Ÿ-×¢×“×™×¨×Ÿ/', '');
            modalProjectAddress.value = project.address;
            modalProjectContact.value = ''; // × ×§×” ×©×“×” ×œ×”×•×¡×¤×ª ××™×© ×§×©×¨ ×—×“×©
            modalSaveBtn.innerText = "×¢×“×›×Ÿ ×¤×¨×•×™×§×˜";
            
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
        }

        window.openNewProjectModal = () => {
            currentEditProjectId = null;
            modalTitle.innerText = "×”×•×¡×¤×ª ×¤×¨×•×™×§×˜ ×—×“×©";
            modalProjectName.value = '';
            modalProjectAddress.value = '';
            modalProjectContact.value = '';
            modalSaveBtn.innerText = "×¦×•×¨ ×¤×¨×•×™×§×˜";
            
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
        }
        
        window.closeModal = () => {
            modal.classList.add('modal-hidden');
            modal.classList.remove('modal-visible');
        }
        
        window.handleModalFormSubmit = async (event) => {
            event.preventDefault();
            loader.classList.remove('hidden');
            loader.classList.remove('opacity-0');
            
            const data = {
                name: modalProjectName.value,
                defaultAddress: modalProjectAddress.value,
                newContact: modalProjectContact.value.trim()
            };
            
            try {
                if (currentEditProjectId) {
                    // --- ×¢×“×›×•×Ÿ ×¤×¨×•×™×§×˜ ×§×™×™× ---
                    const docRef = doc(db, "customers", currentEditProjectId);
                    const updateData = {
                        defaultAddress: data.defaultAddress,
                        // ×¢×“×›×•×Ÿ ×”×©× (×× ×¨×•×¦×™× ×œ××¤×©×¨)
                        // name: `×–×‘×•×œ×•×Ÿ-×¢×“×™×¨×Ÿ/${data.name}`
                    };
                    
                    // ×”×•×¡×¤×ª ××™×© ×§×©×¨ ×—×“×© ×œ××¢×¨×š (×× ×”×•×–×Ÿ)
                    if (data.newContact) {
                        updateData.contactPeople = arrayUnion(data.newContact); // ×“×•×¨×© ×”×’×“×¨×” ×©×œ ×”×©×“×” ×‘-Firestore
                    }
                    
                    await updateDoc(docRef, updateData);
                    console.log("Project Updated:", currentEditProjectId);
                } else {
                    // --- ×™×¦×™×¨×ª ×¤×¨×•×™×§×˜ ×—×“×© ---
                    const newProjectData = {
                        name: `×–×‘×•×œ×•×Ÿ-×¢×“×™×¨×Ÿ/${data.name}`,
                        defaultAddress: data.defaultAddress,
                        contactPeople: data.newContact ? [data.newContact] : [],
                        clientGroup: CLIENT_ID, // ×©×™×•×š ×œ×œ×§×•×— "×–×‘×•×œ×•×Ÿ ×¢×“×™×¨×Ÿ"
                        createdAt: serverTimestamp()
                    };
                    
                    const docRef = await addDoc(collection(db, "customers"), newProjectData);
                    console.log("New Project Created:", docRef.id);
                }
                
                closeModal();
                // ×”-onSnapshot ×©×œ listenForClientProjects ×™×¨×¢× ×Ÿ ××ª ×”×›×¤×ª×•×¨×™× ××•×˜×•××˜×™×ª
                
            } catch (error) {
                console.error("Error saving project:", error);
                alert("×©×’×™××” ×‘×©××™×¨×ª ×”×¤×¨×•×™×§×˜. ×‘×“×•×§ ×”×¨×©××•×ª Firestore.");
            } finally {
                loader.classList.add('hidden');
                loader.classList.add('opacity-0');
            }
        }
        
        // --- PWA Service Worker ---
        
        function registerSW() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker ×¨×©×•×:', registration);
                        
                        // ×”××–× ×” ×œ×”×•×“×¢×•×ª ××”-SW
                        navigator.serviceWorker.addEventListener('message', event => {
                            if (event.data && event.data.type === 'APP_UPDATED') {
                                console.log(`[PWA] ×’×¨×¡×” ×—×“×©×” ${event.data.version} ×”×•×ª×§× ×”.`);
                                showUpdateToast();
                                setTimeout(() => window.location.reload(), 3000);
                            }
                        });
                    })
                    .catch((error) => {
                        console.error('Service Worker ×¨×™×©×•× × ×›×©×œ:', error);
                    });

                // ×‘×“×™×§×” ×× ×™×© ×¢×“×›×•×Ÿ
                navigator.serviceWorker.ready.then((registration) => {
                    if (registration.waiting) {
                        // ×™×© SW ×—×“×© ×©×××ª×™×Ÿ, ×”×¤×¢×œ ××•×ª×•
                         registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                    }
                     registration.update();
                });
            }
        }
        
        function showUpdateToast() {
            updateToast.classList.add('show');
        }

        // --- ×”×ª×—×œ×ª ×”××¤×œ×™×§×¦×™×” ---
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            initFirebase();
        });

    </script>
</body>
</html>
