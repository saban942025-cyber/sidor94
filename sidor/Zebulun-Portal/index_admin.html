<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Zebulun Portal v55 (Fix)</title>
    <!-- 
      Zebulun CRM Portal v55 (Fixes)
      
      Changelog:
      - [FIX v55.1]: 
        - שיפור Error Handling בפונקציה fetchCatalogData
          כדי לטפל בשגיאות JSON מ-Apps Script.
      - [NEW v55]:
        - הוספת מסך "הזמנות לאישור" (Pending Orders)
        - הוספת Workbench לאישור בקשות מהשטח
        - הוספת יכולת "שתף לינק התקנה" למנהלי אתרים
      - [FIX v54.2]:
        - תיקון Firebase config fallback
        - הוספת import-ים חסרים של Firestore ו-Auth
    -->
    
    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href="manifest.json">
<!-- ... existing code ... -->
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme) {
                setTheme(storedTheme);
            } else {
                setTheme(window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            }
            
            navigate('dashboard'); // קבע דף ראשוני
        }

        function initFirebase() {
            try {
                // [FIX v54.2] Fallback config
                const fallbackConfig = {
                    apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
                    authDomain: "saban94-78949.firebaseapp.com", 
                    projectId: "saban94-78949",
                    storageBucket: "saban94-78949.appspot.com", 
                    messagingSenderId: "41553157903", 
                    appId: "1:41553157903:web:cc33d252cff023be97a87a"
                };
                
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config) 
                    : fallbackConfig;

                const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                
                // setLogLevel('debug'); // בטל הערה זו לניפוי באגים מורחב
                console.log("Firebase Initialized.");
                authenticateUser();
            } catch (error) {
                console.error("Firebase Init Error:", error);
                showToast("שגיאת התחברות קריטית ל-Firebase", "error");
                document.getElementById('loader-text').innerText = "שגיאת התחברות";
            }
        }

        function initEventListeners() {
<!-- ... existing code ... -->
        
        async function fetchCatalogData() {
            if (state.catalogData.length > 0) return state.catalogData; // Return cached data

            try {
                const response = await fetch(CATALOG_SCRIPT_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // [FIX v55.1] Add robust JSON parsing with error handling
                const textData = await response.text();
                try {
                    const data = JSON.parse(textData);
                    state.catalogData = data;
                    return data;
                } catch (parseError) {
                    console.error("Failed to parse catalog JSON:", parseError);
                    console.error("Received text:", textData); // Log the problematic text
                    
                    // Check if the error is the expected one from Google Apps Script
                    if (textData.includes("This script must be deployed as a web app")) {
                         showToast("שגיאת קטלוג: יש לבדוק הרשאות ב-Apps Script", "error");
                         console.error("---!!! קטלוג Apps Script Error !!!---");
                         console.error("הסקריפט לא מוגדר כ-Deployment נכון.");
                         console.error("1. פתח את פרויקט Apps Script.");
                         console.error("2. לחץ על 'Deploy' -> 'Manage Deployments'.");
                         console.error("3. ערוך את ה-Deployment הפעיל.");
                         console.error("4. שנה את 'Who has access' ל-'Anyone'.");
                         console.error("----------------------------------------");
                    } else {
                         showToast("שגיאה בטעינת הקטלוג (פורמט לא תקין)", "error");
                    }
                    throw new Error("Invalid JSON response from catalog script.");
                }

            } catch (error) {
                console.error("Failed to load catalog:", error);
                if (!error.message.includes("Invalid JSON")) { // Avoid double-toast
                    showToast("שגיאה בטעינת הקטלוג", "error");
                }
                return []; // Return empty array on failure
            }
