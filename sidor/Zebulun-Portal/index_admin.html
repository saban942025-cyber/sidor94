<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v37 (Catalog Integrated)</title>
    
    <!-- ... (קיים Head, Tailwind, Leaflet, Icons, Fonts) ... -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* ... (כל ה-CSS הקיים של index_admin.html) ... */
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
            --text-dark: #1f2937; /* gray-800 */
            --text-light: #6b7280; /* gray-500 */
            --text-dark-nav: #d1d5db; /* gray-300 */
            --bg-dark-nav: #1f2937; /* slate-800 */
            --bg-dark-nav-hover: #374151; /* slate-700 */
        }
        body {
            font-family: 'Inter', 'Arial', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            overflow: hidden;
        }
        .app-layout { display: grid; grid-template-columns: auto 1fr; height: 100vh; }
        .app-view { width: 100%; height: 100vh; overflow: hidden; display: none; }
        .app-view.active { display: block; }
        #view-dashboard { display: grid; grid-template-columns: 1fr 350px; overflow: hidden; }
        .app-view.active#view-dashboard { display: grid; }
        #view-history { overflow-y: auto; padding: 1rem 2rem; }
        #view-driver-history { display: grid; grid-template-columns: 300px 1fr; height: 100vh; }
        .app-view.active#view-driver-history { display: grid; }
        #map-container { position: relative; background-color: #e0e0e0; }
        #map { height: 100%; width: 100%; }
        #side-panel { background-color: var(--bg-white); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; height: 100%; }
        #navbar { background-color: var(--bg-dark-nav); border-left: 1px solid var(--border-color); color: white; z-index: 10; }
        #navbar .text-xl { color: white; }
        .nav-link { transition: all 0.2s; color: var(--text-dark-nav); position: relative; }
        .nav-link:hover { background-color: var(--bg-dark-nav-hover); color: white; }
        .nav-link.active { background-color: var(--primary-color); color: white; border-right: 3px solid #60a5fa; }
        .nav-link-special { color: var(--text-dark-nav); background-color: var(--bg-dark-nav-hover); }
        .nav-link-special:hover { background-color: var(--primary-color); color: white; }
        #navbar .hidden.lg\\:block { color: white; }
        #navbar #last-updated { color: var(--text-light); }
        #log-button { display: inline-block; float: left; margin-top: 4px; color: var(--text-light); }
        #log-button:hover { color: white; }
        #side-panel-lists { flex: 1; overflow-y: auto; position: relative; }
        .panel-list { overflow-y: auto; position: relative; }
        .order-card, .driver-card { padding: 1rem; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; cursor: pointer; }
        .order-card:hover, .driver-card:hover { background-color: #fafafa; }
        .order-card.active, .driver-card.active { background-color: #eff6ff; border-right: 3px solid var(--primary-color); }
        .order-card .font-bold { color: var(--primary-dark); }
        #details-panel { height: 300px; overflow-y: auto; border-top: 2px solid var(--border-color); background: #fdfdfd; padding: 1rem; display: none; position: relative; }
        #details-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        #details-panel h4 { font-weight: 700; color: var(--text-dark); }
        #details-panel ul { list-style-type: none; padding: 0; margin: 0; }
        #details-panel li { font-size: 0.9rem; margin-bottom: 4px; color: var(--text-light); }
        #details-panel .status-line { display: flex; align-items: center; gap: 0.5rem; }
        #details-panel li .dist { font-weight: 500; color: var(--text-dark); display: inline-block; min-width: 60px; text-align: left; }
        #details-close-btn, #details-copy-link-btn { cursor: pointer; color: var(--text-light); }
        #details-close-btn:hover, #details-copy-link-btn:hover { color: var(--text-dark); }
        .status-change-btn { background: none; border: none; color: var(--primary-color); font-size: 0.8rem; font-weight: 500; cursor: pointer; padding: 2px 4px; border-radius: 4px; }
        .status-change-btn:hover { background-color: #eff6ff; color: var(--primary-dark); }
        #view-history .tab-button { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; color: var(--text-light); }
        #view-history .tab-button.active { border-bottom-color: var(--primary-color); color: var(--primary-color); }
        .history-table tbody tr:hover, .customer-table tbody tr:hover { background-color: #f9fafb; }
        .customer-table tbody tr:hover { cursor: pointer; }
        .history-table .action-button { background-color: var(--primary-color); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; margin-left: 4px; }
        .history-table .action-button:hover { background-color: var(--primary-dark); }
        .history-table .action-button-secondary { background-color: var(--text-light); }
        .history-table .action-button-secondary:hover { background-color: var(--text-dark); }
        #driver-history-sidebar { background-color: var(--bg-white); border-left: 1px solid var(--border-color); padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        #driver-history-map { background-color: #e0e0e0; position: relative; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-active { background-color: #22c55e; }
        .status-stuck { background-color: #ef4444; }
        .status-inactive { background-color: #9ca3af; }
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { margin: 13px 20px; font-family: 'Inter', sans-serif; }
        .leaflet-popup-content h4 { font-weight: 700; margin-bottom: 8px; }
        .leaflet-popup-content p { margin: 4px 0; color: var(--text-light); }
        .loader-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; z-index: 10; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 5000; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 12px 20px; background-color: var(--text-dark); color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: all 0.3s ease; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: #22c55e; }
        .toast.error { background-color: #ef4444; }
        #new-order-modal, #customer-edit-modal { max-width: 600px; border-radius: 12px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 0; }
        #new-order-modal::backdrop, #customer-edit-modal::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }

        /* [NEW v37] Catalog & Cart Styles */
        #new-order-modal {
            max-width: 900px; /* Make modal wider for catalog */
        }
        .catalog-layout {
            display: grid;
            grid-template-columns: 2fr 1fr; /* 2/3 for catalog, 1/3 for cart */
            gap: 1.5rem;
            max-height: 70vh;
            overflow: hidden;
        }
        #catalog-main {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #catalog-results-container {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background: var(--bg-light);
            padding: 0.5rem;
        }
        .product-card-admin {
            display: flex;
            gap: 0.75rem;
            background-color: var(--bg-white);
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }
        .product-card-admin:hover {
            border-color: var(--primary-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .product-card-admin img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.375rem;
            border: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .product-card-info {
            flex-grow: 1;
            min-width: 0; /* Fix for flex truncation */
        }
        .product-card-info h5 {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .product-card-info p {
            font-size: 0.8rem;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .product-card-admin .btn {
            padding: 0.5rem;
            flex-shrink: 0;
        }
        
        #cart-sidebar {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background-color: var(--bg-white);
        }
        #order-cart-ui {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0.75rem;
        }
        .cart-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
        .cart-item-info {
            flex-grow: 1;
            min-width: 0;
        }
        .cart-item-info span {
            display: block;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .cart-item-info p {
            font-size: 0.75rem;
            color: var(--text-light);
        }
        .cart-item-qty {
            width: 70px;
            padding: 0.25rem 0.5rem;
            text-align: center;
        }
        .cart-item .btn-icon {
            padding: 0.25rem;
            color: var(--danger);
        }
        .cart-summary {
            padding: 1rem;
            border-top: 2px solid var(--border-color);
            background-color: var(--bg-light);
            flex-shrink: 0;
        }
        .cart-summary p {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Responsive for modal */
        @media (max-width: 768px) {
            #new-order-modal {
                max-width: 95vw;
            }
            .catalog-layout {
                grid-template-columns: 1fr; /* Stack on mobile */
                max-height: 80vh;
            }
            #cart-sidebar {
                max-height: 200px; /* Limit cart height */
            }
        }
        
        @media (max-width: 1024px) {
            #view-dashboard { grid-template-columns: 1fr; }
            #side-panel { position: fixed; bottom: 0; left: 0; right: 0; height: 40vh; z-index: 2000; border-right: none; border-top: 1px solid var(--border-color); transform: translateY(100%); transition: transform 0.3s ease; }
            #side-panel.open { transform: translateY(0); }
            #navbar { display: flex; width: 100%; z-index: 2001; border-left: none; border-bottom: 1px solid var(--border-color); }
            .app-layout { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            .nav-link { flex: 1; justify-content: center; }
            .nav-link span.hidden { display: none; }
            .nav-link.active { border-right: none; border-bottom: 3px solid var(--primary-color); }
            #details-panel { height: 200px; }
            #view-driver-history { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            #driver-history-sidebar { grid-row: 1 / 2; border-left: none; border-bottom: 1px solid var(--border-color); }
            #driver-history-map { grid-row: 2 / 3; }
        }
    </style>
</head>
<body class="antialiased">

    <!-- (כל ה-HTML הקיים של Navbar ו-Views) -->
    <!-- ... -->
    <nav id="navbar" class="w-20 lg:w-64 flex flex-col p-4 space-y-4">
        <!-- ... (כל כפתורי הניווט הקיימים) ... -->
        <a href="#" class="nav-link" onclick="openNewOrderForm()">
            <i data-feather="plus-circle" class="w-6 h-6"></i>
            <span class="font-semibold text-lg hidden lg:block">הזמנה חדשה</span>
        </a>
        <!-- ... -->
    </nav>
    <!-- ... -->
    <!-- (כל שאר ה-HTML הקיים) -->
    <!-- ... -->


    <!-- New Order Modal (עם שדות משודרגים) -->
    <dialog id="new-order-modal">
        <form onsubmit="submitNewOrder(event)">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold">יצירת הזמנה חדשה (מקטלוג)</h3>
                <button type="button" class="text-gray-500 hover:text-gray-800" onclick="closeNewOrderForm()">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <!-- [NEW v37] Catalog Layout -->
            <div class="catalog-layout p-6">
                
                <!-- Main Catalog View -->
                <div id="catalog-main">
                    <!-- Customer Search (Existing) -->
                    <div>
                        <label for="customer-search" class="block text-sm font-medium mb-1">חפש לקוח קיים</label>
                        <input type="text" id="customer-search" list="customer-list" class="w-full p-2 border rounded-md" oninput="handleCustomerSearch(this.value)" autocomplete="off">
                        <datalist id="customer-list"></datalist>
                    </div>
                    <!-- Existing Customer Display (Hidden by default) -->
                    <div id="existing-customer-display" class="p-3 my-2 bg-gray-50 border rounded-lg" style="display: none;">
                        <input type="hidden" id="customer-id-existing">
                        <p class="text-sm"><strong>לקוח:</strong> <span id="customer-name-display"></span> <span id="customer-number-display" class="text-xs text-gray-500"></span></p>
                        <p class="text-sm"><strong>כתובת:</strong> <span id="customer-address-display"></span></p>
                    </div>
                    
                    <!-- Catalog Search -->
                    <div class="mt-4">
                        <label for="catalog-search-input" class="block text-sm font-medium mb-1">חפש בקטלוג</label>
                        <input type="text" id="catalog-search-input" class="w-full p-2 border rounded-md" placeholder="הקלד שם מוצר, מק'ט או כינוי..." onkeyup="renderAdminCatalogSearch(this.value)">
                    </div>
                    
                    <!-- Catalog Results -->
                    <div id="catalog-results-container" class="mt-2">
                        <!-- Product cards will be injected here by JS -->
                        <div class="p-4 text-center text-gray-400">טוען קטלוג...</div>
                    </div>
                </div>
                
                <!-- Cart Sidebar -->
                <aside id="cart-sidebar">
                    <h4 class="text-lg font-semibold p-3 border-b">סל קניות</h4>
                    <div id="order-cart-ui" class="no-scrollbar">
                        <!-- Cart items will be injected here by JS -->
                        <p class="p-4 text-sm text-gray-400 text-center">הסל ריק.</p>
                    </div>
                    <div class="cart-summary">
                        <p>סה"כ פריטים: <span id="cart-total-items">0</span></p>
                        <!-- <p>סה"כ: <span id="cart-total-price">₪0.00</span></p> -->
                        <div class="mt-4">
                            <label for="order-notes" class="block text-sm font-medium mb-1">הערות להזמנה</label>
                            <textarea id="order-notes" rows="2" placeholder="הערות מנהל..." class="w-full p-2 border rounded-md"></textarea>
                        </div>
                    </div>
                </aside>
                
            </div>
            
            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-3 space-x-reverse">
                <button type="button" class="px-4 py-2 bg-white border rounded-md hover:bg-gray-50" onclick="closeNewOrderForm()">
                    ביטול
                </button>
                <button type="submit" id="submit-order-btn" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                    צור ושתף ב-WhatsApp
                </button>
            </div>
        </form>
    </dialog>
    
    <!-- (שאר המודאלים הקיימים, כמו customer-edit-modal) -->
    <!-- ... -->


    <!-- 
      ==========================================================
      ===               תחילת סקריפט ראשי (v37)              ===
      ==========================================================
    -->
    <script type="module">
        // --- Inlined Firebase SDK Imports ---
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        // ... (כל הייבואים הקיימים של auth ו-firestore) ...
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, 
            collection, query, where, Timestamp, runTransaction, getDocs, orderBy, 
            serverTimestamp, limit, writeBatch, collectionGroup, arrayUnion
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";


        // --- [NEW v37] Global Var for Catalog API ---
        // !!! אחי, שים לב !!!
        // עליך להדביק כאן את כתובת ה-Web App שקיבלת לאחר פרסום Code.gs
        const CATALOG_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwzQluyFKrFWoLZ1Q0Y5hcwfErB0FTLMM8cbFf35GzzVIOuVCvMRTlD0FAEKZ2OUbGL/exec"; 


        // --- (כל המשתנים הגלובליים הקיימים) ---
        let db, auth;
        let map, driverHistoryMap;
        let allOrders = [];
        let allCustomers = [];
        let allDrivers = [];
        // ... (וכו') ...
        let currentUserId = null;
        
        // --- [NEW v37] Catalog State ---
        let adminCatalog = []; // יכיל את כל המוצרים מהקטלוג
        let adminCart = []; // יכיל את סל הקניות הנוכחי

        
        // --- (כל קוד האתחול הקיים) ---
        const fallbackConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949",
          storageBucket: "saban94-78949.firebasestorage.app", 
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a", 
          measurementId: "G-XV6RZDESSB"
        };
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(fallbackConfig));
        // ... (המשך קוד האתחול) ...
        
        try {
            const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');
            // ... (המשך קוד האתחול) ...
        } catch (e) {
            // ... (טיפול בשגיאות) ...
        }

        // --- (כל הפונקציות הקיימות: SmartLog, initializeApplication, initializeMaps, וכו') ---
        // ...
        
        
        // --- [NEW v37] Catalog Functions ---
        
        /**
         * טוען את נתוני הקטלוג מה-Apps Script API
         * (הדרישה שלך)
         */
        async function fetchAdminCatalog() {
            if (adminCatalog.length > 0) return; // טען רק פעם אחת
            if (CATALOG_WEB_APP_URL.includes("---")) {
                showToast("שגיאת הגדרה: יש להזין כתובת API של קטלוג", "error");
                return;
            }

            console.log("טוען קטלוג מ-Apps Script...");
            try {
                const response = await fetch(CATALOG_WEB_APP_URL);
                if (!response.ok) {
                    throw new Error(`Catalog API returned status ${response.status}`);
                }
                const text = await response.text(); // קודם נקבל טקסט

                // ננסה לפענח JSON
                try {
                    const result = JSON.parse(text);
                    if (result.status === 'success' && Array.isArray(result.data)) {
                        adminCatalog = result.data;
                        console.log(`קטלוג נטען בהצלחה: ${adminCatalog.length} מוצרים.`);
                        renderAdminCatalogSearch(""); // רנדר ראשוני של כל המוצרים
                    } else {
                        throw new Error(result.error?.message || "Invalid JSON structure");
                    }
                } catch (jsonError) {
                    // [דרישה 5] הדפסת הודעת השגיאה הברורה בעברית
                    console.error("========================================================");
                    console.error("אחי, שגיאה קריטית בטעינת הקטלוג (שגיאת JSON):", jsonError.message);
                    console.error("השרת החזיר טקסט שמתחיל ב:", text.substring(0, 100) + "...");
                    console.error("זו כנראה *לא* בעיה בקוד הזה, אלא בהגדרות ה-Deployment של ה-Apps Script שלך.");
                    console.error("אנא ודא שהסקריפט שלך מוגדר לגישה: 'Anyone'.");
                    console.error("========================================================");
                    showToast("שגיאה חמורה בטעינת קטלוג. בדוק Console.", "error");
                    document.getElementById('catalog-results-container').innerHTML = `<p class="p-4 text-red-500">שגיאה בטעינת הקטלוג. בדוק הגדרות Apps Script.</p>`;
                }

            } catch (fetchError) {
                console.error("Failed to fetch catalog (Network/Fetch error):", fetchError);
                showToast("שגיאת רשת בטעינת הקטלוג", "error");
            }
        }
        
        /**
         * מסנן ומרנדר את תוצאות חיפוש הקטלוג
         * (הדרישה שלך)
         */
        function renderAdminCatalogSearch(query) {
            const container = document.getElementById('catalog-results-container');
            const q = query.toLowerCase().trim();
            
            const results = adminCatalog.filter(product => {
                if (!q) return true; // הצג הכל אם החיפוש ריק
                return (product.name.toLowerCase().includes(q) ||
                        product.sku.toLowerCase().includes(q) ||
                        product.aliases.some(alias => alias.toLowerCase().includes(q)));
            }).slice(0, 50); // הגבל ל-50 תוצאות
            
            if (results.length === 0) {
                container.innerHTML = `<p class="p-4 text-center text-gray-400">לא נמצאו מוצרים תואמים.</p>`;
                return;
            }

            container.innerHTML = results.map(product => `
                <div class="product-card-admin">
                    <img src="${product.imageUrl || 'https://placehold.co/60x60/e2e8f0/94a3b8?text=N/A'}" alt="${product.name}">
                    <div class="product-card-info">
                        <h5>${product.name}</h5>
                        <p>מק"ט: ${product.sku} | ${product.category}</p>
                        <p class="truncate">${product.description || 'אין תיאור'}</p>
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="addToAdminCart('${product.sku}')">
                        <i data-feather="plus" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            feather.replace({ width: '16px', height: '16px' });
        }
        window.renderAdminCatalogSearch = renderAdminCatalogSearch; // Expose
        
        /**
         * מוסיף פריט לסל הקניות הווירטואלי
         * (הדרישה שלך)
         */
        function addToAdminCart(sku) {
            const product = adminCatalog.find(p => p.sku === sku);
            if (!product) return;
            
            const existingItem = adminCart.find(item => item.sku === sku);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                adminCart.push({
                    sku: product.sku,
                    name: product.name,
                    quantity: 1,
                    // price: product.price // נוסיף בעתיד אם יהיה מחיר
                });
            }
            renderAdminCart();
        }
        window.addToAdminCart = addToAdminCart; // Expose

        /**
         * מרנדר את סל הקניות
         * (הדרישה שלך)
         */
        function renderAdminCart() {
            const container = document.getElementById('order-cart-ui');
            if (adminCart.length === 0) {
                container.innerHTML = `<p class="p-4 text-sm text-gray-400 text-center">הסל ריק.</p>`;
                document.getElementById('cart-total-items').innerText = "0";
                return;
            }
            
            container.innerHTML = adminCart.map((item, index) => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <span>${item.name}</span>
                        <p>מק"ט: ${item.sku}</p>
                    </div>
                    <input 
                        type="number" 
                        class="form-input cart-item-qty" 
                        value="${item.quantity}" 
                        min="1" 
                        onchange="updateCartQuantity(${index}, this.value)">
                    <button type="button" class="btn-icon" onclick="removeFromAdminCart(${index})">
                        <i data-feather="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            
            document.getElementById('cart-total-items').innerText = adminCart.reduce((sum, item) => sum + item.quantity, 0);
            feather.replace({ width: '16px', height: '16px' });
        }
        
        function updateCartQuantity(index, newQuantity) {
            const qty = parseInt(newQuantity);
            if (qty > 0) {
                adminCart[index].quantity = qty;
            } else {
                adminCart.splice(index, 1); // הסר אם הכמות 0
            }
            renderAdminCart();
        }
        window.updateCartQuantity = updateCartQuantity; // Expose
        
        function removeFromAdminCart(index) {
            adminCart.splice(index, 1);
            renderAdminCart();
        }
        window.removeFromAdminCart = removeFromAdminCart; // Expose
        
        
        // --- [MODIFIED] פונקציות קיימות ששודרגו ---
        
        function openNewOrderForm() {
            document.getElementById('new-order-modal').showModal();
            // איפוס הטופס
            document.getElementById('new-order-modal').querySelector('form').reset();
            document.getElementById('existing-customer-display').style.display = 'none';
            adminCart = []; // איפוס סל הקניות
            renderAdminCart(); // רנדור סל ריק
            
            // טעינת הקטלוג אם הוא עדיין לא טעון
            if (adminCatalog.length === 0) {
                fetchAdminCatalog();
            } else {
                renderAdminCatalogSearch(""); // הצג את כל המוצרים
            }
            
            feather.replace();
        }
        window.openNewOrderForm = openNewOrderForm; // Expose

        function closeNewOrderForm() {
            document.getElementById('new-order-modal').close();
            adminCart = []; // נקה סל ביציאה
        }
        window.closeNewOrderForm = closeNewOrderForm; // Expose

        
        /**
         * [MODIFIED v37]
         * שולח הזמנה חדשה ל-Firestore, כולל הפריטים מסל הקניות
         */
        async function submitNewOrder(e) {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('submit-order-btn');
            btn.disabled = true;
            btn.innerText = 'מעבד...';
            
            let customerId = document.getElementById('customer-id-existing').value;
            let customerData = {};
            let address = '';

            // --- 1. ודא שלקוח נבחר ---
            if (document.getElementById('existing-customer-display').style.display === 'block') {
                const customer = allCustomers.find(c => c.id === customerId);
                customerData = {
                    id: customer.id,
                    name: customer.name,
                    phone: customer.phone,
                    customerNumber: customer.customerNumber || null,
                };
                address = document.getElementById('customer-address-display').innerText;
            } else {
                showToast("חובה לבחור לקוח קיים מהרשימה", "error");
                btn.disabled = false;
                btn.innerText = 'צור ושתף ב-WhatsApp';
                return;
            }
            
            // --- 2. ודא שסל הקניות אינו ריק ---
            if (adminCart.length === 0) {
                 showToast("חובה להוסיף לפחות מוצר אחד לסל הקניות", "error");
                btn.disabled = false;
                btn.innerText = 'צור ושתף ב-WhatsApp';
                return;
            }

            const customOrderNumber = `AUTO-${Date.now().toString().slice(-6)}`;
            const notes = document.getElementById('order-notes').value;

            const orderData = {
                customer: customerData,
                customer_name: customerData.name,
                customer_id: customerData.customerNumber,
                address: address,
                
                orderDate: new Date().toISOString().split('T')[0], // תאריך של היום
                orderTime: new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }),
                
                projectName: "הזמנת קטלוג (מנהל)", // פרויקט גנרי
                notes: notes, 
                warehouse: "החרש", // [TODO] אפשר להוסיף בחירה
                deliveryType: "משאית", // [TODO] אפשר להוסיף בחירה
                
                status: "חדש",
                createdAt: serverTimestamp(),
                lastModified: serverTimestamp(),
                createdBy: "AdminPanel (Catalog)",
                order_id: customOrderNumber,
                
                cartItems: adminCart // [NEW v37] הוספת סל הקניות להזמנה
            };
            
            SmartLog.info("Attempting to create new catalog order...", "CRUD.Order.Create", orderData);
            
            try {
                const orderRef = doc(db, "orders", customOrderNumber); // שימוש במספר האוטומטי כמזהה
                await setDoc(orderRef, orderData);
                
                SmartLog.info(`Order created successfully: ${customOrderNumber}`, "CRUD.Order.CreateSuccess");
                showToast('הזמנה חדשה נוצרה בהצלחה!', 'success');
                form.reset();
                closeNewOrderForm();
                showView('dashboard');
                
                // שלח וואטסאפ
                await shareToWhatsApp(orderData);

            } catch (error) {
                SmartLog.error(error, "CRUD.Order.CreateFailed", orderData);
                showToast('שגיאה ביצירת הזמנה.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = 'צור ושתף ב-WhatsApp';
            }
        }
        
        // --- (כל שאר הפונקציות הקיימות: shareToWhatsApp, updateOrderStatus, וכו') ---
        // ...
        
        // [MODIFIED] שיניתי את פונקציית החיפוש של לקוחות
        function handleCustomerSearch(value) {
            const newCustomerFields = document.getElementById('new-customer-fields'); // This element doesn't exist in this modal, but we keep the logic similar
            const existingCustomerDisplay = document.getElementById('existing-customer-display');
            const dataListOptions = document.getElementById('customer-list').options;
            
            let found = false;
            for (let i = 0; i < dataListOptions.length; i++) {
                if (dataListOptions[i].value === value) {
                    const customerId = dataListOptions[i].dataset.id;
                    const customer = allCustomers.find(c => c.id === customerId);
                    if (customer) {
                        // Fill existing customer display
                        existingCustomerDisplay.style.display = 'block';
                        document.getElementById('customer-id-existing').value = customer.id;
                        document.getElementById('customer-name-display').innerText = customer.name;
                        document.getElementById('customer-number-display').innerText = `(${customer.customerNumber || 'N/A'})`;
                        document.getElementById('customer-address-display').innerText = customer.defaultAddress || 'N/A';
                        found = true;
                    }
                    break;
                }
            }

            if (!found) {
                existingCustomerDisplay.style.display = 'none';
                document.getElementById('customer-id-existing').value = "";
            }
        }
        window.handleCustomerSearch = handleCustomerSearch; // Expose

        // --- (המשך כל הקוד הקיים...) ---
        // ... (SmartLog, listenForDrivers, listenForCustomers, וכו'...)
    </script>

</body>
</html>
