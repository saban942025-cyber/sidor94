<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Zebulun Site</title>
    
    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href="../site_manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Google Font: Rubik -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --primary-light: #eff6ff; /* blue-50 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
            --text-dark: #1f2937; /* gray-800 */
            --text-light: #6b7280; /* gray-500 */
            --danger: #ef4444; /* red-500 */
        }
        
        html { -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            overscroll-behavior: none;
            /* Allow content to scroll behind bottom nav */
            padding-bottom: 80px; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Loader --- */
        #app-loader {
            position: fixed;
            inset: 0;
            background-color: var(--bg-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.3s ease;
        }
        .loader {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        .loader-small {
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* --- Global Alert (Toast) --- */
        #global-alert-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            width: 90%;
            max-width: 400px;
        }
        .global-alert {
            background: rgba(30, 41, 59, 0.85); /* slate-800 */
            backdrop-filter: blur(5px);
            color: #fff;
            padding: 1rem 1.25rem;
            border-radius: 0.75rem;
            font-weight: 600;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            animation: popIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .global-alert.alert-success {
            background: rgba(34, 197, 94, 0.85); /* green-500 */
        }
        .global-alert.alert-error {
            background: rgba(239, 68, 68, 0.85); /* red-500 */
        }
        @keyframes popIn {
          from { transform: translateY(-20px) scale(0.9); opacity: 0; }
          to { transform: translateY(0) scale(1); opacity: 1; }
        }
        
        /* --- App Views --- */
        .app-view {
            display: none; /* Hidden by default */
            padding: 1rem;
        }
        .app-view.active {
            display: block; /* Shown when active */
        }

        /* --- Bottom Navigation --- */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(65px + env(safe-area-inset-bottom, 0));
            background-color: var(--bg-white);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            display: grid;
            grid-auto-flow: column;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            background-color: transparent;
            border: none;
            padding: 0.5rem 0;
            font-size: 0.75rem;
            font-weight: 500;
            transition: color 0.2s;
            border-top: 3px solid transparent;
        }
        .nav-button.active {
            color: var(--primary-color);
            border-top-color: var(--primary-color);
        }
        
        /* --- Catalog Styles --- */
        .product-card {
            background-color: var(--bg-white);
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .product-card img {
            height: 120px;
            width: 100%;
            object-fit: cover;
        }
        .product-card-content {
            padding: 0.75rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .product-card h4 {
            font-weight: 600;
            color: var(--text-dark);
            line-height: 1.3;
        }
        .product-card p {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }
        .product-card-footer {
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        /* --- Cart Styles --- */
        #cart-icon {
            position: fixed;
            bottom: calc(80px + env(safe-area-inset-bottom, 0));
            left: 1.5rem;
            width: 60px;
            height: 60px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 999;
        }
        #cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            border: 2px solid var(--bg-white);
        }
        
        /* --- Modal (Popup) --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-white);
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            box-shadow: 0 -10px 25px -5px rgba(0, 0, 0, 0.1);
            z-index: 1002;
            width: 100%;
            max-height: 85vh;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }
        .modal-container.visible {
            transform: translateY(0);
        }
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .modal-body {
            padding: 1rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-light);
            text-align: left;
            flex-shrink: 0;
        }
        .cart-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .cart-item:last-child { border-bottom: none; }
        .cart-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 0.375rem;
        }
        .cart-item-info { flex-grow: 1; }
        .cart-item-info h5 { font-weight: 600; }
        .cart-item-info p { font-size: 0.8rem; color: var(--text-light); }
        .cart-item-actions { display: flex; align-items: center; gap: 0.5rem; }
        .cart-item-actions input { width: 50px; text-align: center; }
        
        /* --- Order Tracking --- */
        #map-container {
            height: 300px;
            width: 100%;
            border-radius: 0.5rem;
            background-color: var(--border-color);
            margin-top: 1rem;
        }
        .status-tracker { display: flex; justify-content: space-between; align-items: flex-start; position: relative; margin: 1.5rem 0; }
        .status-tracker::before { content: ''; position: absolute; top: 12px; right: 0; left: 0; height: 3px; background-color: var(--border-color); z-index: 1; }
        .status-tracker-progress { position: absolute; top: 12px; right: 0; height: 3px; background-color: var(--primary-color); z-index: 2; width: 0%; transition: width 0.5s ease; }
        .status-step { display: flex; flex-direction: column; align-items: center; text-align: center; width: 60px; z-index: 3; }
        .status-dot { width: 24px; height: 24px; border-radius: 50%; background-color: var(--border-color); border: 3px solid var(--bg-light); display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .status-label { font-size: 0.75rem; font-weight: 500; color: var(--text-light); margin-top: 0.5rem; line-height: 1.2; }
        .status-step.completed .status-dot { background-color: var(--primary-color); border-color: var(--primary-light); }
        .status-step.completed .status-label { color: var(--text-dark); }
        .status-step.active .status-dot { background-color: var(--bg-light); border-color: var(--primary-color); transform: scale(1.1); }
        .status-step.active .status-label { color: var(--primary-color); font-weight: 700; }
        
    </style>
</head>
<body class="antialiased">

    <!-- Global Loader -->
    <div id="app-loader">
        <div class="loader"></div>
        <p class="mt-4 font-semibold text-lg" id="loader-text">טוען אפליקציית אתר...</p>
    </div>

    <!-- Global Alert (Toast) Container -->
    <div id="global-alert-container"></div>

    <!-- Cart Modal -->
    <div id="cart-modal-overlay" class="modal-overlay" onclick="closeCartModal()"></div>
    <div id="cart-modal" class="modal-container">
        <header class="modal-header flex justify-between items-center">
            <h3 id="modal-title" class="text-lg font-semibold">סל הקניות שלך</h3>
            <button class="btn-icon" onclick="closeCartModal()">
                <i data-feather="x"></i>
            </button>
        </header>
        <div id="cart-modal-body" class="modal-body no-scrollbar">
            <!-- Cart items injected by JS -->
            <p id="cart-empty-msg">הסל ריק.</p>
        </div>
        <footer id="cart-modal-footer" class="modal-footer flex gap-2 justify-end">
             <button class="btn btn-primary btn-lg w-full" onclick="submitPendingOrder()">
                <i data-feather="send"></i>
                <span>שלח לאישור יוסי</span>
            </button>
        </footer>
    </div>
    
    <!-- Cart FAB -->
    <button id="cart-icon" onclick="openCartModal()">
        <i data-feather="shopping-cart" class="w-7 h-7"></i>
        <span id="cart-badge">0</span>
    </button>

    <!-- App Header -->
    <header class="bg-white shadow-sm p-4 sticky top-0 z-10">
        <h1 class="text-xl font-bold text-center text-primary-color" id="app-header-title">
            פרויקט: טוען...
        </h1>
    </header>

    <!-- App Content -->
    <div id="main-content">
        
        <!-- View 1: New Order (Chat/Form) -->
        <div id="view-order" class="app-view active">
            <div class="glass-card mb-4">
                <h2 class="text-lg font-bold">שלום, <span id="user-name-display">מנהל</span>!</h2>
                <p class="text-sm text-light">השתמש בטופס זה לשליחת בקשת הזמנה חדשה לאישור יוסי.</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="form-label" for="raw-text-input">הקלד הזמנה (טקסט חופשי)</label>
                    <textarea id="raw-text-input" class="form-input" rows="4" placeholder="לדוגמה: 20 בלוק 20, 5 שקי מלט..."></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                     <button class="btn btn-secondary" onclick="document.getElementById('media-file-input').click()">
                        <i data-feather="camera" class="w-4 h-4"></i>
                        <span>צלם / צרף תמונה</span>
                     </button>
                     <input type="file" id="media-file-input" class="hidden" accept="image/*" onchange="handleMediaUpload(event)">
                     
                     <button class="btn btn-secondary" onclick="sendLocation()">
                        <i data-feather="map-pin" class="w-4 h-4"></i>
                        <span>שלח מיקום מדויק</span>
                     </button>
                </div>
                <div id="media-preview-container" class="space-y-2"></div>
                <p id="upload-status" class="text-sm text-center text-light"></p>
            </div>
        </div>
        
        <!-- View 2: Catalog -->
        <div id="view-catalog" class="app-view">
             <div>
                <input type="text" id="catalog-search-input" class="form-input" placeholder="חפש מוצר, מק'ט או כינוי..." oninput="searchCatalog(this.value)">
             </div>
             <div id="catalog-grid" class="grid grid-cols-2 gap-3 mt-4">
                <!-- Product cards injected by JS -->
                <p id="catalog-loader" class="text-light col-span-2 text-center">טוען קטלוג...</p>
             </div>
        </div>
        
        <!-- View 3: My Orders (Tracking) -->
        <div id="view-tracking" class="app-view">
            <div id="orders-list-container" class="flex flex-col gap-3">
                <!-- Order history injected by JS -->
                <p id="orders-loader" class="text-light text-center">טוען היסטוריית הזמנות...</p>
            </div>
        </div>
        
    </div>

    <!-- Bottom Navigation -->
    <nav id="bottom-nav">
        <button id="nav-order" class="nav-button active" onclick="navigate('order')">
            <i data-feather="plus-circle"></i>
            <span>הזמנה חדשה</span>
        </button>
        <button id="nav-catalog" class="nav-button" onclick="navigate('catalog')">
            <i data-feather="book-open"></i>
            <span>קטלוג</span>
        </button>
        <button id="nav-tracking" class="nav-button" onclick="navigate('tracking')">
            <i data-feather="truck"></i>
            <span>ההזמנות שלי</span>
        </button>
    </nav>


    <!-- 
    ======================================================
    === 3. EMBEDDED JAVASCRIPT (Site App v1.2 - FIXES)
    ======================================================
    -->
    <script type="module">
        // [תיקון] הוספת ייבוא מלא
        import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            onSnapshot, 
            query, 
            where, 
            orderBy, 
            limit, 
            serverTimestamp,
            getDocs
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL,
            uploadString // [NEW] For location
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        // --- Configuration ---
        const fallbackConfig = {
            apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
            authDomain: "saban94-78949.firebaseapp.com", 
            projectId: "saban94-78949",
            storageBucket: "saban94-78949.appspot.com", 
            messagingSenderId: "41553157903", 
            appId: "1:41553157903:web:cc33d252cff023be97a87a"
        };
        const FIREBASE_CONFIG = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : fallbackConfig;

        // [תיקון] עדכון לכתובת הקטלוג החדשה שסיפקת
        const CATALOG_API_URL = "https://script.google.com/macros/s/AKfycbzXTd7xKPR6MH9rtOEGxPr3-hrTCTfpuH0kKOzpRkMGOlmYbvKfjwL8d2fgwIa_3_UT/exec";

        // --- Global App State ---
        let db, auth, storage;
        let currentUserId = null;
        let appInitialized = false;
        
        const state = {
            currentView: 'order',
            catalog: [],
            cart: [], // Array of { sku, name, quantity, image }
            mediaFiles: [], // Array of { type, url }
            currentLocation: null,
            project: null, // { id, name, setupKey, clientId }
            ordersHistory: [], // [NEW]
            ordersListeners: [] // [NEW]
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', initSiteApp);

        async function initSiteApp() {
            console.log("DOM loaded. Initializing Site App...");
            feather.replace();
            initFirebase();
            
            try {
                await authenticateUser();
                await getProjectDetails();
                
                if (!state.project) {
                    showError("שגיאה קריטית: לא ניתן לזהות את הפרויקט מהקישור.");
                    return;
                }
                
                initEventListeners();
                fetchCatalogData();
                listenToMyOrders();
                
                document.getElementById('app-header-title').innerText = `פרויקט: ${state.project.name}`;
                document.getElementById('user-name-display').innerText = state.project.submitter_name || "מנהל";
                
                document.getElementById('app-loader').style.display = 'none';
                
            } catch (error) {
                console.error("Initialization failed:", error);
                showError(error.message);
            }
        }

        function initFirebase() {
            try {
                const app = !getApps().length ? initializeApp(FIREBASE_CONFIG) : getApp();
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                console.log("Firebase Initialized.");
            } catch (error) {
                console.error("Firebase Init Error:", error);
                showError("שגיאת התחברות קריטית ל-Firebase");
            }
        }
        
        function initEventListeners() {
            document.getElementById('nav-order').addEventListener('click', () => navigate('order'));
            document.getElementById('nav-catalog').addEventListener('click', () => navigate('catalog'));
            document.getElementById('nav-tracking').addEventListener('click', () => navigate('tracking'));
            
            window.navigate = navigate;
            window.searchCatalog = debounce(searchCatalog, 300);
            window.addToCart = addToCart;
            window.openCartModal = openCartModal;
            window.closeCartModal = closeCartModal;
            window.updateCartQuantity = updateCartQuantity;
            window.submitPendingOrder = submitPendingOrder;
            window.handleMediaUpload = handleMediaUpload;
            window.sendLocation = sendLocation;
            window.removeMedia = removeMedia;
            window.showOrderDetails = showOrderDetails; // [NEW]
        }

        async function authenticateUser() {
            return new Promise((resolve, reject) => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log(`User Authenticated: ${currentUserId}`);
                        resolve(user);
                    } else {
                        console.log("No user found. Signing in anonymously...");
                        try {
                            // [TODO] Add real auth later. For now, anonymous.
                            const { user } = await signInAnonymously(auth);
                            currentUserId = user.uid;
                            resolve(user);
                        } catch (error) {
                            console.error("Authentication Error:", error);
                            reject(new Error("שגיאת התחברות למערכת"));
                        }
                    }
                });
            });
        }
        
        async function getProjectDetails() {
            const params = new URLSearchParams(window.location.search);
            const setupKey = params.get('setup_key');
            if (!setupKey) {
                throw new Error("קישור ההתקנה פגום (חסר מפתח פרויקט).");
            }
            
            console.log(`Looking for project with setupKey: ${setupKey}`);
            const q = query(collection(db, "projects"), where("setupKey", "==", setupKey), limit(1));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                throw new Error("קישור ההתקנה פגום או לא קיים.");
            }
            
            const doc = snapshot.docs[0];
            state.project = { id: doc.id, ...doc.data() };
            
            // [TODO] Ask for user name
            state.project.submitter_name = prompt("אנא הזן את שמך המלא:", "מנהל אתר") || "מנהל אתר";
        }

        // --- [NEW v55] Catalog Data Fetching ---
        async function fetchCatalogData() {
            if (state.catalog.length > 0) return; 
            console.log("Fetching catalog data...");
            try {
                const response = await fetch(CATALOG_API_URL);
                if (!response.ok) {
                    throw new Error(`Catalog API returned status ${response.status}`);
                }
                const text = await response.text();
                
                // [תיקון] הוספת try-catch סביב response.json()
                try {
                    const data = JSON.parse(text);
                    // [תיקון] בודק את המבנה הנכון מה-API: {status: "success", data: [...]}
                    if (data && data.status === 'success' && Array.isArray(data.data)) {
                        state.catalog = data.data; // [תיקון] משתמש ב-data.data
                        console.log(`Catalog loaded with ${state.catalog.length} items.`);
                        renderCatalog(); // Render after fetching
                    } else {
                        throw new Error("Invalid JSON structure from catalog API");
                    }
                } catch (e) {
                    console.error("========================================================");
                    console.error(`אחי, שגיאה קריטית בטעינת הקטלוג (שגיאת JSON): ${e.message}`);
                    console.error(`השרת החזיר טקסט שמתחיל ב: ${text.substring(0, 100)}...`);
                    console.error("זו כנראה *לא* בעיה בקוד הזה, אלא בהגדרות ה-Deployment של ה-Apps Script שלך.");
                    console.error("אנא ודא שהסקריפט שלך מוגדר לגישה: 'Anyone'.");
                    console.error("========================================================");
                    showToast("שגיאה חמורה בטעינת קטלוג. בדוק Console.", "error");
                    document.getElementById('catalog-loader').innerText = 'שגיאה בטעינת הקטלוג.';
                }
                
            } catch (error) {
                console.error("Failed to load catalog:", error);
                 document.getElementById('catalog-loader').innerText = 'שגיאה בטעינת הקטלוג.';
            }
        }

        // --- Navigation ---
        function navigate(viewId) {
            state.currentView = viewId;
            document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`view-${viewId}`).classList.add('active');
            document.getElementById(`nav-${viewId}`).classList.add('active');
            
            if (viewId === 'catalog' && state.catalog.length === 0) {
                fetchCatalogData();
            }
            if (viewId === 'tracking') {
                listenToMyOrders(); // Refresh listeners
            }
        }
        
        // --- Catalog & Cart Logic ---
        function renderCatalog(filterTerm = '') {
            const grid = document.getElementById('catalog-grid');
            grid.innerHTML = '';
            
            const lowerTerm = filterTerm.toLowerCase();
            const results = state.catalog.filter(item => 
                !filterTerm || 
                item.name.toLowerCase().includes(lowerTerm) ||
                (item.sku && item.sku.toString().includes(lowerTerm))
            );
            
            if (results.length === 0 && state.catalog.length > 0) {
                grid.innerHTML = '<p class="text-light col-span-2 text-center">לא נמצאו מוצרים תואמים.</p>';
                return;
            }
            if (state.catalog.length === 0 && !document.getElementById('catalog-loader')) {
                grid.innerHTML = '<p id="catalog-loader" class="text-light col-span-2 text-center">טוען קטלוג...</p>';
                return;
            }
            
            results.forEach(item => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <img src="${item.imageUrl || 'https://placehold.co/300x200/e2e8f0/94a3b8?text=N/A'}" alt="${item.name}">
                    <div class="product-card-content">
                        <h4 class="truncate">${item.name}</h4>
                        <p>מק"ט: ${item.sku}</p>
                        <div class="product-card-footer mt-auto">
                            <button class="btn btn-primary w-full" 
                                    data-sku="${item.sku}" 
                                    data-name="${item.name}" 
                                    data-image="${item.imageUrl || ''}"
                                    onclick="addToCart(this)">
                                <i data-feather="plus" class="w-4 h-4"></i>
                                <span>הוסף לסל</span>
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            feather.replace();
        }
        
        function searchCatalog(term) {
            renderCatalog(term);
        }
        
        function addToCart(button) {
            const sku = button.dataset.sku;
            const existingItem = state.cart.find(item => item.sku === sku);
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                state.cart.push({
                    sku: sku,
                    name: button.dataset.name,
                    image: button.dataset.image,
                    quantity: 1
                });
            }
            
            showToast(`${button.dataset.name} הוסף לסל`, 'success');
            updateCartBadge();
        }
        
        function updateCartBadge() {
            const badge = document.getElementById('cart-badge');
            const totalItems = state.cart.reduce((sum, item) => sum + item.quantity, 0);
            badge.innerText = totalItems;
            badge.style.display = totalItems > 0 ? 'flex' : 'none';
        }
        
        function openCartModal() {
            const body = document.getElementById('cart-modal-body');
            const emptyMsg = document.getElementById('cart-empty-msg');
            
            if (state.cart.length === 0) {
                body.innerHTML = '';
                emptyMsg.style.display = 'block';
            } else {
                emptyMsg.style.display = 'none';
                body.innerHTML = state.cart.map(item => `
                    <div class="cart-item">
                        <img src="${item.image || 'https://placehold.co/50x50/e2e8f0/94a3b8?text=N/A'}" alt="${item.name}">
                        <div class="cart-item-info">
                            <h5>${item.name}</h5>
                            <p>מק"ט: ${item.sku}</p>
                        </div>
                        <div class="cart-item-actions">
                            <input type="number" class="form-input" value="${item.quantity}" min="1" 
                                   onchange="updateCartQuantity('${item.sku}', this.value)">
                            <button class="btn-icon text-danger" onclick="updateCartQuantity('${item.sku}', 0)">
                                <i data-feather="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                feather.replace();
            }
            
            document.getElementById('cart-modal-overlay').classList.add('visible');
            document.getElementById('cart-modal').classList.add('visible');
        }
        
        function closeCartModal() {
            document.getElementById('cart-modal-overlay').classList.remove('visible');
            document.getElementById('cart-modal').classList.remove('visible');
        }
        
        function updateCartQuantity(sku, newQuantity) {
            const qty = parseInt(newQuantity);
            const itemIndex = state.cart.findIndex(item => item.sku === sku);
            
            if (itemIndex === -1) return;
            
            if (qty <= 0) {
                state.cart.splice(itemIndex, 1);
            } else {
                state.cart[itemIndex].quantity = qty;
            }
            
            openCartModal(); // Re-render cart modal
            updateCartBadge();
        }
        
        // --- Media & Location ---
        async function handleMediaUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const uploadStatus = document.getElementById('upload-status');
            uploadStatus.innerHTML = `<div class="loader-small"></div> <span>מעלה קובץ...</span>`;
            uploadStatus.classList.remove('hidden');
            
            try {
                const storageRef = ref(storage, `site_requests/${state.project.id}/${Date.now()}_${file.name}`);
                const snapshot = await uploadBytes(storageRef, file);
                const url = await getDownloadURL(snapshot.ref);
                
                state.mediaFiles.push({ type: file.type, url: url });
                renderMediaPreviews();
                uploadStatus.classList.add('hidden');
                showToast("קובץ הועלה בהצלחה", "success");

            } catch (error) {
                console.error("Media upload failed:", error);
                uploadStatus.innerText = "שגיאה בהעלאת קובץ";
                setTimeout(() => uploadStatus.classList.add('hidden'), 3000);
            }
        }
        
        function renderMediaPreviews() {
            const container = document.getElementById('media-preview-container');
            container.innerHTML = state.mediaFiles.map((file, index) => {
                return `
                    <div class="flex items-center gap-2 p-2 bg-white border rounded-md">
                        <i data-feather="${file.type.startsWith('image/') ? 'image' : 'file'}" class="w-5 h-5 text-primary-color"></i>
                        <span class="flex-grow text-sm truncate">${file.url.split('%2F').pop().split('?')[0]}</span>
                        <button class="btn-icon text-danger" onclick="removeMedia(${index})">
                            <i data-feather="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
            }).join('');
            feather.replace();
        }
        
        function removeMedia(index) {
            state.mediaFiles.splice(index, 1);
            renderMediaPreviews();
        }
        
        function sendLocation() {
            if (!navigator.geolocation) {
                showToast("שליחת מיקום אינה נתמכת בדפדפן זה.", "error");
                return;
            }
            
            const uploadStatus = document.getElementById('upload-status');
            uploadStatus.innerHTML = `<div class="loader-small"></div> <span>מאחזר מיקום...</span>`;
            uploadStatus.classList.remove('hidden');
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    state.currentLocation = { latitude, longitude };
                    
                    // [NEW] Try to get address
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                        const data = await response.json();
                        state.currentLocation.address = data.display_name || `${latitude}, ${longitude}`;
                    } catch (e) {
                        state.currentLocation.address = `${latitude}, ${longitude}`;
                    }
                    
                    uploadStatus.innerHTML = `<i data-feather="check" class="w-4 h-4 text-green-500"></i> <span class="text-green-600">מיקום מדויק נקלט: ${state.currentLocation.address.substring(0,30)}...</span>`;
                    setTimeout(() => uploadStatus.classList.add('hidden'), 4000);
                },
                (error) => {
                    console.error("Geolocation failed:", error);
                    uploadStatus.innerText = "שגיאה בקליטת מיקום";
                    setTimeout(() => uploadStatus.classList.add('hidden'), 3000);
                }
            );
        }

        // --- Order Submission ---
        async function submitPendingOrder() {
            const rawText = document.getElementById('raw-text-input').value.trim();
            
            if (state.cart.length === 0 && rawText.length === 0 && state.mediaFiles.length === 0) {
                showToast("חובה להוסיף פריטים, טקסט או מדיה לבקשה", "error");
                return;
            }
            
            const btn = document.querySelector('#cart-modal-footer button');
            btn.disabled = true;
            btn.innerHTML = '<div class="loader-small"></div> <span>שולח...</span>';
            
            const payload = {
                client_id: state.project.clientId,
                project_id: state.project.id,
                project_name: state.project.name,
                site_manager_uid: currentUserId,
                submitter_name: state.project.submitter_name,
                timestamp: serverTimestamp(),
                status: "pending",
                final_order_id: null,
                raw_text: rawText,
                cart_items: state.cart,
                media_files: state.mediaFiles,
                location_address: state.currentLocation ? state.currentLocation.address : null
            };
            
            try {
                const docRef = await addDoc(collection(db, "pending_orders"), payload);
                console.log("Pending order created:", docRef.id);
                showToast("הבקשה נשלחה לאישור יוסי!", "success");
                
                // Reset form
                state.cart = [];
                state.mediaFiles = [];
                state.currentLocation = null;
                document.getElementById('raw-text-input').value = '';
                renderMediaPreviews();
                updateCartBadge();
                closeCartModal();
                navigate('tracking'); // Switch to tracking view
                
            } catch (error) {
                console.error("Failed to submit pending order:", error);
                showToast("שגיאה בשליחת הבקשה", "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-feather="send"></i> <span>שלח לאישור יוסי</span>';
                feather.replace();
            }
        }
        
        // --- [NEW] Order Tracking Logic ---
        function listenToMyOrders() {
            // Clear old listeners
            state.ordersListeners.forEach(unsub => unsub());
            state.ordersListeners = [];
            
            const container = document.getElementById('orders-list-container');
            container.innerHTML = '<p id="orders-loader" class="text-light text-center">טוען היסטוריית הזמנות...</p>';
            
            // 1. Listen to pending orders
            const qPending = query(
                collection(db, "pending_orders"), 
                where("site_manager_uid", "==", currentUserId),
                where("project_id", "==", state.project.id),
                orderBy("timestamp", "desc"),
                limit(10)
            );
            
            const unsubPending = onSnapshot(qPending, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const data = { id: change.doc.id, ...change.doc.data() };
                    const index = state.ordersHistory.findIndex(o => o.id === data.id);
                    if (change.type === 'removed' && index > -1) {
                        state.ordersHistory.splice(index, 1);
                    } else if (index > -1) {
                        state.ordersHistory[index] = data; // Update
                    } else {
                        state.ordersHistory.push(data); // Add
                    }
                });
                renderOrdersHistory();
            }, error => console.error("Error listening to pending:", error));
            
            state.ordersListeners.push(unsubPending);
            
            // 2. Listen to approved orders
            const qApproved = query(
                collection(db, "orders"),
                where("siteManagerUid", "==", currentUserId),
                where("projectId", "==", state.project.id),
                orderBy("createdAt", "desc"),
                limit(10)
            );
            
            const unsubApproved = onSnapshot(qApproved, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const data = { id: change.doc.id, ...change.doc.data() };
                    const index = state.ordersHistory.findIndex(o => o.sourceRequestId === data.sourceRequestId);
                    if (change.type === 'removed' && index > -1) {
                         // Should not happen, but good to handle
                    } else if (index > -1) {
                        // Replace the 'pending' version with the 'approved' version
                        state.ordersHistory[index] = data; 
                    } else {
                        // This is an approved order without a pending request (e.g. Yossi created it)
                        // Or the pending request is too old (older than 10)
                        // Let's check if we already have it
                        const approvedIndex = state.ordersHistory.findIndex(o => o.id === data.id);
                        if (approvedIndex > -1) {
                            state.ordersHistory[approvedIndex] = data; // Update
                        } else {
                            state.ordersHistory.push(data); // Add
                        }
                    }
                });
                renderOrdersHistory();
            }, error => console.error("Error listening to approved:", error));
            
            state.ordersListeners.push(unsubApproved);
        }
        
        function renderOrdersHistory() {
            const container = document.getElementById('orders-list-container');
            container.innerHTML = '';
            
            if (state.ordersHistory.length === 0) {
                 container.innerHTML = '<p class="text-light text-center">עדיין לא שלחת בקשות.</p>';
                 return;
            }
            
            // Sort by time
            state.ordersHistory.sort((a, b) => {
                const timeA = a.createdAt || a.timestamp;
                const timeB = b.createdAt || b.timestamp;
                return timeB?.toDate() - timeA?.toDate();
            });
            
            state.ordersHistory.forEach(order => {
                const card = document.createElement('div');
                card.className = 'list-item-card bg-white';
                
                const isPending = !!order.submitter_name; // Check if it's a pending order
                let statusText, statusColor;
                
                if (isPending) {
                    statusText = "ממתין לאישור";
                    statusColor = "text-yellow-600";
                    if (order.status === 'rejected') {
                         statusText = "נדחה";
                         statusColor = "text-danger";
                    }
                } else {
                    // It's an approved order
                    statusText = order.status || "אושר";
                    statusColor = "text-green-600";
                    if (order.status === 'בדרך') statusColor = "text-primary-color";
                }
                
                const timestamp = order.createdAt || order.timestamp;
                
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h4 class="font-bold">${order.projectName || order.project_name || 'בקשה'}</h4>
                        <span class="font-bold text-sm ${statusColor}">${statusText}</span>
                    </div>
                    <p class="text-sm text-light">${new Date(timestamp?.toDate()).toLocaleString('he-IL')}</p>
                    <p class="text-sm text-dark truncate mt-2">"${order.rawText || order.raw_text || 'מצורפים פריטים'}"</p>
                    ${!isPending ? `<button class="btn btn-secondary btn-sm mt-3 w-full" onclick="showOrderDetails('${order.id}')">צפה במעקב וצ'אט</button>` : ''}
                `;
                container.appendChild(card);
            });
            feather.replace();
        }
        
        function showOrderDetails(orderId) {
            // [NEW] Redirect to customer.html for live tracking
            // This re-uses the existing live tracking app
            const order = state.ordersHistory.find(o => o.id === orderId);
            if (!order) return;
            
            const customerLink = `customer.html?id=${order.order_id || order.orderId}`;
            window.open(customerLink, '_blank');
        }

        // --- Utils ---
        function showError(message) {
            document.getElementById('app-loader').innerHTML = `
                <i data-feather="alert-triangle" class="w-12 h-12 text-danger"></i>
                <p class="mt-4 font-semibold text-lg text-danger">${message}</p>
                <button class"btn btn-primary mt-4" onclick="window.location.reload()">נסה שוב</button>
            `;
            feather.replace();
        }

        function showToast(message, type = "info") {
            const container = document.getElementById("global-alert-container");
            const alertBox = document.createElement("div");
            alertBox.className = `global-alert ${type === 'error' ? 'alert-error' : 'alert-success'}`;
            
            const icon = (type === "error") ? "alert-triangle" : 'check-circle';
            alertBox.innerHTML = `<i data-feather="${icon}" class="w-5 h-5"></i><span>${message}</span>`;
            
            container.appendChild(alertBox);
            feather.replace();
            
            setTimeout(() => {
                alertBox.style.opacity = '0';
                alertBox.style.transform = 'translateY(-20px)';
                setTimeout(() => alertBox.remove(), 300);
            }, 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

    </script>
</body>
</html>
