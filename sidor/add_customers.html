<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>×”×§××ª ×”×–×× ×” (v3.1 - Fix & Design)</title>
    <!-- 
      DeliveryMaster CRM Form v3.1 (Fix & Design)
      
      Changelog:
      - [CRITICAL FIX v3.1]:
        - ×ª×™×§×•×Ÿ ×©×’×™××ª `serverTimestamp() is not currently supported inside arrays`.
        - ×”×•×—×œ×£ `serverTimestamp()` ×‘×ª×•×š `auditLog` ×‘-`new Date()`.
      - [DESIGN v3.1]:
        - ×¢×™×¦×•×‘ ××—×“×© ×©×œ ×ª×‘× ×™×ª ×”-WhatsApp (×‘-`shareToWhatsApp`)
          ×œ××¨××” × ×§×™ ×•×§×œ×™×œ ×™×•×ª×¨, ×¢× ××™××•×’'×™× 
          (×‘××§×•× ×”×§×•×•×™× ×”×›×‘×“×™×).
        - ×”×•×¡×¤×ª ×¨×§×¢ ×¦×‘×¢×•× ×™ ×¢×“×™×Ÿ (×ª×›×œ×ª/×™×¨×§×¨×§) ×œ×©×œ×‘×™ ×”×˜×•×¤×¡.
      - [v3.0]:
        - ×©×™×œ×•×‘ ×”×¢×œ××ª ×§×‘×¦×™× ×œ-Google Drive + ×©×™×ª×•×£ WhatsApp.
        - ×”×•×¡×¤×ª ××ª×—×•×œ Firebase ××œ×.
      - [v2.2]:
        - ×ª×™×§×•×Ÿ ×œ×•×’×™×§×ª ×™×¦×™×¨×ª ×œ×§×•×— ×œ×©×™××•×© ×‘-Auto-ID.
      - [v2.1]:
        - ×¢×™×¦×•×‘ CRM ××•×“×¨× ×™, 2 ×©×œ×‘×™×, ××¦×‘ ×›×”×”/×‘×”×™×¨, × ×™×”×•×œ ×¤×¨×•×™×§×˜×™×.
    -->

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Google Font: Rubik -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --step-inactive: #9ca3af; /* gray-400 */
            --step-active: #3b82f6;   /* blue-500 */
            --step-complete: #16a34a; /* green-600 */
            --line-inactive: #e5e7eb;  /* gray-200 */
            --line-active: #dbeafe;    /* blue-100 */
            --line-complete: #dcfce7;  /* green-100 */
        }
        
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Rubik', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
            color: #1f2937; /* gray-800 */
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Dark Mode */
        html.dark {
            background-color: #1f2937; /* gray-800 */
            color: #f3f4f6; /* gray-100 */
        }
        html.dark body {
            background-color: #1f2937;
            color: #f3f4f6;
        }
        html.dark .form-card {
            background-color: #374151; /* gray-700 */
            border-color: #4b5563; /* gray-600 */
        }
        html.dark .form-input {
            background-color: #4b5563; /* gray-600 */
            border-color: #5e6875; /* gray-500 */
            color: #f3f4f6;
        }
        html.dark .form-input::placeholder {
            color: #9ca3af; /* gray-400 */
        }
        /* [NEW v3.1] Step background dark */
        html.dark #step-1-customer { background-color: #374151; }
        html.dark #step-2-order { background-color: #374151; }
        
        html.dark .tag-badge {
            background-color: #1d4ed8; /* blue-700 */
            color: #eff6ff; /* blue-50 */
        }
        html.dark .tag-remove {
            color: #93c5fd; /* blue-300 */
        }
        html.dark .btn-secondary {
            background-color: #4b5563; /* gray-600 */
            color: #f3f4f6;
        }
        html.dark .btn-secondary:hover {
            background-color: #5e6875; /* gray-500 */
        }
        
        /* [NEW v3.1] Step background light */
        #step-1-customer {
            background-color: #f0f9ff; /* blue-50 */
            border-radius: 1rem;
            padding: 1.5rem;
            transition: background-color 0.3s;
        }
        #step-2-order {
            background-color: #f0fdf4; /* green-50 */
            border-radius: 1rem;
            padding: 1.5rem;
            transition: background-color 0.3s;
        }
        
        /* Stepper */
        .stepper-line {
            height: 4px;
            background-color: var(--line-inactive);
            transition: background-color 0.4s;
        }
        .stepper-dot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--line-inactive);
            color: var(--step-inactive);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.125rem;
            transition: all 0.4s;
            border: 4px solid #f3f4f6; /* gray-100 */
        }
        html.dark .stepper-dot {
            border-color: #1f2937; /* gray-800 */
        }
        
        .stepper-label {
            color: var(--step-inactive);
            font-weight: 500;
            transition: color 0.4s;
        }
        
        /* Step Complete */
        .step.complete .stepper-line { background-color: var(--line-complete); }
        .step.complete .stepper-dot { background-color: var(--step-complete); color: white; border-color: var(--line-complete); }
        .step.complete .stepper-label { color: var(--step-complete); }
        
        /* Step Active */
        .step.active .stepper-line { background-color: var(--line-active); }
        .step.active .stepper-dot { background-color: var(--step-active); color: white; border-color: var(--line-active); transform: scale(1.1); }
        .step.active .stepper-label { color: var(--step-active); font-weight: 700; }
        
        /* Project Tags */
        .tag-badge {
            background-color: #dbeafe; /* blue-100 */
            color: #1e40af; /* blue-800 */
            padding: 4px 8px 4px 12px;
            border-radius: 9999px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.875rem;
        }
        .tag-remove {
            color: #60a5fa; /* blue-400 */
            cursor: pointer;
            border-radius: 50%;
        }
        .tag-remove:hover {
            background-color: rgba(255,255,255,0.3);
            color: #ef4444; /* red-500 */
        }
        
        /* Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .toast {
            padding: 12px 20px;
            background-color: #1f2937; /* gray-800 */
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { background-color: #16a34a; } /* green-600 */
        .toast.error { background-color: #dc2626; } /* red-600 */
        .toast.info { background-color: #3b82f6; } /* blue-500 */
        
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <div class="w-full max-w-4xl mx-auto">
        <!-- Dark Mode Toggle -->
        <button id="theme-toggle" class="absolute top-5 right-5 p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
            <i data-feather="moon" class="w-6 h-6 hidden dark:block"></i>
            <i data-feather="sun" class="w-6 h-6 block dark:hidden"></i>
        </button>

        <!-- Header -->
        <div class="text-center mb-10">
            <h1 class="text-5xl font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-sky-400">×˜×•×¤×¡ ×”×§××” ××”×™×¨</h1>
            <p class="text-xl text-gray-600 dark:text-gray-400">×”×§××ª ×œ×§×•×— ×•×”×–×× ×” ×‘×©× ×™ ×©×œ×‘×™× ×¤×©×•×˜×™×</p>
        </div>

        <!-- Stepper -->
        <div class="flex items-center w-full max-w-xl mx-auto mb-12">
            <!-- Step 1 -->
            <div id="stepper-1" class="step active flex-1">
                <div class="flex flex-col items-center">
                    <div class="stepper-dot">1</div>
                    <div class="stepper-label mt-2 text-center text-sm sm:text-base">×¤×¨×˜×™ ×œ×§×•×—</div>
                </div>
            </div>
            
            <div class="stepper-line flex-1"></div>
            
            <!-- Step 2 -->
            <div id="stepper-2" class="step flex-1">
                <div class="flex flex-col items-center">
                    <div class="stepper-dot">2</div>
                    <div class="stepper-label mt-2 text-center text-sm sm:text-base">×¤×¨×˜×™ ×”×–×× ×”</div>
                </div>
            </div>
        </div>

        <!-- Form Card -->
        <div class="form-card bg-white dark:bg-gray-700 shadow-2xl rounded-2xl p-6 sm:p-10 border border-gray-200 dark:border-gray-600">

            <!-- Step 1: Customer Details -->
            <div id="step-1-customer">
                <h2 class="text-3xl font-semibold mb-6 text-blue-600 dark:text-blue-400">×©×œ×‘ 1: ×¤×¨×˜×™ ×œ×§×•×—</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                    <!-- Customer Number -->
                    <div>
                        <label for="customer-number" class="block text-lg font-medium mb-2">××¡×¤×¨ ×œ×§×•×— (×—×•×‘×”)</label>
                        <input type="text" id="customer-number" class="form-input w-full p-4 text-xl border-2 border-gray-200 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500" placeholder="×œ×“×•×’××”: 601524">
                    </div>
                    <!-- Customer Name -->
                    <div>
                        <label for="customer-name" class="block text-lg font-medium mb-2">×©× ×œ×§×•×— (×—×•×‘×”)</label>
                        <input type="text" id="customer-name" class="form-input w-full p-4 text-xl border-2 border-gray-200 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500" placeholder="×©× ××œ× ×©×œ ×”×œ×§×•×—/×—×‘×¨×”">
                    </div>
                    <!-- Phone -->
                    <div>
                        <label for="customer-phone" class="block text-lg font-medium mb-2">×˜×œ×¤×•×Ÿ ×¨××©×™</label>
                        <input type="tel" id="customer-phone" class="form-input w-full p-4 text-xl border-2 border-gray-200 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500" placeholder="05X-XXXXXXX">
                    </div>
                    <!-- Contact Person -->
                    <div>
                        <label for="customer-contact" class="block text-lg font-medium mb-2">××™×© ×§×©×¨ (×¨×©×•×ª)</label>
                        <input type="text" id="customer-contact" class="form-input w-full p-4 text-xl border-2 border-gray-200 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500" placeholder="×©× ××™×© ×§×©×¨ ×‘×©×˜×—">
                    </div>
                    <!-- Address: Street -->
                    <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-x-6 gap-y-5">
                        <div>
                            <label for="customer-street" class="block text-lg font-medium mb-2">×¨×—×•×‘</label>
                            <input type="text" id="customer-street" class="form-input w-full p-4 text-xl border-2 border-gray-200 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500" placeholder="×”×—×©××•× ××™×">
                        </div>
                        <div>
                            <label for="customer-street-num" class="block text-lg font-medium mb-2">××¡×¤×¨</label>
                            <input type="text" id="customer-street-num" class="form-input w-full p-4 text-xl border-2 border-gray-200 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500" placeholder="90">
                        </div>
                        <div>
                            <label for="customer-city" class="block text-lg font-medium mb-2">×¢×™×¨</label>
                            <input type="text" id="customer-city" class="form-input w-full p-4 text-xl border-2 border-gray-200 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500" placeholder="×ª×œ ××‘×™×‘">
                        </div>
                    </div>
                </div>
                <!-- Navigation -->
                <div class="mt-10 flex justify-end">
                    <button id="btn-next-step" class="btn-primary py-3 px-8 bg-blue-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        ×”××©×š ×œ×©×œ×‘ 2: ×¤×¨×˜×™ ×”×–×× ×” <i data-feather="arrow-left" class="inline-block w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Order Details -->
            <div id="step-2-order" style="display: none;">
                <h2 class="text-3xl font-semibold mb-6 text-green-600 dark:text-green-400">×©×œ×‘ 2: ×¤×¨×˜×™ ×”×–×× ×”</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                    
                    <!-- Projects -->
                    <div class="md:col-span-2">
                        <label class="block text-lg font-medium mb-2">× ×™×”×•×œ ×¤×¨×•×™×§×˜×™×</label>
                        <div class="flex gap-2">
                            <input type="text" id="project-input" class="form-input w-full p-4 text-xl border-2 border-gray-200 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500" placeholder="×”×§×œ×“ ×©× ×¤×¨×•×™×§×˜ ×•×œ×—×¥ +">
                            <button id="btn-add-project" type="button" class="btn-primary p-4 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700">
                                <i data-feather="plus" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <div id="project-tags-container" class="flex flex-wrap gap-2 mt-3">
                            <!-- Project tags will be injected here -->
                        </div>
                    </div>
                    
                    <!-- Transport Type -->
                    <div>
                        <label for="order-transport-type" class="block text-lg font-medium mb-2">×¡×•×’ ×”×•×‘×œ×”</label>
                        <select id="order-transport-type" class="form-input w-full p-4 text-xl border-2 border-gray-200 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500">
                            <option value="">-- ×‘×—×¨ ×¡×•×’ --</option>
                            <option value="××©××™×ª">××©××™×ª</option>
                            <option value="×˜×¨×™×™×œ×¨">×˜×¨×™×™×œ×¨</option>
                            <option value="×× ×•×£">×× ×•×£</option>
                            <option value="×”×¦×‘×ª ××›×•×œ×”">×”×¦×‘×ª ××›×•×œ×”</option>
                            <option value="×¤×™× ×•×™ ××›×•×œ×”">×¤×™× ×•×™ ××›×•×œ×”</option>
                            <option value="×”×—×œ×¤×ª ××›×•×œ×”">×”×—×œ×¤×ª ××›×•×œ×”</option>
                            <option value="××™×¡×•×£ ×¢×¦××™">××™×¡×•×£ ×¢×¦××™</option>
                            <option value="××—×¨">××—×¨</option>
                        </select>
                    </div>
                    
                    <!-- Order Number -->
                    <div>
                        <label for="order-number" class="block text-lg font-medium mb-2">××¡×¤×¨ ×”×–×× ×” (×¨×©×•×ª)</label>
                        <input type="text" id="order-number" class="form-input w-full p-4 text-xl border-2 border-gray-200 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500" placeholder="×”×©××¨ ×¨×™×§ ×œ××•×˜×•××˜×™">
                    </div>

                    <!-- Order Content -->
                    <div class="md:col-span-2">
                        <label for="order-content" class="block text-lg font-medium mb-2">×ª×•×›×Ÿ ×”×”×–×× ×”</label>
                        <textarea id="order-content" rows="4" class="form-input w-full p-4 text-xl border-2 border-gray-200 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500" placeholder="×œ×“×•×’××”: 10 ×‘×œ×•×§ 20, 5 ××œ×˜..."></textarea>
                    </div>

                    <!-- [NEW v3.0] File Upload Section -->
                    <div class="md:col-span-2">
                        <label for="file-upload" class="block text-lg font-medium mb-2">×¦×™×¨×•×£ ××¡××š (××•×¤×¦×™×•× ×œ×™)</label>
                        <input type="file" id="file-upload" class="block w-full text-lg text-gray-700 dark:text-gray-300
                            file:mr-4 file:py-3 file:px-5 file:rounded-lg file:border-0
                            file:text-md file:font-semibold file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100 dark:file:bg-slate-700 dark:file:text-blue-300 dark:hover:file:bg-slate-600"/>
                        <div id="upload-status" class="text-sm text-blue-600 dark:text-blue-400 mt-2 hidden"></div>
                    </div>
                </div>
                
                <!-- Navigation -->
                <div class="mt-10 flex justify-between">
                    <button id="btn-prev-step" class="btn-secondary py-3 px-8 bg-gray-200 text-gray-700 text-lg font-semibold rounded-lg shadow-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">
                        <i data-feather="arrow-right" class="inline-block w-5 h-5"></i> ×—×–×•×¨ ×œ×¤×¨×˜×™ ×œ×§×•×—
                    </button>
                    <button id="btn-submit-full" class="btn-primary py-3 px-8 bg-green-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        <i data-feather="check-circle" class="inline-block w-5 h-5"></i> ×©××•×¨ ×”×›×œ ×•×©×œ×— ×œ-WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // [FIX v3.0] ×”×•×¡×¤×ª ××ª×—×•×œ Firebase ××œ×
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, collection, doc, onSnapshot, query, orderBy, addDoc, updateDoc, 
            serverTimestamp, deleteDoc, arrayUnion, where, getDocs, getDoc, limit, setDoc 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- Inlined Config Logic ---
        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", authDomain: "saban94-78949.firebaseapp.com", projectId: "saban94-78949",
          storageBucket: "saban94-78949.firebasestorage.app", // [FIX v34.9] Corrected bucket name
          messagingSenderId: "41553157903", appId: "1:41553157903:web:cc33d252cff023be97a87a", measurementId: "G-XV6RZDESSB"
        };
        let app, auth, db; 
        let initializationError = null;
        try {
            app = getApps().length ? getApp() : initializeApp(firebaseConfig);
            auth = getAuth(app); 
            db = getFirestore(app);
            // Sign in anonymously
            await signInAnonymously(auth);
            console.log("Firebase Initialized and Signed In Anonymously.");
        } catch (error) { 
            console.error("CRITICAL: Firebase init failed!", error); 
            initializationError = error; 
            showToast("×©×’×™××ª ×”×ª×—×‘×¨×•×ª ×§×¨×™×˜×™×ª ×œ×©×¨×ª", "error");
        }

        // [NEW v3.0] Google Apps Script Web App URL
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzwWherCt8LsMCmd9dQ__1RdN4OXb3BBcwYezJG0qVkFKbxowefqBLWbXHTft1QlXhprg/exec"; 

        // --- SmartLog (Minimal) ---
        const SmartLog = {
            info: (msg, ctx) => console.log("[INFO]", msg, ctx || ''),
            warn: (msg, ctx) => console.warn("[WARN]", msg, ctx || ''),
            error: (err, ctx) => console.error("[ERROR]", err, ctx || '')
        };

        // --- State ---
        let projectTags = [];
        let newCustomerData = {};

        // --- Dark Mode ---
        const themeToggle = document.getElementById('theme-toggle');
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            feather.replace();
        });

        // --- Stepper Navigation ---
        const step1 = document.getElementById('step-1-customer');
        const step2 = document.getElementById('step-2-order');
        const stepper1 = document.getElementById('stepper-1');
        const stepper2 = document.getElementById('stepper-2');

        document.getElementById('btn-next-step').addEventListener('click', () => {
            // Validate Step 1
            const customerNumber = document.getElementById('customer-number').value.trim();
            const customerName = document.getElementById('customer-name').value.trim();
            const customerStreet = document.getElementById('customer-street').value.trim();
            const customerStreetNum = document.getElementById('customer-street-num').value.trim();
            const customerCity = document.getElementById('customer-city').value.trim();

            if (!customerNumber || !customerName || !customerStreet || !customerStreetNum || !customerCity) {
                showToast("×™×© ×œ××œ× ××ª ×›×œ ×©×“×•×ª ×”×—×•×‘×” ×©×œ ×”×œ×§×•×— (××¡×¤×¨, ×©×, ×›×ª×•×‘×ª ××œ××”).", "error");
                return;
            }
            
            // Save Step 1 data
            newCustomerData = {
                customerNumber: customerNumber,
                name: customerName,
                phone: document.getElementById('customer-phone').value.trim(),
                contactPerson: document.getElementById('customer-contact').value.trim(),
                addressStreet: customerStreet,
                addressNumber: customerStreetNum,
                addressCity: customerCity,
                defaultAddress: `${customerStreet} ${customerStreetNum}, ${customerCity}`
            };

            // Move to Step 2
            step1.style.display = 'none';
            step2.style.display = 'block';
            stepper1.classList.remove('active');
            stepper1.classList.add('complete');
            stepper2.classList.add('active');
            feather.replace();
        });

        document.getElementById('btn-prev-step').addEventListener('click', () => {
            step2.style.display = 'none';
            step1.style.display = 'block';
            stepper2.classList.remove('active');
            stepper1.classList.remove('complete');
            stepper1.classList.add('active');
        });

        // --- Project Tags Logic ---
        const projectInput = document.getElementById('project-input');
        const addProjectBtn = document.getElementById('btn-add-project');
        const tagsContainer = document.getElementById('project-tags-container');

        const addProjectTag = () => {
            const tagText = projectInput.value.trim();
            if (tagText && !projectTags.includes(tagText)) {
                projectTags.push(tagText);
                renderProjectTags();
                projectInput.value = '';
            }
        };

        const renderProjectTags = () => {
            tagsContainer.innerHTML = '';
            projectTags.forEach(tag => {
                const tagEl = document.createElement('div');
                tagEl.className = 'tag-badge';
                tagEl.innerHTML = `
                    <span>${tag}</span>
                    <button type="button" class="tag-remove" data-tag="${tag}">
                        <i data-feather="x" class="w-4 h-4"></i>
                    </button>
                `;
                tagsContainer.appendChild(tagEl);
            });
            feather.replace();
        };

        tagsContainer.addEventListener('click', (e) => {
            const removeBtn = e.target.closest('.tag-remove');
            if (removeBtn) {
                const tagToRemove = removeBtn.dataset.tag;
                projectTags = projectTags.filter(tag => tag !== tagToRemove);
                renderProjectTags();
            }
        });

        addProjectBtn.addEventListener('click', addProjectTag);
        projectInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addProjectTag();
            }
        });

        // --- [NEW v3.0] File Upload Logic ---
        /**
         * Uploads a file to Google Apps Script.
         * @param {File} file - The file object to upload.
         * @param {string} customerId - The customer ID.
         * @returns {Promise<object>} - The result object from the server.
         */
        async function handleFileUpload(file, customerId) {
            if (WEB_APP_URL === "YOUR_APPS_SCRIPT_WEB_APP_URL_HERE") {
                throw new Error("×©×’×™××ª ×ª×¦×•×¨×”: ×™×© ×œ×”×’×“×™×¨ ××ª ×›×ª×•×‘×ª ×”-Web App ×‘×§×•×“ ×ª×—×™×œ×”.");
            }
            if (!file) throw new Error("×œ× × ×‘×—×¨ ×§×•×‘×¥.");
            
            // 1. Convert file to Base64
            const base64Data = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });

            // 2. Prepare payload for Apps Script
            const payload = {
                fileData: base64Data,
                fileName: file.name,
                mimeType: file.type,
                customerId: customerId || 'unknown'
            };
            
            // 3. Send to Apps Script Web App
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'cors', // Required for cross-domain request
                body: JSON.stringify(payload),
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8', // Apps Script quirk
                }
            });

            if (!response.ok) {
                throw new Error(`×©×’×™××ª ×©×¨×ª: ${response.statusText}`);
            }

            const result = await response.json();
            
            if (result.success && result.url) {
                SmartLog.info("File uploaded to Drive", { url: result.url, name: result.name });
                return result; // Return the full result (success, url, waUrl)
            } else {
                throw new Error(result.error || "×©×’×™××” ×œ× ×™×“×•×¢×” ×‘×©×¨×ª");
            }
        }
        
        // --- [NEW v3.0] Toast Notification ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = message;
            
            container.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Animate out
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // --- [NEW v3.1] Modified WhatsApp Share ---
        /**
         * Generates a WhatsApp share URL.
         * @param {object} orderData - The order data object.
         * @param {string|null} attachmentUrl - Optional URL of the uploaded file.
         * @returns {string} - The full WhatsApp URL.
         */
        function shareToWhatsApp(orderData, attachmentUrl = null) {
            const phone = "972508860896"; // ×™×¢×“ ××—×œ×§×ª ×”×–×× ×•×ª
            
            const customerContact = newCustomerData.contactPerson || newCustomerData.name;
            
            // Create attachment text if URL exists
            const attachmentText = attachmentUrl 
                ? `\n\nğŸ“ *×§×•×‘×¥ ××¦×•×¨×£:*\n${attachmentUrl}` 
                : '';

            const template = `
*âœ… ×”×–×× ×” ×—×“×©×” (×˜×•×¤×¡ ×”×§××”)*
ğŸ‘¤ *×œ×§×•×—:* ${newCustomerData.name} (#${newCustomerData.customerNumber})
ğŸ“ *×˜×œ×¤×•×Ÿ:* ${newCustomerData.phone}
ğŸ™â€â™‚ï¸ *××™×© ×§×©×¨:* ${customerContact}

ğŸšš *×¤×¨×˜×™ ××¡×¤×§×”:*
*×¡×•×’:* ${orderData.deliveryType || '×œ× ×¦×•×™×Ÿ'}
*××™×§×•×:* ${newCustomerData.defaultAddress}
*×ª××¨×™×š:* ${orderData.orderDate}

*×¤×¨×•×™×§×˜:* ${orderData.projectName.join(', ') || '×›×œ×œ×™'}

ğŸ“‹ *×ª×•×›×Ÿ ×”×”×–×× ×”:*
${orderData.notes || "--- ××™×Ÿ ×ª×•×›×Ÿ ---"}
${attachmentText}
            `;
            
            const waUrl = `https://api.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(template.trim())}`;
            SmartLog.info("Generated WhatsApp URL", { url: waUrl });
            return waUrl;
        }
        
        // --- Main Submit Logic ---
        document.getElementById('btn-submit-full').addEventListener('click', async (e) => {
            const btn = e.target;
            btn.disabled = true;
            btn.innerHTML = '<div class="loader" style="width:20px; height:20px; border-width: 2px; margin: 0 auto;"></div>';

            if (initializationError) {
                 showToast("×©×’×™××ª ×—×™×‘×•×¨ ×œ×©×¨×ª. ×¨×¢× ×Ÿ ××ª ×”×“×£.", "error");
                 btn.disabled = false;
                 btn.innerHTML = '<i data-feather="check-circle" class="inline-block w-5 h-5"></i> ×©××•×¨ ×”×›×œ ×•×©×œ×— ×œ-WhatsApp';
                 feather.replace();
                 return;
            }

            try {
                // --- Step 1: Create or Find Customer ---
                // Using Auto-ID as discussed (v2.2 logic)
                const customerRef = doc(collection(db, "customers"));
                
                // [FIX v3.1] Replaced serverTimestamp with new Date() for array
                const customerData = {
                    ...newCustomerData,
                    createdAt: serverTimestamp(),
                    auditLog: [{
                        action: "Created (via CRM Form)",
                        timestamp: new Date() // [FIX v3.1]
                    }]
                };
                
                // Check if customer *number* already exists (to prevent duplicates)
                const q = query(collection(db, "customers"), where("customerNumber", "==", newCustomerData.customerNumber), limit(1));
                const existingSnap = await getDocs(q);
                
                if (!existingSnap.empty) {
                    // Customer with this NUMBER already exists
                    showToast("×©×’×™××”: ××¡×¤×¨ ×œ×§×•×— ×–×” ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª.", "error");
                    throw new Error("Customer number already exists.");
                }
                
                await setDoc(customerRef, customerData);
                const newCustomerId = customerRef.id; // This is the Auto-ID
                SmartLog.info("Customer created successfully", { id: newCustomerId });
                showToast("×©×œ×‘ 1: ×œ×§×•×— × ×•×¦×¨ ×‘×”×¦×œ×—×”!", "success");

                // --- Step 2: Handle File Upload (if any) ---
                const file = document.getElementById('file-upload').files[0];
                let attachmentUrl = null;
                let whatsAppUrl = null; // This will be the main WA link

                if (file) {
                    showToast('××¢×œ×” ×§×•×‘×¥... ×× × ×”××ª×Ÿ', 'info');
                    document.getElementById('upload-status').innerText = '××¢×œ×” ×§×•×‘×¥...';
                    document.getElementById('upload-status').classList.remove('hidden');
                    
                    try {
                        // Pass the customer *number* to the Apps Script
                        const uploadResult = await handleFileUpload(file, newCustomerData.customerNumber);
                        attachmentUrl = uploadResult.url; // GDrive URL
                        whatsAppUrl = uploadResult.waUrl; // WA link with GDrive URL
                        
                        document.getElementById('upload-status').innerText = '×§×•×‘×¥ ×¦×•×¨×£ ×‘×”×¦×œ×—×”!';
                        showToast('×§×•×‘×¥ ×¦×•×¨×£ ×‘×”×¦×œ×—×”!', 'success');
                        
                    } catch (uploadError) {
                        SmartLog.error(uploadError, "Upload.AppsScript");
                        showToast(`×©×’×™××” ×‘×”×¢×œ××ª ×§×•×‘×¥: ${uploadError.message}`, 'error');
                        // Don't block the order, just log the error
                        document.getElementById('upload-status').innerText = '×©×’×™××” ×‘×”×¢×œ××ª ×§×•×‘×¥. ×”×”×–×× ×” ×ª×™×•×•×¦×¨ ×œ×œ× ×”×§×•×‘×¥.';
                    }
                }

                // --- Step 3: Create Order ---
                const customOrderNumber = document.getElementById('order-number').value.trim();
                const orderId = customOrderNumber || `AUTO-${Date.now().toString().slice(-6)}`;
                
                const orderData = {
                    order_id: orderId,
                    customer: {
                        id: newCustomerId,
                        name: newCustomerData.name,
                        phone: newCustomerData.phone,
                        customerNumber: newCustomerData.customerNumber
                    },
                    address: newCustomerData.defaultAddress,
                    projectName: projectTags, // Save array of projects
                    deliveryType: document.getElementById('order-transport-type').value,
                    notes: document.getElementById('order-content').value,
                    attachmentUrl: attachmentUrl, // Add the GDrive link
                    orderDate: new Date().toISOString().split('T')[0], // Use today's date
                    status: "×—×“×©",
                    createdBy: "CRM-Form",
                    createdAt: serverTimestamp(),
                    lastModified: serverTimestamp()
                };

                const orderRef = doc(db, "orders", orderId);
                await setDoc(orderRef, orderData);
                SmartLog.info("Order created successfully", { id: orderId });

                // --- Step 4: Share to WhatsApp ---
                if (whatsAppUrl) {
                    // We already have the WA link from the file upload (which includes the file URL)
                    window.open(whatsAppUrl, '_blank');
                    showToast('×”×–×× ×” ×•×§×•×‘×¥ × ×•×¦×¨×•! ×¤×•×ª×— WhatsApp...', 'success');
                } else {
                    // No file was attached, so we generate a WA link for the order *only*
                    const orderWaUrl = shareToWhatsApp(orderData, null); // Pass null for attachment
                    window.open(orderWaUrl, '_blank');
                    showToast('×”×–×× ×” × ×•×¦×¨×”! ×¤×•×ª×— WhatsApp...', 'success');
                }

                // --- Step 5: Reset Form ---
                setTimeout(() => {
                    // Reset all fields
                    document.getElementById('customer-number').value = '';
                    document.getElementById('customer-name').value = '';
                    document.getElementById('customer-phone').value = '';
                    document.getElementById('customer-contact').value = '';
                    document.getElementById('customer-street').value = '';
                    document.getElementById('customer-street-num').value = '';
                    document.getElementById('customer-city').value = '';
                    document.getElementById('order-number').value = '';
                    document.getElementById('order-transport-type').value = '';
                    document.getElementById('order-content').value = '';
                    document.getElementById('project-input').value = '';
                    document.getElementById('file-upload').value = '';
                    document.getElementById('upload-status').classList.add('hidden');
                    projectTags = [];
                    renderProjectTags();
                    
                    // Go back to step 1
                    step2.style.display = 'none';
                    step1.style.display = 'block';
                    stepper2.classList.remove('active');
                    stepper1.classList.remove('complete');
                    stepper1.classList.add('active');
                    
                    btn.disabled = false;
                    btn.innerHTML = '<i data-feather="check-circle" class="inline-block w-5 h-5"></i> ×©××•×¨ ×”×›×œ ×•×©×œ×— ×œ-WhatsApp';
                    feather.replace();
                }, 2000); // Short delay to let user see success

            } catch (error) {
                SmartLog.error(error, "Submit.FullOrder");
                showToast(`×©×’×™××” ×§×¨×™×˜×™×ª: ${error.message}`, "error");
                btn.disabled = false;
                btn.innerHTML = '<i data-feather="check-circle" class="inline-block w-5 h-5"></i> ×©××•×¨ ×”×›×œ ×•×©×œ×— ×œ-WhatsApp';
                feather.replace();
            }
        });

        // --- Init Icons ---
        feather.replace();
    </script>
</body>
</html>

