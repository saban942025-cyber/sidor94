<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>הקמת לקוח והזמנה חדשה</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root { --blur-value: 12px; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', 'Arial', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        html.dark body {
            background-color: #1f2937; /* gray-800 */
        }
        
        /* Glassmorphism Card */
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(var(--blur-value));
            -webkit-backdrop-filter: blur(var(--blur-value));
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        html.dark .glass-card {
            background: rgba(31, 41, 55, 0.7); /* gray-800/70 */
            border: 1px solid rgba(75, 85, 99, 0.5); /* gray-600/50 */
        }
        
        /* Stepper */
        .stepper-step {
            display: flex;
            align-items: center;
            opacity: 0.5;
        }
        .stepper-step.active {
            opacity: 1;
        }
        .step-circle {
            width: 2.5rem; /* 40px */
            height: 2.5rem; /* 40px */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-600 */
        }
        .stepper-step.active .step-circle {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
        .step-line {
            flex-grow: 1;
            height: 2px;
            background-color: #e5e7eb; /* gray-200 */
        }
        
        /* Input Styles */
        .form-input {
            @apply w-full p-3 border rounded-md bg-white/50 dark:bg-gray-700/50 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .form-label {
            @apply block text-lg font-medium mb-2 text-gray-700 dark:text-gray-200;
        }
        .form-grid {
             @apply grid grid-cols-1 md:grid-cols-2 gap-6;
        }
        
        /* Button Styles */
        .btn {
            @apply w-full p-4 text-lg font-bold rounded-lg shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-gray-600 dark:text-white dark:hover:bg-gray-500 focus:ring-gray-400;
        }
        
    </style>
</head>
<body class="dark:bg-gray-900">

    <!-- Dark Mode Toggle -->
    <button id="theme-toggle" class="fixed top-4 right-4 p-3 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 shadow-lg z-50">
        <i data-feather="sun" class="hidden dark:block"></i>
        <i data-feather="moon" class="block dark:hidden"></i>
    </button>

    <div class="container mx-auto max-w-3xl p-4 md:p-8">
        
        <h1 class="text-5xl font-bold text-center mb-8 text-gray-800 dark:text-white">הקמה מהירה</h1>
        
        <!-- Main Card -->
        <div class="glass-card rounded-xl shadow-2xl overflow-hidden">
            
            <!-- Stepper -->
            <div class="flex p-6 border-b border-gray-200/50 dark:border-gray-700/50">
                <div id="step-1-indicator" class="stepper-step active w-1/2">
                    <div class="step-circle">1</div>
                    <span class="mr-3 text-lg font-semibold text-gray-800 dark:text-white">פרטי לקוח</span>
                </div>
                <div class="step-line mt-5 mx-4"></div>
                <div id="step-2-indicator" class="stepper-step w-1/2 justify-end">
                    <span class="ml-3 text-lg font-semibold text-gray-800 dark:text-white">פרטי הזמנה</span>
                    <div class="step-circle">2</div>
                </div>
            </div>

            <!-- Form Content -->
            <div class="p-6 md:p-10">
                
                <!-- === Step 1: Customer Details === -->
                <section id="step-1-form" class="space-y-6">
                    <div class="form-grid">
                        <div>
                            <label for="customer-name-new" class="form-label">שם לקוח מלא (חובה)</label>
                            <input type="text" id="customer-name-new" class="form-input text-xl" required>
                        </div>
                        <div>
                            <label for="customer-number-new" class="form-label">מספר לקוח (חובה)</label>
                            <input type="text" id="customer-number-new" class="form-input text-xl" placeholder="למשל: 102030" required>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div>
                            <label for="customer-phone-new" class="form-label">טלפון ראשי (חובה)</label>
                            <input type="tel" id="customer-phone-new" class="form-input text-xl" required>
                        </div>
                        <div>
                            <label for="customer-contact-new" class="form-label">איש קשר (רשות)</label>
                            <input type="text" id="customer-contact-new" class="form-input text-xl">
                        </div>
                    </div>
                    
                    <hr class="dark:border-gray-600">

                    <label class="form-label">כתובת (חובה)</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <input type="text" id="customer-city-new" placeholder="עיר" class="form-input text-xl" required>
                        <input type="text" id="customer-street-new" placeholder="רחוב" class="form-input text-xl" required>
                        <input type="text" id="customer-streetnum-new" placeholder="מספר" class="form-input text-xl" required>
                    </div>
                    
                    <div>
                        <label for="customer-edit-coords" class="form-label">קואורדינטות (רשות)</label>
                        <input type="text" id="customer-edit-coords" class="form-input text-xl" placeholder="הדבק מ-Google Maps (למשל: 32.1, 34.9)">
                    </div>

                    <button id="next-step-btn" class="btn btn-primary mt-8">
                        הבא: פרטי הזמנה
                        <i data-feather="arrow-left" class="inline-block"></i>
                    </button>
                </section>
                
                <!-- === Step 2: Order Details === -->
                <section id="step-2-form" class="space-y-6" style="display: none;">
                    
                    <div class="p-4 bg-blue-50 dark:bg-gray-700 rounded-lg border border-blue-200 dark:border-blue-600">
                        <h3 class="text-xl font-bold text-blue-800 dark:text-blue-200">לקוח: <span id="customer-summary-name"></span></h3>
                        <p class="text-lg text-gray-700 dark:text-gray-300">מספר: <span id="customer-summary-id"></span></p>
                    </div>

                    <div>
                        <label for="order-project-name" class="form-label">שם פרויקט (רשות)</label>
                        <input type="text" id="order-project-name" placeholder="לדוגמה: בניין בראשון" class="form-input text-xl">
                    </div>

                    <div class="form-grid">
                        <div>
                            <label for="order-date" class="form-label">תאריך אספקה</label>
                            <input type="date" id="order-date" class="form-input text-xl" required>
                        </div>
                        <div>
                            <label for="order-time" class="form-label">שעת אספקה</label>
                            <input type="time" id="order-time" class="form-input text-xl">
                        </div>
                    </div>
                    
                    <div class="form-grid">
                         <div>
                            <label for="order-delivery-type" class="form-label">סוג הובלה</label>
                            <select id="order-delivery-type" class="form-input text-xl" required>
                                <option value="">בחר סוג הובלה</option>
                                <option value="משאית">משאית</option>
                                <option value="טריילר">טריילר</option>
                                <option value="מנוף">מנוף</option>
                                <option value="הצבת מכולה">הצבת מכולה</option>
                                <option value="פינוי מכולה">פינוי מכולה</option>
                                <option value="החלפת מכולה">החלפת מכולה</option>
                                <option value="איסוף עצמי">איסוף עצמי</option>
                                <option value="אחר">אחר</option>
                            </select>
                        </div>
                        <div>
                            <label for="order-warehouse" class="form-label">מחסן</label>
                            <select id="order-warehouse" class="form-input text-xl" required>
                                <option value="">בחר מחסן</option>
                                <option value="החרש">החרש</option>
                                <option value="התלמיד">התלמיד</option>
                                <option value="30-שארק">30-שארק</option>
                                <option value="אחר">אחר</option>
                            </select>
                        </div>
                    </div>
                
                    <div>
                        <label for="order-notes" class="form-label">תוכן ההזמנה (פריטים)</label>
                        <textarea id="order-notes" rows="4" placeholder="לדוגמה: 10 בלוק 20, 5 מלט..." class="form-input text-xl"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 pt-8">
                         <button id="prev-step-btn" type="button" class="btn btn-secondary">
                             <i data-feather="arrow-right" class="inline-block"></i>
                             חזור: פרטי לקוח
                         </button>
                         <button id="submit-order-btn" type="button" class="btn btn-primary">
                             צור לקוח והזמנה
                             <i data-feather="check" class="inline-block"></i>
                         </button>
                    </div>
                </section>

            </div>
        </div>
        
        <!-- Toast Container -->
        <div id="toast-container" class="fixed bottom-5 left-5 z-[5000]"></div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, doc, addDoc, setDoc, updateDoc, 
            collection, query, where, Timestamp, runTransaction, getDocs, orderBy, 
            serverTimestamp, writeBatch, arrayUnion
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949",
          storageBucket: "saban94-78949.firebasestorage.app", 
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a", 
          measurementId: "G-XV6RZDESSB"
        };
        
        let db, auth;
        let allCustomers = [];
        let newCustomerData = {}; // Store Step 1 data
        
        try {
            const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
            db = getFirestore(app);
            auth = getAuth(app);
            await signInAnonymously(auth);
            console.log("Firebase Initialized & Signed in Anonymously.");
            await listenForCustomers(); // Load customers for validation
        } catch (e) {
            console.error("Firebase Initialization Failed:", e);
            showToast('שגיאת התחברות חמורה ל-Firebase', 'error');
        }

        // --- Dark Mode Toggle ---
        const themeToggle = document.getElementById('theme-toggle');
        const htmlEl = document.documentElement;
        
        // On page load or when changing themes, best to add inline in `head` to avoid FOUC
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          htmlEl.classList.add('dark');
        } else {
          htmlEl.classList.remove('dark');
        }

        themeToggle.addEventListener('click', () => {
            if (htmlEl.classList.contains('dark')) {
                htmlEl.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                htmlEl.classList.add('dark');
                localStorage.theme = 'dark';
            }
            feather.replace(); // Refresh icons
        });
        
        // --- Stepper UI Logic ---
        const step1Form = document.getElementById('step-1-form');
        const step2Form = document.getElementById('step-2-form');
        const step1Indicator = document.getElementById('step-1-indicator');
        const step2Indicator = document.getElementById('step-2-indicator');
        
        document.getElementById('next-step-btn').addEventListener('click', handleStep1Next);
        document.getElementById('prev-step-btn').addEventListener('click', showStep1);
        document.getElementById('submit-order-btn').addEventListener('click', submitFullOrder);

        function showStep1() {
            step1Form.style.display = 'block';
            step2Form.style.display = 'none';
            step1Indicator.classList.add('active');
            step2Indicator.classList.remove('active');
            window.scrollTo(0, 0);
        }

        function showStep2() {
            step1Form.style.display = 'none';
            step2Form.style.display = 'block';
            step1Indicator.classList.remove('active');
            step2Indicator.classList.add('active');
            window.scrollTo(0, 0);
        }

        // --- Data Listeners ---
        async function listenForCustomers() {
            const q = query(collection(db, 'customers'));
            try {
                const snapshot = await getDocs(q);
                allCustomers = [];
                snapshot.forEach(doc => {
                    allCustomers.push({ id: doc.id, ...doc.data() });
                });
                console.log(`Loaded ${allCustomers.length} customers for validation.`);
            } catch (error) {
                console.error("Failed to load customers:", error);
                showToast("שגיאה בטעינת מאגר לקוחות", "error");
            }
        }
        
        // --- Form Logic ---
        
        async function handleStep1Next() {
            // 1. Read Data
            newCustomerData = {
                name: document.getElementById('customer-name-new').value.trim(),
                customerNumber: document.getElementById('customer-number-new').value.trim(),
                phone: document.getElementById('customer-phone-new').value.trim(),
                contactPerson: document.getElementById('customer-contact-new').value.trim(),
                addressStreet: document.getElementById('customer-street-new').value.trim(),
                addressNumber: document.getElementById('customer-streetnum-new').value.trim(),
                addressCity: document.getElementById('customer-city-new').value.trim(),
                coordsString: document.getElementById('customer-edit-coords').value.trim(),
                customLat: null,
                customLon: null
            };
            
            // 2. Validate
            if (!newCustomerData.name || !newCustomerData.customerNumber || !newCustomerData.phone || !newCustomerData.addressStreet || !newCustomerData.addressNumber || !newCustomerData.addressCity) {
                showToast("שם, מספר לקוח, טלפון וכתובת מלאה הם שדות חובה.", "error");
                return;
            }
            
            // 3. Validate Coords (if provided)
            if (newCustomerData.coordsString) {
                const parts = newCustomerData.coordsString.split(',');
                if (parts.length === 2 && !isNaN(parseFloat(parts[0])) && !isNaN(parseFloat(parts[1]))) {
                    newCustomerData.customLat = parseFloat(parts[0]);
                    newCustomerData.customLon = parseFloat(parts[1]);
                } else {
                    showToast("פורמט קואורדינטות לא תקין. השתמש ב- lat, lon או השאר ריק.", "error");
                    return;
                }
            }
            
            // 4. Validate Customer Number Uniqueness
            const existingCustomer = allCustomers.find(c => c.customerNumber === newCustomerData.customerNumber);
            if (existingCustomer) {
                showToast(`שגיאה: מספר לקוח ${newCustomerData.customerNumber} כבר קיים עבור "${existingCustomer.name}".`, "error");
                return;
            }
            
            // 5. All good, move to next step
            document.getElementById('customer-summary-name').innerText = newCustomerData.name;
            document.getElementById('customer-summary-id').innerText = newCustomerData.customerNumber;
            document.getElementById('order-date').value = new Date().toISOString().split('T')[0]; // Set default date
            showStep2();
        }
        
        async function submitFullOrder() {
            const btn = document.getElementById('submit-order-btn');
            btn.disabled = true;
            btn.innerText = 'מעבד...';
            
            // 1. Read Order Data
            const orderData = {
                projectName: document.getElementById('order-project-name').value.trim(),
                orderDate: document.getElementById('order-date').value,
                orderTime: document.getElementById('order-time').value,
                deliveryType: document.getElementById('order-delivery-type').value,
                warehouse: document.getElementById('order-warehouse').value,
                notes: document.getElementById('order-notes').value,
            };
            
            // 2. Validate Order Data
            if (!orderData.orderDate || !orderData.deliveryType || !orderData.warehouse) {
                showToast("תאריך, סוג הובלה ומחסן הם שדות חובה.", "error");
                btn.disabled = false;
                btn.innerText = 'צור לקוח והזמנה';
                return;
            }
            
            // 3. Prepare Batch Write
            try {
                const batch = writeBatch(db);
                
                // --- 3a. Prepare Customer Document ---
                const customerRef = doc(collection(db, "customers"));
                const customerObject = {
                    ...newCustomerData,
                    defaultAddress: `${newCustomerData.addressStreet} ${newCustomerData.addressNumber}, ${newCustomerData.addressCity}`,
                    auditLog: arrayUnion({
                        action: "Created",
                        timestamp: serverTimestamp()
                    }),
                    createdAt: serverTimestamp() // Added for tracking
                };
                delete customerObject.coordsString; // Clean up temp field
                batch.set(customerRef, customerObject);

                // --- 3b. Prepare Order Document ---
                const orderRef = doc(collection(db, "orders"));
                const order_id = `AUTO-${Date.now().toString().slice(-6)}`;
                const fullOrderObject = {
                    ...orderData,
                    customer: {
                        id: customerRef.id,
                        name: newCustomerData.name,
                        phone: newCustomerData.phone,
                        customerNumber: newCustomerData.customerNumber
                    },
                    customer_name: newCustomerData.name, // Flat field for compatibility
                    customer_id: newCustomerData.customerNumber, // Flat field for compatibility
                    address: customerObject.defaultAddress,
                    latitude: newCustomerData.customLat, // Add lat
                    longitude: newCustomerData.customLon, // Add lon
                    status: "חדש",
                    createdAt: serverTimestamp(),
                    lastModified: serverTimestamp(),
                    createdBy: "AdminPanel-SingleForm",
                    order_id: order_id
                };
                batch.set(orderRef, fullOrderObject);
                
                // --- 4. Commit Batch ---
                await batch.commit();
                
                showToast("הלקוח וההזמנה נוצרו בהצלחה!", "success");
                
                // --- 5. Share to WhatsApp ---
                await shareToWhatsApp(fullOrderObject);
                
                // --- 6. Reset Form ---
                // Reset step 1
                document.getElementById('customer-name-new').value = '';
                document.getElementById('customer-number-new').value = '';
                document.getElementById('customer-phone-new').value = '';
                document.getElementById('customer-contact-new').value = '';
                document.getElementById('customer-street-new').value = '';
                document.getElementById('customer-streetnum-new').value = '';
                document.getElementById('customer-city-new').value = '';
                document.getElementById('customer-edit-coords').value = '';
                // Reset step 2
                document.getElementById('order-project-name').value = '';
                document.getElementById('order-time').value = '';
                document.getElementById('order-delivery-type').value = '';
                document.getElementById('order-warehouse').value = '';
                document.getElementById('order-notes').value = '';
                
                newCustomerData = {}; // Clear temp data
                await listenForCustomers(); // Refresh customer list in background
                showStep1(); // Go back to step 1

            } catch (error) {
                console.error("Failed to create customer/order:", error);
                showToast(`שגיאה קריטית: ${error.message}`, "error");
            } finally {
                btn.disabled = false;
                btn.innerText = 'צור לקוח והזמנה';
            }
        }
        
        async function shareToWhatsApp(orderData) {
            const phone = "972508860896"; // טלפון מנהל
            
            const template = `
*✅ הזמנה חדשה (טופס הקמה)*
=================
*לקוח:* ${orderData.customer.name || 'לא צוין'}
*מס' לקוח:* ${orderData.customer.customerNumber || 'N/A'}
*טלפון:* ${orderData.customer.phone || 'N/A'}
*איש קשר:* ${newCustomerData.contactPerson || 'לא צוין'}

*פרויקט:* ${orderData.projectName || 'לא צוין'}
=================
*פרטי אספקה:*
*סוג הובלה:* ${orderData.deliveryType || 'לא צוין'}
*מיקום:* ${orderData.address || 'לא צוין'}
*תאריך:* ${orderData.orderDate}
*שעה:* ${orderData.orderTime || 'לא צוין'}
=================
*תוכן ההזמנה:*
${orderData.notes || "--- אין תוכן ---"}
            `;
            
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(template)}`;
            window.open(whatsappUrl, '_blank');
        }

        // --- Toast Utility ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            let bgColor = 'bg-gray-800 dark:bg-gray-200 text-white dark:text-black';
            if (type === 'success') {
                bgColor = 'bg-green-500 text-white';
            } else if (type === 'error') {
                bgColor = 'bg-red-500 text-white';
            }
            
            toast.className = `p-4 rounded-lg shadow-lg ${bgColor} mb-2 transform translate-y-10 opacity-0 transition-all duration-300 ease-out text-lg`;
            toast.innerHTML = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-y-10');
                toast.classList.remove('opacity-0');
            }, 100);
            
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }

        // --- Init Icons ---
        feather.replace();

    </script>
</body>
</html>
