<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>拽转 拽  (v4.0)</title>
    <!-- 
      DeliveryMaster CRM Form v4.0 (注爪 转拽)
      
      Changelog:
      - [注爪] 砖 注爪 拽爪注 拽抓 index (15).html.
      - [注爪] 住驻 转专转 专砖转 住 专拽注 砖 砖专.
      - [注爪] 驻住 注爪 "注祝" 注爪 专住 (card) 专 拽.
      - [驻拽爪]  拽 砖 v3.2 ( 砖 GPS) 砖专 .
    -->

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp, setDoc, doc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        // 住驻转 Storage SDK
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
    </script>
    
    <style>
        /* 住转 祝 砖专 (index 15) */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        body {
            background-color: #f5f7fa; /* 专拽注 砖专 */
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background-color: var(--light);
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }
        
        header h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        /* 住 专住 砖注祝 转 驻住 */
        .form-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
            border: 1px solid #e5e7eb;
            max-width: 800px;
            margin: 0 auto;
            overflow: hidden; /*  砖-stepper  砖 */
        }

        /* 住转 驻住 拽转 拽 (add_customers) */
        .form-input {
            @apply w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-base focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all duration-200 ease-in-out;
        }
        .form-textarea {
            @apply w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-base focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all duration-200 ease-in-out h-28;
        }
        .btn {
            @apply text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 ease-in-out;
        }
        .btn:disabled {
            @apply bg-gray-400 cursor-not-allowed;
        }
        
        /* Stepper */
        .stepper-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        .step {
            display: flex;
            align-items: center;
            flex: 1;
        }
        .step:last-child {
            flex: 0;
        }
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e0e7ff; /* indigo-100 */
            color: #4338ca; /* indigo-700 */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        .step-label {
            margin-right: 0.75rem;
            color: #6b7280; /* gray-500 */
            font-weight: 500;
        }
        .step-line {
            flex: 1;
            height: 2px;
            background-color: #e5e7eb; /* gray-200 */
            margin: 0 1rem;
        }
        
        .step.active .step-circle {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
        }
        .step.active .step-label {
            color: #111827; /* gray-900 */
            font-weight: 600;
        }
        
        .step.complete .step-circle {
            background-color: #10b981; /* green-500 */
            color: white;
        }
        .step.complete .step-label {
            color: #374151; /* gray-700 */
        }
        .step.complete + .step-line {
            background-color: #10b981; /* green-500 */
        }

        /* Modal & Toast */
        .modal {
            @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300;
        }
        .modal-content {
            @apply bg-white rounded-lg shadow-2xl p-6 w-full max-w-md;
        }
        .toast {
            @apply fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-lg text-white font-semibold z-[100] transition-all duration-300;
        }
        .toast.success { @apply bg-green-500; }
        .toast.error { @apply bg-red-500; }
        .toast.info { @apply bg-blue-500; }
        
    </style>
</head>
<body class="p-4 md:p-8">

    <header>
        <h1>驻住 拽转 拽 </h1>
        <p>注专转 DeliveryMaster (v4.0)</p>
    </header>

    <div class="form-card">
        
        <!-- Stepper -->
        <div class="stepper-container">
            <div id="stepper-1" class="step active">
                <div class="step-circle">1</div>
                <div class="step-label">驻专 拽</div>
            </div>
            <div class="step-line"></div>
            <div id="stepper-2" class="step">
                <div class="step-circle">2</div>
                <div class="step-label">驻专 </div>
            </div>
        </div>
        
        <div class="p-6 md:p-10">
            <!-- 砖 1: 驻专 拽 -->
            <div id="step-1" class="space-y-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">砖 1: 驻专 拽</h2>
                
                <div>
                    <label for="customer-name" class="text-sm font-medium text-gray-600">砖 拽 </label>
                    <input type="text" id="customer-name" placeholder="砖 拽" class="form-input mt-1">
                </div>
                
                <div>
                    <label for="customer-id" class="text-sm font-medium text-gray-600">住驻专 拽 ()</label>
                    <input type="text" id="customer-id" placeholder="住驻专  " class="form-input mt-1">
                </div>
                
                <div>
                    <label for="customer-phone" class="text-sm font-medium text-gray-600">驻 砖 拽砖专</label>
                    <input type="tel" id="customer-phone" placeholder="驻 " class="form-input mt-1">
                </div>
                
                <div>
                    <label for="contact-person" class="text-sm font-medium text-gray-600">砖 砖 拽砖专</label>
                    <input type="text" id="contact-person" placeholder="砖 砖 拽砖专 转专" class="form-input mt-1">
                </div>

                <div class="pt-4">
                    <h3 class="text-lg font-semibold mb-2">转转 专专转 </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="address-city" placeholder="注专" class="form-input">
                        <input type="text" id="address-street" placeholder="专" class="form-input">
                        <input type="text" id="address-number" placeholder="住驻专" class="form-input">
                    </div>
                </div>

                <!-- [住驻 砖 v3.2] 住驻转 砖 GPS 驻  -->
                <div class="pt-2">
                    <label for="customer-gps" class="text-sm font-medium text-gray-600">
                        拽专转 (拽 -Google Maps)
                    </label>
                    <input type="text" id="customer-gps" placeholder=": 32.0853, 34.7818" class="form-input text-left mt-1" style="direction: ltr;">
                    <p class="text-xs text-gray-500 mt-1">驻爪. 拽 拽 驻.</p>
                </div>

                <button id="next-step-btn" class="btn bg-blue-600 hover:bg-blue-700 w-full mt-6">
                    : 驻专  <i data-feather="arrow-left" class="inline-block w-5 h-5"></i>
                </button>
            </div>
            
            <!-- 砖 2: 驻专  -->
            <div id="step-2" class="space-y-4" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">砖 2:  专砖</h2>
                
                <div>
                    <label for="order-date" class="text-sm font-medium text-gray-600">转专 住驻拽</label>
                    <input type="date" id="order-date" class="form-input mt-1">
                </div>
                
                <div>
                    <label for="order-time" class="text-sm font-medium text-gray-600">砖注转 住驻拽</label>
                    <input type="time" id="order-time" class="form-input mt-1">
                </div>
                
                <div>
                    <label for="order-content" class="text-sm font-medium text-gray-600">转 </label>
                    <textarea id="order-content" placeholder="驻专  (拽住 驻砖)" class="form-textarea mt-1"></textarea>
                </div>
                
                <div>
                    <label for="project-input" class="text-sm font-medium text-gray-600">驻专拽 / 转转 (驻爪)</label>
                    <div class="flex gap-2">
                        <input type="text" id="project-input" placeholder="住祝 转转 抓 专" class="form-input mt-1">
                    </div>
                    <div id="project-tags-container" class="flex flex-wrap gap-2 mt-2"></div>
                </div>

                <div>
                    <label for="file-upload" class="text-sm font-medium text-gray-600">注转 拽抓 (转注/PDF)</label>
                    <input type="file" id="file-upload" class="form-input mt-1 text-sm">
                    <div id="upload-status" class="hidden text-sm text-blue-600 font-medium mt-2"></div>
                </div>

                <div class="flex gap-4 mt-6">
                    <button id="prev-step-btn" class="btn bg-gray-500 hover:bg-gray-600 w-1/3">
                        <i data-feather="arrow-right" class="inline-block w-5 h-5"></i> 专
                    </button>
                    <button id="submit-btn" class="btn bg-green-600 hover:bg-green-700 w-2/3">
                        <i data-feather="check-circle" class="inline-block w-5 h-5"></i> 砖专  砖 -WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast container -->
    <div id="toast-container"></div>
    
    <!-- Modal -->
    <div id="customer-modal" class="modal hidden opacity-0">
        <div class="modal-content transform scale-90 transition-transform duration-300">
            <h3 class="text-xl font-bold mb-4">拽 拽</h3>
            <p id="modal-text" class="mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="modal-close-btn" class="btn bg-gray-200 text-gray-800 hover:bg-gray-300 w-auto"></button>
                <button id="modal-confirm-btn" class="btn bg-blue-600 hover:bg-blue-700 w-auto">砖 砖 2</button>
            </div>
        </div>
    </div>

    <!-- [砖  砖 住拽专驻 v3.2] -->
    <script type="module">
        // Import all required functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp, setDoc, doc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo",
            authDomain: "saban94-78949.firebaseapp.com",
            projectId: "saban94-78949",
            storageBucket: "saban94-78949.appspot.com",
            messagingSenderId: "41553157903",
            appId: "1:41553157903:web:cc33d252cff023be97a87a",
            measurementId: "G-XV6RZDESSB"
        };

        // --- Init Firebase ---
        let db, auth, storage;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);
            
            // Authenticate anonymously
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("User is authenticated:", user.uid);
                } else {
                    signInAnonymously(auth).catch((error) => {
                        console.error("Anonymous sign-in failed:", error);
                    });
                }
            });
        } catch (e) {
            console.error("Firebase initialization error:", e);
            alert("砖转 转 拽专转.  转 转专 住住 转.");
        }

        // --- Collections ---
        const CUSTOMERS_COLLECTION = 'customers';
        const ORDERS_COLLECTION = 'orders_v2'; // Using v2 as seen in other files

        // --- DOM Elements ---
        const step1 = document.getElementById('step-1');
        const step2 = document.getElementById('step-2');
        const stepper1 = document.getElementById('stepper-1');
        const stepper2 = document.getElementById('stepper-2');
        const nextStepBtn = document.getElementById('next-step-btn');
        const prevStepBtn = document.getElementById('prev-step-btn');
        const submitBtn = document.getElementById('submit-btn');
        const projectInput = document.getElementById('project-input');
        const projectTagsContainer = document.getElementById('project-tags-container');
        const fileUpload = document.getElementById('file-upload');
        const uploadStatus = document.getElementById('upload-status');
        
        // Modal elements
        const modal = document.getElementById('customer-modal');
        const modalText = document.getElementById('modal-text');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');

        let projectTags = [];
        let existingCustomerData = null;
        let uploadedFileUrl = null;

        // --- Logger ---
        const SmartLog = {
            info: (msg) => console.log(`[INFO] ${msg}`),
            error: (err, context) => console.error(`[ERROR | ${context}]`, err),
        };

        // --- Toast Utility ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- Step Navigation ---
        function goToStep2() {
            step1.style.display = 'none';
            step2.style.display = 'block';
            stepper1.classList.remove('active');
            stepper1.classList.add('complete');
            stepper2.classList.add('active');
            feather.replace();
        }

        nextStepBtn.addEventListener('click', async () => {
            const customerId = document.getElementById('customer-id').value.trim();
            if (!customerId) {
                showToast("  住驻专 拽", "error");
                return;
            }
            
            // Check if customer exists
            nextStepBtn.disabled = true;
            nextStepBtn.innerText = "拽 转...";
            try {
                const q = query(collection(db, CUSTOMERS_COLLECTION), where("customerNumber", "==", customerId));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    // Customer exists
                    existingCustomerData = querySnapshot.docs[0].data();
                    modalText.innerText = `拽 "${existingCustomerData.name}" (${customerId}) 专 拽 注专转. 
                                            专爪 砖 爪专 注专  砖?`;
                    modal.classList.remove('hidden', 'opacity-0');
                    modal.querySelector('.modal-content').classList.remove('scale-90');
                } else {
                    // New customer
                    existingCustomerData = null;
                    goToStep2();
                }
            } catch (error) {
                SmartLog.error(error, "CheckCustomerExists");
                showToast(`砖 拽转 拽: ${error.message}`, "error");
            } finally {
                nextStepBtn.disabled = false;
                nextStepBtn.innerHTML = ': 驻专  <i data-feather="arrow-left" class="inline-block w-5 h-5"></i>';
                feather.replace();
            }
        });

        prevStepBtn.addEventListener('click', () => {
            step2.style.display = 'none';
            step1.style.display = 'block';
            stepper2.classList.remove('active');
            stepper1.classList.remove('complete');
            stepper1.classList.add('active');
            feather.replace();
        });

        // Modal logic
        modalCloseBtn.addEventListener('click', () => {
            modal.classList.add('hidden', 'opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-90');
            existingCustomerData = null;
        });
        modalConfirmBtn.addEventListener('click', () => {
            modal.classList.add('hidden', 'opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-90');
            goToStep2();
        });

        // --- Project Tags ---
        function renderProjectTags() {
            projectTagsContainer.innerHTML = '';
            projectTags.forEach((tag, index) => {
                const tagEl = document.createElement('span');
                tagEl.className = 'bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full flex items-center gap-2';
                tagEl.innerHTML = `<span>${tag}</span>
                                 <button type="button" class="text-blue-600" data-index="${index}">&times;</button>`;
                projectTagsContainer.appendChild(tagEl);
            });
        }

        projectInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                const tag = projectInput.value.trim();
                if (tag && !projectTags.includes(tag)) {
                    projectTags.push(tag);
                    renderProjectTags();
                }
                projectInput.value = '';
            }
        });

        projectTagsContainer.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const index = e.target.getAttribute('data-index');
                projectTags.splice(index, 1);
                renderProjectTags();
            }
        });

        // --- File Upload ---
        fileUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            uploadStatus.classList.remove('hidden');
            uploadStatus.className = 'text-sm text-blue-600 font-medium mt-2';
            uploadStatus.innerText = '注 拽抓...';
            
            try {
                const storageRef = ref(storage, `uploads/${Date.now()}_${file.name}`);
                const snapshot = await uploadBytes(storageRef, file);
                uploadedFileUrl = await getDownloadURL(snapshot.ref);
                
                uploadStatus.className = 'text-sm text-green-600 font-medium mt-2';
                uploadStatus.innerText = `注 砖: ${file.name}`;
                SmartLog.info(`File uploaded: ${uploadedFileUrl}`);
            } catch (error) {
                SmartLog.error(error, "FileUpload");
                uploadStatus.className = 'text-sm text-red-600 font-medium mt-2';
                uploadStatus.innerText = `砖 注: ${error.message}`;
                uploadedFileUrl = null;
            }
        });

        // --- Main Submit Function ---
        submitBtn.addEventListener('click', async () => {
            const btn = submitBtn;
            btn.disabled = true;
            btn.innerHTML = '<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mx-auto"></div>';

            try {
                // --- Step 1 Data ---
                const customerId = document.getElementById('customer-id').value.trim();
                const customerName = document.getElementById('customer-name').value.trim();
                const customerPhone = document.getElementById('customer-phone').value.trim();
                const contactPerson = document.getElementById('contact-person').value.trim();
                const addressCity = document.getElementById('address-city').value.trim();
                const addressStreet = document.getElementById('address-street').value.trim();
                const addressNumber = document.getElementById('address-number').value.trim();
                
                // [住驻 砖 v3.2] 拽专转 砖 GPS
                const customerGPS = document.getElementById('customer-gps').value.trim();

                // --- Step 2 Data ---
                const orderContent = document.getElementById('order-content').value.trim();
                const orderDate = document.getElementById('order-date').value;
                const orderTime = document.getElementById('order-time').value;

                // --- Validation ---
                if (!customerId || !customerName || !orderDate || !orderContent) {
                    showToast("砖转 : 住驻专 拽, 砖, 转专 转 ", "error");
                    btn.disabled = false;
                    btn.innerHTML = '<i data-feather="check-circle" class="inline-block w-5 h-5"></i> 砖专  砖 -WhatsApp';
                    feather.replace();
                    return;
                }

                // --- Customer Logic (Create or Use Existing) ---
                let customerRef;
                let customerDocId;
                const auditEntry = { action: "Created", timestamp: new Date() };

                if (existingCustomerData) {
                    SmartLog.info("Using existing customer");
                    //爪 转 -ID 砖 住 拽
                    const q = query(collection(db, CUSTOMERS_COLLECTION), where("customerNumber", "==", customerId));
                    const querySnapshot = await getDocs(q);
                    customerDocId = querySnapshot.docs[0].id;
                    customerRef = doc(db, CUSTOMERS_COLLECTION, customerDocId);
                } else {
                    SmartLog.info("Creating new customer");
                    // [砖  v3.2]
                    const newCustomerData = {
                        customerNumber: customerId,
                        name: customerName,
                        phone: customerPhone,
                        contactPerson: contactPerson,
                        addressCity: addressCity,
                        addressStreet: addressStreet,
                        addressNumber: addressNumber,
                        defaultAddress: `${addressStreet} ${addressNumber}, ${addressCity}`,
                        gps: customerGPS, // [住驻 砖 v3.2] 砖专转 砖 GPS
                        auditLog: [auditEntry]
                    };
                    const docRef = await addDoc(collection(db, CUSTOMERS_COLLECTION), newCustomerData);
                    customerRef = docRef;
                    customerDocId = docRef.id;
                    SmartLog.info(`New customer created with ID: ${customerDocId}`);
                }
                
                // --- Create Order ---
                const newOrderData = {
                    order_id: `auto_${Date.now()}`, // Temporary ID
                    customer: {
                        id: customerDocId,
                        name: customerName,
                        phone: customerPhone,
                        address: `${addressStreet} ${addressNumber}, ${addressCity}`
                    },
                    customer_name: customerName, // for simpler queries
                    customer_id: customerId, // for simpler queries
                    customer_address: `${addressStreet} ${addressNumber}, ${addressCity}`, // for simpler queries
                    
                    status: "砖",
                    createdAt: serverTimestamp(),
                    lastModified: serverTimestamp(),
                    
                    orderDate: orderDate,
                    orderTime: orderTime,
                    deliveryType: "专 砖抓",
                    rawText: orderContent,
                    notes: "",
                    
                    tags: projectTags,
                    fileUrl: uploadedFileUrl || "",
                    
                    createdBy: "CRMFlow"
                };

                const orderDocRef = await addDoc(collection(db, ORDERS_COLLECTION_PATH), newOrderData);
                SmartLog.info(`New order created with ID: ${orderDocRef.id}`);

                // --- WhatsApp Message ---
                const waMessage = `
 *拽 砖 爪专:*
*砖:* ${customerName} (#${customerId})
*砖 拽砖专:* ${contactPerson || '-'}
*驻:* ${customerPhone || '-'}
*转转:* ${addressStreet} ${addressNumber}, ${addressCity}

 * 砖 (v${orderDocRef.id.slice(0,5)}):*
*转专:* ${orderDate}
*砖注:* ${orderTime || '-'}
*转转:* ${projectTags.join(', ') || '-'}
*拽抓:* ${uploadedFileUrl ? '' : ''}

 *转:*
${orderContent}
                `.trim().replace(/\n\s+/g, '\n');
                
                const waLink = `https://api.whatsapp.com/send?phone=972506610040&text=${encodeURIComponent(waMessage)}`;
                
                // Open WA
                window.open(waLink, '_blank');
                
                // --- Success & Reset ---
                showToast("拽  爪专 爪!", "success");
                
                setTimeout(() => {
                    // Reset Step 1
                    document.getElementById('customer-id').value = '';
                    document.getElementById('customer-name').value = '';
                    document.getElementById('customer-phone').value = '';
                    document.getElementById('contact-person').value = '';
                    document.getElementById('address-city').value = '';
                    document.getElementById('address-street').value = '';
                    document.getElementById('address-number').value = '';
                    document.getElementById('customer-gps').value = ''; // [住驻 砖 v3.2] 驻住 砖 GPS
                    
                    // Reset Step 2
                    document.getElementById('order-date').value = '';
                    document.getElementById('order-time').value = '';
                    document.getElementById('order-content').value = '';
                    document.getElementById('project-input').value = '';
                    document.getElementById('file-upload').value = '';
                    document.getElementById('upload-status').classList.add('hidden');
                    projectTags = [];
                    renderProjectTags();
                    
                    // Go back to step 1
                    step2.style.display = 'none';
                    step1.style.display = 'block';
                    stepper2.classList.remove('active');
                    stepper1.classList.remove('complete');
                    stepper1.classList.add('active');
                    
                    btn.disabled = false;
                    btn.innerHTML = '<i data-feather="check-circle" class="inline-block w-5 h-5"></i> 砖专  砖 -WhatsApp';
                    feather.replace();
                }, 2000); // Short delay to let user see success

            } catch (error) {
                SmartLog.error(error, "Submit.FullOrder");
                showToast(`砖 拽专转: ${error.message}`, "error");
                btn.disabled = false;
                btn.innerHTML = '<i data-feather="check-circle" class="inline-block w-5 h-5"></i> 砖专  砖 -WhatsApp';
                feather.replace();
            }
        });

        // --- Init Icons ---\
        feather.replace();
    </script>
</body>
</html>
