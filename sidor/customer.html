<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sidor Customer Portal v46 (Master Fix)</title>
    <!-- 
      Sidor Customer Portal v46 (Master Fix)
      
      Changelog:
      - [קריטי] תיקון שגיאת "getApps is not defined" ו-"setLogLevel is not defined" 
        שזוהתה בלוגים (v43).
      - [קריטי] תיקון לוגיקת 'normalizePhone' לטפל ב-05X ולא +972 (v41).
      - [קריטי] אתחול המפה (initMap) קורה רק בלחיצה על טאב "מפה"
        כדי למנוע "כשל שקט" בטעינה (v1.18).
      - [כלול] כל שדרוגי ה-UI: מצב כהה/בהיר, אווטאר, מסך כניסה פרימיום (v41).
      - [כלול] כל מנגנון המיקום המקומי (DEFAULT_LOCATION, locationsDB, parseGPS) (v1.22).
    -->

    <!-- PWA, Tailwind, Leaflet, Icons, Font -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/3498db/white?text=Sidor">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #2c3e50;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --bg-app: #f5f7fa;
            --surface: #ffffff;
            --text-color: #2c3e50;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --accent: #FF6B35; /* [חדש] צבע הדגשה לכפתור (הנחיה B.3) */
        }
        
        /* [חדש] עיצוב כהה (הנחיה B) */
        .dark {
            --bg-app: #111827;
            --surface: #1f2937;
            --text-color: #f3f4f6;
            --text-muted: #9ca3af;
            --border-color: #374151;
        }

        html, body {
            overscroll-behavior-y: none;
            height: 100%;
            max-height: 100vh;
        }
        body { 
            font-family: 'Rubik', sans-serif; 
            background-color: var(--bg-app); 
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .form-input {
            @apply w-full p-3 border rounded-lg text-base transition-all duration-200 ease-in-out;
            background-color: var(--bg-app);
            border-color: var(--border-color);
            color: var(--text-color);
        }
        .form-input:focus {
            @apply ring-1 ring-blue-500;
            background-color: var(--surface);
            border-color: var(--primary);
        }
        
        .form-textarea {
            @apply w-full p-3 border rounded-lg text-base h-32;
            background-color: var(--bg-app);
            border-color: var(--border-color);
            color: var(--text-color);
        }
        
        .btn {
            @apply text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 ease-in-out;
        }
        .btn-primary { @apply bg-blue-500 hover:bg-blue-600; }
        .btn-secondary { 
            background-color: var(--light);
            color: var(--secondary);
            border: 1px solid var(--border-color);
        }
        .dark .btn-secondary {
            background-color: #374151;
            color: var(--light);
            border-color: #4b5563;
        }
        
        .btn-success { @apply bg-green-500 hover:bg-green-600; }
        .btn:disabled { @apply bg-gray-400 cursor-not-allowed; }

        /* --- [חדש] מבנה אפליקציה --- */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        .app-page {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }
        .app-page.active {
            display: flex;
        }
        
        .app-header {
            background: var(--surface);
            padding: 0.75rem 1rem;
            padding-top: calc(0.75rem + env(safe-area-inset-top));
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            z-index: 20;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; 
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .app-main {
            flex: 1;
            overflow-y: auto;
            position: relative;
            -webkit-overflow-scrolling: touch; 
            padding: 1rem;
        }
        
        /* [חדש] סרגל ניווט תחתון (הנחיה 9) */
        .app-nav {
            background: var(--surface);
            border-top: 1px solid var(--border-color);
            padding-bottom: env(safe-area-inset-bottom);
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            height: 65px;
            z-index: 20;
            flex-shrink: 0; 
            transition: background-color 0.3s, border-color 0.3s;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.7rem;
            font-weight: 500;
        }
        .nav-item.active {
            color: var(--primary);
        }
        .nav-item svg {
            width: 22px;
            height: 22px;
            margin-bottom: 4px;
        }
        .nav-item-center {
            transform: translateY(-15px);
        }
        .nav-item-center button {
            background-color: var(--primary);
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }
        .nav-item-center svg { width: 28px; height: 28px; margin: 0; }
        
        /* [חדש] דף כניסה פרימיום (הנחיה B) */
        #page-login {
            display:flex; flex-direction:column; align-items:center; justify-content:center;
            height:100vh; background: linear-gradient(135deg,#0f172a 0%, #0b1220 100%);
            color:#fff;
            text-align: center;
            padding: 1rem;
        }
        .login-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            position: absolute;
            top: calc(1.5rem + env(safe-area-inset-top));
            color: #94a3b8;
        }
        .login-logo { 
            width: 32px;
            height: 32px;
            color: var(--primary);
        }
        .hero-title { 
            font-size: 30px; 
            font-weight:800; 
            letter-spacing:0.5px; 
            margin-bottom:8px; 
        }
        .hero-subtitle {
            font-size: 1rem;
            color: #cbd5e1;
            margin-bottom: 2rem;
        }
        .phone-card { 
            background: rgba(255,255,255,0.06); 
            padding: 1.5rem; 
            border-radius:14px; 
            box-shadow: 0 8px 30px rgba(2,6,23,0.7); 
            width: 420px; 
            max-width:95%; 
        }
        .input-phone { 
            width:100%; 
            padding:14px 16px; 
            border-radius:10px; 
            border: 1px solid rgba(255,255,255,0.1); 
            outline:none; 
            font-size:18px; 
            background: rgba(255,255,255,0.03); 
            color:#fff; 
            text-align: center;
            direction: ltr;
        }
        .btn-enter { 
            margin-top:12px; 
            width:100%; 
            padding:14px; 
            border-radius:12px; 
            font-weight:700; 
            font-size:16px; 
            cursor:pointer; 
            border:none; 
            transition: transform .08s ease;
            background-color: var(--accent);
            color: white;
        }
        .btn-enter:active { transform: scale(0.98); }
        .login-loader { 
            width:32px; 
            height:32px; 
            border-radius:50%; 
            border:4px solid rgba(255,255,255,0.08); 
            border-top-color: var(--accent); 
            animation: spin 1s linear infinite; 
            margin: 12px auto; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 1.5rem auto;
            background-color: rgba(255,255,255,0.1);
            border: 2px dashed rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .avatar-preview i {
            width: 32px;
            height: 32px;
            color: rgba(255,255,255,0.3);
        }
        .input-avatar {
            width:100%; 
            padding:8px 10px; 
            border-radius:8px; 
            border: 1px solid rgba(255,255,255,0.1); 
            outline:none; 
            font-size:12px; 
            background: rgba(255,255,255,0.03); 
            color:#fff;
            direction: ltr;
            margin-top: 0.5rem;
        }
        
        .release-note {
            position: absolute;
            bottom: env(safe-area-inset-bottom, 1rem);
            font-size: 0.75rem;
            color: #475569;
        }

        /* [חדש] מודלים */
        .modal {
            @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300;
        }
        .modal-content {
            @apply rounded-lg shadow-2xl p-6 w-full max-w-md;
            background-color: var(--surface);
            color: var(--text-color);
        }
        
        /* כרטיסים */
        .card {
            background: var(--surface);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .card-header {
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        .card-body {
            padding: 1rem;
        }

        /* [חדש] כפתור החלפת עיצוב */
        .theme-toggle-btn {
            @apply w-full flex items-center justify-between p-3 rounded-lg;
            background-color: var(--bg-app);
            border: 1px solid var(--border-color);
        }

        .toast {
            @apply fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-lg text-white font-semibold z-[100] transition-all duration-300;
        }
        .toast.success { @apply bg-green-500; }
        .toast.error { @apply bg-red-500; }
        .toast.info { @apply bg-blue-500; }
    </style>
</head>
<body>

    <!-- [חדש] מבנה אפליקציה -->
    <div class="app-container">

        <!-- [חדש] דף כניסה פרימיום (הנחיה B) -->
        <div id="page-login" class="app-page active">
            
            <header class="login-header">
                <i data-feather="truck" class="login-logo"></i>
                <span>DeliveryMaster ללקוחו ח.סבן חומרי בנין</span>
            </header>

            <!-- [עדכון v41] שימוש בלינק שסופק (בצבע לבן) -->
            <div class="avatar-preview" id="avatar-preview">
                <img src="https://img.icons8.com/?size=100&id=36m26sAM2RfO&format=png&color=FFFFFF" alt="avatar" class="w-12 h-12 opacity-30">
            </div>
            
            <h1 class="hero-title">ברוכים הבאים ל־DeliveryMaster</h1>
            <p class="hero-subtitle">אנא הזן את מספר הטלפון שלך</p>
            
            <div class="phone-card">
                <div id="loader-container" class="hidden text-center mb-3">
                    <div class="loader"></div>
                    <p id="loader-text" class="text-sm text-gray-400">מאמת מספר טלפון...</p>
                </div>
                
                <div id="login-form">
                    <input type="tel" id="phone-input" placeholder="הקלד מספר טלפון או הדבק">
                    <p id="paste-helper" class="text-green-400 text-sm mt-2 hidden"></p>
                    
                    <!-- [חדש] הנחיה D: שדה אווטאר -->
                    <input type="text" id="avatar-url-input" class="input-avatar mt-3" placeholder="הדבק לינק לאווטאר / אימוג'י (אופציונלי)">

                    <button id="login-btn" class="btn-enter">
                        כניסה
                    </button>
                    <p id="login-error" class="text-red-500 text-sm mt-2 hidden"></p>
                </div>
            </div>

            <!-- [חדש] הנחיה E: הערת שחרור -->
            <footer class="release-note">
                DeliveryMaster — ח.סבן חומרי בנין (v46)
            </footer>
        </div>

        <!-- [חדש] דף בחירת פרויקט (הנחיה 3) -->
        <div id="page-project-select" class="app-page">
            <header class="app-header">
                <h1 class="font-bold text-lg">בחירת פרויקט</h1>
            </header>
            <main class="app-main">
                <p class="text-gray-600 mb-4">נמצאו מספר פרויקטים המשויכים למספר זה. אנא בחר פרויקט:</p>
                <div id="project-list-container" class="space-y-3">
                    <!-- רשימת פרויקטים תטען כאן -->
                </div>
            </main>
        </div>

        <!-- [חדש] פורטל ראשי (מחליף את הקובץ הישן) -->
        <div id="page-portal" class="app-page">
            <header class="app-header">
                <h1 id="header-title" class="font-bold text-lg">מעקב הזמנה</h1>
                <div class="flex items-center gap-2">
                    <span id="header-project-name" class="text-sm font-medium text-gray-500"></span>
                    <img id="header-avatar-img" class="w-8 h-8 rounded-full bg-gray-200">
                </div>
            </header>
            
            <main class="app-main no-scrollbar">
                
                <!-- טאב 1: מעקב חי -->
                <div id="portal-tracking" class="portal-page active" style="padding: 0; height: 100%;">
                    <div id="map-container" class="w-full h-full z-0"></div>
                </div>

                <!-- טאב 2: פרויקטים -->
                <div id="portal-projects" class="portal-page" style="display: none;">
                    <h2 class="text-2xl font-bold mb-4">פרויקטים</h2>
                    <div id="portal-project-list" class="space-y-3">
                        <!-- רשימת פרויקטים תטען כאן -->
                    </div>
                </div>

                <!-- טאב 3: היסטוריה -->
                <div id="portal-history" class="portal-page" style="display: none;">
                    <h2 class="text-2xl font-bold mb-4">היסטוריית הזמנות</h2>
                    <div id="history-list-container" class="space-y-3">
                        <!-- היסטוריה תטען כאן -->
                    </div>
                </div>

                <!-- טאב 4: חשבון -->
                <div id="portal-account" class="portal-page" style="display: none;">
                    <h2 class="text-2xl font-bold mb-4">החשבון שלי</h2>
                    <div class="card card-body space-y-3">
                        <p class="font-medium">לקוח: <span id="account-name" class="font-normal">...</span></p>
                        <p class="font-medium">טלפון: <span id="account-phone" class="font-normal">...</span></p>
                        <p class="font-medium">מכשיר: <span id="account-device" class="font-normal">...</span></p>
                        
                        <!-- [חדש] הנחיה B: כפתור עיצוב -->
                        <div class="pt-4">
                            <label class="form-label">העדפות תצוגה</label>
                            <button id="theme-toggle-btn" class="theme-toggle-btn">
                                <span class="flex items-center gap-2">
                                    <i data-feather="moon" id="theme-icon-dark"></i>
                                    <i data-feather="sun" id="theme-icon-light" class="hidden"></i>
                                    <span id="theme-text">מצב כהה</span>
                                </span>
                                <div class="w-10 h-6 bg-gray-300 dark:bg-blue-600 rounded-full p-1 flex items-center transition-all duration-300" id="theme-toggle-switch">
                                    <div class="w-4 h-4 bg-white rounded-full transform transition-transform duration-300" id="theme-toggle-dot"></div>
                                </div>
                            </button>
                        </div>

                        <button id="logout-btn" class="btn btn-secondary w-full mt-6 text-sm">התנתק ושכח מכשיר זה</button>
                    </div>
                </div>
            </main>

            <!-- [חדש] ניווט תחתון (הנחיה 9) -->
            <nav class="app-nav">
                <button class="nav-item active" onclick="app.navigatePortalTab('portal-tracking')" ontouchstart="app.navigatePortalTab('portal-tracking')">
                    <i data-feather="map-pin"></i>
                    <span>מעקב</span>
                </button>
                <button class="nav-item" onclick="app.navigatePortalTab('portal-projects')" ontouchstart="app.navigatePortalTab('portal-projects')">
                    <i data-feather="briefcase"></i>
                    <span>פרויקטים</span>
                </button>
                <div class="nav-item nav-item-center">
                    <button onclick="app.openNewOrderModal()" ontouchstart="app.openNewOrderModal()">
                        <i data-feather="plus"></i>
                    </button>
                </div>
                <button class="nav-item" onclick="app.navigatePortalTab('portal-history')" ontouchstart="app.navigatePortalTab('portal-history')">
                    <i data-feather="clock"></i>
                    <span>היסטוריה</span>
                </button>
                <button class="nav-item" onclick="app.navigatePortalTab('portal-account')" ontouchstart="app.navigatePortalTab('portal-account')">
                    <i data-feather="user"></i>
                    <span>חשבון</span>
                </button>
            </nav>
        </div>
    </div>
    
    <!-- [חדש] מודל שיוך מכשיר (הנחיה 6) -->
    <div id="modal-device-bind" class="modal hidden opacity-0">
        <div class="modal-content transform scale-90 transition-transform duration-300">
            <h3 class="text-xl font-bold mb-4">שיוך מכשיר</h3>
            <p class="mb-6">אנו מזהים שזו כניסה ראשונה ממכשיר זה. האם תרצה לשייך מכשיר זה לחשבונך (כניסה אוטומטית בעתיד)?</p>
            <div class="flex justify-end gap-3">
                <button onclick="app.denyBindDevice()" class="btn btn-secondary w-auto">לא, תודה</button>
                <button onclick="app.confirmBindDevice()" class="btn btn-primary w-auto">כן, שמור מכשיר</button>
            </div>
        </div>
    </div>
    
    <!-- [חדש] מודל הזמנה חדשה (הנחיה 7) -->
    <div id="modal-new-order" class="modal hidden opacity-0" onclick="app.closeNewOrderModal(event)">
        <div class="modal-content w-full max-w-lg max-h-[80vh] flex flex-col" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">יצירת הזמנה חדשה</h3>
                <button onclick="app.closeNewOrderModal()" class="text-gray-500 hover:text-gray-800">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <!-- טאבים של המודל -->
            <div class="flex border-b mb-4" style="border-color: var(--border-color);">
                <button id="tab-btn-smart" class="py-2 px-4 font-semibold border-b-2 border-blue-500 text-blue-500">הדבקה חכמה</button>
                <button id="tab-btn-form" class="py-2 px-4 font-semibold text-gray-500" style="color: var(--text-muted);">טופס ידני</button>
            </div>
            
            <div class="overflow-y-auto pr-2">
                <!-- טאב 1: הדבקה חכמה (הנחיה 7) -->
                <div id="tab-content-smart" class="space-y-4">
                    <p class="text-sm" style="color: var(--text-muted);">הדבק כאן הודעת וואטסאפ או טקסט הזמנה. המערכת תנסה לנתח ולמלא את הפרטים אוטומטית.</p>
                    <textarea id="smart-paste-input" class="form-textarea" rows="8" placeholder="..."></textarea>
                    <button id="submit-smart-paste" class="btn btn-primary w-full">נתח וצור הזמנה</button>
                </div>
                
                <!-- טאב 2: טופס ידני (הנחיה 7) -->
                <div id="tab-content-form" class="space-y-4 hidden">
                    <div>
                        <label for="order-form-project" class="form-label">בחר פרויקט</label>
                        <select id="order-form-project" class="form-input"></select>
                    </div>
                    <div>
                        <label for="order-form-catalog" class="form-label">בחר פריטים (מהקטלוג)</label>
                        <select id="order-form-catalog" class="form-input" multiple size="5">
                            <option>טוען קטלוג...</option>
                        </select>
                    </div>
                    <div>
                        <label for="order-form-date" class="form-label">תאריך אספקה</label>
                        <input type="date" id="order-form-date" class="form-input">
                    </div>
                    <div>
                        <label for="order-form-notes" class="form-label">הערות</label>
                        <textarea id="order-form-notes" class="form-textarea" rows="3" placeholder="הערות לנהג או למחסן..."></textarea>
                    </div>
                    
                    <!-- [חדש] שדות מיקום (הנחיה 8) -->
                    <div class="p-3 rounded-lg border" style="background-color: var(--bg-app); border-color: var(--border-color);">
                        <label class="form-label">מיקום אספקה</label>
                        <button onclick="app.shareDeviceLocation()" class="btn bg-green-500 hover:bg-green-600 w-full text-sm py-2">
                            <i data-feather="map-pin" class="inline w-4 h-4"></i> שתף מיקום מדויק מהמכשיר
                        </button>
                        <p class="text-center text-xs my-2" style="color: var(--text-muted);">או</p>
                        <input type="text" id="order-form-gps" class="form-input text-left text-sm" style="direction: ltr;" placeholder="הדבק GPS ידני (לדוגמה: 32.0, 34.7)">
                        <p id="location-status" class="text-green-600 text-sm font-medium mt-2 hidden"></p>
                    </div>
                    
                    <button id="submit-order-form" class="btn btn-primary w-full">שלח הזמנה</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast container -->
    <div id="toast-container"></div>
    
    <script type="module">
        // [תיקון v43] הוספת getApp, getApps, ו- setLogLevel לייבוא
        import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp, setDoc, doc, onSnapshot, orderBy, limit, setLogLevel } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // --- [יישום הנחיה 1] מיקום ברירת מחדל ---
        const DEFAULT_LOCATION = { lat: 32.0750544, lng: 34.826251 };
        
        // --- [יישום הנחיה 3] מאגר כתובות מקומי ---
        const locationsDB = {
            "האגדה 15, רמת גן": { lat: 32.0750544, lng: 34.826251 },
            "שקד 2, רשפון": { lat: 32.199149, lng: 34.827883 },
            "קפלנסקי 18, כפר סבא": { lat: 32.188991, lng: 34.903732 },
            "הוורדים 19, סביון": { lat: 32.0716, lng: 34.8733 },
            "חופי 81, רמת גן": { lat: 32.0833, lng: 34.8211 }
        };

// ... existing code ...
        let allOrders = [];
        let allHistoryOrders = [];
        let allProjects = [];
        let currentClient = null;
        let currentProject = null;
        let clientDeviceId = localStorage.getItem('sidorDeviceId') || null;
        let sharedLocation = null; // ישמש לשמירת מיקום מהמכשיר
        let userId = null; // [תיקון v47] הוספת הגדרת משתנה חסרה
        
        // --- [יישום הנחיה 1] משתנים גלובליים למפה ---
        let
        let mapReady = false;
        let mapMarkers = []; 

        
        // --- [תיקון קריטי v1.7] הגדרות Firebase קבועות ---
        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949",
          storageBucket: "saban94-78949.appspot.com",
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a",
          measurementId: "G-XV6RZDESSB"
        };
        
        // --- [תיקון v43] נתיב קולקציית לקוחות ---
        const ORDERS_COLLECTION_PATH = 'orders_v2'; 
        const CUSTOMERS_COLLECTION_PATH = 'customers'; // [תיקון] שימוש ב-customers הקיים
        const PROJECTS_COLLECTION_PATH = 'projects'; // לפי המפרט החדש
        const DEVICES_COLLECTION_PATH = 'devices'; // (הנחיה 6)

        // --- [חדש v1.13] אייקונים למפה ---
        const orderIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41]
        });


        // --- לוגר ("מלשינון") ופונקציות טעינה ---
        const SmartLog = {
            info: (msg, data = '') => console.log(`[INFO | ${new Date().toISOString()}] ${msg}`, data),
            error: (err, msg, data = '') => console.error(`[ERROR | ${new Date().toISOString()}] ${msg}`, data, err),
        };
        
        // --- פונקציות API (יישום הנחיות) ---
        const api = {
            // [יישום הנחיה 2]
            getClientsByPhone: async (phone) => {
                // [יישום הנחיה A.3]
                SmartLog.info(`Querying clients with normalized phone: ${phone}`);
                
                // [יישום הנחיה A.1] זוהי שאילתת הליבה
                // ודא שהוספת אינדקס ל-phone ב-customers
                try {
                    const q = query(collection(db, CUSTOMERS_COLLECTION_PATH), where("phone", "==", phone));
                    const snapshot = await getDocs(q);
                    
                    if (snapshot.empty) {
                        SmartLog.info("No clients found for this phone number in Firestore.");
                        return [];
                    }
                    
                    let clients = [];
                    // כאן אנו מניחים שלקוח = פרויקט, לפי המבנה הקיים
                    // אם תרצה להוסיף 'projects' בעתיד, כאן המקום
                    snapshot.forEach(doc => {
                        const clientData = doc.data();
                        clients.push({
                            id: doc.id,
                            name: clientData.name,
                            phone: clientData.phone,
                            projects: [ // יצירת "פרויקט" דינמי מנתוני הלקוח
                                { 
                                    id: doc.id, 
                                    title: clientData.name, 
                                    address: clientData.defaultAddress || `${clientData.addressStreet} ${clientData.addressNumber}, ${clientData.addressCity}`,
                                    gps: clientData.gps,
                                    customLat: clientData.customLat,
                                    customLon: clientData.customLon
                                }
                            ]
                        });
                    });
                    
                    SmartLog.info(`Found ${clients.length} clients in Firestore`, clients);
                    return clients;

                } catch (error) {
                    SmartLog.error(error, "Failed to fetch clients from Firestore. DO YOU HAVE AN INDEX ON 'phone'?");
                    // אם השליפה נכשלת (למשל, חסר אינדקס), חזור ל-Mock כדי לא לתקוע
                    return api.mockGetClientsByPhone(phone); 
                }
            },

            // [חדש] פונקציית Mock למקרה חירום
            mockGetClientsByPhone: async (phone) => {
                SmartLog.info(`Using MOCK API for phone: ${phone}`);
                await new Promise(res => setTimeout(res, 500));
                
                // [יישום הנחיה A.7]
                if (phone === "0546609953") {
                    SmartLog.info("MOCK: Found client for 054-6609953");
                    return [
                        { id: "client_3", name: "חדד נועם/כפר סבא", phone: "0546609953", projects: [
                            { id: "project_D", title: "פרויקט ששת הימים", address: "ששת הימים 8, כפר סבא" }
                        ]}
                    ];
                }
                if (phone === "0501234567") {
                    return [
                        { id: "client_1", name: "חברת א' בע\"מ", phone: "0501234567", projects: [
                            { id: "project_A", title: "פרויקט מגדלי תל אביב", address: "דרך ששת הימים 30, תל אביב" },
                            { id: "project_B", title: "פרויקט וילות ברמת השרון", address: "סוקולוב 50, רמת השרון" }
                        ]}
                    ];
                } else {
                    return [];
                }
            },

            // [יישום הנחיה 6]
            bindDevice: async (deviceId, clientId, projectId) => {
                SmartLog.info(`Binding device:`, { deviceId, clientId, projectId });
                const deviceRef = doc(db, DEVICES_COLLECTION_PATH, deviceId);
                await setDoc(deviceRef, { clientId, projectId, createdAt: serverTimestamp(), lastPhone: currentClient.phone });
                return true;
            },
            
            // [יישום הנחיה 10]
            getCatalog: async () => {
                SmartLog.info(`API: /api/catalog`);
                const cacheKey = 'sidorCatalogCache';
                const cached = sessionStorage.getItem(cacheKey);
                
                if (cached) {
                    SmartLog.info("Catalog loaded from cache");
                    return JSON.parse(cached);
                }

                // הדמיית שליפה מ-Google Sheet
                await new Promise(res => setTimeout(res, 800)); 
                const catalog = [
                    { sku: '1001', name: 'מלט שחור (25 ק\"ג)', price: 15 },
                    { sku: '1002', name: 'בלוק איטונג 20', price: 8 },
                    { sku: '2005', name: 'חול ים (באללה)', price: 120 },
                ];
                
                sessionStorage.setItem(cacheKey, JSON.stringify(catalog));
                return catalog;
            }
        };


        const app = {
            showLoader: (text = "טוען...") => {
                const loaderContainer = document.getElementById('loader-container');
                const loaderForm = document.getElementById('login-form');
                const loaderText = document.getElementById('loader-text');
                
                // Loader ראשי
                const mainLoader = document.getElementById('loader');
                if (mainLoader) mainLoader.style.display = 'flex';

                // Loader בתוך דף הכניסה
                if (loaderContainer && loaderForm) {
                    loaderForm.classList.add('hidden');
                    loaderContainer.classList.remove('hidden');
                    if(loaderText) loaderText.innerText = text;
                }
            },
            hideLoader: () => {
                const mainLoader = document.getElementById('loader');
                if (mainLoader) mainLoader.style.display = 'none';

                const loaderContainer = document.getElementById('loader-container');
                const loaderForm = document.getElementById('login-form');
                if (loaderContainer && loaderForm) {
                    loaderForm.classList.remove('hidden');
                    loaderContainer.classList.add('hidden');
                }
            },

            // --- 1. אתחול (לפי לוגיקה חדשה) ---
            init: () => {
                SmartLog.info("Sidor Customer Portal v43 (Import Fix) initializing...");
                app.showLoader("מתחבר למערכת..."); 
                
                try {
                    if (!firebaseConfig.projectId) {
                        throw new Error("Firebase config is missing projectId");
                    }
                    
                    // [תיקון v43]
                    const fbApp = !getApps().length ? initializeApp(firebaseConfig) : getApp();
                    db = getFirestore(fbApp);
                    auth = getAuth(fbApp);
                    setLogLevel('debug'); // [תיקון v43]

                    app.initTheme(); // [חדש] אתחול עיצוב
                    app.authenticateUser();
                } catch (e) {
                    SmartLog.error(e, "Firebase Init Failed");
                    app.hideLoader();
                    showToast("שגיאת אתחול קריטית", "error");
                }
            },

            // --- 2. אימות (לפי לוגיקה חדשה) ---
            authenticateUser: () => {
                SmartLog.info("Authenticating...");
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        SmartLog.info(`User authenticated: ${userId}`);
                        
                        // [יישום הנחיה 1] בדיקת שיוך קיים
                        const boundPhone = localStorage.getItem('sidorBoundPhone');
                        if (boundPhone && clientDeviceId) {
                            SmartLog.info(`Device is bound to phone ${boundPhone}. Logging in...`);
                            await app.login(boundPhone);
                        } else {
                            SmartLog.info("Device not bound. Showing login page.");
                            app.showPage('page-login');
                            app.hideLoader();
                        }

                    } else {
                        SmartLog.info("No user, signing in anonymously...");
                        try {
                            await signInAnonymously(auth);
                        } catch (e) {
                            SmartLog.error(e, "Authentication failed");
                            app.hideLoader();
                        }
                    }
                });
            },

            // [חדש] פונקציית כניסה (הנחיה 2)
            login: async (phone = null) => {
                app.showLoader("מאמת מספר טלפון...");
                
                const phoneInput = document.getElementById('phone-input');
                const phoneToLogin = phone || phoneInput.value;
                
                // [יישום הנחיה A.2]
                const normalizedPhone = app.normalizePhone(phoneToLogin);
                
                if (!normalizedPhone || !app.validatePhone(normalizedPhone)) {
                    document.getElementById('login-error').innerText = "מספר טלפון לא תקין. (נדרש 05X-XXXXXXX)";
                    document.getElementById('login-error').classList.remove('hidden');
                    app.hideLoader();
                    return;
                }
                
                document.getElementById('login-error').classList.add('hidden');
                app.showLoader("מחפש לקוחות..."); // [יישום הנחיה C.1]
                
                try {
                    const clients = await api.getClientsByPhone(normalizedPhone);
                    
                    if (clients.length === 0) {
                        document.getElementById('login-error').innerText = "מספר זה לא משויך לאף לקוח. צור קשר ליצירת חשבון.";
                        document.getElementById('login-error').classList.remove('hidden');
                        app.hideLoader();
                        return;
                    }

                    if (clients.length === 1 && clients[0].projects.length === 1) {
                        // [יישום הנחיה 2] כניסה ישירה לפרויקט יחיד
                        SmartLog.info("Single client & project found. Binding device...");
                        currentClient = clients[0];
                        currentProject = clients[0].projects[0];
                        allProjects = clients[0].projects;
                        await app.bindDeviceIfNeeded(normalizedPhone);
                    } else {
                        // [יישום הנחיה 3] הצג רשימת פרויקטים
                        SmartLog.info(`Multiple projects (${clients[0].projects.length}) found. Showing selection screen.`);
                        currentClient = clients[0];
                        allProjects = clients[0].projects;
                        app.renderProjectSelection(clients[0].projects, normalizedPhone);
                        app.showPage('page-project-select');
                        app.hideLoader();
                    }
                    
                } catch (error) {
                    SmartLog.error(error, "Login failed");
                    document.getElementById('login-error').innerText = `שגיאת שרת: ${error.message}`;
                    document.getElementById('login-error').classList.remove('hidden');
                    app.hideLoader();
                }
            },
            
            // [חדש] שיוך מכשיר (הנחיה 6)
            bindDeviceIfNeeded: async (phone) => {
                if (!clientDeviceId) {
                    clientDeviceId = generateUUID();
                    localStorage.setItem('sidorDeviceId', clientDeviceId);
                    SmartLog.info(`New deviceId generated: ${clientDeviceId}. Showing bind modal.`);
                    // הצג מודל אישור
                    document.getElementById('modal-device-bind').classList.remove('hidden', 'opacity-0');
                    document.getElementById('modal-device-bind').querySelector('.modal-content').classList.remove('scale-90');
                    // שמירת הטלפון זמנית
                    document.getElementById('modal-device-bind').dataset.phone = phone;
                } else {
                    SmartLog.info(`Device ${clientDeviceId} already bound. Loading portal.`);
                    localStorage.setItem('sidorBoundPhone', phone); // רענון השיוך
                    await app.loadPortal();
                }
            },
            
            confirmBindDevice: async () => {
                const phone = document.getElementById('modal-device-bind').dataset.phone;
                try {
                    await api.bindDevice(clientDeviceId, currentClient.id, currentProject.id);
                    localStorage.setItem('sidorBoundPhone', phone);
                    document.getElementById('modal-device-bind').classList.add('hidden', 'opacity-0');
                    await app.loadPortal();
                } catch (error) {
                    SmartLog.error(error, "Device bind failed");
                    showToast("שגיאה בשיוך המכשיר", "error");
                }
            },
            
            denyBindDevice: async () => {
                const phone = document.getElementById('modal-device-bind').dataset.phone;
                localStorage.removeItem('sidorDeviceId');
                clientDeviceId = null;
                document.getElementById('modal-device-bind').classList.add('hidden', 'opacity-0');
                await app.loadPortal(); // המשך ללא שיוך (שיוך זמני)
            },

            // [חדש] טעינת פורטל מלא
            loadPortal: async () => {
                SmartLog.info(`Loading portal for client ${currentClient.id}, project ${currentProject.id}`);
                app.showPage('page-portal');
                
                // עדכון UI
                document.getElementById('header-project-name').innerText = currentProject.title;
                document.getElementById('account-name').innerText = currentClient.name;
                document.getElementById('account-phone').innerText = currentClient.phone;
                document.getElementById('account-device').innerText = clientDeviceId ? clientDeviceId.slice(0, 8) : 'לא משויך';
                
                // [יישום הנחיה D] הצג אווטאר
                const avatarUrl = localStorage.getItem('sidorAvatarUrl') || "https://img.icons8.com/?size=100&id=36m26sAM2RfO&format=png&color=FFFFFF";
                document.getElementById('header-avatar-img').src = avatarUrl;
                
                // טעינת נתונים
                app.listenToOrders(currentProject.id); // רק הזמנות פעילות לפרויקט
                app.listenToHistory(currentClient.id); // כל ההזמנות של הלקוח
                
                // טעינת קטלוג מראש
                app.loadCatalogToForm();
                
                app.hideLoader();
            },
            
            logout: () => {
                localStorage.removeItem('sidorBoundPhone');
                localStorage.removeItem('sidorDeviceId');
                localStorage.removeItem('sidorAvatarUrl');
                currentClient = null;
                currentProject = null;
                clientDeviceId = null;
                allOrders = [];
                allProjects = [];
                SmartLog.info("User logged out and device unbound.");
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('loader-container').classList.add('hidden');
                app.showPage('page-login');
            },
            
            // [חדש] הצגת עמוד
            showPage: (pageId) => {
                document.querySelectorAll('.app-page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
            },

            // [חדש] רשימת פרויקטים (הנחיה 3)
            renderProjectSelection: (projects, phone) => {
                const container = document.getElementById('project-list-container');
                container.innerHTML = projects.map(p => `
                    <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                        <h3 class="font-bold text-lg">${p.title}</h3>
                        <p class="text-gray-600 text-sm">${p.address}</p>
                        <button class="btn btn-primary w-full mt-3" onclick="app.selectProject('${p.id}', '${phone}')">בחר בפרויקט זה</button>
                    </div>
                `).join('');
            },
            
            selectProject: async (projectId, phone) => {
                currentProject = allProjects.find(p => p.id === projectId);
                SmartLog.info(`Project ${projectId} selected.`);
                app.showLoader("טוען פרויקט...");
                await app.bindDeviceIfNeeded(phone);
            },


            // --- 4. האזנה להזמנות (מעקב חי) ---
            listenToOrders: (projectId) => {
                if (ordersListener) ordersListener(); 
                const collectionPath = ORDERS_COLLECTION_PATH;
                
                const q = query(
                    collection(db, collectionPath),
                    where("projectId", "==", projectId),
                    where("status", "in", ["חדש", "בטיפול", "שויך", "בדרך", "חדש (מלקוח)"]),
                    orderBy("createdAt", "desc"),
                    limit(10)
                );
                
                SmartLog.info(`Attaching LIVE listener to orders at: ${collectionPath} for project ${projectId}`);

                ordersListener = onSnapshot(q, (snapshot) => { 
                        SmartLog.info(`Snapshot received (Live Orders): ${snapshot.size} docs`);
                        
                        let ordersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        ordersData.forEach(order => {
                            const location = app.resolveLocation(order, 'order');
                            order.latitude = location.lat; 
                            order.longitude = location.lng;
                        });
                        
                        allOrders = ordersData; 
                        app.renderMarkersOnMap(); // עדכון סיכות מפה
                    }, 
                    (error) => {
                        SmartLog.error(error, "!!! FATAL: onSnapshot error (Live Orders)");
                    }
                );
            },
            
            // [חדש] האזנה להיסטוריה (טאב היסטוריה)
            listenToHistory: (clientId) => {
                if (historyListener) historyListener();
                
                const collectionPath = ORDERS_COLLECTION_PATH;
                const q = query(
                    collection(db, collectionPath),
                    where("clientId", "==", clientId), // שים לב: זה דורש שהשדה clientId יתווסף להזמנות
                    orderBy("createdAt", "desc"),
                    limit(30)
                );

                SmartLog.info(`Attaching HISTORY listener to orders at: ${collectionPath} for client ${clientId}`);

                historyListener = onSnapshot(q, (snapshot) => {
                    SmartLog.info(`Snapshot received (History): ${snapshot.size} docs`);
                    allHistoryOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    app.renderPortalHistory(allHistoryOrders);
                }, (error) => {
                    SmartLog.error(error, "!!! FATAL: onSnapshot error (History)");
                });
            },
                        
            
            // --- 5. רינדור ---
            renderPortalHistory: (orders) => {
                const container = document.getElementById('history-list-container');
                if (!container) return;
                if (orders.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 pt-8">לא נמצאו הזמנות קודמות.</p>`;
                    return;
                }
                
                container.innerHTML = orders.map(order => {
                    const statusColor = order.status === 'הושלם' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700';
                    return `
                        <div class="card" onclick="app.focusOnMapItem('${order.id}', 'order')">
                            <div class="card-header">
                                <span class="font-bold text-sm">${new Date(order.createdAt?.toDate() || Date.now()).toLocaleDateString('he-IL')}</span>
                                <span class="font-mono text-xs px-2 py-1 rounded ${statusColor}">${order.status || 'חדש'}</span>
                            </div>
                            <div class="card-body space-y-1">
                                <h3 class="font-semibold text-lg">${order.customer?.name || order.customer_name || 'לקוח לא ידוע'}</h3>
                                <p class="text-sm text-gray-600">${order.address || order.customer_address || 'כתובת לא צוינה'}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            // --- 6. ניווט ---
            navigatePortalTab: (pageId) => {
                document.querySelectorAll('.portal-page').forEach(p => p.style.display = 'none');
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                
                document.getElementById(pageId).style.display = 'block';
                document.querySelector(`.nav-item[onclick*="'${pageId}'"]`).classList.add('active');
                
                document.getElementById('header-title').innerText = {
                    'portal-tracking': 'מעקב הזמנה',
                    'portal-projects': 'פרויקטים',
                    'portal-history': 'היסטוריית הזמנות',
                    'portal-account': 'החשבון שלי'
                }[pageId];

                if (pageId === 'portal-tracking') {
                    app.initMap('map-container'); // אתחל (בבטחה)
                    app.waitForMap(() => {
                        app.renderMarkersOnMap();
                    });
                }
            },

            // --- 7. פונקציות מפה (לפי הנחיות 1, 2, 3, 5, 6) ---
            
            // [יישום הנחיה 1 ו-2] פונקציית אתחול המפה
            initMap: (containerId) => {
                if (map) {
                    map.invalidateSize();
                    if (!mapReady) mapReady = true; // ודא שהדגל תמיד נכון
                    return;
                }
                
                const mapContainer = document.getElementById(containerId);
                if (!mapContainer) {
                    SmartLog.info("Map container not found");
                    return; 
                }
                
                try {
                    map = L.map(containerId).setView([DEFAULT_LOCATION.lat, DEFAULT_LOCATION.lng], 10);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19, attribution: '© OpenStreetMap'
                    }).addTo(map);
                    
                    SmartLog.info("Map initialized successfully.");
                    mapReady = true; // [יישום הנחיה 2]
                } catch(e) {
                    SmartLog.error(e, "Map.Init");
                    mapContainer.innerHTML = '<p class="text-red-500 p-4">שגיאה בטעינת המפה.</p>';
                    mapReady = false;
                }
            },
            
            // [יישום הנחיה 3] מנגנון המתנה למפה
            waitForMap: (callback) => {
                SmartLog.info("Waiting for map...");
                if (mapReady && map) {
                    SmartLog.info("Map is ready. Executing callback.");
                    callback();
                    return;
                }
                // [יישום הנחיה 2] המתנה וחזרה
                setTimeout(() => app.waitForMap(callback), 300);
            },

            // [יישום הנחיה 1] פונקציית הוספת סיכה
            addMarkerToMap: (lat, lng, icon, popupContent) => {
                const marker = L.marker([lat, lng], { icon }).addTo(map)
                    .bindPopup(popupContent);
                mapMarkers.push(marker);
                return marker;
            },

            // [יישום הנחיה 5 ו-6] פונקציית רינדור מרכזית
            renderMarkersOnMap: () => {
                // [יישום הנחיה 4] בדיקה לפני רינדור
                if (!mapReady || !map) {
                    SmartLog.info("renderMarkersOnMap called, but map is not ready. Waiting...", { mapReady, mapExists: !!map });
                    return;
                }
                
                SmartLog.info("Rendering markers on map...");

                // [יישום הנחיה 5] ניקוי מרקרים ישנים
                mapMarkers.forEach(m => m.remove());
                mapMarkers = [];
                const bounds = L.latLngBounds();

                // 1. צייר הזמנות (כחול)
                allOrders.forEach(order => {
                    // [יישום הנחיה 5]
                    const lat = order.latitude;
                    const lng = order.longitude;
                    
                    if (!lat || !lng) {
                        // [יישום הנחיה 6]
                        SmartLog.error(null, "[RED-ALERT] Skipping order, missing lat/lng", order);
                        return; 
                    }
                    
                    const popupContent = `<b>(הזמנה) ${order.customer_name || 'לקוח'}</b><br>
                                          ${order.customer_address || 'כתובת לא ידועה'}<br>
                                          <b>סטטוס: ${order.status || 'חדש'}</b>`;
                    
                    const marker = app.addMarkerToMap(lat, lng, orderIcon, popupContent);
                    bounds.extend([lat, lng]);
                });

                if (bounds.isValid() && mapMarkers.length > 0) {
                    map.fitBounds(bounds, { padding: [20, 20] });
                }
                SmartLog.info(`Rendered ${mapMarkers.length} markers on map.`);
            },
            
            focusOnMapItem: (orderId, type) => {
                let lat, lon;
                let popupContent = "";

                if (type === 'order') {
                    const order = allOrders.find(o => o.id === orderId) || allHistoryOrders.find(o => o.id === orderId);
                    if (!order) {
                        SmartLog.error(null, "Order not found for focus", orderId);
                        return;
                    }
                    
                    const location = app.resolveLocation(order, 'order');
                    lat = location.lat;
                    lon = location.lng;
                    
                    if (!lat || !lon) {
                        SmartLog.error(null, "Cannot focus, order missing location", order);
                        showToast("לא קיים מיקום עבור הזמנה זו", "info");
                        return;
                    }
                    popupContent = `<b>(הזמנה) ${order.customer?.name || order.customer_name || ''}</b><br>${order.address || order.customer_address}<br>סטטוס: ${order.status}`;
                } 

                if (lat && lon) {
                    app.navigatePortalTab('portal-tracking'); 
                    app.waitForMap(() => {
                        SmartLog.info(`Focusing map on [${lat}, ${lon}]`);
                        map.setView([lat, lon], 16); // 16 = זום קרוב
                        L.popup().setLatLng([lat, lon]).setContent(popupContent).openOn(map);
                    });
                } else {
                    SmartLog.info("No location for this item:", orderId);
                    showToast("לא קיים מיקום עבור פריט זה", "info");
                }
            },

            // --- [חדש v1.22] פונקציות איתור מיקום (הועתקו מ-index2.html) ---
            
            // [יישום הנחיה 2]
            parseGPS: (gpsString) => {
                if (!gpsString || typeof gpsString !== 'string') return null;
                const parts = gpsString.split(',');
                if (parts.length < 2) return null;
                
                const lat = parseFloat(parts[0].trim());
                const lng = parseFloat(parts[1].trim());
                
                if (isNaN(lat) || isNaN(lng)) return null;
                return { lat, lng };
            },

            // [יישום הנחיה 3]
            findLocationInDB: (address) => {
                if (!address || typeof address !== 'string') return null;
                const normalizedAddress = address.trim(); 
                if (locationsDB[normalizedAddress]) {
                    SmartLog.info("Local DB HIT", normalizedAddress);
                    return locationsDB[normalizedAddress];
                }
                return null;
            },

            // [יישום הנחיה 4]
            resolveLocation: (doc, type) => {
                let lat, lng, source, address;

                // עדיפות 1: שדה GPS ידני (מהנחיה 2)
                if (doc.gps) {
                    const parsed = app.parseGPS(doc.gps);
                    if (parsed) {
                        return { lat: parsed.lat, lng: parsed.lng, source: 'manual_gps' };
                    }
                }

                // עדיפות 2: שדות קיימים (Cache של Firestore)
                if (type === 'order' && doc.latitude && doc.longitude) {
                    return { lat: doc.latitude, lng: doc.longitude, source: 'firestore_cache' };
                }
                // [תיקון] שדה לקוח הוא customLat/customLon
                if (type === 'project' && doc.customLat && doc.customLon) {
                    return { lat: doc.customLat, lng: doc.customLon, source: 'firestore_cache' };
                }

                // עדיפות 3: מאגר מקומי (הנחיה 3)
                address = (type === 'order') ? (doc.address || doc.customer_address) : doc.address;
                if (address) {
                    const fromDB = app.findLocationInDB(address);
                    if (fromDB) {
                        return { lat: fromDB.lat, lng: fromDB.lng, source: 'local_db' };
                    }
                }

                // עדיפות 4: Fallback (הנחיה 4)
                return { lat: DEFAULT_LOCATION.lat, lng: DEFAULT_LOCATION.lng, source: 'fallback' };
            },
            
            // --- 8. [חדש] לוגיקת הזמנה חדשה ---
            
            openNewOrderModal: () => {
                sharedLocation = null; // איפוס מיקום
                document.getElementById('location-status').classList.add('hidden');
                document.getElementById('order-form-gps').value = '';
                
                // טען פרויקטים לבחירה
                const projectSelect = document.getElementById('order-form-project');
                projectSelect.innerHTML = allProjects.map(p => `<option value="${p.id}">${p.title} (${p.address})</option>`).join('');
                projectSelect.value = currentProject.id; // בחר את הפרויקט הנוכחי
                
                document.getElementById('modal-new-order').classList.remove('hidden', 'opacity-0');
            },
            
            closeNewOrderModal: (e = null) => {
                if(e && e.target.id !== 'modal-new-order') return;
                document.getElementById('modal-new-order').classList.add('hidden', 'opacity-0');
            },

            loadCatalogToForm: async () => {
                try {
                    const catalog = await api.getCatalog();
                    const catalogSelect = document.getElementById('order-form-catalog');
                    catalogSelect.innerHTML = catalog.map(item => `<option value="${item.sku}">${item.name}</option>`).join('');
                } catch (error) {
                    SmartLog.error(error, "Failed to load catalog");
                }
            },
            
            // [חדש] הנחיה 8: שיתוף מיקום מהמכשיר
            shareDeviceLocation: () => {
                if (!navigator.geolocation) {
                    showToast("שיתוף מיקום לא נתמך בדפדפן זה", "error");
                    return;
                }
                
                const statusEl = document.getElementById('location-status');
                statusEl.innerText = "מאחזר מיקום...";
                statusEl.className = "text-blue-600 text-sm font-medium mt-2";
                statusEl.classList.remove('hidden');

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        sharedLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        SmartLog.info("Device location shared:", sharedLocation);
                        statusEl.innerText = `מיקום מדויק נשמר! (${sharedLocation.lat.toFixed(4)}, ${sharedLocation.lng.toFixed(4)})`;
                        statusEl.className = "text-green-600 text-sm font-medium mt-2";
                        document.getElementById('order-form-gps').value = ''; // נקה GPS ידני אם קיים
                    },
                    (error) => {
                        SmartLog.error(error, "Geolocation failed");
                        statusEl.innerText = `שגיאה באחזור מיקום: ${error.message}`;
                        statusEl.className = "text-red-600 text-sm font-medium mt-2";
                        sharedLocation = null;
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            },
            
            // [חדש] הנחיה 7: שמירת הזמנה
            submitOrderForm: async () => {
                const btn = document.getElementById('submit-order-form');
                btn.disabled = true;
                btn.innerText = "שומר...";
                
                try {
                    const projectId = document.getElementById('order-form-project').value;
                    const selectedProject = allProjects.find(p => p.id === projectId);
                    const items = Array.from(document.getElementById('order-form-catalog').selectedOptions).map(opt => ({ sku: opt.value, name: opt.text, qty: 1 }));
                    const orderDate = document.getElementById('order-form-date').value;
                    const notes = document.getElementById('order-form-notes').value;
                    const manualGps = document.getElementById('order-form-gps').value;

                    if (!orderDate || items.length === 0) {
                        showToast("חובה לבחור פריטים ותאריך אספקה", "error");
                        throw new Error("Missing fields");
                    }
                    
                    let orderLocation = { lat: null, lng: null, gps: null };

                    // [יישום הנחיה 8] סדר עדיפויות למיקום
                    if (sharedLocation) {
                        // 1. מיקום מהמכשיר
                        orderLocation = { ...sharedLocation, gps: `${sharedLocation.lat}, ${sharedLocation.lng}` };
                    } else if (manualGps) {
                        // 2. GPS ידני
                        const parsed = app.parseGPS(manualGps);
                        if (parsed) {
                            orderLocation = { ...parsed, gps: manualGps };
                        } else {
                            showToast("פורמט GPS ידני שגוי", "error");
                            throw new Error("Invalid GPS format");
                        }
                    } else {
                        // 3. Fallback לכתובת הפרויקט
                        const resolved = app.resolveLocation(selectedProject, 'project'); // נשתמש בלוגיקה הקיימת
                        orderLocation = { lat: resolved.lat, lng: resolved.lng, gps: resolved.source };
                    }

                    const newOrderData = {
                        clientId: currentClient.id,
                        projectId: projectId,
                        items: items, // [יישום הנחיה 10]
                        status: "חדש (מלקוח)",
                        createdByDevice: clientDeviceId,
                        createdAt: serverTimestamp(),
                        lastModified: serverTimestamp(),
                        orderDate: orderDate,
                        notes: notes,
                        gps: orderLocation.gps, // [יישום הנחיה 8]
                        latitude: orderLocation.lat,
                        longitude: orderLocation.lng,
                        // העתקת פרטי לקוח ופרויקט
                        customer_name: currentClient.name,
                        customer_address: selectedProject.address,
                        projectName: selectedProject.title,
                        customer: {
                            id: currentClient.id,
                            name: currentClient.name,
                            phone: currentClient.phone,
                            address: selectedProject.address
                        }
                    };

                    const orderDocRef = await addDoc(collection(db, ORDERS_COLLECTION_PATH), newOrderData);
                    SmartLog.info(`New order created by customer: ${orderDocRef.id}`, newOrderData);
                    
                    showToast("הזמנה חדשה נוצרה בהצלחה!", "success");
                    app.closeNewOrderModal();
                    app.navigatePortalTab('portal-history'); // עבור להיסטוריה לראות את ההזמנה

                } catch (error) {
                    SmartLog.error(error, "Failed to submit new order");
                    if (error.message !== "Missing fields" && error.message !== "Invalid GPS format") {
                        showToast("שגיאה בשמירת הזמנה", "error");
                    }
                } finally {
                    btn.disabled = false;
                    btn.innerText = "שלח הזמנה";
                }
            },
            
            // [חדש] הנחיה 7: הדבקה חכמה
            submitSmartPaste: () => {
                const text = document.getElementById('smart-paste-input').value;
                if (!text) {
                    showToast("השדה ריק", "error");
                    return;
                }
                
                SmartLog.info("Parsing smart paste (Not Implemented)", text);
                showToast("ניתוח הדבקה חכמה - בבנייה", "info");
                // TODO: להוסיף כאן לוגיקת NLP לניתוח הטקסט
                // ...
                // בסיום, למלא את טופס 2 ולעבור אליו
                // app.navigateNewOrderTab('form');
            },

            navigateNewOrderTab: (tabId) => {
                if (tabId === 'form') {
                    document.getElementById('tab-content-smart').classList.add('hidden');
                    document.getElementById('tab-content-form').classList.remove('hidden');
                    document.getElementById('tab-btn-smart').classList.remove('border-blue-500', 'text-blue-500');
                    document.getElementById('tab-btn-smart').classList.add('text-gray-500');
                    document.getElementById('tab-btn-form').classList.add('border-blue-500', 'text-blue-500');
                    document.getElementById('tab-btn-form').classList.remove('text-gray-500');
                } else {
                    document.getElementById('tab-content-smart').classList.remove('hidden');
                    document.getElementById('tab-content-form').classList.add('hidden');
                    document.getElementById('tab-btn-smart').classList.add('border-blue-500', 'text-blue-500');
                    document.getElementById('tab-btn-smart').classList.remove('text-gray-500');
                    document.getElementById('tab-btn-form').classList.remove('border-blue-500', 'text-blue-500');
                    document.getElementById('tab-btn-form').classList.add('text-gray-500');
                }
            },

            // --- 9. כלי עזר ---
            
            // [יישום הנחיה A.2] - [עדכון v41]
            normalizePhone: (raw) => {
                if (!raw) return null;
                // מנקה הכל חוץ מספרות
                let s = String(raw).replace(/[^0-9]/g, ""); // "0546609953" or "972546609953"
                if (s.startsWith("972")) {
                    s = "0" + s.slice(3); // הופך ל "0546609953"
                }
                if (s.startsWith("05") && s.length === 10) {
                    return s; // מחזיר "0546609953"
                }
                return null; // לא תקין
            },
            
            // [יישום הנחיה F.2]
            extractPhoneFromText: (text) => {
                if (!text) return null;
                // [עדכון v41] חפש פורמט ישראלי
                const re = /(?:^|\s|:|\n)(05\d-?\d{7})(?:$|\s|,|\n)/;
                const matches = text.match(re);
                if (!matches || !matches[1]) return null;
                // החזר את ההתאמה הראשונה הנקייה
                return app.normalizePhone(matches[1]);
            },

            validatePhone: (phone) => {
                if (!phone) return false;
                // [עדכון v41] Regex שתומך רק בפורמט 05X
                const israeliPhoneRegex = /^05\d{8}$/;
                return israeliPhoneRegex.test(phone.trim());
            },

            // [חדש] הנחיה C: החלפת עיצוב
            initTheme: () => {
                const theme = localStorage.getItem('sidorTheme') || 'light';
                app.setTheme(theme);
            },
            
            toggleTheme: () => {
                const currentTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
                app.setTheme(currentTheme);
            },
            
            setTheme: (theme) => {
                const toggleDot = document.getElementById('theme-toggle-dot');
                const themeText = document.getElementById('theme-text');
                const iconDark = document.getElementById('theme-icon-dark');
                const iconLight = document.getElementById('theme-icon-light');

                if (theme === 'dark') {
                    document.body.classList.add('dark');
                    if (toggleDot) toggleDot.style.transform = 'translateX(20px)';
                    if (themeText) themeText.innerText = 'מצב בהיר';
                    if (iconDark) iconDark.classList.add('hidden');
                    if (iconLight) iconLight.classList.remove('hidden');
                } else {
                    document.body.classList.remove('dark');
                    if (toggleDot) toggleDot.style.transform = 'translateX(0)';
                    if (themeText) themeText.innerText = 'מצב כהה';
                    if (iconDark) iconDark.classList.remove('hidden');
                    if (iconLight) iconLight.classList.add('hidden');
                }
                localStorage.setItem('sidorTheme', theme);
                feather.replace(); // רענון אייקונים
            }

        };

        // --- פונקציית עזר גלובלית לטוסט ---
        function showToast(message, type = 'info') {
            let container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type} opacity-0 transform -translate-y-5`;
            toast.innerText = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('opacity-0', '-translate-y-5');
            }, 50);

            setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-5');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // --- חשיפה גלובלית והפעלה ---
        window.app = app; // חשיפה גלובלית כדי שכפתורי HTML יוכלו לקרוא לזה
        
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
            feather.replace();
            
            // חיבור Event Listeners ידני
            document.getElementById('login-btn').addEventListener('click', () => app.login());
            document.getElementById('logout-btn').addEventListener('click', app.logout);
            document.getElementById('tab-btn-smart').addEventListener('click', () => app.navigateNewOrderTab('smart'));
            document.getElementById('tab-btn-form').addEventListener('click', () => app.navigateNewOrderTab('form'));
            document.getElementById('submit-smart-paste').addEventListener('click', app.submitSmartPaste);
            document.getElementById('submit-order-form').addEventListener('click', app.submitOrderForm);
            document.getElementById('theme-toggle-btn').addEventListener('click', app.toggleTheme);
            
            // [יישום הנחיה F.3] "מלשינון" הדבקה
            document.getElementById('phone-input').addEventListener('paste', (e) => {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text');
                const extractedPhone = app.extractPhoneFromText(text);
                
                if (extractedPhone) {
                    e.target.value = extractedPhone;
                    const helper = document.getElementById('paste-helper');
                    helper.innerText = `מספר חולץ: ${extractedPhone}`;
                    helper.classList.remove('hidden');
                    setTimeout(() => helper.classList.add('hidden'), 3000);
                } else {
                    e.target.value = text; // הדבק רגיל אם לא נמצא מספר
                }
            });

            // [יישום הנחיה D] "מלשינון" אווטאר
            document.getElementById('avatar-url-input').addEventListener('input', (e) => { // שונה ל-input
                const url = e.target.value;
                const preview = document.getElementById('avatar-preview');
                if (url && (url.startsWith('http') || url.startsWith('data:image'))) {
                    preview.innerHTML = `<img src="${url}" class="w-full h-full object-cover" alt="Avatar Preview">`;
                    localStorage.setItem('sidorAvatarUrl', url); // שמור לשימוש עתידי
                } else {
                     preview.innerHTML = `<i data-feather="image"></i>`;
                     feather.replace();
                }
            });
        });
    </script>
</body>
</html>
