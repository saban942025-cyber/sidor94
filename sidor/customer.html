<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>注拽  - 砖专 v3.0</title>
    <!-- 
      DeliveryMaster Customer App v3.0 (Firebase)
      - 住驻 转 爪专转  砖
      - 住驻 注专转 转拽砖专转 -转 (爪')
      - 住驻 转 砖转 拽
      - [FIX] Changed Firebase imports to protocol-relative (//)
    -->

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- LeafletJS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- Google Font: Rubik -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Rubik', sans-serif;
            background-color: #f4f7f6;
        }
        #map {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            background-color: #eee;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Status Tracker */
        .status-tracker { display: flex; justify-content: space-between; align-items: flex-start; position: relative; margin-bottom: 2.5rem; }
        .status-tracker::before { content: ''; position: absolute; top: 16px; right: 0; left: 0; height: 4px; background-color: #e5e7eb; z-index: 1; }
        .status-tracker-progress { position: absolute; top: 16px; right: 0; height: 4px; background-color: #3b82f6; z-index: 2; width: 0%; transition: width 0.5s ease; }
        .status-step { display: flex; flex-direction: column; align-items: center; text-align: center; width: 60px; z-index: 3; }
        .status-dot { width: 36px; height: 36px; border-radius: 50%; background-color: #e5e7eb; border: 4px solid #f4f7f6; color: #9ca3af; display: flex; align-items: center; justify-content: center; font-weight: 700; transition: all 0.3s ease; }
        .status-label { font-size: 0.75rem; font-weight: 500; color: #9ca3af; margin-top: 0.5rem; line-height: 1.2; }
        .status-step.completed .status-dot { background-color: #3b82f6; color: white; border-color: #dbeafe; }
        .status-step.completed .status-label { color: #1f2937; }
        .status-step.active .status-dot { background-color: white; border-color: #3b82f6; color: #3b82f6; transform: scale(1.1); }
        .status-step.active .status-label { color: #3b82f6; font-weight: 700; }
        
        /* 住转 砖 爪' */
        .chat-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            word-wrap: break-word;
        }
        .chat-bubble-admin { /* 注  */
            background-color: #e2e8f0; /* gray-200 */
            color: #1e293b; /* gray-800 */
            border-bottom-left-radius: 0.25rem;
            align-self: flex-start;
        }
        .chat-bubble-customer { /* 注 拽 */
            background-color: #2563eb; /* blue-600 */
            color: white;
            border-bottom-right-radius: 0.25rem;
            align-self: flex-end;
        }
        .chat-timestamp {
            font-size: 0.7rem;
            color: #9ca3af; /* gray-400 */
            margin-top: 0.25rem;
        }
        .chat-bubble-customer .chat-timestamp {
             color: #dbeafe; /* blue-100 */
        }
        
        /* 住  */
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="bg-gray-100">

    <!--   砖 -->
    <dialog id="new-order-modal" class="p-0 rounded-lg shadow-xl w-11/12 max-w-2xl">
        <div class="sticky top-0 bg-white p-4 border-b flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-800">爪专转  砖</h2>
            <button onclick="document.getElementById('new-order-modal').close()" class="text-gray-500 hover:text-gray-800">
                <i data-feather="x"></i>
            </button>
        </div>
        <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
            <p class="text-sm text-gray-600">驻专 拽 砖 (<span id="modal-customer-name" class="font-semibold"></span>) 爪专驻 转  .</p>
            
            <div>
                <label for="paste-content" class="block text-sm font-medium text-gray-700">拽 转  ( 拽 驻专)</label>
                <textarea id="paste-content" rows="5" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder=": 10 拽 20, 5 ..."></textarea>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="order-project" class="block text-sm font-medium text-gray-700">砖 驻专拽 (专砖转)</label>
                    <input type="text" id="order-project" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder=":  专砖">
                </div>
                <div>
                    <label for="order-transport-type" class="block text-sm font-medium text-gray-700">住 </label>
                    <select id="order-transport-type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">专 住 </option>
                        <option value="转 祝">转 祝</option>
                        <option value="转 砖转">转 砖转</option>
                        <option value="住祝 注爪">住祝 注爪</option>
                        <option value="注转 祝">注转 祝</option>
                        <option value="爪转 ">爪转 </option>
                        <option value="驻转 ">驻转 </option>
                        <option value="爪转 ">爪转 </option>
                        <option value="驻专拽 转">驻专拽 转</option>
                    </select>
                </div>
            </div>

            <!-- 驻专 住祝 注爪 (住转专 专专转 ) -->
            <div id="branch-info" class="hidden space-y-3 p-4 bg-gray-50 rounded-lg border">
                <h4 class="font-semibold text-gray-800">驻专 住驻 住祝 注爪</h4>
                <div class="text-sm">
                    <p><strong>住祝 转:</strong> 转 6,  砖专 | <a href="tel:09-7602010" class="text-blue-600">09-7602010</a></p>
                    <p><strong>住祝 专砖:</strong> 专砖 10,  砖专 | <a href="tel:09-7402575" class="text-blue-600">09-7402575</a></p>
                </div>
                <!-- 转 住祝  驻转 注转  专爪 -->
            </div>

        </div>
        <div class="p-4 bg-gray-50 border-t flex justify-end gap-3">
            <button type="button" class_alias="secondary" onclick="document.getElementById('new-order-modal').close()" class="py-2 px-4 bg-white border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">
                
            </button>
            <button type="button" onclick="submitNewOrder()" class="py-2 px-4 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700">
                砖 
            </button>
        </div>
    </dialog>


    <div class="container mx-auto max-w-lg p-4">
        
        <header class="text-center my-6 flex flex-col items-center">
            <!-- 驻转专  砖 -->
            <button onclick="openNewOrderModal()" class="absolute top-4 left-4 bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                <i data-feather="plus"></i>
            </button>
            
            <img src="https://placehold.co/80x80/3B82F6/FFFFFF?text=SBN" alt="Company Logo" class="w-20 h-20 mx-auto mb-4 rounded-lg shadow-sm">
            <h1 class="text-3xl font-bold text-gray-800">注拽 砖</h1>
            <p id="order-id-display" class="text-gray-600">注 驻专 ...</p>
        </header>

        <main class="bg-white p-6 rounded-lg shadow-lg space-y-6">
            
            <!-- Loader -->
            <div id="loader" class="text-center py-10">
                <div class="loader"></div>
                <p class="text-gray-600">转专 转  砖...</p>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="hidden text-center py-10">
                <i data-feather="alert-triangle" class="w-12 h-12 mx-auto text-red-500"></i>
                <p class="text-red-600 mt-4" id="error-text">砖 注转 转.</p>
            </div>

            <!-- Order Details -->
            <div id="order-content" class="hidden space-y-6">
                <div>
                    <p class="text-gray-700 text-lg">砖 <strong id="customer-name"></strong>,  砖 住住:</p>
                    <!-- Status Tracker -->
                    <div class="status-tracker mt-6">
                        <div class="status-tracker-progress" id="status-progress-bar"></div>
                        <div class="status-step" id="step-new">
                            <div class="status-dot"><i data-feather="check"></i></div>
                            <div class="status-label">转拽</div>
                        </div>
                        <div class="status-step" id="step-assigned">
                            <div class="status-dot"><i data-feather="user-check"></i></div>
                            <div class="status-label">砖 </div>
                        </div>
                        <div class="status-step" id="step-onway">
                            <div class="status-dot"><i data-feather="truck"></i></div>
                            <div class="status-label">专 </div>
                        </div>
                        <div class="status-step" id="step-completed">
                            <div class="status-dot"><i data-feather="flag"></i></div>
                            <div class="status-label">砖</div>
                        </div>
                    </div>
                </div>
                
                <!-- Map -->
                <div id="map-container" class="hidden">
                    <h3 class="font-semibold mb-3 text-lg">注拽 </h3>
                    <div id="map"></div>
                </div>

                <!-- Driver Details -->
                <div id="driver-details" class="bg-gray-50 p-4 rounded-lg flex items-center space-x-4 space-x-reverse hidden">
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i data-feather="truck" class="w-6 h-6 text-blue-600"></i>
                    </div>
                    <div>
                        <p class="font-semibold"> 砖: <span id="driver-name"></span></p>
                        <a href="#" id="driver-phone-link" class="text-blue-600 text-sm font-medium">
                            <i data-feather="phone" class="w-4 h-4 inline-block ml-1"></i>
                            <span id="driver-phone"></span>
                        </a>
                    </div>
                </div>
                
                <!-- Order Notes -->
                <div id="notes-container" class="hidden">
                    <h3 class="font-semibold mb-2 text-lg">注专转 砖</h3>
                    <p id="order-notes" class="text-gray-700 bg-gray-50 p-3 rounded-md"></p>
                </div>
                
                <!-- 驻爪'专 爪' 砖 -->
                <div id="chat-section">
                    <h3 class="font-semibold mb-3 text-lg">转拽砖专转 注 </h3>
                    <div id="chat-history" class="h-48 bg-gray-100 rounded-lg p-3 overflow-y-auto flex flex-col space-y-2 border">
                        <!-- 注转 爪' 驻注  -->
                        <p class="text-gray-500 text-sm text-center">注 住专转 注转...</p>
                    </div>
                    <div class="mt-3 flex gap-2">
                        <input type="text" id="chat-message" class="flex-grow p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="转 注 ...">
                        <button onclick="sendCustomerMessage()" class="bg-blue-600 text-white p-3 rounded-lg shadow hover:bg-blue-700">
                            <i data-feather="send"></i>
                        </button>
                    </div>
                    <button onclick="sendLocation()" class="mt-2 w-full text-sm bg-green-600 text-white p-2 rounded-lg shadow hover:bg-green-700 flex items-center justify-center gap-2">
                        <i data-feather="map-pin" class="w-4 h-4"></i>
                        砖 拽 拽
                    </button>
                </div>

            </div>

        </main>

        <footer class="text-center mt-6 text-gray-500 text-sm">
            <p>&copy; 2024 DeliveryMaster</p>
        </footer>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // ---  [FIX] Using protocol-relative URLs (//) to avoid module resolution errors ---
        import { initializeApp, getApps, getApp } from "//www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "//www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, collection, doc, onSnapshot, query, orderBy, 
            addDoc, serverTimestamp, where, getDoc 
        } from "//www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- Inlined Config Logic ---
        // 砖砖 拽驻专爪 砖 驻专拽 saban94-78949
        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949",
          storageBucket: "saban94-78949.firebasestorage.app", 
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a", 
          measurementId: "G-XV6RZDESSB"
        };
        
        let app, auth, db; 
        let initializationError = null;
        
        try {
            app = getApps().length ? getApp() : initializeApp(firebaseConfig);
            auth = getAuth(app); 
            db = getFirestore(app);
        } catch (error) { 
            console.error("CRITICAL: Firebase init failed!", error); 
            initializationError = error; 
        }

        const MAX_AUTH_RETRIES = 3; 
        const RETRY_DELAY_MS = 3000;
        
        async function ensureAuth() {
            console.log("ensureAuth: Starting..."); 
            let tries = 0;
            while (tries < MAX_AUTH_RETRIES) {
                tries++;
                try {
                    if (initializationError) throw new Error(`Init failed: ${initializationError.message}`);
                    if (!auth) throw new Error("Auth object missing");
                    const userCredential = await signInAnonymously(auth);
                    console.log("ensureAuth: Success.", userCredential.user.uid); 
                    return userCredential.user;
                } catch (e) {
                    console.warn(`[FirebaseAuth] Attempt ${tries} failed:`, e.code, e.message);
                    if (tries >= MAX_AUTH_RETRIES) { 
                        console.error("ensureAuth: All attempts failed."); 
                        throw e; 
                    }
                    await new Promise(r => setTimeout(r, RETRY_DELAY_MS));
                }
            } 
            throw new Error("ensureAuth: Max retries reached.");
        }
        
        const authReadyPromise = ensureAuth();
        
        // --- SmartLog (Minimal) ---
        const SmartLog = {
            info: (msg, ctx) => console.log("[INFO]", msg, ctx || ''),
            warn: (msg, ctx) => console.warn("[WARN]", msg, ctx || ''),
            error: (err, ctx) => console.error("[ERROR]", err, ctx || '')
        };

        // --- Map & State ---
        let map;
        let driverMarker;
        let orderMarker;
        let orderListenerUnsubscribe = null;
        let locationListenerUnsubscribe = null;
        let messagesListenerUnsubscribe = null; // 砖
        let currentOrderId = null; // 砖砖  -Document ID
        let currentOrderData = null; // --- 砖: 砖专 转  转 
        let currentCustomerData = null; // 砖: 砖专 转 驻专 拽

        // --- Icons ( 砖) ---
        const driverIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41]
        });
        const orderIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41]
        });

        // --- UI Functions ( 砖) ---
        function showLoader(show) { document.getElementById('loader').style.display = show ? 'block' : 'none'; }
        function showError(message) {
            showLoader(false);
            document.getElementById('order-content').style.display = 'none';
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-text').innerText = message || '专注 砖.';
        }
        function showContent() {
            showLoader(false);
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('order-content').classList.remove('hidden');
            document.getElementById('order-content').classList.add('space-y-6');
            feather.replace();
        }
        
        // --- Map Functions ( 砖) ---
        function initializeMap(orderLatLng) {
            try {
                if (map) map.remove(); 
                map = L.map('map');
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OSM' }).addTo(map);
                const bounds = L.latLngBounds();
                if (orderLatLng) {
                    orderMarker = L.marker(orderLatLng, { icon: orderIcon }).addTo(map).bindPopup("转转 住驻拽");
                    bounds.extend(orderLatLng);
                }
                if (bounds.isValid()) { map.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 }); } 
                else { map.setView([32.0853, 34.7818], 9); }
            } catch (error) {
                SmartLog.error(error, { context: "Error initializing map" });
                document.getElementById('map').innerHTML = "砖 注转 驻.";
            }
        }
        
        function updateMap(orderLatLng, driverLatLng) {
            if (!map) return;
            const bounds = L.latLngBounds();
            if (orderLatLng) {
                if (orderMarker) { orderMarker.setLatLng(orderLatLng); } 
                else { orderMarker = L.marker(orderLatLng, { icon: orderIcon }).addTo(map).bindPopup("转转 住驻拽"); }
                bounds.extend(orderLatLng);
            }
            if (driverLatLng) {
                document.getElementById('map-container').classList.remove('hidden');
                if (driverMarker) { driverMarker.setLatLng(driverLatLng); } 
                else { driverMarker = L.marker(driverLatLng, { icon: driverIcon }).addTo(map).bindPopup("拽 "); }
                bounds.extend(driverLatLng);
            } else {
                if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }
            }
            if (bounds.isValid()) { setTimeout(() => map.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 }), 50); }
        }
        
        // --- Status Tracker UI ( 砖) ---
        function updateStatusTracker(status) {
            const steps = { '砖': 0, '砖': 1, '专': 2, '砖': 3, '': -1 };
            const stepIndex = steps[status] ?? 0;
            if (stepIndex === -1) { /* ... handle cancelled ... */ return; }
            const progressPercentage = (stepIndex / 3) * 100;
            document.getElementById('status-progress-bar').style.width = `${progressPercentage}%`;
            document.getElementById('step-new').classList.toggle('completed', stepIndex >= 0);
            document.getElementById('step-assigned').classList.toggle('completed', stepIndex >= 1);
            document.getElementById('step-onway').classList.toggle('completed', stepIndex >= 2);
            document.getElementById('step-completed').classList.toggle('completed', stepIndex >= 3);
            document.querySelectorAll('.status-step').forEach(step => step.classList.remove('active'));
            if (stepIndex === 0) document.getElementById('step-new').classList.add('active');
            if (stepIndex === 1) document.getElementById('step-assigned').classList.add('active');
            if (stepIndex === 2) document.getElementById('step-onway').classList.add('active');
            if (stepIndex === 3) document.getElementById('step-completed').classList.add('active');
        }

        // --- Main Logic ---
        function getOrderIdFromUrl() {
            try {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id'); // ID = order_id (e.g. 6715504)
                if (!id) { showError("拽砖专  转拽. 住专  ."); return null; }
                return id;
            } catch (e) { SmartLog.error(e, { context: "Error reading URL params" }); showError("砖 注 拽砖专."); return null; }
        }
        
        async function startTracking() {
            const shortOrderId = getOrderIdFromUrl();
            if (!shortOrderId) return;
            
            try {
                await authReadyPromise; 
                SmartLog.info("Auth ready, searching for order by order_id.", { shortOrderId: shortOrderId });
                
                // --- 砖专: 驻砖  驻 砖 `order_id` ---
                // 专砖 拽住: orders (order_id ASC)
                const q = query(
                    collection(db, "orders"), 
                    where("order_id", "==", shortOrderId),
                    limit(1)
                );
                
                const orderSnapshot = await getDocs(q);
                
                if (orderSnapshot.empty) {
                    showError("  爪.  拽 转 拽砖专.");
                    SmartLog.error(new Error("Order not found with order_id"), { shortOrderId });
                    return;
                }
                
                // 爪 转 , 注砖   驻 -Document ID 转
                const orderDoc = orderSnapshot.docs[0];
                currentOrderId = orderDoc.id; //  -Document ID
                
                SmartLog.info(`Found order. Document ID: ${currentOrderId}`, { shortOrderId });

                // Attach listener to the order
                const orderRef = doc(db, "orders", currentOrderId);
                orderListenerUnsubscribe = onSnapshot(orderRef, (docSnap) => {
                    if (!docSnap.exists()) {
                        showError(" 拽  砖 拽转 转专.");
                        return;
                    }
                    
                    const orderData = docSnap.data();
                    currentOrderData = orderData; // 砖专转  转 
                    currentCustomerData = orderData.customer; // 砖专转 驻专 拽
                    renderOrderData(orderData); 
                    
                    const driverId = orderData.driver?.id;
                    if (driverId && (orderData.status === '砖' || orderData.status === '专')) {
                        listenToDriverLocation(driverId, orderData);
                    } else {
                        if (locationListenerUnsubscribe) { locationListenerUnsubscribe(); locationListenerUnsubscribe = null; }
                        updateMap([orderData.latitude, orderData.longitude], null);
                    }
                    
                    // 驻注转  爪'
                    listenToMessages(currentOrderId);

                }, (error) => {
                    SmartLog.error(error, { context: "Error in order listener" });
                    showError("砖 拽转 转 .");
                });

            } catch (error) {
                SmartLog.error(error, { context: "Failed to query or auth before tracking" });
                showError("砖转 转专转. 住 专注.");
            }
        }
        
        // --- 驻拽爪转  (注 砖) ---
        function listenToDriverLocation(driverId, orderData) {
            if (locationListenerUnsubscribe) { locationListenerUnsubscribe(); locationListenerUnsubscribe = null; }
            SmartLog.info("Listening to driver location...", { driverId });
            const locationRef = doc(db, "driverLocations", driverId);
            locationListenerUnsubscribe = onSnapshot(locationRef, (docSnap) => {
                 const orderLatLng = [orderData.latitude, orderData.longitude];
                 if (docSnap.exists() && orderData.status === '专') {
                     const locData = docSnap.data();
                     const driverLatLng = [locData.latitude, locData.longitude];
                     updateMap(orderLatLng, driverLatLng);
                 } else {
                     updateMap(orderLatLng, null);
                 }
            }, (error) => {
                SmartLog.error(error, { context: "Error in location listener", driverId });
                updateMap([orderData.latitude, orderData.longitude], null);
            });
        }
        
        function renderOrderData(order) {
            const displayId = order.orderNumber || order.order_id || `#${currentOrderId.slice(-6)}`;
            document.getElementById('order-id-display').innerText = ` ${displayId}`;
            document.getElementById('customer-name').innerText = order.customer?.name || '拽';
            updateStatusTracker(order.status);
            
            const driverDetailsEl = document.getElementById('driver-details');
            const notesContainerEl = document.getElementById('notes-container');
            
            if (order.driver?.name && (order.status === '砖' || order.status === '专')) {
                document.getElementById('driver-name').innerText = order.driver.name;
                const phone = order.driver.phone || ' '; 
                document.getElementById('driver-phone').innerText = phone;
                document.getElementById('driver-phone-link').href = `tel:${phone}`;
                driverDetailsEl.classList.remove('hidden');
                driverDetailsEl.classList.add('flex');
            } else {
                driverDetailsEl.classList.add('hidden');
                driverDetailsEl.classList.remove('flex');
            }

            if (order.notes) {
                document.getElementById('order-notes').innerText = order.notes;
                notesContainerEl.classList.remove('hidden');
            } else {
                notesContainerEl.classList.add('hidden');
            }
            
            const orderLatLng = [order.latitude, order.longitude];
            if (!map && orderLatLng[0]) { 
                 document.getElementById('map-container').classList.remove('hidden');
                 initializeMap(orderLatLng);
            }
            
            showContent();
        }

        // --- 驻拽爪转 砖转 (爪'  砖) ---
        
        function listenToMessages(orderId) {
            if (messagesListenerUnsubscribe) messagesListenerUnsubscribe(); // 转拽  拽
            
            const chatHistoryEl = document.getElementById('chat-history');
            const q = query(
                collection(db, "orders", orderId, "messages"),
                orderBy("timestamp", "asc")
            );

            messagesListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                chatHistoryEl.innerHTML = ''; // 拽 住专
                if (snapshot.empty) {
                    chatHistoryEl.innerHTML = '<p class="text-gray-500 text-sm text-center"> 注转. 转 砖!</p>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const bubble = document.createElement('div');
                    const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '';
                    
                    // 爪 专拽 注转 拽 转专转
                    if (msg.type === 'notification_to_customer') {
                        bubble.className = 'chat-bubble chat-bubble-admin';
                        bubble.innerHTML = `<strong class="block">${msg.senderName || ''}</strong>
                                            <p>${msg.text}</p>
                                            <span class="chat-timestamp text-right">${time}</span>`;
                        chatHistoryEl.appendChild(bubble);
                    } else if (msg.type === 'message_to_admin') {
                        bubble.className = 'chat-bubble chat-bubble-customer';
                        bubble.innerHTML = `<strong class="block">${msg.senderName || ''}</strong>
                                            <p>${msg.text}</p>
                                            <span class="chat-timestamp text-right">${time}</span>`;
                        chatHistoryEl.appendChild(bubble);
                    }
                });
                //  转转转
                chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
            }, (error) => {
                SmartLog.error(error, { context: "Failed to listen to messages" });
                chatHistoryEl.innerHTML = '<p class="text-red-500 text-sm text-center">砖 注转 注转</p>';
            });
        }
        
        async function sendCustomerMessage(messageText) {
            const text = messageText || document.getElementById('chat-message').value.trim();
            if (!text || !currentOrderId || !currentCustomerData) return;
            
            const messageData = {
                text: text,
                senderName: currentCustomerData.name || '拽',
                timestamp: serverTimestamp(),
                type: 'message_to_admin',
                readByViewer: false
            };
            
            try {
                const messagesColRef = collection(db, 'orders', currentOrderId, 'messages');
                await addDoc(messagesColRef, messageData);
                if (!messageText) { //  转拽   砖 驻转 ( 拽)
                    document.getElementById('chat-message').value = '';
                }
                SmartLog.info("Customer message sent", { orderId: currentOrderId, text });
            } catch (error) {
                SmartLog.error(error, { context: "Failed to send customer message" });
                alert("砖 砖转 注.");
            }
        }
        window.sendCustomerMessage = sendCustomerMessage; // 砖驻 转
        
        function sendLocation() {
            if (!navigator.geolocation) {
                alert("砖转 拽  转转 驻驻 .");
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    const locationText = `砖转 转 拽 拽 砖: https://www.google.com/maps?q=${latitude},${longitude}`;
                    sendCustomerMessage(locationText); // 砖 转 拽 注转 拽住
                },
                (error) => {
                    alert(" 转  拽 转 拽.  砖专砖转 拽 驻注转.");
                    SmartLog.error(error, { context: "Geolocation failed" });
                }
            );
        }
        window.sendLocation = sendLocation; // 砖驻 转

        function openNewOrderModal() {
            if (!currentCustomerData) {
                alert("注 驻专 拽,  转 专注...");
                return;
            }
            document.getElementById('modal-customer-name').innerText = currentCustomerData.name || ' 注';
            document.getElementById('new-order-modal').showModal();
        }
        window.openNewOrderModal = openNewOrderModal; // 砖驻 转
        
        async function submitNewOrder() {
            if (!currentCustomerData) {
                alert("砖: 驻专 拽 拽专  注.");
                return;
            }
            
            const pasteContent = document.getElementById('paste-content').value;
            const project = document.getElementById('order-project').value;
            const transportType = document.getElementById('order-transport-type').value;

            if (!pasteContent && !project) {
                alert("  转   砖 驻专拽.");
                return;
            }

            // --- [砖专] ---
            // 砖祝 转 转  转  转
            //  砖 转  砖 转 拽 转转
            const newOrder = {
                customer: currentCustomerData, // 注转拽转 拽 拽 拽
                customer_name: currentOrderData.customer_name,
                customer_id: currentOrderData.customer_id,
                customer_phone: currentOrderData.customer_phone,
                customer_address: currentOrderData.customer_address, // 砖砖 转转 砖  转
                latitude: currentOrderData.latitude || null,
                longitude: currentOrderData.longitude || null,
                
                notes: `---  砖 拽 ---\n驻专拽: ${project}\n转: ${pasteContent}`,
                deliveryType: transportType,
                orderDate: new Date().toISOString().split('T')[0], // 转专 砖 
                orderTime: new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }),
                status: "砖",
                createdBy: "customer", // 爪 砖拽 爪专
                createdAt: serverTimestamp(),
                lastModified: serverTimestamp(),
                order_id: `AUTO-${Date.now().toString().slice(-6)}` // 爪专转  
            };

            try {
                const docRef = await addDoc(collection(db, "orders"), newOrder);
                SmartLog.info("Customer created new order", { newOrderId: docRef.id });
                document.getElementById('new-order-modal').close();
                alert(" 砖 砖 爪 !");
                
                // 驻注转 砖转祝 住驻
                shareToWhatsApp(newOrder);

            } catch (error) {
                SmartLog.error(error, { context: "Failed to create new order" });
                alert("砖 爪专转 .");
            }
        }
        window.submitNewOrder = submitNewOrder; // 砖驻 转
        
        function shareToWhatsApp(orderData) {
            const phone = "972508860896";
            const text = `
*  砖 拽 (驻拽爪):*
-----------------------------
*砖:* ${orderData.customer_name || ' 爪'}
*驻:* ${orderData.customer_phone || ' 爪'}
*转转:* ${orderData.customer_address || ' 爪'}
*转专:* ${orderData.orderDate || ' 爪'}
-----------------------------

*转 :*
${orderData.notes}
---
*住 :* ${orderData.deliveryType || ' 爪'}
            `;
            const url = `https://api.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }
        
        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            startTracking();
            // 专 转 专注 -select 砖 住 
            document.getElementById('order-transport-type').addEventListener('change', (e) => {
                const branchInfo = document.getElementById('branch-info');
                if (e.target.value === '住祝 注爪') {
                    branchInfo.classList.remove('hidden');
                } else {
                    branchInfo.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
