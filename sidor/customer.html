<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>注拽  - v37 (WhatsApp UI)</title>
    <!-- 
      DeliveryMaster Customer App v37 (WhatsApp UI + Bot)
      
      Changelog:
      - [NEW v37] 砖专 UI   驻拽爪:
        - 住驻转 住专  转转 (注拽, 爪',  砖).
        - 驻爪 住 -2 转爪转: #view-tracker - #view-chat.
        - `showView()`  转 注专  转爪转.
      - [NEW v37] 爪 爪' 住 :
        - 转爪转 `#view-chat` 爪 砖拽 爪' 注.
        - 转转 爪' (`chat-history`) 转 转 住.
      - [NEW v37] 爪'- (专转 驻转):
        - `listenToMessages` 拽  砖 专拽.
        -  , 住祝 转 注转 "" 专砖转 拽.
      - [FIX v36.2] 转拽 Race Condition -`startTracking`.
    -->

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- LeafletJS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- Google Font: Rubik -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Rubik', sans-serif;
            background-color: #f4f7f6;
            /* [NEW v37] Allow content to scroll behind bottom nav */
            padding-bottom: 80px; 
        }
        
        /* [NEW v37] Full-screen views */
        .app-view {
            display: none; /* Hidden by default */
        }
        .app-view.active {
            display: block; /* Shown when active */
        }
        
        #map {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            background-color: #eee;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Status Tracker */
        .status-tracker { display: flex; justify-content: space-between; align-items: flex-start; position: relative; margin-bottom: 2.5rem; }
        .status-tracker::before { content: ''; position: absolute; top: 16px; right: 0; left: 0; height: 4px; background-color: #e5e7eb; z-index: 1; }
        .status-tracker-progress { position: absolute; top: 16px; right: 0; height: 4px; background-color: #3b82f6; z-index: 2; width: 0%; transition: width 0.5s ease; }
        .status-step { display: flex; flex-direction: column; align-items: center; text-align: center; width: 60px; z-index: 3; }
        .status-dot { width: 36px; height: 36px; border-radius: 50%; background-color: #e5e7eb; border: 4px solid #f4f7f6; color: #9ca3af; display: flex; align-items: center; justify-content: center; font-weight: 700; transition: all 0.3s ease; }
        .status-label { font-size: 0.75rem; font-weight: 500; color: #9ca3af; margin-top: 0.5rem; line-height: 1.2; }
        .status-step.completed .status-dot { background-color: #3b82f6; color: white; border-color: #dbeafe; }
        .status-step.completed .status-label { color: #1f2937; }
        .status-step.active .status-dot { background-color: white; border-color: #3b82f6; color: #3b82f6; transform: scale(1.1); }
        .status-step.active .status-label { color: #3b82f6; font-weight: 700; }
        
        /* 住转 砖 爪' */
        .chat-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            word-wrap: break-word;
        }
        .chat-bubble-admin { /* 注  */
            background-color: #e2e8f0; /* gray-200 */
            color: #1e293b; /* gray-800 */
            border-bottom-left-radius: 0.25rem;
            align-self: flex-start;
        }
        /* [NEW v37] Bot message */
        .chat-bubble-bot {
            background-color: #f1f5f9; /* gray-100 */
            color: #475569; /* gray-600 */
            border: 1px solid #e2e8f0; /* gray-200 */
            border-bottom-left-radius: 0.25rem;
            align-self: flex-start;
            font-style: italic;
        }
        .chat-bubble-customer { /* 注 拽 */
            background-color: #2563eb; /* blue-600 */
            color: white;
            border-bottom-right-radius: 0.25rem;
            align-self: flex-end;
        }
        .chat-timestamp {
            font-size: 0.7rem;
            color: #9ca3af; /* gray-400 */
            margin-top: 0.25rem;
        }
        .chat-bubble-customer .chat-timestamp {
             color: #dbeafe; /* blue-100 */
        }
        
        .chat-bubble a {
            font-weight: 600;
            text-decoration: underline;
        }
        .chat-bubble-customer a { color: white; }
        .chat-bubble-admin a { color: #1d4ed8; } /* blue-700 */

        /* 住  */
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        
        /* [NEW v37] Bottom Navigation */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background-color: white;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }
        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            color: #6b7280; /* gray-500 */
            background-color: transparent;
            border: none;
            padding: 0.5rem 0;
            font-size: 0.75rem;
            font-weight: 500;
            transition: color 0.2s;
        }
        .nav-button svg {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }
        .nav-button.active {
            color: #3b82f6; /* blue-500 */
        }
        
        /* [NEW v37] Full-screen chat layout */
        #view-chat {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 70px; /* Leave space for bottom nav */
            display: flex;
            flex-direction: column;
            background-color: #f4f7f6;
        }
        #chat-header-bar {
            flex-shrink: 0;
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem;
            text-align: center;
        }
        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        #chat-input-bar {
            flex-shrink: 0;
            background-color: white;
            padding: 0.75rem;
            border-top: 1px solid #e5e7eb;
        }
        
    </style>
</head>
<body class="bg-gray-100">

    <!-- [NEW]  专  -->
    <dialog id="welcome-modal" class="p-0 rounded-lg shadow-xl w-11/12 max-w-lg">
        <div class="sticky top-0 bg-white p-4 border-b flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-800">专  注专转 注拽!</h2>
            <button onclick="document.getElementById('welcome-modal').close()" class="text-gray-500 hover:text-gray-800">
                <i data-feather="x"></i>
            </button>
        </div>
        <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
            <p class="text-lg text-gray-700">砖 <strong id="welcome-customer-name"></strong>,  专 拽专 砖 砖 转.</p>
            
            <div class="space-y-3">
                <div class="flex items-start gap-3">
                    <i data-feather="eye" class="w-6 h-6 text-blue-500 flex-shrink-0 mt-1"></i>
                    <div>
                        <h4 class="font-semibold text-gray-800">爪驻 住住 </h4>
                        <p class="text-gray-600 text-sm">转 专转  专注 转 转 住住  砖 (转拽, 专, ') 转 拽  注 驻  转.</p>
                    </div>
                </div>
                
                <div class="flex items-start gap-3">
                    <i data-feather="message-circle" class="w-6 h-6 text-blue-500 flex-shrink-0 mt-1"></i>
                    <div>
                        <h4 class="font-semibold text-gray-800">转拽砖专转 砖专</h4>
                        <p class="text-gray-600 text-sm">转转转 注 转爪 转转 爪'. 转 砖 注转, 转转,  砖转祝 拽 拽 砖专转  砖.</p>
                    </div>
                </div>

                <div class="flex items-start gap-3">
                    <i data-feather="plus-circle" class="w-6 h-6 text-blue-500 flex-shrink-0 mt-1"></i>
                    <div>
                        <h4 class="font-semibold text-gray-800">爪专转  砖</h4>
                        <p class="text-gray-600 text-sm">爪专 爪 住祝? 抓 注 驻转专 驻住 (+)  驻  驻转 驻住 专 爪专  砖 拽转.</p>
                    </div>
                </div>
            </div>
            
        </div>
        <div class="p-4 bg-gray-50 border-t flex justify-end">
            <button type="button" onclick="document.getElementById('welcome-modal').close()" class="py-2 px-6 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700">
                转, 转!
            </button>
        </div>
    </dialog>

    <!--   砖 -->
    <dialog id="new-order-modal" class="p-0 rounded-lg shadow-xl w-11/12 max-w-2xl">
        <div class="sticky top-0 bg-white p-4 border-b flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-800">爪专转  砖</h2>
            <button onclick="document.getElementById('new-order-modal').close()" class="text-gray-500 hover:text-gray-800">
                <i data-feather="x"></i>
            </button>
        </div>
        <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
            <p class="text-sm text-gray-600">驻专 拽 砖 (<span id="modal-customer-name" class="font-semibold"></span>) 爪专驻 转  .</p>
            
            <div>
                <label for="paste-content" class="block text-sm font-medium text-gray-700">拽 转  ( 拽 驻专)</label>
                <textarea id="paste-content" rows="5" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder=": 10 拽 20, 5 ..."></textarea>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- [NEW v34.7] Smart Project Selector -->
                <div>
                    <label for="order-project-select" class="block text-sm font-medium text-gray-700">专 驻专拽 ( 爪专 砖)</label>
                    <select id="order-project-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="handleProjectSelect(this.value)">
                        <option value="">-- 注 驻专拽 --</option>
                    </select>
                </div>
                <div id="order-project-new-wrapper" class="hidden"> <!-- [NEW] Changed to hidden -->
                    <label for="order-project-new" class="block text-sm font-medium text-gray-700">砖 驻专拽 砖</label>
                    <input type="text" id="order-project-new" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="拽 砖 驻专拽 砖">
                </div>

                <div>
                    <label for="order-transport-type" class="block text-sm font-medium text-gray-700">住 </label>
                    <select id="order-transport-type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">专 住 </option>
                        <option value="转 祝">转 祝</option>
                        <option value="转 砖转">转 砖转</option>
                        <option value="住祝 注爪">住祝 注爪</option>
                        <option value="注转 祝">注转 祝</option>
                        <option value="爪转 ">爪转 </option>
                        <option value="驻转 ">驻转 </option>
                        <option value="爪转 ">爪转 </option>
                        <option value="驻专拽 转">驻专拽 转</option>
                    </select>
                </div>
            </div>
            
            <div>
                <label for="order-location" class="block text-sm font-medium text-gray-700">拽 / 转转</label>
                <input type="text" id="order-location" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder=" 转转  砖专 专拽 砖砖 转转 拽转">
            </div>

            <!-- 驻专 住祝 注爪 (住转专 专专转 ) -->
            <div id="branch-info" class="hidden space-y-3 p-4 bg-gray-50 rounded-lg border">
                <h4 class="font-semibold text-gray-800">驻专 住驻 住祝 注爪</h4>
                <div class="text-sm">
                    <p><strong>住祝 转:</strong> 转 6,  砖专 | <a href="tel:09-7602010" class="text-blue-600">09-7602010</a></p>
                    <p><strong>住祝 专砖:</strong> 专砖 10,  砖专 | <a href="tel:09-7402575" class="text-blue-600">09-7402575</a></p>
                </div>
            </div>

        </div>
        <div class="p-4 bg-gray-50 border-t flex justify-end gap-3">
            <button type="button" class_alias="secondary" onclick="document.getElementById('new-order-modal').close()" class="py-2 px-4 bg-white border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">
                
            </button>
            <button type="button" id="submit-order-btn" onclick="submitNewOrder()" class="py-2 px-4 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700">
                砖 
            </button>
        </div>
    </dialog>


    <div class="container mx-auto max-w-lg p-4">
        
        <!-- [NEW v37] Header (注专 砖转 转爪转) -->
        <header class="text-center my-6 flex flex-col items-center">
            <img src="https://i.postimg.cc/ryPT3r29/image.png" alt="Company Logo" class="w-20 h-20 mx-auto mb-4 rounded-lg shadow-sm">
            <h1 id="main-header" class="text-3xl font-bold text-gray-800">注拽 砖</h1>
            <p id="order-id-display" class="text-gray-600">注 驻专 ...</p>
        </header>

        <!-- Loader -->
        <div id="loader" class="text-center py-10">
            <div class="loader"></div>
            <p class="text-gray-600">转专 转  砖...</p>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden text-center py-10">
            <i data-feather="alert-triangle" class="w-12 h-12 mx-auto text-red-500"></i>
            <p class="text-red-600 mt-4" id="error-text">砖 注转 转.</p>
        </div>

        <!-- [NEW v37] Main Content Area -->
        <div id="main-content-area" class="hidden">
        
            <!-- [NEW v37] View 1: Tracker -->
            <main id="view-tracker" class="app-view active bg-white p-6 rounded-lg shadow-lg space-y-6">
                <div>
                    <!-- [NEW v34.6] Dynamic Greeting -->
                    <h2 id="dynamic-greeting" class="text-2xl font-bold text-gray-800 mb-2"></h2>
                    <p class="text-gray-600 text-lg"> 砖 住住:</p>
                    
                    <!-- Status Tracker -->
                    <div class="status-tracker mt-6">
                        <div class="status-tracker-progress" id="status-progress-bar"></div>
                        <div class="status-step" id="step-new">
                            <div class="status-dot"><i data-feather="check"></i></div>
                            <div class="status-label">转拽</div>
                        </div>
                        <div class="status-step" id="step-assigned">
                            <div class="status-dot"><i data-feather="user-check"></i></div>
                            <div class="status-label">砖 </div>
                        </div>
                        <div class="status-step" id="step-onway">
                            <div class="status-dot"><i data-feather="truck"></i></div>
                            <div class="status-label">专 </div>
                        </div>
                        <div class="status-step" id="step-completed">
                            <div class="status-dot"><i data-feather="flag"></i></div>
                            <div class="status-label">砖</div>
                        </div>
                    </div>
                </div>
                
                <!-- Map -->
                <div id="map-container" class="hidden">
                    <h3 class="font-semibold mb-3 text-lg">注拽 </h3>
                    <div id="map"></div>
                </div>

                <!-- Driver Details -->
                <div id="driver-details" class="bg-gray-50 p-4 rounded-lg flex items-center space-x-4 space-x-reverse hidden">
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i data-feather="truck" class="w-6 h-6 text-blue-600"></i>
                    </div>
                    <div>
                        <p class="font-semibold"> 砖: <span id="driver-name"></span></p>
                        <a href="#" id="driver-phone-link" class="text-blue-600 text-sm font-medium">
                            <i data-feather="phone" class="w-4 h-4 inline-block ml-1"></i>
                            <span id="driver-phone"></span>
                        </a>
                    </div>
                </div>
                
                <!-- Order Notes -->
                <div id="notes-container" class="hidden">
                    <h3 class="font-semibold mb-2 text-lg">注专转 砖</h3>
                    <p id="order-notes" class="text-gray-700 bg-gray-50 p-3 rounded-md"></p>
                </div>
            </main>
            
            <!-- [NEW v37] View 2: Chat (Full Screen) -->
            <main id="view-chat" class="app-view">
                <!-- Chat History -->
                <div id="chat-history" class="h-80 bg-gray-100 rounded-lg p-3 overflow-y-auto flex flex-col space-y-2 border">
                    <!-- 注转 爪' 驻注  -->
                    <p class="text-gray-500 text-sm text-center">注 住专转 注转...</p>
                </div>
                
                <!-- Chat Input Bar -->
                <div id="chat-input-bar" class="mt-3">
                    <div class="flex gap-2">
                        <!-- File Upload Button -->
                        <input type="file" id="file-upload" accept="image/*,application/pdf" class="hidden">
                        <button onclick="document.getElementById('file-upload').click()" class="bg-gray-300 text-gray-700 p-3 rounded-lg shadow hover:bg-gray-400">
                            <i data-feather="paperclip"></i>
                        </button>
                        
                        <input type="text" id="chat-message" class="flex-grow p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="转 注 ...">
                        
                        <button onclick="sendCustomerMessage()" class="bg-blue-600 text-white p-3 rounded-lg shadow hover:bg-blue-700">
                            <i data-feather="send"></i>
                        </button>
                    </div>
                    
                    <!-- Upload Status -->
                    <div id="upload-status" class="text-sm text-gray-600 text-center mt-2 hidden">
                        <div class="loader" style="width: 20px; height: 20px; border-width: 2px; display: inline-block; margin-left: 8px;"></div>
                        注 拽抓...
                    </div>
                    
                    <button onclick="sendLocation()" class="mt-2 w-full text-sm bg-green-600 text-white p-2 rounded-lg shadow hover:bg-green-700 flex items-center justify-center gap-2">
                        <i data-feather="map-pin" class="w-4 h-4"></i>
                        砖 拽 拽
                    </button>
                </div>
            </main>
            
        </div> <!-- End of main-content-area -->

        <footer class="text-center mt-6 text-gray-500 text-sm">
            <p>&copy; 2024 DeliveryMaster</p>
        </footer>

    </div>
    
    <!-- [NEW] Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-[5000]"></div>
    
    <!-- [NEW v37] Bottom Navigation Bar -->
    <nav id="bottom-nav">
        <button id="nav-tracker" class="nav-button active" onclick="showView('tracker')">
            <i data-feather="truck"></i>
            <span>注拽</span>
        </button>
        <button id="nav-chat" class="nav-button" onclick="showView('chat')">
            <i data-feather="message-circle"></i>
            <span>爪'</span>
        </button>
        <button id="nav-new-order" class="nav-button" onclick="openNewOrderModal()">
            <i data-feather="plus-circle"></i>
            <span> 砖</span>
        </button>
    </nav>


    <!-- Firebase SDKs -->
    <script type="module">
        // --- Inlined Firebase SDK Imports ---
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, query, orderBy, addDoc, updateDoc, serverTimestamp, deleteDoc, arrayUnion, where, getDocs, getDoc, limit } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        // --- Inlined Config Logic ---
        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", authDomain: "saban94-78949.firebaseapp.com", projectId: "saban94-78949",
          storageBucket: "saban94-78949.firebasestorage.app", // [FIX v34.9] Corrected bucket name
          messagingSenderId: "41553157903", appId: "1:41553157903:web:cc33d252cff023be97a87a", measurementId: "G-XV6RZDESSB"
        };
        let app, auth, db; 
        let initializationError = null;
        try {
            app = getApps().length ? getApp() : initializeApp(firebaseConfig);
            auth = getAuth(app); 
            db = getFirestore(app);
        } catch (error) { console.error("CRITICAL: Firebase init failed!", error); initializationError = error; }

        const MAX_AUTH_RETRIES = 3; const RETRY_DELAY_MS = 3000;
        async function ensureAuth() {
            console.log("ensureAuth: Starting..."); let tries = 0;
            while (tries < MAX_AUTH_RETRIES) {
                tries++;
                try {
                    if (initializationError) throw new Error(`Init failed: ${initializationError.message}`);
                    if (!auth) throw new Error("Auth object missing");
                    const userCredential = await signInAnonymously(auth);
                    console.log("ensureAuth: Success.", userCredential.user.uid); return userCredential.user;
                } catch (e) {
                    console.warn(`[FirebaseAuth] Attempt ${tries} failed:`, e.code, e.message);
                    if (tries >= MAX_AUTH_RETRIES) { console.error("ensureAuth: All attempts failed."); throw e; }
                    await new Promise(r => setTimeout(r, RETRY_DELAY_MS));
                }
            } throw new Error("ensureAuth: Max retries reached.");
        }
        const authReadyPromise = ensureAuth();
        
        // --- SmartLog (Minimal) ---
        const SmartLog = {
            info: (msg, ctx) => console.log("[INFO]", msg, ctx || ''),
            warn: (msg, ctx) => console.warn("[WARN]", msg, ctx || ''),
            error: (err, ctx) => console.error("[ERROR]", err, ctx || '')
        };

        // --- Map & State ---
        let map;
        let driverMarker;
        let orderMarker;
        let orderListenerUnsubscribe = null;
        let locationListenerUnsubscribe = null;
        let messagesListenerUnsubscribe = null;
        let currentOrderId = null;
        let currentCustomerData = null; 
        let currentFirestoreDocId = null; 
        let customerProjects = []; 
        
        // [NEW v36] Google Apps Script Web App URL
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby7qKICvRYStFkcDPLtGhGPaNqyYt-G8dZqBJfGm7vpmOG6Kf_n3f29V8oyUW9PjBUj7A/exec"; 

        // --- Icons ---
        const driverIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41]
        });
        const orderIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41]
        });

        // --- UI Functions ---
        function showLoader(show) { document.getElementById('loader').style.display = show ? 'block' : 'none'; }
        function showError(message) {
            showLoader(false);
            document.getElementById('main-content-area').style.display = 'none';
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-text').innerText = message || '专注 砖.';
        }
        function showContent() {
            showLoader(false);
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('main-content-area').style.display = 'block'; // [FIX v37] Show main area
            feather.replace();
        }
        
        // [NEW v37] View Management
        function showView(viewName) {
            // Hide all views
            document.getElementById('view-tracker').classList.remove('active');
            document.getElementById('view-chat').classList.remove('active');
            
            // Deactivate all buttons
            document.getElementById('nav-tracker').classList.remove('active');
            document.getElementById('nav-chat').classList.remove('active');
            
            // Show the selected view
            if (viewName === 'tracker') {
                document.getElementById('view-tracker').classList.add('active');
                document.getElementById('nav-tracker').classList.add('active');
                document.getElementById('main-header').innerText = '注拽 砖';
                // Refresh map layout
                if (map) setTimeout(() => map.invalidateSize(), 10);
            } else if (viewName === 'chat') {
                document.getElementById('view-chat').classList.add('active');
                document.getElementById('nav-chat').classList.add('active');
                document.getElementById('main-header').innerText = '砖 注 砖专';
            }
        }
        window.showView = showView; // Expose to global

        // --- Map Functions ---
        function initializeMap(orderLatLng) {
            try {
                if (map) map.remove(); 
                map = L.map('map');
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OSM' }).addTo(map);
                const bounds = L.latLngBounds();
                if (orderLatLng) {
                    orderMarker = L.marker(orderLatLng, { icon: orderIcon }).addTo(map).bindPopup("转转 住驻拽");
                    bounds.extend(orderLatLng);
                }
                if (bounds.isValid()) { map.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 }); } 
                else { map.setView([32.0853, 34.7818], 9); }
            } catch (error) {
                SmartLog.error(error, { context: "Error initializing map" });
                document.getElementById('map').innerHTML = "砖 注转 驻.";
            }
        }
        
        function updateMap(orderLatLng, driverLatLng) {
            if (!map) return;
            const bounds = L.latLngBounds();
            if (orderLatLng) {
                if (orderMarker) { orderMarker.setLatLng(orderLatLng); } 
                else { orderMarker = L.marker(orderLatLng, { icon: orderIcon }).addTo(map).bindPopup("转转 住驻拽"); }
                bounds.extend(orderLatLng);
            }
            if (driverLatLng) {
                document.getElementById('map-container').classList.remove('hidden');
                if (driverMarker) { driverMarker.setLatLng(driverLatLng); } 
                else { driverMarker = L.marker(driverLatLng, { icon: driverIcon }).addTo(map).bindPopup("拽 "); }
                bounds.extend(driverLatLng);
            } else {
                if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }
            }
            if (bounds.isValid()) { setTimeout(() => map.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 }), 50); }
        }
        
        // --- Status Tracker UI ---
        function updateStatusTracker(status) {
            const steps = { '砖': 0, '砖': 1, '专': 2, '砖': 3, '': -1 };
            const stepIndex = steps[status] ?? 0;
            if (stepIndex === -1) { /* ... handle cancelled ... */ return; }
            const progressPercentage = (stepIndex / 3) * 100;
            document.getElementById('status-progress-bar').style.width = `${progressPercentage}%`;
            document.getElementById('step-new').classList.toggle('completed', stepIndex >= 0);
            document.getElementById('step-assigned').classList.toggle('completed', stepIndex >= 1);
            document.getElementById('step-onway').classList.toggle('completed', stepIndex >= 2);
            document.getElementById('step-completed').classList.toggle('completed', stepIndex >= 3);
            document.querySelectorAll('.status-step').forEach(step => step.classList.remove('active'));
            if (stepIndex === 0) document.getElementById('step-new').classList.add('active');
            if (stepIndex === 1) document.getElementById('step-assigned').classList.add('active');
            if (stepIndex === 2) document.getElementById('step-onway').classList.add('active');
            if (stepIndex === 3) document.getElementById('step-completed').classList.add('active');
        }
        
        // [NEW v34.6] Dynamic Greeting
        function setDynamicGreeting(customerName) {
            const greetingEl = document.getElementById('dynamic-greeting');
            if (!greetingEl) return;

            const hour = new Date().getHours();
            let greeting = "专 ";
            if (hour >= 5 && hour < 12) {
                greeting = "拽专 ";
            } else if (hour >= 12 && hour < 18) {
                greeting = "爪专 ";
            } else if (hour >= 18 && hour < 22) {
                greeting = "注专 ";
            } else {
                greeting = " ";
            }
            
            // Get first name
            const firstName = (customerName || '拽').split(' ')[0].replace(',', ''); // Clean up name
            
            greetingEl.innerText = `${greeting}, ${firstName}!`;
        }

        // --- Main Logic ---
        function getOrderIdFromUrl() {
            try {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                if (!id) { showError("拽砖专  转拽. 住专  ."); return null; }
                return id;
            } catch (e) { SmartLog.error(e, { context: "Error reading URL params" }); showError("砖 注 拽砖专."); return null; }
        }
        
        // [FIX v36.2] Updated function
        async function startTracking() {
            currentOrderId = getOrderIdFromUrl(); // This could be '6209643' OR '8RJXj3...'
            if (!currentOrderId) return;
            
            try {
                await authReadyPromise; 
                SmartLog.info("Auth ready, starting to track order.", { orderId: currentOrderId });
                
                let orderDoc;
                let found = false;

                // --- [FIX] Strategy 1: Try finding by Document ID first (old links)
                try {
                    const docRef = doc(db, "orders", currentOrderId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        orderDoc = docSnap;
                        found = true;
                        currentFirestoreDocId = docSnap.id;
                        SmartLog.info(`Found order by Document ID: ${currentFirestoreDocId}`, {});
                    }
                } catch (e) {
                    SmartLog.warn("Not a valid Document ID, trying by order_id field...", { id: currentOrderId });
                }

                // --- [FIX] Strategy 2: Try finding by 'order_id' field (new links)
                if (!found) {
                    const ordersRef = collection(db, "orders");
                    const q = query(ordersRef, where("order_id", "==", currentOrderId), limit(1));
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        orderDoc = querySnapshot.docs[0];
                        found = true;
                        currentFirestoreDocId = orderDoc.id;
                        SmartLog.info(`Found order by order_id field: ${currentFirestoreDocId}`, {});
                    }
                }
                
                if (!found) {
                    showError("  爪.  拽 转 拽砖专.");
                    SmartLog.error(new Error("Order not found"), { id_searched: currentOrderId });
                    return;
                }
                
                // [FIX v36.2] Moved all logic *inside* the listener
                
                // Now listen to the specific document using its real ID
                const orderRef = doc(db, "orders", currentFirestoreDocId);
                orderListenerUnsubscribe = onSnapshot(orderRef, async (docSnap) => {
                    if (!docSnap.exists()) {
                         showError(" 拽  砖 拽转.");
                         return;
                    }
                    
                    const newOrderData = docSnap.data();
                    orderListenerUnsubscribe.snapshot = docSnap; // Attach snapshot for easy access

                    // --- [FIX v36.2] All customer logic is now INSIDE the listener ---
                    const customerInOrder = newOrderData.customer;
                    const customerId = customerInOrder ? customerInOrder.id : null;
                    const customerName = customerInOrder ? customerInOrder.name : null;
                    
                    if (customerId && (!customerName || customerName === 'N/A' || customerName === '拽  注')) {
                        SmartLog.warn("Customer data is partial. Fetching full profile.", { customerId: customerId });
                        try {
                            const customerRef = doc(db, "customers", customerId);
                            const customerSnap = await getDoc(customerRef);
                            if (customerSnap.exists()) {
                                currentCustomerData = { id: customerSnap.id, ...customerSnap.data() }; // Get the full, correct data
                                SmartLog.info("Full customer profile fetched.", currentCustomerData);
                            } else {
                                currentCustomerData = customerInOrder; // Fallback
                            }
                        } catch (e) {
                            SmartLog.error(e, "Failed to fetch full customer profile");
                            currentCustomerData = customerInOrder; // Fallback
                        }
                    } else if (customerInOrder && customerId) {
                        currentCustomerData = customerInOrder; // Data seems fine
                    } else {
                        SmartLog.error(new Error("No customer object or ID found on order"), { orderId: currentFirestoreDocId });
                        // [CRITICAL FIX] Provide a fallback object to prevent crash
                        currentCustomerData = { id: null, name: "拽  " }; 
                    }
                    // --- END CUSTOMER LOGIC ---

                    // --- [FIX v36.2] Fetch projects *after* customer is set ---
                    if (currentCustomerData && currentCustomerData.id && customerProjects.length === 0) { // Only fetch once
                        try {
                            const projectsQuery = query(
                                collection(db, "orders"), 
                                where("customer.id", "==", currentCustomerData.id),
                                orderBy("createdAt", "desc"),
                                limit(20) // Get last 20 orders
                            );
                            const projectsSnap = await getDocs(projectsQuery);
                            const projectSet = new Set();
                            projectsSnap.forEach(doc => { 
                                if (doc.data().projectName) {
                                    // Handle both string and array
                                    if(Array.isArray(doc.data().projectName)) {
                                        doc.data().projectName.forEach(p => projectSet.add(p));
                                    } else {
                                        projectSet.add(doc.data().projectName);
                                    }
                                } 
                            });
                            customerProjects = Array.from(projectSet);
                            SmartLog.info("Fetched customer projects", { projects: customerProjects });
                        } catch (e) {
                             SmartLog.error(e, "Failed to fetch project history");
                        }
                    }
                    // --- END PROJECT LOGIC ---

                    // --- [FIX v36.2] Welcome modal logic ---
                    const messagesColRef = collection(db, "orders", currentFirestoreDocId, "messages");
                    const messagesQuery = query(messagesColRef, limit(1));
                    const messagesSnapshot = await getDocs(messagesQuery);
                    
                    if (messagesSnapshot.empty && currentCustomerData && currentCustomerData.id) { // Only show if customer is valid
                        const customerName = currentCustomerData.name || '拽 拽专';
                        document.getElementById('welcome-customer-name').innerText = customerName;
                        document.getElementById('welcome-modal').showModal();
                        feather.replace(); 
                    }
                    // --- End Welcome Modal Logic ---
                    
                    renderOrderData(newOrderData); 
                    
                    const driverId = newOrderData.driver?.id;
                    if (driverId && (newOrderData.status === '砖' || newOrderData.status === '专')) {
                        listenToDriverLocation(driverId, newOrderData);
                    } else {
                        if (locationListenerUnsubscribe) { locationListenerUnsubscribe(); locationListenerUnsubscribe = null; }
                        if (newOrderData.latitude && newOrderData.longitude) {
                            updateMap([newOrderData.latitude, newOrderData.longitude], null);
                        }
                    }
                    
                    listenToMessages(currentFirestoreDocId); // Use the real document ID

                }, (error) => {
                    SmartLog.error(error, { context: "Error in order listener" });
                    showError("砖 拽转 转 .");
                });

            } catch (error) {
                SmartLog.error(error, { context: "Failed auth or initial query" });
                showError("砖转 转专转. 住 专注.");
            }
        }
        
        function listenToDriverLocation(driverId, orderData) {
            if (locationListenerUnsubscribe) { locationListenerUnsubscribe(); locationListenerUnsubscribe = null; }
            SmartLog.info("Listening to driver location...", { driverId });
            const locationRef = doc(db, "driverLocations", driverId);
            locationListenerUnsubscribe = onSnapshot(locationRef, (docSnap) => {
                 const orderLatLng = (orderData.latitude && orderData.longitude) ? [orderData.latitude, orderData.longitude] : null;
                 if (docSnap.exists() && orderData.status === '专') {
                     const locData = docSnap.data();
                     const driverLatLng = [locData.latitude, locData.longitude];
                     updateMap(orderLatLng, driverLatLng);
                 } else {
                     updateMap(orderLatLng, null);
                 }
            }, (error) => {
                SmartLog.error(error, { context: "Error in location listener", driverId });
                const orderLatLng = (orderData.latitude && orderData.longitude) ? [orderData.latitude, orderData.longitude] : null;
                updateMap(orderLatLng, null);
            });
        }
        
        function renderOrderData(order) {
            const displayId = order.orderNumber || order.order_id || `#${currentOrderId.slice(-6)}`;
            document.getElementById('order-id-display').innerText = ` ${displayId}`;
            
            // [FIX v34.8] Check currentCustomerData before accessing name
            setDynamicGreeting(currentCustomerData ? currentCustomerData.name : '拽');
            
            updateStatusTracker(order.status);
            
            const driverDetailsEl = document.getElementById('driver-details');
            const notesContainerEl = document.getElementById('notes-container');
            
            if (order.driver?.name && (order.status === '砖' || order.status === '专')) {
                document.getElementById('driver-name').innerText = order.driver.name;
                const phone = order.driver.phone || ' '; 
                document.getElementById('driver-phone').innerText = phone;
                document.getElementById('driver-phone-link').href = `tel:${phone}`;
                driverDetailsEl.classList.remove('hidden');
                driverDetailsEl.classList.add('flex');
            } else {
                driverDetailsEl.classList.add('hidden');
                driverDetailsEl.classList.remove('flex');
            }

            if (order.notes) {
                document.getElementById('order-notes').innerText = order.notes;
                notesContainerEl.classList.remove('hidden');
            } else {
                notesContainerEl.classList.add('hidden');
            }
            
            const orderLatLng = (order.latitude && order.longitude) ? [order.latitude, order.longitude] : null;
            if (!map && orderLatLng) { 
                 document.getElementById('map-container').classList.remove('hidden');
                 initializeMap(orderLatLng);
            }
            
            showContent();
        }

        // --- 驻拽爪转 砖转 (爪'  砖) ---
        
        /**
         * @param {string} firestoreDocId The actual Firestore Document ID
         */
        function listenToMessages(firestoreDocId) {
            if (messagesListenerUnsubscribe) messagesListenerUnsubscribe();
            
            const chatHistoryEl = document.getElementById('chat-history');
            const q = query(
                collection(db, "orders", firestoreDocId, "messages"),
                orderBy("timestamp", "asc")
            );

            messagesListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                chatHistoryEl.innerHTML = '';
                
                // [NEW v37] Bot Welcome Message
                if (snapshot.empty && currentCustomerData && currentCustomerData.id) {
                    const firstName = (currentCustomerData.name || '拽').split(' ')[0];
                    const botMsg = {
                        sender: "bot",
                        text: `砖 ${firstName},  注专转 转. 拽 转 驻转  驻  拽.  转 砖 注转, 拽爪,  拽.`,
                        timestamp: Timestamp.now()
                    };
                    chatHistoryEl.appendChild(createMessageBubble(botMsg));
                }
                
                if (snapshot.empty) {
                    // (注 注 专 住 转 )
                } else {
                    snapshot.forEach(doc => {
                        chatHistoryEl.appendChild(createMessageBubble(doc.data()));
                    });
                }
                
                chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
            }, (error) => {
                SmartLog.error(error, { context: "Failed to listen to messages" });
                chatHistoryEl.innerHTML = '<p class="text-red-500 text-sm text-center">砖 注转 注转</p>';
            });
        }
        
        // [NEW v37]
        function createMessageBubble(msg) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex flex-col';
            let bubbleClass = '';
            let senderName = '';
            
            if (msg.type === 'message_to_admin') {
                bubbleClass = 'chat-bubble chat-bubble-customer';
                senderName = msg.senderName || '';
                wrapper.classList.add('items-end'); // [FIX v37] Customer messages on right
            } else if (msg.type === 'notification_to_customer') {
                bubbleClass = 'chat-bubble chat-bubble-admin';
                senderName = msg.senderName || '';
                wrapper.classList.add('items-start');
            } else if (msg.sender === 'bot') { 
                bubbleClass = 'chat-bubble chat-bubble-bot';
                senderName = '  砖专转';
                wrapper.classList.add('items-start');
            } else {
                 return wrapper; // Don't render unknown types
            }
            
            const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '';
            
            let msgText = msg.text || '';
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            if (urlRegex.test(msgText)) {
                msgText = msgText.replace(urlRegex, (url) => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url.includes('drive.google') ? '驻转 拽抓 爪专祝' : '驻转 拽砖专'}</a>`);
            }

            wrapper.innerHTML = `
                <div class="${bubbleClass}">
                    <strong class="block font-semibold">${senderName}</strong>
                    <p class="mt-1">${msgText}</p>
                    <span class="chat-timestamp text-right mt-2">${time}</span>
                </div>
            `;
            return wrapper;
        }
        
        async function sendCustomerMessage(messageText) {
            const text = messageText || document.getElementById('chat-message').value.trim();
            
            if (!text || !currentFirestoreDocId || !currentCustomerData) {
                 SmartLog.warn("Missing data for sending message", { text, currentFirestoreDocId, currentCustomerData });
                 return;
            }
            
            const messageData = {
                text: text,
                senderName: currentCustomerData.name || '拽',
                senderId: currentCustomerData.id, // [NEW v37]
                timestamp: serverTimestamp(),
                type: 'message_to_admin',
                readByViewer: false
            };
            
            try {
                const messagesColRef = collection(db, 'orders', currentFirestoreDocId, 'messages');
                await addDoc(messagesColRef, messageData);
                if (!messageText) {
                    document.getElementById('chat-message').value = '';
                }
                SmartLog.info("Customer message sent", { orderId: currentFirestoreDocId, text });
            } catch (error) {
                SmartLog.error(error, { context: "Failed to send customer message" });
                alert("砖 砖转 注.");
            }
        }
        window.sendCustomerMessage = sendCustomerMessage;
        
        function sendLocation() {
            if (!navigator.geolocation) {
                alert("砖转 拽  转转 驻驻 .");
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    const locationText = `砖转 转 拽 拽 砖: https://www.google.com/maps?q=${latitude},${longitude}`;
                    sendCustomerMessage(locationText);
                },
                (error) => {
                    alert(" 转  拽 转 拽.  砖专砖转 拽 驻注转.");
                    SmartLog.error(error, { context: "Geolocation failed" });
                }
            );
        }
        window.sendLocation = sendLocation;

        function openNewOrderModal() {
            // [FIX v34.7] Validate customer data before opening modal
            if (!currentCustomerData || !currentCustomerData.id || !currentCustomerData.name || currentCustomerData.name === 'N/A' || currentCustomerData.name === '拽  ') {
                alert(" 转 爪专  砖. 驻专 拽 拽砖专  驻  住专.  驻 .");
                return;
            }
            
            document.getElementById('modal-customer-name').innerText = currentCustomerData.name || ' 注';
            
            if (orderListenerUnsubscribe && orderListenerUnsubscribe.snapshot) {
                const orderData = orderListenerUnsubscribe.snapshot.data();
                if (orderData && orderData.address) {
                    document.getElementById('order-location').value = orderData.address;
                } else if (currentCustomerData.defaultAddress) {
                    document.getElementById('order-location').value = currentCustomerData.defaultAddress || currentCustomerData.default_address || '';
                }
            }

            // [NEW v34.7] Populate project dropdown
            const projectSelect = document.getElementById('order-project-select');
            projectSelect.innerHTML = '<option value="">-- 专 驻专拽 拽 --</option>';
            customerProjects.forEach(proj => {
                projectSelect.innerHTML += `<option value="${proj}">${proj}</option>`;
            });
            projectSelect.innerHTML += '<option value="--new--">** 驻专拽 砖 **</option>';
            document.getElementById('order-project-new-wrapper').style.display = 'none';
            document.getElementById('order-project-new').value = '';
            
            document.getElementById('new-order-modal').showModal();
            feather.replace(); 
        }
        window.openNewOrderModal = openNewOrderModal;
        
        // [NEW v34.7]
        function handleProjectSelect(value) {
            const newProjectWrapper = document.getElementById('order-project-new-wrapper');
            newProjectWrapper.style.display = (value === '--new--') ? 'block' : 'none';
        }
        window.handleProjectSelect = handleProjectSelect;
        
        async function submitNewOrder() {
            const btn = document.getElementById('submit-order-btn');
            btn.disabled = true;
            btn.innerText = "砖...";

            // [FIX v34.7] Validation moved to openNewOrderModal
            if (!currentCustomerData || !currentCustomerData.id) {
                 alert("砖转 注专转: 驻专 拽 .  专注.");
                 btn.disabled = false;
                 btn.innerText = "砖 ";
                 return;
            }
            
            const pasteContent = document.getElementById('paste-content').value;
            const transportType = document.getElementById('order-transport-type').value;
            const location = document.getElementById('order-location').value.trim();

            // [NEW v34.7] Get project name from smart selector
            const projectSelect = document.getElementById('order-project-select');
            let projectName;
            if (projectSelect.value === '--new--') {
                projectName = document.getElementById('order-project-new').value.trim();
                if (!projectName) {
                    alert(" 拽 砖 驻专拽 砖.");
                    btn.disabled = false;
                    btn.innerText = "砖 ";
                    return;
                }
            } else {
                projectName = projectSelect.value;
            }
            
            if (!pasteContent && !projectName) {
                alert("  转   专 驻专拽.");
                btn.disabled = false;
                btn.innerText = "砖 ";
                return;
            }
            
            const orderData = orderListenerUnsubscribe.snapshot.data();

            // [FIX v34.8] Stricter check for lat/lon
            const newOrder = {
                customer: currentCustomerData, // This is now the full, reliable customer object
                address: location || orderData.address || ' 爪 转转',
                // Only add lat/lon if they are valid numbers
                ...( (orderData.latitude !== undefined && orderData.latitude !== null) && { latitude: orderData.latitude }),
                ...( (orderData.longitude !== undefined && orderData.longitude !== null) && { longitude: orderData.longitude }),
                projectName: projectName, // [NEW v34.7]
                notes: `---  砖 拽 ---\n${pasteContent}`, // [FIX] Removed project from notes
                deliveryType: transportType,
                orderDate: new Date().toISOString().split('T')[0], 
                orderTime: new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }),
                status: "砖",
                createdBy: "customer", 
                createdAt: serverTimestamp(),
                lastModified: serverTimestamp(),
                order_id: `AUTO-${Date.now().toString().slice(-6)}`
            };

            try {
                const docRef = await addDoc(collection(db, "orders"), newOrder);
                SmartLog.info("Customer created new order", { newOrderId: docRef.id });
                document.getElementById('new-order-modal').close();
                alert(" 砖 砖 爪 !");
                
                shareToWhatsApp(newOrder); 

            } catch (error) {
                SmartLog.error(error, { context: "Failed to create new order" });
                alert("砖 爪专转 .");
            } finally {
                btn.disabled = false;
                btn.innerText = "砖 ";
            }
        }
        window.submitNewOrder = submitNewOrder;
        
        function shareToWhatsApp(orderData) {
            const phone = "972508860896";
            
            const text = `
*  砖 (驻拽爪转 拽)*
=================
*拽:* ${orderData.customer?.name || ' 爪'}
*住' 拽:* ${orderData.customer?.customerNumber || orderData.customer?.customer_id || 'N/A'}
*驻:* ${orderData.customer?.phone || 'N/A'}

*驻专拽:* ${orderData.projectName || ' 爪'}
=================
*驻专 住驻拽:*
*住 :* ${orderData.deliveryType || ' 爪'}
*拽:* ${orderData.address || ' 爪'}
*转专:* ${orderData.orderDate}
*砖注:* ${orderData.orderTime}
=================
*转 :*
${orderData.notes || "---  转 ---"}
            `;
            
            const url = `https://api.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }
        
        // [NEW v36] File Upload Logic (Switched to Apps Script)
        async function handleFileUpload(event) {
            if (WEB_APP_URL === "YOUR_APPS_SCRIPT_WEB_APP_URL_HERE" || WEB_APP_URL.includes("AKfycbzwWherCt8")) {
                alert("砖转 转爪专: 砖 注 转 转转 -Web App 专住 砖 砖拽转.");
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;

            if (!currentFirestoreDocId || !currentCustomerData || !currentCustomerData.id) {
                alert("砖:  转   拽.");
                return;
            }
            
            const uploadStatusEl = document.getElementById('upload-status');
            uploadStatusEl.innerHTML = `<div class="loader" style="width: 20px; height: 20px; border-width: 2px; display: inline-block; margin-left: 8px;"></div> 注 拽抓...`;
            uploadStatusEl.classList.remove('hidden');

            try {
                // 1. Convert file to Base64
                const base64Data = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });

                // 2. Prepare payload for Apps Script
                const payload = {
                    fileData: base64Data,
                    fileName: file.name,
                    mimeType: file.type,
                    customerId: currentCustomerData.customerNumber || currentCustomerData.id // Use customerNumber if available
                };
                
                // 3. Send to Apps Script Web App
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors', // Required for cross-domain request
                    body: JSON.stringify(payload),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // Apps Script quirk
                    }
                });

                if (!response.ok) {
                    throw new Error(`砖转 砖专转: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.success && result.url) {
                    // 4. Send the new Google Drive URL as a chat message
                    await sendCustomerMessage(result.url);
                    SmartLog.info("File uploaded to Drive and link sent", { url: result.url, name: result.name });
                    showToast("拽抓 砖 爪!", "success");
                    uploadStatusEl.classList.add('hidden');
                    
                    // 5. [NEW v36] Open WhatsApp share link
                    if (result.waUrl) {
                        window.open(result.waUrl, '_blank');
                    }
                    
                } else {
                    throw new Error(result.error || "砖  注 砖专转");
                }

            } catch (error) {
                SmartLog.error(error, { context: "File Upload Failed (Apps Script)" });
                uploadStatusEl.innerText = `砖 注转 拽抓: ${error.message}`;
                // Hide error message after 3 seconds
                setTimeout(() => uploadStatusEl.classList.add('hidden'), 3000);
            } finally {
                // Reset file input to allow uploading the same file again
                event.target.value = null;
            }
        }
        
        // [NEW] Toast Notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            let bgColor = (type === 'success') ? 'bg-green-500' : (type === 'error') ? 'bg-red-500' : 'bg-blue-500';
            
            toast.className = `p-3 rounded-lg shadow-lg text-white ${bgColor} transform translate-x-full transition-transform duration-300 ease-out`;
            toast.innerText = message;
            
            container.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Animate out
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            startTracking();
            
            document.getElementById('order-transport-type').addEventListener('change', (e) => {
                const branchInfo = document.getElementById('branch-info');
                if (e.target.value === '住祝 注爪') {
                    branchInfo.classList.remove('hidden');
                } else {
                    branchInfo.classList.add('hidden');
                }
            });
            
            // [NEW] Attach listener to file input
            document.getElementById('file-upload').addEventListener('change', handleFileUpload);
        });
    </script>
</body>
</html>

