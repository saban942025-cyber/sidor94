<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 转 | DeliveryMaster</title>
    
    <style>
        /* ... (住转 CSS  拽抓 拽) ... */
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            direction: rtl;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            scroll-behavior: smooth;
        }
        * { box-sizing: border-box; }
        .mock-header {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .mock-header h1 { margin: 0; font-size: 1.5rem; }
        #openEcoDashboardButton {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #openEcoDashboardButton:hover { background-color: #2980b9; }
        .mock-content { padding: 30px; text-align: center; font-size: 1.2rem; color: #555; }
        #ecoModalOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #ecoModalOverlay.visible { opacity: 1; pointer-events: all; }
        #ecoDashboard {
            width: 90%;
            max-width: 1400px;
            height: 90vh;
            background: #f4f7f6;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        #ecoModalOverlay.visible #ecoDashboard { transform: scale(1); }
        .eco-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: #ffffff;
            border-bottom: 1px solid #dfe4e8;
            flex-shrink: 0;
        }
        .eco-header h2 { margin: 0; color: #1a3b58; font-size: 1.4rem; }
        .eco-controls { display: flex; gap: 15px; align-items: center; }
        .eco-add-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 14px;
            font-size: 0.9rem;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .eco-add-btn:hover { background-color: #218838; }
        .eco-add-btn.back-btn { background-color: #ffc107; color: #212529; }
        .eco-add-btn.back-btn:hover { background-color: #e0a800; }
        .eco-search-box {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.9rem;
            width: 250px;
            transition: box-shadow 0.2s;
        }
        .eco-search-box:focus {
            outline: none;
            box-shadow: 0 0 0 2px #3498db80;
            border-color: #3498db;
        }
        .eco-close-btn {
            font-size: 2.5rem;
            color: #888;
            cursor: pointer;
            line-height: 1;
            padding: 0 5px;
            transition: color 0.2s;
        }
        .eco-close-btn:hover { color: #333; }
        #ecoAddForm {
            padding: 24px;
            background: #ffffff;
            flex-grow: 1;
            overflow-y: auto;
        }
        .eco-form-group { margin-bottom: 16px; }
        .eco-form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
        }
        .eco-form-group input[type="text"],
        .eco-form-group input[type="date"],
        .eco-form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
        }
        /* [转拽] 住 砖 拽专  (驻注 转) */
        .eco-form-group input[readonly] {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }
        .eco-form-actions {
            display: flex;
            gap: 10px;
            margin-top: 24px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .eco-form-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        .eco-form-btn-save { background-color: #007bff; color: white; }
        .eco-form-btn-save:hover { background-color: #0069d9; }
        .eco-form-btn-save:disabled { background-color: #aaa; cursor: not-allowed; }
        #ecoContainerGrid {
            flex-grow: 1;
            overflow-y: auto;
            padding: 24px;
            background: #f4f7f6;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 20px;
        }
        .eco-card {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.07);
            display: flex;
            flex-direction: column;
            padding: 16px 20px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid transparent;
        }
        .eco-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }
        .eco-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid #eee;
            padding-bottom: 12px;
            margin-bottom: 12px;
        }
        .eco-customer-name {
            font-weight: 600;
            font-size: 1.2rem;
            color: #2c3e50;
        }
        .eco-warehouse {
            font-size: 0.9rem;
            color: #555;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        .eco-address {
            font-size: 0.95rem;
            color: #777;
            margin-bottom: 16px;
        }
        .eco-progress-container {
            position: relative;
            width: 100%;
            padding-top: 30px; 
            margin-bottom: 10px;
        }
        .eco-progress-bar-container {
            width: 100%;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        .eco-progress-bar {
            height: 100%;
            border-radius: 6px 0 0 6px;
            transition: width 0.5s ease-out, background-color 0.5s;
            background-color: #66bb6a; 
        }
        .eco-progress-bar.green { background: linear-gradient(90deg, #66bb6a, #43a047); }
        .eco-progress-bar.yellow { background: linear-gradient(90deg, #ffee58, #fdd835); }
        .eco-progress-bar.red { background: linear-gradient(90deg, #ef5350, #e53935); }
        .eco-truck-indicator {
            position: absolute;
            top: 0; 
            right: 0%; 
            transition: right 0.5s ease-out;
            transform: translateX(50%); 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .eco-truck-label {
            font-size: 0.8rem;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 5px;
            border-radius: 4px;
            margin-bottom: 2px;
            white-space: nowrap;
        }
        .eco-truck-icon { font-size: 1.5rem; }
        .eco-card.alert {
            border-color: #e53935;
            box-shadow: 0 0 15px rgba(229, 57, 53, 0.4);
        }
        .eco-card.alert .eco-progress-bar.red { animation: pulse-red 1s infinite; }
        .eco-card.alert .eco-truck-label {
            animation: pulse-text 1s infinite;
            color: #d32f2f;
            font-weight: 700;
        }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        @keyframes pulse-text { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .eco-actions { display: flex; gap: 10px; margin-top: auto; padding-top: 16px; }
        .eco-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: background-color 0.2s, transform 0.1s;
        }
        .eco-btn:active { transform: scale(0.98); }
        .eco-btn-primary { background-color: #007bff; color: white; }
        .eco-btn-primary:hover { background-color: #0069d9; }
        .eco-btn-secondary { background-color: #6c757d; color: white; }
        .eco-btn-secondary:hover { background-color: #5a6268; }
        @media (max-width: 768px) {
            #ecoDashboard { width: 100%; height: 100%; border-radius: 0; }
            #ecoContainerGrid { grid-template-columns: 1fr; padding: 16px; }
            .eco-header { flex-direction: column; gap: 10px; padding: 12px 16px; }
            .eco-controls { width: 100%; flex-direction: column; align-items: stretch; }
            .eco-search-box { width: 100%; }
            .eco-add-btn { width: 100%; }
            #ecoAddForm { padding: 16px; }
        }
        .eco-card.hidden { display: none; }
        .eco-hidden { display: none !important; }
    </style>

    <!-- [砖专] 注转 住驻专转 Firebase v9.15.0 + 驻拽爪转 注专/拽 -->
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        // [砖] 住驻 驻拽爪转 转: C.R.U.D
        import { 
            getFirestore, collection, onSnapshot, query, where, orderBy, 
            addDoc, Timestamp, doc, updateDoc, deleteDoc
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- Mandatory Firebase Config & Auth (using globals) ---
        const fallbackConfig = {
            apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", authDomain: "saban94-76543.firebaseapp.com", projectId: "saban94-76543",
            storageBucket: "saban94-76543.appspot.com", messagingSenderId: "41553157903", appId: "1:41553157903:web:cc33d252cff023be97a87a", measurementId: "G-XV6RZDESSB"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : fallbackConfig;
        const providedToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // [砖] 砖驻转  砖专转 专砖 住拽专驻 专砖
        window.firebaseServices = { 
            db, auth, collection, onSnapshot, query, where, orderBy, 
            addDoc, Timestamp, doc, updateDoc, deleteDoc
        };

        // --- 转 ---
        try {
            if (providedToken) {
                console.log("EcoModal: Authenticating with provided token...");
                await signInWithCustomToken(auth, providedToken);
            } else {
                console.warn("EcoModal: No provided token, signing in anonymously...");
                await signInAnonymously(auth);
            }
            console.log("EcoModal: Auth successful.", auth.currentUser?.uid);
            window.firebaseAuthReady = true;
            document.dispatchEvent(new Event('firebaseAuthReady'));
        } catch (error) {
            console.error("EcoModal: Critical auth failure.", error);
            window.firebaseAuthReady = false;
        }
    </script>
    <!-- 住祝 注转 Firebase -->

</head>
<body>

    <!-- 住转  ... -->
    <div class="mock-header" id="mockDashboardHeader">
        <h1>DeliveryMaster</h1>
        <button id="openEcoDashboardButton">驻转 砖专 转 (Eco)</button>
    </div>
    <div class="mock-content">
        <p> 转 砖 祝 专砖 注专转.</p>
    </div>
    <!-- 住祝 住转  -->


    <!-- =========== 砖专  转 (Eco System) =========== -->
    
    <div id="ecoModalOverlay">
        
        <div id="ecoDashboard">
            
            <header class="eco-header">
                <h2> 转 (Eco System)</h2>
                <div class="eco-controls">
                    <input type="search" id="ecoSearchInput" class="eco-search-box" placeholder="驻砖 驻 拽, 转转...">
                    <button id="ecoAddButton" class="eco-add-btn">住祝 </button>
                </div>
                <span class="eco-close-btn" id="ecoCloseModalButton">&times;</span>
            </header>
            
            <!-- [砖专] 驻住 住驻转  注 驻砖 拽转 -->
            <form id="ecoAddForm" class="eco-hidden" novalidate>
                
                <!-- [砖] 砖 住转专 住 ID 拽 砖专 -->
                <input type="hidden" id="ecoFormCustomerID">
                
                <div class="eco-form-group">
                    <label for="ecoFormCustomerSearch">驻砖 拽 (砖, 住驻专 拽, 驻)</label>
                    <!-- [砖] 拽砖专 -datalist -->
                    <input type="text" id="ecoFormCustomerSearch" list="ecoCustomerList" required autocomplete="off">
                    <!-- [砖] 专砖转 爪注转 转 砖转转 -Firebase -->
                    <datalist id="ecoCustomerList"></datalist>
                </div>
                <div class="eco-form-group">
                    <label for="ecoFormAddress">转转</label>
                    <!-- [转拽] 住专 readonly;  转住祝 住专 注" JS -->
                    <input type="text" id="ecoFormAddress" required>
                </div>
                <div class="eco-form-group">
                    <label for="ecoFormWarehouse">住</label>
                    <select id="ecoFormWarehouse" required>
                        <option value="">专 住...</option>
                        <option value="住 30 - (砖专拽)">住 30 - (砖专拽)</option>
                        <option value="住 32 - (专)">住 32 - (专)</option>
                        <option value="住 40 - (砖 砖专)">住 40 - (砖 砖专)</option>
                    </select>
                </div>
                <div class="eco-form-group">
                    <label for="ecoFormDeliveryNote">住驻专 转注转 砖 (驻爪)</label>
                    <input type="text" id="ecoFormDeliveryNote">
                </div>
                <div class="eco-form-group">
                    <label for="ecoFormStartDate">转专 转</label>
                    <input type="date" id="ecoFormStartDate" required>
                </div>
                <div class="eco-form-actions">
                    <button type="submit" id="ecoSaveButton" class="eco-form-btn eco-form-btn-save">砖专 </button>
                </div>
            </form>

            <!-- 专砖转 专住 -->
            <main id="ecoContainerGrid">
                <p style="padding: 20px; text-align: center;">注 转 -Firebase...</p>
            </main>

        </div>
    </div>

    <template id="ecoCardTemplate">
        <div class="eco-card">
            <div class="eco-card-header">
                <span class="eco-customer-name">砖 拽</span>
                <span class="eco-warehouse">住</span>
            </div>
            <p class="eco-address">转转 拽</p>
            <div class="eco-progress-container">
                <div class="eco-truck-indicator">
                    <span class="eco-truck-label">0 </span>
                    <span class="eco-truck-icon"></span>
                </div>
                <div class="eco-progress-bar-container">
                    <div class="eco-progress-bar green" style="width: 0%;"></div>
                </div>
            </div>
            <div class="eco-actions">
                <button class="eco-btn eco-btn-primary btn-replace">驻</button>
                <button class="eco-btn eco-btn-secondary btn-remove">爪</button>
            </div>
        </div>
    </template>
    
    <!-- =========== 住祝 砖专  转 =========== -->


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 转专  专 ---
            const modalOverlay = document.getElementById('ecoModalOverlay');
            const dashboardPanel = document.getElementById('ecoDashboard');
            const openButton = document.getElementById('openEcoDashboardButton');
            const closeButton = document.getElementById('ecoCloseModalButton');
            const grid = document.getElementById('ecoContainerGrid');
            const cardTemplate = document.getElementById('ecoCardTemplate');
            const searchInput = document.getElementById('ecoSearchInput');
            
            // ---  驻住 ---
            const addButton = document.getElementById('ecoAddButton');
            const addForm = document.getElementById('ecoAddForm');
            const saveButton = document.getElementById('ecoSaveButton');
            
            // --- [砖]  驻住 驻砖 ---
            const customerSearchInput = document.getElementById('ecoFormCustomerSearch');
            const customerDatalist = document.getElementById('ecoCustomerList');
            const customerAddressInput = document.getElementById('ecoFormAddress');
            const customerIdInput = document.getElementById('ecoFormCustomerID');

            // --- 砖转 State ---
            let allContainersData = [];
            let allCustomersData = []; // [砖] 注专 住  拽转
            const MAX_RENTAL_DAYS_VIEW = 10;

            // --- 驻转 住专 砖  ---
            window.openEcoModal = () => {
                modalOverlay.classList.add('visible');
                showContainerList(); 
            };
            const closeEcoModal = () => {
                modalOverlay.classList.remove('visible');
            };

            if (openButton) openButton.addEventListener('click', window.openEcoModal);
            if (closeButton) closeButton.addEventListener('click', closeEcoModal);
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) closeEcoModal();
            });

            // ---  转爪转 驻住/专砖 ---
            const showAddForm = () => {
                grid.classList.add('eco-hidden');
                searchInput.classList.add('eco-hidden');
                addForm.classList.remove('eco-hidden');
                addButton.textContent = '专 专砖';
                addButton.classList.add('back-btn');
                addForm.reset();
                customerIdInput.value = ''; // [砖] 驻住  住转专
                document.getElementById('ecoFormStartDate').valueAsDate = new Date();
            };
            const showContainerList = () => {
                grid.classList.remove('eco-hidden');
                searchInput.classList.remove('eco-hidden');
                addForm.classList.add('eco-hidden');
                addButton.textContent = '住祝 ';
                addButton.classList.remove('back-btn');
            };
            addButton.addEventListener('click', () => {
                if (addForm.classList.contains('eco-hidden')) showAddForm();
                else showContainerList();
            });


            // --- 拽转 专 转 ---
            
            // 砖转  砖专转 Firebase
            let db, auth, collection, onSnapshot, query, where, orderBy, addDoc, Timestamp, doc, updateDoc, deleteDoc;
            let appId, userId;

            const initializeEcoApp = () => {
                const services = window.firebaseServices;
                if (!services || !services.db) {
                    console.error("EcoModal: Firebase services not available.");
                    grid.innerHTML = '<p style="padding: 20px; text-align: center; color: red;">砖 拽专转:  专 住住 转.</p>';
                    return;
                }
                
                // 砖  砖专转 -Firebase
                ({ db, auth, collection, onSnapshot, query, where, orderBy, addDoc, Timestamp, doc, updateDoc, deleteDoc } = services);
                
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                userId = auth.currentUser?.uid;

                if (!userId) {
                    console.error("EcoModal: Auth completed but user ID is not available.");
                    return;
                }
                
                // 驻注转 
                listenToContainers();
                listenToCustomers(); // [砖] 驻注转  拽转
            };

            /**
             * [砖]  拽拽砖 拽转
             */
            const listenToCustomers = () => {
                try {
                    // [转拽] 专 转 转  
                    const customersColPath = `/artifacts/${appId}/public/data/customers`; 
                    console.log(`EcoModal: Listening to customers at: ${customersColPath}`);
                    
                    const q = query(collection(db, customersColPath), orderBy("name")); //  驻 砖
                    
                    onSnapshot(q, (snapshot) => {
                        allCustomersData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        
                        populateCustomerDatalist(); // [砖] 注 专砖 驻转转
                        console.log(`EcoModal: Loaded ${allCustomersData.length} customers.`);
                        
                    }, (error) => {
                        console.error("EcoModal: Error listening to Customers collection:", error);
                    });

                } catch (error) {
                    console.error("EcoModal: Failed to set up Customers listener.", error);
                }
            };
            
            /**
             * [砖]  转 -Datalist 注 拽转
             */
            const populateCustomerDatalist = () => {
                if (!customerDatalist) return;
                customerDatalist.innerHTML = ''; // 拽 驻爪转 拽转
                
                allCustomersData.forEach(cust => {
                    const option = document.createElement('option');
                    option.value = cust.name; //  砖砖转砖 专 专
                    option.dataset.id = cust.id; // 砖专转 
                    option.dataset.address = cust.defaultAddress || cust.address || ''; // 砖专转 转转
                    
                    // 拽住 注专 砖驻注 专驻 ( , 转 驻驻)
                    let label = `${cust.customerNumber || ' 住驻专'} | ${cust.phone || ' 驻'}`;
                    option.label = label;
                    option.textContent = label; // Fallback
                    
                    customerDatalist.appendChild(option);
                });
            };

            /**
             * [砖] 驻 专转 拽 专砖
             */
            const handleCustomerSearch = (event) => {
                const value = event.target.value;
                let found = false;

                // 住 爪 转 -Datalist
                const options = customerDatalist.options;
                for (let i = 0; i < options.length; i++) {
                    if (options[i].value === value) {
                        const selectedOption = options[i];
                        customerAddressInput.value = selectedOption.dataset.address || '';
                        customerIdInput.value = selectedOption.dataset.id || '';
                        customerAddressInput.readOnly = true; // [砖] 注 转 转转  拽 拽
                        found = true;
                        break;
                    }
                }

                if (!found) {
                    // [转拽]  砖转砖 拽 砖 砖
                    customerIdInput.value = ''; // 拽 ID (  拽 砖)
                    customerAddressInput.readOnly = false; // [砖] 驻砖专 注专 转 砖 转转
                    //  ** 拽 转 customerAddressInput  驻砖专  拽 转转 砖
                }
            };

            // [砖] 专 专注 转转 驻砖 拽转
            customerSearchInput.addEventListener('input', handleCustomerSearch);


            /**
             *  拽拽砖 转
             */
            const listenToContainers = () => {
                const containersColPath = `/artifacts/${appId}/public/data/containers`;
                console.log(`EcoModal: Listening to collection: ${containersColPath}`);
                const q = query(collection(db, containersColPath));

                try {
                    onSnapshot(q, (snapshot) => {
                        const containers = snapshot.docs.map(doc => {
                            const data = doc.data();
                            const jsDate = data.startDate?.toDate ? data.startDate.toDate() : null;
                            if (!jsDate) return null; 
                            return {
                                id: doc.id,
                                // [砖专] 转   砖 (string)  砖 (object)
                                customerName: data.customer?.name || data.customerName || 'N/A',
                                address: data.address || 'N/A',
                                warehouse: data.warehouse || 'N/A',
                                startDate: jsDate,
                                // [砖] 砖专  转  拽  拽, 转 驻注转 注转转
                                customerId: data.customer?.id || null 
                            };
                        }).filter(c => c !== null); 
                        allContainersData = containers; 
                        renderData(allContainersData); 
                    }, (error) => {
                        console.error("EcoModal: Error listening to Firestore:", error);
                        grid.innerHTML = '<p style="padding: 20px; text-align: center; color: red;">砖 拽转 转 转.</p>';
                    });
                } catch (error) {
                    console.error("EcoModal: Failed to set up onSnapshot listener.", error);
                }
            };

            /**
             * 专专 转  专住 转 专
             */
            const renderData = (containers) => {
                grid.innerHTML = ''; 
                if (containers.length === 0) {
                    grid.innerHTML = '<p style="padding: 20px; text-align: center;"> 爪 转 驻注转.</p>';
                    return;
                }
                containers.sort((a, b) => b.startDate.getTime() - a.startDate.getTime());
                containers.forEach(container => {
                    const card = createContainerCard(container);
                    grid.appendChild(card);
                });
            };

            /**
             * 爪专  HTML 砖 专住  
             */
            const createContainerCard = (container) => {
                const cardFragment = cardTemplate.content.cloneNode(true);
                const cardElement = cardFragment.querySelector('.eco-card');
                cardElement.dataset.id = container.id;
                
                // [砖专] 拽专 转 砖 拽 (砖 注 注砖 拽)
                cardElement.querySelector('.eco-customer-name').textContent = container.customerName;
                cardElement.querySelector('.eco-warehouse').textContent = container.warehouse;
                cardElement.querySelector('.eco-address').textContent = container.address;

                try {
                    const rentalDays = calculateRentalDays(container.startDate);
                    updateProgressBar(cardElement, rentalDays);
                } catch (e) {
                    console.error(`Error calculating days for container ${container.id}:`, e);
                    cardElement.querySelector('.eco-progress-container').style.display = 'none';
                }

                cardElement.querySelector('.btn-replace').addEventListener('click', () => {
                    handleReplace(container.id, container.customerName);
                });
                cardElement.querySelector('.btn-remove').addEventListener('click', () => {
                    handleRemove(container.id, container.customerName);
                });
                return cardElement;
            };

            // --- 驻拽爪转  (拽) ---
            const calculateRentalDays = (startDateInput) => {
                if (!startDateInput) throw new Error("Invalid start date input");
                const startDate = new Date(startDateInput);
                const today = new Date();
                startDate.setHours(0, 0, 0, 0);
                today.setHours(0, 0, 0, 0);
                const diffTime = today.getTime() - startDate.getTime();
                if (diffTime < 0) return 0; 
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays + 1; 
            };
            const updateProgressBar = (cardElement, days) => {
                const progressBar = cardElement.querySelector('.eco-progress-bar');
                const truckIndicator = cardElement.querySelector('.eco-truck-indicator');
                const truckLabel = cardElement.querySelector('.eco-truck-label');
                if (!progressBar || !truckIndicator || !truckLabel) return;
                let percentage = (days / MAX_RENTAL_DAYS_VIEW) * 100;
                if (percentage > 100) percentage = 100;
                if (percentage < 0) percentage = 0;
                progressBar.style.width = percentage + '%';
                truckIndicator.style.right = percentage + '%';
                truckLabel.textContent = `${days} `;
                progressBar.classList.remove('green', 'yellow', 'red');
                cardElement.classList.remove('alert');
                if (days >= 10) {
                    progressBar.classList.add('red');
                    cardElement.classList.add('alert'); 
                } else if (days >= 8) {
                    progressBar.classList.add('yellow');
                } else {
                    progressBar.classList.add('green');
                }
            };

            // --- [砖专] 拽转 砖专转 驻住 ---
            const handleSaveContainer = async (event) => {
                event.preventDefault();
                
                // [砖专] 拽转 注专 驻住
                let customerId = customerIdInput.value; // 注砖 转 专拽
                const customerName = customerSearchInput.value.trim();
                const address = customerAddressInput.value.trim();
                const warehouse = document.getElementById('ecoFormWarehouse').value;
                const startDateValue = document.getElementById('ecoFormStartDate').value;
                const deliveryNote = document.getElementById('ecoFormDeliveryNote').value.trim();

                // [砖专] 爪
                if (!customerName || !address || !warehouse || !startDateValue) {
                    alert("  转  砖转  (拽, 转转, 住, 转专).");
                    return;
                }
                
                saveButton.disabled = true;
                saveButton.textContent = '砖专...';

                try {
                    // [转拽] 拽 爪专转 拽 砖  爪专
                    if (!customerId) {
                        //   ID,  拽 砖. 爪专 转
                        console.log("EcoModal: Creating new customer...");
                        saveButton.textContent = '爪专 拽 砖...';
                        
                        const newCustomerData = {
                            name: customerName,
                            defaultAddress: address,
                            address: address, // 砖转 驻爪
                            createdAt: Timestamp.now(),
                            // 住祝 砖转 住住, 砖转砖  注专 转 专 转专 注专转 
                            phone: '',
                            customerNumber: '' 
                        };
                        
                        // [转拽] 爪专 转 拽 转  
                        const customersColPath = `/artifacts/${appId}/public/data/customers`;
                        const customerDocRef = await addDoc(collection(db, customersColPath), newCustomerData);
                        customerId = customerDocRef.id; // 砖专 转 -ID 砖
                        console.log(`EcoModal: New customer created with ID: ${customerId} at ${customersColPath}`);
                    }

                    // --- 爪专转  ---
                    saveButton.textContent = '砖专 ...';
                    
                    const newContainerData = {
                        customer: {
                            id: customerId,
                            name: customerName
                        },
                        address: address, 
                        warehouse: warehouse,
                        deliveryNote: deliveryNote || null,
                        startDate: Timestamp.fromDate(new Date(startDateValue)),
                        createdAt: Timestamp.now(),
                        createdBy: userId
                    };

                    const containersColPath = `/artifacts/${appId}/public/data/containers`;
                    const docRef = await addDoc(collection(db, containersColPath), newContainerData);
                    
                    console.log("EcoModal: New container saved successfully!", docRef.id);
                    alert(" 砖专 爪!");
                    showContainerList();
                } catch (error) {
                    console.error("EcoModal: Error saving new container:", error);
                    alert("砖 砖专转 . 拽 转 .");
                } finally {
                    saveButton.disabled = false;
                    saveButton.textContent = '砖专 ';
                }
            };
            addForm.addEventListener('submit', handleSaveContainer);


            // --- 驻 专注 (驻转专 驻砖) ---
            const handleReplace = (containerId, customerName) => {
                console.log(`拽砖转 驻 注专  ${containerId} (${customerName})`);
                alert(`注  专: 驻 注专\n${customerName} (ID: ${containerId})`);
            };
            const handleRemove = (containerId, customerName) => {
                console.log(`拽砖转 爪 注专  ${containerId} (${customerName})`);
                alert(`注  专: 爪 注专\n${customerName} (ID: ${containerId})`);
            };

            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const cards = grid.querySelectorAll('.eco-card');
                cards.forEach(card => {
                    const customerName = card.querySelector('.eco-customer-name').textContent.toLowerCase();
                    const address = card.querySelector('.eco-address').textContent.toLowerCase();
                    const isVisible = customerName.includes(searchTerm) || address.includes(searchTerm);
                    card.style.display = isVisible ? 'flex' : 'none';
                });
            });

            // --- 转转 驻拽爪 ---
            if (window.firebaseAuthReady) {
                initializeEcoApp();
            } else {
                document.addEventListener('firebaseAuthReady', () => {
                    initializeEcoApp();
                });
            }

        });
    </script>

</body>
</html>



