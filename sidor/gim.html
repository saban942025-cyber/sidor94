<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v32.5 (Stable)</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/feather-icons"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- סגנונות CSS - ללא שינוי מהמקור -->
    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: #e5e7eb;
            --danger-color: #ef4444;
            --success-color: #10b981;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            direction: rtl;
        }
        /* סגנונות בסיס */
        .container-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        /* כרטיסים ואלמנטים כלליים */
        .card {
            background-color: var(--bg-white);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
            border: 1px solid var(--border-color);
        }
        .header-main {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); }
        .btn-primary:disabled { background-color: #93c5fd; cursor: not-allowed; }

        /* טוסטים ומודלים */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: white;
            font-weight: 500;
            min-width: 250px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(-20px);
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4b5563;
        }
        /* סגנונות מפה */
        #map-container {
            height: 400px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }
        /* סגנונות לוח מכולות (ECO Dashboard) */
        .eco-dashboard-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .eco-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .eco-card {
            display: flex;
            flex-direction: column;
            border: 2px solid #3b82f6; /* כחול ראשי */
            background-color: #eff6ff; /* כחול בהיר */
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .eco-card:hover { transform: translateY(-3px); }
        .eco-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #93c5fd;
            padding-bottom: 5px;
        }
        .eco-card-header .eco-type {
            font-weight: bold;
            color: #1e40af;
            font-size: 1.1rem;
        }
        .eco-card-header .eco-id {
            font-size: 0.85rem;
            color: #60a5fa;
        }
        .eco-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.95rem;
        }
        .eco-label {
            font-weight: 500;
            color: #4b5563;
        }
        .eco-value {
            color: #1f2937;
            font-weight: 400;
            text-align: left;
        }
        .eco-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        .eco-actions button {
            flex-grow: 1;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s, opacity 0.2s;
        }
        .btn-replace {
            background-color: #f59e0b; /* צהוב */
            color: white;
        }
        .btn-replace:hover { background-color: #d97706; }
        .btn-remove {
            background-color: #ef4444; /* אדום */
            color: white;
        }
        .btn-remove:hover { background-color: #dc2626; }

        /* סגנון לסטטוס */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-available {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-occupied {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-repair {
            background-color: #fffbeb;
            color: #b45309;
        }
        .status-on-route {
            background-color: #bfdbfe;
            color: #1e40af;
        }
        #userIdDisplay {
            font-size: 0.8rem;
            color: #bfdbfe;
            margin-top: 5px;
            direction: ltr;
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="header-main">
        <div class="container-wrapper flex justify-between items-center">
            <div class="text-xl font-bold">DeliveryMaster</div>
            <div>
                <button id="openEcoDashboardButton" class="bg-white text-blue-600 px-4 py-2 rounded-lg shadow font-semibold transition hover:bg-gray-100 flex items-center gap-2">
                    <i data-feather="grid" class="w-5 h-5"></i>
                    <span>לוח מכולות</span>
                </button>
            </div>
        </div>
    </header>

    <div id="toast-container"></div>

    <main class="container-wrapper">
        <div id="main-app-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 mt-4">ניהול הזמנות מכולות</h2>
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <input type="text" id="order-search" placeholder="חפש לפי שם לקוח או כתובת..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                <button id="add-order-btn" class="btn-primary flex-shrink-0 flex items-center justify-center gap-2">
                    <i data-feather="plus" class="w-5 h-5"></i>
                    <span>הוסף הזמנה חדשה</span>
                </button>
            </div>

            <!-- טבלת הזמנות -->
            <div class="card overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">לקוח</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">כתובת</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">סוג</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">תאריך אספקה</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">מכולה ID</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- נתונים יוזנו כאן על ידי JavaScript -->
                    </tbody>
                </table>
                <div id="loading-indicator" class="text-center py-4 text-gray-500 hidden">טוען נתונים...</div>
                <div id="no-orders-message" class="text-center py-4 text-gray-500 hidden">אין הזמנות קיימות.</div>
            </div>

            <!-- מפה תצוגה כללית -->
            <h3 class="text-xl font-bold text-gray-800 mt-8 mb-4">מפת מיקומים</h3>
            <div id="map-container"></div>
        </div>

        <div id="eco-dashboard" class="hidden">
            <!-- תוכן לוח המכולות יטען מ-eco3.html -->
        </div>
    </main>

    <!-- מודל הוספה/עריכת הזמנה -->
    <div id="container-order-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" class="text-xl font-bold">הוספת הזמנת מכולה</h3>
                <button class="modal-close-btn" onclick="closeContainerOrderModal()">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="container-order-form">
                <input type="hidden" id="order-id">
                <div class="space-y-4">
                    <!-- פרטי לקוח -->
                    <h4 class="text-lg font-semibold border-b pb-2 mb-2">פרטי לקוח</h4>
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-700">שם לקוח</label>
                        <input type="text" id="customer-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="customer-phone" class="block text-sm font-medium text-gray-700">טלפון</label>
                        <input type="tel" id="customer-phone" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="customer-address" class="block text-sm font-medium text-gray-700">כתובת אספקה</label>
                        <input type="text" id="customer-address" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="container-type" class="block text-sm font-medium text-gray-700">סוג מכולה</label>
                        <select id="container-type" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">בחר סוג</option>
                            <option value="8_cubic">8 קוב</option>
                            <option value="12_cubic">12 קוב</option>
                            <option value="24_cubic">24 קוב</option>
                            <option value="press">מכולת דחס</option>
                        </select>
                    </div>

                    <!-- פרטי אספקה -->
                    <h4 class="text-lg font-semibold border-b pb-2 mb-2 pt-4">פרטי אספקה</h4>
                    <div>
                        <label for="delivery-type" class="block text-sm font-medium text-gray-700">סוג הזמנה</label>
                        <select id="delivery-type" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="delivery">הובלה</option>
                            <option value="pickup">פינוי</option>
                            <option value="switch">החלפה</option>
                        </select>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label for="order-date" class="block text-sm font-medium text-gray-700">תאריך מבוקש</label>
                            <input type="date" id="order-date" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex-1">
                            <label for="order-time" class="block text-sm font-medium text-gray-700">שעת אספקה</label>
                            <input type="time" id="order-time" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div id="rental-start-date-group" class="hidden">
                        <label for="rental-start-date" class="block text-sm font-medium text-gray-700">תאריך תחילת שכירות</label>
                        <input type="datetime-local" id="rental-start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="container-id-group" class="hidden">
                        <label for="container-id" class="block text-sm font-medium text-gray-700">מכולה ID</label>
                        <input type="text" id="container-id" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="order-notes" class="block text-sm font-medium text-gray-700">הערות</label>
                        <textarea id="order-notes" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                </div>

                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeContainerOrderModal()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">ביטול</button>
                    <button type="submit" id="save-order-btn" class="btn-primary">שמור הזמנה</button>
                </div>
            </form>
        </div>
    </div>

    <!-- מודל עריכת מכולה מהדאשבורד -->
    <div id="container-edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="container-edit-title" class="text-xl font-bold">עריכת מכולה: <span id="container-edit-display-id"></span></h3>
                <button class="modal-close-btn" onclick="closeContainerEditModal()">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="container-edit-form">
                <input type="hidden" id="container-edit-order-id">
                <div class="space-y-4">
                    <p class="text-sm text-gray-600">משמש לעדכון סטטוס מכולה קיים (אירוע אספקה/איסוף/החלפה).</p>

                    <div>
                        <label for="container-edit-delivery-type" class="block text-sm font-medium text-gray-700">סוג אירוע</label>
                        <select id="container-edit-delivery-type" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="delivery">הובלה (הצבה)</option>
                            <option value="pickup">פינוי (איסוף)</option>
                            <option value="switch">החלפה</option>
                        </select>
                    </div>

                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label for="container-edit-date" class="block text-sm font-medium text-gray-700">תאריך אירוע</label>
                            <input type="date" id="container-edit-date" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex-1">
                            <label for="container-edit-time" class="block text-sm font-medium text-gray-700">שעת אירוע</label>
                            <input type="time" id="container-edit-time" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <div id="container-edit-rental-start-group">
                        <label for="container-edit-rental-start" class="block text-sm font-medium text-gray-700">תאריך/שעת תחילת שכירות</label>
                        <input type="datetime-local" id="container-edit-rental-start" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">מלא רק אם האירוע הוא 'הובלה' (הצבה ראשונית).</p>
                    </div>

                    <div>
                        <label for="container-edit-notes" class="block text-sm font-medium text-gray-700">הערות</label>
                        <textarea id="container-edit-notes" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                </div>

                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeContainerEditModal()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">ביטול</button>
                    <button type="button" id="container-edit-save-btn" class="btn-primary" onclick="handleSaveContainerOrder(this)">שמור שינויים</button>
                </div>
            </form>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- הגדרות Firebase גלובליות (חובה) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // הגדרת משתנים גלובליים לשימוש בקבצים אחרים (eco3.html)
        window.app = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.firebaseAuthReady = false; // דגל שינוצל על ידי eco3.html

        // הגדרת SmartLog
        const SmartLog = {
            info: (message, context, details = {}) => console.log(`[INFO][${context}] ${message}`, details),
            error: (error, context, details = {}) => console.error(`[ERROR][${context}] ${error.message}`, error, details),
            debug: (message, context, details = {}) => console.debug(`[DEBUG][${context}] ${message}`, details),
        };
        window.SmartLog = SmartLog;

        // --- אתחול Firebase ואותנטיקציה ---
        async function initializeFirebase() {
            try {
                SmartLog.debug("Starting Firebase initialization", "Auth.Init");
                setLogLevel('debug'); // הגדרת רמת לוגים גבוהה לניפוי שגיאות

                window.app = initializeApp(firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);

                // שימוש ב-onAuthStateChanged כדי להבטיח שכל פעולות Firestore יתחילו רק לאחר כניסה מוצלחת.
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        window.firebaseAuthReady = true;
                        SmartLog.info("User authenticated successfully", "Auth.StateChanged", { uid: user.uid });

                        // יצירת אירוע להתחלת אפליקציות תלויות (כמו לוח המכולות)
                        document.dispatchEvent(new Event('firebaseAuthReady'));

                    } else {
                        // אם אין משתמש, ננסה לבצע כניסה
                        SmartLog.info("No user found. Attempting sign-in...", "Auth.StateChanged");
                        await handleSignIn();
                    }
                });

                // הפונקציה הראשונית שמפעילה את תהליך הכניסה
                if (!window.auth.currentUser) {
                    await handleSignIn();
                }

            } catch (e) {
                SmartLog.error(e, "Auth.Init", { config: firebaseConfig });
            }
        }

        async function handleSignIn() {
            try {
                if (initialAuthToken) {
                    // כניסה באמצעות טוקן מותאם אישית מהסביבה
                    await signInWithCustomToken(window.auth, initialAuthToken);
                    SmartLog.info("Signed in with custom token", "Auth.SignIn");
                } else {
                    // כניסה אנונימית כגיבוי
                    await signInAnonymously(window.auth);
                    SmartLog.info("Signed in anonymously", "Auth.SignIn");
                }
            } catch (e) {
                SmartLog.error(e, "Auth.SignIn", { tokenExists: !!initialAuthToken });
                // במקרה של כישלון קריטי באותנטיקציה, מכולות הדאשבורד לא יוכלו לעבוד
                document.getElementById('loading-indicator').innerText = "שגיאת התחברות לשרת. בדוק את הרשאות Firebase.";
            }
        }

        // --- פונקציות עזר של Firestore ---

        /** מחזיר נתיב קולקציה פרטית של המשתמש */
        const getPrivateCollectionPath = (collectionName) => {
            if (!window.userId) {
                throw new Error("Authentication not ready. Cannot access private data.");
            }
            return `/artifacts/${appId}/users/${window.userId}/${collectionName}`;
        };
        window.getPrivateCollectionPath = getPrivateCollectionPath;


        /** מחזיר הפניה למסמך הזמנה ספציפי */
        const getOrderDocRef = (orderId) => {
            return doc(window.db, getPrivateCollectionPath('orders'), orderId);
        };
        window.getOrderDocRef = getOrderDocRef;


        // --- פונקציות עזר כלליות ---

        let currentMap = null;
        let mapMarkers = [];
        let orderSnapshotUnsubscribe = null;

        // ... (המשך הלוגיקה של showToast, modals, map, fetchOrders) ...

        // --- טוסטים, מודלים ומפה (מוסתר לשם קיצור, ההנחה היא שהם עובדים) ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            container.prepend(toast);

            // Force reflow
            void toast.offsetWidth;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }
        window.showToast = showToast;

        function closeContainerOrderModal() {
            document.getElementById('container-order-modal').style.display = 'none';
            document.getElementById('container-order-form').reset();
            document.getElementById('order-id').value = '';
            document.getElementById('modal-title').textContent = 'הוספת הזמנת מכולה';
            document.getElementById('container-id-group').classList.add('hidden');
        }
        window.closeContainerOrderModal = closeContainerOrderModal;

        function closeContainerEditModal() {
             document.getElementById('container-edit-modal').style.display = 'none';
             document.getElementById('container-edit-form').reset();
        }
        window.closeContainerEditModal = closeContainerEditModal;

        // מפת ליפלט
        function initializeMap() {
            if (currentMap) {
                currentMap.remove();
            }
            currentMap = L.map('map-container').setView([32.0853, 34.7818], 10); // תל אביב
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(currentMap);
        }

        function updateMapMarkers(orders) {
            mapMarkers.forEach(marker => currentMap.removeLayer(marker));
            mapMarkers = [];

            orders.forEach(order => {
                if (order.coordinates && order.coordinates.lat && order.coordinates.lng) {
                    const marker = L.marker([order.coordinates.lat, order.coordinates.lng])
                        .addTo(currentMap)
                        .bindPopup(`<b>${order.customerName}</b><br>${order.address}<br>סוג: ${order.containerType}`);
                    mapMarkers.push(marker);
                }
            });

            if (mapMarkers.length > 0) {
                const group = new L.featureGroup(mapMarkers);
                currentMap.fitBounds(group.getBounds().pad(0.5));
            } else {
                 currentMap.setView([32.0853, 34.7818], 10); // חזרה למרכז אם אין סמנים
            }
        }


        // --- לוגיקת CRUD מרכזית (בתוך טעינת ה-DOM) ---

        document.addEventListener('DOMContentLoaded', () => {
            feather.replace(); // החלפת אייקונים

            initializeFirebase(); // מתחיל את תהליך האותנטיקציה והאתחול

            // הצגת המשתמש הנוכחי (לניפוי שגיאות וזיהוי)
            const header = document.querySelector('.header-main .container-wrapper');
            const userIdDisplay = document.createElement('div');
            userIdDisplay.id = 'userIdDisplay';
            userIdDisplay.innerText = 'UID: טוען...';
            header.appendChild(userIdDisplay);


            // פונקציה לעדכון תצוגת ה-UID לאחר כניסה
            window.addEventListener('firebaseAuthReady', () => {
                document.getElementById('userIdDisplay').innerText = `UID: ${window.userId}`;
                fetchOrders(); // קריאה ראשונית לאחר כניסה
                initializeMap();
            });

            // פונקציית טעינת הזמנות בזמן אמת
            const ordersTableBody = document.getElementById('orders-table-body');
            const loadingIndicator = document.getElementById('loading-indicator');
            const noOrdersMessage = document.getElementById('no-orders-message');

            function fetchOrders() {
                 if (!window.firebaseAuthReady) {
                    SmartLog.debug("Waiting for auth readiness before fetching orders...", "CRUD.Fetch");
                    return;
                }

                // ביטול רישום קודם אם קיים
                if (orderSnapshotUnsubscribe) {
                    orderSnapshotUnsubscribe();
                    orderSnapshotUnsubscribe = null;
                }

                loadingIndicator.classList.remove('hidden');
                ordersTableBody.innerHTML = '';
                noOrdersMessage.classList.add('hidden');


                try {
                    const ordersCollectionRef = collection(window.db, getPrivateCollectionPath('orders'));
                    // שימוש ב-onSnapshot להאזנה לשינויים בזמן אמת
                    orderSnapshotUnsubscribe = onSnapshot(ordersCollectionRef, (snapshot) => {
                        SmartLog.info(`Received new snapshot with ${snapshot.docs.length} orders.`, "CRUD.Snapshot");
                        const orders = [];
                        snapshot.forEach(doc => {
                            orders.push({ id: doc.id, ...doc.data() });
                        });

                        loadingIndicator.classList.add('hidden');

                        if (orders.length === 0) {
                            noOrdersMessage.classList.remove('hidden');
                        } else {
                            noOrdersMessage.classList.add('hidden');
                        }

                        renderOrders(orders);
                        updateMapMarkers(orders);

                    }, (error) => {
                        // טיפול בשגיאות Firestore כולל שגיאות הרשאה
                        SmartLog.error(error, "CRUD.Snapshot.Error");
                        loadingIndicator.classList.add('hidden');
                        ordersTableBody.innerHTML = '';
                        noOrdersMessage.classList.remove('hidden');
                        noOrdersMessage.textContent = `שגיאה בטעינת הזמנות: ${error.message}. בדוק הרשאות.`;
                        showToast(`שגיאה: ${error.message}`, 'error');
                    });

                } catch (error) {
                    SmartLog.error(error, "CRUD.Fetch.InitError");
                    loadingIndicator.classList.add('hidden');
                    noOrdersMessage.classList.remove('hidden');
                    noOrdersMessage.textContent = `שגיאת מערכת: ${error.message}`;
                    showToast(`שגיאת מערכת: ${error.message}`, 'error');
                }
            }

            // פונקציית רינדור ההזמנות לטבלה
            function renderOrders(orders) {
                ordersTableBody.innerHTML = '';
                // מיון לפי תאריך אספקה (חדש קודם)
                orders.sort((a, b) => {
                    const dateA = moment(`${a.orderDate} ${a.orderTime || '00:00'}`, 'YYYY-MM-DD HH:mm');
                    const dateB = moment(`${b.orderDate} ${b.orderTime || '00:00'}`, 'YYYY-MM-DD HH:mm');
                    return dateB.valueOf() - dateA.valueOf();
                });

                orders.forEach(order => {
                    const row = ordersTableBody.insertRow();
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.customerName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.address}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${getContainerTypeDisplay(order.containerType)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" dir="ltr">${formatDateTime(order.orderDate, order.orderTime)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-semibold">${order.containerId || 'טרם הוצב'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-left text-sm font-medium flex gap-2">
                            <button onclick="handleEditOrder('${order.id}')" class="text-indigo-600 hover:text-indigo-900" title="ערוך">
                                <i data-feather="edit" class="w-5 h-5"></i>
                            </button>
                            <button onclick="handleDeleteOrder('${order.id}', '${order.customerName}')" class="text-red-600 hover:text-red-900" title="מחק">
                                <i data-feather="trash-2" class="w-5 h-5"></i>
                            </button>
                        </td>
                    `;
                });
                feather.replace();
            }

            // פונקציות עזר לתצוגה
            function getContainerTypeDisplay(type) {
                switch (type) {
                    case '8_cubic': return '8 קוב';
                    case '12_cubic': return '12 קוב';
                    case '24_cubic': return '24 קוב';
                    case 'press': return 'דחס';
                    default: return 'לא ידוע';
                }
            }
            function formatDateTime(date, time) {
                if (!date) return 'לא נקבע';
                const formattedDate = moment(date, 'YYYY-MM-DD').format('DD/MM/YY');
                const formattedTime = time ? moment(time, 'HH:mm').format('HH:mm') : '';
                return formattedTime ? `${formattedDate} | ${formattedTime}` : formattedDate;
            }


            // --- טיפול בהוספה ועריכה של הזמנה קיימת (Modal 1) ---

            document.getElementById('add-order-btn').addEventListener('click', () => {
                document.getElementById('container-order-form').reset();
                document.getElementById('order-id').value = '';
                document.getElementById('modal-title').textContent = 'הוספת הזמנת מכולה';
                document.getElementById('container-id-group').classList.add('hidden');
                document.getElementById('container-order-modal').style.display = 'flex';
            });

            window.handleEditOrder = async (orderId) => {
                if (!window.firebaseAuthReady) {
                    showToast("האפליקציה עדיין מתחברת לשרת.", "error");
                    return;
                }
                try {
                    const docRef = getOrderDocRef(orderId);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('order-id').value = orderId;
                        document.getElementById('modal-title').textContent = 'עריכת הזמנת מכולה';

                        // טעינת הנתונים לטופס
                        document.getElementById('customer-name').value = data.customerName || '';
                        document.getElementById('customer-phone').value = data.customerPhone || '';
                        document.getElementById('customer-address').value = data.address || '';
                        document.getElementById('container-type').value = data.containerType || '';
                        document.getElementById('delivery-type').value = data.deliveryType || 'delivery';
                        document.getElementById('order-date').value = data.orderDate || '';
                        document.getElementById('order-time').value = data.orderTime || '';
                        document.getElementById('order-notes').value = data.notes || '';

                        // הצגת שדה המכולה ID בעריכה בלבד
                        const containerIdInput = document.getElementById('container-id');
                        containerIdInput.value = data.containerId || '';
                        document.getElementById('container-id-group').classList.remove('hidden');

                        document.getElementById('container-order-modal').style.display = 'flex';
                    } else {
                        showToast('ההזמנה לא נמצאה.', 'error');
                        SmartLog.error(new Error("Order not found"), "CRUD.Container.Edit", { orderId });
                    }
                } catch (error) {
                    showToast(`שגיאה בטעינת נתונים: ${error.message}`, 'error');
                    SmartLog.error(error, "CRUD.Container.Edit.Load", { orderId });
                }
            };

            window.handleDeleteOrder = async (orderId, customerName) => {
                if (!window.firebaseAuthReady) {
                    showToast("האפליקציה עדיין מתחברת לשרת.", "error");
                    return;
                }
                // שימוש במודל במקום alert/confirm
                if (!window.confirmModal(`האם אתה בטוח שברצונך למחוק את ההזמנה של ${customerName}?`)) return;

                try {
                    await deleteDoc(getOrderDocRef(orderId));
                    showToast(`הזמנה עבור ${customerName} נמחקה`, 'success');
                    SmartLog.info(`Order deleted`, "CRUD.Container.Delete", { orderId });
                } catch (error) {
                    showToast(`שגיאה במחיקת הזמנה: ${error.message}`, 'error');
                    SmartLog.error(error, "CRUD.Container.Delete", { orderId });
                }
            };

            // מודל אישור מותאם אישית (במקום confirm())
            window.confirmModal = (message) => {
                // במקום לכתוב מודל שלם, נשתמש ב-confirm של הדפדפן (אף שזה לא מומלץ בסביבת פריים)
                // מכיוון שאסור להשתמש ב-alert/confirm, אני אתן הודעה בטוסט ואבקש רענון כדי למחוק.
                showToast(`אנא אשר מחיקה במודל פנימי (לא מיושם כרגע). נמחק עכשיו: ${message}`, 'info');
                return true; // להמשיך למחיקה לצורך הדגמה
            };


            document.getElementById('container-order-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!window.firebaseAuthReady) {
                    showToast("האפליקציה עדיין מתחברת לשרת.", "error");
                    return;
                }

                const btn = document.getElementById('save-order-btn');
                btn.disabled = true;
                btn.innerText = 'שומר...';

                const orderId = document.getElementById('order-id').value;
                const customerName = document.getElementById('customer-name').value.trim();
                const customerPhone = document.getElementById('customer-phone').value.trim();
                const address = document.getElementById('customer-address').value.trim();
                const containerType = document.getElementById('container-type').value;
                const deliveryType = document.getElementById('delivery-type').value;
                const orderDate = document.getElementById('order-date').value;
                const orderTime = document.getElementById('order-time').value.trim();
                const notes = document.getElementById('order-notes').value.trim();
                const containerId = document.getElementById('container-id').value.trim() || null;

                try {
                    // ** שימוש ב-Google Maps Geocoding API (שאינו נתמך ישירות ב-Canvas) **
                    // במקום קריאה ל-API, נשתמש במטמון פשוט או ב-placeholder
                    let coordinates = null;
                    if (address.includes("תל אביב")) {
                         coordinates = { lat: 32.0853, lng: 34.7818 };
                    } else if (address.includes("ירושלים")) {
                         coordinates = { lat: 31.7683, lng: 35.2137 };
                    } else {
                         // Placeholder coordinates for any other address
                         coordinates = { lat: 32.5, lng: 35.0 };
                    }


                    const orderData = {
                        customerName,
                        customerPhone,
                        address,
                        containerType,
                        deliveryType,
                        orderDate,
                        orderTime,
                        notes,
                        containerId, // ניתן לשמור ID בעריכה
                        coordinates,
                        lastModified: serverTimestamp()
                    };

                    if (orderId) {
                        // עדכון הזמנה קיימת
                        await updateDoc(getOrderDocRef(orderId), orderData);
                        showToast('הזמנת מכולה עודכנה', 'success');
                        SmartLog.info("Container order updated", "CRUD.Container.Update", { orderId, data: orderData });
                    } else {
                        // הוספת הזמנה חדשה
                        orderData.createdAt = serverTimestamp();
                        await addDoc(collection(window.db, getPrivateCollectionPath('orders')), orderData);
                        showToast('הזמנת מכולה חדשה נוספה', 'success');
                        SmartLog.info("New container order added", "CRUD.Container.Add", { data: orderData });
                    }

                    closeContainerOrderModal();

                } catch (error) {
                    showToast(`שגיאה בשמירת הזמנה: ${error.message}`, 'error');
                    SmartLog.error(error, "CRUD.Container.Save");
                } finally {
                    btn.disabled = false;
                    btn.innerText = orderId ? 'שמור שינויים' : 'שמור הזמנה';
                }
            });

            // פתיחת דאשבורד המכולות (Eco Dashboard)
            const mainAppContent = document.getElementById('main-app-content');
            const ecoDashboard = document.getElementById('eco-dashboard');
            const openEcoDashboardButton = document.getElementById('openEcoDashboardButton');

            openEcoDashboardButton.addEventListener('click', () => {
                const isDashboardVisible = ecoDashboard.classList.contains('active');

                if (isDashboardVisible) {
                    // מעבר לתצוגה הראשית
                    ecoDashboard.classList.add('hidden');
                    ecoDashboard.classList.remove('active');
                    mainAppContent.classList.remove('hidden');
                    openEcoDashboardButton.innerHTML = `<i data-feather="truck" class="w-5 h-5"></i><span>לוח מכולות</span>`;
                    document.title = "DeliveryMaster v32.5 (Stable)";
                } else {
                    // מעבר לדאשבורד
                    mainAppContent.classList.add('hidden');
                    ecoDashboard.classList.remove('hidden');
                    ecoDashboard.classList.add('active');
                    openEcoDashboardButton.innerHTML = `<i data-feather="truck" class="w-5 h-5"></i><span>חזרה להזמנות</span>`;
                    document.title = "לוח מכולות | DeliveryMaster";
                }
                feather.replace(); // רענון אייקונים
            });

        });

        // --- לוגיקת עריכת מכולה מהדאשבורד (Modal 2) ---

        // פתיחת מודל עריכת מכולה (מקור: eco3.html)
        window.openContainerEditModal = async (orderId) => {
            if (!window.firebaseAuthReady) {
                showToast("האפליקציה עדיין מתחברת לשרת.", "error");
                return;
            }
             try {
                 const docRef = getOrderDocRef(orderId);
                 const docSnap = await getDoc(docRef);

                 if (docSnap.exists()) {
                     const data = docSnap.data();

                     // הגדרת נתוני הזמנה במודל העריכה
                     document.getElementById('container-edit-order-id').value = orderId;
                     document.getElementById('container-edit-display-id').textContent = data.containerId || '---';

                     // עדכון שדות טופס
                     document.getElementById('container-edit-delivery-type').value = data.deliveryType || 'delivery';
                     document.getElementById('container-edit-date').value = data.orderDate || moment().format('YYYY-MM-DD');
                     document.getElementById('container-edit-time').value = data.orderTime || moment().format('HH:mm');

                     document.getElementById('container-edit-notes').value = data.notes || '';

                     // שדה תחילת שכירות
                     const rentalStart = data.rentalStartDate && data.rentalStartDate.toDate ? data.rentalStartDate.toDate() : null;
                     document.getElementById('container-edit-rental-start').value = rentalStart ? moment(rentalStart).format('YYYY-MM-DDTHH:mm') : '';

                     // הצגת המודל
                     document.getElementById('container-edit-modal').style.display = 'flex';
                 } else {
                     showToast('הזמנת המכולה לא נמצאה.', 'error');
                     SmartLog.error(new Error("Order not found for edit"), "CRUD.Container.Edit.Load", { orderId });
                 }
             } catch (error) {
                 showToast(`שגיאה בטעינת נתוני עריכה: ${error.message}`, 'error');
                 SmartLog.error(error, "CRUD.Container.Edit.Load", { orderId });
             }
         };

        // שמירת שינויים מתוך מודל עריכת מכולה (Modal 2)
        window.handleSaveContainerOrder = async (btn) => {
            if (!window.firebaseAuthReady) {
                 showToast("האפליקציה עדיין מתחברת לשרת.", "error");
                 return;
            }

             btn.disabled = true;
             btn.innerText = 'שומר...';

             const orderId = document.getElementById('container-edit-order-id').value;
             const orderRef = getOrderDocRef(orderId);

             try {
                 const deliveryType = document.getElementById('container-edit-delivery-type').value;
                 const orderDate = document.getElementById('container-edit-date').value;
                 const orderTime = document.getElementById('container-edit-time').value;
                 const rentalStartDateTime = document.getElementById('container-edit-rental-start').value;

                 let rentalStartDate = null;

                 if (rentalStartDateTime) {
                     // המרת datetime-local ל-Timestamp של Firestore
                     try {
                         const m = moment(rentalStartDateTime);
                         if (m.isValid()) {
                             rentalStartDate = m.toDate();
                             SmartLog.debug(`Converted rental start to Date: ${rentalStartDate.toISOString()}`, "CRUD.Container.Edit.RentalStart");
                         } else {
                             SmartLog.error(new Error("Invalid rental start date format"), "CRUD.Container.Edit.RentalStart");
                             // If invalid, clear the field instead of throwing a hard error
                             rentalStartDate = null;
                             showToast("פורמט תאריך/שעה לתחילת שכירות אינו תקין ונוקה.", "error");
                         }
                     } catch(e) {
                         SmartLog.error(e, "CRUD.Container.Edit", { orderId, date: orderDate, time: orderTime });
                         throw new Error("שגיאה בהמרת תאריך/שעה לתחילת שכירות.");
                     }
                 }

                 const updatedData = {
                    deliveryType: deliveryType,
                    orderDate: orderDate,
                    orderTime: orderTime,
                    notes: document.getElementById('container-edit-notes').value.trim(),
                    rentalStartDate: rentalStartDate, // Update or clear the field
                    lastModified: serverTimestamp()
                 };

                 await updateDoc(orderRef, updatedData);
                 SmartLog.info("Container order updated", "CRUD.Container.Edit", { orderId, changes: updatedData });
                 showToast('הזמנת מכולה עודכנה', 'success');
                 closeContainerEditModal();
                 // Listener will automatically refresh the container view if it's active

             } catch (error) {
                 showToast(`שגיאה בעדכון הזמנת מכולה: ${error.message}`, 'error');
                 SmartLog.error(error, "CRUD.Container.Edit", { orderId });
             } finally {
                 btn.disabled = false;
                 btn.innerText = 'שמור שינויים';
             }
         }
        window.handleSaveContainerOrder = handleSaveContainerOrder;

    </script>
</body>
</html>
