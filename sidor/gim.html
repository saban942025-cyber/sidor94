<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v32.5 (Stable)</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/feather-icons"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
            --text-dark: #1f2937; /* gray-800 */
            --text-light: #6b7280; /* gray-500 */
            --text-dark-nav: #d1d5db; /* gray-300 */
            --bg-dark-nav: #1f2937; /* slate-800 */
            --bg-dark-nav-hover: #374151; /* slate-700 */
            --danger-soft: #fee2e2; /* red-100 */
            --danger-medium: #f87171; /* red-400 */
            --danger-dark: #dc2626; /* red-600 */
        }
        body {
            font-family: 'Inter', 'Arial', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            overflow: hidden;
        }

        /* Layout */
        .app-layout {
            display: grid;
            grid-template-columns: auto 1fr;
            height: 100vh;
        }

        /* App Views */
        .app-view {
            width: 100%;
            height: 100vh;
            overflow: hidden; /* Prevent scrolling on main views */
            display: none; /* Hidden by default */
        }
        .app-view.active {
            display: block; /* Show active view */
        }

        #view-dashboard {
            display: grid; /* Use grid for dashboard */
            grid-template-columns: 1fr 350px;
            overflow: hidden;
        }
        .app-view.active#view-dashboard { display: grid; } /* Override default block for dashboard */

        #view-history, #view-containers { /* Allow scrolling for History and Containers */
            overflow-y: auto;
            padding: 1.5rem 2.5rem;
        }

        #view-driver-history {
             display: grid; /* Use grid for driver history */
             grid-template-columns: 300px 1fr; /* Sidebar and Map */
             height: 100vh;
        }
        .app-view.active#view-driver-history { display: grid; } /* Override default block */

        #map-container {
            position: relative;
            background-color: #e0e0e0;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        #side-panel {
            background-color: var(--bg-white);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Navbar */
        #navbar {
            background-color: var(--bg-dark-nav);
            border-left: 1px solid var(--border-color);
            color: white;
            z-index: 10;
        }
        #navbar .text-xl { color: white; }
        .nav-link { transition: all 0.2s; color: var(--text-dark-nav); }
        .nav-link:hover { background-color: var(--bg-dark-nav-hover); color: white; }
        .nav-link.active { background-color: var(--primary-color); color: white; border-right: 3px solid #60a5fa; }
        .nav-link-special { color: var(--text-dark-nav); background-color: var(--bg-dark-nav-hover); }
        .nav-link-special:hover { background-color: var(--primary-color); color: white; }
        #navbar .hidden.lg\\:block { color: white; }
        #navbar #last-updated { color: var(--text-light); }

        /* Side Panel */
        #side-panel-lists { flex: 1; overflow-y: auto; position: relative; }
        .panel-list { overflow-y: auto; position: relative; }
        .order-card, .driver-card { padding: 1rem; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; }
        .order-card:hover, .driver-card:hover { background-color: #fafafa; }
        .order-card.active, .driver-card.active { background-color: #eff6ff; border-right: 3px solid var(--primary-color); }
        .order-card .font-bold { color: var(--primary-dark); }

        /* Details Panel */
        #details-panel { height: 300px; overflow-y: auto; border-top: 2px solid var(--border-color); background: #fdfdfd; padding: 1rem; display: none; position: relative; }
        #details-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        #details-panel h4 { font-weight: 700; color: var(--text-dark); }
        #details-panel ul { list-style-type: none; padding: 0; margin: 0; }
        #details-panel li { font-size: 0.9rem; margin-bottom: 4px; color: var(--text-light); }
        #details-panel .status-line { display: flex; align-items: center; gap: 0.5rem; }
        #details-panel li .dist { font-weight: 500; color: var(--text-dark); display: inline-block; min-width: 60px; text-align: left; }
        #details-close-btn, #details-copy-link-btn { cursor: pointer; color: var(--text-light); }
        #details-close-btn:hover, #details-copy-link-btn:hover { color: var(--text-dark); }
        .status-change-btn { background: none; border: none; color: var(--primary-color); font-size: 0.8rem; font-weight: 500; cursor: pointer; padding: 2px 4px; border-radius: 4px; }
        .status-change-btn:hover { background-color: #eff6ff; color: var(--primary-dark); }

        /* History & Customer Management View */
         #view-history .tab-button, #view-containers .tab-button { /* Apply to both */
            padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; color: var(--text-light); }
         #view-history .tab-button.active, #view-containers .tab-button.active { border-bottom-color: var(--primary-color); color: var(--primary-color); }
        .history-table tbody tr:hover, .customer-table tbody tr:hover, .container-table tbody tr:hover { background-color: #f9fafb; }
        .customer-table tbody tr:hover, .container-table tbody tr:hover { cursor: pointer; } /* Make container table rows clickable for editing */
        .action-button { background-color: var(--primary-color); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; margin-left: 4px; }
        .action-button:hover { background-color: var(--primary-dark); }
        .action-button-secondary { background-color: var(--text-light); }
        .action-button-secondary:hover { background-color: var(--text-dark); }

        /* Driver History View */
        #driver-history-sidebar { background-color: var(--bg-white); border-left: 1px solid var(--border-color); padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        #driver-history-map { background-color: #e0e0e0; position: relative; }

        /* Containers View */
        #view-containers h2 { font-size: 1.8rem; font-weight: 700; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; }
        .warehouse-section { margin-bottom: 2rem; }
        .warehouse-section h3 { font-size: 1.3rem; font-weight: 600; margin-bottom: 1rem; color: var(--primary-dark); }
        .container-table th, .container-table td { padding: 0.75rem 1rem; text-align: right; border-bottom: 1px solid var(--border-color); vertical-align: middle; font-size: 0.9rem; }
        .container-table th { font-weight: 500; color: var(--text-light); background-color: #f9fafb; }
        .container-table tbody tr.overdue { background-color: var(--danger-soft); animation: subtle-pulse 1.5s infinite ease-in-out; }
        .container-table td .edit-btn { color: var(--primary-color); cursor: pointer; }
        .container-table td .edit-btn:hover { color: var(--primary-dark); }
        .progress-bar-container { width: 100%; background-color: var(--border-color); border-radius: 99px; overflow: hidden; height: 10px; }
        .progress-bar { height: 100%; background-color: var(--primary-color); border-radius: 99px; transition: width 0.3s ease; }
        .progress-bar.overdue { background-color: var(--danger-medium); }
        .container-summary { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); font-weight: 600; }
        @keyframes subtle-pulse { 0% { background-color: var(--danger-soft); } 50% { background-color: #fecaca; /* red-200 */} 100% { background-color: var(--danger-soft); } }

        /* Status Colors */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-active { background-color: #22c55e; } .status-stuck { background-color: #ef4444; } .status-inactive { background-color: #9ca3af; }

        /* Leaflet Customizations */
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { margin: 13px 20px; font-family: 'Inter', sans-serif; }
        .leaflet-popup-content h4 { font-weight: 700; margin-bottom: 8px; }
        .leaflet-popup-content p { margin: 4px 0; color: var(--text-light); }

        /* Loader */
        .loader-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; z-index: 10; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast Notification */
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 5000; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 12px 20px; background-color: var(--text-dark); color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: all 0.3s ease; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: #22c55e; } .toast.error { background-color: #ef4444; }

        /* Modal Dialog */
        #new-order-modal, #customer-edit-modal, #container-edit-modal { /* Added container modal */
            max-width: 600px; border-radius: 12px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 0; }
        #new-order-modal::backdrop, #customer-edit-modal::backdrop, #container-edit-modal::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }

        /* Responsive */
        @media (max-width: 1024px) {
            #view-dashboard { grid-template-columns: 1fr; }
            #side-panel { position: fixed; bottom: 0; left: 0; right: 0; height: 40vh; z-index: 2000; border-right: none; border-top: 1px solid var(--border-color); transform: translateY(100%); transition: transform 0.3s ease; }
            #side-panel.open { transform: translateY(0); }
            #navbar { display: flex; width: 100%; z-index: 2001; border-left: none; border-bottom: 1px solid var(--border-color); }
            .app-layout { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            .nav-link { flex: 1; justify-content: center; } .nav-link span { display: none; } .nav-link.active { border-right: none; border-bottom: 3px solid var(--primary-color); }
            #details-panel { height: 200px; }
            #view-driver-history { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            #driver-history-sidebar { grid-row: 1 / 2; border-left: none; border-bottom: 1px solid var(--border-color); }
            #driver-history-map { grid-row: 2 / 3; }
            #view-history, #view-containers { padding: 1rem; } /* Less padding on mobile */
        }
    </style>
</head>
<body class="antialiased">

    <div class="app-layout">
        <nav id="navbar" class="w-20 lg:w-64 flex flex-col p-4 space-y-4">
            <div class="hidden lg:flex items-center space-x-2 space-x-reverse px-2 mb-4">
                <i data-feather="truck" class="w-8 h-8 text-blue-500"></i>
                <span class="text-xl font-bold">DeliveryMaster</span>
            </div>

            <a href="#" class="nav-link active flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="showView('dashboard')">
                <i data-feather="map" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">דשבורד</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="showView('history')">
                <i data-feather="archive" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">היסטוריה ולקוחות</span>
            </a>
             <a href="#" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="showView('driver-history')">
                <i data-feather="navigation" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">היסטוריית נהגים</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="showView('containers')">
                 <i data-feather="hard-drive" class="w-6 h-6"></i> <span class="font-semibold text-lg hidden lg:block">מכולות</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="openNewOrderForm()">
                <i data-feather="plus-circle" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">הזמנה חדשה</span>
            </a>
            <a href="log.html" target="_blank" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg">
                <i data-feather="file-text" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">לוגים</span>
            </a>

            <div class="flex-grow"></div> <a href="#" class="nav-link nav-link-special flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="sendGlobalPing()">
                <i data-feather="bell" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">שלח התראה גלובלית</span>
            </a>

            <div class="hidden lg:block border-t border-gray-700 pt-4 mt-4">
                <div class="text-sm">שלום, <span class="font-semibold">מנהל</span></div>
                <div id="last-updated" class="text-xs">מתחבר...</div>
            </div>
        </nav>

        <div class="relative">
            <main id="view-dashboard" class="app-view active"> <div id="map-container">
                    <div id="map"></div>
                    <div id="map-loader" class="loader-container">
                        <div class="loader"></div>
                        <span class="ml-4 font-semibold">טוען מפה ומאמת...</span>
                    </div>
                </div>

                <aside id="side-panel">
                    <div class="flex border-b border-gray-200">
                        <button id="tab-orders" class="flex-1 p-4 font-semibold text-center border-b-2 border-blue-500 text-blue-500" onclick="showPanelTab('orders')">
                            הזמנות
                        </button>
                        <button id="tab-drivers" class="flex-1 p-4 font-semibold text-center border-b-2 border-transparent text-gray-500" onclick="showPanelTab('drivers')">
                            נהגים
                        </button>
                    </div>

                    <div class="p-3 border-b border-gray-200">
                        <input type="text" id="search-input" placeholder="חפש הזמנה או נהג..." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300" onkeyup="filterLists()">
                    </div>

                    <div id="side-panel-lists" class="relative">
                        <div id="orders-list" class="panel-list">
                            <div class="loader-container"><div class="loader"></div></div>
                        </div>

                        <div id="drivers-list" class="panel-list" style="display: none;">
                            <div class="loader-container"><div class="loader"></div></div>
                        </div>
                    </div>

                    <div id="details-panel">
                        <div class="text-center text-gray-500 p-8">בחר נהג או הזמנה להצגת פרטים</div>
                    </div>
                </aside>
            </main>

            <div id="view-history" class="app-view">
                <div class="flex border-b border-gray-200 mb-6">
                    <button class="tab-button active" onclick="showHistoryTab('orders')">היסטוריית הזמנות</button>
                    <button class="tab-button" onclick="showHistoryTab('customers')">ניהול לקוחות</button>
                </div>

                <div id="history-orders-content">
                    <h2 class="text-2xl font-bold mb-4">היסטוריית הזמנות</h2>
                    <div class="flex flex-col lg:flex-row gap-4 mb-4 p-4 bg-white rounded-lg shadow-sm">
                        <input type="text" id="history-search" placeholder="חפש לפי מס' הזמנה, לקוח, נהג, כתובת..." class="flex-grow p-2 border rounded-md">
                        <div class="flex gap-4">
                            <input type="date" id="history-date-from" class="p-2 border rounded-md" title="מתאריך">
                            <input type="date" id="history-date-to" class="p-2 border rounded-md" title="עד תאריך">
                        </div>
                        <button id="history-filter-btn" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">סנן</button>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 history-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">מס' הזמנה</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">לקוח</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">נהג</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">כתובת</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">סטטוס</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">תאריך</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">פעולות</th>
                                    </tr>
                                </thead>
                                <tbody id="history-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="7" class="text-center p-8 text-gray-500">טוען היסטוריה...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                 </div>

                 <div id="history-customers-content" style="display: none;">
                     <h2 class="text-2xl font-bold mb-4">ניהול לקוחות</h2>
                     <div class="flex flex-col lg:flex-row gap-4 mb-4 p-4 bg-white rounded-lg shadow-sm">
                        <input type="text" id="customer-search-input" placeholder="חפש לפי שם, טלפון, מספר לקוח..." class="flex-grow p-2 border rounded-md" onkeyup="renderCustomerTable()">
                     </div>
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 customer-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">שם</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">מספר לקוח</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">טלפון</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">כתובת</th>
                                    </tr>
                                </thead>
                                <tbody id="customer-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="4" class="text-center p-8 text-gray-500">טוען לקוחות...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                 </div>
            </div>

             <div id="view-driver-history" class="app-view">
                 <aside id="driver-history-sidebar" class="bg-white p-4 border-l border-gray-200">
                     <h3 class="text-xl font-semibold mb-4">היסטוריית נהג</h3>
                     <div>
                         <label for="driver-select" class="block text-sm font-medium text-gray-700 mb-1">בחר נהג</label>
                         <select id="driver-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                             <option value="">טוען נהגים...</option>
                         </select>
                     </div>
                     <div class="grid grid-cols-2 gap-2">
                         <div>
                            <label for="driver-history-date-from" class="block text-sm font-medium text-gray-700 mb-1">מתאריך</label>
                            <input type="date" id="driver-history-date-from" class="w-full p-2 border rounded-md">
                         </div>
                         <div>
                            <label for="driver-history-time-from" class="block text-sm font-medium text-gray-700 mb-1">משעה</label>
                             <input type="time" id="driver-history-time-from" class="w-full p-2 border rounded-md">
                         </div>
                         <div>
                             <label for="driver-history-date-to" class="block text-sm font-medium text-gray-700 mb-1">עד תאריך</label>
                             <input type="date" id="driver-history-date-to" class="w-full p-2 border rounded-md">
                         </div>
                         <div>
                             <label for="driver-history-time-to" class="block text-sm font-medium text-gray-700 mb-1">עד שעה</label>
                             <input type="time" id="driver-history-time-to" class="w-full p-2 border rounded-md">
                         </div>
                     </div>
                     <button id="driver-history-filter-btn" class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">הצג מסלול</button>
                     <div class="mt-4 border-t pt-4 text-sm text-gray-600">
                         <p><strong>סטטוס אחרון:</strong> <span id="driver-last-status">-</span></p>
                         <p><strong>מרחק משוער:</strong> <span id="driver-distance-traveled">-</span> ק"מ</p>
                         <p><strong>זמן בין הזמנות (ממוצע):</strong> <span id="driver-avg-time">-</span> דקות</p>
                     </div>
                      <div class="mt-auto text-xs text-gray-500">
                        * נתוני היסטוריה דורשים מבנה נתונים ייעודי ב-Firestore (למשל, קולקציית `locationHistory`).
                     </div>
                 </aside>
                 <div id="driver-history-map" class="relative">
                     <div class="absolute top-2 right-2 z-10 bg-white p-2 rounded shadow text-sm">
                         מציג מסלול עבור: <span id="driver-history-map-label" class="font-semibold">-</span>
                     </div>
                     <div class="w-full h-full bg-gray-300 flex items-center justify-center text-gray-500">
                         טוען מפת היסטוריה...
                         </div>
                 </div>
            </div>

             <div id="view-containers" class="app-view">
                <h2>ניהול מכולות פעילות</h2>

                <div class="loader-container" id="containers-loader">
                    <div class="loader"></div> <span class="ml-2">טוען נתוני מכולות...</span>
                </div>

                <div id="containers-content">
                    </div>

                <div class="container-summary" id="containers-summary">
                    סה"כ מכולות פעילות: <span id="total-active-containers">0</span>
                </div>
            </div>

        </div>
    </div>

    <div id="toast-container"></div>

    <dialog id="new-order-modal">
        <form onsubmit="submitNewOrder(event)">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold">יצירת הזמנה חדשה</h3>
                <button type="button" class="text-gray-500 hover:text-gray-800" onclick="closeNewOrderForm()">
                    <i data-feather="x"></i>
                </button>
            </div>

            <div class="p-6 space-y-4">
                <div>
                    <label for="customer-search" class="block text-sm font-medium mb-1">חפש לקוח קיים או הקלד שם ללקוח חדש</label>
                    <input type="text" id="customer-search" list="customer-list" class="w-full p-2 border rounded-md" oninput="handleCustomerSearch(this.value)" autocomplete="off">
                    <datalist id="customer-list"></datalist>
                </div>

                <div id="new-customer-fields" class="p-4 bg-blue-50 border border-blue-200 rounded-lg space-y-3" style="display: none;">
                    <p class="font-semibold text-blue-700">פרטי לקוח חדש</p>
                    <input type="hidden" id="customer-id-new">
                    <input type="text" id="customer-name-new" placeholder="שם לקוח מלא" class="w-full p-2 border rounded-md">
                    <input type="text" id="customer-phone-new" placeholder="טלפון" class="w-full p-2 border rounded-md">
                    <div class="form-grid">
                        <input type="text" id="customer-street-new" placeholder="רחוב" class="w-full p-2 border rounded-md">
                        <input type="text" id="customer-streetnum-new" placeholder="מספר" class="w-full p-2 border rounded-md">
                        <input type="text" id="customer-city-new" placeholder="עיר" class="w-full p-2 border rounded-md">
                    </div>
                    <input type="text" id="customer-contact-new" placeholder="איש קשר" class="w-full p-2 border rounded-md">
                     <input type="text" id="customer-number-new" placeholder="מספר לקוח (אופציונלי)" class="w-full p-2 border rounded-md">
                </div>

                <div id="existing-customer-display" class="p-4 bg-gray-50 border rounded-lg" style="display: none;">
                    <input type="hidden" id="customer-id-existing">
                    <p><strong>לקוח:</strong> <span id="customer-name-display"></span> <span id="customer-number-display" class="text-sm text-gray-500"></span></p>
                    <p><strong>כתובת:</strong> <span id="customer-address-display"></span></p>
                    <p><strong>טלפון:</strong> <span id="customer-phone-display"></span></p>
                </div>

                <hr>

                <div>
                    <label for="order-number" class="block text-sm font-medium mb-1">מספר הזמנה (אופציונלי)</label>
                    <input type="text" id="order-number" placeholder="השאר ריק למזהה אוטומטי" class="w-full p-2 border rounded-md mb-4">
                 </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" id="order-date" class="w-full p-2 border rounded-md" required>
                        <input type="time" id="order-time" class="w-full p-2 border rounded-md">
                    </div>
                    <select id="order-delivery-type" class="w-full p-2 border rounded-md" required>
                        <option value="">סוג הובלה</option>
                        <option value="הובלת מנוף">הובלת מנוף</option>
                        <option value="הובלת משאית">הובלת משאית</option>
                        <option value="איסוף עצמי">איסוף עצמי</option>
                        <option value="עבודת מנוף">עבודת מנוף</option>
                        <option value="עבודת מנוף 15 מטר">עבודת מנוף 15 מטר</option>
                        <option value="הצבת מכולה">הצבת מכולה</option>
                        <option value="החלפת מכולה">החלפת מכולה</option>
                        <option value="הוצאת מכולה">הוצאת מכולה</option>
                        <option value="פינוי במקום">פינוי במקום</option>
                        <option value="פריקה ידנית">פריקה ידנית</option>
                    </select>
                    <select id="order-warehouse" class="w-full p-2 border rounded-md" required>
                        <option value="">בחר מחסן</option>
                        <option value="החרש">החרש</option>
                        <option value="התלמיד">התלמיד</option>
                        <option value="30-שארק">30-שארק (מכולה)</option>
                        <option value="32-כראדי">32-כראדי (מכולה)</option>
                        <option value="40-כראדי">40-כראדי (מכולה)</option>
                    </select>
                    </div>

                <textarea id="order-notes" rows="3" placeholder="הערות להזמנה..." class="w-full p-2 border rounded-md"></textarea>
            </div>

            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-3 space-x-reverse">
                <button type="button" class="px-4 py-2 bg-white border rounded-md hover:bg-gray-50" onclick="closeNewOrderForm()">
                    ביטול
                </button>
                <button type="submit" id="submit-order-btn" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                    צור הזמנה
                </button>
            </div>
        </form>
    </dialog>

    <dialog id="customer-edit-modal">
        <form onsubmit="handleSaveCustomer(event)">
            <input type="hidden" id="customer-edit-id">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold" id="customer-edit-title">עריכת פרטי לקוח</h3>
                <button type="button" class="text-gray-500 hover:text-gray-800" onclick="closeCustomerEditModal()">
                    <i data-feather="x"></i>
                </button>
            </div>

            <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                 <div class="form-grid">
                     <div>
                        <label for="customer-edit-name" class="block text-sm font-medium mb-1">שם לקוח</label>
                        <input type="text" id="customer-edit-name" class="w-full p-2 border rounded-md" required>
                     </div>
                     <div>
                        <label for="customer-edit-number" class="block text-sm font-medium mb-1">מספר לקוח</label>
                        <input type="text" id="customer-edit-number" class="w-full p-2 border rounded-md">
                     </div>
                     <div>
                         <label for="customer-edit-phone" class="block text-sm font-medium mb-1">טלפון</label>
                        <input type="tel" id="customer-edit-phone" class="w-full p-2 border rounded-md" required>
                     </div>
                     <div>
                         <label for="customer-edit-contact" class="block text-sm font-medium mb-1">איש קשר</label>
                        <input type="text" id="customer-edit-contact" class="w-full p-2 border rounded-md">
                     </div>
                 </div>

                 <hr class="my-4">

                 <p class="font-semibold text-gray-700">כתובת ברירת מחדל</p>
                 <div class="form-grid">
                    <input type="text" id="customer-edit-street" placeholder="רחוב" class="w-full p-2 border rounded-md" required>
                    <input type="text" id="customer-edit-streetnum" placeholder="מספר" class="w-full p-2 border rounded-md" required>
                    <input type="text" id="customer-edit-city" placeholder="עיר" class="w-full p-2 border rounded-md" required>
                 </div>

                 <div>
                    <label for="customer-edit-coords" class="block text-sm font-medium mb-1">קואורדינטות (הדבק מ-Google Maps)</label>
                    <input type="text" id="customer-edit-coords" placeholder="לדוגמה: 32.12345, 34.98765" class="w-full p-2 border rounded-md">
                    <p class="text-xs text-gray-500 mt-1">אופציונלי. אם יוזן, ישמש למיקום מדויק בהזמנות לכתובת זו.</p>
                 </div>

                 <div class="mt-4 border-t pt-4">
                    <h4 class="text-sm font-medium text-gray-600 mb-2">היסטוריית שינויים (אחרונים)</h4>
                    <ul id="customer-audit-log" class="text-xs text-gray-500 space-y-1 max-h-24 overflow-y-auto">
                        <li>טוען היסטוריה...</li>
                    </ul>
                 </div>
            </div>

            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-3 space-x-reverse">
                <button type="button" class="px-4 py-2 bg-white border rounded-md hover:bg-gray-50" onclick="closeCustomerEditModal()">
                    ביטול
                </button>
                <button type="submit" id="customer-save-btn" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                    שמור שינויים
                </button>
            </div>
        </form>
    </dialog>

    <dialog id="container-edit-modal">
        <form onsubmit="handleSaveContainerOrder(event)">
            <input type="hidden" id="container-edit-order-id">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold" id="container-edit-title">עריכת הזמנת מכולה</h3>
                <button type="button" class="text-gray-500 hover:text-gray-800" onclick="closeContainerEditModal()">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                <p><strong>לקוח:</strong> <span id="container-edit-customer-name"></span></p>
                <p><strong>כתובת:</strong> <span id="container-edit-address"></span></p>
                <p><strong>מחסן:</strong> <span id="container-edit-warehouse"></span></p>
                <hr>
                <div>
                    <label for="container-edit-delivery-type" class="block text-sm font-medium mb-1">סוג פעולה</label>
                    <select id="container-edit-delivery-type" class="w-full p-2 border rounded-md">
                        <option value="הצבת מכולה">הצבת מכולה</option>
                        <option value="החלפת מכולה">החלפת מכולה</option>
                        <option value="הוצאת מכולה">הוצאת מכולה</option>
                        <option value="פינוי במקום">פינוי במקום</option>
                        </select>
                 </div>
                 <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label for="container-edit-date" class="block text-sm font-medium mb-1">תאריך פעולה</label>
                        <input type="date" id="container-edit-date" class="w-full p-2 border rounded-md">
                     </div>
                      <div>
                        <label for="container-edit-time" class="block text-sm font-medium mb-1">שעת פעולה</label>
                        <input type="time" id="container-edit-time" class="w-full p-2 border rounded-md">
                     </div>
                 </div>
                 <div>
                    <label for="container-edit-notes" class="block text-sm font-medium mb-1">הערות</label>
                    <textarea id="container-edit-notes" rows="3" class="w-full p-2 border rounded-md"></textarea>
                 </div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-3 space-x-reverse">
                <button type="button" class="px-4 py-2 bg-white border rounded-md hover:bg-gray-50" onclick="closeContainerEditModal()">
                    ביטול
                </button>
                <button type="submit" id="container-save-btn" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                    שמור שינויים
                </button>
            </div>
        </form>
    </dialog>


    <script type="module">
        // --- [FIX] שדרוג גרסאות Firebase SDK ל-v10 יציב ---
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, query, orderBy, addDoc, updateDoc, serverTimestamp, deleteDoc, arrayUnion, where, getDocs, setDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getFunctions } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

        // --- [FIX] אתחול Firebase יציב מבוסס משתני סביבה ---
        // שימוש במשתנים הגלובליים __firebase_config ו-__initial_auth_token
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                // שימוש בערכי המקור כ-fallback למקרה שהמשתנים לא קיימים
                apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", authDomain: "saban94-78949.firebaseapp.com", projectId: "saban94-78949",
                storageBucket: "saban94-78949.firebasestorage.app", messagingSenderId: "41553157903", appId: "1:41553157903:web:cc33d252cff023be97a87a", measurementId: "G-XV6RZDESSB"
              };
        const providedToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db, functions;
        let initializationError = null;
        let isAuthReady = false; // [FIX] דגל גלובלי לסטטוס אימות, מחליף בדיקות חוזרות ב-SmartLog

        try {
            app = getApps().length ? getApp() : initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            functions = getFunctions(app, 'europe-west1');
        } catch (error) {
            console.error("CRITICAL: Firebase init failed!", error);
            initializationError = error;
        }
        
        // --- *** START: SmartLog (UPGRADED) *** ---
        // [FIX] לוגיקה משודרגת של SmartLog לשימוש בדגל isAuthReady
        const LOG_COLLECTION = 'system_logs_v3';
        const sessionId = (Date.now() + Math.random()).toString(36);
        let isDbAvailable = !!db;

        const writeLog = async (level, message, origin, context = {}, category = null, solution = null) => {
            const consoleArgs = [`[${origin}] ${level}:`, message];
            if (Object.keys(context).length > 0) consoleArgs.push(context);
            if (category) consoleArgs.push(`[Cat: ${category}]`);
            if (solution) consoleArgs.push(`[Sol: ${solution}]`);

            switch (level) {
                case 'INFO': console.log(...consoleArgs); break;
                case 'WARN': console.warn(...consoleArgs); break;
                case 'ERROR': console.error(...consoleArgs); break;
                default: console.log(...consoleArgs);
            }

            // [FIX] בדיקה יעילה יותר. לא מנסה לכתוב ל-DB אם האימות לא הושלם בהצלחה.
            if (!isDbAvailable || !isAuthReady || !auth?.currentUser) {
                return;
            }

            try {
                const user = auth.currentUser;
                const userContext = { uid: user.uid, isAnonymous: user.isAnonymous };
                const logEntry = {
                    timestamp: serverTimestamp(),
                    level,
                    message: String(message),
                    origin,
                    context: { ...JSON.parse(JSON.stringify(context || {})), sessionId, userAgent: navigator.userAgent || 'N/A', page: window.location.pathname || 'N/A' },
                    user: userContext,
                    category: category || null,
                    solution: solution || null
                };
                await addDoc(collection(db, LOG_COLLECTION), logEntry);
            } catch (error) {
                console.error("SmartLog FATAL ERROR writing to Firestore.", error, { originalMessage: message });
                if (error.code === 'permission-denied' || error.message.includes('permissions')) {
                    console.warn("SmartLog: Disabling Firestore logging due to permissions.");
                    isDbAvailable = false;
                }
            }
        };

        const SmartLog = {
            info: (msg, origin, ctx = {}) => { writeLog('INFO', msg, origin, ctx); },
            warn: (msg, origin, ctx = {}, cat = null, sol = null) => { writeLog('WARN', msg, origin, ctx, cat, sol); },
            error: (err, origin, ctx = {}, cat = null, sol = null) => {
                const msg = err instanceof Error ? err.message : String(err);
                const stack = err instanceof Error ? err.stack : 'N/A';
                writeLog('ERROR', msg, origin, { ...ctx, stack }, cat, sol);
            }
        };
        // --- *** END: SmartLog DEFINITION *** ---


        // --- [NEW] פונקציית אתחול אימות חדשה ---
        // מחליפה את פונקציית ensureAuth המקורית
        async function initializeAuth() {
            if (initializationError) {
                throw new Error(`Firebase init failed: ${initializationError.message}`);
            }
            if (!auth) {
                throw new Error("Firebase Auth object not initialized.");
            }
            
            try {
                if (providedToken) {
                    SmartLog.info("Authenticating with provided token...", "Init.Auth");
                    await signInWithCustomToken(auth, providedToken);
                } else {
                    SmartLog.warn("No provided token, signing in anonymously...", "Init.Auth");
                    await signInAnonymously(auth);
                }
                SmartLog.info(`Auth successful. User: ${auth.currentUser?.uid}`, "Init.Auth");
                isAuthReady = true; // [SUCCESS] קובע את הדגל הגלובלי
            } catch (error) {
                SmartLog.error(error, "Init.Auth", { message: "Critical auth failure." });
                isAuthReady = false; // [FAIL] מוודא שהדגל נשאר שקרי
                throw error; // זורק את השגיאה הלאה ל-initializeApplication
            }
        }

        // [FIX] ה-Promise שהאפליקציה תחכה לו.
        const authReadyPromise = initializeAuth();


        // --- CONFIG & STATE ---
        const ISRAEL_CENTER = [32.0853, 34.7818];
        const WAREHOUSE_LOCATIONS = {
            "החרש": [32.13266165049073, 34.898196599998755],
            "התלמיד": [32.16303427408473, 34.894926705310006],
            "30-שארק": null, "32-כראדי": null, "40-כראדי": null
        };
        const VIRTUAL_WAREHOUSES = ["30-שארק", "32-כראדי", "40-כראדי"];
        const ALLOWED_STATUSES = ["חדש", "שויך", "בדרך", "הושלם", "בוטל"];
        const CONTAINER_RENTAL_LIMIT_DAYS = 10;
        const CONTAINER_DELIVERY_TYPES = ["הצבת מכולה", "החלפת מכולה", "הוצאת מכולה", "פינוי במקום"];

        let state = { orders: [], drivers: [], liveLocations: {}, customers: [], activeContainers: [] };
        let map; let driverHistoryMap; let driverMarkers = {}; let orderMarkers = {}; let containerMarkers = {}; let driverHistoryPolyline = null;

        // --- ICONS (Leaflet) ---
        const driverIconActive = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] });
        const driverIconStuck = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] });
        const orderIconNew = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] });
        // --- [NEW] ICONS for Containers ---
        const containerIconActive = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] });
        const containerIconOverdue = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] });


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
             try {
                feather.replace();
             } catch (e) {
                 SmartLog.error(e, "Init.Feather", { message: "Feather icons failed on DOMContentLoaded" });
                 setTimeout(() => { try { feather.replace(); } catch (err) { SmartLog.error(err, "Init.Feather", { message: "Feather retry failed" }); } }, 500);
             }
             initializeApplication();
             try {
                const orderDateInput = document.getElementById('order-date');
                if(orderDateInput) orderDateInput.value = new Date().toISOString().split('T')[0];
             } catch(e) { SmartLog.error(e, "Init.DOM", { element: "order-date" }); }
        });

        async function initializeApplication() {
            SmartLog.info("v32.5: Initializing...", "Init");
            try {
                updateStatus("מפעיל מפות...");
                initMap();
                initDriverHistoryMap();
                showLoader('orders-list', true);
                showLoader('drivers-list', true);
                
                updateStatus("מאמת משתמש...");
                await authReadyPromise; // [FIX] ממתין לפונקציית האימות החדשה
                
                updateStatus("מחבר מאזינים...");
                listenToDrivers();
                listenToOrders();
                listenToLocations();
                listenToCustomers();
                
                document.getElementById('history-filter-btn')?.addEventListener('click', renderHistoryTable);
                document.getElementById('driver-history-filter-btn')?.addEventListener('click', fetchAndDrawDriverRoute);
                
                showLoader('map-loader', false);
                updateStatus("מחובר ומאזין");
            } catch (error) {
                 SmartLog.error(error, "Init.Critical", { message: "Application initialization failed." });
                 updateStatus(`שגיאת אתחול: ${error.message}`, true);
                 const mapLoaderEl = document.getElementById('map-loader');
                 if (mapLoaderEl) mapLoaderEl.innerHTML = `<div class="p-4 text-red-600 font-semibold">שגיאת אתחול קריטית. בדוק קונסול.</div>`;
                 showToast(`שגיאת אתחול: ${error.message}`, 'error');
             }
        }

        function initMap() {
             try {
                 if (map) map.remove(); // Prevent duplicate maps
                 map = L.map('map').setView(ISRAEL_CENTER, 9);
                 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
                 SmartLog.info("Dashboard Map initialized", "Init.Map");
             } catch (error) {
                 SmartLog.error(error, "Init.Map");
                  const mapEl = document.getElementById('map');
                  if (mapEl) mapEl.innerHTML = `<div class="p-8 text-center text-red-600">שגיאה בטעינת המפה הראשית.</div>`;
             }
         }
        function initDriverHistoryMap() {
             try {
                 if (driverHistoryMap) driverHistoryMap.remove(); // Prevent duplicate maps
                 const mapContainer = document.getElementById('driver-history-map');
                 if (!mapContainer) throw new Error("Driver history map container not found");
                 mapContainer.innerHTML = '';
                 driverHistoryMap = L.map('driver-history-map').setView(ISRAEL_CENTER, 9);
                 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(driverHistoryMap);
                 SmartLog.info("Driver History Map initialized", "Init.Map.History");
             } catch (error) {
                 SmartLog.error(error, "Init.Map.History");
                 const mapContainer = document.getElementById('driver-history-map');
                 if(mapContainer) mapContainer.innerHTML = `<div class="p-8 text-center text-red-600">שגיאה בטעינת מפת ההיסטוריה.</div>`;
             }
         }
        function updateStatus(message, isError = false) {
            try {
                const el = document.getElementById('last-updated');
                if (el) { el.innerText = message; el.style.color = isError ? '#ef4444' : '#6b7280'; }
                else { console.warn("Could not find #last-updated element to update status:", message); }
            } catch (e) { SmartLog.error(e, "UI.UpdateStatus", { message }); }
         }

        // --- FIRESTORE LISTENERS (REAL-TIME) ---
        function listenToDrivers() {
             try {
                SmartLog.info("Listening to Drivers...", "Firestore.Listen");
                const q = query(collection(db, "drivers"), orderBy("name"));
                onSnapshot(q, (snapshot) => {
                    SmartLog.info(`Drivers: ${snapshot.docs.length} docs.`, "Firestore.Snapshot");
                    state.drivers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderDrivers();
                    renderMapMarkers();
                    populateDriverSelector();
                    showLoader('drivers-list', false);
                }, e => { SmartLog.error(e, "Firestore.Drivers.Listener"); updateStatus("שגיאת מאזין נהגים", true); });
             } catch (e) { SmartLog.error(e, "Firestore.Drivers.Init"); }
         }
         
        function listenToOrders() {
            try {
                SmartLog.info("Listening to Orders...", "Firestore.Listen");
                const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
                onSnapshot(q, (snapshot) => {
                    SmartLog.info(`Orders: ${snapshot.docs.length} docs.`, "Firestore.Snapshot");
                    state.orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // עיבוד ורינדור
                    renderOrders();
                    
                    // --- [FIX] אופטימיזציה: רנדר טבלאות רק אם התצוגה שלהן פעילה ---
                    const historyView = document.getElementById('view-history');
                    if (historyView && historyView.classList.contains('active')) {
                        renderHistoryTable();
                    }
                    
                    // [MODIFIED] Always process containers to update state.activeContainers for the map
                    processAndRenderContainers();
                    const containerView = document.getElementById('view-containers');
                    if (containerView && containerView.classList.contains('active')) {
                         // Re-render the table view if it's the one that's active
                         renderContainerTable();
                    }
                    
                    // [NEW] Always render map markers as container state might have changed
                    renderMapMarkers();
                    // --- סוף התיקון ---

                    showLoader('orders-list', false);
                }, e => {
                    SmartLog.error(e, "Firestore.Orders.Listener");
                    updateStatus("שגיאת מאזין הזמנות", true);
                    const containerContent = document.getElementById('containers-content');
                    if (containerContent) containerContent.innerHTML = `<p class="text-red-600 p-4">שגיאה בטעינת נתוני מכולות.</p>`;
                    showLoader('containers-loader', false);
                });
            } catch (e) { SmartLog.error(e, "Firestore.Orders.Init"); }
         }
         
        function listenToLocations() {
             try {
                SmartLog.info("Listening to Locations...", "Firestore.Listen");
                const q = query(collection(db, "driverLocations"));
                onSnapshot(q, (snapshot) => {
                    SmartLog.info(`Locations: ${snapshot.docs.length} changes.`, "Firestore.Snapshot");
                    const newLocations = {};
                    snapshot.forEach(doc => { newLocations[doc.id] = { id: doc.id, ...doc.data() }; });
                    state.liveLocations = newLocations;
                    renderDrivers();
                    renderMapMarkers();
                }, e => { SmartLog.error(e, "Firestore.Locations.Listener"); updateStatus("שגיאת מאזין מיקומים", true); });
             } catch (e) { SmartLog.error(e, "Firestore.Locations.Init"); }
         }
         
        function listenToCustomers() {
             try {
                SmartLog.info("Listening to Customers...", "Firestore.Listen");
                const q = query(collection(db, "customers"), orderBy("name"));
                onSnapshot(q, (snapshot) => {
                    SmartLog.info(`Customers: ${snapshot.docs.length} changes.`, "Firestore.Snapshot");
                    state.customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    populateCustomerDatalist();
                    
                    // [FIX] אופטימיזציה: רנדר טבלת לקוחות רק אם התצוגה פעילה
                    const historyView = document.getElementById('view-history');
                    const customerTab = document.getElementById('history-customers-content');
                    if (historyView && historyView.classList.contains('active') && customerTab && customerTab.style.display !== 'none') {
                         renderCustomerTable();
                    }
                }, e => { SmartLog.error(e, "Firestore.Customers.Listener"); updateStatus("שגיאת מאזין לקוחות", true); });
             } catch (e) { SmartLog.error(e, "Firestore.Customers.Init"); }
         }

        // --- RENDER FUNCTIONS (with Error Handling) ---
        function renderDrivers() {
             try {
                const list = document.getElementById('drivers-list');
                if (!list) return;
                list.innerHTML = '';
                if (state.drivers.length === 0) { list.innerHTML = `<div class="p-4 text-center text-gray-500">לא נמצאו נהגים פעילים.</div>`; return; }
                state.drivers.forEach(driver => {
                    const location = state.liveLocations[driver.id];
                    const assignedOrders = state.orders.filter(o => o.driver?.id === driver.id && o.status !== 'הושלם');
                    list.appendChild(createDriverCard(driver, location, assignedOrders.length));
                });
             } catch (e) { SmartLog.error(e, "Render.Drivers"); }
         }
         
        function createDriverCard(driver, location, assignedCount) {
             // (פונקציה זו פנימית ל-renderDrivers, הסיכוי לשגיאה נמוך, אך ניתן להוסיף try/catch גם פה)
             const el = document.createElement('div');
             el.className = 'driver-card p-4 cursor-pointer';
             el.id = `driver-card-${driver.id}`;
             el.setAttribute('data-search', driver.name.toLowerCase());
             el.onclick = () => focusOnMapItem(driver.id, 'driver');
             let statusClass = 'status-inactive'; let statusText = 'לא מחובר';
             if (location) { statusClass = location.isStuck ? 'status-stuck' : 'status-active'; statusText = location.isStuck ? `תקוע (${location.minutesAgo || '?'})` : 'פעיל'; }
             el.innerHTML = `
                 <div class="flex justify-between items-center"> <span class="font-semibold">${driver.name}</span> <div class="flex items-center space-x-2 space-x-reverse"> <span class="text-sm font-medium">${statusText}</span> <span class="status-dot ${statusClass}"></span> </div> </div>
                 <div class="text-sm text-gray-500 flex justify-between items-center mt-1"> <span>${driver.vehicleType || 'משאית'} | ${driver.phone}</span> <span class="text-xs font-medium text-blue-600">${assignedCount} משויכות</span> </div>`;
             return el;
         }
         
        function renderOrders() {
             try {
                const list = document.getElementById('orders-list');
                if (!list) return;
                list.innerHTML = '';
                const unassignedOrders = state.orders.filter(o => o.status === 'חדש' && !VIRTUAL_WAREHOUSES.includes(o.warehouse) );
                if (unassignedOrders.length === 0) { list.innerHTML = `<div class="p-4 text-center text-gray-500">אין הזמנות חדשות (לא מכולות) לשיבוץ.</div>`; return; }
                unassignedOrders.sort((a,b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0)).forEach(order => { list.appendChild(createOrderCard(order)); });
             } catch (e) { SmartLog.error(e, "Render.Orders"); }
         }
         
        function createOrderCard(order) {
             const el = document.createElement('div');
             el.className = 'order-card p-4 cursor-pointer';
             el.id = `order-card-${order.id}`;
             el.setAttribute('data-search', `${order.orderNumber || order.id} ${order.customer?.name?.toLowerCase()} ${order.address?.toLowerCase()}`);
             el.onclick = () => focusOnMapItem(order.id, 'order');
             const orderDate = order.orderDate ? new Date(order.orderDate).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' }) : 'N/A';
             const customerName = order.customer?.name || 'לקוח לא ידוע';
             const address = order.address || 'כתובת לא צוינה';
             const createdTime = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '';
             const displayId = order.orderNumber || `#${order.id.slice(-6)}`;
             const orderTimeStr = order.orderTime ? ` (${order.orderTime})` : ''; // Add time if exists
             el.innerHTML = `
                 <div class="flex justify-between items-center mb-1"> <span class="font-bold text-blue-600">${displayId}</span> <span class="text-sm font-semibold">${orderDate}${orderTimeStr}</span> </div>
                 <div class="font-semibold text-gray-800">${customerName}</div> <div class="text-sm text-gray-600 truncate">${address}</div>
                 <div class="text-xs text-gray-500 mt-1 flex justify-between"> <span>${order.deliveryType || ''} | ${order.warehouse || ''}</span> <span>נוצר: ${createdTime}</span> </div>`;
             return el;
         }
         
        function renderMapMarkers() {
             try {
                if (!map) return;
                const bounds = L.latLngBounds();
                
                // Render Drivers
                Object.values(state.liveLocations).forEach(driverLoc => {
                    if (!driverLoc.latitude || !driverLoc.longitude) return;
                    const driverData = state.drivers.find(d => d.id === driverLoc.id);
                    const name = driverData?.name || 'נהג לא ידוע';
                    const latLng = [driverLoc.latitude, driverLoc.longitude];
                    const icon = driverLoc.isStuck ? driverIconStuck : driverIconActive;
                    const popupContent = `<h4>${name}</h4> <p>${driverLoc.isStuck ? 'תקוע' : 'פעיל'} | עדכון לפני ${driverLoc.minutesAgo || '?'} דקות</p>`;
                    if (driverMarkers[driverLoc.id]) { driverMarkers[driverLoc.id].setLatLng(latLng).setIcon(icon).setPopupContent(popupContent); }
                    else { driverMarkers[driverLoc.id] = L.marker(latLng, { icon: icon }).addTo(map).bindPopup(popupContent).on('click', () => focusOnMapItem(driverLoc.id, 'driver')); }
                    if (!driverLoc.isStuck) bounds.extend(latLng);
                });
                
                // Render Orders
                const unassignedOrders = state.orders.filter(o => o.status === 'חדש' && o.latitude && o.longitude && !VIRTUAL_WAREHOUSES.includes(o.warehouse));
                // Remove old markers
                Object.keys(orderMarkers).forEach(orderId => { if (!unassignedOrders.some(o => o.id == orderId)) { if (map.hasLayer(orderMarkers[orderId])) { map.removeLayer(orderMarkers[orderId]); } delete orderMarkers[orderId]; } });
                // Add/update current markers
                unassignedOrders.forEach(order => {
                    const latLng = [order.latitude, order.longitude];
                    const customerName = order.customer?.name || 'לקוח לא ידוע';
                    const displayId = order.orderNumber || `#${order.id.slice(-6)}`;
                    const popupContent = `<h4>הזמנה ${displayId}</h4> <p>${customerName}</p> <p>${order.address || '...'}</p> <button class="w-full mt-2 px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600" onclick="showAssignDriverModal('${order.id}')"> שייך נהג </button>`;
                    if (orderMarkers[order.id]) { orderMarkers[order.id].setLatLng(latLng).setPopupContent(popupContent); }
                    else { orderMarkers[order.id] = L.marker(latLng, { icon: orderIconNew }).addTo(map).bindPopup(popupContent).on('click', () => focusOnMapItem(order.id, 'order')); }
                    bounds.extend(latLng);
                });

                // --- [NEW] Render Active Containers ---
                const activeContainers = state.activeContainers.filter(c => c.latitude && c.longitude);
                
                // Remove old container markers
                Object.keys(containerMarkers).forEach(orderId => {
                    if (!activeContainers.some(c => c.orderId == orderId)) {
                        if (map.hasLayer(containerMarkers[orderId])) {
                            map.removeLayer(containerMarkers[orderId]);
                        }
                        delete containerMarkers[orderId];
                    }
                });

                // Add/update current container markers
                activeContainers.forEach(container => {
                    const latLng = [container.latitude, container.longitude];
                    const icon = container.isOverdue ? containerIconOverdue : containerIconActive;
                    
                    const overdueStyle = container.isOverdue ? 'style="color: #dc2626; font-weight: bold;"' : '';
                    const popupContent = `
                        <h4 style="font-weight: 700; margin-bottom: 8px;">מכולה פעילה (${container.warehouse})</h4>
                        <p style="margin: 4px 0;"><strong>לקוח:</strong> ${container.customerName}</p>
                        <p style="margin: 4px 0;"><strong>כתובת:</strong> ${container.address}</p>
                        <p style="margin: 4px 0;" ${overdueStyle}>
                            ימי שכירות: ${container.rentalDays} ${container.isOverdue ? '(בחריגה!)' : ''}
                        </p>
                        <button 
                            class="w-full mt-2 px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600" 
                            onclick="replaceContainer('${container.orderId}')">
                            בצע החלפה
                        </button>
                    `;
                    
                    if (containerMarkers[container.orderId]) {
                        containerMarkers[container.orderId].setLatLng(latLng).setIcon(icon).setPopupContent(popupContent);
                    } else {
                        containerMarkers[container.orderId] = L.marker(latLng, { icon: icon })
                            .addTo(map)
                            .bindPopup(popupContent);
                        // No focusOnMapItem for containers, they don't have a side-panel card
                    }
                    bounds.extend(latLng);
                });
                
                // Fit bounds
                if (bounds.isValid() && (unassignedOrders.length > 0 || Object.keys(driverMarkers).some(id => !state.liveLocations[id]?.isStuck) || activeContainers.length > 0 )) { // [MODIFIED] Added activeContainers check
                    try { map.fitBounds(bounds, { padding: [50, 50] }); } catch (e) { console.warn("FitBounds error:", e); }
                }
                else if (!bounds.isValid()) {
                    map.setView(ISRAEL_CENTER, 9);
                }
             } catch (e) { SmartLog.error(e, "Render.MapMarkers"); }
         }
         
        function renderHistoryTable() {
             try {
                const list = document.getElementById('history-table-body');
                if (!list) return;
                
                const search = document.getElementById('history-search').value.toLowerCase();
                const dateFrom = document.getElementById('history-date-from').value;
                const dateTo = document.getElementById('history-date-to').value;
                
                let filteredOrders = state.orders;
                
                if (search) { filteredOrders = filteredOrders.filter(o => (o.id.toLowerCase().includes(search)) || (o.orderNumber?.toLowerCase().includes(search)) || (o.customer?.name?.toLowerCase().includes(search)) || (o.driver?.name?.toLowerCase().includes(search)) || (o.address?.toLowerCase().includes(search)) ); }
                if (dateFrom) { const fromMs = new Date(dateFrom).getTime(); filteredOrders = filteredOrders.filter(o => { const orderTimestamp = o.createdAt?.toDate ? o.createdAt.toDate().getTime() : (o.orderDate ? new Date(o.orderDate).getTime() : 0); return orderTimestamp >= fromMs; }); }
                if (dateTo) { const toMs = new Date(dateTo).setHours(23, 59, 59, 999); filteredOrders = filteredOrders.filter(o => { const orderTimestamp = o.createdAt?.toDate ? o.createdAt.toDate().getTime() : (o.orderDate ? new Date(o.orderDate).getTime() : Infinity); return orderTimestamp <= toMs; }); }
                
                filteredOrders.sort((a, b) => { const timeA = a.createdAt?.toMillis() || 0; const timeB = b.createdAt?.toMillis() || 0; return timeB - timeA; });
                
                let html = '';
                if (filteredOrders.length === 0) { html = '<tr><td colspan="7" class="text-center p-8 text-gray-500">לא נמצאו הזמנות תואמות</td></tr>'; }
                else { filteredOrders.forEach(order => {
                    const orderDate = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleDateString('he-IL') : (order.orderDate ? new Date(order.orderDate).toLocaleDateString('he-IL') : 'N/A');
                    const displayId = order.orderNumber || `#${order.id.slice(-6)}`;
                    const orderTimeStr = order.orderTime ? ` (${order.orderTime})` : '';
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${displayId}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.customer?.name || '...'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.driver?.name || '---'}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate" title="${order.address || ''}">${order.address || '...'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.status || '...'}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${orderDate}${orderTimeStr}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="action-button" onclick="promptForStatusChange('${order.id}', '${order.status || 'חדש'}')">עדכן סטטוס</button>
                                <button class="action-button action-button-secondary" onclick="copyCustomerLink('${order.id}')" title="העתק לינק ללקוח"> <i data-feather="share-2" class="w-4 h-4"></i> </button>
                            </td> </tr> `; }); }
                
                list.innerHTML = html;
                feather.replace({ width: '16px', height: '16px' });
             } catch (e) { SmartLog.error(e, "Render.HistoryTable"); }
         }
         
        function renderCustomerTable() {
             try {
                const list = document.getElementById('customer-table-body');
                if(!list) return;
                
                const search = document.getElementById('customer-search-input').value.toLowerCase();
                let filteredCustomers = state.customers;
                
                if (search) { filteredCustomers = filteredCustomers.filter(c => (c.name?.toLowerCase().includes(search)) || (c.phone?.includes(search)) || (c.customerNumber?.toLowerCase().includes(search)) || (c.defaultAddress?.toLowerCase().includes(search)) ); }
                
                filteredCustomers.sort((a, b) => a.name?.localeCompare(b.name || '') || 0);
                
                let html = '';
                if (filteredCustomers.length === 0) { html = '<tr><td colspan="4" class="text-center p-8 text-gray-500">לא נמצאו לקוחות תואמים</td></tr>'; }
                else { filteredCustomers.forEach(cust => { html += `
                    <tr class="hover:bg-gray-50" onclick="openCustomerEditModal('${cust.id}')">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${cust.name || '---'}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cust.customerNumber || '---'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cust.phone || '---'}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate" title="${cust.defaultAddress || ''}">${cust.defaultAddress || '---'}</td>
                    </tr> `; }); }
                list.innerHTML = html;
             } catch (e) { SmartLog.error(e, "Render.CustomerTable"); }
         }
        window.renderCustomerTable = renderCustomerTable;

        // --- NEW: CONTAINER VIEW LOGIC (with Error Handling) ---
        /**
         * [MODIFIED] This function now *only* processes data into state.activeContainers.
         * The rendering of the table is split to renderContainerTable().
         */
        function processAndRenderContainers() {
             try {
                SmartLog.info("Processing container data...", "Containers");
                
                state.activeContainers = [];
                
                const ordersByCustomer = state.orders.reduce((acc, order) => {
                     if (order?.customer?.id && VIRTUAL_WAREHOUSES.includes(order.warehouse)) {
                        if (!acc[order.customer.id]) acc[order.customer.id] = [];
                        acc[order.customer.id].push(order);
                    }
                    return acc;
                }, {});
                
                for (const customerId in ordersByCustomer) {
                    const customerOrders = ordersByCustomer[customerId];
                    customerOrders.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                    const latestOrder = customerOrders[0];
                    
                    if (latestOrder.deliveryType === 'הצבת מכולה' || latestOrder.deliveryType === 'החלפת מכולה') {
                        const startDate = latestOrder.rentalStartDate?.toDate ? latestOrder.rentalStartDate.toDate() :
                                          (latestOrder.createdAt?.toDate ? latestOrder.createdAt.toDate() :
                                          (latestOrder.orderDate ? new Date(latestOrder.orderDate) : null));

                        if (startDate) {
                            const rentalDays = calculateRentalDays(startDate);
                            state.activeContainers.push({
                                orderId: latestOrder.id,
                                customerId: customerId,
                                customerName: latestOrder.customer?.name || '?',
                                address: latestOrder.address,
                                warehouse: latestOrder.warehouse,
                                deliveryType: latestOrder.deliveryType,
                                rentalStartDate: startDate,
                                rentalDays: rentalDays,
                                isOverdue: rentalDays > CONTAINER_RENTAL_LIMIT_DAYS,
                                orderNumber: latestOrder.orderNumber,
                                orderTime: latestOrder.orderTime,
                                // [UPGRADE] Add coordinates for map rendering
                                latitude: latestOrder.latitude,
                                longitude: latestOrder.longitude
                            });
                        } else { SmartLog.warn("Could not determine rental start date for active container", "Containers.Process", { orderId: latestOrder.id, customerId }); }
                    }
                }
             } catch (e) {
                 SmartLog.error(e, "Containers.Process");
                 state.activeContainers = []; // Clear state on error
             }
         }

        /**
         * [NEW] Renders the table in #view-containers based on state.activeContainers
         */
         function renderContainerTable() {
             try {
                SmartLog.info("Rendering container table view...", "Containers.Render");
                showLoader('containers-loader', true);
                
                const containerContent = document.getElementById('containers-content');
                if (!containerContent) { SmartLog.error("Container content element not found", "Containers.Render"); showLoader('containers-loader', false); return; }
                
                containerContent.innerHTML = '';

                const containersByWarehouse = state.activeContainers.reduce((acc, container) => {
                    if (!acc[container.warehouse]) acc[container.warehouse] = [];
                    acc[container.warehouse].push(container); return acc;
                 }, {});
                 
                let totalActive = 0;
                VIRTUAL_WAREHOUSES.forEach(warehouse => {
                    const warehouseContainers = containersByWarehouse[warehouse] || [];
                    warehouseContainers.sort((a, b) => {
                        if (a.isOverdue && !b.isOverdue) return -1;
                        if (!a.isOverdue && b.isOverdue) return 1;
                        return b.rentalDays - a.rentalDays;
                    });
                    let sectionHtml = `<div class="warehouse-section"><h3>${warehouse} (${warehouseContainers.length})</h3>`;
                    if (warehouseContainers.length > 0) {
                        sectionHtml += `<div class="bg-white rounded-lg shadow-sm overflow-hidden"><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 container-table"><thead class="bg-gray-50"><tr>
                                            <th>לקוח</th><th>כתובת</th><th>ת. הצבה/החלפה</th><th>ימי שכירות (מתוך ${CONTAINER_RENTAL_LIMIT_DAYS})</th>
                                            <th>פעולה אחרונה</th><th>מס' הזמנה</th><th>עריכה</th></tr></thead>
                                            <tbody class="bg-white divide-y divide-gray-200">${warehouseContainers.map(c => createContainerRow(c)).join('')}</tbody>
                                            </table></div></div>`;
                    } else { sectionHtml += `<p class="text-gray-500">אין מכולות פעילות במחסן זה.</p>`; }
                    sectionHtml += `</div>`;
                    containerContent.innerHTML += sectionHtml;
                    totalActive += warehouseContainers.length;
                });
                
                const totalEl = document.getElementById('total-active-containers');
                if (totalEl) totalEl.innerText = totalActive;

                feather.replace({ width: '16px', height: '16px' });
             } catch (e) {
                 SmartLog.error(e, "Render.Containers");
                 const containerContent = document.getElementById('containers-content');
                 if(containerContent) containerContent.innerHTML = `<div class="p-4 text-red-600">שגיאה בעיבוד נתוני מכולות.</div>`;
             } finally {
                showLoader('containers-loader', false);
             }
         }
         
        function createContainerRow(container) {
             const startDateStr = container.rentalStartDate instanceof Date ? container.rentalStartDate.toLocaleDateString('he-IL') : 'N/A';
             const progressPercent = Math.min(100, (container.rentalDays / CONTAINER_RENTAL_LIMIT_DAYS) * 100);
             const progressBarClass = container.isOverdue ? 'progress-bar overdue' : 'progress-bar';
             const rowClass = container.isOverdue ? 'overdue' : '';
             const displayId = container.orderNumber || `#${container.orderId.slice(-6)}`;
             const timeStr = container.orderTime || '';
             return `
                 <tr class="${rowClass}">
                     <td class="font-medium">${container.customerName}</td> <td>${container.address}</td> <td>${startDateStr} ${timeStr}</td>
                     <td> <div class="flex items-center gap-2"> <span>${container.rentalDays}</span> <div class="progress-bar-container flex-grow"> <div class="${progressBarClass}" style="width: ${progressPercent}%;"></div> </div> </div> </td>
                     <td>${container.deliveryType}</td> <td>${displayId}</td>
                     <td> <button class="edit-btn" onclick="openContainerEditModal('${container.orderId}')"> <i data-feather="edit-2"></i> </button> </td>
                 </tr> `;
         }
         
        function calculateRentalDays(startDate) {
             try {
                if (!(startDate instanceof Date)) return 0;
                const today = new Date();
                const start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
                today.setHours(0, 0, 0, 0);
                const diffTime = Math.abs(today - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays + 1;
             } catch (e) {
                 SmartLog.error(e, "Util.CalculateRentalDays", { startDate });
                 return 0;
             }
         }

        // --- UI & MAP INTERACTIONS (with Error Handling) ---
        function showView(viewName) {
            try {
                SmartLog.info(`Switching view to: ${viewName}`, "UI.Nav");
                document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
                const viewEl = document.getElementById(`view-${viewName}`);
                if (viewEl) { viewEl.classList.add('active'); }
                else { SmartLog.error(`View element not found`, "UI.Nav", { viewId: `view-${viewName}` }); document.getElementById('view-dashboard')?.classList.add('active'); viewName = 'dashboard'; }
                
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                const navLink = document.querySelector(`.nav-link[onclick*="showView('${viewName}')"]`);
                if (navLink) navLink.classList.add('active');

                // Ensure maps resize correctly after view switch
                if (viewName === 'dashboard' && map) setTimeout(() => { try { map.invalidateSize(); } catch(e){ SmartLog.error(e, "UI.MapResize", { map: 'dashboard' }); } }, 10);
                if (viewName === 'driver-history' && driverHistoryMap) setTimeout(() => { try { driverHistoryMap.invalidateSize(); } catch(e){ SmartLog.error(e, "UI.MapResize", { map: 'driver-history' }); } }, 10);

                // [FIX] Trigger renders only when switching *to* the view
                if (viewName === 'containers') {
                    // processAndRenderContainers(); // This is already called by the listener
                    renderContainerTable(); // Just render the table
                }
                if (viewName === 'history') {
                    renderHistoryTable();
                    renderCustomerTable(); // Render both, as tab might be active
                }
            } catch (e) { SmartLog.error(e, "UI.ShowView", { viewName }); }
         }
        window.showView = showView;
        
        function showHistoryTab(tabName) {
            try {
                if (tabName === 'orders') {
                    document.getElementById('history-orders-content').style.display = 'block';
                    document.getElementById('history-customers-content').style.display = 'none';
                    document.querySelector('.tab-button[onclick*="orders"]').classList.add('active');
                    document.querySelector('.tab-button[onclick*="customers"]').classList.remove('active');
                    renderHistoryTable(); // Re-render on tab switch
                } else {
                    document.getElementById('history-orders-content').style.display = 'none';
                    document.getElementById('history-customers-content').style.display = 'block';
                    document.querySelector('.tab-button[onclick*="orders"]').classList.remove('active');
                    document.querySelector('.tab-button[onclick*="customers"]').classList.add('active');
                    renderCustomerTable(); // Re-render on tab switch
                }
            } catch (e) { SmartLog.error(e, "UI.ShowHistoryTab", { tabName }); }
         }
        window.showHistoryTab = showHistoryTab;
        
        function showPanelTab(tabName) {
            try {
                if (tabName === 'orders') {
                    document.getElementById('orders-list').style.display = 'block';
                    document.getElementById('drivers-list').style.display = 'none';
                    document.getElementById('tab-orders').classList.add('border-blue-500', 'text-blue-500');
                    document.getElementById('tab-orders').classList.remove('border-transparent', 'text-gray-500');
                    document.getElementById('tab-drivers').classList.add('border-transparent', 'text-gray-500');
                    document.getElementById('tab-drivers').classList.remove('border-blue-500', 'text-blue-500');
                } else {
                    document.getElementById('orders-list').style.display = 'none';
                    document.getElementById('drivers-list').style.display = 'block';
                    document.getElementById('tab-orders').classList.remove('border-blue-500', 'text-blue-500');
                    document.getElementById('tab-orders').classList.add('border-transparent', 'text-gray-500');
                    document.getElementById('tab-drivers').classList.remove('border-transparent', 'text-gray-500');
                    document.getElementById('tab-drivers').classList.add('border-blue-500', 'text-blue-500');
                }
            } catch (e) { SmartLog.error(e, "UI.ShowPanelTab", { tabName }); }
         }
        window.showPanelTab = showPanelTab;
        
        function filterLists() {
            try {
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                document.querySelectorAll('#orders-list .order-card').forEach(card => {
                    const searchable = card.getAttribute('data-search') || '';
                    card.style.display = searchable.includes(searchTerm) ? 'block' : 'none';
                });
                document.querySelectorAll('#drivers-list .driver-card').forEach(card => {
                    const searchable = card.getAttribute('data-search') || '';
                    card.style.display = searchable.includes(searchTerm) ? 'block' : 'none';
                });
            } catch (e) { SmartLog.error(e, "UI.FilterLists"); }
         }
        window.filterLists = filterLists;
        
        function focusOnMapItem(id, type) {
            try {
                SmartLog.info(`Focusing on ${type} ${id}`, "UI.MapFocus");
                // 1. Highlight in list
                document.querySelectorAll('.order-card, .driver-card').forEach(c => c.classList.remove('active'));
                const card = document.getElementById(`${type}-card-${id}`);
                if (card) {
                    card.classList.add('active');
                    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
                
                // 2. Center map and open popup
                let marker;
                if (type === 'driver') marker = driverMarkers[id];
                if (type === 'order') marker = orderMarkers[id];
                
                if (marker && map) {
                    map.flyTo(marker.getLatLng(), 15);
                    marker.openPopup();
                }
                
                // 3. Render details panel
                renderDetailsPanel(id, type);
                
            } catch (e) { SmartLog.error(e, "UI.FocusOnMapItem", { id, type }); }
        }
        
        function showAssignDriverModal(orderId) {
            try {
                const order = state.orders.find(o => o.id === orderId);
                if (!order) { showToast('שגיאה: הזמנה לא נמצאה', 'error'); return; }
                
                const availableDrivers = state.drivers.filter(d => {
                    const location = state.liveLocations[d.id];
                    return location && !location.isStuck;
                });
                
                if (availableDrivers.length === 0) {
                    showToast('אין נהגים זמינים (פעילים ולא תקועים) לשיבוץ', 'info');
                    return;
                }
                
                let driverOptions = availableDrivers.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                
                // (This assumes a modal structure exists, which is missing in the HTML)
                // For now, using a simple prompt
                const driverId = prompt(`שייך הזמנה #${order.orderNumber || order.id.slice(-6)} לנהג:\n\n${availableDrivers.map(d => d.name).join('\n')}\n\nהקלד שם נהג או ID:`);
                
                if (driverId) {
                    // Find driver by name or ID
                    const selectedDriver = availableDrivers.find(d => d.id === driverId || d.name.toLowerCase() === driverId.toLowerCase());
                    if (selectedDriver) {
                        assignOrderToDriver(orderId, selectedDriver.id);
                    } else {
                        showToast('נהג לא נמצא או לא זמין', 'error');
                    }
                }
            } catch (e) { SmartLog.error(e, "UI.ShowAssignModal", { orderId }); }
        }
        window.showAssignDriverModal = showAssignDriverModal;
        
        async function assignOrderToDriver(orderId, driverId) {
             try {
                const driver = state.drivers.find(d => d.id === driverId);
                if (!driver) { showToast('שגיאה: נהג לא קיים', 'error'); return; }
                
                const orderRef = doc(db, "orders", orderId);
                await updateDoc(orderRef, {
                    status: "שויך",
                    driver: { id: driver.id, name: driver.name, phone: driver.phone },
                    lastModified: serverTimestamp()
                });
                
                SmartLog.info(`Order ${orderId} assigned to ${driverId}`, "CRUD.Assign");
                showToast(`הזמנה שויכה ל${driver.name}`, 'success');
                closeDetailsPanel();
             } catch (error) {
                 SmartLog.error(error, "CRUD.Assign", { orderId, driverId });
                 showToast('שגיאה בשיבוץ הזמנה', 'error');
             }
         }
         
        function renderDetailsPanel(id, type) {
            try {
                const panel = document.getElementById('details-panel');
                if (!panel) return;
                
                let html = '';
                if (type === 'order') {
                    const order = state.orders.find(o => o.id === id);
                    if (!order) { html = 'שגיאה: פרטי הזמנה לא נמצאו.'; }
                    else {
                        const displayId = order.orderNumber || `#${order.id.slice(-6)}`;
                        html = `
                            <div id="details-panel-header">
                                <h4>הזמנה ${displayId}</h4>
                                <div>
                                    <i data-feather="copy" id="details-copy-link-btn" class="w-4 h-4" onclick="copyCustomerLink('${order.id}')"></i>
                                    <i data-feather="x" id="details-close-btn" class="w-5 h-5" onclick="closeDetailsPanel()"></i>
                                </div>
                            </div>
                            <ul>
                                <li><strong>לקוח:</strong> ${order.customer?.name || '---'}</li>
                                <li><strong>טלפון:</strong> ${order.customer?.phone || '---'}</li>
                                <li><strong>כתובת:</strong> ${order.address || '---'}</li>
                                <li><strong>סוג:</strong> ${order.deliveryType || '---'} | ${order.warehouse || '---'}</li>
                                <li><strong>הערות:</strong> ${order.notes || '---'}</li>
                                <li class="status-line"><strong>סטטוס:</strong> ${order.status} <button class="status-change-btn" onclick="promptForStatusChange('${order.id}', '${order.status}')">[שנה סטטוס]</button></li>
                            </ul>
                            <div class="mt-4">
                                <label for="assign-driver-select" class="text-sm font-medium">שייך לנהג:</label>
                                <div class="flex gap-2 mt-1">
                                    <select id="assign-driver-select" class="w-full p-2 border rounded-md text-sm">
                                        <option value="">בחר נהג זמין...</option>
                                        ${state.drivers.filter(d => state.liveLocations[d.id] && !state.liveLocations[d.id].isStuck).map(d => `<option value="${d.id}">${d.name}</option>`).join('')}
                                    </select>
                                    <button class="px-3 py-1 bg-blue-500 text-white rounded-md text-sm" onclick="assignOrderToDriver('${order.id}', document.getElementById('assign-driver-select').value)">שייך</button>
                                </div>
                            </div>
                        `;
                    }
                } else if (type === 'driver') {
                    const driver = state.drivers.find(d => d.id === id);
                    const location = state.liveLocations[id];
                    if (!driver) { html = 'שגיאה: פרטי נהג לא נמצאו.'; }
                    else {
                        const assignedOrders = state.orders.filter(o => o.driver?.id === id && (o.status === 'שויך' || o.status === 'בדרך'));
                        html = `
                            <div id="details-panel-header">
                                <h4>${driver.name}</h4>
                                <i data-feather="x" id="details-close-btn" class="w-5 h-5" onclick="closeDetailsPanel()"></i>
                            </div>
                            <ul>
                                <li><strong>סטטוס:</strong> ${location ? (location.isStuck ? 'תקוע' : 'פעיל') : 'לא מחובר'}</li>
                                <li><strong>טלפון:</strong> ${driver.phone || '---'}</li>
                                <li><strong>רכב:</strong> ${driver.vehicleType || '---'}</li>
                                <li><strong>עדכון אחרון:</strong> ${location ? (location.minutesAgo + ' דקות') : '---'}</li>
                            </ul>
                            <h5 class="font-semibold mt-3 mb-1 text-sm">הזמנות משויכות (${assignedOrders.length})</h5>
                            <ul class="text-sm space-y-1">
                                ${assignedOrders.length > 0 ? assignedOrders.map(o => `
                                    <li class="p-2 bg-gray-50 rounded-md cursor-pointer" onclick="focusOnMapItem('${o.id}', 'order')">
                                        <div class="font-medium">${o.customer?.name} (${o.status})</div>
                                        <div class="text-xs text-gray-500">${o.address}</div>
                                    </li>`).join('') : '<li class="text-gray-500">אין הזמנות פעילות</li>'}
                            </ul>
                        `;
                    }
                }
                
                panel.innerHTML = html;
                panel.style.display = 'block';
                feather.replace();
            } catch (e) { SmartLog.error(e, "UI.RenderDetailsPanel", { id, type }); }
         }
         
        function closeDetailsPanel() {
            try {
                const panel = document.getElementById('details-panel');
                if (panel) panel.style.display = 'none';
                document.querySelectorAll('.order-card, .driver-card').forEach(c => c.classList.remove('active'));
            } catch (e) { SmartLog.error(e, "UI.CloseDetailsPanel"); }
         }
        window.closeDetailsPanel = closeDetailsPanel;

        // --- Geocoding Function ---
        async function geocodeAddress(address) {
             if (!address) return null;
             const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1&countrycodes=il`;
             SmartLog.info(`Geocoding address: ${address}`, "Geocode.Nominatim");
             try {
                 const response = await fetch(url);
                 if (!response.ok) throw new Error(`Nominatim API failed: ${response.status}`);
                 const data = await response.json();
                 if (data && data.length > 0) {
                     const { lat, lon } = data[0];
                     SmartLog.info(`Geocode success: [${lat}, ${lon}]`, "Geocode.Nominatim");
                     return [parseFloat(lat), parseFloat(lon)];
                 } else {
                     SmartLog.warn(`Geocode found no results for: ${address}`, "Geocode.Nominatim");
                     return null;
                 }
             } catch (error) {
                 SmartLog.error(error, "Geocode.Nominatim", { address });
                 return null;
             }
         }

        // --- STATUS UPDATE FUNCTIONS ---
        function promptForStatusChange(orderId, currentStatus) {
            try {
                const order = state.orders.find(o => o.id === orderId);
                if (!order) { showToast('הזמנה לא נמצאה', 'error'); return; }
                
                let optionsText = ALLOWED_STATUSES.filter(s => s !== currentStatus).map((s, i) => `${i+1}. ${s}`).join('\n');
                const newStatusInput = prompt(`עדכן סטטוס להזמנה #${order.orderNumber || order.id.slice(-6)}\nסטטוס נוכחי: ${currentStatus}\n\nבחר סטטוס חדש:\n${optionsText}\n\nאו הקלד שם סטטוס:`);
                
                if (!newStatusInput) return; // User cancelled
                
                let newStatus = newStatusInput.trim();
                // Check if user entered a number
                if (/^[1-9]$/.test(newStatus)) {
                    const index = parseInt(newStatus) - 1;
                    const allowedOptions = ALLOWED_STATUSES.filter(s => s !== currentStatus);
                    if (index >= 0 && index < allowedOptions.length) {
                        newStatus = allowedOptions[index];
                    }
                }
                
                if (ALLOWED_STATUSES.includes(newStatus)) {
                    updateOrderStatus(orderId, newStatus);
                } else {
                    showToast('סטטוס לא חוקי', 'error');
                }
            } catch (e) { SmartLog.error(e, "UI.PromptStatusChange", { orderId }); }
         }
        window.promptForStatusChange = promptForStatusChange;
        
        async function updateOrderStatus(orderId, newStatus) {
             SmartLog.info(`Attempting to update status for order ${orderId} to ${newStatus}`, "CRUD.StatusUpdate");
             try {
                 const orderRef = doc(db, "orders", orderId);
                 await updateDoc(orderRef, {
                     status: newStatus,
                     lastModified: serverTimestamp()
                 });
                 SmartLog.info(`Order ${orderId} status updated to ${newStatus}`, "CRUD.StatusUpdate");
                 showToast('סטטוס הזמנה עודכן', 'success');
                 closeDetailsPanel(); // Close details panel if open
             } catch (error) {
                 SmartLog.error(error, "CRUD.StatusUpdate", { orderId, newStatus });
                 showToast('שגיאה בעדכון סטטוס', 'error');
             }
         }

        // --- NEW ORDER FORM ---
        function populateCustomerDatalist() {
            try {
                const datalist = document.getElementById('customer-list');
                if (!datalist) return;
                datalist.innerHTML = state.customers.map(cust =>
                    `<option value="${cust.name}" data-id="${cust.id}">${cust.phone} | ${cust.customerNumber || ''}</option>`
                ).join('');
            } catch (e) { SmartLog.error(e, "Render.CustomerDatalist"); }
         }
         
        function openNewOrderForm() {
            try {
                // Reset form
                document.getElementById('new-order-modal').querySelector('form').reset();
                document.getElementById('order-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('new-customer-fields').style.display = 'none';
                document.getElementById('existing-customer-display').style.display = 'none';
                document.getElementById('customer-search').value = '';
                
                document.getElementById('new-order-modal').showModal();
                feather.replace();
            } catch (e) { SmartLog.error(e, "UI.OpenNewOrderForm"); }
         }
        window.openNewOrderForm = openNewOrderForm;
        
        function closeNewOrderForm() {
            try {
                document.getElementById('new-order-modal').close();
            } catch (e) { SmartLog.error(e, "UI.CloseNewOrderForm"); }
         }
        window.closeNewOrderForm = closeNewOrderForm;
        
        function handleCustomerSearch(value) {
            try {
                const list = document.getElementById('customer-list');
                const selectedOption = Array.from(list.options).find(opt => opt.value.toLowerCase() === value.toLowerCase());
                
                if (selectedOption) {
                    const customerId = selectedOption.getAttribute('data-id');
                    const customer = state.customers.find(c => c.id === customerId);
                    if (customer) {
                        document.getElementById('customer-id-existing').value = customer.id;
                        document.getElementById('customer-name-display').innerText = customer.name;
                        document.getElementById('customer-number-display').innerText = `(${customer.customerNumber || 'ללא מס'})`;
                        document.getElementById('customer-address-display').innerText = customer.defaultAddress || '---';
                        document.getElementById('customer-phone-display').innerText = customer.phone || '---';
                        
                        document.getElementById('existing-customer-display').style.display = 'block';
                        document.getElementById('new-customer-fields').style.display = 'none';
                    }
                } else {
                    document.getElementById('existing-customer-display').style.display = 'none';
                    document.getElementById('new-customer-fields').style.display = 'block';
                    document.getElementById('customer-id-new').value = '';
                    document.getElementById('customer-name-new').value = value; // Pre-fill name
                    document.getElementById('customer-phone-new').value = '';
                    document.getElementById('customer-street-new').value = '';
                    document.getElementById('customer-streetnum-new').value = '';
                    document.getElementById('customer-city-new').value = '';
                    document.getElementById('customer-contact-new').value = '';
                    document.getElementById('customer-number-new').value = '';
                }
            } catch (e) { SmartLog.error(e, "UI.HandleCustomerSearch"); }
         }
        window.handleCustomerSearch = handleCustomerSearch;
        
        async function submitNewOrder(event) {
             event.preventDefault();
             const btn = document.getElementById('submit-order-btn');
             btn.disabled = true;
             btn.innerText = 'מעבד...';
             
             let customerDataForOrder = {};
             let customerAddress = '';
             let customerRefId = '';
             let customerCustomCoords = null; // [lat, lon] or null
             let useCustomerCoords = false;

             try {
                 // Step 1: Handle Customer (New or Existing)
                 if (document.getElementById('new-customer-fields').style.display === 'block') {
                     btn.innerText = 'יוצר לקוח חדש...';
                     const newCustomer = {
                         name: document.getElementById('customer-name-new').value.trim(),
                         phone: document.getElementById('customer-phone-new').value.trim(),
                         street: document.getElementById('customer-street-new').value.trim(),
                         streetNum: document.getElementById('customer-streetnum-new').value.trim(),
                         city: document.getElementById('customer-city-new').value.trim(),
                         contact: document.getElementById('customer-contact-new').value.trim(),
                         customerNumber: document.getElementById('customer-number-new').value.trim() || null,
                         createdAt: serverTimestamp(),
                         auditLog: [{ timestamp: serverTimestamp(), user: 'admin', action: 'Created' }]
                     };
                     if (!newCustomer.name || !newCustomer.phone || !newCustomer.street || !newCustomer.streetNum || !newCustomer.city) {
                         throw new Error('יש למלא את כל שדות הלקוח החדש (שם, טלפון, כתובת מלאה)');
                     }
                     customerAddress = `${newCustomer.street} ${newCustomer.streetNum}, ${newCustomer.city}`;
                     newCustomer.defaultAddress = customerAddress;
                     
                     const customerDocRef = await addDoc(collection(db, "customers"), newCustomer);
                     customerRefId = customerDocRef.id;
                     SmartLog.info("Created new customer", "CRUD.Customer", { id: customerRefId });
                     
                     customerDataForOrder = { id: customerRefId, name: newCustomer.name, phone: newCustomer.phone, customerNumber: newCustomer.customerNumber };

                 } else if (document.getElementById('existing-customer-display').style.display === 'block') {
                     customerRefId = document.getElementById('customer-id-existing').value;
                     const customer = state.customers.find(c => c.id === customerRefId);
                     if (!customer) throw new Error('הלקוח הקיים שנבחר אינו חוקי');
                     
                     customerDataForOrder = { id: customer.id, name: customer.name, phone: customer.phone, customerNumber: customer.customerNumber };
                     customerAddress = customer.defaultAddress;
                     
                     if (customer.customCoordinates) { // Check for saved coords
                        const coords = customer.customCoordinates.split(',').map(s => parseFloat(s.trim()));
                        if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                            customerCustomCoords = [coords[0], coords[1]];
                            useCustomerCoords = true;
                            SmartLog.info("Using custom coordinates from customer profile", "CRUD.Order", { customerId: customerRefId });
                        }
                     }
                 } else {
                     throw new Error('לא נבחר לקוח קיים או נוצר לקוח חדש');
                 }

                 // Step 2: Handle Geocoding / Coordinates
                 const selectedWarehouse = document.getElementById('order-warehouse').value;
                 const isVirtual = VIRTUAL_WAREHOUSES.includes(selectedWarehouse);
                 let finalCoords = null;
                 let rentalStartDate = null;
                 const deliveryType = document.getElementById('order-delivery-type').value;

                 if (isVirtual) {
                     SmartLog.info("Skipping geocoding for virtual warehouse order", "CRUD.Order.Create");
                     if (useCustomerCoords) finalCoords = customerCustomCoords;
                     
                     if (['הצבת מכולה', 'החלפת מכולה'].includes(deliveryType)) {
                         const orderDateStr = document.getElementById('order-date').value;
                         const orderTimeStr = document.getElementById('order-time').value.trim() || '00:00';
                         if (orderDateStr) {
                             const dateTimeStr = `${orderDateStr}T${orderTimeStr}`;
                             const jsDate = new Date(dateTimeStr);
                             if (!isNaN(jsDate)) {
                                 rentalStartDate = Timestamp.fromDate(jsDate); // Use Firestore Timestamp
                                 SmartLog.info("Setting rentalStartDate", "CRUD.Order.Create", { date: rentalStartDate.toDate() });
                             } else {
                                 throw new Error("Invalid date/time combination for rentalStartDate");
                             }
                         } else {
                             SmartLog.warn("Order date is required to set rentalStartDate", "CRUD.Order.Create");
                             showToast("תאריך הזמנה נדרש לקביעת תחילת שכירות מכולה", 'warn');
                         }
                     }
                 } else {
                    // GEOCODING (For non-virtual warehouses)
                    if (useCustomerCoords) {
                         finalCoords = customerCustomCoords;
                    } else {
                        btn.innerText = 'מאתר כתובת...';
                        const coords = await geocodeAddress(customerAddress);
                        const warehouseCoords = WAREHOUSE_LOCATIONS[selectedWarehouse] || ISRAEL_CENTER;
                        finalCoords = coords || warehouseCoords;
                        if (!coords) { showToast('לא ניתן היה לאתר כתובת, ההזמנה תוצג במיקום המחסן', 'info'); }
                    }
                 }
                 
                 btn.innerText = 'יוצר הזמנה...';

                 // Step 3: Create Order Object
                 const newOrder = {
                    customer: customerDataForOrder,
                    address: customerAddress,
                    orderNumber: document.getElementById('order-number').value.trim() || null,
                    orderDate: document.getElementById('order-date').value,
                    orderTime: document.getElementById('order-time').value.trim() || null,
                    deliveryType: deliveryType,
                    warehouse: selectedWarehouse,
                    notes: document.getElementById('order-notes').value.trim(),
                    latitude: finalCoords ? finalCoords[0] : null,
                    longitude: finalCoords ? finalCoords[1] : null,
                    status: "חדש",
                    createdAt: serverTimestamp(),
                    lastModified: serverTimestamp(),
                    rentalStartDate: rentalStartDate // null if not applicable
                 };

                 // Step 4: Validate
                 if (!newOrder.deliveryType || !newOrder.warehouse) {
                     throw new Error('יש לבחור סוג הובלה ומחסן');
                 }

                 // Step 5: Save
                 const orderDocRef = await addDoc(collection(db, "orders"), newOrder);
                 SmartLog.info("Order created", "CRUD.Order", { id: orderDocRef.id, orderNumber: newOrder.orderNumber, isVirtual });
                 showToast('הזמנה חדשה נוצרה בהצלחה', 'success');
                 closeNewOrderForm();
                 focusOnMapItem(orderDocRef.id, 'order');

             } catch (error) {
                 SmartLog.error(error, "CRUD.Order.Create");
                 showToast(`שגיאה ביצירת הזמנה: ${error.message}`, 'error');
             } finally {
                 btn.disabled = false;
                 btn.innerText = 'צור הזמנה';
             }
         }
        window.submitNewOrder = submitNewOrder;

         // --- CUSTOMER EDIT MODAL (with Error Handling) ---
         function openCustomerEditModal(customerId) {
            try {
                const customer = state.customers.find(c => c.id === customerId);
                if (!customer) {
                    showToast('שגיאה: לקוח לא נמצא', 'error');
                    return;
                }
                
                // Populate fields
                document.getElementById('customer-edit-id').value = customer.id;
                document.getElementById('customer-edit-title').innerText = `עריכת: ${customer.name}`;
                document.getElementById('customer-edit-name').value = customer.name || '';
                document.getElementById('customer-edit-number').value = customer.customerNumber || '';
                document.getElementById('customer-edit-phone').value = customer.phone || '';
                document.getElementById('customer-edit-contact').value = customer.contact || '';
                document.getElementById('customer-edit-street').value = customer.street || '';
                document.getElementById('customer-edit-streetnum').value = customer.streetNum || '';
                document.getElementById('customer-edit-city').value = customer.city || '';
                document.getElementById('customer-edit-coords').value = customer.customCoordinates || '';
                
                // Populate audit log
                const logList = document.getElementById('customer-audit-log');
                if (customer.auditLog && customer.auditLog.length > 0) {
                    logList.innerHTML = [...customer.auditLog].reverse().map(log => {
                        const date = log.timestamp?.toDate ? log.timestamp.toDate().toLocaleString('he-IL') : '...';
                        return `<li><strong>${date}:</strong> ${log.action} (על ידי ${log.user})</li>`;
                    }).join('');
                } else {
                    logList.innerHTML = '<li>אין היסטוריית שינויים</li>';
                }
                
                document.getElementById('customer-edit-modal').showModal();
                feather.replace();
            } catch (e) { SmartLog.error(e, "UI.OpenCustomerEdit", { customerId }); }
         }
         window.openCustomerEditModal = openCustomerEditModal;
         
         function closeCustomerEditModal() {
            try {
                document.getElementById('customer-edit-modal').close();
            } catch (e) { SmartLog.error(e, "UI.CloseCustomerEdit"); }
         }
         window.closeCustomerEditModal = closeCustomerEditModal;
         
         async function handleSaveCustomer(event) {
             event.preventDefault();
             const btn = document.getElementById('customer-save-btn');
             btn.disabled = true;
             btn.innerText = 'שומר...';
             
             const customerId = document.getElementById('customer-edit-id').value;
             const customerRef = doc(db, "customers", customerId);
             
             try {
                 const originalCustomer = state.customers.find(c => c.id === customerId);
                 if (!originalCustomer) throw new Error("לקוח מקורי לא נמצא");
                 
                 const originalAddress = originalCustomer.defaultAddress;
                 
                 const updatedData = {
                     name: document.getElementById('customer-edit-name').value.trim(),
                     customerNumber: document.getElementById('customer-edit-number').value.trim() || null,
                     phone: document.getElementById('customer-edit-phone').value.trim(),
                     contact: document.getElementById('customer-edit-contact').value.trim(),
                     street: document.getElementById('customer-edit-street').value.trim(),
                     streetNum: document.getElementById('customer-edit-streetnum').value.trim(),
                     city: document.getElementById('customer-edit-city').value.trim(),
                     customCoordinates: document.getElementById('customer-edit-coords').value.trim() || null
                 };
                 
                 const newAddress = `${updatedData.street} ${updatedData.streetNum}, ${updatedData.city}`;
                 updatedData.defaultAddress = newAddress;
                 
                 const addressChanged = newAddress !== originalAddress;
                 let newCoords = null;
                 
                 // Handle coordinates
                 if (updatedData.customCoordinates) { // Priority to manual coords
                    const coords = updatedData.customCoordinates.split(',').map(s => parseFloat(s.trim()));
                    if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                        newCoords = [coords[0], coords[1]];
                    } else {
                        throw new Error("פורמט קואורדינטות לא חוקי. השתמש ב: lat, lon");
                    }
                 } else if (addressChanged) { // Geocode new address if no manual coords
                     btn.innerText = 'מאתר כתובת...';
                     const coords = await geocodeAddress(newAddress);
                     if (coords) newCoords = coords;
                     SmartLog.info("Geocoded new address during customer update", "CRUD.Customer", { customerId, coords: newCoords });
                 }
                 
                 // Check for changes
                 const changes = {};
                 let hasChanges = false;
                 for (const key in updatedData) {
                     if (updatedData[key] !== originalCustomer[key]) {
                         changes[key] = { from: originalCustomer[key], to: updatedData[key] };
                         hasChanges = true;
                     }
                 }

                 btn.innerText = 'שומר...';
                 
                 if (hasChanges) {
                     const auditEntry = {
                         timestamp: serverTimestamp(),
                         user: 'admin', // Placeholder
                         action: `Updated fields: ${Object.keys(changes).join(', ')}`
                     };
                     updatedData.auditLog = arrayUnion(auditEntry);
                     
                     await updateDoc(customerRef, updatedData);
                     SmartLog.info("Customer updated with audit log", "CRUD.Customer", { id: customerId, changes: Object.keys(changes) });
                     showToast('פרטי לקוח עודכנו', 'success');
                 } else {
                     SmartLog.info("No changes detected for customer update", "CRUD.Customer", { id: customerId });
                     showToast('לא זוהו שינויים לשמירה', 'info');
                 }
                 
                 // Update active orders linked to this customer IF address changed
                 if (addressChanged) {
                     SmartLog.info(`Address changed for ${customerId}. Checking active orders...`, "CRUD.Order.UpdateOnCustChange");
                     const q = query(collection(db, "orders"),
                         where("customer.id", "==", customerId),
                         where("status", "in", ["חדש", "שויך", "בדרך"]),
                         where("address", "==", originalAddress) // Only update orders with the OLD address
                     );
                     
                     try {
                         const querySnapshot = await getDocs(q);
                         let updatedCount = 0;
                         const batch = []; // Use batch for efficiency, though not strictly necessary here
                         
                         querySnapshot.forEach(orderDoc => {
                             const orderUpdateData = {
                                 address: newAddress,
                                 "customer.name": updatedData.name, // Also update name/phone in order
                                 "customer.phone": updatedData.phone
                             };
                             if (newCoords) { // Update coords only if we have new ones
                                 orderUpdateData.latitude = newCoords[0];
                                 orderUpdateData.longitude = newCoords[1];
                             }
                             batch.push(updateDoc(doc(db, "orders", orderDoc.id), orderUpdateData));
                             updatedCount++;
                         });
                         
                         await Promise.all(batch); // Commit all updates
                         
                         if (updatedCount > 0) {
                             SmartLog.info(`Updated location for ${updatedCount} active orders`, "CRUD.Order.UpdateOnCustChange", { customerId });
                             showToast(`מיקום עודכן עבור ${updatedCount} הזמנות פעילות`, 'info');
                         } else {
                             SmartLog.info(`No active orders found matching old address ${originalAddress}`, "CRUD.Order.UpdateOnCustChange", { customerId });
                         }
                     } catch (orderUpdateError) {
                         SmartLog.error(orderUpdateError, "CRUD.Order.UpdateOnCustChange", { customerId });
                         showToast('שגיאה בעדכון הזמנות מקושרות', 'error');
                     }
                 }
                 
                 closeCustomerEditModal();
                 
             } catch (error) {
                 SmartLog.error(error, "CRUD.Customer.Update", { customerId });
                 showToast(`שגיאה בשמירת לקוח: ${error.message}`, 'error');
             } finally {
                 btn.disabled = false;
                 btn.innerText = 'שמור שינויים';
             }
         }
         window.handleSaveCustomer = handleSaveCustomer;

        // --- [NEW] CONTAINER MAP ACTIONS ---
        /**
         * Creates a new "Replacement" order based on an existing active container.
         * This will supersede the old order in the "activeContainers" logic.
         */
        async function replaceContainer(orderId) {
            SmartLog.info(`Initiating replacement for container order: ${orderId}`, "CRUD.Container.Replace");
            if (!confirm("האם אתה בטוח שברצונך ליצור הזמנת 'החלפת מכולה' עבור לקוח זה?")) {
                return;
            }

            try {
                // 1. Find the original order from the *main* orders list
                const originalOrder = state.orders.find(o => o.id === orderId);
                if (!originalOrder) {
                    throw new Error("לא נמצאה הזמנה מקורית לביצוע החלפה.");
                }

                // 2. Get today's date/time
                const now = new Date();
                const todayDateStr = now.toISOString().split('T')[0];
                const nowTimeStr = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
                const rentalStartDateTimestamp = Timestamp.fromDate(now); // Use today as the new start

                // 3. Create new order object
                const newOrder = {
                    customer: originalOrder.customer, // Copy customer object
                    address: originalOrder.address,
                    warehouse: originalOrder.warehouse,
                    latitude: originalOrder.latitude,
                    longitude: originalOrder.longitude,
                    
                    deliveryType: "החלפת מכולה", // Set as replacement
                    orderDate: todayDateStr,
                    orderTime: nowTimeStr,
                    rentalStartDate: rentalStartDateTimestamp, // Reset rental start date
                    
                    orderNumber: null, // Let system generate new ID
                    notes: `החלפה עבור הזמנה ${originalOrder.orderNumber || originalOrder.id.slice(-6)}`,
                    status: "חדש",
                    createdAt: serverTimestamp(),
                    lastModified: serverTimestamp()
                };

                // 4. Save the new order
                const orderDocRef = await addDoc(collection(db, "orders"), newOrder);
                
                SmartLog.info("Container replacement order created", "CRUD.Container.Replace", { newOrderId: orderDocRef.id, oldOrderId: orderId });
                showToast('הזמנת החלפה נוצרה בהצלחה', 'success');
                
                // 5. Close any open popups
                if (map) map.closePopup();

            } catch (error) {
                SmartLog.error(error, "CRUD.Container.Replace", { orderId });
                showToast(`שגיאה ביצירת החלפה: ${error.message}`, 'error');
            }
        }
        // Make it globally accessible from the popup
        window.replaceContainer = replaceContainer;

         // --- DRIVER HISTORY PAGE ---
         function populateDriverSelector() {
            try {
                const select = document.getElementById('driver-select');
                if (!select) return;
                if (state.drivers.length > 0) {
                    select.innerHTML = '<option value="">בחר נהג</option>';
                    state.drivers.forEach(driver => {
                        select.innerHTML += `<option value="${driver.id}">${driver.name}</option>`;
                    });
                } else {
                    select.innerHTML = '<option value="">לא נמצאו נהגים</option>';
                }
            } catch (e) { SmartLog.error(e, "Render.DriverSelector"); }
         }
         
         async function fetchAndDrawDriverRoute() {
             const btn = document.getElementById('driver-history-filter-btn');
             btn.disabled = true;
             btn.innerText = 'טוען מסלול...';
             
             try {
                const driverId = document.getElementById('driver-select').value;
                const dateFrom = document.getElementById('driver-history-date-from').value;
                const timeFrom = document.getElementById('driver-history-time-from').value || '00:00';
                const dateTo = document.getElementById('driver-history-date-to').value;
                const timeTo = document.getElementById('driver-history-time-to').value || '23:59';
                
                if (!driverId || !dateFrom || !dateTo) {
                    throw new Error("יש לבחור נהג וטווח תאריכים מלא");
                }
                
                const startDateTime = new Date(`${dateFrom}T${timeFrom}`);
                const endDateTime = new Date(`${dateTo}T${timeTo}`);
                
                if (endDateTime <= startDateTime) {
                    throw new Error("תאריך סיום חייב להיות אחרי תאריך התחלה");
                }
                
                // --- סימולציה של שאילתא ---
                // כאן תבוא השאילתא האמיתית ל-Firestore
                // לדוגמה:
                // const q = query(collection(db, "locationHistory"),
                //     where("driverId", "==", driverId),
                //     where("timestamp", ">=", Timestamp.fromDate(startDateTime)),
                //     where("timestamp", "<=", Timestamp.fromDate(endDateTime)),
                //     orderBy("timestamp", "asc")
                // );
                // const snapshot = await getDocs(q);
                // const points = snapshot.docs.map(doc => doc.data());
                // --- סוף סימולציה ---
                
                SmartLog.warn("Driver History fetch is a placeholder. Requires 'locationHistory' collection.", "DriverHistory.Fetch", { driverId });
                // הדגמה עם נתונים מזויפים
                const points = [
                    { latitude: 32.0853, longitude: 34.7818, timestamp: Timestamp.fromDate(startDateTime) },
                    { latitude: 32.1093, longitude: 34.8555, timestamp: Timestamp.fromDate(new Date(startDateTime.getTime() + 15*60000)) },
                    { latitude: 32.0734, longitude: 34.7925, timestamp: Timestamp.fromDate(new Date(startDateTime.getTime() + 30*60000)) }
                ];
                
                if (points.length < 2) {
                    showToast('לא נמצאו נתוני מיקום עבור הטווח שנבחר', 'info');
                    drawRouteOnHistoryMap([]);
                    return;
                }
                
                const latLngPoints = points.map(p => [p.latitude, p.longitude]);
                drawRouteOnHistoryMap(latLngPoints);
                
                const distance = calculateRouteDistance(latLngPoints);
                document.getElementById('driver-distance-traveled').innerText = distance.toFixed(2);
                document.getElementById('driver-history-map-label').innerText = state.drivers.find(d => d.id === driverId)?.name || '...';
                
             } catch (error) {
                 SmartLog.error(error, "DriverHistory.Fetch");
                 showToast(`שגיאה בטעינת מסלול: ${error.message}`, 'error');
                 drawRouteOnHistoryMap([]); // נקה מפה
                 document.getElementById('driver-distance-traveled').innerText = '-';
                 document.getElementById('driver-history-map-label').innerText = '-';
             } finally {
                 btn.disabled = false;
                 btn.innerText = 'הצג מסלול';
             }
         }
         window.fetchAndDrawDriverRoute = fetchAndDrawDriverRoute;
         
         function drawRouteOnHistoryMap(latLngPoints) {
            try {
                if (!driverHistoryMap) return;
                
                // Clear previous route
                if (driverHistoryPolyline) {
                    driverHistoryMap.removeLayer(driverHistoryPolyline);
                    driverHistoryPolyline = null;
                }
                
                if (latLngPoints.length < 2) {
                    driverHistoryMap.setView(ISRAEL_CENTER, 9);
                    return;
                }
                
                // Draw new route
                driverHistoryPolyline = L.polyline(latLngPoints, { color: 'blue' }).addTo(driverHistoryMap);
                
                // Add start/end markers
                L.marker(latLngPoints[0], { icon: driverIconActive }).addTo(driverHistoryMap).bindPopup('התחלה');
                L.marker(latLngPoints[latLngPoints.length - 1], { icon: driverIconStuck }).addTo(driverHistoryMap).bindPopup('סיום');
                
                driverHistoryMap.fitBounds(driverHistoryPolyline.getBounds(), { padding: [50, 50] });
            } catch (e) { SmartLog.error(e, "Render.DriverHistoryMap", { points: latLngPoints.length }); }
         }
         
         function calculateRouteDistance(points) {
             // (This is a simple Haversine distance, not route distance)
             let totalDistance = 0;
             for (let i = 0; i < points.length - 1; i++) {
                 totalDistance += L.latLng(points[i]).distanceTo(L.latLng(points[i+1]));
             }
             return totalDistance / 1000; // convert to KM
         }

        // --- HELPERS ---
        function showLoader(elementId, show) {
            try {
                const el = document.getElementById(elementId);
                if (!el) return;
                let loader = el.querySelector('.loader-container');
                if (show) {
                    if (!loader) {
                        loader = document.createElement('div');
                        loader.className = 'loader-container';
                        loader.innerHTML = '<div class="loader"></div>';
                        el.style.position = 'relative';
                        el.appendChild(loader);
                    }
                    loader.style.display = 'flex';
                } else {
                    if (loader) {
                        loader.style.display = 'none';
                    }
                }
            } catch (e) { SmartLog.error(e, "UI.ShowLoader", { elementId, show }); }
         }
         
        function showToast(message, type = 'info') {
            try {
                const container = document.getElementById('toast-container');
                if (!container) return;
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerText = message;
                
                container.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 10); // Fade in
                setTimeout(() => {
                    toast.classList
