<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster Viewer v2.3</title>
    <!-- 
      Viewer App v2.3 - Unified Fix
      
      Changelog:
      - [FIX v2.3] - Added 'Log Snitch' to `listenForActiveOrders`
        - Will now report exactly how many docs are received vs. filtered.
      - [FIX v2.3] - Fixed manifest.json 404 error (was pointing to manifest-mobile.json).
      - [FIX v2.3] - Added missing 'mobile-web-app-capable' meta tag.
      - [FIX v2.3] - Switched query logic to filter status client-side,
        avoiding the Firestore Index requirement.
    -->
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LeafletJS (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- [FIX v2.3] Pointed manifest to the correct file -->
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="httpsC://i.postimg.cc/ryPT3r29/image.png">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>">


    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
            --text-dark: #1f2937; /* gray-800 */
            --text-light: #6b7280; /* gray-500 */
        }
        body {
            font-family: 'Inter', 'Arial', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            overflow: hidden;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Layout */
        .app-layout {
            display: grid;
            grid-template-columns: 1fr 400px; /* Map | Side Panel */
            height: 100vh;
        }
        
        #map-container {
            position: relative;
            background-color: #e0e0e0;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        #side-panel {
            background-color: var(--bg-white);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        /* Side Panel */
        #side-panel-lists {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }
        .panel-list {
            overflow-y: auto;
            position: relative;
            padding: 0.5rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
            align-content: flex-start;
        }

        /* Order Card */
        .order-card, .driver-card {
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
            background-color: var(--bg-white);
            display: flex;
            flex-direction: column;
        }
        .order-card:hover, .driver-card:hover {
            background-color: #fafafa;
            border-color: var(--primary-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .order-card.active, .driver-card.active {
            background-color: #eff6ff; /* blue-50 */
            border-right-width: 4px;
            border-right-color: var(--primary-color);
        }
        .order-card .font-bold {
            color: var(--primary-dark);
        }
        .order-card.highlight-customer-order {
            background-color: #fefce8; /* yellow-50 */
            border-color: #facc15; /* yellow-400 */
        }

        /* Status Colors */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-active { background-color: #22c55e; } /* green-500 */
        .status-stuck { background-color: #ef4444; } /* red-500 */
        .status-inactive { background-color: #9ca3af; } /* gray-400 */
        
        /* Leaflet Customizations */
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { margin: 13px 20px; font-family: 'Inter', sans-serif; }
        
        /* Loader */
        .loader-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 5000;
        }
        .toast {
            padding: 12px 20px;
            background-color: var(--text-dark);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: #22c55e; }
        .toast.error { background-color: #ef4444; }
        
        /* Modal Dialog */
        dialog {
            max-width: 500px;
            border-radius: 12px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 0;
        }
        dialog::backdrop {
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(2px);
        }
        .form-grid {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 1rem;
        }
        
        /* Card Action Button Style */
        .card-action-button {
            padding: 4px 10px;
            font-size: 0.8rem;
            font-weight: 500;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-white);
            color: var(--text-dark);
            transition: all 0.2s;
        }
        .card-action-button:hover {
            background-color: var(--bg-light);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        /* Comment Popup */
        #comment-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            z-index: 4000;
            padding: 1rem;
            width: 300px;
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease-out;
            animation: pulse 1s infinite;
        }
        #comment-popup.show {
            transform: translateY(0);
            opacity: 1;
            animation: none;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-layout {
                grid-template-columns: 1fr; /* Stack map and list */
                grid-template-rows: 40vh 60vh; /* Map on top */
            }
            #side-panel {
                width: 100%;
                border-right: none;
                border-top: 1px solid var(--border-color);
                height: 100%; /* Full height of its grid cell */
            }
            #comment-popup {
                bottom: 10px;
                right: 10px;
                left: 10px;
                width: auto;
            }
        }
    </style>
</head>
<body class="antialiased">

    <div class="app-layout">
        <!-- Map Container -->
        <div id="map-container">
            <div id="map"></div>
            <div id="map-loader" class="loader-container">
                <div class="loader"></div>
                <span class="ml-4 font-semibold">注 驻 转...</span>
            </div>
        </div>

        <!-- Side Panel (Lists) -->
        <aside id="side-panel">
            <!-- Tabs -->
            <div class="flex border-b border-gray-200">
                <button id="tab-orders" class="flex-1 p-4 font-semibold text-center border-b-2 border-blue-500 text-blue-500" onclick="showPanelTab('orders')">
                    转
                </button>
                <button id="tab-drivers" class="flex-1 p-4 font-semibold text-center border-b-2 border-transparent text-gray-500" onclick="showPanelTab('drivers')">
                    
                </button>
            </div>
            
            <!-- Search -->
            <div class="p-3 border-b border-gray-200">
                <input type="text" id="search-input" placeholder="驻砖   ..." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300" onkeyup="filterLists()">
            </div>
            
            <!-- Lists Wrapper -->
            <div id="side-panel-lists" class="no-scrollbar">
                <!-- Orders List -->
                <div id="orders-list" class="panel-list">
                    <div class="loader-container"><div class="loader"></div></div>
                </div>
                
                <!-- Drivers List -->
                <div id="drivers-list" class="panel-list" style="display: none;">
                    <div class="loader-container"><div class="loader"></div></div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <!-- [NEW] Customer History Modal -->
    <dialog id="customer-history-modal">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-xl font-bold" id="modal-history-title">住专转 拽</h3>
            <button type="button" class="text-gray-500 hover:text-gray-800" onclick="closeCustomerHistoryModal()">
                <i data-feather="x"></i>
            </button>
        </div>
        <div id="modal-history-content" class="p-6 max-h-[70vh] overflow-y-auto space-y-2">
            <!-- History injected by JS -->
            <p>注 住专...</p>
        </div>
        <div class="p-4 bg-gray-50 border-t flex justify-end">
            <button type="button" class="px-4 py-2 bg-white border rounded-md hover:bg-gray-50" onclick="closeCustomerHistoryModal()">
                住专
            </button>
        </div>
    </dialog>

    <!-- [NEW] Add Comment Modal -->
    <dialog id="add-comment-modal">
        <form onsubmit="handleSendComment(event)">
            <input type="hidden" id="comment-order-id">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold">砖转 注专</h3>
                <button type="button" class="text-gray-500 hover:text-gray-800" onclick="closeAddCommentModal()">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label for="comment-user-name" class="block text-sm font-medium mb-1">砖 砖</label>
                    <input type="text" id="comment-user-name" class="w-full p-2 border rounded-md" placeholder=": 专" required>
                </div>
                <div>
                    <label for="comment-text" class="block text-sm font-medium mb-1">驻专 注专</label>
                    <textarea id="comment-text" rows="3" class="w-full p-2 border rounded-md" placeholder=": 拽 拽砖 转专 爪 砖注 驻 注..." required></textarea>
                </div>
                <div class="form-grid">
                    <button type="submit" name="target" value="sidor" class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                        砖 住专
                    </button>
                    <button type="submit" name="target" value="customer" class="w-full px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">
                        砖 拽
                    </button>
                </div>
            </div>
        </form>
    </dialog>
    
    <!-- [NEW] Comment Popup Notification -->
    <div id="comment-popup" style="display: none;">
        <div class="flex justify-between items-center mb-2">
            <h4 class="font-bold text-blue-600">
                <i data-feather="message-square" class="inline-block w-5 h-5"></i>
                注专 砖
            </h4>
            <button class="text-gray-400 hover:text-gray-700" onclick="closeCommentPopup()">
                <i data-feather="x" class="w-5 h-5"></i>
            </button>
        </div>
        <p class="text-sm font-semibold text-gray-800" id="comment-popup-sender"></p>
        <p class="text-sm text-gray-600 mt-1" id="comment-popup-text"></p>
    </div>


    <!-- 
      ==========================================================
      ===               转转 住拽专驻 专砖 (v2.3)              ===
      ==========================================================
    -->
    <script type="module">
        // --- Inlined Firebase SDK Imports ---
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, 
            collection, query, where, Timestamp, runTransaction, getDocs, orderBy, 
            serverTimestamp, limit, writeBatch, collectionGroup, arrayUnion
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- Global Variables ---
        let db, auth;
        let map;
        let allOrders = [];
        let allCustomers = [];
        let allDrivers = [];
        let driverMarkers = {};
        let orderMarkers = {};
        let selectedOrder = null;
        let selectedDriver = null;
        let lastUpdate = null;
        let liveLocations = {}; 
        let currentUserId = null;
        
        let ordersUnsubscribe = null;
        let customersUnsubscribe = null;
        let driversUnsubscribe = null;
        let locationsUnsubscribe = null;
        
        // [NEW] Comment listener
        let globalCommentUnsubscribe = null;
        
        const ALLOWED_STATUSES = ["砖", "砖 (拽)", "驻", "砖", "专", "砖", "", "住驻拽", " 注"];
        const WAREHOUSE_LOCATIONS = { "专砖": [32.13266, 34.89819], "转": [32.16303, 34.89492] };

        // --- Firebase Config & Auth ---
        const fallbackConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949"
        };
        
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(fallbackConfig));
        
        try {
            const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');
            console.log("Firebase Initialized (Project: saban94-78949).");
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log("User Signed In:", currentUserId);
                    initializeApplication();
                } else {
                    console.log("No user. Trying auth...");
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                    }
                }
            });

        } catch (e) {
            console.error("Firebase Initialization Failed:", e);
            showToast('砖转 转专转 专 -Firebase', 'error');
        }

        // --- Main Application Init ---
        function initializeApplication() {
            feather.replace();
            initializeMaps();
            attachAllListeners();
        }

        // --- Map Init ---
        function initializeMaps() {
            try {
                map = L.map('map').setView([32.0853, 34.7818], 9);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '漏 OpenStreetMap'
                }).addTo(map);
                document.getElementById('map-loader').style.display = 'none';
            } catch (e) {
                console.error("App.MapInit Error:", e);
                document.getElementById('map-loader').innerText = '砖 注转 驻.';
            }
        }
        
        // --- Data Fetching & Listeners ---
        const ORDERS_COLLECTION = 'orders_v2'; 

        function attachAllListeners() {
            listenForActiveOrders();
            listenForCustomers();
            listenForDrivers();
            listenForDriverLocations();
            listenForGlobalComments(); // [NEW] Start comment listener
        }

        // 1. Listen for Orders
        function listenForActiveOrders() {
            if (ordersUnsubscribe) ordersUnsubscribe();
            
            // [FIX v2.3] Simpler query, filter client-side to avoid index
            const q = query(
                collection(db, ORDERS_COLLECTION),
                orderBy('createdAt', 'desc'),
                limit(100) 
            );
            
            ordersUnsubscribe = onSnapshot(q, (snapshot) => {
                const loader = document.getElementById('orders-list').querySelector('.loader-container');
                if(loader) loader.style.display = 'none';
                
                // [NEW v2.2] --- 砖 (Log Snitch) ---
                const rawDocsCount = snapshot.size;
                // -------------------------------------

                allOrders = [];
                snapshot.forEach(doc => allOrders.push({ id: doc.id, ...doc.data() }));
                
                // [FIX v2.3] Filter client-side
                allOrders = allOrders.filter(order => !['砖', '', '住驻拽'].includes(order.status));
                
                // [NEW v2.2] ---  砖 ---
                const filteredDocsCount = allOrders.length;
                console.log(`%c[砖] 转拽 ${rawDocsCount} 转. 专 住 住住, 爪转 ${filteredDocsCount} 转.`, "color: blue; font-weight: bold;");
                // ---------------------------------
                
                // Sort client-side after filtering
                allOrders.sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
                
                renderOrdersList();
                renderMapMarkers(); 
                console.log(`Loaded ${allOrders.length} active orders from '${ORDERS_COLLECTION}'`, "Data.Orders");
                lastUpdate = new Date();
            }, (error) => {
                console.error("Data.Orders.ListenFailed Error:", error);
                document.getElementById('orders-list').innerHTML = `<p class="p-4 text-red-500">砖 注转 转: ${error.message}</p>`;
            });
        }

        // 2. Listen for Customers
        function listenForCustomers() {
            if (customersUnsubscribe) customersUnsubscribe();
            const q = query(collection(db, 'customers'), orderBy('name'));
            customersUnsubscribe = onSnapshot(q, (snapshot) => {
                allCustomers = [];
                snapshot.forEach(doc => {
                    allCustomers.push({ id: doc.id, ...doc.data() });
                });
                console.log(`Loaded ${allCustomers.length} customers`, "Data.Customers");
            }, (error) => {
                console.error("Data.Customers.ListenFailed Error:", error);
            });
        }

        // 3. Listen for Drivers
        function listenForDrivers() {
            if (driversUnsubscribe) driversUnsubscribe();
            const q = query(collection(db, 'drivers'), orderBy('name'));
            driversUnsubscribe = onSnapshot(q, (snapshot) => {
                const loader = document.getElementById('drivers-list').querySelector('.loader-container');
                if(loader) loader.style.display = 'none';
                allDrivers = [];
                snapshot.forEach(doc => {
                    allDrivers.push({ id: doc.id, ...doc.data() });
                });
                renderDriversList();
                console.log(`Loaded ${allDrivers.length} drivers`, "Data.Drivers");
            }, (error) => {
                console.error("Data.Drivers.ListenFailed Error:", error);
                document.getElementById('drivers-list').innerHTML = '<p class="p-4 text-red-500">砖 注转 .</p>';
            });
        }

        // 4. Listen for Driver Locations
        function listenForDriverLocations() {
            if (locationsUnsubscribe) locationsUnsubscribe();
            const q = query(collection(db, 'driverLocations'));
            locationsUnsubscribe = onSnapshot(q, (snapshot) => {
                liveLocations = {};
                snapshot.forEach(doc => {
                    liveLocations[doc.id] = doc.data();
                });
                renderDriversList(); 
                renderMapMarkers(); 
                lastUpdate = new Date();
            }, (error) => {
                console.error("Data.Locations.ListenFailed Error:", error);
            });
        }
        
        // 5. [NEW] Listen for new comments
        function listenForGlobalComments() {
            if (globalCommentUnsubscribe) globalCommentUnsubscribe();
            
            // Listen to ALL messages subcollections
            const q = query(
                collectionGroup(db, 'messages'),
                orderBy('timestamp', 'desc'),
                limit(1)
            );

            let isFirstLoad = true;
            globalCommentUnsubscribe = onSnapshot(q, (snapshot) => {
                if (isFirstLoad) {
                    isFirstLoad = false;
                    return; // Don't show popup for old messages on load
                }
                
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const message = change.doc.data();
                        // Show popup only for messages *from* admin (sidor) or *to* customer
                        if (message.type === 'notification_to_customer' || message.type === 'message_to_admin') {
                            showCommentPopup(message);
                        }
                    }
                });
            }, (error) => {
                console.error("GlobalComment.ListenFailed Error:", error);
            });
        }

        // --- Rendering Functions ---
        
        function renderOrdersList() {
            const list = document.getElementById('orders-list');
            if (!list) return;
            const search = document.getElementById('search-input').value.toLowerCase();
            list.innerHTML = '';
            
            const filtered = allOrders.filter(order => 
                (order.customer?.name && order.customer.name.toLowerCase().includes(search)) || 
                (order.order_id && order.order_id.includes(search)) ||
                (order.address && order.address.toLowerCase().includes(search))
            );
            
            if (filtered.length === 0) {
                list.innerHTML = '<p class="p-4 text-gray-500 text-center col-span-full"> 爪 转 驻注转.</p>';
                return;
            }
            
            filtered.forEach(order => {
                const card = document.createElement('div');
                const isCustomerOrder = order.status === '砖 (拽)';
                const highlightClass = isCustomerOrder ? 'highlight-customer-order' : '';
                card.className = `order-card ${selectedOrder === order.id ? 'active' : ''} ${highlightClass} flex flex-col`;
                
                const displayId = order.orderNumber || order.order_id || `#${order.id.slice(0,6)}`;
                const customerName = order.customer?.name || '拽  注';
                const address = order.address || '转转  爪';
                const notes = order.notes || order.rawText || '...';
                const displayTime = order.orderTime ? `| ${order.orderTime}` : ``;

                card.innerHTML = `
                    <div class="flex-grow" onclick="focusOnMapItem('${order.id}', 'order')">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-blue-600 text-lg">${displayId}</span>
                            <span class="text-sm font-medium ${isCustomerOrder ? 'text-yellow-800' : 'text-gray-700'}">${order.status || '砖'} ${displayTime}</span>
                        </div>
                        <div class="font-semibold text-gray-900 text-lg">${customerName}</div>
                        <p class="text-sm text-gray-500 truncate mt-1">${address}</p>
                        <pre class="text-sm bg-gray-50 p-2 mt-3 rounded-md border whitespace-pre-wrap max-h-20 overflow-y-auto no-scrollbar">${notes}</pre>
                    </div>

                    <footer class="mt-4 pt-3 border-t border-gray-100 flex gap-2 justify-end">
                        <button class="card-action-button" onclick="openAddCommentModal('${order.id}')" title="住祝 注专">
                            <i data-feather="message-square" class="inline-block w-4 h-4"></i> 注专
                        </button>
                        <button class="card-action-button" onclick="showCustomerHistoryModal('${order.customer?.id}', '${customerName}')" title="爪 住专转 拽">
                            <i data-feather="archive" class="inline-block w-4 h-4"></i> 住专
                        </button>
                        <button class="card-action-button" onclick="copyCustomerLink('${order.id}')" title="注转拽 拽砖专 注拽 拽">
                            <i data-feather="link" class="inline-block w-4 h-4"></i> 拽砖专
                        </button>
                    </footer>
                `;
                list.appendChild(card);
            });
            feather.replace({ width: '16px', height: '16px' });
        }
        
        function renderDriversList() {
            const list = document.getElementById('drivers-list');
            if (!list) return;
            const search = document.getElementById('search-input').value.toLowerCase();
            list.innerHTML = '';
            
            const filtered = allDrivers.filter(driver => 
                driver.name.toLowerCase().includes(search) ||
                (driver.phone && driver.phone.includes(search))
            );

            if (filtered.length === 0) {
                list.innerHTML = '<p class="p-4 text-gray-500 text-center col-span-full"> 爪 .</p>';
                return;
            }
            
            filtered.forEach(driver => {
                const location = liveLocations[driver.id];
                const card = document.createElement('div');
                card.className = `driver-card ${selectedDriver === driver.id ? 'active' : ''}`;
                card.onclick = () => {
                    selectedDriver = driver.id;
                    selectedOrder = null;
                    renderDriversList();
                    renderOrdersList();
                    focusOnMapItem(driver.id, 'driver');
                };
                
                let statusClass = 'status-inactive';
                let statusText = ' 专';
                
                if (location) {
                    statusClass = location.isStuck ? 'status-stuck' : 'status-active';
                    statusText = location.isStuck ? `转拽注` : '驻注';
                }

                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-lg">${driver.name}</h3>
                        <div class="flex items-center space-x-2 space-x-reverse">
                            <span class="text-sm font-medium">${statusText}</span>
                            <span class="status-dot ${statusClass}"></span>
                        </div>
                    </div>
                    <p class="text-gray-600">${driver.phone || 'N/A'}</p>
                    <p class="text-sm text-gray-500">注: ${driver.payload || 'N/A'}</p>
                `;
                list.appendChild(card);
            });
        }
        
        function renderMapMarkers() {
            if (!map) return;
            const bounds = L.latLngBounds();

            // Render Drivers
            Object.keys(liveLocations).forEach(driverId => {
                const location = liveLocations[driverId];
                if (!location.latitude || !location.longitude) return;
                const driverData = allDrivers.find(d => d.id === driverId);
                const name = driverData?.name || '  注';
                const latLng = [location.latitude, location.longitude];
                const icon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41]
                });
                const popupContent = `<h4>${name}</h4><p>${location.isStuck ? '转拽注' : '驻注'}</p>`;
                if (driverMarkers[driverId]) {
                    driverMarkers[driverId].setLatLng(latLng).setIcon(icon).setPopupContent(popupContent);
                } else {
                    driverMarkers[driverId] = L.marker(latLng, { icon: icon })
                        .addTo(map)
                        .bindPopup(popupContent)
                        .on('click', () => focusOnMapItem(driverId, 'driver'));
                }
                if (!location.isStuck) bounds.extend(latLng);
            });
            
            // Render Active Orders
            const activeMapOrders = allOrders.filter(o => 
                !['砖', '', '住驻拽'].includes(o.status) && o.latitude && o.longitude
            );
            
            Object.keys(orderMarkers).forEach(orderId => {
                if (!activeMapOrders.some(o => o.id == orderId)) {
                    if (map.hasLayer(orderMarkers[orderId])) {
                        map.removeLayer(orderMarkers[orderId]);
                    }
                    delete orderMarkers[orderId];
                }
            });

            activeMapOrders.forEach(order => {
                const latLng = [order.latitude, order.longitude];
                const customerName = order.customer?.name || '拽  注';
                const displayId = order.orderNumber || `#${order.id.slice(0,6)}`;
                const isNew = ['砖', '砖 (拽)', '驻', ' 注'].includes(order.status);
                const iconUrl = isNew 
                    ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png'
                    : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png'; // Assigned/OnWay
                
                const icon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41]
                });
                
                const popupContent = `
                    <h4> ${displayId} (${order.status})</h4>
                    <p>${customerName}</p>
                    <p>${order.address || '...'}</p>
                `;
                if (orderMarkers[order.id]) {
                    orderMarkers[order.id].setLatLng(latLng).setIcon(icon).setPopupContent(popupContent);
                } else {
                    orderMarkers[order.id] = L.marker(latLng, { icon: icon })
                        .addTo(map)
                        .bindPopup(popupContent)
                        .on('click', () => focusOnMapItem(order.id, 'order'));
                }
                bounds.extend(latLng);
            });

            if (bounds.isValid()) {
                 try { map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 }); } catch (e) { console.warn("FitBounds error:", e); }
            }
        }
        
        function focusOnMapItem(id, type) {
            let marker, card;
            
            if (type === 'driver') {
                marker = driverMarkers[id];
                card = document.querySelector(`.driver-card[onclick*="'${id}'"]`);
                selectedDriver = id;
                selectedOrder = null;
            } else {
                marker = orderMarkers[id];
                card = document.querySelector(`.order-card[onclick*="'${id}'"]`);
                selectedOrder = id;
                selectedDriver = null;
            }
            
            if (marker) {
                map.setView(marker.getLatLng(), 15);
                marker.openPopup();
            }
            
            renderOrdersList();
            renderDriversList();
            
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // --- UI Functions ---

        function showPanelTab(tabName) {
            document.getElementById('orders-list').style.display = (tabName === 'orders') ? 'block' : 'none';
            document.getElementById('drivers-list').style.display = (tabName === 'drivers') ? 'block' : 'none';
            
            document.getElementById('tab-orders').classList.toggle('border-blue-500', tabName === 'orders');
            document.getElementById('tab-orders').classList.toggle('text-blue-500', tabName === 'orders');
            document.getElementById('tab-orders').classList.toggle('text-gray-500', tabName !== 'orders');
            document.getElementById('tab-orders').classList.toggle('border-transparent', tabName !== 'orders');

            document.getElementById('tab-drivers').classList.toggle('border-blue-500', tabName === 'drivers');
            document.getElementById('tab-drivers').classList.toggle('text-blue-500', tabName === 'drivers');
            document.getElementById('tab-drivers').classList.toggle('text-gray-500', tabName !== 'drivers');
            document.getElementById('tab-drivers').classList.toggle('border-transparent', tabName !== 'drivers');
        }

        function filterLists() {
            renderOrdersList();
            renderDriversList(); 
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // --- CRUD Functions ---
        
        async function copyCustomerLink(orderId) {
            if (!orderId) {
                showToast('  住专', 'error');
                return;
            }
            try {
                const orderRef = doc(db, ORDERS_COLLECTION, orderId);
                const orderSnap = await getDoc(orderRef);
                if (!orderSnap.exists()) {
                    showToast('  爪', 'error');
                    return;
                }
                const orderData = orderSnap.data();
                const shortOrderId = orderData.order_id; 
                if (!shortOrderId) {
                     showToast('砖:    "住驻专 " (order_id)', 'error');
                     return;
                }

                // [FIX] Use the correct path based on file structure
                const customerLink = `customer.html?id=${shortOrderId}`;
                
                const tempInput = document.createElement("textarea");
                tempInput.value = customerLink;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand("copy");
                document.body.removeChild(tempInput);
                
                showToast('拽砖专 拽 注转拽!', 'success');
            } catch (error) {
                console.error("UI.CopyLinkFailed Error:", error);
                showToast('砖 注转拽转 拽砖专', 'error');
            }
        }

        async function showCustomerHistoryModal(customerId, customerName) {
            if (!customerId) {
                showToast(' 砖 拽  ', 'error');
                return;
            }
            
            const modal = document.getElementById('customer-history-modal');
            const content = document.getElementById('modal-history-content');
            
            document.getElementById('modal-history-title').innerText = `住专 注专: ${customerName}`;
            content.innerHTML = '<div class="loader-container" style="position: relative; background: none;"><div class="loader"></div></div>';
            modal.showModal();

            try {
                const q = query(
                    collection(db, ORDERS_COLLECTION),
                    where('customer.id', '==', customerId),
                    orderBy('createdAt', 'desc'),
                    limit(20)
                );
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    content.innerHTML = '<p class="text-sm text-gray-500"> 住专转 转 拽 .</p>';
                } else {
                    content.innerHTML = snapshot.docs.map(doc => {
                        const d = doc.data();
                        return `
                            <div class="history-item">
                                <div class="flex justify-between text-xs">
                                    <span class="font-bold">${d.order_id || d.id.slice(-6)}</span>
                                    <span class="text-gray-500">${new Date(d.createdAt?.seconds * 1000).toLocaleDateString('he-IL')}</span>
                                </div>
                                <p class="text-sm truncate">${d.notes || d.rawText || '-'}</p>
                                <p class="text-xs font-medium text-blue-600">${d.status}</p>
                            </div>
                        `;
                    }).join('');
                }
            } catch (e) {
                console.error("UI.Modal.HistoryFetch Error:", e);
                content.innerHTML = '<p class="text-sm text-red-500">砖 注转 住专.</p>';
            }
        }

        function closeCustomerHistoryModal() {
            document.getElementById('customer-history-modal').close();
        }
        
        // --- [NEW] Comment Functions ---
        
        function openAddCommentModal(orderId) {
            const modal = document.getElementById('add-comment-modal');
            modal.querySelector('#comment-order-id').value = orderId;
            modal.querySelector('#comment-text').value = '';
            
            // Load user name from profile if exists
            const savedName = localStorage.getItem('viewer_user_name');
            if (savedName) {
                modal.querySelector('#comment-user-name').value = savedName;
            }
            
            modal.showModal();
        }
        
        function closeAddCommentModal() {
            document.getElementById('add-comment-modal').close();
        }
        
        async function handleSendComment(event) {
            event.preventDefault();
            const target = event.submitter.value; // 'sidor' or 'customer'
            const orderId = document.getElementById('comment-order-id').value;
            const text = document.getElementById('comment-text').value.trim();
            const senderName = document.getElementById('comment-user-name').value.trim() || '爪驻';
            
            if (!text || !orderId) return;

            // Save name for next time
            localStorage.setItem('viewer_user_name', senderName);
            
            const messageData = {
                text: text,
                senderName: senderName,
                senderId: currentUserId,
                timestamp: serverTimestamp(),
                readByViewer: false,
                // [NEW] Differentiate message type based on button
                type: target === 'customer' ? 'notification_to_customer' : 'message_to_admin'
            };
            
            try {
                const messagesColRef = collection(db, ORDERS_COLLECTION, orderId, 'messages');
                await addDoc(messagesColRef, messageData);
                showToast('注专 砖 爪!', 'success');
                closeAddCommentModal();
            } catch (error) {
                console.error("Failed to send comment:", error);
                showToast('砖 砖转 注专.', 'error');
            }
        }
        
        function showCommentPopup(message) {
            const popup = document.getElementById('comment-popup');
            document.getElementById('comment-popup-sender').innerText = `转: ${message.senderName || ' 注'}`;
            document.getElementById('comment-popup-text').innerText = message.text || '...';
            
            popup.style.display = 'block';
            setTimeout(() => popup.classList.add('show'), 10); // Animate in
            
            // Auto-close after 10 seconds
            setTimeout(closeCommentPopup, 10000);
        }
        
        function closeCommentPopup() {
            const popup = document.getElementById('comment-popup');
            popup.classList.remove('show');
            setTimeout(() => popup.style.display = 'none', 300);
        }

        // --- Expose Functions to Global Scope ---
        window.showPanelTab = showPanelTab;
        window.filterLists = filterLists;
        window.copyCustomerLink = copyCustomerLink;
        window.showCustomerHistoryModal = showCustomerHistoryModal;
        window.closeCustomerHistoryModal = closeCustomerHistoryModal;
        window.openAddCommentModal = openAddCommentModal;
        window.closeAddCommentModal = closeAddCommentModal;
        window.handleSendComment = handleSendComment;
        window.closeCommentPopup = closeCommentPopup;
        window.focusOnMapItem = focusOnMapItem;

    </script>
</body>
</html>
