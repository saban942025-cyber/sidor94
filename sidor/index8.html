<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v32.5 (Stable)</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/feather-icons"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- סגנונות CSS - ללא שינוי מהמקור -->
    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
            --text-dark: #1f2937; /* gray-800 */
            --text-light: #6b7280; /* gray-500 */
            --text-dark-nav: #d1d5db; /* gray-300 */
            --bg-dark-nav: #1f2937; /* slate-800 */
            --bg-dark-nav-hover: #374151; /* slate-700 */
            --danger-soft: #fee2e2; /* red-100 */
            --danger-medium: #f87171; /* red-400 */
            --danger-dark: #dc2626; /* red-600 */
        }
        body {
            font-family: 'Inter', 'Arial', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            overflow: hidden;
        }

        /* Layout */
        .app-layout {
            display: grid;
            grid-template-columns: auto 1fr;
            height: 100vh;
        }

        /* App Views */
        .app-view {
            width: 100%;
            height: 100vh;
            overflow: hidden; /* Prevent scrolling on main views */
            display: none; /* Hidden by default */
        }
        .app-view.active {
            display: block; /* Show active view */
        }

        #view-dashboard {
            display: grid; /* Use grid for dashboard */
            grid-template-columns: 1fr 350px;
            overflow: hidden;
        }
        .app-view.active#view-dashboard { display: grid; } /* Override default block for dashboard */

        #view-history, #view-containers { /* Allow scrolling for History and Containers */
            overflow-y: auto;
            padding: 1.5rem 2.5rem;
        }

        #view-driver-history {
             display: grid; /* Use grid for driver history */
             grid-template-columns: 300px 1fr; /* Sidebar and Map */
             height: 100vh;
        }
        .app-view.active#view-driver-history { display: grid; } /* Override default block */

        #map-container {
            position: relative;
            background-color: #e0e0e0;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        #side-panel {
            background-color: var(--bg-white);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Navbar */
        #navbar {
            background-color: var(--bg-dark-nav);
            border-left: 1px solid var(--border-color);
            color: white;
            z-index: 10;
        }
        #navbar .text-xl { color: white; }
        .nav-link { transition: all 0.2s; color: var(--text-dark-nav); }
        .nav-link:hover { background-color: var(--bg-dark-nav-hover); color: white; }
        .nav-link.active { background-color: var(--primary-color); color: white; border-right: 3px solid #60a5fa; }
        .nav-link-special { color: var(--text-dark-nav); background-color: var(--bg-dark-nav-hover); }
        .nav-link-special:hover { background-color: var(--primary-color); color: white; }
        #navbar .hidden.lg\\:block { color: white; }
        #navbar #last-updated { color: var(--text-light); }

        /* Side Panel */
        #side-panel-lists { flex: 1; overflow-y: auto; position: relative; }
        .panel-list { overflow-y: auto; position: relative; }
        .order-card, .driver-card { padding: 1rem; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; }
        .order-card:hover, .driver-card:hover { background-color: #fafafa; }
        .order-card.active, .driver-card.active { background-color: #eff6ff; border-right: 3px solid var(--primary-color); }
        .order-card .font-bold { color: var(--primary-dark); }

        /* Details Panel */
        #details-panel { height: 300px; overflow-y: auto; border-top: 2px solid var(--border-color); background: #fdfdfd; padding: 1rem; display: none; position: relative; }
        #details-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        #details-panel h4 { font-weight: 700; color: var(--text-dark); }
        #details-panel ul { list-style-type: none; padding: 0; margin: 0; }
        #details-panel li { font-size: 0.9rem; margin-bottom: 4px; color: var(--text-light); }
        #details-panel .status-line { display: flex; align-items: center; gap: 0.5rem; }
        #details-panel li .dist { font-weight: 500; color: var(--text-dark); display: inline-block; min-width: 60px; text-align: left; }
        #details-close-btn, #details-copy-link-btn { cursor: pointer; color: var(--text-light); }
        #details-close-btn:hover, #details-copy-link-btn:hover { color: var(--text-dark); }
        .status-change-btn { background: none; border: none; color: var(--primary-color); font-size: 0.8rem; font-weight: 500; cursor: pointer; padding: 2px 4px; border-radius: 4px; }
        .status-change-btn:hover { background-color: #eff6ff; color: var(--primary-dark); }

        /* History & Customer Management View */
         #view-history .tab-button, #view-containers .tab-button { /* Apply to both */
            padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; color: var(--text-light); }
         #view-history .tab-button.active, #view-containers .tab-button.active { border-bottom-color: var(--primary-color); color: var(--primary-color); }
        .history-table tbody tr:hover, .customer-table tbody tr:hover, .container-table tbody tr:hover { background-color: #f9fafb; }
        .customer-table tbody tr:hover, .container-table tbody tr:hover { cursor: pointer; } /* Make container table rows clickable for editing */
        .action-button { background-color: var(--primary-color); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; margin-left: 4px; }
        .action-button:hover { background-color: var(--primary-dark); }
        .action-button-secondary { background-color: var(--text-light); }
        .action-button-secondary:hover { background-color: var(--text-dark); }

        /* Driver History View */
        #driver-history-sidebar { background-color: var(--bg-white); border-left: 1px solid var(--border-color); padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        #driver-history-map { background-color: #e0e0e0; position: relative; }

        /* Containers View */
        #view-containers h2 { font-size: 1.8rem; font-weight: 700; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; }
        .warehouse-section { margin-bottom: 2rem; }
        .warehouse-section h3 { font-size: 1.3rem; font-weight: 600; margin-bottom: 1rem; color: var(--primary-dark); }
        .container-table th, .container-table td { padding: 0.75rem 1rem; text-align: right; border-bottom: 1px solid var(--border-color); vertical-align: middle; font-size: 0.9rem; }
        .container-table th { font-weight: 500; color: var(--text-light); background-color: #f9fafb; }
        .container-table tbody tr.overdue { background-color: var(--danger-soft); animation: subtle-pulse 1.5s infinite ease-in-out; }
        .container-table td .edit-btn { color: var(--primary-color); cursor: pointer; }
        .container-table td .edit-btn:hover { color: var(--primary-dark); }
        .progress-bar-container { width: 100%; background-color: var(--border-color); border-radius: 99px; overflow: hidden; height: 10px; }
        .progress-bar { height: 100%; background-color: var(--primary-color); border-radius: 99px; transition: width 0.3s ease; }
        .progress-bar.overdue { background-color: var(--danger-medium); }
        .container-summary { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); font-weight: 600; }
        @keyframes subtle-pulse { 0% { background-color: var(--danger-soft); } 50% { background-color: #fecaca; /* red-200 */} 100% { background-color: var(--danger-soft); } }

        /* Status Colors */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-active { background-color: #22c55e; } .status-stuck { background-color: #ef4444; } .status-inactive { background-color: #9ca3af; }

        /* Leaflet Customizations */
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { margin: 13px 20px; font-family: 'Inter', sans-serif; }
        .leaflet-popup-content h4 { font-weight: 700; margin-bottom: 8px; }
        .leaflet-popup-content p { margin: 4px 0; color: var(--text-light); }

        /* Loader */
        .loader-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; z-index: 10; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast Notification */
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 5000; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 12px 20px; background-color: var(--text-dark); color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: all 0.3s ease; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: #22c55e; } .toast.error { background-color: #ef4444; }

        /* Modal Dialog */
        #new-order-modal, #customer-edit-modal, #container-edit-modal { /* Added container modal */
            max-width: 600px; border-radius: 12px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 0; }
        #new-order-modal::backdrop, #customer-edit-modal::backdrop, #container-edit-modal::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }

        /* Responsive */
        @media (max-width: 1024px) {
            #view-dashboard { grid-template-columns: 1fr; }
            #side-panel { position: fixed; bottom: 0; left: 0; right: 0; height: 40vh; z-index: 2000; border-right: none; border-top: 1px solid var(--border-color); transform: translateY(100%); transition: transform 0.3s ease; }
            #side-panel.open { transform: translateY(0); }
            #navbar { display: flex; width: 100%; z-index: 2001; border-left: none; border-bottom: 1px solid var(--border-color); }
            .app-layout { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            .nav-link { flex: 1; justify-content: center; } .nav-link span { display: none; } .nav-link.active { border-right: none; border-bottom: 3px solid var(--primary-color); }
            #details-panel { height: 200px; }
            #view-driver-history { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            #driver-history-sidebar { grid-row: 1 / 2; border-left: none; border-bottom: 1px solid var(--border-color); }
            #driver-history-map { grid-row: 2 / 3; }
            #view-history, #view-containers { padding: 1rem; } /* Less padding on mobile */
        }
    </style>
</head>
<body class="antialiased">

    <!-- HTML Structure - ללא שינוי מהמקור -->
    <div class="app-layout">
        <nav id="navbar" class="w-20 lg:w-64 flex flex-col p-4 space-y-4">
            <div class="hidden lg:flex items-center space-x-2 space-x-reverse px-2 mb-4">
                <i data-feather="truck" class="w-8 h-8 text-blue-500"></i>
                <span class="text-xl font-bold">DeliveryMaster</span>
            </div>

            <a href="#" class="nav-link active flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="showView('dashboard')">
                <i data-feather="map" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">דשבורד</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="showView('history')">
                <i data-feather="archive" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">היסטוריה ולקוחות</span>
            </a>
             <a href="#" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="showView('driver-history')">
                <i data-feather="navigation" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">היסטוריית נהגים</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="showView('containers')">
                 <i data-feather="hard-drive" class="w-6 h-6"></i> <span class="font-semibold text-lg hidden lg:block">מכולות</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="openNewOrderForm()">
                <i data-feather="plus-circle" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">הזמנה חדשה</span>
            </a>
            <a href="log.html" target="_blank" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg">
                <i data-feather="file-text" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">לוגים</span>
            </a>

            <div class="flex-grow"></div> <a href="#" class="nav-link nav-link-special flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="sendGlobalPing()">
                <i data-feather="bell" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">שלח התראה גלובלית</span>
            </a>

            <div class="hidden lg:block border-t border-gray-700 pt-4 mt-4">
                <div class="text-sm">שלום, <span class="font-semibold">מנהל</span></div>
                <div id="last-updated" class="text-xs">מתחבר...</div>
            </div>
        </nav>

        <div class="relative">
            <main id="view-dashboard" class="app-view active"> <div id="map-container">
                    <div id="map"></div>
                    <div id="map-loader" class="loader-container">
                        <div class="loader"></div>
                        <span class="ml-4 font-semibold">טוען מפה ומאמת...</span>
                    </div>
                </div>

                <aside id="side-panel">
                    <div class="flex border-b border-gray-200">
                        <button id="tab-orders" class="flex-1 p-4 font-semibold text-center border-b-2 border-blue-500 text-blue-500" onclick="showPanelTab('orders')">
                            הזמנות
                        </button>
                        <button id="tab-drivers" class="flex-1 p-4 font-semibold text-center border-b-2 border-transparent text-gray-500" onclick="showPanelTab('drivers')">
                            נהגים
                        </button>
                    </div>

                    <div class="p-3 border-b border-gray-200">
                        <input type="text" id="search-input" placeholder="חפש הזמנה או נהג..." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300" onkeyup="filterLists()">
                    </div>

                    <div id="side-panel-lists" class="relative">
                        <div id="orders-list" class="panel-list">
                            <div class="loader-container"><div class="loader"></div></div>
                        </div>

                        <div id="drivers-list" class="panel-list" style="display: none;">
                            <div class="loader-container"><div class="loader"></div></div>
                        </div>
                    </div>

                    <div id="details-panel">
                        <div class="text-center text-gray-500 p-8">בחר נהג או הזמנה להצגת פרטים</div>
                    </div>
                </aside>
            </main>

            <div id="view-history" class="app-view">
                <div class="flex border-b border-gray-200 mb-6">
                    <button class="tab-button active" onclick="showHistoryTab('orders')">היסטוריית הזמנות</button>
                    <button class="tab-button" onclick="showHistoryTab('customers')">ניהול לקוחות</button>
                </div>

                <div id="history-orders-content">
                    <h2 class="text-2xl font-bold mb-4">היסטוריית הזמנות</h2>
                    <div class="flex flex-col lg:flex-row gap-4 mb-4 p-4 bg-white rounded-lg shadow-sm">
                        <input type="text" id="history-search" placeholder="חפש לפי מס' הזמנה, לקוח, נהג, כתובת..." class="flex-grow p-2 border rounded-md">
                        <div class="flex gap-4">
                            <input type="date" id="history-date-from" class="p-2 border rounded-md" title="מתאריך">
                            <input type="date" id="history-date-to" class="p-2 border rounded-md" title="עד תאריך">
                        </div>
                        <button id="history-filter-btn" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">סנן</button>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 history-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">מס' הזמנה</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">לקוח</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">נהג</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">כתובת</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">סטטוס</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">תאריך</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">פעולות</th>
                                    </tr>
                                </thead>
                                <tbody id="history-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="7" class="text-center p-8 text-gray-500">טוען היסטוריה...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                 </div>

                 <div id="history-customers-content" style="display: none;">
                     <h2 class="text-2xl font-bold mb-4">ניהול לקוחות</h2>
                     <div class="flex flex-col lg:flex-row gap-4 mb-4 p-4 bg-white rounded-lg shadow-sm">
                        <input type="text" id="customer-search-input" placeholder="חפש לפי שם, טלפון, מספר לקוח..." class="flex-grow p-2 border rounded-md" onkeyup="renderCustomerTable()">
                     </div>
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 customer-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">שם</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">מספר לקוח</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">טלפון</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">כתובת</th>
                                    </tr>
                                </thead>
                                <tbody id="customer-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="4" class="text-center p-8 text-gray-500">טוען לקוחות...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                 </div>
            </div>

             <div id="view-driver-history" class="app-view">
                 <aside id="driver-history-sidebar" class="bg-white p-4 border-l border-gray-200">
                     <h3 class="text-xl font-semibold mb-4">היסטוריית נהג</h3>
                     <div>
                         <label for="driver-select" class="block text-sm font-medium text-gray-700 mb-1">בחר נהג</label>
                         <select id="driver-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                             <option value="">טוען נהגים...</option>
                         </select>
                     </div>
                     <div class="grid grid-cols-2 gap-2">
                         <div>
                            <label for="driver-history-date-from" class="block text-sm font-medium text-gray-700 mb-1">מתאריך</label>
                            <input type="date" id="driver-history-date-from" class="w-full p-2 border rounded-md">
                         </div>
                          <div>
                            <label for="driver-history-time-from" class="block text-sm font-medium text-gray-700 mb-1">משעה</label>
                             <input type="time" id="driver-history-time-from" class="w-full p-2 border rounded-md">
                         </div>
                         <div>
                             <label for="driver-history-date-to" class="block text-sm font-medium text-gray-700 mb-1">עד תאריך</label>
                             <input type="date" id="driver-history-date-to" class="w-full p-2 border rounded-md">
                         </div>
                         <div>
                             <label for="driver-history-time-to" class="block text-sm font-medium text-gray-700 mb-1">עד שעה</label>
                             <input type="time" id="driver-history-time-to" class="w-full p-2 border rounded-md">
                         </div>
                     </div>
                     <button id="driver-history-filter-btn" class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">הצג מסלול</button>
                     <div class="mt-4 border-t pt-4 text-sm text-gray-600">
                         <p><strong>סטטוס אחרון:</strong> <span id="driver-last-status">-</span></p>
                         <p><strong>מרחק משוער:</strong> <span id="driver-distance-traveled">-</span> ק"מ</p>
                         <p><strong>זמן בין הזמנות (ממוצע):</strong> <span id="driver-avg-time">-</span> דקות</p>
                     </div>
                      <div class="mt-auto text-xs text-gray-500">
                        * נתוני היסטוריה דורשים מבנה נתונים ייעודי ב-Firestore (למשל, קולקציית `locationHistory`).
                     </div>
                 </aside>
                 <div id="driver-history-map" class="relative">
                     <div class="absolute top-2 right-2 z-10 bg-white p-2 rounded shadow text-sm">
                         מציג מסלול עבור: <span id="driver-history-map-label" class="font-semibold">-</span>
                     </div>
                     <div class="w-full h-full bg-gray-300 flex items-center justify-center text-gray-500">
                         טוען מפת היסטוריה...
                         </div>
                 </div>
            </div>

             <div id="view-containers" class="app-view">
                <h2>ניהול מכולות פעילות</h2>

                <div class="loader-container" id="containers-loader">
                    <div class="loader"></div> <span class="ml-2">טוען נתוני מכולות...</span>
                </div>

                <div id="containers-content">
                    </div>

                <div class="container-summary" id="containers-summary">
                    סה"כ מכולות פעילות: <span id="total-active-containers">0</span>
                </div>
            </div>

        </div>
    </div>

    <!-- Modals (Dialogs) - ללא שינוי מהמקור -->
    <div id="toast-container"></div>

    <dialog id="new-order-modal">
        <form onsubmit="submitNewOrder(event)">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold">יצירת הזמנה חדשה</h3>
                <button type="button" class="text-gray-500 hover:text-gray-800" onclick="closeNewOrderForm()">
                    <i data-feather="x"></i>
                </button>
            </div>

            <div class="p-6 space-y-4">
                <div>
                    <label for="customer-search" class="block text-sm font-medium mb-1">חפש לקוח קיים או הקלד שם ללקוח חדש</label>
                    <input type="text" id="customer-search" list="customer-list" class="w-full p-2 border rounded-md" oninput="handleCustomerSearch(this.value)" autocomplete="off">
                    <datalist id="customer-list"></datalist>
                </div>

                <div id="new-customer-fields" class="p-4 bg-blue-50 border border-blue-200 rounded-lg space-y-3" style="display: none;">
                    <p class="font-semibold text-blue-700">פרטי לקוח חדש</p>
                    <input type="hidden" id="customer-id-new">
                    <input type="text" id="customer-name-new" placeholder="שם לקוח מלא" class="w-full p-2 border rounded-md">
                    <input type="text" id="customer-phone-new" placeholder="טלפון" class="w-full p-2 border rounded-md">
                    <div class="form-grid">
                        <input type="text" id="customer-street-new" placeholder="רחוב" class="w-full p-2 border rounded-md">
                        <input type="text" id="customer-streetnum-new" placeholder="מספר" class="w-full p-2 border rounded-md">
                        <input type="text" id="customer-city-new" placeholder="עיר" class="w-full p-2 border rounded-md">
                    </div>
                    <input type="text" id="customer-contact-new" placeholder="איש קשר" class="w-full p-2 border rounded-md">
                     <input type="text" id="customer-number-new" placeholder="מספר לקוח (אופציונלי)" class="w-full p-2 border rounded-md">
                </div>

                <div id="existing-customer-display" class="p-4 bg-gray-50 border rounded-lg" style="display: none;">
                    <input type="hidden" id="customer-id-existing">
                    <p><strong>לקוח:</strong> <span id="customer-name-display"></span> <span id="customer-number-display" class="text-sm text-gray-500"></span></p>
                    <p><strong>כתובת:</strong> <span id="customer-address-display"></span></p>
                    <p><strong>טלפון:</strong> <span id="customer-phone-display"></span></p>
                </div>

                <hr>

                <div>
                    <label for="order-number" class="block text-sm font-medium mb-1">מספר הזמנה (אופציונלי)</label>
                    <input type="text" id="order-number" placeholder="השאר ריק למזהה אוטומטי" class="w-full p-2 border rounded-md mb-4">
                 </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" id="order-date" class="w-full p-2 border rounded-md" required>
                        <input type="time" id="order-time" class="w-full p-2 border rounded-md">
                    </div>
                    <select id="order-delivery-type" class="w-full p-2 border rounded-md" required>
                        <option value="">סוג הובלה</option>
                        <option value="הובלת מנוף">הובלת מנוף</option>
                        <option value="הובלת משאית">הובלת משאית</option>
                        <option value="איסוף עצמי">איסוף עצמי</option>
                        <option value="עבודת מנוף">עבודת מנוף</option>
                        <option value="עבודת מנוף 15 מטר">עבודת מנוף 15 מטר</option>
                        <option value="הצבת מכולה">הצבת מכולה</option>
                        <option value="החלפת מכולה">החלפת מכולה</option>
                        <option value="הוצאת מכולה">הוצאת מכולה</option>
                        <option value="פינוי במקום">פינוי במקום</option>
                        <option value="פריקה ידנית">פריקה ידנית</option>
                    </select>
                    <select id="order-warehouse" class="w-full p-2 border rounded-md" required>
                        <option value="">בחר מחסן</option>
                        <option value="החרש">החרש</option>
                        <option value="התלמיד">התלמיד</option>
                        <option value="30-שארק">30-שארק (מכולה)</option>
                        <option value="32-כראדי">32-כראדי (מכולה)</option>
                        <option value="40-כראדי">40-כראדי (מכולה)</option>
                    </select>
                    </div>

                <textarea id="order-notes" rows="3" placeholder="הערות להזמנה..." class="w-full p-2 border rounded-md"></textarea>
            </div>

            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-3 space-x-reverse">
                <button type="button" class="px-4 py-2 bg-white border rounded-md hover:bg-gray-50" onclick="closeNewOrderForm()">
                    ביטול
                </button>
                <button type="submit" id="submit-order-btn" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                    צור הזמנה
                </button>
            </div>
        </form>
    </dialog>

    <dialog id="customer-edit-modal">
        <form onsubmit="handleSaveCustomer(event)">
            <input type="hidden" id="customer-edit-id">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold" id="customer-edit-title">עריכת פרטי לקוח</h3>
                <button type="button" class="text-gray-500 hover:text-gray-800" onclick="closeCustomerEditModal()">
                    <i data-feather="x"></i>
                </button>
            </div>

            <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                 <div class="form-grid">
                     <div>
                        <label for="customer-edit-name" class="block text-sm font-medium mb-1">שם לקוח</label>
                        <input type="text" id="customer-edit-name" class="w-full p-2 border rounded-md" required>
                     </div>
                     <div>
                        <label for="customer-edit-number" class="block text-sm font-medium mb-1">מספר לקוח</label>
                        <input type="text" id="customer-edit-number" class="w-full p-2 border rounded-md">
                     </div>
                     <div>
                         <label for="customer-edit-phone" class="block text-sm font-medium mb-1">טלפון</label>
                        <input type="tel" id="customer-edit-phone" class="w-full p-2 border rounded-md" required>
                     </div>
                     <div>
                         <label for="customer-edit-contact" class="block text-sm font-medium mb-1">איש קשר</label>
                        <input type="text" id="customer-edit-contact" class="w-full p-2 border rounded-md">
                     </div>
                 </div>

                 <hr class="my-4">

                 <p class="font-semibold text-gray-700">כתובת ברירת מחדל</p>
                 <div class="form-grid">
                    <input type="text" id="customer-edit-street" placeholder="רחוב" class="w-full p-2 border rounded-md" required>
                    <input type="text" id="customer-edit-streetnum" placeholder="מספר" class="w-full p-2 border rounded-md" required>
                    <input type="text" id="customer-edit-city" placeholder="עיר" class="w-full p-2 border rounded-md" required>
                 </div>

                 <div>
                    <label for="customer-edit-coords" class="block text-sm font-medium mb-1">קואורדינטות (הדבק מ-Google Maps)</label>
                    <input type="text" id="customer-edit-coords" placeholder="לדוגמה: 32.12345, 34.98765" class="w-full p-2 border rounded-md">
                    <p class="text-xs text-gray-500 mt-1">אופציונלי. אם יוזן, ישמש למיקום מדויק בהזמנות לכתובת זו.</p>
                 </div>

                 <div class="mt-4 border-t pt-4">
                    <h4 class="text-sm font-medium text-gray-600 mb-2">היסטוריית שינויים (אחרונים)</h4>
                    <ul id="customer-audit-log" class="text-xs text-gray-500 space-y-1 max-h-24 overflow-y-auto">
                        <li>טוען היסטוריה...</li>
                    </ul>
                 </div>
            </div>

            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-3 space-x-reverse">
                <button type="button" class="px-4 py-2 bg-white border rounded-md hover:bg-gray-50" onclick="closeCustomerEditModal()">
                    ביטול
                </button>
                <button type="submit" id="customer-save-btn" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                    שמור שינויים
                </button>
            </div>
        </form>
    </dialog>

    <dialog id="container-edit-modal">
        <form onsubmit="handleSaveContainerOrder(event)">
            <input type="hidden" id="container-edit-order-id">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold" id="container-edit-title">עריכת הזמנת מכולה</h3>
                <button type="button" class="text-gray-500 hover:text-gray-800" onclick="closeContainerEditModal()">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                <p><strong>לקוח:</strong> <span id="container-edit-customer-name"></span></p>
                <p><strong>כתובת:</strong> <span id="container-edit-address"></span></p>
                <p><strong>מחסן:</strong> <span id="container-edit-warehouse"></span></p>
                <hr>
                <div>
                    <label for="container-edit-delivery-type" class="block text-sm font-medium mb-1">סוג פעולה</label>
                    <select id="container-edit-delivery-type" class="w-full p-2 border rounded-md">
                        <option value="הצבת מכולה">הצבת מכולה</option>
                        <option value="החלפת מכולה">החלפת מכולה</option>
                        <option value="הוצאת מכולה">הוצאת מכולה</option>
                        <option value="פינוי במקום">פינוי במקום</option>
                        </select>
                 </div>
                 <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label for="container-edit-date" class="block text-sm font-medium mb-1">תאריך פעולה</label>
                        <input type="date" id="container-edit-date" class="w-full p-2 border rounded-md">
                     </div>
                      <div>
                        <label for="container-edit-time" class="block text-sm font-medium mb-1">שעת פעולה</label>
                        <input type="time" id="container-edit-time" class="w-full p-2 border rounded-md">
                     </div>
                 </div>
                 <div>
                    <label for="container-edit-notes" class="block text-sm font-medium mb-1">הערות</label>
                    <textarea id="container-edit-notes" rows="3" class="w-full p-2 border rounded-md"></textarea>
                 </div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-3 space-x-reverse">
                <button type="button" class="px-4 py-2 bg-white border rounded-md hover:bg-gray-50" onclick="closeContainerEditModal()">
                    ביטול
                </button>
                <button type="submit" id="container-save-btn" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                    שמור שינויים
                </button>
            </div>
        </form>
    </dialog>

    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, query, orderBy, addDoc, updateDoc, serverTimestamp, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo",
            authDomain: "saban94-78949.firebaseapp.com",
            projectId: "saban94-78949",
            storageBucket: "saban94-78949.firebasestorage.app",
            messagingSenderId: "41553157903",
            appId: "1:41553157903:web:cc33d252cff023be97a87a",
            measurementId: "G-XV6RZDESSB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state
        let state = {
            orders: [],
            drivers: [],
            customers: [],
            activeContainers: []
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize Feather Icons
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }

                // Initialize authentication
                await initializeAuth();
                
                // Initialize real-time listeners
                initializeRealtimeListeners();
                
                // Hide loader
                const mapLoader = document.getElementById('map-loader');
                if (mapLoader) {
                    mapLoader.style.display = 'none';
                }
                
                console.log('Application initialized successfully');
                
            } catch (error) {
                console.error('Error initializing application:', error);
                showToast('שגיאה באתחול המערכת', 'error');
            }
        });

        // Authentication with enhanced error handling
        async function initializeAuth() {
            return new Promise((resolve, reject) => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    unsubscribe();
                    if (user) {
                        console.log('User already signed in:', user.uid);
                        resolve(user);
                    } else {
                        try {
                            const result = await signInAnonymously(auth);
                            console.log('Anonymous sign-in successful:', result.user.uid);
                            resolve(result.user);
                        } catch (error) {
                            console.error('Anonymous sign-in failed:', error);
                            reject(error);
                        }
                    }
                });
            });
        }

        // Initialize real-time Firestore listeners
        function initializeRealtimeListeners() {
            try {
                // Listen to orders
                const ordersQuery = query(collection(db, "orders"), orderBy("createdAt", "desc"));
                onSnapshot(ordersQuery, 
                    (snapshot) => {
                        state.orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log('Orders updated:', state.orders.length);
                        renderOrdersList();
                    },
                    (error) => {
                        console.error('Error listening to orders:', error);
                        showToast('שגיאה בטעינת הזמנות', 'error');
                    }
                );

                // Listen to drivers
                const driversQuery = query(collection(db, "drivers"), orderBy("name"));
                onSnapshot(driversQuery, 
                    (snapshot) => {
                        state.drivers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log('Drivers updated:', state.drivers.length);
                        renderDriversList();
                        populateDriverSelector();
                    },
                    (error) => {
                        console.error('Error listening to drivers:', error);
                        showToast('שגיאה בטעינת נהגים', 'error');
                    }
                );

                // Listen to customers
                const customersQuery = query(collection(db, "customers"), orderBy("name"));
                onSnapshot(customersQuery, 
                    (snapshot) => {
                        state.customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log('Customers updated:', state.customers.length);
                        populateCustomerDatalist();
                    },
                    (error) => {
                        console.error('Error listening to customers:', error);
                        showToast('שגיאה בטעינת לקוחות', 'error');
                    }
                );

            } catch (error) {
                console.error('Error initializing real-time listeners:', error);
                showToast('שגיאה בחיבור לבסיס הנתונים', 'error');
            }
        }

        // View management functions
        function showView(viewName) {
            try {
                // Hide all views
                document.querySelectorAll('.app-view').forEach(view => {
                    view.classList.remove('active');
                });
                
                // Remove active class from all nav links
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                
                // Show selected view
                const targetView = document.getElementById(`view-${viewName}`);
                if (targetView) {
                    targetView.classList.add('active');
                }
                
                // Activate corresponding nav link
                const activeNavLink = document.querySelector(`.nav-link[onclick*="showView('${viewName}')"]`);
                if (activeNavLink) {
                    activeNavLink.classList.add('active');
                }
                
                console.log('Switched to view:', viewName);
                
                // Load view-specific data
                switch(viewName) {
                    case 'history':
                        loadHistoryData();
                        break;
                    case 'containers':
                        loadContainersData();
                        break;
                    case 'driver-history':
                        loadDriverHistoryData();
                        break;
                }
                
            } catch (error) {
                console.error('Error switching view:', error);
                showToast('שגיאה בהחלפת תצוגה', 'error');
            }
        }

        function showPanelTab(tabName) {
            try {
                const ordersTab = document.getElementById('tab-orders');
                const driversTab = document.getElementById('tab-drivers');
                const ordersList = document.getElementById('orders-list');
                const driversList = document.getElementById('drivers-list');
                
                if (tabName === 'orders') {
                    ordersTab.classList.add('border-blue-500', 'text-blue-500');
                    ordersTab.classList.remove('border-transparent', 'text-gray-500');
                    driversTab.classList.add('border-transparent', 'text-gray-500');
                    driversTab.classList.remove('border-blue-500', 'text-blue-500');
                    ordersList.style.display = 'block';
                    driversList.style.display = 'none';
                    renderOrdersList();
                } else {
                    driversTab.classList.add('border-blue-500', 'text-blue-500');
                    driversTab.classList.remove('border-transparent', 'text-gray-500');
                    ordersTab.classList.add('border-transparent', 'text-gray-500');
                    ordersTab.classList.remove('border-blue-500', 'text-blue-500');
                    ordersList.style.display = 'none';
                    driversList.style.display = 'block';
                    renderDriversList();
                }
            } catch (error) {
                console.error('Error switching panel tab:', error);
            }
        }

        function showHistoryTab(tabName) {
            try {
                const ordersContent = document.getElementById('history-orders-content');
                const customersContent = document.getElementById('history-customers-content');
                const tabButtons = document.querySelectorAll('#view-history .tab-button');
                
                tabButtons.forEach(button => {
                    button.classList.remove('active');
                });
                
                if (tabName === 'orders') {
                    event.target.classList.add('active');
                    ordersContent.style.display = 'block';
                    customersContent.style.display = 'none';
                    renderHistoryTable();
                } else {
                    event.target.classList.add('active');
                    ordersContent.style.display = 'none';
                    customersContent.style.display = 'block';
                    renderCustomerTable();
                }
            } catch (error) {
                console.error('Error switching history tab:', error);
            }
        }

        // Rendering functions
        function renderOrdersList() {
            try {
                const container = document.getElementById('orders-list');
                if (!container) return;
                
                const activeOrders = state.orders.filter(order => 
                    order.status && !['הושלם', 'בוטל'].includes(order.status)
                );
                
                if (activeOrders.length === 0) {
                    container.innerHTML = '<div class="p-4 text-center text-gray-500">אין הזמנות פעילות</div>';
                    return;
                }
                
                container.innerHTML = activeOrders.map(order => `
                    <div class="order-card p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-50">
                        <div class="flex justify-between items-start mb-2">
                            <div class="font-bold text-blue-600">${order.orderNumber || `#${order.id.slice(-6)}`}</div>
                            <div class="text-sm text-gray-500">${formatDate(order.createdAt)}</div>
                        </div>
                        <div class="font-semibold text-gray-800 mb-1">${order.customer?.name || 'לקוח לא ידוע'}</div>
                        <div class="text-sm text-gray-600 truncate mb-2">${order.address || 'ללא כתובת'}</div>
                        <div class="flex justify-between items-center text-xs">
                            <span class="px-2 py-1 rounded ${getStatusClass(order.status)}">${order.status || 'חדש'}</span>
                            <span class="text-gray-500">${order.driver?.name || 'ללא נהג'}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error rendering orders list:', error);
            }
        }

        function renderDriversList() {
            try {
                const container = document.getElementById('drivers-list');
                if (!container) return;
                
                if (state.drivers.length === 0) {
                    container.innerHTML = '<div class="p-4 text-center text-gray-500">אין נהגים פעילים</div>';
                    return;
                }
                
                container.innerHTML = state.drivers.map(driver => `
                    <div class="driver-card p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-50">
                        <div class="flex justify-between items-center mb-2">
                            <div class="font-semibold text-gray-800">${driver.name || 'נהג ללא שם'}</div>
                            <div class="status-dot ${getDriverStatusClass(driver.status)}"></div>
                        </div>
                        <div class="text-sm text-gray-600 mb-1">${driver.phone || 'ללא טלפון'}</div>
                        <div class="text-xs text-gray-500">${driver.vehicleType || 'ללא רכב'} • ${driver.status || 'לא פעיל'}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error rendering drivers list:', error);
            }
        }

        function renderHistoryTable() {
            try {
                const container = document.getElementById('history-table-body');
                if (!container) return;
                
                if (state.orders.length === 0) {
                    container.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-500">אין הזמנות בהיסטוריה</td></tr>';
                    return;
                }
                
                container.innerHTML = state.orders.map(order => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.orderNumber || `#${order.id.slice(-6)}`}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.customer?.name || '---'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.driver?.name || '---'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate">${order.address || '---'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.status || '---'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(order.createdAt)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <button class="action-button" onclick="promptForStatusChange('${order.id}')">עדכן סטטוס</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error rendering history table:', error);
            }
        }

        function renderCustomerTable() {
            try {
                const container = document.getElementById('customer-table-body');
                if (!container) return;
                
                if (state.customers.length === 0) {
                    container.innerHTML = '<tr><td colspan="4" class="text-center p-8 text-gray-500">אין לקוחות במערכת</td></tr>';
                    return;
                }
                
                container.innerHTML = state.customers.map(customer => `
                    <tr class="hover:bg-gray-50 cursor-pointer" onclick="openCustomerEditModal('${customer.id}')">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${customer.name || '---'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.customerNumber || '---'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.phone || '---'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate">${customer.defaultAddress || '---'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error rendering customer table:', error);
            }
        }

        // Utility functions
        function formatDate(date) {
            if (!date) return '';
            try {
                const d = date.toDate ? date.toDate() : new Date(date);
                return d.toLocaleDateString('he-IL');
            } catch (error) {
                return '';
            }
        }

        function getStatusClass(status) {
            const statusClasses = {
                'חדש': 'bg-blue-100 text-blue-800',
                'שויך': 'bg-yellow-100 text-yellow-800',
                'בדרך': 'bg-purple-100 text-purple-800',
                'הושלם': 'bg-green-100 text-green-800',
                'בוטל': 'bg-red-100 text-red-800'
            };
            return statusClasses[status] || 'bg-gray-100 text-gray-800';
        }

        function getDriverStatusClass(status) {
            const statusClasses = {
                'פעיל': 'status-active',
                'תקוע': 'status-stuck',
                'לא פעיל': 'status-inactive'
            };
            return statusClasses[status] || 'status-inactive';
        }

        function showToast(message, type = 'info') {
            try {
                const container = document.getElementById('toast-container');
                if (!container) return;
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                
                container.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 10);
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 4000);
            } catch (error) {
                console.error('Error showing toast:', error);
            }
        }

        // Stub functions for unimplemented features
        function populateCustomerDatalist() {
            try {
                const datalist = document.getElementById('customer-list');
                if (datalist && state.customers.length > 0) {
                    datalist.innerHTML = state.customers.map(customer => 
                        `<option value="${customer.name}">${customer.phone || ''} | ${customer.customerNumber || ''}</option>`
                    ).join('');
                }
            } catch (error) {
                console.error('Error populating customer datalist:', error);
            }
        }

        function populateDriverSelector() {
            try {
                const select = document.getElementById('driver-select');
                if (select && state.drivers.length > 0) {
                    select.innerHTML = '<option value="">בחר נהג</option>' + 
                        state.drivers.map(driver => 
                            `<option value="${driver.id}">${driver.name}</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error populating driver selector:', error);
            }
        }

        function loadHistoryData() {
            console.log('Loading history data...');
            renderHistoryTable();
            renderCustomerTable();
        }

        function loadContainersData() {
            console.log('Loading containers data...');
            // This would load container-specific data
            showToast('טוען נתוני מכולות...', 'info');
        }

        function loadDriverHistoryData() {
            console.log('Loading driver history data...');
            // This would load driver history data
            showToast('טוען היסטוריית נהגים...', 'info');
        }

        function filterLists() {
            try {
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                
                // Filter orders
                document.querySelectorAll('#orders-list .order-card').forEach(card => {
                    const text = card.textContent.toLowerCase();
                    card.style.display = text.includes(searchTerm) ? 'block' : 'none';
                });
                
                // Filter drivers
                document.querySelectorAll('#drivers-list .driver-card').forEach(card => {
                    const text = card.textContent.toLowerCase();
                    card.style.display = text.includes(searchTerm) ? 'block' : 'none';
                });
            } catch (error) {
                console.error('Error filtering lists:', error);
            }
        }

        // Make functions globally available
        window.showView = showView;
        window.showPanelTab = showPanelTab;
        window.showHistoryTab = showHistoryTab;
        window.filterLists = filterLists;

        // Initialize remaining global functions as stubs
        window.openNewOrderForm = function() { showToast('פתיחת טופס הזמנה חדשה', 'info'); };
        window.closeNewOrderForm = function() { showToast('סגירת טופס הזמנה', 'info'); };
        window.submitNewOrder = function(e) { e.preventDefault(); showToast('שליחת הזמנה חדשה', 'info'); };
        window.handleCustomerSearch = function(value) { console.log('Customer search:', value); };
        window.openCustomerEditModal = function(id) { showToast(`עריכת לקוח ${id}`, 'info'); };
        window.closeCustomerEditModal = function() { showToast('סגירת עריכת לקוח', 'info'); };
        window.handleSaveCustomer = function(e) { e.preventDefault(); showToast('שמירת לקוח', 'info'); };
        window.promptForStatusChange = function(orderId) { showToast(`עדכון סטטוס להזמנה ${orderId}`, 'info'); };
        window.sendGlobalPing = function() { showToast('שליחת התראה גלובלית', 'info'); };
        window.handleSaveContainerOrder = function(e) { e.preventDefault(); showToast('שמירת מכולה', 'info'); };
        window.closeContainerEditModal = function() { showToast('סגירת עריכת מכולה', 'info'); };
        window.openContainerEditModal = function(id) { showToast(`עריכת מכולה ${id}`, 'info'); };
        window.fetchAndDrawDriverRoute = function() { showToast('טוען מסלול נהג', 'info'); };

    </script>
</body>
</html>
