<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v32.0 (צ'אט משולב)</title>
    <!-- 
      DeliveryMaster Admin App v32.0 (Chat Integration)
      
      Changelog:
      - v32.0: (שילוב צ'אט)
        - הוספת לשונית "צ'אט" לסרגל הצד.
        - טעינת רשימת חדרי צ'אט.
        - הוספת חלון צ'אט מלא בפאנל התחתון.
        - תיקון `appId` לחיבור נכון ל-Firestore (מבוסס על מבנה ה-DB).
      - v31.9.2: הוספת סוגי הובלה.
      - v31.9.1: הוספת שעת אספקה.
      ... (לוגים קודמים) ...
    -->
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LeafletJS (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
            --text-dark: #1f2937; /* gray-800 */
            --text-light: #6b7280; /* gray-500 */
            --text-dark-nav: #d1d5db; /* gray-300 */
            --bg-dark-nav: #1f2937; /* slate-800 */
            --bg-dark-nav-hover: #374151; /* slate-700 */
        }
        body {
            font-family: 'Inter', 'Arial', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            overflow: hidden;
        }
        
        /* Layout */
        .app-layout {
            display: grid;
            grid-template-columns: auto 1fr;
            height: 100vh;
        }
        
        /* App Views */
        .app-view {
            width: 100%;
            height: 100vh;
            overflow: hidden; /* Prevent scrolling on main views */
        }
        
        #view-dashboard {
            display: grid;
            grid-template-columns: 1fr 350px;
            overflow: hidden;
        }
        
        #view-history, #view-driver-history { display: none; }
        
        #map-container {
            position: relative;
            background-color: #e0e0e0;
        }
        #map { height: 100%; width: 100%; }

        #side-panel {
            background-color: var(--bg-white);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        /* Navbar */
        #navbar {
            background-color: var(--bg-dark-nav);
            border-left: 1px solid var(--border-color);
            color: white;
            z-index: 10;
        }
        /* ... (שאר סגנונות הניווט) ... */
        .nav-link { transition: all 0.2s; color: var(--text-dark-nav); }
        .nav-link:hover { background-color: var(--bg-dark-nav-hover); color: white; }
        .nav-link.active { background-color: var(--primary-color); color: white; }
        .nav-link-special { color: var(--text-dark-nav); background-color: var(--bg-dark-nav-hover); }
        .nav-link-special:hover { background-color: var(--primary-color); color: white; }

        /* Side Panel */
        #side-panel-tabs {
            display: flex;
            border-b: 1px solid var(--border-color);
        }
        .panel-tab {
            flex: 1;
            padding: 1rem;
            font-weight: 600;
            text-align: center;
            border-bottom: 3px solid transparent;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
        }
        .panel-tab:hover {
            background-color: #f9fafb;
        }
        .panel-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        #side-panel-lists {
            flex: 1;
            overflow-y: auto;
            position: relative; /* For loader */
        }
        .panel-list {
            overflow-y: auto;
            position: relative; /* For loader */
        }
        .order-card, .driver-card, .chat-room-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .order-card:hover, .driver-card:hover, .chat-room-item:hover {
            background-color: #fafafa;
        }
        .order-card.active, .driver-card.active, .chat-room-item.active {
            background-color: #eff6ff; /* blue-50 */
            border-right: 3px solid var(--primary-color);
        }
        .order-card .font-bold { color: var(--primary-dark); }
        
        /* Details Panel */
        #details-panel {
            height: 300px; /* Fixed height for details */
            overflow-y: auto;
            border-top: 2px solid var(--border-color);
            background: #fdfdfd;
            padding: 1rem;
            display: block; /* Shown by default for orders/drivers */
            position: relative;
        }
         #details-panel-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 8px;
         }
        
        /* *** NEW CHAT PANEL *** */
        #chat-window-panel {
            height: 300px; /* Same height as details panel */
            border-top: 2px solid var(--border-color);
            background: #fdfdfd;
            display: none; /* Hidden by default */
            flex-direction: column; /* Chat layout */
        }
        #chat-window-header {
            padding: 0.75rem 1rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            background-color: #f9fafb;
        }
        #chat-message-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        #chat-input-box {
            padding: 0.75rem;
            border-top: 1px solid var(--border-color);
            background-color: #f9fafb;
        }
        #chat-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
        }
        /* Chat bubble styles */
        .chat-bubble {
            max-width: 80%;
            padding: 0.5rem 0.75rem;
            border-radius: 12px;
            font-size: 0.9rem;
        }
        .chat-bubble-sent {
            background-color: var(--primary-color);
            color: white;
            align-self: flex-start; /* RTL: start is left */
            border-bottom-left-radius: 0;
        }
        .chat-bubble-received {
            background-color: var(--bg-white);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
            align-self: flex-end; /* RTL: end is right */
            border-bottom-right-radius: 0;
        }

        /* Status Colors */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-active { background-color: #22c55e; } /* green-500 */
        .status-stuck { background-color: #ef4444; } /* red-500 */
        .status-inactive { background-color: #9ca3af; } /* gray-400 */
        
        /* Loader */
        .loader-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .toast {
            padding: 12px 20px;
            background-color: var(--text-dark);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: #22c55e; }
        .toast.error { background-color: #ef4444; }
        
        /* Modal Dialog */
        #new-order-modal, #customer-edit-modal {
            max-width: 600px;
            border-radius: 12px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 0;
        }
        #new-order-modal::backdrop, #customer-edit-modal::backdrop {
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(2px);
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            #view-dashboard { grid-template-columns: 1fr; }
            #side-panel {
                position: fixed; bottom: 0; left: 0; right: 0;
                height: 40vh; z-index: 2000;
                border-right: none; border-top: 1px solid var(--border-color);
                transform: translateY(100%); transition: transform 0.3s ease;
            }
            #side-panel.open { transform: translateY(0); }
            #navbar { display: flex; width: 100%; z-index: 2001; }
            .app-layout { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            .nav-link { flex: 1; justify-content: center; }
            .nav-link span { display: none; }
            
            #details-panel, #chat-window-panel { height: 200px; }
        }
    </style>
</head>
<body class="antialiased">

    <div class="app-layout">
        <!-- Navbar -->
        <nav id="navbar" class="w-20 lg:w-64 flex flex-col p-4 space-y-4">
            <!-- (סמלי ניווט נשארים כפי שהיו) -->
             <div class="hidden lg:flex items-center space-x-2 space-x-reverse px-2 mb-4">
                <i data-feather="truck" class="w-8 h-8 text-blue-500"></i>
                <span class="text-xl font-bold text-white">DeliveryMaster</span>
            </div>
            
            <a href="#" class="nav-link active flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="showView('dashboard')">
                <i data-feather="map" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">דשבורד</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="showView('history')">
                <i data-feather="archive" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">היסטוריה ולקוחות</span>
            </a>
             <a href="#" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="showView('driver-history')">
                <i data-feather="navigation" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">היסטוריית נהגים</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="openNewOrderForm()">
                <i data-feather="plus-circle" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">הזמנה חדשה</span>
            </a>
            <a href="log.html" target="_blank" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg">
                <i data-feather="file-text" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">לוגים</span>
            </a>
            
            <div class="flex-grow"></div> <!-- Spacer -->
            
            <a href="#" class="nav-link nav-link-special flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="sendGlobalPing()">
                <i data-feather="bell" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">שלח התראה גלובלית</span>
            </a>

            <div class="hidden lg:block border-t border-gray-700 pt-4 mt-4">
                <div class="text-sm text-gray-300">שלום, <span class="font-semibold text-white">מנהל</span></div>
                <div id="last-updated" class="text-xs text-gray-400">מתחבר...</div>
            </div>
        </nav>

        <!-- Main Content Wrapper -->
        <div class="relative">
            <!-- Main Content (Map + Side Panel) -->
            <main id="view-dashboard" class="app-view">
                <!-- Map Container -->
                <div id="map-container">
                    <div id="map"></div>
                    <div id="map-loader" class="loader-container">
                        <div class="loader"></div>
                        <span class="ml-4 font-semibold">טוען מפה ומאמת...</span>
                    </div>
                </div>

                <!-- Side Panel (Lists) -->
                <aside id="side-panel">
                    <!-- *** MODIFIED TABS *** -->
                    <div id="side-panel-tabs" class="flex border-b border-gray-200">
                        <button id="tab-orders" class="panel-tab active" onclick="showPanelTab('orders')">
                            הזמנות
                        </button>
                        <button id="tab-drivers" class="panel-tab" onclick="showPanelTab('drivers')">
                            נהגים
                        </button>
                        <button id="tab-chat" class="panel-tab" onclick="showPanelTab('chat')">
                            צ'אט
                        </button>
                    </div>
                    
                    <!-- Search (מוסתר זמנית בצ'אט) -->
                    <div id="search-bar" class="p-3 border-b border-gray-200">
                        <input type="text" id="search-input" placeholder="חפש הזמנה או נהג..." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300" onkeyup="filterLists()">
                    </div>
                    
                    <!-- Lists Wrapper -->
                    <div id="side-panel-lists" class="relative">
                        <!-- Orders List -->
                        <div id="orders-list" class="panel-list">
                            <div class="loader-container"><div class="loader"></div></div>
                        </div>
                        
                        <!-- Drivers List -->
                        <div id="drivers-list" class="panel-list" style="display: none;">
                            <div class="loader-container"><div class="loader"></div></div>
                        </div>

                        <!-- *** NEW CHAT ROOMS LIST *** -->
                        <div id="chat-rooms-list" class="panel-list" style="display: none;">
                             <div class="loader-container"><div class="loader"></div></div>
                             <!-- חדרי צ'אט יטענו לכאן -->
                        </div>
                    </div>
                    
                    <!-- Details Panel (Original) -->
                    <div id="details-panel">
                        <!-- Content injected by renderDetailsPanel() -->
                        <div class="text-center text-gray-500 p-8">בחר נהג או הזמנה להצגת פרטים</div>
                    </div>

                    <!-- *** NEW CHAT WINDOW PANEL *** -->
                    <div id="chat-window-panel">
                        <div id="chat-window-header">בחר חדר צ'אט</div>
                        <div id="chat-message-list">
                            <!-- הודעות יטענו לכאן -->
                        </div>
                        <div id="chat-input-box">
                            <input type="text" id="chat-input" placeholder="כתוב הודעה..." disabled>
                        </div>
                    </div>

                </aside>
            </main>
            
            <!-- History & Customer Management View (Combined) -->
            <div id="view-history" class="app-view p-4 md:p-8 overflow-y-auto">
                <!-- ... (תוכן עמוד היסטוריה ולקוחות נשאר כפי שהיה) ... -->
            </div>
            
             <!-- Driver History View (New Structure) -->
            <div id="view-driver-history" class="app-view">
                 <!-- ... (תוכן עמוד היסטוריית נהגים נשאר כפי שהיה) ... -->
            </div>
            
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- New Order Modal -->
    <dialog id="new-order-modal">
        <!-- ... (תוכן מודאל הזמנה חדשה נשאר כפי שהיה) ... -->
    </dialog>
    
    <!-- Customer Edit Modal -->
    <dialog id="customer-edit-modal">
        <!-- ... (תוכן מודאל עריכת לקוח נשאר כפי שהיה) ... -->
    </dialog>


    <script type="module">
        // --- Inlined Firebase SDK Imports ---
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, query, orderBy, addDoc, updateDoc, serverTimestamp, deleteDoc, arrayUnion, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getFunctions } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-functions.js";

        // --- Inlined Config Logic ---
        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", authDomain: "saban94-78949.firebaseapp.com", projectId: "saban94-78949",
          storageBucket: "saban94-78949.firebasestorage.app", messagingSenderId: "41553157903", appId: "1:41553157903:web:cc33d252cff023be97a87a", measurementId: "G-XV6RZDESSB"
        };

        // *** NEW: appId זוהה ממבנה ה-DB ***
        const appId = 'sidor'; 

        let app, auth, db, functions;
        let initializationError = null;
        try {
            app = getApps().length ? getApp() : initializeApp(firebaseConfig);
            auth = getAuth(app); db = getFirestore(app); functions = getFunctions(app, 'europe-west1');
        } catch (error) { console.error("CRITICAL: Firebase init failed!", error); initializationError = error; }

        const MAX_AUTH_RETRIES = 3; const RETRY_DELAY_MS = 3000;
        async function ensureAuth() {
            console.log("ensureAuth: Starting..."); let tries = 0;
            while (tries < MAX_AUTH_RETRIES) {
                tries++;
                try {
                    if (initializationError) throw new Error(`Init failed: ${initializationError.message}`);
                    if (!auth) throw new Error("Auth object missing");
                    console.log(`ensureAuth: Attempt ${tries}/${MAX_AUTH_RETRIES}...`);
                    const userCredential = await signInAnonymously(auth);
                    console.log("ensureAuth: Success.", userCredential.user.uid); return userCredential.user;
                } catch (e) {
                    console.warn(`[FirebaseAuth] Attempt ${tries} failed:`, e.code, e.message);
                    if (tries >= MAX_AUTH_RETRIES) { console.error("ensureAuth: All attempts failed."); throw e; }
                    console.log(`ensureAuth: Retrying in ${RETRY_DELAY_MS / 1000}s...`); await new Promise(r => setTimeout(r, RETRY_DELAY_MS));
                }
            } throw new Error("ensureAuth: Max retries reached.");
        }
        const authReadyPromise = ensureAuth();

        // --- Inlined SmartLog Logic ---
        const LOG_COLLECTION = 'system_logs_v3'; const sessionId = (Date.now() + Math.random()).toString(36);
        // ... (קוד SmartLog נשאר זהה) ...
        let isDbAvailable = !!db; let authChecked = false;
        const writeLog = async (level, message, origin, context = {}, category = null, solution = null) => {
            const consoleArgs = [`[${origin}] ${level}:`, message]; if (Object.keys(context).length > 0) consoleArgs.push(context); if (category) consoleArgs.push(`[Cat: ${category}]`); if (solution) consoleArgs.push(`[Sol: ${solution}]`);
            switch (level) { case 'INFO': console.log(...consoleArgs); break; case 'WARN': console.warn(...consoleArgs); break; case 'ERROR': console.error(...consoleArgs); break; default: console.log(...consoleArgs); }
            if (!isDbAvailable) { return; }
            try {
                if (!authChecked || !auth?.currentUser) {
                    await authReadyPromise; authChecked = true;
                }
                const user = auth?.currentUser; if (!user) { console.warn("SmartLog: User missing after authReady."); return; }
                const userContext = { uid: user.uid, isAnonymous: user.isAnonymous };
                const logEntry = {
                    timestamp: serverTimestamp(), level, message: String(message), origin,
                    context: { ...JSON.parse(JSON.stringify(context || {})), sessionId, userAgent: navigator.userAgent || 'N/A', page: window.location.pathname || 'N/A' },
                    user: userContext, category: category || null, solution: solution || null
                };
                await addDoc(collection(db, LOG_COLLECTION), logEntry);
            } catch (error) {
                console.error("SmartLog FATAL ERROR writing to Firestore.", error, { originalMessage: message });
                if (error.code === 'permission-denied' || error.message.includes('permissions')) { console.warn("SmartLog: Disabling Firestore logging."); isDbAvailable = false; }
            }
        };
        const SmartLog = {
            info: (msg, origin, ctx = {}) => { writeLog('INFO', msg, origin, ctx); },
            warn: (msg, origin, ctx = {}, cat = null, sol = null) => { writeLog('WARN', msg, origin, ctx, cat, sol); },
            error: (err, origin, ctx = {}, cat = null, sol = null) => { const msg = err instanceof Error ? err.message : String(err); const stack = err instanceof Error ? err.stack : 'N/A'; writeLog('ERROR', msg, origin, { ...ctx, stack }, cat, sol); }
        };

        // --- CONFIG & STATE ---
        const ISRAEL_CENTER = [32.0853, 34.7818];
        const WAREHOUSE_LOCATIONS = { "החרש": [32.13266165049073, 34.898196599998755], "התלמיד": [32.16303427408473, 34.894926705310006] };
        const ALLOWED_STATUSES = ["חדש", "שויך", "בדרך", "הושלם", "בוטל"]; 

        let state = {
            orders: [],
            drivers: [],
            liveLocations: {},
            customers: [],
            // *** NEW CHAT STATE ***
            chatRooms: [],
            currentRoomId: null,
            unsubscribeMessages: () => {} // Function to stop the listener
        };
        
        let map;
        let driverHistoryMap; 
        let driverMarkers = {};
        let orderMarkers = {};
        let driverHistoryPolyline = null; 
        
        // --- ICONS (Leaflet) ---
        // ... (קוד אייקונים של המפה נשאר זהה) ...
        const driverIconActive = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41]
        });
        const driverIconStuck = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41]
        });
        const orderIconNew = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41]
        });

        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            initializeApplication();
            
             const orderDateInput = document.getElementById('order-date');
             if(orderDateInput) orderDateInput.value = new Date().toISOString().split('T')[0];

             // *** NEW: Add listener for chat input ***
             document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSendMessage();
             });
        });
        
        async function initializeApplication() {
            SmartLog.info("v32.0-Chat: Initializing...", "Init"); // Version bump
            try {
                updateStatus("מפעיל מפות...");
                initMap(); 
                // initDriverHistoryMap(); // נטען רק כשצריך
                
                showLoader('orders-list', true);
                showLoader('drivers-list', true);
                showLoader('chat-rooms-list', true); // *** NEW ***
                
                updateStatus("מאמת משתמש...");
                const user = await authReadyPromise;
                SmartLog.info(`Firebase Auth successful. User: ${user.uid}`, "Init.Auth");
                
                updateStatus("מחבר מאזינים...");
                listenToDrivers(); 
                listenToOrders();
                listenToLocations();
                listenToCustomers(); 
                listenToChatRooms(); // *** NEW ***
                
                // (הגדרות מאזיני כפתורים של עמוד היסטוריה)
                
                showLoader('map-loader', false);
                updateStatus("מחובר ומאזין");
                
            } catch (error) {
                SmartLog.error(error, "Init.Critical", { message: "Application initialization failed." });
                updateStatus(`שגיאת אתחול: ${error.message}`);
                document.getElementById('map-loader').innerHTML = `שגיאת אתחול קריטית.`;
                showToast(`שגיאת אתחול: ${error.message}`, 'error');
            }
        }

        // --- (פונקציות initMap, initDriverHistoryMap, updateStatus נשארות זהות) ---
        function initMap() {
            try {
                map = L.map('map').setView(ISRAEL_CENTER, 9);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
                SmartLog.info("Dashboard Map initialized", "Init.Map");
            } catch (error) {
                SmartLog.error(error, "Init.Map");
                document.getElementById('map').innerHTML = `<div class="p-8 text-center text-red-600">שגיאה בטעינת המפה הראשית.</div>`;
            }
        }
        function updateStatus(message, isError = false) {
            const el = document.getElementById('last-updated');
            if (el) {
                el.innerText = message;
                el.style.color = isError ? '#ef4444' : '#6b7280';
            }
        }

        // --- FIRESTORE LISTENERS (REAL-TIME) ---
        
        function listenToDrivers() {
            SmartLog.info("Listening to Drivers...", "Firestore.Listen");
            const q = query(collection(db, "drivers"), orderBy("name"));
            onSnapshot(q, (snapshot) => {
                SmartLog.info(`Drivers: ${snapshot.docs.length} docs.`, "Firestore.Snapshot");
                state.drivers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDrivers();
                renderMapMarkers();
                // populateDriverSelector(); // יקרה רק בכניסה לעמוד היסטוריה
                showLoader('drivers-list', false);
            }, e => { 
                SmartLog.error(e, "Firestore.Drivers.Listener"); 
                updateStatus("שגיאת מאזין נהגים", true); 
            });
        }
        
        function listenToOrders() {
            SmartLog.info("Listening to Orders...", "Firestore.Listen");
            const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                SmartLog.info(`Orders: ${snapshot.docs.length} docs.`, "Firestore.Snapshot");
                state.orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOrders(); // Renders sidebar
                renderMapMarkers(); // Renders map
                // renderHistoryTable(); // יקרה רק בכניסה לעמוד היסטוריה
                showLoader('orders-list', false);
            }, e => { 
                SmartLog.error(e, "Firestore.Orders.Listener"); 
                updateStatus("שגיאת מאזין הזמנות", true); 
            });
        }

        function listenToLocations() {
             SmartLog.info("Listening to Locations...", "Firestore.Listen");
             const q = query(collection(db, "driverLocations"));
             onSnapshot(q, (snapshot) => {
                SmartLog.info(`Locations: ${snapshot.docs.length} changes.`, "Firestore.Snapshot");
                const newLocations = {};
                snapshot.forEach(doc => {
                    newLocations[doc.id] = { id: doc.id, ...doc.data() };
                });
                state.liveLocations = newLocations;
                renderDrivers();
                renderMapMarkers();
             }, e => { 
                SmartLog.error(e, "Firestore.Locations.Listener"); 
                updateStatus("שגיאת מאזין מיקומים", true); 
            });
        }
        
        function listenToCustomers() {
             SmartLog.info("Listening to Customers...", "Firestore.Listen");
             const q = query(collection(db, "customers"), orderBy("name"));
             onSnapshot(q, (snapshot) => {
                SmartLog.info(`Customers: ${snapshot.docs.length} changes.`, "Firestore.Snapshot");
                state.customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateCustomerDatalist();
                // renderCustomerTable(); // יקרה רק בכניסה לעמוד היסטוריה
             }, e => { 
                SmartLog.error(e, "Firestore.Customers.Listener"); 
                updateStatus("שגיאת מאזין לקוחות", true); 
            });
        }

        
        // --- RENDER FUNCTIONS (Orders & Drivers) ---
        // ... (פונקציות renderDrivers, createDriverCard, renderOrders, createOrderCard, renderMapMarkers נשארות זהות) ...
        function renderDrivers() {
            const list = document.getElementById('drivers-list');
            if (!list) return;
            list.innerHTML = '';
            if (state.drivers.length === 0) {
                list.innerHTML = `<div class="p-4 text-center text-gray-500">לא נמצאו נהגים פעילים.</div>`;
                return;
            }
            state.drivers.forEach(driver => {
                const location = state.liveLocations[driver.id]; 
                const assignedOrders = state.orders.filter(o => o.driver?.id === driver.id && o.status !== 'הושלם');
                list.appendChild(createDriverCard(driver, location, assignedOrders.length));
            });
        }
        function createDriverCard(driver, location, assignedCount) {
            const el = document.createElement('div');
            el.className = 'driver-card p-4 cursor-pointer';
            el.id = `driver-card-${driver.id}`;
            el.setAttribute('data-search', driver.name.toLowerCase());
            el.onclick = () => focusOnMapItem(driver.id, 'driver');
            let statusClass = 'status-inactive';
            let statusText = 'לא מחובר';
            if (location) {
                statusClass = location.isStuck ? 'status-stuck' : 'status-active';
                statusText = location.isStuck ? `תקוע (${location.minutesAgo || '?'})` : 'פעיל';
            }
            el.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-semibold">${driver.name}</span>
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <span class="text-sm font-medium">${statusText}</span>
                        <span class="status-dot ${statusClass}"></span>
                    </div>
                </div>
                <div class="text-sm text-gray-500 flex justify-between items-center mt-1">
                    <span>${driver.vehicleType || 'משאית'} | ${driver.phone}</span>
                    <span class="text-xs font-medium text-blue-600">${assignedCount} משויכות</span>
                </div>
            `;
            return el;
        }
        function renderOrders() {
            const list = document.getElementById('orders-list');
            if (!list) return; 
            list.innerHTML = ''; 
            const unassignedOrders = state.orders.filter(o => o.status === 'חדש');
            if (unassignedOrders.length === 0) {
                list.innerHTML = `<div class="p-4 text-center text-gray-500">אין הזמנות חדשות לשיבוץ.</div>`;
                return;
            }
            unassignedOrders
                .sort((a,b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0)) // Oldest first
                .forEach(order => {
                    list.appendChild(createOrderCard(order));
                });
        }
        function createOrderCard(order) {
            const el = document.createElement('div');
            el.className = 'order-card p-4 cursor-pointer';
            el.id = `order-card-${order.id}`;
            el.setAttribute('data-search', `${order.orderNumber || order.id} ${order.customer?.name?.toLowerCase()} ${order.address?.toLowerCase()}`);
            el.onclick = () => focusOnMapItem(order.id, 'order');
            const orderDate = order.orderDate ? new Date(order.orderDate).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' }) : 'N/A';
            const customerName = order.customer?.name || 'לקוח לא ידוע';
            const address = order.address || 'כתובת לא צוינה';
            const createdTime = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '';
            const displayId = order.orderNumber || `#${order.id.slice(-6)}`;
            const displayTime = order.orderTime ? `| ${order.orderTime}` : '';
            el.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-blue-600">${displayId}</span>
                    <span class="text-sm font-semibold">${orderDate} ${displayTime}</span>
                </div>
                <div class="font-semibold text-gray-800">${customerName}</div>
                <div class="text-sm text-gray-600 truncate">${address}</div>
                <div class="text-xs text-gray-500 mt-1 flex justify-between">
                    <span>${order.deliveryType || ''} | ${order.warehouse || ''}</span>
                    <span>נוצר: ${createdTime}</span>
                </div>
            `;
            return el;
        }
        function renderMapMarkers() {
            if (!map) return;
            const bounds = L.latLngBounds();
            Object.values(state.liveLocations).forEach(driverLoc => {
                if (!driverLoc.latitude || !driverLoc.longitude) return;
                const driverData = state.drivers.find(d => d.id === driverLoc.id);
                const name = driverData?.name || 'נהג לא ידוע';
                const latLng = [driverLoc.latitude, driverLoc.longitude];
                const icon = driverLoc.isStuck ? driverIconStuck : driverIconActive;
                const popupContent = `<h4>${name}</h4><p>${driverLoc.isStuck ? 'תקוע' : 'פעיל'} | עדכון לפני ${driverLoc.minutesAgo || '?'} דקות</p>`;
                if (driverMarkers[driverLoc.id]) {
                    driverMarkers[driverLoc.id].setLatLng(latLng).setIcon(icon).setPopupContent(popupContent);
                } else {
                    driverMarkers[driverLoc.id] = L.marker(latLng, { icon: icon }).addTo(map).bindPopup(popupContent).on('click', () => focusOnMapItem(driverLoc.id, 'driver'));
                }
                 if (!driverLoc.isStuck) bounds.extend(latLng);
            });
            const unassignedOrders = state.orders.filter(o => o.status === 'חדש' && o.latitude && o.longitude);
            Object.keys(orderMarkers).forEach(orderId => {
                if (!unassignedOrders.some(o => o.id == orderId)) {
                    if (map.hasLayer(orderMarkers[orderId])) {
                        map.removeLayer(orderMarkers[orderId]);
                    }
                    delete orderMarkers[orderId];
                }
            });
            unassignedOrders.forEach(order => {
                const latLng = [order.latitude, order.longitude];
                const customerName = order.customer?.name || 'לקוח לא ידוע';
                const displayId = order.orderNumber || `#${order.id.slice(-6)}`;
                const popupContent = `
                    <h4>הזמנה ${displayId}</h4><p>${customerName}</p><p>${order.address || '...'}</p>
                    <button class="w-full mt-2 px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600" 
                            onclick="showAssignDriverModal('${order.id}')">שייך נהג</button>`;
                if (orderMarkers[order.id]) {
                    orderMarkers[order.id].setLatLng(latLng).setPopupContent(popupContent);
                } else {
                    orderMarkers[order.id] = L.marker(latLng, { icon: orderIconNew }).addTo(map).bindPopup(popupContent).on('click', () => focusOnMapItem(order.id, 'order'));
                }
                bounds.extend(latLng);
            });
            if (bounds.isValid() && (unassignedOrders.length > 0 || Object.keys(driverMarkers).some(id => !state.liveLocations[id]?.isStuck) )) {
                 try { map.fitBounds(bounds, { padding: [50, 50] }); } catch (e) { console.warn("FitBounds error:", e); }
            } else if (!bounds.isValid()) {
                map.setView(ISRAEL_CENTER, 9);
            }
        }
        
        // --- (פונקציות עמוד היסטוריה ולקוחות נשארות זהות) ---
        

        // --- UI & MAP INTERACTIONS ---
        
        function showView(viewName) {
            // ... (קוד פונקציה זו נשאר זהה) ...
        }
        window.showView = showView; 
        
        
        // *** MODIFIED: showPanelTab ***
        function showPanelTab(tabName) {
            // Hide all lists
            document.getElementById('orders-list').style.display = 'none';
            document.getElementById('drivers-list').style.display = 'none';
            document.getElementById('chat-rooms-list').style.display = 'none';
            
            // Hide all panels
            document.getElementById('details-panel').style.display = 'none';
            document.getElementById('chat-window-panel').style.display = 'none'; // flex
            
            // Deactivate all tabs
            document.getElementById('tab-orders').classList.remove('active');
            document.getElementById('tab-drivers').classList.remove('active');
            document.getElementById('tab-chat').classList.remove('active');
            
            // Show relevant items
            if (tabName === 'orders') {
                document.getElementById('orders-list').style.display = 'block';
                document.getElementById('details-panel').style.display = 'block';
                document.getElementById('tab-orders').classList.add('active');
                document.getElementById('search-bar').style.display = 'block';
                closeDetailsPanel(); // Clear details
            } else if (tabName === 'drivers') {
                document.getElementById('drivers-list').style.display = 'block';
                document.getElementById('details-panel').style.display = 'block';
                document.getElementById('tab-drivers').classList.add('active');
                document.getElementById('search-bar').style.display = 'block';
                closeDetailsPanel(); // Clear details
            } else if (tabName === 'chat') {
                document.getElementById('chat-rooms-list').style.display = 'block';
                document.getElementById('chat-window-panel').style.display = 'flex'; // Chat window uses flex
                document.getElementById('tab-chat').classList.add('active');
                document.getElementById('search-bar').style.display = 'none'; // Hide search bar for chat
            }
        }
        window.showPanelTab = showPanelTab; // Make global
        
        function filterLists() {
            // ... (קוד פונקציה זו נשאר זהה) ...
        }
        
        function focusOnMapItem(id, type) {
            // ... (קוד פונקציה זו נשאר זהה) ...
        }

        function showAssignDriverModal(orderId) {
            // ... (קוד פונקציה זו נשאר זהה) ...
        }
        
        async function assignOrderToDriver(orderId, driverId) {
            // ... (קוד פונקציה זו נשאר זהה) ...
        }

        // --- SMART PANEL LOGIC (Details) ---

        function renderDetailsPanel(id, type) {
            // ... (קוד פונקציה זו נשאר זהה) ...
        }
        
        function closeDetailsPanel() {
            document.getElementById('details-panel').style.display = 'none';
            document.querySelectorAll('.driver-card, .order-card').forEach(c => c.classList.remove('active'));
        }
        window.closeDetailsPanel = closeDetailsPanel; 
        
        // --- Geocoding Function ---
        async function geocodeAddress(address) {
            // ... (קוד פונקציה זו נשאר זהה) ...
        }

        // --- STATUS UPDATE FUNCTIONS ---
        function promptForStatusChange(orderId, currentStatus) {
            // ... (קוד פונקציה זו נשאר זהה) ...
        }
        window.promptForStatusChange = promptForStatusChange; 

        async function updateOrderStatus(orderId, newStatus) {
             // ... (קוד פונקציה זו נשאר זהה) ...
        }
        
        // --- NEW ORDER FORM ---
        function populateCustomerDatalist() {
            // ... (קוד פונקציה זו נשאר זהה) ...
        }
        function openNewOrderForm() {
             // ... (קוד פונקציה זו נשאר זהה) ...
        }
        window.openNewOrderForm = openNewOrderForm; 

        function closeNewOrderForm() {
            // ... (קוד פונקציה זו נשאר זהה) ...
        }
        window.closeNewOrderForm = closeNewOrderForm; 
        
        function handleCustomerSearch(value) {
            // ... (קוד פונקציה זו נשאר זהה) ...
        }
        window.handleCustomerSearch = handleCustomerSearch; 
        
        async function submitNewOrder(event) {
            // ... (קוד פונקציה זו נשאר זהה) ...
        }
        window.submitNewOrder = submitNewOrder; 

         // --- CUSTOMER EDIT MODAL ---
         function openCustomerEditModal(customerId) {
             // ... (קוד פונקציה זו נשאר זהה) ...
         }
         window.openCustomerEditModal = openCustomerEditModal; 

         function closeCustomerEditModal() {
             // ... (קוד פונקציה זו נשאר זהה) ...
         }
         window.closeCustomerEditModal = closeCustomerEditModal; 

         async function handleSaveCustomer(event) {
             // ... (קוד פונקציה זו נשאר זהה) ...
         }
         window.handleSaveCustomer = handleSaveCustomer; 

         // --- DRIVER HISTORY PAGE ---
         // ... (קוד עמוד היסטוריית נהגים נשאר זהה) ...

        
        // --- HELPERS (Loader, Toast, Clipboard) ---
        function showLoader(elementId, show) {
            // ... (קוד פונקציה זו נשאר זהה) ...
        }
        
        function showToast(message, type = 'info') {
            // ... (קוד פונקציה זו נשאר זהה) ...
        }
        
        function copyToClipboard(text) {
            // ... (קוד פונקציה זו נשאר זהה) ...
        }

        function copyCustomerLink(orderId) {
             // ... (קוד פונקציה זו נשאר זהה) ...
        }
        window.copyCustomerLink = copyCustomerLink; 
        
        // --- Global Ping Function ---
        async function sendGlobalPing() {
             // ... (קוד פונקציה זו נשאר זהה) ...
        }
        window.sendGlobalPing = sendGlobalPing; 


        // ===========================================
        // *** NEW CHAT LOGIC             ***
        // ===========================================

        function renderChatRoom(room) {
            const el = document.createElement('div');
            el.className = 'chat-room-item';
            el.id = `chat-room-${room.id}`;
            el.setAttribute('data-search', room.name.toLowerCase());
            el.onclick = () => switchRoom(room.id, room.name);
            
            el.innerHTML = `
                <div class="font-semibold">${room.name}</div>
                <div class_id="text-sm text-gray-500 truncate">${room.lastMessage || '...'}</div>
            `;
            return el;
        }

        function listenToChatRooms() {
            const roomsEl = document.getElementById('chat-rooms-list');
            const collectionPath = `artifacts/${appId}/public/data/chat_rooms`;
            SmartLog('Firestore', `Listening to rooms: ${collectionPath}`, "Chat");
            
            try {
                const q = query(collection(db, collectionPath)); // Add orderBy if needed
                onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        roomsEl.innerHTML = `<div class="p-4 text-sm text-center text-gray-500">לא נמצאו חדרי צ'אט.</div>`;
                        return;
                    }
                    
                    state.chatRooms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    roomsEl.innerHTML = ''; // Clear
                    state.chatRooms.forEach(room => {
                        roomsEl.appendChild(renderChatRoom(room));
                    });
                    
                    showLoader('chat-rooms-list', false);

                }, (error) => {
                    SmartLog.error(error, "Chat.Rooms.Listener");
                    roomsEl.innerHTML = `<div class="p-4 text-red-500">שגיאה בטעינת חדרים.</div>`;
                });
            } catch (e) { SmartLog.error(e, "Chat.Rooms.Init"); }
        }

        function switchRoom(roomId, roomName) {
            if (state.currentRoomId === roomId) return; // Already in this room
            
            state.currentRoomId = roomId;
            
            // Update UI
            document.querySelectorAll('.chat-room-item').forEach(i => i.classList.remove('active'));
            document.getElementById(`chat-room-${roomId}`).classList.add('active');
            
            document.getElementById('chat-window-header').textContent = roomName;
            document.getElementById('chat-message-list').innerHTML = ''; // Clear messages
            document.getElementById('chat-input').disabled = false;
            
            listenToMessages(roomId);
        }

        function listenToMessages(roomId) {
            state.unsubscribeMessages(); // Stop listening to old room
            
            const collectionPath = `artifacts/${appId}/public/data/messages`;
            SmartLog('Firestore', `Listening to messages where roomId == ${roomId}`, "Chat");
            
            try {
                const q = query(
                    collection(db, collectionPath), 
                    where('roomId', '==', roomId),
                    orderBy('createdAt', 'asc') // Show oldest first
                );

                state.unsubscribeMessages = onSnapshot(q, (snapshot) => {
                    document.getElementById('chat-message-list').innerHTML = ''; // Clear list
                    snapshot.docs.forEach(doc => renderChatMessage(doc.data()));
                    scrollToBottom();
                }, (error) => {
                    SmartLog.error(error, "Chat.Messages.Listener");
                    document.getElementById('chat-message-list').innerHTML = `<div class="p-4 text-red-500">שגיאה בטעינת הודעות.</div>`;
                });
            } catch (e) { SmartLog.error(e, "Chat.Messages.Init"); }
        }

        function renderChatMessage(msg) {
            const listEl = document.getElementById('chat-message-list');
            if (!listEl) return;
            
            // (Assuming auth.currentUser.uid is available, otherwise need to get it from authReadyPromise)
            const currentUserId = auth.currentUser ? auth.currentUser.uid : null;
            const isSent = msg.senderId === currentUserId; // 'מנהל' שולח
            
            const bubbleClass = isSent ? 'chat-bubble-sent' : 'chat-bubble-received';
            
            const time = msg.createdAt ? new Date(msg.createdAt.seconds * 1000).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '';
            
            const msgEl = document.createElement('div');
            msgEl.className = `chat-bubble ${bubbleClass}`;
            
            // הצגת שם השולח אם זה לא המשתמש הנוכחי
            const senderName = isSent ? '' : `<div class="font-semibold text-xs mb-1">${msg.senderName || 'אלמוני'}</div>`;

            msgEl.innerHTML = `
                ${senderName}
                <p>${msg.text}</p>
                <div class="text-xs opacity-70 mt-1 text-left">${time}</div>
            `;
            listEl.appendChild(msgEl);
        }

        function scrollToBottom() {
            const listEl = document.getElementById('chat-message-list');
            if (listEl) {
                listEl.scrollTop = listEl.scrollHeight;
            }
        }

        async function handleSendMessage() {
            const inputEl = document.getElementById('chat-input');
            const text = inputEl.value.trim();
            
            if (!text || !state.currentRoomId) return;

            inputEl.disabled = true;

            const collectionPath = `artifacts/${appId}/public/data/messages`;
            const messageData = {
                text,
                roomId: state.currentRoomId,
                senderId: auth.currentUser ? auth.currentUser.uid : 'unknown_admin',
                senderName: "מנהל", 
                createdAt: serverTimestamp() 
            };
            
            try {
                await addDoc(collection(db, collectionPath), messageData);
                inputEl.value = ''; // Clear input
                // עדכון ההודעה האחרונה בחדר (אופציונלי, לשיפור)
                const roomRef = doc(db, `artifacts/${appId}/public/data/chat_rooms`, state.currentRoomId);
                await updateDoc(roomRef, { lastMessage: text, lastMessageAt: serverTimestamp() });

            } catch (e) {
                SmartLog.error(e, "Chat.Send");
                showToast('שגיאה בשליחת הודעה', 'error');
            } finally {
                inputEl.disabled = false;
                inputEl.focus();
            }
        }

        // Make functions globally accessible for inline event handlers
        window.filterLists = filterLists;
        window.showAssignDriverModal = showAssignDriverModal;

    </script>
</body>
</html>
