<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✍️ מרכז הודעות (v5.1 - Glassmorphism)</title>
    <!-- 
      DeliveryMaster Admin - מרכז הודעות v5.1 (Glassmorphism + Bot)
      
      Changelog:
      - [FIX v5.2] - תיקון טעינה תקועה ע"י הסרת מיון שרת זמנית.
      - [FIX v5.1] - תיקון נתיבי ייבוא קריטיים של Firebase SDK.
      - [NEW v5.0] Glassmorphism UI
      - [NEW v5.0] Bot/Agent Flow
      - [NEW v5.0] חווית צ'אט (וי קריאה, חיווי הקלדה)
    -->
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Google Font: Rubik & Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: rgba(229, 231, 235, 0.7); /* gray-200 w/ opacity */
            --text-dark: #1f2937; /* gray-800 */
            --text-light: #6b7280; /* gray-500 */
            
            /* Glassmorphism */
            --bg-glass: rgba(255, 255, 255, 0.6);
            --border-glass: rgba(255, 255, 255, 0.4);
            --shadow-glass: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        html.dark {
            --bg-light: #1f2937;
            --bg-white: #374151;
            --border-color: rgba(75, 85, 99, 0.7);
            --text-dark: #f3f4f6;
            --text-light: #9ca3af;
            --bg-glass: rgba(55, 65, 81, 0.6);
            --border-glass: rgba(255, 255, 255, 0.1);
            --shadow-glass: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: 'Inter', 'Rubik', sans-serif;
            background-color: #f3f4f6;
            color: var(--text-dark);
            overflow: hidden;
            height: 100vh;
            margin: 0;
            background-image: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
        }
        
        .glass-wrapper {
            width: calc(100% - 4rem);
            height: calc(100vh - 4rem);
            margin: 2rem;
            background: var(--bg-glass);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid var(--border-glass);
            border-radius: 1.5rem; /* 2xl */
            box-shadow: var(--shadow-glass);
            overflow: hidden;
            display: grid;
            grid-template-columns: 350px 1fr; /* Sidebar, Main Chat */
        }
        html.dark .glass-wrapper {
             background: var(--bg-glass);
             border-color: var(--border-glass);
        }

        /* --- Sidebar (Conversation List) --- */
        #conversation-list {
            background-color: rgba(255, 255, 255, 0.5);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        html.dark #conversation-list {
            background-color: rgba(31, 41, 55, 0.5);
            border-left-color: var(--border-glass);
        }

        .header {
            padding: 1.5rem;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
        }
        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        .search-bar {
            position: relative;
            margin-top: 1rem;
        }
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem; /* Padding for icon */
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background-color: var(--bg-white);
            color: var(--text-dark);
            transition: all 0.2s;
            box-sizing: border-box;
        }
        html.dark .search-input {
            background-color: #4b5563; /* gray-600 */
            border-color: #6b7280; /* gray-500 */
            color: var(--text-dark);
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        .search-icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }
        
        /* [NEW v4.3] Tab Buttons */
        .tab-filter {
            display: flex;
            justify-content: space-around;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            background-color: rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
        }
        html.dark .tab-filter {
            background-color: rgba(31, 41, 55, 0.2);
        }
        .tab-button {
            padding: 0.5rem 0.75rem;
            border: none;
            background: none;
            border-radius: 0.5rem;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-button:hover {
            background-color: rgba(255, 255, 255, 0.5);
            color: var(--text-dark);
        }
        html.dark .tab-button:hover {
            background-color: rgba(75, 85, 99, 0.5);
        }
        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
        }

        #conversation-items {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0.75rem;
        }
        .conv-item {
            display: flex;
            align-items: flex-start;
            padding: 1rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--border-color);
        }
        .conv-item:last-child {
            border-bottom: none;
        }
        .conv-item:hover {
            background-color: rgba(255, 255, 255, 0.7);
        }
        html.dark .conv-item:hover {
            background-color: rgba(75, 85, 99, 0.7);
        }
        .conv-item.active {
            background-color: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        html.dark .conv-item.active {
             background-color: rgba(75, 85, 99, 1);
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
            margin-left: 0.75rem;
        }
        .avatar.unread {
            background-color: #ef4444; /* red-500 */
        }
        .conv-details {
            flex-grow: 1;
            overflow: hidden;
        }
        .conv-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .conv-name {
            font-weight: 600;
            color: var(--text-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .conv-time {
            font-size: 0.75rem;
            color: var(--text-light);
            flex-shrink: 0;
        }
        .conv-preview {
            font-size: 0.875rem;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .conv-preview strong { /* Unread preview */
            color: var(--text-dark);
            font-weight: 600;
        }
        .conv-agent { /* [NEW v5.0] */
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--primary-dark);
        }
        html.dark .conv-agent {
            color: #93c5fd; /* blue-300 */
        }

        /* --- Main Chat Area --- */
        #chat-area {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #chat-welcome {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            padding: 2rem;
            text-align: center;
        }
        #chat-welcome svg {
            width: 80px;
            height: 80px;
            stroke-width: 1.5;
            margin-bottom: 1rem;
        }
        
        #chat-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #chat-header-details {
            overflow: hidden;
        }
        #chat-header-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #chat-header-phone {
            font-size: 0.875rem;
            color: var(--text-light);
        }
        #chat-header-actions {
            display: flex;
            gap: 0.5rem;
        }
        .action-btn {
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background: var(--bg-white);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
        }
        html.dark .action-btn {
            background-color: var(--bg-white);
            border-color: var(--border-color);
        }
        .action-btn:hover {
            background-color: var(--bg-light);
            color: var(--text-dark);
        }
        html.dark .action-btn:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .action-btn.takeover { /* [NEW v5.0] */
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .action-btn.takeover:hover {
            background-color: var(--primary-dark);
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }
        
        .message-bubble {
            max-width: 75%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            margin-bottom: 0.75rem;
            position: relative;
        }
        .message-in {
            background-color: var(--bg-white);
            color: var(--text-dark);
            border-bottom-right-radius: 0.25rem;
            align-self: flex-end;
        }
        html.dark .message-in {
            background-color: var(--bg-white);
        }
        .message-out {
            background-color: var(--primary-color);
            color: white;
            border-bottom-left-radius: 0.25rem;
            align-self: flex-start;
        }
        .message-text {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .message-time {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            opacity: 0.7;
            display: flex;
            align-items: center;
        }
        .message-in .message-time {
            text-align: right;
        }
        .message-out .message-time {
            text-align: left;
        }
        /* [NEW v5.0] Read Receipt */
        .read-receipt {
            font-family: sans-serif;
            font-size: 1rem;
            margin-right: 0.25rem;
            line-height: 1;
        }

        /* [NEW v5.0] Typing Indicator */
        .typing-indicator {
            align-self: flex-end;
            font-style: italic;
            color: var(--text-light);
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
        }

        #chat-input-area {
            flex-shrink: 0;
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            background-color: rgba(255, 255, 255, 0.5);
        }
        html.dark #chat-input-area {
            background-color: rgba(31, 41, 55, 0.5);
        }
        .chat-input-wrapper {
            position: relative;
        }
        #reply-message-text {
            width: 100%;
            padding: 1rem 3rem 1rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            background-color: var(--bg-white);
            color: var(--text-dark);
            resize: none;
            box-sizing: border-box;
            transition: all 0.2s;
        }
        html.dark #reply-message-text {
            background-color: #4b5563; /* gray-600 */
            border-color: #6b7280; /* gray-500 */
            color: var(--text-dark);
        }
        #reply-message-text:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        #send-reply-btn {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            padding: 0.5rem;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #send-reply-btn:hover {
            background-color: var(--primary-dark);
        }
        #send-reply-btn:disabled {
            background-color: #9ca3af; /* gray-400 */
            cursor: not-allowed;
        }
        
        /* [NEW v4.2] Quick Replies */
        #quick-replies {
            padding-top: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .quick-reply-btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            background-color: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 99px;
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        html.dark .quick-reply-btn {
            background-color: var(--bg-white);
            border-color: var(--border-color);
        }
        .quick-reply-btn:hover {
            background-color: var(--bg-light);
            border-color: var(--primary-color);
        }
        html.dark .quick-reply-btn:hover {
            background-color: #4b5563; /* gray-600 */
        }


        /* Loader */
        .loader-container {
            position: absolute;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(2px);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            z-index: 10;
        }
        html.dark .loader-container {
             background-color: rgba(31, 41, 55, 0.8);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }

        /* Responsive */
        @media (max-width: 768px) {
            .glass-wrapper {
                margin: 0;
                height: 100vh;
                width: 100vw;
                border-radius: 0;
                grid-template-columns: 1fr; /* Stack columns */
            }
            #conversation-list {
                /* When a chat is active, hide the list */
                display: none;
            }
            .chat-active #conversation-list {
                display: flex;
            }
            .chat-active #chat-area {
                display: none;
            }
            
            /* On mobile, when a chat is selected, we hide the list and show the chat */
            body.chat-selected #conversation-list {
                display: none;
            }
            body.chat-selected #chat-area {
                display: flex;
            }

            #chat-header {
                padding: 1rem;
            }
            /* Add a back button to the chat header on mobile */
            #back-to-list-btn {
                display: block;
                margin-left: 0.75rem;
            }
            #chat-header-details {
                /* Show back button */
                display: flex;
                align-items: center;
            }
        }
    </style>
</head>
<body class=""> <!-- 'chat-selected' class will be added by JS on mobile -->
    
    <!-- רקע גרדיאנט קבוע -->
    <div class="app-background"></div>

    <!-- מארז Glassmorphism ראשי -->
    <div class="glass-wrapper">
        <!-- רשימת שיחות (Sidebar) -->
        <aside id="conversation-list">
            <div class="header">
                <h1 class="header-title">✍️ מרכז הודעות</h1>
                <div class="search-bar">
                    <input type="text" id="search-conversations" class="search-input" placeholder="חפש לפי שם, טלפון או תוכן...">
                    <i data-feather="search" class="search-icon"></i>
                </div>
            </div>
            
            <!-- [NEW v4.3] פילטר טאבים -->
            <div class="tab-filter">
                 <button class="tab-button active" onclick="setConversationFilter('all')">הכל</button>
                 <button class="tab-button" onclick="setConversationFilter('unread')">לא נקראו</button>
                 <button class="tab-button" onclick="setConversationFilter('agent')">בטיפולך</button>
                 <button class="tab-button" onclick="setConversationFilter('bot')">בטיפול בוט</button>
            </div>

            <div id="conversation-items">
                <!-- Loader -->
                <div id="conv-loader" class="loader-container">
                    <div class="loader"></div>
                </div>
                <!-- שיחות יטענו לכאן ע"י JS -->
            </div>
        </aside>

        <!-- אזור צ'אט מרכזי -->
        <main id="chat-area">
            <!-- מצב פתיחה (Welcome) -->
            <div id="chat-welcome" class="">
                <i data-feather="message-square"></i>
                <h2 class="text-xl font-semibold">ברוך הבא למרכז ההודעות</h2>
                <p>בחר שיחה מהרשימה בצד ימין כדי להתחיל.</p>
            </div>

            <!-- אזור צ'אט פעיל (מוסתר כברירת מחדל) -->
            <div id="chat-active" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
                <!-- כותרת הצ'אט -->
                <header id="chat-header">
                    <div id="chat-header-details">
                        <!-- [NEW] כפתור חזרה למובייל -->
                        <button id="back-to-list-btn" class="action-btn" style="display: none;" onclick="goBackToList()">
                             <i data-feather="arrow-right"></i>
                        </button>
                        <div>
                            <h2 id="chat-header-name">טוען...</h2>
                            <p id="chat-header-phone"></p>
                        </div>
                    </div>
                    <div id="chat-header-actions">
                        <button id="escalate-btn" class="action-btn takeover" title="השתלט על השיחה" onclick="escalateToHuman()">
                            <i data-feather="user-check"></i>
                        </button>
                        <button class="action-btn" title="סגור שיחה (ארכיון)" onclick="archiveConversation()">
                            <i data-feather="archive"></i>
                        </button>
                    </div>
                </header>

                <!-- הודעות -->
                <div id="chat-messages">
                    <!-- Loader -->
                    <div id="chat-loader" class="loader-container">
                        <div class="loader"></div>
                    </div>
                    <!-- הודעות יטענו לכאן -->
                </div>

                <!-- אזור הקלדה -->
                <footer id="chat-input-area">
                    <!-- [NEW v4.2] Quick Replies -->
                    <div id="quick-replies">
                        <!-- כפתורים מהירים יטענו לכאן -->
                    </div>
                    
                    <div class="chat-input-wrapper">
                        <textarea id="reply-message-text" rows="3" placeholder="הקלד את תשובתך..." disabled></textarea>
                        <button id="send-reply-btn" title="שלח" onclick="sendAdminReply()" disabled>
                            <i data-feather="send"></i>
                        </button>
                    </div>
                </footer>
            </div>
        </main>
    </div>

    <!-- 
      ==========================================================
      ===               תחילת סקריפט ראשי (v5.1)              ===
      ==========================================================
    -->
    <script type="module">
        // [FIX v5.1] תיקון נתיבי ייבוא
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, 
            collection, query, where, Timestamp, runTransaction, getDocs, orderBy, 
            serverTimestamp, limit, writeBatch, collectionGroup, arrayUnion
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        // --- Global Variables ---
        let db, auth;
        let currentUserId = "Admin"; // מנהל תמיד
        let allConversations = [];
        let currentConversationId = null;
        let messagesUnsubscribe = null;
        let conversationsUnsubscribe = null;
        let currentConversationFilter = 'all'; // [NEW v4.3]
        
        // [NEW v5.0] Admin details
        const ADMIN_AGENT = {
            id: "Admin",
            name: "צוות האתר"
        };

        // --- Firebase Config (Placeholder) ---
        const fallbackConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949",
          storageBucket: "saban94-78949.appspot.com",
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a", 
          measurementId: "G-XV6RZDESSB"
        };
        
        // --- Initialization ---
        try {
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(fallbackConfig));
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase Initialized.");

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log("Admin User Signed In:", currentUserId);
                    ADMIN_AGENT.id = currentUserId; // עדכון מזהה מנהל
                    ADMIN_AGENT.name = user.displayName || "מנהל"; // עדכון שם מנהל אם קיים
                    
                    // התחל האזנה לשיחות
                    listenForConversations();
                    
                } else {
                    console.log("No user. Trying auth...");
                    try {
                        // נסה להתחבר עם טוקן מיוחד אם קיים
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            // אם לא, התחבר כאנונימי (לצורך גישה)
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                        document.getElementById('conv-loader').innerHTML = '<p class="p-4 text-red-500">שגיאת התחברות קריטית ל-Firebase.</p>';
                    }
                }
            });

        } catch (e) {
            console.error("Firebase Initialization Failed:", e);
            document.getElementById('conv-loader').innerHTML = '<p class="p-4 text-red-500">שגיאה באתחול Firebase.</p>';
        }

        // --- Data Listeners ---

        function listenForConversations() {
            // [FIX v5.2] הסרת המיון הזמנית כדי למנוע שגיאת אינדקס חסר
            // הדרך הנכונה היא ליצור אינדקס ב-Firebase על 'orders' -> 'lastMessageTimestamp' (descending)
            // const q = query(collection(db, "orders"), orderBy("lastMessageTimestamp", "desc"));
            
            // [חדש] שאילתה בסיסית ללא מיון (דורש אינדקס)
            const q = query(collection(db, "orders"));
            
            if (conversationsUnsubscribe) conversationsUnsubscribe();
            
            conversationsUnsubscribe = onSnapshot(q, (snapshot) => {
                document.getElementById('conv-loader').classList.add('hidden');
                allConversations = [];
                snapshot.forEach(doc => {
                    allConversations.push({ id: doc.id, ...doc.data() });
                });

                // [FIX v5.2] מיון בצד הלקוח (Client-side) בגלל הסרת המיון מהשרת
                allConversations.sort((a, b) => 
                    (b.lastMessageTimestamp?.toMillis() || 0) - (a.lastMessageTimestamp?.toMillis() || 0)
                );

                renderConversationList();
            }, (error) => {
                console.error("Error listening to conversations:", error);
                document.getElementById('conv-loader').innerHTML = `<p class="p-4 text-red-500">שגיאה בטעינת שיחות. ייתכן שחסר אינדקס במסד הנתונים: ${error.message}</p>`;
            });
        }

        function renderConversationList() {
            const listEl = document.getElementById('conversation-items');
            const search = document.getElementById('search-conversations').value.toLowerCase();
            
            let filteredConversations = allConversations.filter(conv => {
                // 1. Filter by Search
                const searchMatch = !search ||
                    (conv.customer?.name && conv.customer.name.toLowerCase().includes(search)) ||
                    (conv.customer?.phone && conv.customer.phone.toLowerCase().includes(search)) ||
                    (conv.lastMessage && conv.lastMessage.toLowerCase().includes(search));
                
                if (!searchMatch) return false;

                // 2. Filter by Tab [NEW v4.3]
                switch (currentConversationFilter) {
                    case 'unread':
                        // הצג רק שיחות עם adminHasUnread
                        return conv.adminHasUnread === true;
                    case 'agent':
                        // הצג רק שיחות שמשויכות למנהל
                        return conv.agent?.id === ADMIN_AGENT.id;
                    case 'bot':
                        // הצג רק שיחות שאינן משויכות למנהל (בטיפול בוט)
                        return !conv.agent || conv.agent.id !== ADMIN_AGENT.id;
                    case 'all':
                    default:
                        return true; // הצג הכל
                }
            });

            if (filteredConversations.length === 0) {
                listEl.innerHTML = '<p class="p-4 text-center text-gray-500">לא נמצאו שיחות תואמות.</p>';
                return;
            }
            
            listEl.innerHTML = filteredConversations.map(conv => {
                const isActive = conv.id === currentConversationId;
                const isUnread = conv.adminHasUnread;
                const time = conv.lastMessageTimestamp?.toDate ? formatTime(conv.lastMessageTimestamp.toDate()) : '';
                const initial = (conv.customer?.name || "א")[0].toUpperCase();
                
                // [NEW v5.0] הגדרת סוכן
                const agentName = conv.agent?.id === ADMIN_AGENT.id ? "בטיפולך" : "בטיפול בוט";

                return `
                    <div class="conv-item ${isActive ? 'active' : ''}" onclick="selectConversation('${conv.id}')">
                        <div class="avatar ${isUnread ? 'unread' : ''}">${initial}</div>
                        <div class="conv-details">
                            <div class="conv-header">
                                <span class="conv-name">${conv.customer?.name || 'לקוח לא ידוע'}</span>
                                <span class="conv-time">${time}</span>
                            </div>
                            <p class="conv-preview ${isUnread ? 'font-bold text-gray-800 dark:text-gray-200' : ''}">
                                ${conv.lastMessage || '...'}
                            </p>
                            <p class="conv-agent">${agentName}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function selectConversation(convId) {
            if (currentConversationId === convId) return; // אל תטען מחדש אם כבר נבחר
            
            currentConversationId = convId;
            renderConversationList(); // עדכון הרשימה להצגת 'active'
            
            // הצג את אזור הצ'אט והסתר את הפתיח
            document.getElementById('chat-welcome').classList.add('hidden');
            document.getElementById('chat-active').classList.remove('hidden');
            document.getElementById('chat-loader').classList.remove('hidden');
            
            // הפעל כפתורי שליחה
            document.getElementById('reply-message-text').disabled = false;
            document.getElementById('send-reply-btn').disabled = false;

            // עדכון כותרת
            const conv = allConversations.find(c => c.id === convId);
            if (conv) {
                document.getElementById('chat-header-name').innerText = conv.customer?.name || 'לקוח';
                document.getElementById('chat-header-phone').innerText = conv.customer?.phone || '';
                // [NEW v5.0] הצג/הסתר כפתור השתלטות
                const escalateBtn = document.getElementById('escalate-btn');
                if (conv.agent?.id === ADMIN_AGENT.id) {
                    escalateBtn.style.display = 'none'; // כבר בטיפולך
                } else {
                    escalateBtn.style.display = 'block'; // בטיפול בוט
                }
            }

            // האזנה להודעות
            if (messagesUnsubscribe) messagesUnsubscribe();
            
            const messagesCol = collection(db, "orders", convId, "messages");
            const q = query(messagesCol, orderBy("timestamp", "asc"));
            
            messagesUnsubscribe = onSnapshot(q, (snapshot) => {
                document.getElementById('chat-loader').classList.add('hidden');
                const messagesEl = document.getElementById('chat-messages');
                messagesEl.innerHTML = ''; // נקה הודעות קודמות
                
                snapshot.forEach(doc => {
                    messagesEl.appendChild(createMessageBubble(doc.data()));
                });

                // בדוק אם יש חיווי הקלדה [NEW v5.0]
                const currentConv = allConversations.find(c => c.id === currentConversationId);
                if (currentConv && currentConv.customerIsTyping === true) {
                    messagesEl.appendChild(createTypingIndicator());
                }

                scrollToBottom();
            }, (error) => {
                console.error("Error fetching messages:", error);
                document.getElementById('chat-loader').innerHTML = '<p class="p-4 text-red-500">שגיאה בטעינת הודעות.</p>';
            });

            // סמן כנקרא
            if (conv && conv.adminHasUnread) {
                await updateDoc(doc(db, "orders", convId), {
                    adminHasUnread: false
                });
            }
            
            // טען תשובות מהירות
            loadQuickReplies(conv.lastBotMessageKey);
            
            // עדכון תצוגה למובייל
            document.body.classList.add('chat-selected');
        }
        window.selectConversation = selectConversation; // Expose globally

        // --- פונקציות UI (מובייל, יצירת בועות) ---
        function goBackToList() {
            document.body.classList.remove('chat-selected');
            currentConversationId = null;
            if (messagesUnsubscribe) messagesUnsubscribe();
            renderConversationList();
        }
        window.goBackToList = goBackToList;

        function createMessageBubble(msg) {
            const bubble = document.createElement('div');
            const isOut = msg.sender === 'customer'; // 'customer' = יוצא (מהמנהל), 'bot'/'agent' = נכנס
            
            const time = msg.timestamp?.toDate ? formatTime(msg.timestamp.toDate()) : '';
            const readReceipt = isOut ? '✓' : '✓'; // [NEW v5.0]

            bubble.className = `message-bubble ${isOut ? 'message-out' : 'message-in'}`;
            bubble.innerHTML = `
                <div class="message-text">${msg.text.replace(/\n/g, '<br>')}</div>
                <div class="message-time">
                    <span class="read-receipt">${readReceipt}</span>
                    ${time}
                </div>
            `;
            return bubble;
        }

        function createTypingIndicator() {
             const typingEl = document.createElement('div');
             typingEl.className = 'typing-indicator';
             typingEl.innerText = '...מקליד ✍️';
             return typingEl;
        }

        function scrollToBottom() {
            const messagesEl = document.getElementById('chat-messages');
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // --- שליחת הודעות ופעולות ---

        async function sendAdminReply() {
            const textarea = document.getElementById('reply-message-text');
            const text = textarea.value.trim();
            if (!text || !currentConversationId) return;

            // [NEW v5.0] ודא שהשיחה משויכת למנהל לפני שליחה
            const convRef = doc(db, "orders", currentConversationId);
            const convSnap = await getDoc(convRef);
            if (!convSnap.exists() || convSnap.data().agent?.id !== ADMIN_AGENT.id) {
                // אם לא, בצע השתלטות אוטומטית
                await escalateToHuman(false); // בצע השתלטות שקטה
            }

            const message = {
                text: text,
                sender: "agent", // המנהל הוא 'agent'
                timestamp: serverTimestamp(),
                agent: ADMIN_AGENT // שמור מידע על המנהל ששלח
            };

            textarea.value = ''; // נקה מיידית
            
            try {
                // הוסף הודעה חדשה
                await addDoc(collection(db, "orders", currentConversationId, "messages"), message);
                
                // עדכן את השיחה הראשית
                await updateDoc(convRef, {
                    lastMessage: text,
                    lastMessageTimestamp: serverTimestamp(),
                    adminHasUnread: false,
                    customerHasUnread: true, // סמן כלא נקרא עבור הלקוח
                    lastBotMessageKey: null, // נקה תשובות מהירות
                    customerIsTyping: false // [NEW v5.0]
                });
                
                loadQuickReplies(null); // נקה תשובות מהירות
                scrollToBottom();
            } catch (error) {
                console.error("Error sending reply:", error);
                showToast("שגיאה בשליחת ההודעה", "error");
                textarea.value = text; // החזר טקסט במקרה של כשל
            }
        }
        window.sendAdminReply = sendAdminReply;

        /**
         * [NEW v5.0] השתלטות על שיחה
         */
        async function escalateToHuman(showAlert = true) {
            if (!currentConversationId) return;
            
            const convRef = doc(db, "orders", currentConversationId);
            try {
                await updateDoc(convRef, {
                    agent: ADMIN_AGENT, // שייך למנהל הנוכחי
                    lastBotMessageKey: null // נקה תשובות מהירות של הבוט
                });
                
                // הסתר את כפתור ההשתלטות
                document.getElementById('escalate-btn').style.display = 'none';
                loadQuickReplies(null); // נקה תשובות מהירות
                
                if (showAlert) {
                    showToast("השיחה שויכה אליך. הלקוח יקבל כעת את הודעותיך.", "success");
                }
            } catch (error) {
                console.error("Error escalating to human:", error);
                if (showAlert) {
                    showToast("שגיאה בהשתלטות על השיחה", "error");
                }
            }
        }
        window.escalateToHuman = escalateToHuman;


        async function archiveConversation() {
            if (!currentConversationId) return;
            
            // [הערה] פעולה זו צריכה להיות 'סגור' ולא 'מחק'
            // אנו משנים את הסטטוס כדי שהמאזין הראשי יפסיק להביא אותה
            
            // [הערה 2] - כרגע המאזין הראשי לא מסנן לפי סטטוס.
            // נוסיף סטטוס 'Archived'
            
            if (!confirm("האם אתה בטוח שברצונך לסגור (לשמור בארכיון) שיחה זו?")) return;

            try {
                await updateDoc(doc(db, "orders", currentConversationId), {
                    status: "Archived", // סטטוס חדש
                    adminHasUnread: false // נקה חיווי
                });
                
                // חזור לרשימה
                document.getElementById('chat-welcome').classList.remove('hidden');
                document.getElementById('chat-active').classList.add('hidden');
                goBackToList();
                
                showToast("השיחה הועברה לארכיון", "success");

            } catch (error) {
                console.error("Error archiving conversation:", error);
                showToast("שגיאה בסגירת השיחה", "error");
            }
        }
        window.archiveConversation = archiveConversation;

        // --- Helpers ---
        function formatTime(date) {
            return date.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
        }
        
        function showToast(message, type = 'success') {
            // (פונקציית עזר להצגת התראות - ניתן להוסיף כאן)
            console.log(`[${type}]: ${message}`);
        }
        
        // [NEW v4.2] טעינת תשובות מהירות
        async function loadQuickReplies(key) {
            const container = document.getElementById('quick-replies');
            container.innerHTML = '';
            if (!key) return; // אין מפתח, אין תשובות

            try {
                const docRef = doc(db, "bot_quick_replies", key);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && docSnap.data().replies) {
                    docSnap.data().replies.forEach(reply => {
                        const btn = document.createElement('button');
                        btn.className = 'quick-reply-btn';
                        btn.innerText = reply;
                        btn.onclick = () => {
                            const textarea = document.getElementById('reply-message-text');
                            textarea.value = reply;
                            textarea.focus();
                        };
                        container.appendChild(btn);
                    });
                }
            } catch (error) {
                console.error("Error loading quick replies:", error);
            }
        }
        
        // [NEW v4.3] Filter tabs
        function setConversationFilter(filter) {
            currentConversationFilter = filter;
            // Update active button
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-button[onclick="setConversationFilter('${filter}')"]`).classList.add('active');
            renderConversationList(); // Re-render the list
        }
        window.setConversationFilter = setConversationFilter;

        // --- Init ---\
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            document.getElementById('search-conversations').addEventListener('keyup', renderConversationList);
            
            // [NEW v4.3] Dark mode init
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
</body>
</html>

