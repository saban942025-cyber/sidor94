<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✍️ מרכז הודעות (v5.0 - Glassmorphism)</title>
    <!-- 
      DeliveryMaster Admin - מרכז הודעות v5.0 (Glassmorphism + Bot)
      
      Changelog:
      - [NEW v5.0] Glassmorphism UI:
        - הוספת עטיפת "זכוכית" (glassmorphism) לכל האפליקציה.
        - עדכון רקעים וגופנים (Inter/Rubik) לעיצוב מודרני.
      - [NEW v5.0] Bot/Agent Flow:
        - הוספת כפתור "השתלט על השיחה" (Force Takeover) בכרטיס הלקוח.
        - הטמעת פונקציית `escalateToHuman` שמשייכת שיחה למנהל.
        - `sendAdminReply` מוודא שהשיחה משויכת למנהל לפני שליחה.
        - עדכון חיווי "משויך ל:" בכרטיס הלקוח (בוט / בטיפולך).
      - [NEW v5.0] חווית צ'אט:
        - הוספת "וי קריאה" (✔️) להודעות נכנסות ויוצאות.
        - חיווי הקלדה "...מקליד ✍️" מופעל על ידי `order.customerIsTyping`.
      - [FIX v5.1] ייצוב טעינה ו-Auth Loop:
        - הוספת דגל `appInitialized` למניעת קריאות כפולות ל-Firestore.
        - הוספת בדיקות בטיחות לפונקציות `setConversationFilter`.
        - תיקון נתיבי ייבוא (Import) של Firebase.
        - תיקון שאילתת טעינה ראשונית (שימוש בקולקציית `conversations`).
        - החזרת מיון + הוספת `limit` לשאילתה.
      - [FIX v5.2] תיקון לוגיקת Auth:
        - הפרדת תהליך ההתחברות (Sign-in) מהמאזין (onAuthStateChanged)
        - מניעת "Chicken-and-egg" problem שגרם לטעינה אינסופית.
      - [FIX v5.3] אילוץ שגיאת אינדקס:
        - הסרת `limit()` מהשאילתה הראשית כדי לאלץ את Firestore
        - להחזיר שגיאת אינדקס ברורה וניתנת ללחיצה.
    -->
    
    <!-- Icons (Feather) & Fonts -->
    <script src="https://unpkg.com/feather-icons"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // הפעלת מצב כהה
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Rubik', 'sans-serif'],
                    },
                    colors: {
                        'brand-blue': '#3b82f6',
                        'brand-dark': '#1f2937',
                        'brand-light': '#f3f4f6',
                    }
                }
            }
        }
    </script>
    
    <!-- סגנון מותאם אישית (Glassmorphism) -->
    <style>
        body {
            font-family: 'Inter', 'Rubik', sans-serif;
            background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
            overflow: hidden;
        }
        
        .glass-wrapper {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 1.5rem; /* 2xl */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            overflow: hidden;
            height: calc(100vh - 4rem);
            margin: 2rem;
            display: grid;
            grid-template-columns: 350px 1fr;
        }
        
        /* Dark Mode */
        html.dark body {
            background: linear-gradient(120deg, #0f172a 0%, #1e293b 100%);
        }
        html.dark .glass-wrapper {
            background: rgba(30, 41, 59, 0.6); /* slate-800 */
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }
        html.dark .glass-sidebar {
            background: rgba(55, 65, 81, 0.5); /* gray-700 */
            border-left-color: rgba(255, 255, 255, 0.1);
        }
        html.dark .glass-chat-header {
            background: rgba(55, 65, 81, 0.7); /* gray-700 */
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }
        html.dark .glass-chat-footer {
            background: rgba(55, 65, 81, 0.7); /* gray-700 */
            border-top-color: rgba(255, 255, 255, 0.1);
        }
        html.dark .form-input, html.dark .btn-secondary {
            background-color: #374151; /* gray-700 */
            border-color: #4b5563; /* gray-600 */
            color: #f3f4f6; /* gray-100 */
        }
        html.dark .text-gray-800 { color: #f3f4f6; } /* gray-100 */
        html.dark .text-gray-600 { color: #d1d5db; } /* gray-300 */
        html.dark .text-gray-500 { color: #9ca3af; } /* gray-400 */
        html.dark .text-gray-400 { color: #6b7280; } /* gray-500 */
        html.dark .conv-card:hover {
            background-color: rgba(75, 85, 99, 0.7); /* gray-600 */
        }
        html.dark .conv-card.active {
            background-color: #3b82f6; /* blue-500 */
        }
        html.dark .chat-bubble-in {
            background-color: #374151; /* gray-700 */
        }
        html.dark .chat-bubble-out {
            background-color: #2563eb; /* blue-600 */
        }
        html.dark .btn-quick-reply:hover {
            background-color: #4b5563; /* gray-600 */
        }
        
        /* --- Sidebar --- */
        .glass-sidebar {
            background: rgba(255, 255, 255, 0.5);
            border-left: 1px solid rgba(229, 231, 235, 0.7);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* --- Chat Area --- */
        .glass-chat-header {
            background: rgba(255, 255, 255, 0.7);
            border-bottom: 1px solid rgba(229, 231, 235, 0.7);
        }
        .glass-chat-footer {
            background: rgba(255, 255, 255, 0.7);
            border-top: 1px solid rgba(229, 231, 235, 0.7);
        }
        
        /* --- Loader --- */
        .loader-container {
            position: absolute;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(2px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        html.dark .loader-container {
            background-color: rgba(30, 41, 59, 0.8);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
        
        /* --- Conversation Card --- */
        .conv-card {
            border-bottom: 1px solid rgba(229, 231, 235, 0.7);
            transition: background-color 0.2s;
        }
        html.dark .conv-card {
            border-bottom-color: rgba(75, 85, 99, 0.7);
        }
        .conv-card:hover {
            background-color: rgba(243, 244, 246, 0.7); /* gray-100 */
        }
        .conv-card.active {
            background-color: #dbeafe; /* blue-100 */
            border-right: 4px solid #3b82f6;
        }
        html.dark .conv-card.active {
            background-color: #3b82f6; /* blue-500 */
            border-right-color: #93c5fd; /* blue-300 */
        }
        
        /* --- Chat Bubbles --- */
        .chat-bubble-in {
            background-color: #ffffff;
            border-radius: 20px 20px 20px 5px;
        }
        .chat-bubble-out {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-radius: 20px 20px 5px 20px;
        }
        
        /* --- Form Inputs --- */
        .form-input {
            background-color: #ffffff;
            border: 1px solid rgba(229, 231, 235, 0.7);
            transition: all 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        
        /* --- Buttons --- */
        .btn {
            transition: all 0.2s;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* blue-600 */
        }
        .btn-secondary {
            background-color: #ffffff;
            border: 1px solid rgba(229, 231, 235, 0.7);
            color: #374151; /* gray-700 */
        }
        .btn-secondary:hover {
            background-color: #f9fafb; /* gray-50 */
        }
        .btn-danger {
            background-color: #ef4444; /* red-500 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
        }
        .btn-quick-reply {
            background-color: #e5e7eb; /* gray-200 */
            color: #1f2937; /* gray-800 */
            border: 1px solid rgba(209, 213, 219, 0.7);
        }
        .btn-quick-reply:hover {
            background-color: #d1d5db; /* gray-300 */
        }
        
        /* --- Tab Buttons --- */
        .tab-button {
            color: #6b7280; /* gray-500 */
            border-bottom: 3px solid transparent;
        }
        html.dark .tab-button {
            color: #9ca3af; /* gray-400 */
        }
        .tab-button.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        html.dark .tab-button.active {
            color: #60a5fa; /* blue-400 */
            border-bottom-color: #60a5fa;
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(156, 163, 175, 0.5); /* gray-400 */
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(107, 114, 128, 0.7); /* gray-500 */
        }
        html.dark ::-webkit-scrollbar-thumb {
            background: rgba(107, 114, 128, 0.5); /* gray-500 */
        }
        html.dark ::-webkit-scrollbar-thumb:hover {
            background: rgba(156, 163, 175, 0.7); /* gray-400 */
        }
        
        /* --- Responsive --- */
        @media (max-width: 1024px) {
            body {
                overflow: auto;
            }
            .glass-wrapper {
                margin: 0;
                height: 100vh;
                width: 100vw;
                border-radius: 0;
                grid-template-columns: 1fr;
            }
            .glass-sidebar {
                border-left: none;
                height: 40vh;
            }
            .chat-area {
                height: 60vh;
            }
        }
    </style>
</head>
<body class="antialiased text-gray-800">
    
    <!-- App Wrapper -->
    <div class="glass-wrapper">
        
        <!-- Sidebar (רשימת שיחות) -->
        <div class="glass-sidebar">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-300 dark:border-gray-600">
                <div class="flex items-center">
                    <i data-feather="message-square" class="text-brand-blue w-7 h-7"></i>
                    <h1 class="text-2xl font-bold mr-3 text-gray-800">מרכז הודעות</h1>
                </div>
                <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-500 dark:text-gray-400">
                    <i data-feather="moon" id="theme-icon-moon" class="hidden"></i>
                    <i data-feather="sun" id="theme-icon-sun" class="hidden"></i>
                </button>
            </div>
            
            <!-- Search -->
            <div class="mb-4">
                <input type="text" id="search-conversations" placeholder="חיפוש שיחות..." class="w-full px-4 py-2 rounded-lg form-input">
            </div>
            
            <!-- Tabs -->
            <div class="flex mb-2 border-b border-gray-300 dark:border-gray-600">
                <button class="tab-button flex-1 py-2 font-semibold active" onclick="setConversationFilter('all')">
                    כל השיחות
                </button>
                <button class="tab-button flex-1 py-2 font-semibold" onclick="setConversationFilter('new')">
                    חדשות
                </button>
                <button class="tab-button flex-1 py-2 font-semibold" onclick="setConversationFilter('mine')">
                    בטיפולי
                </button>
            </div>
            
            <!-- Conversation List -->
            <div id="conv-list-container" class="flex-1 overflow-y-auto relative">
                <!-- Loader -->
                <div id="conv-loader" class="loader-container">
                    <div class="loader"></div>
                </div>
                <!-- List -->
                <div id="conv-list">
                    <!-- שיחות יוכנסו לכאן ע"י JS -->
                </div>
            </div>
        </div>
        
        <!-- Chat Area (אזור צ'אט) -->
        <div id="chat-area" class="flex flex-col h-full bg-transparent" style="display: none;">
            
            <!-- Header -->
            <div class="glass-chat-header p-4 flex justify-between items-center shadow-sm">
                <div>
                    <h2 id="chat-customer-name" class="text-xl font-bold text-gray-800">בחר שיחה</h2>
                    <p id="chat-customer-details" class="text-sm text-gray-500">...
                        <span id="chat-typing-indicator" class="hidden text-brand-blue font-semibold">מקליד ✍️...</span>
                    </p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="takeover-btn" onclick="escalateToHuman()" class="btn btn-secondary text-sm py-1 px-3 hidden">
                        <i data-feather="zap" class="w-4 h-4"></i>
                        <span>השתלט על השיחה</span>
                    </button>
                    <a id="customer-link" href="#" target="_blank" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-500" title="פתח כרטיס לקוח">
                        <i data-feather="user" class="w-5 h-5"></i>
                    </a>
                </div>
            </div>
            
            <!-- Messages -->
            <div id="messages-container" class="flex-1 p-6 overflow-y-auto space-y-4">
                <!-- הודעות יוכנסו לכאן ע"י JS -->
            </div>
            
            <!-- Quick Replies -->
            <div id="quick-replies" classs="p-2 flex flex-wrap gap-2 border-t border-gray-200 dark:border-gray-700">
                 <!-- הצעות יוכנסו לכאן ע"י JS -->
            </div>
            
            <!-- Footer (שליחת הודעה) -->
            <div class="glass-chat-footer p-4">
                <div class="flex items-center gap-3">
                    <input type="text" id="reply-message-text" class="form-input flex-1 px-4 py-3 rounded-lg" placeholder="הקלד הודעה..." onkeydown="handleKeydown(event)">
                    <button onclick="sendAdminReply()" class="btn btn-primary p-3 rounded-lg">
                        <i data-feather="send" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Placeholder (כאשר לא נבחרה שיחה) -->
        <div id="chat-placeholder" class="flex items-center justify-center h-full text-gray-500 dark:text-gray-400">
            <div class="text-center">
                <i data-feather="message-square" class="w-24 h-24 mx-auto"></i>
                <h2 class="text-2xl font-medium mt-4">בחר שיחה מהרשימה כדי להתחיל</h2>
                <p class="text-lg">כל ההודעות מלקוחות יופיעו כאן בזמן אמת.</p>
            </div>
        </div>

    </div>
    
    <!-- 
      ==========================================================
      ===               תחילת סקריפט ראשי (v5.3)              ===
      ==========================================================
    -->
    <script type="module">
        // [FIX v5.0] שימוש בנתיבי CDN רשמיים
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, 
            collection, query, where, Timestamp, runTransaction, getDocs, orderBy, 
            serverTimestamp, limit, writeBatch, arrayUnion
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- Global Variables ---
        let db, auth;
        let currentUserId = null;
        let conversations = []; // כל השיחות
        let currentConversationId = null;
        let messagesUnsubscribe = null; // מאזין להודעות בשיחה הפתוחה
        let conversationUnsubscribe = null; // מאזין לשיחות ברשימה
        let currentConversationFilter = 'all'; // 'all', 'new', 'mine'
        
        // [FIX v5.1] דגל למניעת טעינה כפולה
        let appInitialized = false; 

        // --- Firebase Config (Placeholder) ---
        const fallbackConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949",
          storageBucket: "saban94-78949.firebasestorage.app", 
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a", 
          measurementId: "G-XV6RZDESSB"
        };
        
        // --- Initialization ---
        function initApp() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(fallbackConfig));
                
                const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');
                console.log("Firebase Initialized.");

                // --- Authentication ---
                // [FIX v5.2] 1. חבר את המאזין קודם. הוא "יתפוס" את אירוע ההתחברות.
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log(`Admin User Signed In: ${currentUserId}`);
                        
                        // הפעלת האזנה רק פעם אחת
                        if (!appInitialized) {
                            appInitialized = true;
                            listenForConversations();
                        }

                    } else {
                        // משתמש מחובר, או שההתחברות האנונימית נכשלה
                        console.log("User is signed out.");
                        appInitialized = false; 
                    }
                });
                
                // [FIX v5.2] 2. הפעל את תהליך ההתחברות. זה יגרום למאזין למעלה לפעול.
                triggerAuth();

            } catch (e) {
                console.error("Firebase Initialization Failed:", e);
                document.getElementById('conv-loader').innerHTML = '<p class="text-red-500">שגיאת התחברות חמורה</p>';
            }
        }
        
        // [NEW v5.2] פונקציה ייעודית להפעלת התחברות
        async function triggerAuth() {
            // אם המשתמש כבר מחובר (נדיר בטעינה ראשונית, אבל אפשרי), המאזין יתפוס אותו
            if (auth.currentUser) {
                 console.log("User already signed in. Listener will handle it.");
                 return;
            }
            
            console.log("No current user. Trying auth...");
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }
        }
        
        // --- Data Listeners ---
        
        // 1. האזנה לרשימת השיחות
        function listenForConversations() {
            if (conversationUnsubscribe) conversationUnsubscribe();
            
            const loader = document.getElementById('conv-loader');
            loader.classList.remove('hidden');
            console.log("Attempting to listen for conversations..."); // [FIX v5.3] הוספת לוג
            
            // [FIX v5.3] הסרת limit() כדי לאלץ שגיאת אינדקס ברורה
            const q = query(
                collection(db, "conversations"), 
                orderBy("lastMessageTimestamp", "desc")
            );
            
            conversationUnsubscribe = onSnapshot(q, (snapshot) => {
                conversations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderConversationList();
                loader.classList.add('hidden');
                
                if (currentConversationId) {
                    const updatedConv = conversations.find(c => c.id === currentConversationId);
                    if (updatedConv) {
                        updateChatHeader(updatedConv);
                    }
                }
                
            }, (error) => {
                // [FIX v5.3] הוספת לוגים ברורים יותר לשגיאה
                console.error("CRITICAL: Failed to listen for conversations:", error.message);
                console.error("THIS IS LIKELY A MISSING INDEX. Click the link in the error message to create it.");
                loader.innerHTML = `<p class="p-4 text-red-500"><b>שגיאה קריטית בטעינת שיחות.</b><br>ייתכן שחסר אינדקס ב-Firestore.<br><br><b>הודעת שגיאה:</b> ${error.message}</p>`;
            });
        }
        
        // 2. האזנה להודעות בשיחה ספציפית
        function openConversation(convId) {
            if (messagesUnsubscribe) messagesUnsubscribe(); // הפסק האזנה קודמת
            
            currentConversationId = convId;
            
            document.getElementById('chat-placeholder').style.display = 'none';
            document.getElementById('chat-area').style.display = 'flex';
            document.getElementById('messages-container').innerHTML = '<div class="loader-container"><div class="loader"></div></div>';
            
            const conv = conversations.find(c => c.id === convId);
            if (!conv) {
                console.error("Conversation not found!");
                return;
            }
            
            updateChatHeader(conv);
            renderConversationList(); // רענון הרשימה לסימון 'active'
            
            // האזנה להודעות חדשות
            const messagesQuery = query(
                collection(db, "conversations", convId, "messages"),
                orderBy("timestamp", "asc")
            );
            
            messagesUnsubscribe = onSnapshot(messagesQuery, (snapshot) => {
                const messagesContainer = document.getElementById('messages-container');
                messagesContainer.innerHTML = ''; // נקה הודעות קודמות
                
                snapshot.forEach(doc => {
                    renderMessage(doc.data());
                });
                
                // גלול לתחתית
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // [FIX v5.0] סמן הודעות כנקראו (אם הן מהלקוח)
                markMessagesAsRead(convId, snapshot.docs);
                
            }, (error) => {
                console.error("Failed to listen for messages:", error);
                messagesContainer.innerHTML = '<p class="text-red-500">שגיאה בטעינת הודעות.</p>';
            });
            
            // טעינת הצעות מהבוט
            loadBotSuggestions(conv);
        }
        window.openConversation = openConversation; // חשיפה ל-HTML

        // --- Rendering Functions ---

        // 1. רנדור רשימת השיחות
        function renderConversationList() {
            const listEl = document.getElementById('conv-list');
            if (!listEl) return;
            
            let filteredConvs = conversations;
            
            // [NEW v4.3] סינון לפי טאבים
            if (currentConversationFilter === 'new') {
                filteredConvs = conversations.filter(c => c.isUnread && c.assignedTo === 'bot');
            } else if (currentConversationFilter === 'mine') {
                filteredConvs = conversations.filter(c => c.assignedTo === currentUserId);
            }
            
            // סינון לפי חיפוש
            const searchTerm = document.getElementById('search-conversations').value.toLowerCase();
            if (searchTerm) {
                filteredConvs = filteredConvs.filter(c => 
                    (c.customer?.name && c.customer.name.toLowerCase().includes(searchTerm)) ||
                    (c.customer?.phone && c.customer.phone.includes(searchTerm))
                );
            }

            if (filteredConvs.length === 0) {
                listEl.innerHTML = '<p class="p-4 text-center text-gray-500">לא נמצאו שיחות.</p>';
                return;
            }
            
            listEl.innerHTML = filteredConvs.map(conv => {
                const isActive = conv.id === currentConversationId;
                const isUnread = conv.isUnread;
                const time = conv.lastMessageTimestamp?.toDate ? formatTime(conv.lastMessageTimestamp.toDate()) : '';
                
                // [NEW v5.0] חיווי שיוך (בוט/מנהל)
                let assignedText = "משויך לבוט";
                let assignedClass = "text-gray-400";
                if (conv.assignedTo !== 'bot') {
                    assignedText = "בטיפולך";
                    assignedClass = "text-brand-blue font-semibold";
                }
                
                return `
                    <div class="conv-card p-4 cursor-pointer ${isActive ? 'active' : ''}" onclick="openConversation('${conv.id}')">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-lg truncate ${isUnread ? 'text-brand-blue' : 'text-gray-800'}">${conv.customer?.name || 'לקוח לא ידוע'}</h3>
                            <span class="text-xs text-gray-500 flex-shrink-0 ml-2">${time}</span>
                        </div>
                        <p class="text-sm text-gray-600 truncate">${conv.lastMessageSnippet || '...'}</p>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs ${assignedClass}">${assignedText}</span>
                            ${isUnread ? '<span class="w-3 h-3 bg-brand-blue rounded-full"></span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 2. רנדור הודעה בודדת
        function renderMessage(msg) {
            if (!msg.timestamp) return;
            
            const messagesContainer = document.getElementById('messages-container');
            const time = msg.timestamp.toDate().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
            
            // [NEW v5.0] הוספת "וי קריאה"
            const readReceipt = msg.isRead ? '✔️✔️' : '✔️';
            
            if (msg.sender === 'customer') {
                messagesContainer.innerHTML += `
                    <div class="flex justify-start">
                        <div class="chat-bubble-in p-3 max-w-lg shadow">
                            <p>${msg.text}</p>
                            <span class="text-xs text-gray-400 mt-1 block text-left">${time} ${readReceipt}</span>
                        </div>
                    </div>
                `;
            } else { // 'admin' or 'bot'
                messagesContainer.innerHTML += `
                    <div class="flex justify-end">
                        <div class="chat-bubble-out p-3 max-w-lg shadow">
                            <p>${msg.text}</p>
                            <span class="text-xs text-blue-100 opacity-70 mt-1 block text-left">${time} ${readReceipt}</span>
                        </div>
                    </div>
                `;
            }
        }
        
        // 3. עדכון כותרת הצ'אט
        function updateChatHeader(conv) {
            document.getElementById('chat-customer-name').innerText = conv.customer?.name || 'לקוח';
            document.getElementById('chat-customer-details').innerText = `משויך ל: ${conv.assignedTo === 'bot' ? 'בוט' : 'בטיפולך'} | ${conv.customer?.phone || ''}`;
            
            // [NEW v5.0] חיווי הקלדה
            const typingIndicator = document.getElementById('chat-typing-indicator');
            if (conv.customerIsTyping) {
                typingIndicator.classList.remove('hidden');
            } else {
                typingIndicator.classList.add('hidden');
            }
            
            // [NEW v5.0] כפתור השתלטות
            const takeoverBtn = document.getElementById('takeover-btn');
            if (conv.assignedTo === 'bot') {
                takeoverBtn.classList.remove('hidden');
            } else {
                takeoverBtn.classList.add('hidden');
            }
            
            // עדכון קישור לכרטיס לקוח (אם קיים)
            const customerLink = document.getElementById('customer-link');
            if (conv.customer?.order_id) {
                // הנחה שהקישור הוא לדף `customer.html`
                customerLink.href = `../customer.html?id=${conv.customer.order_id}`;
                customerLink.style.display = 'block';
            } else {
                customerLink.style.display = 'none';
            }
        }

        // --- Chat Actions ---

        // 1. שליחת הודעת מנהל
        async function sendAdminReply() {
            const text = document.getElementById('reply-message-text').value;
            if (!text.trim() || !currentConversationId) return;

            document.getElementById('reply-message-text').value = '';
            
            const convRef = doc(db, "conversations", currentConversationId);
            const messagesCol = collection(db, "conversations", currentConversationId, "messages");
            
            const messageData = {
                text: text,
                sender: 'admin',
                timestamp: serverTimestamp(),
                isRead: false
            };
            
            try {
                // 1. הוסף הודעה חדשה
                await addDoc(messagesCol, messageData);
                
                // 2. עדכן את השיחה הראשית
                await updateDoc(convRef, {
                    lastMessageSnippet: text,
                    lastMessageTimestamp: serverTimestamp(),
                    isUnread: false, // מנהל תמיד קורא כשהוא שולח
                    assignedTo: currentUserId // [FIX v5.0] שייך למנהל אוטומטית
                });
                
                console.log("Admin reply sent.");
            } catch (e) {
                console.error("Error sending reply:", e);
                showToast("שגיאה בשליחת הודעה", "error");
                document.getElementById('reply-message-text').value = text; // החזר טקסט
            }
        }
        window.sendAdminReply = sendAdminReply; // חשיפה ל-HTML

        // 2. לחיצה על Enter
        function handleKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendAdminReply();
            }
        }
        window.handleKeydown = handleKeydown; // חשיפה ל-HTML

        // 3. [NEW v5.0] השתלטות על שיחה
        async function escalateToHuman() {
            if (!currentConversationId) return;
            
            const convRef = doc(db, "conversations", currentConversationId);
            try {
                await updateDoc(convRef, {
                    assignedTo: currentUserId,
                    isUnread: false // המנהל "קרא" את השיחה ברגע שהשתלט
                });
                document.getElementById('takeover-btn').classList.add('hidden');
                // העדכון יגיע דרך onSnapshot ויעדכן את הכותרת
                console.log("Conversation escalated to human.");
            } catch (e) {
                console.error("Error escalating conversation:", e);
                showToast("שגיאה בהשתלטות על השיחה", "error");
            }
        }
        window.escalateToHuman = escalateToHuman; // חשיפה ל-HTML
        
        // 4. [NEW v5.0] סימון כנקרא
        async function markMessagesAsRead(convId, messageDocs) {
            const convRef = doc(db, "conversations", convId);
            const batch = writeBatch(db);
            let needsUpdate = false;
            
            messageDocs.forEach(doc => {
                const msg = doc.data();
                if (msg.sender === 'customer' && !msg.isRead) {
                    batch.update(doc.ref, { isRead: true });
                    needsUpdate = true;
                }
            });
            
            if (needsUpdate) {
                // עדכן גם את השיחה הראשית שהיא נקראה
                batch.update(convRef, { isUnread: false });
                await batch.commit();
                console.log("Marked messages as read.");
            }
        }
        
        // 5. [NEW v4.3] טעינת הצעות מהבוט
        function loadBotSuggestions(conversation) {
            const container = document.getElementById('quick-replies');
            container.innerHTML = '';
            
            // פונקציית דמה - בעתיד יגיע מ-Dialogflow או שירות Bot
            const suggestions = [
                "בטח, מיד בודק...",
                "מה מספר ההזמנה?",
                "אני מעביר את פנייתך למנהל.",
                "תודה רבה!"
            ];
            
            if (conversation.assignedTo === 'bot') {
                 // אל תציג הצעות אם הבוט עדיין שולט
                return;
            }

            suggestions.forEach(reply => {
                const btn = document.createElement('button');
                btn.className = 'btn-quick-reply py-1 px-3 rounded-full text-sm font-medium';
                btn.innerText = reply;
                btn.onclick = () => {
                    const textarea = document.getElementById('reply-message-text');
                    textarea.value = reply;
                    textarea.focus();
                };
                container.appendChild(btn);
            });
        }
        
        // [NEW v4.3] סינון טאבים
        function setConversationFilter(filter) {
            currentConversationFilter = filter;
            
            // Update active button
            document.querySelectorAll('.tab-button').forEach(btn => {
                if(btn) btn.classList.remove('active'); // [FIX v5.1] בדיקת בטיחות
            });
            
            const activeButton = document.querySelector(`.tab-button[onclick="setConversationFilter('${filter}')"]`);
            if (activeButton) { // [FIX v5.1] בדיקת בטיחות
                activeButton.classList.add('active');
            }
            
            renderConversationList(); // Re-render the list
        }
        window.setConversationFilter = setConversationFilter;

        // --- Utilities ---
        
        function formatTime(date) {
            const now = new Date();
            const diff = now.getTime() - date.getTime();
            const minutes = Math.floor(diff / 60000);
            
            if (minutes < 1) return 'כעת';
            if (minutes < 60) return `לפני ${minutes} דק'`;
            
            // אם זה היום, הצג שעה
            if (date.getDate() === now.getDate() && date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear()) {
                return date.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
            }
            
            // אם זה אתמול
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.getDate() === yesterday.getDate() && date.getMonth() === yesterday.getMonth() && date.getFullYear() === yesterday.getFullYear()) {
                return 'אתמול';
            }
            
            // אחרת, הצג תאריך מלא
            return date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' });
        }
        
        // [NEW v4.3] Dark Mode Toggle
        function toggleDarkMode() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                updateThemeIcons('light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                updateThemeIcons('dark');
            }
        }
        window.toggleDarkMode = toggleDarkMode;

        function updateThemeIcons(theme) {
            if (theme === 'dark') {
                document.getElementById('theme-icon-sun').classList.remove('hidden');
                document.getElementById('theme-icon-moon').classList.add('hidden');
            } else {
                document.getElementById('theme-icon-sun').classList.add('hidden');
                document.getElementById('theme-icon-moon').classList.remove('hidden');
            }
        }
        
        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            feather.replace();
            document.getElementById('search-conversations').addEventListener('keyup', renderConversationList);
            
            // [NEW v4.3] Dark mode init
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                updateThemeIcons('dark');
            } else {
                document.documentElement.classList.remove('dark');
                updateThemeIcons('light');
            }
        });
    </script>
</body>
</html>

