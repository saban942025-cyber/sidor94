<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v32.6 (דיוק מפה)</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/feather-icons"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- סגנונות CSS - ללא שינוי מהמקור -->
    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
        }

        html, body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            direction: rtl;
            background-color: var(--bg-light);
            margin: 0;
            padding: 0;
            scroll-behavior: smooth;
        }

        * { box-sizing: border-box; }

        .mock-header {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .mock-header h1 { margin: 0; font-size: 1.5rem; }
        .nav-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .nav-button:hover { background-color: #2980b9; }

        /* סגנונות גנריים למודאל ו-Toast */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* נסתר כברירת מחדל */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-content {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            width: 500px;
            overflow: hidden;
        }

        /* סגנונות מיוחדים ללוח המכולות */
        .eco-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .eco-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .overdue-card {
            border: 2px solid #e74c3c; /* Red border for overdue */
            background-color: #fce7e7;
        }
        .overdue-text {
            color: #e74c3c; /* Red text for overdue days */
            font-weight: 600;
        }
        .normal-text {
            color: #2ecc71; /* Green text for normal days */
            font-weight: 600;
        }

        /* סגנון ל-Toast Notification */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column-reverse; /* כדי שהחדש יופיע למטה */
            gap: 10px;
        }
        .toast {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { background-color: #2ecc71; }
        .toast.error { background-color: #e74c3c; }
        .toast.info { background-color: #3498db; }
        
        /* Map Styles */
        #map {
            height: 60vh;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        .leaflet-popup-content p {
            margin: 0.25rem 0;
        }
        .leaflet-marker-icon {
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.5));
        }

    </style>
</head>
<body>

    <!-- טעינת Firebase -->
    <script type="module">
        // עדכון: שינוי לגרסה 9.15.0 והוספת פונקציות Timestamp, getApps, getApp
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, 
            collection, query, where, Timestamp, runTransaction, getDocs, orderBy, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        // --- Mandatory Firebase Config & Auth (using globals) ---
        // עדכון: שימוש במפתחות שסופקו כברירת מחדל (Fallback)
        const fallbackConfig = {
            apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
            authDomain: "saban94-76543.firebaseapp.com", 
            projectId: "saban94-76543",
            storageBucket: "saban94-76543.appspot.com", 
            messagingSenderId: "41553157903", 
            appId: "1:41553157903:web:cc33d252cff023be97a87a", 
            measurementId: "G-XV6RZDESSB"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : fallbackConfig;

        // --- משתנים גלובליים ---
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.firebaseAuthReady = false; // דגל לאימות סטטוס טעינת Firebase

        // הגדרת רמת לוגים ל-Firestore (אחרי שה-SDK נטען)
        setLogLevel('debug');

        // פונקציית עזר גלובלית לחישוב סטטוס איחור של מכולה (חדש)
        function calculateOverdueStatus(rentalStartDate, returnDate = null, maxDaysAllowed = 7) {
            if (!rentalStartDate) {
                return { isOverdue: false, daysOverdue: 0, daysLeft: maxDaysAllowed, daysElapsed: 0, returned: false };
            }

            let startDateMs;
            // טיפול ב-Firebase Timestamp או Date
            if (rentalStartDate.toDate) {
                startDateMs = rentalStartDate.toDate().getTime();
            } else if (rentalStartDate instanceof Date) {
                startDateMs = rentalStartDate.getTime();
            } else if (typeof rentalStartDate === 'number') {
                startDateMs = rentalStartDate;
            } else {
                return { isOverdue: false, daysOverdue: 0, daysLeft: maxDaysAllowed, daysElapsed: 0, returned: false };
            }

            // אם המכולה הוחזרה
            if (returnDate) {
                return { isOverdue: false, daysOverdue: 0, daysLeft: 0, daysElapsed: 0, returned: true };
            }

            // חישוב ימים שלמים שעברו (מעוגל כלפי מעלה כדי לכלול יום התחלה)
            const todayMs = new Date().setHours(0, 0, 0, 0); // יום נוכחי בחצות
            const startDayMs = new Date(startDateMs).setHours(0, 0, 0, 0); // תאריך התחלה בחצות
            
            // ימים שחלפו (כולל יום ההתחלה)
            const timeElapsedMs = todayMs - startDayMs;
            const daysElapsed = Math.floor(timeElapsedMs / (1000 * 60 * 60 * 24)) + 1; 

            // חישוב סטטוס
            const daysLeft = maxDaysAllowed - daysElapsed;
            const isOverdue = daysElapsed > maxDaysAllowed;
            const daysOverdue = isOverdue ? daysElapsed - maxDaysAllowed : 0;

            return {
                isOverdue: isOverdue,
                daysOverdue: daysOverdue,
                daysLeft: Math.max(0, daysLeft),
                daysElapsed: daysElapsed,
                returned: false
            };
        }
        window.calculateOverdueStatus = calculateOverdueStatus; // חשיפה גלובלית

        // פונקציית אתחול
        async function initializeFirebase() {
             
            let app;
            // מונע אתחול מרובה של האפליקציה ב-Hot Reloading
            if (getApps().length) {
                app = getApp();
            } else {
                app = initializeApp(firebaseConfig);
            }

            window.db = getFirestore(app);
            window.auth = getAuth(app);
            
            // חשיפת שירותי Firebase גלובלית
            window.firebaseServices = { 
                db: window.db, 
                auth: window.auth, 
                collection, onSnapshot, query, where, orderBy, 
                addDoc, Timestamp, doc, updateDoc, deleteDoc, serverTimestamp, runTransaction, getDocs 
            };
            
            // טעינת מידע על המשתמש
            onAuthStateChanged(window.auth, async (user) => {
                if (!user) {
                    // כניסה באמצעות Custom Token או אנונימית
                    try {
                        if (window.initialAuthToken) {
                            await signInWithCustomToken(window.auth, window.initialAuthToken);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    } catch (error) {
                        console.error("Firebase Sign In Failed (Fallback to Anonymous):", error);
                    }
                }
                
                // סיום תהליך האותנטיקציה, מוכן להתחיל את האפליקציה
                const currentUser = window.auth.currentUser;
                if (currentUser) {
                    window.userId = currentUser.uid;
                    window.firebaseAuthReady = true;
                    document.dispatchEvent(new CustomEvent('firebaseAuthReady'));
                    console.log(`Firebase Ready. User ID: ${window.userId}`);
                    // עדכון גלובלי של ה-userId לתצוגה
                    const userIdElement = document.getElementById('current-user-id');
                    if (userIdElement) {
                        userIdElement.textContent = window.userId;
                    }
                }
            });
        }

        initializeFirebase();

        // פונקציות גלובליות נחשפו דרך window.firebaseServices
        // (יש לוודא שימוש בהן בחלק הסקריפט התחתון במקום קריאה ישירה לפונקציות ישנות)
        
    </script>


    <!-- רכיבי UI מרכזיים (כותרת וניווט) -->
    <div class="mock-header">
        <h1>🚚 DeliveryMaster</h1>
        <div class="flex items-center space-x-4 space-x-reverse">
            <button id="openEcoDashboardButton" class="nav-button">
                לוח מכולות (ECO)
            </button>
            <button id="openMapDashboardButton" class="nav-button">
                מפה וכלים
            </button>
        </div>
    </div>
    <div class="p-4 bg-gray-200 text-sm text-gray-700">
        <span class="font-bold">משתמש:</span> <span id="current-user-id" class="ltr inline-block bg-white px-2 py-0.5 rounded shadow-sm text-xs">...טוען...</span>
    </div>

    <!-- Container Dashboard (לוח מחוונים מכולות) -->
    <div id="container-dashboard" class="p-6 hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">לוח מכולות (8 קוב)</h2>
            <button id="openContainerCreateModalButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center">
                <i data-feather="plus-circle" class="w-5 h-5 ml-2"></i>
                הוסף הזמנת מכולה
            </button>
        </div>
        
        <!-- כלי סינון וחיפוש -->
        <div class="mb-6 flex space-x-4 space-x-reverse">
            <input type="text" id="container-search-input" placeholder="חפש לפי שם לקוח או כתובת..." 
                   class="flex-grow p-3 border border-gray-300 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150">
            
            <select id="container-status-filter" class="p-3 border border-gray-300 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150 w-48">
                <option value="all">כל הסטטוסים</option>
                <option value="active">פעיל</option>
                <option value="overdue">באיחור</option>
                <option value="pending">טרם החל (ממתין)</option>
            </select>
        </div>

        <!-- רשת המכולות -->
        <div id="containers-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- כרטיסי מכולות יטענו כאן -->
            <p id="loading-message" class="col-span-full text-center text-gray-500">טוען נתוני מכולות...</p>
        </div>
    </div>

    <!-- Map Dashboard (מפה) -->
    <div id="map-dashboard" class="p-6 hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">מפה וניהול שוטף</h2>
        <div id="map"></div>
        
        <div class="mt-6 p-4 bg-white rounded-xl shadow-lg">
            <h3 class="text-xl font-semibold mb-3 border-b pb-2">פעולות מיקום</h3>
            <div class="flex space-x-4 space-x-reverse">
                <button id="show-pending-route" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center" disabled>
                    <i data-feather="navigation" class="w-5 h-5 ml-2"></i>
                    הצג מסלול מומלץ (ממתינים)
                </button>
                <button id="show-active-route" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center" disabled>
                    <i data-feather="map" class="w-5 h-5 ml-2"></i>
                    הצג מסלול מומלץ (פעילים)
                </button>
            </div>
            <p id="map-status" class="mt-3 text-sm text-gray-500">המפה טעונה, ממתין לנתוני מכולות...</p>
        </div>
    </div>
    
    <!-- Modal: יצירת הזמנת מכולה חדשה -->
    <div id="container-create-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="p-6">
                <h3 class="text-xl font-bold mb-4 border-b pb-2">הזמנת מכולה חדשה</h3>
                
                <form id="container-create-form" class="space-y-4">
                    <!-- שם לקוח -->
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-700">שם לקוח</label>
                        <input type="text" id="customer-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <!-- סוג מכולה -->
                    <div>
                        <label for="container-size" class="block text-sm font-medium text-gray-700">סוג מכולה</label>
                        <select id="container-size" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="8 קוב">8 קוב (עד 10 ימים)</option>
                        </select>
                    </div>
                    <!-- כתובת -->
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700">כתובת להצבה</label>
                        <input type="text" id="address" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- קואורדינטות (חדש) -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="latitude" class="block text-sm font-medium text-gray-700">Latitude (קו רוחב)</label>
                            <input type="number" step="any" id="latitude" placeholder="32.1867..." required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 ltr text-right">
                        </div>
                        <div>
                            <label for="longitude" class="block text-sm font-medium text-gray-700">Longitude (קו אורך)</label>
                            <input type="number" step="any" id="longitude" placeholder="34.9526..." required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 ltr text-right">
                        </div>
                    </div>
                    
                    <!-- כפתור Geocode (משתמש בשדות הקואורדינטות) -->
                    <button type="button" id="geocode-button" class="w-full bg-purple-500 hover:bg-purple-600 text-white text-sm py-2 px-3 rounded-md transition duration-150">
                        אתר/אמת מיקום מכתובת (או השתמש בנתונים שהוזנו)
                    </button>
                    <!-- סוג פעולה -->
                    <div>
                        <label for="delivery-type" class="block text-sm font-medium text-gray-700">סוג פעולה</label>
                        <select id="delivery-type" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="Delivery">הצבה</option>
                            <option value="Replace">החלפה</option>
                            <option value="Removal">הוצאה</option>
                        </select>
                    </div>
                    <!-- תאריך/שעת הזמנה מתוכנן -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="order-date" class="block text-sm font-medium text-gray-700">תאריך מתוכנן</label>
                            <input type="date" id="order-date" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="order-time" class="block text-sm font-medium text-gray-700">שעת מתוכנן</label>
                            <input type="time" id="order-time" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <!-- הערות -->
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700">הערות</label>
                        <textarea id="notes" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>

                    <!-- כפתורי שליחה וביטול -->
                    <div class="flex justify-end space-x-3 space-x-reverse pt-4">
                        <button type="button" id="close-create-modal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-150">
                            ביטול
                        </button>
                        <button type="submit" id="save-new-container-order" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                            שמור הזמנה
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: עריכת הזמנת מכולה קיימת -->
    <div id="container-edit-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="p-6">
                <h3 class="text-xl font-bold mb-4 border-b pb-2">עריכת הזמנת מכולה <span id="container-edit-id" class="text-sm text-gray-500"></span></h3>
                
                <form id="container-edit-form" class="space-y-4">
                    <!-- שדה לקריאה בלבד: שם לקוח -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">שם לקוח</label>
                        <p id="container-edit-customer-name" class="mt-1 block w-full p-2 bg-gray-100 border border-gray-300 rounded-md"></p>
                    </div>
                    
                    <!-- שדה לקריאה בלבד: סוג מכולה וכתובת -->
                    <div class="grid grid-cols-2 gap-4">
                         <div>
                            <label class="block text-sm font-medium text-gray-700">סוג מכולה</label>
                            <p id="container-edit-container-size" class="mt-1 block w-full p-2 bg-gray-100 border border-gray-300 rounded-md"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">כתובת</label>
                            <p id="container-edit-address" class="mt-1 block w-full p-2 bg-gray-100 border border-gray-300 rounded-md"></p>
                        </div>
                    </div>
                    
                    <!-- קואורדינטות (קריאה בלבד בעריכה, המיקום נשמר מהיצירה) -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Latitude (קו רוחב)</label>
                            <p id="container-edit-latitude" class="mt-1 block w-full p-2 bg-gray-100 border border-gray-300 rounded-md ltr text-right"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Longitude (קו אורך)</label>
                            <p id="container-edit-longitude" class="mt-1 block w-full p-2 bg-gray-100 border border-gray-300 rounded-md ltr text-right"></p>
                        </div>
                    </div>

                    <!-- סוג פעולה (ניתן לעריכה) -->
                    <div>
                        <label for="container-edit-delivery-type" class="block text-sm font-medium text-gray-700">סוג פעולה</label>
                        <select id="container-edit-delivery-type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="Delivery">הצבה</option>
                            <option value="Replace">החלפה</option>
                            <option value="Removal">הוצאה</option>
                        </select>
                    </div>

                    <!-- תאריך/שעת הזמנה מתוכנן (ניתן לעריכה) -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="container-edit-order-date" class="block text-sm font-medium text-gray-700">תאריך מתוכנן</label>
                            <input type="date" id="container-edit-order-date" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="container-edit-order-time" class="block text-sm font-medium text-gray-700">שעת מתוכנן</label>
                            <input type="time" id="container-edit-order-time" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <!-- תאריך תחילת שכירות (הגדרת "פעיל") - ניתן לעריכה -->
                    <div>
                        <label for="container-edit-rental-start-date" class="block text-sm font-medium text-gray-700">תאריך תחילת שכירות (הגדר כ'פעיל')</label>
                        <input type="datetime-local" id="container-edit-rental-start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">מחק את התאריך כדי להחזיר לסטטוס 'ממתין'.</p>
                    </div>

                    <!-- הערות (ניתן לעריכה) -->
                    <div>
                        <label for="container-edit-notes" class="block text-sm font-medium text-gray-700">הערות</label>
                        <textarea id="container-edit-notes" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    
                    <!-- כפתורי שליחה ומחיקה -->
                    <div class="flex justify-between items-center pt-4">
                        <button type="button" id="delete-container-order" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                            מחק הזמנה
                        </button>
                        <div class="flex space-x-3 space-x-reverse">
                             <button type="button" id="close-edit-modal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-150">
                                ביטול
                            </button>
                            <button type="submit" id="save-edited-container-order" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                                שמור שינויים
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal: אישור מחיקה -->
    <div id="delete-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="p-6 text-center">
                <i data-feather="alert-triangle" class="w-12 h-12 text-red-500 mx-auto mb-4"></i>
                <h3 class="text-xl font-bold mb-2">אשר מחיקת הזמנה</h3>
                <p id="delete-confirm-message" class="text-gray-700 mb-6">האם אתה בטוח שברצונך למחוק את ההזמנה עבור הלקוח **? לא ניתן לבטל פעולה זו.</p>
                <div class="flex justify-center space-x-4 space-x-reverse">
                    <button id="cancel-delete-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-150">
                        ביטול
                    </button>
                    <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                        מחק לצמיתות
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <!-- סקריפט ראשי -->
    <script>
        // --- Smart Logging Functionality ---
        const SmartLog = {
            info: (message, context, details = {}) => console.log(`[INFO] [${context}] ${message}`, details),
            error: (error, context, details = {}) => console.error(`[ERROR] [${context}] ${error.message || error}`, details, error)
        };
        
        // --- Toast Notification ---
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type} shadow-lg`;
            toast.textContent = message;
            
            // הוספת הטקסט לקונטיינר (הופך אותו לגלוי מעט)
            container.appendChild(toast);
            
            // הפעלה: הופך לגלוי ומזיז למקום (מאפשר אנימציה)
            setTimeout(() => toast.classList.add('show'), 10);

            // הסרה אוטומטית
            setTimeout(() => {
                toast.classList.remove('show');
                // הסרה מה-DOM לאחר סיום האנימציה
                setTimeout(() => container.removeChild(toast), 300);
            }, duration);
        }
        window.showToast = showToast; // חשיפה גלובלית
        
        // --- Modal Control Functions ---
        const getModal = (id) => document.getElementById(id);
        const openModal = (id) => getModal(id)?.style.setProperty('display', 'flex');
        const closeModal = (id) => getModal(id)?.style.setProperty('display', 'none');

        // פונקציות ספציפיות
        const openContainerCreateModal = () => openModal('container-create-modal');
        const closeContainerCreateModal = () => closeModal('container-create-modal');
        const openContainerEditModal = () => openModal('container-edit-modal');
        const closeContainerEditModal = () => closeModal('container-edit-modal');
        const openDeleteConfirmModal = () => openModal('delete-confirm-modal');
        const closeDeleteConfirmModal = () => closeModal('delete-confirm-modal');


        // --- Firestore Utilities ---
        /**
         * Generates the collection path for a user's private data.
         * @param {string} collectionName - The name of the collection (e.g., 'container-orders').
         * @returns {string} The full Firestore path.
         */
        function getPrivateCollectionPath(collectionName) {
            if (!window.userId || !window.appId) {
                SmartLog.error("User ID or App ID missing", "Firestore.Path");
                return null;
            }
            // /artifacts/{appId}/users/{userId}/{your_collection_name}
            return `artifacts/${window.appId}/users/${window.userId}/${collectionName}`;
        }

        /**
         * Geocoding (Mock) - Now prioritizes manually entered coordinates.
         * If the address matches a mock city, it returns that city's coordinates.
         * Otherwise, it uses the coordinates already in the Lat/Lng inputs as the source of truth (if valid).
         */
        async function geocodeAddress(address, currentLat, currentLng) {
             SmartLog.info(`Searching/Verifying coordinates for: ${address}`, "Geocoding.Mock");
             
             // קואורדינטות ברירת מחדל לא נמצאו (כפר סבא - לפי בקשת המשתמש)
             const FALLBACK_LAT = 32.186705; 
             const FALLBACK_LNG = 34.952626;

             // Mock Geocoding for Israeli cities 
             const mockLocations = {
                "תל אביב": { lat: 32.0853, lng: 34.7818 },
                "ירושלים": { lat: 31.7683, lng: 35.2137 },
                "חיפה": { lat: 32.7940, lng: 34.9896 },
                "באר שבע": { lat: 31.2518, lng: 34.7913 },
                "רמת גן": { lat: 32.0833, lng: 34.8000 },
                "אשדוד": { lat: 31.7900, lng: 34.6530 },
                "נתניה": { lat: 32.3228, lng: 34.8530 },
                "כפר סבא": { lat: FALLBACK_LAT, lng: FALLBACK_LNG }, // הוספת כפר סבא לדיוק
             };
             
             const city = Object.keys(mockLocations).find(c => address.includes(c));

             return new Promise(resolve => {
                 setTimeout(() => {
                     let lat = currentLat;
                     let lng = currentLng;
                     let source = 'User Input';

                     if (city) {
                         // נמצאה עיר בנתוני המוק - שימוש בקואורדינטות המדויקות יותר
                         lat = mockLocations[city].lat;
                         lng = mockLocations[city].lng;
                         source = `Mock: ${city}`;
                         showToast(`מיקום נמצא (Mock): ${city}`, 'success', 1500);
                     } else if (isNaN(currentLat) || isNaN(currentLng)) {
                         // אם הכתובת לא נמצאה ואין קואורדינטות שהוזנו - שימוש בפולבק
                         lat = FALLBACK_LAT;
                         lng = FALLBACK_LNG;
                         source = 'Default Fallback (Kfar Saba)';
                         showToast('הכתובת לא נמצאה, נעשה שימוש במיקום ברירת מחדל (כפר סבא)', 'info', 3000);
                     } else {
                         // שימוש בקואורדינטות שהוזנו ידנית ע"י המשתמש (אם קיימות ותקינות)
                         showToast(`השתמש במיקום שהוזן: Lat ${lat.toFixed(4)}, Lng ${lng.toFixed(4)}`, 'success', 1500);
                     }

                     resolve({ success: true, lat: parseFloat(lat), lng: parseFloat(lng) });

                 }, 500);
             });
        }


        // --- CRUD Operations for Container Orders ---

        /**
         * Adds a new container order to Firestore.
         */
         async function handleCreateContainerOrder(event) {
             event.preventDefault();
             
             const btn = document.getElementById('save-new-container-order');
             btn.disabled = true;
             btn.innerText = 'שומר...';

             try {
                 const { db, collection, addDoc, Timestamp } = window.firebaseServices;
                 const collectionPath = getPrivateCollectionPath('container-orders');
                 if (!collectionPath) return;

                 // Read form data
                 const customerName = document.getElementById('customer-name').value.trim();
                 const containerSize = document.getElementById('container-size').value;
                 const address = document.getElementById('address').value.trim();
                 const latInput = document.getElementById('latitude').value;
                 const lngInput = document.getElementById('longitude').value;
                 const deliveryType = document.getElementById('delivery-type').value;
                 const orderDate = document.getElementById('order-date').value;
                 const orderTime = document.getElementById('order-time').value;
                 const notes = document.getElementById('notes').value.trim();
                 
                 const lat = parseFloat(latInput);
                 const lng = parseFloat(lngInput);
                 
                 if (isNaN(lat) || isNaN(lng)) {
                    throw new Error("אנא ודא שהוזנו קואורדינטות Lat/Lng תקינות לפני שמירה.");
                 }
                 
                 // Combine date and time to a Date object, then to Timestamp
                 const scheduledDateTime = new Date(`${orderDate}T${orderTime}:00`);
                 const scheduledTimestamp = Timestamp.fromDate(scheduledDateTime);

                 const newOrderData = {
                     customerName,
                     containerSize,
                     address,
                     location: { lat, lng }, // שמירת הקואורדינטות המדויקות
                     deliveryType,
                     scheduledAt: scheduledTimestamp,
                     orderDate,
                     orderTime,
                     notes,
                     rentalStartDate: null, // Initial status is pending
                     returnDate: null,
                     createdAt: Timestamp.now(),
                     createdBy: window.userId
                 };

                 await addDoc(collection(db, collectionPath), newOrderData);
                 SmartLog.info("New container order created", "CRUD.Container.Create", newOrderData);
                 showToast('הזמנת מכולה חדשה נוצרה בהצלחה!', 'success');

                 // Reset form and close modal
                 document.getElementById('container-create-form').reset();
                 closeContainerCreateModal();

             } catch (error) {
                 showToast(`שגיאה ביצירת הזמנת מכולה: ${error.message}`, 'error');
                 SmartLog.error(error, "CRUD.Container.Create");
             } finally {
                 btn.disabled = false;
                 btn.innerText = 'שמור הזמנה';
             }
         }
         
         /**
          * Updates an existing container order in Firestore.
          */
         async function handleSaveContainerOrder(event) {
             event.preventDefault();

             const btn = document.getElementById('save-edited-container-order');
             btn.disabled = true;
             btn.innerText = 'שומר...';

             try {
                 const { db, doc, updateDoc, serverTimestamp } = window.firebaseServices;
                 const collectionPath = getPrivateCollectionPath('container-orders');
                 if (!collectionPath) return;

                 const orderId = document.getElementById('container-edit-id').dataset.orderId;
                 const orderRef = doc(db, collectionPath, orderId);

                 // Read editable form data
                 const deliveryType = document.getElementById('container-edit-delivery-type').value;
                 const orderDate = document.getElementById('container-edit-order-date').value;
                 const orderTime = document.getElementById('container-edit-order-time').value;
                 const rentalStartDateTimeLocal = document.getElementById('container-edit-rental-start-date').value;

                 let rentalStartDate = null;
                 
                 // Handle Rental Start Date update
                 if (rentalStartDateTimeLocal) {
                     try {
                         const startDateTime = new Date(rentalStartDateTimeLocal);
                         if (isNaN(startDateTime.getTime())) {
                             throw new Error("תאריך/שעה תחילת שכירות לא תקין.");
                         }
                         // If the date is valid, set it as a Firebase Timestamp
                         rentalStartDate = window.firebaseServices.Timestamp.fromDate(startDateTime);
                     } catch(e) {
                         SmartLog.error(e, "CRUD.Container.Edit", { orderId, date: orderDate, time: orderTime });
                         throw new Error("שגיאה בהמרת תאריך/שעה לתחילת שכירות.");
                     }
                 }

                 const updatedData = {
                    deliveryType: deliveryType,
                    orderDate: orderDate,
                    orderTime: orderTime,
                    notes: document.getElementById('container-edit-notes').value.trim(),
                    rentalStartDate: rentalStartDate, // Update or clear the field
                    lastModified: serverTimestamp()
                 };

                 await updateDoc(orderRef, updatedData);
                 SmartLog.info("Container order updated", "CRUD.Container.Edit", { orderId, changes: updatedData });
                 showToast('הזמנת מכולה עודכנה', 'success');
                 closeContainerEditModal();
                 // Listener will automatically refresh the container view if it's active

             } catch (error) {
                 showToast(`שגיאה בעדכון הזמנת מכולה: ${error.message}`, 'error');
                 SmartLog.error(error, "CRUD.Container.Edit", { orderId });
             } finally {
                 btn.disabled = false;
                 btn.innerText = 'שמור שינויים';
             }
         }
        window.handleSaveContainerOrder = handleSaveContainerOrder;

        /**
         * Deletes a container order from Firestore.
         */
        let orderToDeleteId = null; // משתנה גלובלי זמני לשמירת ה-ID לפני האישור

        function openDeleteConfirmation(orderId, customerName) {
            orderToDeleteId = orderId;
            const messageElement = document.getElementById('delete-confirm-message');
            messageElement.innerHTML = `האם אתה בטוח שברצונך למחוק את ההזמנה עבור הלקוח <strong>${customerName}</strong>? לא ניתן לבטל פעולה זו.`;
            openDeleteConfirmModal();
        }
        window.openDeleteConfirmation = openDeleteConfirmation; // חשיפה גלובלית

        async function handleDeleteContainerOrder() {
            const btn = document.getElementById('confirm-delete-btn');
            btn.disabled = true;
            btn.innerText = 'מוחק...';

            try {
                if (!orderToDeleteId) {
                    throw new Error("לא נבחרה הזמנה למחיקה.");
                }

                const { db, doc, deleteDoc } = window.firebaseServices;
                const collectionPath = getPrivateCollectionPath('container-orders');
                if (!collectionPath) return;

                const orderRef = doc(db, collectionPath, orderToDeleteId);
                await deleteDoc(orderRef);

                SmartLog.info("Container order deleted", "CRUD.Container.Delete", { orderId: orderToDeleteId });
                showToast('הזמנת מכולה נמחקה בהצלחה', 'success');
                closeDeleteConfirmModal();
                closeContainerEditModal(); // סוגר גם את חלון העריכה אם פתוח

            } catch (error) {
                 showToast(`שגיאה במחיקת הזמנת מכולה: ${error.message}`, 'error');
                 SmartLog.error(error, "CRUD.Container.Delete", { orderId: orderToDeleteId });
            } finally {
                 btn.disabled = false;
                 btn.innerText = 'מחק לצמיתות';
                 orderToDeleteId = null;
            }
        }

        // --- Container Dashboard Logic ---
        
        // משתנה לשמירת ה-map instance גלובלית
        let map;
        let markersGroup = null;
        let containerDataCache = []; // שמירת נתוני המכולות לשימוש מרובה

        /**
         * Initializes and runs the Container Dashboard logic.
         */
        function initializeContainerDashboard() {
            const { db, collection, query, onSnapshot, where, orderBy } = window.firebaseServices;
            const collectionPath = getPrivateCollectionPath('container-orders');
            if (!collectionPath) {
                 document.getElementById('loading-message').textContent = 'שגיאה: פרטי משתמש/אפליקציה חסרים.';
                 return;
            }
            
            const grid = document.getElementById('containers-grid');
            grid.innerHTML = '<p id="loading-message" class="col-span-full text-center text-gray-500">טוען נתוני מכולות...</p>';

            // Query: כל ההזמנות, מסודרות לפי תאריך מתוכנן
            const q = query(collection(db, collectionPath), orderBy("scheduledAt", "desc"));
            
            // Listener: מקשיב לשינויים בזמן אמת
            onSnapshot(q, (snapshot) => {
                try {
                    // עדכון המטמון וניקוי הרשת
                    containerDataCache = [];
                    grid.innerHTML = '';
                    const containers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    if (containers.length === 0) {
                        grid.innerHTML = '<p class="col-span-full text-center text-gray-500">אין הזמנות מכולה. הוסף אחת כדי להתחיל!</p>';
                        return;
                    }
                    
                    containers.forEach(container => {
                        containerDataCache.push(container); // שמירה במטמון
                        
                        // חישוב סטטוס איחור באמצעות הפונקציה הגלובלית (חדש)
                        const maxDays = container.containerSize === '8 קוב' ? 14 : 10; 
                        const status = window.calculateOverdueStatus(container.rentalStartDate, container.returnDate, maxDays);

                        let statusText;
                        let statusClass;
                        let cardClasses = 'eco-card bg-white p-4 rounded-xl shadow-lg flex flex-col space-y-3 border border-gray-200 cursor-pointer';

                        if (status.returned) {
                             statusText = 'הוחזר';
                             statusClass = 'text-gray-500';
                        } else if (status.isOverdue) {
                            statusText = `באיחור! ${status.daysOverdue} ימים`;
                            statusClass = 'overdue-text'; // Red
                            cardClasses += ' overdue-card';
                        } else if (status.daysElapsed > 0) {
                            statusText = `${status.daysLeft} ימים נותרו`;
                            statusClass = 'normal-text'; // Green
                        } else {
                            statusText = 'טרם החל';
                            statusClass = 'text-gray-500';
                        }

                        // יצירת הכרטיס
                        const card = document.createElement('div');
                        card.className = cardClasses;
                        card.dataset.orderId = container.id;
                        
                        card.innerHTML = `
                            <div class="flex items-start justify-between">
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-gray-200 text-gray-700">${container.containerSize} (${container.deliveryType})</span>
                                <i data-feather="edit-3" class="w-5 h-5 text-gray-400 hover:text-blue-500 transition duration-150 edit-container-btn" data-order-id="${container.id}"></i>
                            </div>
                            
                            <h3 class="text-xl font-bold text-gray-800 eco-customer-name">${container.customerName}</h3>
                            <p class="text-sm text-gray-600 eco-address">${container.address}</p>
                            
                            <div class="border-t pt-3 space-y-2">
                                <p class="text-sm flex justify-between">
                                    <span class="font-medium text-gray-700">תאריך מתוכנן:</span>
                                    <span>${container.orderDate} בשעה ${container.orderTime}</span>
                                </p>
                                <p class="text-sm flex justify-between">
                                    <span class="font-medium text-gray-700">סטטוס שכירות:</span>
                                    <span class="${statusClass}">${statusText}</span>
                                </p>
                                ${container.rentalStartDate 
                                    ? `<p class="text-xs text-gray-500">החל מ: ${container.rentalStartDate.toDate().toLocaleDateString('he-IL')}</p>` 
                                    : ''
                                }
                            </div>
                            <div class="flex space-x-2 space-x-reverse pt-2">
                                <button data-order-id="${container.id}" data-type="Replace" class="action-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xs py-1 px-2 rounded-lg transition duration-150">החלף</button>
                                <button data-order-id="${container.id}" data-type="Removal" class="action-btn bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded-lg transition duration-150">פנה</button>
                                ${!container.rentalStartDate ? `<button data-order-id="${container.id}" data-type="StartRental" class="action-btn bg-green-500 hover:bg-green-600 text-white text-xs py-1 px-2 rounded-lg transition duration-150">התחל שכירות</button>` : ''}
                                ${container.rentalStartDate && !container.returnDate ? `<button data-order-id="${container.id}" data-type="CompleteRental" class="action-btn bg-gray-500 hover:bg-gray-600 text-white text-xs py-1 px-2 rounded-lg transition duration-150">סיום שכירות</button>` : ''}

                            </div>
                        `;
                        grid.appendChild(card);
                    });

                    // הפעלת אייקוני Feather
                    feather.replace();
                    
                    // מריץ סינון לפי הסטטוס הנוכחי (למקרה שהיה פעיל)
                    filterContainersByStatus(document.getElementById('container-status-filter').value);

                } catch (error) {
                    SmartLog.error(error, "ContainerDashboard.onSnapshot");
                    grid.innerHTML = '<p class="col-span-full text-center text-red-500">שגיאה בטעינת הנתונים.</p>';
                }
            });
        }
        window.initializeContainerDashboard = initializeContainerDashboard; // חשיפה גלובלית
        
        /**
         * Updates the UI to show the selected container's details in the edit modal.
         */
        function handleEditContainerClick(orderId) {
             const container = containerDataCache.find(c => c.id === orderId);
             if (!container) {
                 showToast('הזמנה לא נמצאה.', 'error');
                 return;
             }

             // השדות לקריאה בלבד
             document.getElementById('container-edit-id').dataset.orderId = orderId;
             document.getElementById('container-edit-id').textContent = `ID: ${orderId}`;
             document.getElementById('container-edit-customer-name').textContent = container.customerName;
             document.getElementById('container-edit-container-size').textContent = container.containerSize;
             document.getElementById('container-edit-address').textContent = container.address;
             // קואורדינטות (קריאה בלבד)
             document.getElementById('container-edit-latitude').textContent = container.location?.lat?.toFixed(6) || 'N/A';
             document.getElementById('container-edit-longitude').textContent = container.location?.lng?.toFixed(6) || 'N/A';


             // השדות לעריכה
             document.getElementById('container-edit-delivery-type').value = container.deliveryType;
             document.getElementById('container-edit-order-date').value = container.orderDate;
             document.getElementById('container-edit-order-time').value = container.orderTime;
             document.getElementById('container-edit-notes').value = container.notes || '';
             
             // טיפול בשדה תחילת השכירות
             if (container.rentalStartDate && container.rentalStartDate.toDate) {
                 const date = container.rentalStartDate.toDate();
                 // יצירת פורמט YYYY-MM-DDTHH:MM עבור input[type="datetime-local"]
                 const localDateTime = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                 document.getElementById('container-edit-rental-start-date').value = localDateTime;
             } else {
                 document.getElementById('container-edit-rental-start-date').value = '';
             }

             openContainerEditModal();
        }


        // --- Map Dashboard Logic ---
        
        /**
         * Initializes the Leaflet map.
         */
        function initializeMap() {
             if (map) map.remove(); // מונע יצירה כפולה

             // ברירת מחדל: תל אביב
             map = L.map('map').setView([32.0853, 34.7818], 13);

             L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                 attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
             }).addTo(map);
             
             markersGroup = L.layerGroup().addTo(map);

             // הפעלת Listener לטעינת הנתונים
             loadContainerOrdersForMap();
             document.getElementById('map-status').textContent = 'המפה מוכנה. טוען הזמנות...';
        }

        /**
         * Loads container orders and renders map markers.
         */
        function loadContainerOrdersForMap() {
            const { db, collection, query, onSnapshot, where, orderBy } = window.firebaseServices;
            const collectionPath = getPrivateCollectionPath('container-orders');
            if (!collectionPath) return;

            // Query: מביא רק הזמנות שיש להן קואורדינטות תקינות
            const q = query(collection(db, collectionPath), where('location.lat', '!=', null));

            onSnapshot(q, (snapshot) => {
                try {
                    const containers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderMapMarkers(containers);
                    document.getElementById('map-status').textContent = `נמצאו ${containers.length} הזמנות עם מיקום.`;
                } catch (error) {
                    SmartLog.error(error, "MapDashboard.onSnapshot");
                    document.getElementById('map-status').textContent = 'שגיאה בטעינת נתוני המפה.';
                }
            });
        }
        
        /**
         * Renders the markers on the map.
         * @param {Array<Object>} containers - Array of container order objects.
         */
        function renderMapMarkers(containers) {
            if (!map || !markersGroup) return;
            markersGroup.clearLayers(); // ניקוי סמנים קודמים

            containers.forEach(container => {
                if (!container.location || !container.location.lat || !container.location.lng) return;

                const { lat, lng } = container.location;

                // יצירת אייקון מותאם אישית (האם המכולה באיחור?)
                const maxDays = container.containerSize === '8 קוב' ? 7 : 14; 
                const status = window.calculateOverdueStatus(container.rentalStartDate, container.returnDate, maxDays); // שימוש בפונקציה הגלובלית (חדש)

                let markerColor = 'blue'; // ברירת מחדל: ממתין
                if (container.rentalStartDate && !container.returnDate) {
                    markerColor = status.isOverdue ? 'red' : 'green'; // פעיל/איחור
                } else if (container.returnDate) {
                    markerColor = 'gray'; // הוחזר
                } else if (container.deliveryType === 'Removal') {
                    markerColor = 'orange'; // הוצאה
                }

                const iconHtml = `<div style="background-color: ${markerColor}; width: 1.5rem; height: 1.5rem; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`;
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: iconHtml,
                    iconSize: [24, 24],
                    popupAnchor: [0, -12]
                });

                const marker = L.marker([lat, lng], { icon: customIcon }).addTo(markersGroup);

                // תוכן ה-Popup
                let statusInfo = '';
                if (status.returned) {
                    statusInfo = `<p class="font-bold text-gray-500">סטטוס: הוחזר</p>`;
                } else if (status.isOverdue) {
                    statusInfo = `<p class="font-bold text-red-600">באיחור: ${status.daysOverdue} ימים!</p>`;
                } else if (status.daysElapsed > 0) {
                    statusInfo = `<p class="font-bold text-green-600">נותרו: ${status.daysLeft} ימים</p>`;
                } else {
                    statusInfo = `<p class="font-bold text-gray-500">סטטוס: ממתין להצבה</p>`;
                }
                
                const scheduledDate = container.scheduledAt?.toDate ? container.scheduledAt.toDate().toLocaleDateString('he-IL') : 'לא נקבע';
                const scheduledTime = container.scheduledAt?.toDate ? container.scheduledAt.toDate().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '';

                const popupContent = `
                    <div class="text-right">
                        <h4 class="text-lg font-bold text-gray-800">${container.customerName}</h4>
                        <p class="text-sm text-gray-600">${container.address}</p>
                        <p class="text-xs text-gray-400 ltr">Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}</p>
                        <hr class="my-2"/>
                        <p class="text-sm"><strong>מכולה:</strong> ${container.containerSize}</p>
                        <p class="text-sm"><strong>פעולה:</strong> ${container.deliveryType}</p>
                        <p class="text-sm"><strong>מתוכנן:</strong> ${scheduledDate} (${scheduledTime})</p>
                        <hr class="my-2"/>
                        ${statusInfo}
                        <button onclick="window.handleEditContainerClick('${container.id}')" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-3 rounded-lg">
                            ערוך פרטים
                        </button>
                    </div>
                `;

                marker.bindPopup(popupContent, { maxWidth: 300 });
            });
            
            // התאמת המפה לכל הסמנים
            if (containers.length > 0) {
                const bounds = markersGroup.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        }
        
        // --- Filtering Logic (Container Dashboard) ---
        function filterContainersByStatus(statusFilter) {
            const grid = document.getElementById('containers-grid');
            const cards = grid.querySelectorAll('.eco-card');

            cards.forEach(card => {
                const orderId = card.dataset.orderId;
                const container = containerDataCache.find(c => c.id === orderId);
                
                if (!container) return;
                
                const maxDays = container.containerSize === '8 קוב' ? 7 : 14; 
                const status = window.calculateOverdueStatus(container.rentalStartDate, container.returnDate, maxDays);
                
                let isVisible = false;

                switch (statusFilter) {
                    case 'all':
                        isVisible = true;
                        break;
                    case 'active':
                        isVisible = container.rentalStartDate && !container.returnDate && !status.isOverdue;
                        break;
                    case 'overdue':
                        isVisible = status.isOverdue;
                        break;
                    case 'pending':
                        isVisible = !container.rentalStartDate && !container.returnDate;
                        break;
                    // TODO: הוסף סינון 'הוחזר' אם נדרש
                    default:
                        isVisible = true;
                }

                card.style.display = isVisible ? 'flex' : 'none';
            });
        }


        // --- Event Listeners and Main Setup ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // טעינת אייקונים
            feather.replace();

            // --- Geocoding Listener ---
            document.getElementById('geocode-button').addEventListener('click', async () => {
                const addressInput = document.getElementById('address');
                const latInput = document.getElementById('latitude');
                const lngInput = document.getElementById('longitude');

                const address = addressInput.value.trim();
                const currentLat = parseFloat(latInput.value);
                const currentLng = parseFloat(lngInput.value);
                
                if (!address && (isNaN(currentLat) || isNaN(currentLng))) {
                    showToast('אנא הזן כתובת או קואורדינטות.', 'error');
                    return;
                }

                const result = await geocodeAddress(address, currentLat, currentLng);
                if (result.success) {
                    latInput.value = result.lat;
                    lngInput.value = result.lng;
                } 
                // אין צורך ב-else כי פונקציית ה-geocode תמיד מחזירה הצלחה עם מיקום כלשהו
            });
            
            // --- Navigation Logic ---
            const containerDashboard = document.getElementById('container-dashboard');
            const mapDashboard = document.getElementById('map-dashboard');
            const openEcoBtn = document.getElementById('openEcoDashboardButton');
            const openMapBtn = document.getElementById('openMapDashboardButton');

            function navigateTo(target) {
                containerDashboard.classList.add('hidden');
                mapDashboard.classList.add('hidden');
                
                if (target === 'container') {
                    containerDashboard.classList.remove('hidden');
                } else if (target === 'map') {
                    mapDashboard.classList.remove('hidden');
                    // אתחול המפה רק כשעוברים אליה
                    if (!map) {
                        initializeMap();
                    } else {
                        // אם המפה כבר קיימת, יש לוודא שהיא מעדכנת את התצוגה שלה
                         map.invalidateSize(); 
                    }
                }
            }

            openEcoBtn.addEventListener('click', () => navigateTo('container'));
            openMapBtn.addEventListener('click', () => navigateTo('map'));

            // ברירת מחדל: הצג לוח מכולות
            navigateTo('container');
            
            // --- Modal Listeners ---
            document.getElementById('openContainerCreateModalButton').addEventListener('click', openContainerCreateModal);
            document.getElementById('close-create-modal').addEventListener('click', closeContainerCreateModal);
            document.getElementById('close-edit-modal').addEventListener('click', closeContainerEditModal);
            document.getElementById('cancel-delete-btn').addEventListener('click', closeDeleteConfirmModal);
            document.getElementById('container-create-form').addEventListener('submit', handleCreateContainerOrder);
            document.getElementById('container-edit-form').addEventListener('submit', handleSaveContainerOrder);
            document.getElementById('delete-container-order').addEventListener('click', (e) => {
                 e.preventDefault();
                 const orderId = document.getElementById('container-edit-id').dataset.orderId;
                 const customerName = document.getElementById('container-edit-customer-name').textContent;
                 openDeleteConfirmation(orderId, customerName);
            });
            document.getElementById('confirm-delete-btn').addEventListener('click', handleDeleteContainerOrder);


            // סגירת מודאל בלחיצה על רקע אפור כהה
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeModal(overlay.id);
                    }
                });
            });


            // --- Dashboard Event Delegation ---
            
            // האצלת אירועים לטיפול בכפתור העריכה ובכפתורי הפעולה
            document.getElementById('containers-grid').addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-container-btn');
                const actionBtn = e.target.closest('.action-btn');

                if (editBtn) {
                    const orderId = editBtn.dataset.orderId;
                    handleEditContainerClick(orderId);
                } else if (actionBtn) {
                    const orderId = actionBtn.dataset.orderId;
                    const actionType = actionBtn.dataset.type;
                    
                    // TODO: implement specific action handlers (Replace, Removal, StartRental, CompleteRental)
                    showToast(`פעולת ${actionType} נבחרה עבור ID: ${orderId}`, 'info');

                    // פונקציית עזר לשנות סטטוס שכירות מתוך לוח המכולות (לצורך בדיקה)
                    if (actionType === 'StartRental') {
                         window.handleSetRentalStart(orderId, new Date());
                    } else if (actionType === 'CompleteRental') {
                         window.handleSetRentalReturn(orderId, new Date());
                    }
                }
            });
            
            // --- Filtering and Search Listeners ---
            document.getElementById('container-status-filter').addEventListener('change', (e) => {
                filterContainersByStatus(e.target.value);
            });

            document.getElementById('container-search-input').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const cards = document.getElementById('containers-grid').querySelectorAll('.eco-card');
                
                cards.forEach(card => {
                    const customerName = card.querySelector('.eco-customer-name')?.textContent.toLowerCase() || '';
                    const address = card.querySelector('.eco-address')?.textContent.toLowerCase() || '';
                    const isVisible = customerName.includes(searchTerm) || address.includes(searchTerm);
                    
                    // שמירה על סטטוס הסינון הנוכחי (משלב את החיפוש עם הסינון)
                    const statusFilter = document.getElementById('container-status-filter').value;
                    const isStatusVisible = card.style.display !== 'none'; // אם הוא כבר הוסתר על ידי סינון הסטטוס

                    card.style.display = isVisible && isStatusVisible ? 'flex' : 'none';
                });
                
                // מריץ סינון סטטוס מחדש לאחר החיפוש
                filterContainersByStatus(document.getElementById('container-status-filter').value);
            });

            // --- סטטוס/פעולות שכירות מהירות ---
            async function handleSetRentalStart(orderId, date) {
                 const { db, doc, updateDoc, serverTimestamp } = window.firebaseServices;
                 const collectionPath = getPrivateCollectionPath('container-orders');
                 if (!collectionPath) return;

                 try {
                      const rentalStartDate = window.firebaseServices.Timestamp.fromDate(date);
                      await updateDoc(doc(db, collectionPath, orderId), {
                          rentalStartDate: rentalStartDate,
                          returnDate: null, // מוודא שאין תאריך החזרה אם מתחילים שכירות
                          lastModified: serverTimestamp()
                      });
                      showToast('סטטוס שכירות הוגדר כ"פעיל"', 'success');
                 } catch (error) {
                      showToast(`שגיאה בהגדרת סטטוס: ${error.message}`, 'error');
                      SmartLog.error(error, "CRUD.Rental.Start", { orderId });
                 }
            }
            window.handleSetRentalStart = handleSetRentalStart;

            async function handleSetRentalReturn(orderId, date) {
                 const { db, doc, updateDoc, serverTimestamp } = window.firebaseServices;
                 const collectionPath = getPrivateCollectionPath('container-orders');
                 if (!collectionPath) return;

                 try {
                      const returnDate = window.firebaseServices.Timestamp.fromDate(date);
                      await updateDoc(doc(db, collectionPath, orderId), {
                          returnDate: returnDate,
                          rentalStartDate: window.firebaseServices.Timestamp.now(), // מוודא שיש תאריך התחלה לפני סיום (למקרה של דאטה לא שלם)
                          lastModified: serverTimestamp()
                      });
                      showToast('סטטוס שכירות הוגדר כ"הוחזר"', 'success');
                 } catch (error) {
                      showToast(`שגיאה בהגדרת סטטוס: ${error.message}`, 'error');
                      SmartLog.error(error, "CRUD.Rental.Return", { orderId });
                 }
            }
            window.handleSetRentalReturn = handleSetRentalReturn;


            // --- התחלת האפליקציה ---\
            if (window.firebaseAuthReady) {
                initializeContainerDashboard();
            } else {
                document.addEventListener('firebaseAuthReady', () => {
                    initializeContainerDashboard();
                });
            }

            // TODO: להפעיל את initializeMap רק בלחיצה על כפתור המפה
        });
    </script>
</body>
</html>
