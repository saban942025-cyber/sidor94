<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Zebulun Site App</title>
    
    <!-- 
      Zebulun Site App (v55.8)
      -------------------------
      אפליקציית PWA למנהלי אתרים.
      - מתחברת עם setup_key
      - טוענת קטלוג מוצרים
      - שולחת בקשות הזמנה לאישור (ל-pending_orders)
      - עוקבת אחר סטטוס הזמנות מאושרות
      
      תיקונים בגרסה זו (v55.8):
      - [FIX] הוספת `getDocs` ו-`limit` לייבוא Firestore (תיקון שגיאת 'is not defined').
      - [FIX] תיקון נתיב המניפסט ל-`../site_manifest.json`
      - [FIX] עדכון כתובת הקטלוג ל-API הנכון (`...Ia_3_UT/exec`).
      - [FIX] תיקון לוגיקת קריאת הקטלוג ל-`data.data`.
      - [FIX] הוספת בדיקת `if (!state.currentProject)` ב-loadOrderHistory למניעת קריסה.
    -->

    <!-- PWA Manifest & Theme -->
    <!-- [תיקון v55.8] תיקון נתיב המניפסט -->
    <link rel="manifest" href="../site_manifest.json">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/ryPT3r29/image.png">
    <link rel="icon" href="https://i.postimg.cc/ryPT3r29/image.png">

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Google Font: Rubik -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --primary-light: #eff6ff; /* blue-50 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
            --text-dark: #1f2937; /* gray-800 */
            --text-light: #6b7280; /* gray-500 */
            --danger: #ef4444; /* red-500 */
        }
        
        html.dark {
            --primary-color: #60a5fa; /* blue-400 */
            --primary-dark: #3b82f6; /* blue-500 */
            --primary-light: #1e3a8a; /* blue-900 / slate-700 */
            --bg-light: #0f172a; /* slate-900 */
            --bg-white: #1e293b; /* slate-800 */
            --border-color: #334155; /* slate-700 */
            --text-dark: #f1f5f9; /* slate-100 */
            --text-light: #94a3b8; /* slate-400 */
            --danger: #f87171; /* red-400 */
        }

        html { -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            overscroll-behavior: none;
            overflow: hidden; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Loader --- */
        #app-loader {
            position: fixed;
            inset: 0;
            background-color: var(--bg-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.3s ease;
        }
        .loader {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        .loader-small {
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* --- Global Alert (Toast) --- */
        #global-alert-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            width: 90%;
            max-width: 400px;
        }
        .global-alert {
            background: rgba(30, 41, 59, 0.85); /* slate-800 */
            backdrop-filter: blur(5px);
            color: #fff;
            padding: 1rem 1.25rem;
            border-radius: 0.75rem;
            font-weight: 600;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            animation: popIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        @keyframes popIn {
          from { transform: translateY(20px) scale(0.9); opacity: 0; }
          to { transform: translateY(0) scale(1); opacity: 1; }
        }

        /* --- Form Elements --- */
        .form-label {
            display: block;
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            color: var(--text-dark);
        }
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.6rem 0.9rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background-color: var(--bg-white);
            color: var(--text-dark);
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-light);
        }
        .btn {
            padding: 0.6rem 1.25rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        .btn-primary:disabled {
            background-color: var(--text-light);
            cursor: not-allowed;
            opacity: 0.7;
        }
        .btn-secondary {
            background-color: var(--bg-light);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }
        .btn-icon {
            padding: 0.5rem;
            border-radius: 0.5rem;
            background: none;
            border: none;
            color: var(--text-light);
        }
        .btn-icon:hover {
            background-color: var(--bg-light);
            color: var(--text-dark);
        }
        
        /* --- Card Styles --- */
        .glass-card {
            background: var(--bg-white);
            border-radius: 0.75rem;
            padding: 1.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid var(--border-color);
        }
        .list-item-card {
            background-color: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        /* --- PWA Layout --- */
        #site-pwa-layout {
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            height: -webkit-fill-available;
        }
        #site-header {
            background-color: var(--bg-white);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 10;
            padding: 1rem 1.25rem;
            padding-top: calc(1rem + env(safe-area-inset-top, 0));
        }
        .header-project-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
        }
        .header-submitter-name {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        #site-main-content {
            overflow-y: auto;
            position: relative;
        }
        
        #site-bottom-nav {
            display: grid;
            grid-auto-flow: column;
            background-color: var(--bg-white);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -1px 3px rgba(0,0,0,0.05);
            z-index: 10;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            color: var(--text-light);
            font-size: 0.7rem;
            font-weight: 500;
            border-top: 3px solid transparent;
            transition: all 0.2s ease;
            position: relative;
        }
        .nav-button.active {
            color: var(--primary-color);
            border-top-color: var(--primary-color);
            background-color: var(--primary-light);
        }
        .notification-badge {
            position: absolute;
            top: 4px;
            right: 20px;
            background-color: var(--danger);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            border-radius: 99px;
            padding: 0 6px;
            min-width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            border: 2px solid var(--bg-white);
            display: none; /* Hidden by default */
        }
        .nav-button.active .notification-badge {
            border-color: var(--primary-light);
        }

        /* --- App Pages --- */
        .app-page {
            padding: 1rem;
            display: none; /* Hidden by default */
        }
        .app-page.active {
            display: block;
        }

        /* --- New Request Page --- */
        #new-request-cart {
            min-height: 50px;
        }
        .cart-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-white);
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }
        .cart-item-info { flex-grow: 1; }
        .cart-item-info strong { font-size: 0.9rem; }
        .cart-item-info p { font-size: 0.8rem; color: var(--text-light); }
        .cart-item input { width: 60px; text-align: center; }

        #media-preview-container {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }
        .media-preview {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .media-preview img { width: 100%; height: 100%; object-fit: cover; }
        .media-preview .media-icon { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: var(--bg-white); }
        .media-preview .remove-media {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: rgba(0,0,0,0.6);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* --- Catalog Page --- */
        #catalog-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        @media (min-width: 640px) {
            #catalog-grid { grid-template-columns: repeat(3, 1fr); }
        }
        .product-card {
            background-color: var(--bg-white);
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .product-card-img {
            height: 120px;
            background-color: var(--bg-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .product-card-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .product-card-body {
            padding: 0.75rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .product-card-body h5 {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-dark);
            line-height: 1.3;
            height: 2.6em; /* 2 lines */
            overflow: hidden;
        }
        .product-card-body p {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }
        .product-card-body .btn {
            margin-top: auto; /* Push button to bottom */
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
            margin-top: 0.75rem;
        }

        /* --- History Page --- */
        .status-badge {
            padding: 0.1rem 0.6rem;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 99px;
            text-transform: uppercase;
        }
        .status-pending { background-color: #fef9c3; color: #713f12; } /* yellow */
        .status-approved { background-color: #dbeafe; color: #1e3a8a; } /* blue */
        .status-onway { background-color: #dcfce7; color: #15803d; } /* green */
        .status-rejected { background-color: #fee2e2; color: #991b1b; } /* red */

    </style>
</head>
<body class="antialiased">

    <!-- Global Loader -->
    <div id="app-loader">
        <div class="loader"></div>
        <p class="mt-4 font-semibold text-lg" id="loader-text">טוען אפליקציית אתר...</p>
    </div>

    <!-- Global Alert (Toast) Container -->
    <div id="global-alert-container"></div>
    
    <!-- PWA Layout -->
    <div id="site-pwa-layout">
        <!-- Header -->
        <header id="site-header">
            <h1 id="header-project-name" class="header-project-name truncate">...</h1>
            <p id="header-submitter-name" class="header-submitter-name">טוען פרטי מנהל...</p>
        </header>
        
        <!-- Main Content -->
        <main id="site-main-content" class="no-scrollbar">
            
            <!-- Page 1: New Request -->
            <div id="page-new-request" class="app-page active">
                <div class="glass-card">
                    <!-- Cart -->
                    <div id="new-request-cart" class="space-y-2">
                        <!-- Items added from catalog appear here -->
                    </div>
                    
                    <!-- Raw Text Input -->
                    <textarea id="raw-text-input" class="form-textarea mt-3" rows="3" placeholder="הקלד פריטים נוספים, הערות, או הדבק רשימה..."></textarea>
                    
                    <!-- Media Buttons -->
                    <div class="grid grid-cols-4 gap-2 mt-3">
                        <input type="file" id="image-upload-input" accept="image/*" class="hidden" onchange="handleMediaUpload(event, 'image')">
                        <input type="file" id="audio-upload-input" accept="audio/*" class="hidden" onchange="handleMediaUpload(event, 'audio')">
                        
                        <button class="btn btn-secondary" onclick="document.getElementById('image-upload-input').click()">
                            <i data-feather="camera"></i>
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('audio-upload-input').click()">
                            <i data-feather="mic"></i>
                        </button>
                        <button class="btn btn-secondary" onclick="sendLocation()">
                            <i data-feather="map-pin"></i>
                        </button>
                        <button class="btn btn-secondary" onclick="showToast('בקרוב', 'info')">
                            <i data-feather="video"></i>
                        </button>
                    </div>
                    
                    <!-- Media Preview -->
                    <div id="media-preview-container"></div>
                    
                    <!-- Submitter Name -->
                    <input type="text" id="submitter-name-input" class="form-input mt-4" placeholder="שם מלא (חובה)" required>

                    <!-- Send Button -->
                    <button id="send-request-btn" class="btn btn-primary btn-lg w-full mt-4" onclick="sendRequest()">
                        <i data-feather="send"></i>
                        <span>שלח לאישור יוסי</span>
                    </button>
                </div>
            </div>
            
            <!-- Page 2: Catalog -->
            <div id="page-catalog" class="app-page">
                <input type="text" id="catalog-search-input" class="form-input mb-3" placeholder="חפש מוצר או מק'ט..." onkeyup="renderCatalog()">
                <div id="catalog-grid">
                    <!-- Products injected by renderCatalog() -->
                </div>
            </div>
            
            <!-- Page 3: History / Status -->
            <div id="page-history" class="app-page">
                <div id="history-list-container" class="flex flex-col gap-3">
                    <!-- Injected by loadOrderHistory() -->
                </div>
            </div>

        </main>
        
        <!-- Bottom Navigation -->
        <nav id="site-bottom-nav">
            <button id="nav-site-request" class="nav-button active" onclick="navigate('new-request')">
                <i data-feather="plus-circle" class="w-6 h-6"></i>
                <span>הזמנה</span>
            </button>
            <button id="nav-site-catalog" class="nav-button" onclick="navigate('catalog')">
                <i data-feather="shopping-bag" class="w-6 h-6"></i>
                <span>קטלוג</span>
            </button>
            <button id="nav-site-history" class="nav-button" onclick="navigate('history')">
                <i data-feather="archive" class="w-6 h-6"></i>
                <span>היסטוריה</span>
                <span id="history-badge" class="notification-badge">0</span>
            </button>
        </nav>
    </div>

    <!-- 
    ======================================================
    === 2. EMBEDDED JAVASCRIPT (v55.8)
    ======================================================
    -->
    <script type="module">
        // [תיקון v55.8] הוספת getDocs ו- limit
        import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            onSnapshot, 
            query, 
            where, 
            orderBy, 
            limit, 
            serverTimestamp,
            getDocs
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        // --- Configuration ---
        const fallbackConfig = {
            apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
            authDomain: "saban94-78949.firebaseapp.com", 
            projectId: "saban94-78949",
            storageBucket: "saban94-78949.appspot.com", 
            messagingSenderId: "41553157903", 
            appId: "1:41553157903:web:cc33d252cff023be97a87a"
        };
        const FIREBASE_CONFIG = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : fallbackConfig;
        
        // [תיקון v55.8] עדכון לכתובת הקטלוג הנכונה
        const CATALOG_API_URL = "https://script.google.com/macros/s/AKfycbzXTd7xKPR6MH9rtOEGxPr3-hrTCTfpuH0kKOzpRkMGOlmYbvKfjwL8d2fgwIa_3_UT/exec";
        
        const CLIENT_ID = "zebulun_adiran"; 

        // --- Global App State ---
        let db, auth, storage;
        let currentUserId = null;
        let appInitialized = false;

        const state = {
            currentView: 'new-request',
            setupKey: null,
            currentProject: null, // יכיל את אובייקט הפרויקט { id, name, address, ... }
            catalog: [],
            requestCart: [], // { sku, name, quantity }
            mediaFiles: [], // { type, file, name } -> { type, url } after upload
            orderHistory: [] // { id, ...data }
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', initSiteApp);

        function initSiteApp() {
            console.log("DOM loaded. Initializing Site App...");
            feather.replace();
            initFirebase();
            initEventListeners();
            
            // קבלת מפתח התקנה מה-URL
            try {
                const params = new URLSearchParams(window.location.search);
                state.setupKey = params.get('setup_key');
                if (!state.setupKey) {
                    showAppLoaderError("שגיאה: הלינק לא תקין. חסר מפתח התקנה (setup_key).");
                    return;
                }
            } catch (e) {
                showAppLoaderError("שגיאה בקריאת ה-URL.");
                return;
            }

            navigate('new-request');
        }

        function initFirebase() {
            try {
                const app = !getApps().length ? initializeApp(FIREBASE_CONFIG) : getApp();
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                console.log("Firebase Initialized.");
                authenticateUser();
            } catch (error) {
                console.error("Firebase Init Error:", error);
                showAppLoaderError("שגיאת התחברות קריטית ל-Firebase");
            }
        }

        function initEventListeners() {
            // כפתורי ניווט
            document.getElementById('nav-site-request').addEventListener('click', () => navigate('new-request'));
            document.getElementById('nav-site-catalog').addEventListener('click', () => navigate('catalog'));
            document.getElementById('nav-site-history').addEventListener('click', () => navigate('history'));
            
            // חשיפת פונקציות גלובליות
            window.navigate = navigate;
            window.sendRequest = sendRequest;
            window.handleMediaUpload = handleMediaUpload;
            window.removeMedia = removeMedia;
            window.sendLocation = sendLocation;
            window.renderCatalog = renderCatalog;
            window.addItemToCart = addItemToCart;
            window.updateCartItemQuantity = updateCartItemQuantity;
            window.removeCartItem = removeCartItem;
            window.showToast = showToast;
        }

        function showAppLoaderError(message) {
            document.getElementById('loader-text').innerText = message;
            document.querySelector('#app-loader .loader').style.display = 'none';
        }

        function authenticateUser() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log(`Site User Authenticated: ${currentUserId}`);
                    
                    if (!appInitialized) {
                        appInitialized = true;
                        // טען נתונים קריטיים לפני הסתרת ה-loader
                        await loadProjectData();
                        await fetchCatalogData();
                        await loadOrderHistory();
                        
                        const loader = document.getElementById('app-loader');
                        if (loader) {
                            loader.style.opacity = '0';
                            setTimeout(() => loader.style.display = 'none', 300);
                        }
                    }
                } else {
                    console.log("No user found. Signing in anonymously...");
                    try {
                        // משתמשי אתר הם אנונימיים, אך ה-UID שלהם נשמר
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Authentication Error:", error);
                        showAppLoaderError("שגיאת התחברות. בדוק חיבור רשת.");
                    }
                }
            });
        }
        
        // --- Data Loading ---
        async function loadProjectData() {
            if (!state.setupKey || !db) return;
            
            try {
                const projectsRef = collection(db, "projects");
                // [תיקון v55.8] הוספת `limit` לרשימת הייבוא פתרה את השגיאה
                const q = query(projectsRef, where("setupKey", "==", state.setupKey), limit(1));
                
                // [תיקון v55.8] הוספת `getDocs` לרשימת הייבוא פתרה את השגיאה
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    showAppLoaderError("הפרויקט לא נמצא. הלינק שגוי או שהפרויקט נמחק.");
                    return;
                }
                
                const projectDoc = snapshot.docs[0];
                state.currentProject = { id: projectDoc.id, ...projectDoc.data() };
                
                // עדכון ה-Header
                document.getElementById('header-project-name').innerText = state.currentProject.name;
                document.getElementById('header-submitter-name').innerText = `מנהל אתר (UID: ${currentUserId.slice(0,6)})`;
                
                // מילוי אוטומטי של כתובת אם קיימת
                const locationInput = document.getElementById('order-location');
                if (locationInput && state.currentProject.address) {
                    locationInput.value = state.currentProject.address;
                }

            } catch (error) {
                console.error("Failed to load project:", error);
                showAppLoaderError(`שגיאה בטעינת הפרויקט: ${error.message}`);
            }
        }
        
        async function loadOrderHistory() {
            // [תיקון v55.8] בדיקה שהפרויקט נטען בהצלחה לפני שמנסים לקרוא ממנו
            if (!state.currentProject || !state.currentProject.id) {
                console.warn("loadOrderHistory skipped: currentProject is not loaded yet.");
                return;
            }

            try {
                // א) קריאת בקשות שעדיין ממתינות
                const pendingQ = query(
                    collection(db, "pending_orders"), 
                    where("project_id", "==", state.currentProject.id),
                    where("site_manager_uid", "==", currentUserId)
                    // [FIX] הסרת orderBy כדי למנוע דרישת אינדקס
                );
                const pendingSnapshot = await getDocs(pendingQ);
                let history = pendingSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // ב) קריאת הזמנות שכבר אושרו
                const approvedQ = query(
                    collection(db, "orders"),
                    where("projectId", "==", state.currentProject.id),
                    where("siteManagerUid", "==", currentUserId)
                    // [FIX] הסרת orderBy
                );
                const approvedSnapshot = await getDocs(approvedQ);
                approvedSnapshot.docs.forEach(doc => {
                    history.push({ id: doc.id, ...doc.data(), status: doc.data().status || 'מאושר' });
                });
                
                // ג) מיון מאוחד בצד הלקוח
                history.sort((a, b) => {
                    const timeA = (a.timestamp || a.createdAt)?.seconds || 0;
                    const timeB = (b.timestamp || b.createdAt)?.seconds || 0;
                    return timeB - timeA; // מהחדש לישן
                });
                
                state.orderHistory = history;
                renderHistoryPage();

            } catch(error) {
                console.error("Failed to load order history:", error);
            }
        }

        // --- Navigation ---
        function navigate(viewId) {
            console.log(`Navigating to: ${viewId}`);
            state.currentView = viewId;
            
            document.querySelectorAll('.app-page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));

            document.getElementById(`page-${viewId}`).classList.add('active');
            document.getElementById(`nav-site-${viewId.split('-')[0]}`).classList.add('active');
            
            feather.replace();
        }

        // --- Catalog Logic ---
        async function fetchCatalogData() {
            if (state.catalog.length > 0) return;
            console.log("Fetching catalog...");
            try {
                const response = await fetch(CATALOG_API_URL);
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const text = await response.text();
                try {
                    const data = JSON.parse(text);
                    // [תיקון v55.8] התאמה למבנה הנכון data.data
                    if (data && data.status === 'success' && Array.isArray(data.data)) {
                        state.catalog = data.data; 
                        console.log(`Catalog loaded with ${state.catalog.length} items.`);
                    } else {
                        throw new Error("Invalid JSON structure from catalog API");
                    }
                } catch (e) {
                    console.error("Failed to parse catalog JSON:", e.message);
                    console.error("תגובה שהתקבלה:", text.substring(0, 100) + "...");
                    throw new Error("שגיאת JSON מהקטלוג. בדוק הרשאות Apps Script.");
                }
                
                renderCatalog(); // רינדור ראשוני
            } catch (error) {
                console.error("Failed to fetch catalog:", error);
                document.getElementById('catalog-grid').innerHTML = `<p class="text-danger p-4 col-span-2">${error.message}</p>`;
            }
        }
        
        function renderCatalog() {
            const grid = document.getElementById('catalog-grid');
            const searchTerm = document.getElementById('catalog-search-input').value.toLowerCase();
            
            if (state.catalog.length === 0) {
                grid.innerHTML = '<div class="loader"></div>';
                return;
            }
            
            const filtered = state.catalog.filter(item => 
                (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                (item.sku && item.sku.toString().includes(searchTerm))
            );
            
            if (filtered.length === 0) {
                grid.innerHTML = '<p class="text-light col-span-2 text-center p-4">לא נמצאו מוצרים</p>';
                return;
            }

            grid.innerHTML = filtered.map(item => `
                <div class="product-card">
                    <div class="product-card-img">
                        <img src="${item.imageUrl || 'https://placehold.co/150x120/e2e8f0/94a3b8?text=N/A'}" alt="${item.name}" loading="lazy">
                    </div>
                    <div class="product-card-body">
                        <h5>${item.name}</h5>
                        <p>מק"ט: ${item.sku}</p>
                        <button class="btn btn-primary w-full" onclick="addItemToCart('${item.sku}', '${item.name}')">
                            <i data-feather="plus" class="w-4 h-4"></i>
                            <span>הוסף</span>
                        </button>
                    </div>
                </div>
            `).join('');
            
            feather.replace();
        }
        
        // --- Cart Logic ---
        function addItemToCart(sku, name) {
            const existingItem = state.requestCart.find(item => item.sku === sku);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                state.requestCart.push({ sku, name, quantity: 1 });
            }
            showToast(`${name} הוסף להזמנה`);
            renderRequestCart();
        }
        
        function updateCartItemQuantity(sku, change) {
            const item = state.requestCart.find(item => item.sku === sku);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeCartItem(sku);
                } else {
                    renderRequestCart();
                }
            }
        }
        
        function removeCartItem(sku) {
            state.requestCart = state.requestCart.filter(item => item.sku !== sku);
            renderRequestCart();
        }
        
        function renderRequestCart() {
            const container = document.getElementById('new-request-cart');
            if (state.requestCart.length === 0) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = state.requestCart.map(item => `
                <div class="cart-item">
                    <img src="https://placehold.co/40x40/e2e8f0/94a3b8?text=N/A" alt="${item.name}" class="w-10 h-10 rounded object-cover">
                    <div class="cart-item-info">
                        <strong>${item.name}</strong>
                        <p>מק"ט: ${item.sku}</p>
                    </div>
                    <input type="number" class="form-input" value="${item.quantity}" onchange="updateCartItemQuantity('${item.sku}', parseInt(this.value) - ${item.quantity})">
                    <button class="btn-icon text-danger" onclick="removeCartItem('${item.sku}')">
                        <i data-feather="x-circle" class="w-5 h-5"></i>
                    </button>
                </div>
            `).join('');
            feather.replace();
        }

        // --- Media & Location Logic ---
        async function handleMediaUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            const mediaId = `media-${Date.now()}`;
            state.mediaFiles.push({ id: mediaId, type, file, name: file.name });
            renderMediaPreviews();
            
            const btn = document.getElementById('send-request-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loader-small"></div> <span>מעלה קובץ...</span>';
            
            try {
                const storageRef = ref(storage, `site_requests/${state.currentProject.id}/${currentUserId}/${file.name}`);
                const snapshot = await uploadBytes(storageRef, file);
                const url = await getDownloadURL(snapshot.ref);
                
                // עדכון הקובץ במערך המדיה עם ה-URL
                const mediaItem = state.mediaFiles.find(m => m.id === mediaId);
                mediaItem.url = url;
                delete mediaItem.file; // הסר את אובייקט הקובץ
                
                showToast("קובץ הועלה בהצלחה");
            } catch (error) {
                console.error("Media upload failed:", error);
                showToast(`שגיאה בהעלאת ${type}`, "error");
                // הסר מדיה שנכשלה
                state.mediaFiles = state.mediaFiles.filter(m => m.id !== mediaId);
                renderMediaPreviews();
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-feather="send"></i> <span>שלח לאישור יוסי</span>';
                feather.replace();
            }
        }
        
        function removeMedia(mediaId) {
            state.mediaFiles = state.mediaFiles.filter(m => m.id !== mediaId);
            renderMediaPreviews();
        }

        function renderMediaPreviews() {
            const container = document.getElementById('media-preview-container');
            container.innerHTML = state.mediaFiles.map(media => `
                <div class="media-preview">
                    <div class="media-icon">
                        ${media.type === 'image' ? '<i data-feather="image" class="w-6 h-6 text-light"></i>' : ''}
                        ${media.type === 'audio' ? '<i data-feather="mic" class="w-6 h-6 text-light"></i>' : ''}
                        ${media.type === 'location' ? '<i data-feather="map-pin" class="w-6 h-6 text-light"></i>' : ''}
                    </div>
                    <div class="remove-media" onclick="removeMedia('${media.id}')">
                        <i data-feather="x" class="w-4 h-4"></i>
                    </div>
                </div>
            `).join('');
            feather.replace();
        }

        function sendLocation() {
            if (!navigator.geolocation) {
                showToast("GPS לא נתמך בדפדפן זה", "error");
                return;
            }
            showToast("מנסה לקבל מיקום GPS...", "info");
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    const mediaId = `media-${Date.now()}`;
                    state.mediaFiles.push({
                        id: mediaId,
                        type: 'location',
                        url: `https://www.google.com/maps?q=${latitude},${longitude}`,
                        address: `מיקום GPS: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`
                    });
                    renderMediaPreviews();
                    showToast("מיקום GPS נשמר", "success");
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    showToast("שגיאה בקבלת מיקום GPS", "error");
                },
                { enableHighAccuracy: true }
            );
        }

        // --- Send Request ---
        async function sendRequest() {
            const btn = document.getElementById('send-request-btn');
            const submitterName = document.getElementById('submitter-name-input').value.trim();
            const rawText = document.getElementById('raw-text-input').value.trim();
            
            if (!submitterName) {
                showToast("חובה להזין שם מנהל אתר", "error");
                return;
            }
            if (!state.currentProject) {
                showToast("שגיאה: לא נטען פרויקט. רענן את הדף.", "error");
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<div class="loader-small"></div> <span>שולח בקשה...</span>';

            const locationItem = state.mediaFiles.find(m => m.type === 'location');
            
            const payload = {
                client_id: CLIENT_ID,
                project_id: state.currentProject.id,
                project_name: state.currentProject.name,
                site_manager_uid: currentUserId,
                submitter_name: submitterName,
                timestamp: serverTimestamp(),
                status: "pending",
                raw_text: rawText,
                cart_items: state.requestCart,
                media_files: state.mediaFiles.map(m => ({ type: m.type, url: m.url, name: m.name })),
                location_address: locationItem ? locationItem.address : (document.getElementById('order-location')?.value || state.currentProject.address)
            };

            try {
                await addDoc(collection(db, "pending_orders"), payload);
                showToast("הבקשה נשלחה לאישור יוסי!", "success");
                resetNewRequestForm();
                await loadOrderHistory(); // טען מחדש היסטוריה
                navigate('history'); // עבור להצגת ההיסטוריה
            } catch (error) {
                console.error("Failed to send request:", error);
                showToast("שגיאה בשליחת הבקשה", "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-feather="send"></i> <span>שלח לאישור יוסי</span>';
                feather.replace();
            }
        }
        
        function resetNewRequestForm() {
            document.getElementById('raw-text-input').value = '';
            state.requestCart = [];
            state.mediaFiles = [];
            renderRequestCart();
            renderMediaPreviews();
        }

        // --- History Page ---
        function renderHistoryPage() {
            const container = document.getElementById('history-list-container');
            if (state.orderHistory.length === 0) {
                container.innerHTML = '<p class="text-light text-center p-4">אין היסטוריית בקשות או הזמנות.</p>';
                return;
            }
            
            container.innerHTML = state.orderHistory.map(order => {
                const status = order.status || 'לא ידוע';
                let statusClass = 'status-pending';
                let statusText = 'ממתין לאישור';
                
                if (status === 'approved' || status === 'חדש') {
                    statusClass = 'status-approved';
                    statusText = 'אושר (בטיפול)';
                } else if (status === 'בדרך') {
                    statusClass = 'status-onway';
                    statusText = 'בדרך אליך';
                } else if (status === 'rejected') {
                    statusClass = 'status-rejected';
                    statusText = 'נדחה';
                }

                return `
                    <div class="list-item-card">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold">${order.project_name}</h4>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <p class="text-sm text-dark truncate">
                            ${order.raw_text || (order.cart_items && order.cart_items.length > 0 ? order.cart_items.map(i => `${i.quantity}x ${i.name}`).join(', ') : 'בקשה ריקה')}
                        </p>
                        <p class="text-xs text-light mt-2">${new Date((order.timestamp || order.createdAt)?.toDate()).toLocaleString('he-IL')}</p>
                    </div>
                `;
            }).join('');
        }

        // --- Utils ---
        function showToast(message, type = "info") {
            const container = document.getElementById("global-alert-container");
            const alertBox = document.createElement("div");
            alertBox.className = `global-alert ${type === 'error' ? 'alert-error' : (type === 'success' ? 'alert-success' : 'alert-info')}`;
            
            const icon = (type === "error") ? "alert-triangle" : (type === 'success' ? 'check-circle' : 'info');
            alertBox.innerHTML = `<i data-feather="${icon}" class="w-5 h-5"></i><span>${message}</span>`;
            
            container.appendChild(alertBox);
            feather.replace();
            
            setTimeout(() => {
                alertBox.style.opacity = '0';
                alertBox.style.transform = 'translateY(20px)';
                setTimeout(() => alertBox.remove(), 300);
            }, 3000);
        }
    </script>

</body>
</html>
