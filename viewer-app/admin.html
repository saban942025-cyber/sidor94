<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v32.5 (Eco+)</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/feather-icons"></script>

    <script type="module">
        // ×™×© ×œ×”×—×œ×™×£ ×‘×¤×¨×˜×™ ×”×”×’×“×¨×•×ª ×©×œ ×”×¤×¨×•×™×§×˜ ×©×œ×›×
        const fallbackConfig = {
            apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
            authDomain: "saban94-76543.firebaseapp.com", 
            projectId: "saban94-76543",
            storageBucket: "saban94-76543.appspot.com", 
            messagingSenderId: "41553157903", 
            appId: "1:41553157903:web:cc33d252cff023be97a87a", 
            measurementId: "G-XV6RZDESSB"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            query, 
            where, 
            onSnapshot, 
            addDoc, 
            updateDoc, 
            serverTimestamp, 
            arrayUnion,
            getDocs // × ×“×¨×© ×œ×¢×“×›×•×Ÿ ×”×–×× ×•×ª ×›×©×œ×§×•×— ××©×ª× ×”
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.db = db;
        window.serverTimestamp = serverTimestamp;
        window.arrayUnion = arrayUnion;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.collection = collection;
        window.doc = doc;
        window.query = query;
        window.where = where;
        window.onSnapshot = onSnapshot;
        window.getDocs = getDocs;

        // ... ×œ×•×’×™×§×ª ××™××•×ª ×•-Listeners ×›×¤×™ ×©× ×¨××ª×” ×‘×œ×•×’
        signInAnonymously(auth).then(() => {
            console.log("[Init.Auth] INFO: Auth successful. User: ...");
            // ×›××Ÿ ×§×•×¨××™× ×œ×¤×•× ×§×¦×™×•×ª ×”-Listen
        }).catch(error => {
            console.error("[Init.Auth] ERROR: Auth failed.", error);
        });

        // ×™×¦×™×¨×ª SmartLog ×•-Toast ×¤×©×•×˜×™× ×œ×“×•×’××”
        window.SmartLog = {
            info: (msg, source, data) => console.log(`[${source}] INFO: ${msg}`, data || ''),
            error: (msg, source, data) => console.error(`[${source}] ERROR: ${msg}`, data || '')
        };
        window.showToast = (msg, type) => console.log(`[Toast ${type.toUpperCase()}]: ${msg}`);


        // =======================================================
        // ğŸš¨ ×”×ª×™×§×•×Ÿ ×”× ×“×¨×© × ××¦× ×›××Ÿ, ×‘×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×”×–×× ×”
        // =======================================================

        /**
         * CRUD.Order.Create: ×™×•×¦×¨ ×”×–×× ×” ×—×“×©×” ×•××¢×“×›×Ÿ ××ª ××¡××š ×”×œ×§×•×—.
         * ×”×¤×•× ×§×¦×™×” ×©×©× × ×¨×©××” ×”×©×’×™××” ×”××§×•×¨×™×ª.
         * @param {string} customerId - ××–×”×” ×”×œ×§×•×—.
         * @param {object} orderDetails - ×¤×¨×˜×™ ×”×”×–×× ×”.
         */
        async function handleCreateNewOrder(customerId, orderDetails) {
            const customerRef = doc(db, "customers", customerId);
            const ordersCollection = collection(db, "orders");

            SmartLog.info("Starting new order creation", "CRUD.Order.Create", { customerId });

            try {
                // 1. ×™×¦×™×¨×ª ××¡××š ×”×”×–×× ×” ×”×—×“×©
                const newOrderData = {
                    ...orderDetails,
                    status: "×—×“×©",
                    createdAt: serverTimestamp(), // ×©×™××•×© ×ª×§×™×Ÿ: ×©×“×” ×‘×¨××” ×”×¢×œ×™×•× ×”
                    lastModified: serverTimestamp() // ×©×™××•×© ×ª×§×™×Ÿ: ×©×“×” ×‘×¨××” ×”×¢×œ×™×•× ×”
                };

                const newOrderRef = await addDoc(ordersCollection, newOrderData);
                const newOrderId = newOrderRef.id;

                SmartLog.info(`Order document created: ${newOrderId}`, "CRUD.Order.Create");

                // 2. ×¢×“×›×•×Ÿ ××¡××š ×”×œ×§×•×— (×”×—×œ×§ ×©×’×¨× ×œ×©×’×™××”)
                
                // ×”×ª×™×§×•×Ÿ ××ª×‘×¦×¢ ×‘×ª×•×š ×”××•×‘×™×™×§×˜ ×”××•×¢×‘×¨ ×œ-arrayUnion
                const orderRecordForCustomerHistory = {
                    id: newOrderId,
                    // âœ… ×”×ª×™×§×•×Ÿ: ×©×™××•×© ×‘-new Date() ×‘××§×•× serverTimestamp() ×›×“×™ ×œ×”×™×× ×¢ ××”×©×’×™××” ×‘×ª×•×š ×”××¢×¨×š
                    addedAt: new Date(), 
                    status: "×—×“×©",
                    amount: orderDetails.amount || 0 // ×“×•×’××” ×œ×©×“×•×ª × ×•×¡×¤×™×
                };
                
                await updateDoc(customerRef, {
                    lastOrderAdded: serverTimestamp(), // ×©×“×” ×‘×¨××” ×”×¢×œ×™×•× ×” (×ª×§×™×Ÿ)
                    ordersHistory: arrayUnion(orderRecordForCustomerHistory) // ×©×™××•×© ×‘×¢×¨×š ×”××ª×•×§×Ÿ
                });

                SmartLog.info(`Customer ${customerId} updated with new order ${newOrderId}`, "CRUD.Order.Create.CustomerUpdate");
                showToast('×”×–×× ×” ×—×“×©×” × ×•×¦×¨×” ×‘×”×¦×œ×—×”', 'success');
                
                return newOrderId;

            } catch (error) {
                // [CRUD.Order.Create] ERROR: ... serverTimestamp() is not currently supported inside arrays ...
                SmartLog.error(error, "CRUD.Order.Create", { customerId });
                showToast(`×©×’×™××” ×‘×”×•×¡×¤×ª ×”×–×× ×” ×—×“×©×”: ${error.message}`, 'error');
                throw error;
            }
        }

        window.handleCreateNewOrder = handleCreateNewOrder;

        // =======================================================
        // ×¤×•× ×§×¦×™×•×ª × ×•×¡×¤×•×ª ××”×§×•×“ ×©×©×œ×—×ª (×¢×“×›×•×Ÿ ×”×–×× ×” ×§×™×™××ª)
        // =======================================================

        // ... ×¤×•× ×§×¦×™×™×ª handleSaveContainerOrder ××”×¡× ×™×¤×˜ ×”×§×•×“× (×¢×“×›×•×Ÿ ×”×–×× ×”)
        async function handleSaveContainerOrder(orderId, orderData, customerRef, updatedData) {
             // ... ×œ×•×’×™×§×ª ×‘×“×™×§×•×ª ×ª××¨×™×š ×•×›×•'...
             
             // updatedData ×›×‘×¨ ×”×•×¦×’ ×•×›×œ×œ:
             // lastModified: serverTimestamp()
             
             // ×”×§×•×“ ×©×”×¦×’×ª:
             const updatedDataSave = {
                // ... ×©×“×•×ª ×”×–×× ×”
                lastModified: serverTimestamp() // ×ª×§×™×Ÿ ×œ×—×œ×•×˜×™×Ÿ
             };

             // ×“×•×’××” ×œ×©×™××•×© ×‘×§×•×“ ×©×”×•×¦×’:
             // await updateDoc(doc(db, "orders", orderId), updatedDataSave);

             // ... ×”××©×š ×”×§×•×“...
        }
        window.handleSaveContainerOrder = handleSaveContainerOrder;


        // ... ×¤×•× ×§×¦×™×™×ª ×¢×“×›×•×Ÿ ×œ×§×•×— ×•×¢×“×›×•×Ÿ ×”×–×× ×•×ª ×¤×¢×™×œ×•×ª ××”×¡× ×™×¤×˜ ×”××—×¨×•×Ÿ
        // × × ×™×— ×©×–×• ×¤×•× ×§×¦×™×” ×”× ×§×¨××ª 'handleUpdateCustomerAndOrders'
        async function handleUpdateCustomerAndOrders(customerId, changes, updatedData, addressChanged, originalAddress, newAddress, newCoords) {
             const customerRef = doc(db, "customers", customerId);
             
             // 1. ×¢×“×›×•×Ÿ ××¡××š ×”×œ×§×•×—
             if (Object.keys(changes).length > 0) {
                 await updateDoc(customerRef, updatedData);
                 SmartLog.info("Customer updated with audit log", "CRUD.Customer", { id: customerId, changes: Object.keys(changes) });
                 showToast('×¤×¨×˜×™ ×œ×§×•×— ×¢×•×“×›× ×•', 'success');
             } else {
                 SmartLog.info("No changes detected for customer update", "CRUD.Customer", { id: customerId });
                 showToast('×œ× ×–×•×”×• ×©×™× ×•×™×™× ×œ×©××™×¨×”', 'info');
             }
             
             // 2. ×¢×“×›×•×Ÿ ×”×–×× ×•×ª ×¤×¢×™×œ×•×ª
             if (addressChanged) {
                 SmartLog.info(`Address changed for ${customerId}. Checking active orders...`, "CRUD.Order.UpdateOnCustChange");
                 const q = query(collection(db, "orders"),
                     where("customer.id", "==", customerId),
                     where("status", "in", ["×—×“×©", "×©×•×™×š", "×‘×“×¨×š"]),
                     where("address", "==", originalAddress) 
                 );
                 
                 try {
                     const querySnapshot = await getDocs(q);
                     let updatedCount = 0;
                     // ×‘××§×•× ××¢×¨×š ×©×œ Promise-×™×, × ×©×ª××© ×‘-Batch (××•××œ×¥) ××• ×‘-Promise.all
                     const updatePromises = []; // ×©×™××•×© ×‘-Promise.all
                     
                     querySnapshot.forEach(orderDoc => {
                         const orderUpdateData = {
                             address: newAddress,
                             "customer.name": updatedData.name, 
                             "customer.phone": updatedData.phone
                         };
                         if (newCoords) { 
                             orderUpdateData.latitude = newCoords[0];
                             orderUpdateData.longitude = newCoords[1];
                         }
                         // ×“×•×—×£ ××ª ×”-Promise ×œ××¢×¨×š
                         updatePromises.push(updateDoc(doc(db, "orders", orderDoc.id), orderUpdateData));
                         updatedCount++;
                     });
                     
                     // ××‘×¦×¢ ××ª ×›×œ ×”×¢×“×›×•× ×™× ×‘××§×‘×™×œ
                     await Promise.all(updatePromises); 
                     SmartLog.info(`Updated ${updatedCount} active orders with new address.`, "CRUD.Order.UpdateOnCustChange");
                     showToast(`×¢×•×“×›× ×• ${updatedCount} ×”×–×× ×•×ª ×¤×¢×™×œ×•×ª ×‘×›×ª×•×‘×ª ×”×—×“×©×”`, 'info');
                     
                 } catch (e) {
                     SmartLog.error(e, "CRUD.Order.UpdateOnCustChange", { customerId });
                     showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×–×× ×•×ª ×¤×¢×™×œ×•×ª', 'error');
                 }
             }
        }
        window.handleUpdateCustomerAndOrders = handleUpdateCustomerAndOrders;


    </script>
</head>
<body>
    <main>
        <button onclick="window.handleCreateNewOrder('KCXmenIeABybNVatNUbN', { customer: { id: 'KCXmenIeABybNVatNUbN', name: '×œ×§×•×— ×‘×“×™×§×”' }, amount: 100, deliveryType: '×¨×’×™×œ' })">
            ×¦×•×¨ ×”×–×× ×” ×—×“×©×” (×‘×“×™×§×”)
        </button>
    </main>
    
    <style>
        /* ... ×¡×’× ×•× ×•×ª ×”-CSS ×©×œ×›× ... */
    </style>
    
    <script>
        // ×§×•×“ JavaScript ×©××™× ×• ××•×“×•×œ (×œ×“×•×’××”, ×§×¨×™××” ×œ-feather-icons)
        feather.replace();
    </script>
</body>
</html>
