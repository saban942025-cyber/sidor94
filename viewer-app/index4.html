<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DeliveryMaster Viewer v50.11 (Chat)</title>
    <!-- 
      DeliveryMaster Live Viewer App v50.11 (Chat)
      
      Changelog:
      - v50.11 (חדש):
        - נוסף כפתור "הודעות" לסרגל הניווט התחתון.
        - נוסף חיווי (Badge) על הכפתור עבור הודעות חדשות.
        - נוסף דף "fullpage-messages" המציג רשימת הזמנות עם הודעות שלא נקראו.
        - נוסף מודל צ'אט מלא (`openChatModal`) המאפשר צפייה בהיסטוריה ושליחת תגובות.
        - פונקציות (`listenToUnreadMessages`, `updateMessagesAsRead`, `sendAdminReply`) הותאמו מקבצי מנהל אחרים.
    -->
    
    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/ryPT3r29/image.png">
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LeafletJS (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Chart.js (NEW for Reports) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- Tone.js for Sound -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
            --text-dark: #1f2937; /* gray-800 */
            --text-light: #6b7280; /* gray-500 */
             --color-manof-bg: #e0f2fe; /* sky-100 */
             --color-masait-bg: #dcfce7; /* green-100 */
             --color-isuf-bg: #f3f4f6;   /* gray-100 */
             --color-future-bg: #f9fafb; /* gray-50 */
             --bottom-nav-height: 65px;
        }
        html, body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', 'Arial', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
             padding-bottom: var(--bottom-nav-height);
        }
        
        /* Main Layout */
        .viewer-layout { display: flex; flex-direction: column; height: 100vh; width: 100%; }
        header { flex-shrink: 0; }
        #viewer-counters {
            flex-shrink: 0;
            background-color: #e5e7eb;
            padding: 0.5rem 1rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .counter-item {
            display: flex; align-items: center; gap: 0.5rem; font-weight: 500;
             color: var(--text-dark); background-color: var(--bg-white);
             padding: 0.25rem 0.75rem; border-radius: 99px; font-size: 0.8rem;
             cursor: pointer; transition: background-color 0.2s;
        }
        .counter-item:hover { background-color: #e5e7eb; }
         .counter-item .count {
             font-weight: 700; color: var(--primary-dark);
             min-width: 1.25rem; text-align: center;
         }

        /* Main Content Layout */
        #viewer-main-content {
            display: grid; grid-template-columns: 1fr 350px; grid-template-rows: 1fr;
            flex-grow: 1; overflow: hidden; height: calc(100% - var(--bottom-nav-height));
        }
        #viewer-map-container { position: relative; background-color: #e0e0e0; grid-row: 1; grid-column: 1; }
        #viewer-map { height: 100%; width: 100%; }
        #viewer-side-panel {
            grid-row: 1; grid-column: 2; background-color: var(--bg-white);
            border-right: 1px solid var(--border-color); display: flex;
            flex-direction: column; height: 100%; overflow: hidden;
        }
        
        @media (max-width: 768px) {
            #viewer-main-content { grid-template-columns: 1fr; grid-template-rows: 35% 1fr; }
            #viewer-map-container { grid-row: 1; grid-column: 1; }
            #viewer-side-panel { grid-row: 2; grid-column: 1; border-right: none; border-top: 1px solid var(--border-color); }
        }
        
        #viewer-side-panel .search-container { padding: 0.75rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .panel-list-container { flex: 1; overflow-y: auto; position: relative; }
        .panel-list { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; display: none; }
        .panel-list.active { display: block; }
        
        .order-card {
            padding: 1rem; border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s; cursor: pointer;
        }
        .order-card:hover { background-color: #fafafa; }
         .order-card.active { background-color: #eff6ff; border-right: 3px solid var(--primary-color); }
        .order-card-header-center { text-align: center; margin-bottom: 0.5rem; }
        .order-card-header-center .order-id { font-weight: 700; font-size: 1.1rem; color: var(--primary-dark); display: block; }
        .order-card-header-center .customer-name { font-weight: 600; font-size: 1rem; color: var(--text-dark); display: block; }
        .order-card-details {
            font-size: 0.875rem; color: var(--text-light); display: flex;
            flex-direction: column; gap: 0.25rem; margin-top: 0.75rem;
        }
        .order-card-details div { display: flex; align-items: center; gap: 0.5rem; }

        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { margin: 13px 20px; font-family: 'Inter', sans-serif; }
        .leaflet-popup-content h4 { font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; }
        .leaflet-popup-content p { margin: 4px 0; color: var(--text-light); }
        
        .loader-container {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.7); display: flex;
            align-items: center; justify-content: center; z-index: 10;
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

         #connection-status {
             font-size: 0.8rem; font-weight: 500; padding: 4px 8px;
             border-radius: 99px; display: inline-flex; align-items: center; gap: 4px;
         }
         #connection-status.connected { background-color: #dcfce7; color: #166534; }
         #connection-status.connecting { background-color: #fef9c3; color: #854d0e; }
         #connection-status.error { background-color: #fee2e2; color: #991b1b; }
         #connection-status .dot { width: 6px; height: 6px; border-radius: 50%; }
         #connection-status.connected .dot { background-color: #22c55e; }
         #connection-status.connecting .dot { background-color: #facc15; }
         #connection-status.error .dot { background-color: #ef4444; }
         
        #toast-container {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%); z-index: 5000; display: flex; flex-direction: column; gap: 8px;
        }
        .toast {
            padding: 12px 20px; background-color: var(--text-dark); color: white;
            border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0; transform: translateY(20px); transition: all 0.3s ease;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: #22c55e; }
        .toast.error { background-color: #ef4444; }
        .toast.ping { background-color: var(--primary-color); }

        /* Full Page Views */
        .full-page-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 1000; overflow-y: auto;
            transform: translateX(100%); transition: transform 0.3s ease;
            padding-bottom: var(--bottom-nav-height);
        }
        .full-page-view.active { transform: translateX(0); }
        .full-page-header {
            position: sticky; top: 0; background: white; border-bottom: 1px solid var(--border-color);
            padding: 1rem; display: flex; align-items: center; gap: 1rem; z-index: 10;
        }
        .full-page-content { padding: 1rem; }
        .enhanced-order-card {
            padding: 1rem; border-bottom: 1px solid var(--border-color); background: white;
            transition: all 0.2s ease; cursor: pointer;
        }
        .enhanced-order-card:last-child { border-bottom: none; }
        .enhanced-order-card:hover { background: #f8fafc; }
        .order-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .order-main-info { flex: 1; }
        .order-meta { display: flex; gap: 1rem; font-size: 0.875rem; color: var(--text-light); margin-top: 0.5rem; flex-wrap: wrap; }
        .order-badge {
            padding: 0.25rem 0.75rem; border-radius: 99px; font-size: 0.75rem;
            font-weight: 600; background: var(--bg-light);
        }
        .badge-status-new { background: #dbeafe; color: #1e40af; }
        .badge-status-assigned { background: #fef3c7; color: #92400e; }
        .badge-status-onway { background: #dcfce7; color: #166534; }
        .badge-status-completed { background: #f3f4f6; color: #374151; }
        .tomorrow-orders-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .delivery-type-section { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .delivery-type-header {
            padding: 1rem; font-weight: 700; color: white;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .delivery-type-manof { background: linear-gradient(135deg, #0ea5e9, #0369a1); }
        .delivery-type-masait { background: linear-gradient(135deg, #10b981, #047857); }
        .delivery-type-isuf { background: linear-gradient(135deg, #6b7280, #374151); }
        .nav-button {
            background: var(--primary-color); color: white; border: none; padding: 0.75rem 1rem;
            border-radius: 8px; font-weight: 600; cursor: pointer; transition: background 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.875rem;
        }
        .nav-button:hover { background: var(--primary-dark); }
        .nav-button.secondary { background: var(--bg-light); color: var(--text-dark); }
        .nav-button.secondary:hover { background: #e5e7eb; }
        
        .rental-progress-bar { background-color: var(--border-color); border-radius: 99px; height: 10px; overflow: hidden; margin-top: 0.75rem; }
        .rental-progress-bar .progress { background-color: var(--primary-color); height: 100%; transition: width 0.3s ease; }
        .rental-days { font-size: 0.875rem; font-weight: 600; color: var(--text-light); text-align: center; margin-top: 0.25rem; }
        .overtime-flash { color: #ef4444; animation: gentle-flash 1.5s infinite; }
        @keyframes gentle-flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        
        /* Fixed Bottom Nav */
        #bottom-nav-bar {
            position: fixed; bottom: 0; left: 0; right: 0; height: var(--bottom-nav-height);
            background-color: var(--bg-white); border-top: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-around;
            z-index: 100; padding: 0 0.5rem; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .bottom-nav-button {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            justify-content: center; color: var(--text-light); font-weight: 500;
            font-size: 0.75rem; border: none; background: none; cursor: pointer;
            padding: 0.5rem 0; border-radius: 8px; transition: all 0.2s ease; height: 100%;
            position: relative; /* חדש: עבור החיווי */
        }
        .bottom-nav-button i { width: 24px; height: 24px; margin-bottom: 2px; }
        .bottom-nav-button:hover { background-color: var(--bg-light); color: var(--primary-color); }
        
        /* חיווי הודעה חדשה (חדש) */
        .nav-badge {
            position: absolute;
            top: 4px;
            right: 20px; /* התאם לפי הצורך */
            width: 10px;
            height: 10px;
            background-color: #ef4444; /* red-500 */
            border-radius: 50%;
            border: 2px solid white;
            display: none; /* מוסתר כברירת מחדל */
        }
        .nav-badge.active {
            display: block;
        }


        /* Reports Page Styling */
        .report-filter-bar { display: flex; flex-wrap: wrap; gap: 1rem; padding: 1rem; background: var(--bg-light); border-radius: 8px; margin-bottom: 1.5rem; align-items: center; }
        .report-filter-bar label { font-weight: 500; }
        .report-filter-bar input { padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; }
        .report-section { background: var(--bg-white); border-radius: 8px; border: 1px solid var(--border-color); padding: 1rem; margin-bottom: 1.5rem; }
        .report-section h3 { font-size: 1.25rem; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .customer-list-item { padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); font-weight: 500; }
        .customer-list-item:last-child { border-bottom: none; }

        /* סגנונות חדשים לצ'אט במודל */
        .chat-bubble {
            max-width: 80%; padding: 0.75rem 1rem; border-radius: 1rem;
            margin-bottom: 0.5rem; word-wrap: break-word;
        }
        .chat-bubble-admin { /* הודעה מהמנהל */
            background-color: #e2e8f0; color: #1e293b;
            border-bottom-left-radius: 0.25rem; align-self: flex-start;
        }
        .chat-bubble-customer { /* הודעה מהלקוח */
            background-color: #2563eb; color: white;
            border-bottom-right-radius: 0.25rem; align-self: flex-end;
        }
        .chat-timestamp { font-size: 0.7rem; color: #9ca3af; margin-top: 0.25rem; }
        .chat-bubble-customer .chat-timestamp { color: #dbeafe; }
        .chat-input-area {
            position: sticky; bottom: 0; background: white;
            padding: 1rem; border-top: 1px solid var(--border-color);
        }

        @media (max-width: 768px) {
            .order-card-details { font-size: 0.8rem; }
            .report-filter-bar { flex-direction: column; align-items: stretch; }
            .report-filter-bar .nav-button { width: 100%; }
        }

    </style>
</head>
<body class="antialiased">

    <div class="viewer-layout">
        <header class="bg-white shadow-sm p-4 flex justify-between items-center">
             <div class="flex items-center space-x-2 space-x-reverse">
                 <i data-feather="truck" class="w-7 h-7 text-blue-500"></i>
                 <h1 class="text-xl font-bold">DeliveryMaster Viewer</h1>
             </div>
             <div id="connection-status" class="connecting">
                 <span class="dot"></span>
                 <span>מתחבר...</span>
             </div>
        </header>
        
        <div id="viewer-counters">
             <div class="counter-item" onclick="showActiveListPage()">
                 🔄
                 <span>בסידור:</span>
                 <span id="count-active" class="count">-</span>
             </div>
             <div class="counter-item" onclick="showCompletedTodayListPage()">
                 ✅
                 <span>סופקו היום:</span>
                 <span id="count-completed-today" class="count">-</span>
             </div>
             <div class="counter-item" onclick="showFutureListPage()">
                 📅
                 <span>צפי עתידי:</span>
                 <span id="count-future" class="count">-</span>
             </div>
        </div>

        <!-- Main Content (Map + Side Panel) -->
        <main id="viewer-main-content">
            <div id="viewer-map-container">
                <div id="viewer-map"></div>
                <div id="viewer-map-loader" class="loader-container">
                    <div class="loader"></div>
                    <span class="ml-4 font-semibold">טוען מפה ונתונים...</span>
                </div>
            </div>

            <aside id="viewer-side-panel">
                <div class="search-container">
                    <input type="text" id="viewer-search-input" placeholder="חפש הזמנה, לקוח, כתובת או מחסן..." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300" onkeyup="filterViewerLists()">
                </div>
                
                <div class="panel-list-container">
                    <div id="viewer-orders-active-list" class="panel-list active" style="display:block;">
                        <div class="loader-container"><div class="loader"></div></div>
                    </div>
                </div>
            </aside>
        </main>

        <!-- Fixed Bottom Nav Bar (עם כפתור הודעות) -->
        <nav id="bottom-nav-bar">
            <button class="bottom-nav-button" onclick="showMaterialsPage()">
                <i data-feather="package"></i>
                <span>חומרי בנין</span>
            </button>
            <button class="bottom-nav-button" onclick="showContainersPage()">
                <i data-feather="archive"></i>
                <span>מכולות</span>
            </button>
            <!-- כפתור הודעות חדש -->
            <button class="bottom-nav-button" onclick="showMessagesPage()">
                <i data-feather="message-square"></i>
                <span>הודעות</span>
                <span id="message-alert-badge" class="nav-badge"></span>
            </button>
            <button class="bottom-nav-button" onclick="showReportsPage()">
                <i data-feather="bar-chart-2"></i>
                <span>דוחות</span>
            </button>
        </nav>
    </div>

     <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Full Page Views (כולל דף הודעות ומודל צ'אט) -->

    <!-- Full Page View: חומרי בנין -->
    <div id="fullpage-materials" class="full-page-view">
        <div class="full-page-header">
            <button class="nav-button secondary" onclick="hideFullPageView('materials')">
                <i data-feather="arrow-right"></i> חזרה
            </button>
            <h2 class="text-xl font-bold">חומרי בנין (החרש, התלמיד)</h2>
        </div>
        <div class="full-page-content">
            <div id="materials-orders-container">
                <div class="loader-container"><div class="loader"></div></div>
            </div>
        </div>
    </div>

    <!-- Full Page View: מכולות -->
    <div id="fullpage-containers" class="full-page-view">
        <div class="full-page-header">
            <button class="nav-button secondary" onclick="hideFullPageView('containers')">
                <i data-feather="arrow-right"></i> חזרה
            </button>
            <h2 class="text-xl font-bold">מכולות (30, 32, 40)</h2>
        </div>
        <div class="full-page-content">
            <div id="containers-orders-container" class="tomorrow-orders-grid">
                <div class="loader-container"><div class="loader"></div></div>
            </div>
        </div>
    </div>
    
    <!-- Full Page View: דוחות -->
    <div id="fullpage-reports" class="full-page-view">
        <div class="full-page-header">
            <button class="nav-button secondary" onclick="hideFullPageView('reports')">
                <i data-feather="arrow-right"></i> חזרה
            </button>
            <h2 class="text-xl font-bold">דוחות וניתוחים</h2>
        </div>
        <div class="full-page-content">
            <!-- Filter Bar -->
            <div class="report-filter-bar">
                <label for="report-date-start">מתאריך:</label>
                <input type="date" id="report-date-start">
                <label for="report-date-end">עד תאריך:</label>
                <input type="date" id="report-date-end">
                <button class="nav-button" onclick="renderReports()">
                    <i data-feather="filter"></i> סנן
                </button>
            </div>
            
            <div id="reports-content-container">
                <!-- Charts & Lists -->
            </div>
        </div>
    </div>
    
    <!-- Full Page View: Active List (From Counter) -->
    <div id="fullpage-list-active" class="full-page-view">
        <div class="full-page-header">
            <button class="nav-button secondary" onclick="hideFullPageView('list-active')">
                <i data-feather="arrow-right"></i> חזרה
            </button>
            <h2 class="text-xl font-bold">הזמנות בסידור</h2>
        </div>
        <div class="full-page-content" id="list-active-container"></div>
    </div>
    
    <!-- Full Page View: Completed Today List (From Counter) -->
    <div id="fullpage-list-completed-today" class="full-page-view">
        <div class="full-page-header">
            <button class="nav-button secondary" onclick="hideFullPageView('list-completed-today')">
                <i data-feather="arrow-right"></i> חזרה
            </button>
            <h2 class="text-xl font-bold">הזמנות שסופקו היום</h2>
        </div>
        <div class="full-page-content" id="list-completed-today-container"></div>
    </div>
    
    <!-- Full Page View: Future List (From Counter) -->
    <div id="fullpage-list-future" class="full-page-view">
        <div class="full-page-header">
            <button class="nav-button secondary" onclick="hideFullPageView('list-future')">
                <i data-feather="arrow-right"></i> חזרה
            </button>
            <h2 class="text-xl font-bold">צפי הזמנות עתידי</h2>
        </div>
        <div class="full-page-content" id="list-future-container"></div>
    </div>

    <!-- ********** דפים חדשים ********** -->

    <!-- Full Page View: רשימת הודעות -->
    <div id="fullpage-messages" class="full-page-view">
        <div class="full-page-header">
            <button class="nav-button secondary" onclick="hideFullPageView('messages')">
                <i data-feather="arrow-right"></i> חזרה
            </button>
            <h2 class="text-xl font-bold">הודעות מלקוחות</h2>
        </div>
        <div class="full-page-content">
            <p class="text-sm text-gray-600 mb-4">מוצגות רק הזמנות עם הודעות חדשות שלא נקראו.</p>
            <div id="message-list-container" class="space-y-3">
                <div class="loader-container"><div class="loader"></div></div>
            </div>
        </div>
    </div>

    <!-- Full Page View: מודל צ'אט (שימוש חוזר בדף קיים) -->
    <div id="fullpage-chat-modal" class="full-page-view flex flex-col">
        <div class="full-page-header">
            <button class="nav-button secondary" onclick="hideFullPageView('chat-modal')">
                <i data-feather="arrow-right"></i> חזרה
            </button>
            <h2 id="chat-modal-title" class="text-xl font-bold">שיחה עם לקוח</h2>
        </div>
        <!-- גוף המודל (גולל) -->
        <div class="full-page-content flex-1 overflow-y-auto p-4" id="chat-history-modal">
             <div class="loader-container"><div class="loader"></div></div>
            <!-- בועות צ'אט יופיעו כאן -->
        </div>
        <!-- כתיבת הודעה (קבוע בתחתית) -->
        <div class="chat-input-area flex gap-2 p-4">
            <input type="text" id="admin-reply-text" class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="כתוב תגובה או התראה...">
            <button id="admin-reply-button" class="nav-button">
                <i data-feather="send"></i>
            </button>
        </div>
    </div>


    <script type="module">
        // --- Inlined Firebase SDK Imports ---
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, collection, doc, onSnapshot, query, orderBy, addDoc, 
            where, limit, serverTimestamp, collectionGroup, getDocs, writeBatch 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js"; 

        // --- Inlined Config Logic ---
        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", authDomain: "saban94-78949.firebaseapp.com", projectId: "saban94-78949",
          storageBucket: "saban94-78949.firebasestorage.app", messagingSenderId: "41553157903", appId: "1:41553157903:web:cc33d252cff023be97a87a", measurementId: "G-XV6RZDESSB"
        };
        let app, auth, db;
        let initializationError = null;
        try {
            app = getApps().length ? getApp() : initializeApp(firebaseConfig);
            auth = getAuth(app); db = getFirestore(app);
            console.log("Firebase initialized for Viewer");
        } catch (error) { console.error("CRITICAL: Firebase init failed!", error); initializationError = error; }

        const MAX_AUTH_RETRIES = 3; const RETRY_DELAY_MS = 3000;
        async function ensureAuth() {
            console.log("ensureAuth: Starting..."); let tries = 0;
            updateConnectionStatus('connecting', 'מאמת...');
            while (tries < MAX_AUTH_RETRIES) {
                tries++;
                try {
                    if (initializationError) throw new Error(`Init failed: ${initializationError.message}`);
                    if (!auth) throw new Error("Auth object missing");
                    const userCredential = await signInAnonymously(auth);
                    console.log("ensureAuth: Success.", userCredential.user.uid);
                    updateConnectionStatus('connecting', 'מאזין...');
                    return userCredential.user;
                } catch (e) {
                    console.warn(`[FirebaseAuth] Attempt ${tries} failed:`, e.code, e.message);
                    if (tries >= MAX_AUTH_RETRIES) { console.error("ensureAuth: All attempts failed."); throw e; }
                    await new Promise(r => setTimeout(r, RETRY_DELAY_MS));
                }
            } throw new Error("ensureAuth: Max retries reached.");
        }
        const authReadyPromise = ensureAuth();

        // --- Inlined SmartLog Logic ---
        const SmartLog = {
            info: (msg, origin, ctx = {}) => { console.log(`[INFO|${origin}] ${msg}`, ctx); },
            warn: (msg, origin, ctx = {}) => { console.warn(`[WARN|${origin}] ${msg}`, ctx); },
            error: (err, origin, ctx = {}) => { console.error(`[ERROR|${origin}] ${err.message || err}`, ctx, err); }
        };

        // --- CONFIG & STATE ---
        const ISRAEL_CENTER = [32.0853, 34.7818];
        const ACTIVE_ORDER_STATUSES = ["חדש", "שויך", "בדרך"];
        let reportChartWarehouse = null;
        let reportChartTime = null;
        let viewerState = {
            allOrders: [], activeOrders: [], futureOrders: [], completedTodayOrders: [],
            drivers: [], liveLocations: {},
            unreadMessages: new Map() // --- חדש: Map(orderId -> {count, customerName}) ---
        };
        let viewerMap;
        let viewerDriverMarkers = {};
        let viewerOrderMarkers = {};
        let unsubscribeModalChat = null; // --- חדש: מאזין לצ'אט הפתוח ---
        
        // --- Icons & Styling (ללא שינוי) ---
        const driverIconActive = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] });
        const driverIconStuck = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] });
        const orderIconActive = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] });
        const orderTypeDetails = {
            'הובלת מנוף': { icon: '🏗️', className: 'type-manof' },
            'הובלת משאית': { icon: '🚚', className: 'type-masait' },
            'איסוף עצמי': { icon: '👤', className: 'type-isuf' },
            'default': { icon: '📦', className: '' }
        };

        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            try { feather.replace(); } catch (e) { SmartLog.error(e, "Init.Feather"); }
            initializeViewerApplication();
        });
        
        async function initializeViewerApplication() {
            SmartLog.info("v50.11 Viewer: Initializing...", "Init");
            try {
                updateConnectionStatus('connecting', 'מפעיל מפה...');
                initViewerMap();
                showLoader('viewer-orders-active-list', true);
                
                await authReadyPromise; 
                SmartLog.info(`Firebase Auth successful for viewer.`, "Init.Auth");
                
                listenToDriversViewer();
                listenToAllOrdersViewer(); 
                listenToLocationsViewer();
                listenToGlobalPings();
                listenToUnreadMessages(); // --- מאזין חדש להודעות ---
                
                showLoader('viewer-map-loader', false);
                updateConnectionStatus('connected', 'מחובר');
                
            } catch (error) {
                SmartLog.error(error, "Init.Critical", { message: "Viewer initialization failed." });
                updateConnectionStatus('error', `שגיאת אתחול: ${error.message}`);
                 const mapLoader = document.getElementById('viewer-map-loader');
                 if(mapLoader) mapLoader.innerHTML = `<span class="text-red-600">שגיאת אתחול קריטית.</span>`;
                showToast(`שגיאת אתחול: ${error.message}`, 'error');
            }
        }

        function initViewerMap() {
            try {
                const mapContainer = document.getElementById('viewer-map');
                if (!mapContainer) throw new Error("Map container #viewer-map not found");
                 if (viewerMap) { viewerMap.remove(); viewerMap = null; }
                viewerMap = L.map('viewer-map').setView(ISRAEL_CENTER, 9);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OSM' }).addTo(viewerMap);
                SmartLog.info("Viewer Map initialized", "Init.Map");
            } catch (error) {
                SmartLog.error(error, "Init.Map");
                 const mapContainer = document.getElementById('viewer-map');
                 if(mapContainer) mapContainer.innerHTML = `<div class="p-8 text-center text-red-600">שגיאה בטעינת המפה.</div>`;
            }
        }
        
        function updateConnectionStatus(statusClass, message) {
             const el = document.getElementById('connection-status');
             if (el) {
                 el.className = statusClass;
                 const span = el.querySelector('span:last-child');
                 if (span) span.innerText = message;
             }
         }

        // --- FIRESTORE LISTENERS ---
        
        function listenToDriversViewer() {
            SmartLog.info("Listening to Drivers...", "Firestore.Listen");
            const q = query(collection(db, "drivers"), orderBy("name"));
            onSnapshot(q, (snapshot) => {
                viewerState.drivers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderViewerMapMarkers();
            }, e => { SmartLog.error(e, "Firestore.Drivers.Listener"); updateConnectionStatus("error", "שגיאת נהגים"); });
        }
        
        function listenToAllOrdersViewer() {
            SmartLog.info("Listening to ALL Orders...", "Firestore.Listen");
            const q = query(collection(db, "orders"), orderBy("createdAt", "desc")); 
            onSnapshot(q, (snapshot) => {
                SmartLog.info(`All Orders: ${snapshot.docs.length} docs.`, "Firestore.Snapshot");
                viewerState.allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
                const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999);
                
                viewerState.activeOrders = viewerState.allOrders.filter(o => ACTIVE_ORDER_STATUSES.includes(o.status || ''));
                viewerState.futureOrders = viewerState.allOrders.filter(o => {
                    if (!o.orderDate) return false;
                    try { const orderDateObj = new Date(o.orderDate); orderDateObj.setHours(0, 0, 0, 0); return orderDateObj > todayEnd; } 
                    catch (e) { return false; }
                });
                viewerState.completedTodayOrders = viewerState.allOrders.filter(o => {
                     if (o.status !== 'הושלם') return false;
                     const modifiedTime = o.lastModified?.toDate ? o.lastModified.toDate().getTime() : 0;
                     return modifiedTime >= todayStart.getTime() && modifiedTime <= todayEnd.getTime();
                });
                
                renderViewerOrdersList();
                renderViewerMapMarkers();
                updateCounters();
                showLoader('viewer-orders-active-list', false);
            }, e => { SmartLog.error(e, "Firestore.AllOrders.Listener"); updateConnectionStatus("error", "שגיאת הזמנות"); });
        }


        function listenToLocationsViewer() {
             SmartLog.info("Listening to Locations...", "Firestore.Listen");
             const q = query(collection(db, "driverLocations"));
             onSnapshot(q, (snapshot) => {
                const newLocations = {};
                snapshot.forEach(doc => { newLocations[doc.id] = { id: doc.id, ...doc.data() }; });
                viewerState.liveLocations = newLocations;
                renderViewerMapMarkers();
             }, e => { SmartLog.error(e, "Firestore.Locations.Listener"); updateConnectionStatus("error", "שגיאת מיקומים"); });
        }
        
        function listenToGlobalPings() {
             SmartLog.info("Listening for Global Pings...", "Firestore.Listen");
             const since = new Date(Date.now() - 60000); 
             const q = query( collection(db, "globalPings"), where("createdAt", ">", since), orderBy("createdAt", "desc"), limit(1) );
             let initialLoad = true;
             onSnapshot(q, (snapshot) => {
                 if (initialLoad) { initialLoad = false; return; }
                 snapshot.docChanges().forEach(change => {
                     if (change.type === "added") {
                         const ping = change.doc.data();
                         SmartLog.info("Global Ping Received!", "Pings", ping);
                         playNotificationSound('A5', '4n');
                         showToast(`התראה מהמנהל: ${ping.message}`, 'ping');
                     }
                 });
             }, e => { SmartLog.error(e, "Firestore.Pings.Listener"); });
        }
        
        // --- מאזין חדש להודעות שלא נקראו ---
        function listenToUnreadMessages() {
            SmartLog.info("Listening for Unread Messages...", "Firestore.Listen.Messages");
            
            // שאילתה זו דורשת אינדקס כפי שמופיע בתמונה image_1fb01e.png
            // messages -> type (ASC) -> readByViewer (ASC) -> __name__ (ASC)
            const q = query(
                collectionGroup(db, 'messages'),
                where('type', '==', 'message_to_admin'),
                where('readByViewer', '==', false)
            );

            onSnapshot(q, (snapshot) => {
                const newUnreadMap = new Map();
                
                snapshot.forEach(doc => {
                    const message = doc.data();
                    const orderId = doc.ref.parent.parent.id; // קבלת ID ההזמנה
                    
                    if (newUnreadMap.has(orderId)) {
                        newUnreadMap.get(orderId).count++;
                    } else {
                        // נצטרך למצוא את שם הלקוח. ננסה למצוא אותו מההזמנה ב-state
                        const order = viewerState.allOrders.find(o => o.id === orderId);
                        newUnreadMap.set(orderId, {
                            count: 1,
                            customerName: order?.customer?.name || message.senderName || 'לקוח לא ידוע',
                            orderId: orderId // שמירת ה-ID המלא
                        });
                    }
                });

                viewerState.unreadMessages = newUnreadMap;
                updateMessageBadge();
                
                // אם דף ההודעות פתוח, רענן אותו
                if (document.getElementById('fullpage-messages').classList.contains('active')) {
                    renderMessagesPage();
                }

            }, (error) => {
                SmartLog.error(error, "Firestore.Listen.Messages", { msg: "Failed to listen to collectionGroup 'messages'. Check index." });
                showToast("שגיאה בסנכרון הודעות", "error");
            });
        }

        // --- RENDER FUNCTIONS ---
         function updateCounters() {
             const countActiveEl = document.getElementById('count-active');
             const countCompletedEl = document.getElementById('count-completed-today');
             const countFutureEl = document.getElementById('count-future');
             if(countActiveEl) countActiveEl.innerText = viewerState.activeOrders.length;
             if(countCompletedEl) countCompletedEl.innerText = viewerState.completedTodayOrders.length;
             if(countFutureEl) countFutureEl.innerText = viewerState.futureOrders.length;
         }
        
        function renderViewerOrdersList() {
            const list = document.getElementById('viewer-orders-active-list');
            if (!list) return;
            list.innerHTML = '';
            if (viewerState.activeOrders.length === 0) {
                list.innerHTML = `<div class="p-4 text-center text-gray-500">אין הזמנות פעילות כרגע.</div>`;
                return;
            }
            const sortedActiveOrders = [...viewerState.activeOrders].sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
            sortedActiveOrders.forEach(order => { list.appendChild(createViewerOrderCard(order)); });
             filterViewerLists();
             feather.replace();
        }
        
        function createViewerOrderCard(order) {
            const el = document.createElement('div');
            el.className = `order-card`;
            el.id = `viewer-order-card-${order.id}`; 
            el.setAttribute('data-search', `${order.orderNumber || order.id} ${order.customer?.name?.toLowerCase()} ${order.address?.toLowerCase()} ${order.warehouse?.toLowerCase()}`);
            el.onclick = () => focusViewerMapItem(order.id, 'order'); 

            const customerName = order.customer?.name || 'לקוח לא ידוע';
            const address = order.address || 'כתובת לא צוינה';
            const displayId = order.orderNumber || `#${order.id.slice(-6)}`;
            const orderDateForDisplay = order.orderDate ? new Date(order.orderDate).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '...';
            const orderTimeForDisplay = order.orderTime || '...';
            
            el.innerHTML = `
                <div class="order-card-header-center">
                    <span class="order-id">${displayId}</span>
                    <span class="customer-name">${customerName}</span>
                </div>
                <div class="order-card-details mt-4">
                    <div class="flex items-center gap-2 text-gray-700">
                        <i data-feather="map-pin" class="w-4 h-4"></i>
                        <span class="font-medium truncate">${address}</span>
                    </div>
                    <div class="flex items-center gap-2 text-gray-700">
                        <i data-feather="home" class="w-4 h-4"></i>
                        <span class="font-medium">מחסן: ${order.warehouse || '?'}</span>
                    </div>
                </div>
                <div class="mt-3 bg-gray-100 p-3 rounded-lg flex items-center justify-center gap-4 text-gray-800">
                    <div class="flex items-center gap-2">
                        <i data-feather="calendar" class="w-4 h-4 text-primary-dark"></i>
                        <span class="font-semibold">${orderDateForDisplay}</span>
                    </div>
                    <div class="border-l border-gray-300 h-5"></div>
                    <div class="flex items-center gap-2">
                        <i data-feather="clock" class="w-4 h-4 text-primary-dark"></i>
                        <span class="font-semibold">${orderTimeForDisplay}</span>
                    </div>
                </div>
            `;
            return el;
        }
        
        function renderViewerMapMarkers() {
            if (!viewerMap) return;
            const bounds = L.latLngBounds();
            Object.values(viewerState.liveLocations).forEach(driverLoc => {
                if (!driverLoc.latitude || !driverLoc.longitude) return;
                const driverData = viewerState.drivers.find(d => d.id === driverLoc.id);
                const name = driverData?.name || 'נהג לא ידוע';
                const latLng = [driverLoc.latitude, driverLoc.longitude];
                const icon = driverLoc.isStuck ? driverIconStuck : driverIconActive;
                const popupContent = `<h4>${name}</h4><p>${driverLoc.isStuck ? 'תקוע' : 'פעיל'}</p>`;
                if (viewerDriverMarkers[driverLoc.id]) {
                    viewerDriverMarkers[driverLoc.id].setLatLng(latLng).setIcon(icon).setPopupContent(popupContent);
                } else {
                    viewerDriverMarkers[driverLoc.id] = L.marker(latLng, { icon }).addTo(viewerMap).bindPopup(popupContent).on('click', () => focusViewerMapItem(driverLoc.id, 'driver'));
                }
                 if (!driverLoc.isStuck) bounds.extend(latLng);
            });
             Object.keys(viewerDriverMarkers).forEach(driverId => {
                 if (!viewerState.liveLocations[driverId]) {
                     if (viewerMap.hasLayer(viewerDriverMarkers[driverId])) viewerMap.removeLayer(viewerDriverMarkers[driverId]);
                     delete viewerDriverMarkers[driverId];
                 }
             });
            
            const activeMapOrders = viewerState.activeOrders.filter(o => o.latitude && o.longitude);
            Object.keys(viewerOrderMarkers).forEach(orderId => {
                if (!activeMapOrders.some(o => o.id == orderId)) {
                    if (viewerMap.hasLayer(viewerOrderMarkers[orderId])) viewerMap.removeLayer(viewerOrderMarkers[orderId]);
                    delete viewerOrderMarkers[orderId];
                }
            });
            activeMapOrders.forEach(order => {
                const latLng = [order.latitude, order.longitude];
                const customerName = order.customer?.name || '...';
                const displayId = order.orderNumber || `#${order.id.slice(-6)}`;
                 const typeInfo = orderTypeDetails[order.deliveryType] || orderTypeDetails['default'];
                const popupContent = `<h4>${typeInfo.icon} הזמנה ${displayId}</h4><p>${customerName}</p><p>${order.address || '...'}</p><p>סטטוס: ${order.status}</p>${order.driver?.name ? `<p>נהג: ${order.driver.name}</p>` : ''}<p id="popup-dist-${order.id}" class="font-semibold text-blue-600"></p>`;
                if (viewerOrderMarkers[order.id]) {
                    viewerOrderMarkers[order.id].setLatLng(latLng).setPopupContent(popupContent);
                } else {
                    viewerOrderMarkers[order.id] = L.marker(latLng, { icon: orderIconActive }).addTo(viewerMap).bindPopup(popupContent).on('click', () => focusViewerMapItem(order.id, 'order'));
                }
                bounds.extend(latLng);
            });
             if (bounds.isValid() && (activeMapOrders.length > 0 || Object.keys(viewerDriverMarkers).some(id => !viewerState.liveLocations[id]?.isStuck))) {
                 try { viewerMap.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 }); } catch (e) { console.warn("FitBounds error:", e); }
             } else if (!bounds.isValid()) {
                viewerMap.setView(ISRAEL_CENTER, 9); 
             }
        }
        
        // --- פונקציות דפים מלאים (ללא שינוי ברובן) ---
        function showFullPageView(viewId) {
            const el = document.getElementById(`fullpage-${viewId}`);
            if (el) { el.classList.add('active'); feather.replace(); }
        }
        function hideFullPageView(viewId) {
             const el = document.getElementById(`fullpage-${viewId}`);
             if (el) {
                el.classList.remove('active');
                feather.replace();
                // --- חדש: נתק מאזין צ'אט בסגירה ---
                if (viewId === 'chat-modal' && unsubscribeModalChat) {
                    unsubscribeModalChat();
                    unsubscribeModalChat = null;
                    SmartLog.info("Unsubscribed from chat listener", "Chat");
                }
             }
        }
        function showMaterialsPage() {
            SmartLog.info("Showing Materials Page", "UI.FullPage");
            showLoader('materials-orders-container', true);
            renderMaterialsPage();
            showFullPageView('materials');
        }
        function renderMaterialsPage() {
            const container = document.getElementById('materials-orders-container');
            if (!container) return;
            const materialWarehouses = ['מחסן החרש', 'מחסן התלמיד'];
            const materialsOrders = viewerState.allOrders.filter(o => materialWarehouses.includes(o.warehouse)).sort((a,b) => (a.orderDate ? new Date(a.orderDate) : 0) - (b.orderDate ? new Date(b.orderDate) : 0));
            if (materialsOrders.length === 0) { container.innerHTML = '<div class="text-center p-8 text-gray-500">לא נמצאו הזמנות.</div>'; return; }
            container.innerHTML = materialsOrders.map(order => createEnhancedOrderCard(order, true)).join('');
            showLoader('materials-orders-container', false);
            feather.replace();
        }
        function showContainersPage() {
            SmartLog.info("Attempting to show Containers Page", "UI.FullPage");
            const pass = prompt("נדרשת סיסמה:", "");
            if (pass === "1125") {
                SmartLog.info("Password correct", "UI.FullPage");
                showLoader('containers-orders-container', true);
                renderContainersPage();
                showFullPageView('containers');
            } else if (pass !== null) { SmartLog.warn("Password incorrect", "UI.FullPage"); alert("סיסמה שגויה."); }
        }
        function renderContainersPage() {
            const container = document.getElementById('containers-orders-container');
            if (!container) return;
            const materialWarehouses = ['מחסן החרש', 'מחסן התלמיד'];
            const containerOrders = viewerState.allOrders.filter(o => !materialWarehouses.includes(o.warehouse)).sort((a,b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
            if (containerOrders.length === 0) { container.innerHTML = '<div class="text-center p-8 text-gray-500">לא נמצאו הזמנות מכולה.</div>'; return; }
            container.innerHTML = containerOrders.map(order => createContainerOrderCard(order)).join('');
            showLoader('containers-orders-container', false);
            feather.replace();
        }
        function createContainerOrderCard(order) {
            const typeInfo = orderTypeDetails[order.deliveryType] || orderTypeDetails['default'];
            const customerName = order.customer?.name || '...';
            const address = order.address || '...';
            const displayId = order.orderNumber || `#${order.id.slice(-6)}`;
            const RENTAL_PERIOD_DAYS = 10;
            let daysPassed = 0, progressPercent = 0, isOvertime = false, createdDateStr = '...';
            if (order.createdAt && order.createdAt.toDate) {
                const createdMillis = order.createdAt.toDate().getTime();
                createdDateStr = new Date(createdMillis).toLocaleDateString('he-IL');
                daysPassed = (Date.now() - createdMillis) / (1000 * 60 * 60 * 24);
                progressPercent = Math.min(100, (daysPassed / RENTAL_PERIOD_DAYS) * 100);
                isOvertime = daysPassed > RENTAL_PERIOD_DAYS;
            }
            const daysDisplay = `${Math.floor(daysPassed)} / ${RENTAL_PERIOD_DAYS} ימים`;
            return `<div class="delivery-type-section"><div class="delivery-type-header delivery-type-isuf"><span>${typeInfo.icon}</span><span class="font-bold">${displayId}</span><span>${customerName}</span></div><div class="p-4"><div class="font-semibold text-gray-800">${address}</div><div class="text-sm text-gray-500 mb-3"><span>התחלה: ${createdDateStr}</span>${order.driver?.name ? ` | <span>נהג: ${order.driver.name}</span>` : ''}</div><div class="rental-progress-bar"><div class="progress" style="width: ${progressPercent}%; background-color: ${isOvertime ? '#ef4444' : 'var(--primary-color)'};"></div></div><div class="rental-days ${isOvertime ? 'overtime-flash' : ''}">${daysDisplay}</div></div></div>`;
        }
        function showReportsPage() {
            SmartLog.info("Showing Reports Page", "UI.FullPage");
            showFullPageView('reports');
            const endDate = new Date(), startDate = new Date();
            startDate.setDate(endDate.getDate() - 7);
            const startEl = document.getElementById('report-date-start'), endEl = document.getElementById('report-date-end');
            if (startEl && endEl) { startEl.value = startDate.toISOString().split('T')[0]; endEl.value = endDate.toISOString().split('T')[0]; }
            renderReports();
        }
        function renderReports() {
            SmartLog.info("Rendering Reports", "Reports");
            const startEl = document.getElementById('report-date-start'), endEl = document.getElementById('report-date-end');
            if (!startEl || !endEl || !startEl.value || !endEl.value) { showToast("נא לבחור תאריכי התחלה וסיום", "error"); return; }
            try {
                const startDate = new Date(startEl.value); startDate.setHours(0, 0, 0, 0);
                const endDate = new Date(endEl.value); endDate.setHours(23, 59, 59, 999);
                const filteredOrders = viewerState.allOrders.filter(o => { const orderTime = o.createdAt?.toDate ? o.createdAt.toDate().getTime() : 0; return orderTime >= startDate.getTime() && orderTime <= endDate.getTime(); });
                SmartLog.info(`Found ${filteredOrders.length} orders in range`, "Reports", {startDate, endDate});
                // טען מחדש את התוכן של הדוחות
                document.getElementById('reports-content-container').innerHTML = `
                    <div class="report-section"><h3>הזמנות לפי מחסן</h3><canvas id="report-chart-warehouse" height="250"></canvas></div>
                    <div class="report-section"><h3>הזמנות לאורך זמן</h3><canvas id="report-chart-time" height="250"></canvas></div>
                    <div class="report-section"><h3>לקוחות שקיבלו אספקה</h3><div id="report-list-customers"><div class="text-center p-4 text-gray-500">טוען נתונים...</div></div></div>`;
                renderWarehouseChart(filteredOrders);
                renderOrdersOverTimeChart(filteredOrders, startDate, endDate);
                renderCompletedCustomersList(filteredOrders);
            } catch (e) { SmartLog.error(e, "Reports.Render"); showToast(`שגיאה בהכנת הדוח: ${e.message}`, "error"); }
        }
        function renderWarehouseChart(orders) {
            const ctx = document.getElementById('report-chart-warehouse')?.getContext('2d'); if (!ctx) return;
            const warehouseCounts = orders.reduce((acc, order) => { const w = order.warehouse || 'לא ידוע'; acc[w] = (acc[w] || 0) + 1; return acc; }, {});
            if (reportChartWarehouse) reportChartWarehouse.destroy();
            reportChartWarehouse = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(warehouseCounts), datasets: [{ label: 'כמות הזמנות', data: Object.values(warehouseCounts), backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1 }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
        }
        function renderOrdersOverTimeChart(orders, startDate, endDate) {
            const ctx = document.getElementById('report-chart-time')?.getContext('2d'); if (!ctx) return;
            const ordersByDay = {}; let currentDate = new Date(startDate);
            while (currentDate <= endDate) { const dayStr = currentDate.toLocaleDateString('he-IL', {day: '2-digit', month: '2-digit'}); ordersByDay[dayStr] = 0; currentDate.setDate(currentDate.getDate() + 1); }
            orders.forEach(order => { const dayStr = order.createdAt.toDate().toLocaleDateString('he-IL', {day: '2-digit', month: '2-digit'}); if (ordersByDay.hasOwnProperty(dayStr)) ordersByDay[dayStr]++; });
            if (reportChartTime) reportChartTime.destroy();
            reportChartTime = new Chart(ctx, { type: 'line', data: { labels: Object.keys(ordersByDay), datasets: [{ label: 'הזמנות ליום', data: Object.values(ordersByDay), fill: false, borderColor: 'rgb(75, 192, 192)', tension: 0.1 }] }, options: { responsive: true } });
        }
        function renderCompletedCustomersList(orders) {
            const container = document.getElementById('report-list-customers'); if (!container) return;
            const completedOrders = orders.filter(o => o.status === 'הושלם');
            const uniqueCustomers = Array.from(new Set(completedOrders.map(o => o.customer?.name || '...'))).sort();
            if (uniqueCustomers.length === 0) { container.innerHTML = '<div class="text-center p-4 text-gray-500">לא סופקו הזמנות.</div>'; return; }
            container.innerHTML = uniqueCustomers.map(name => `<div class="customer-list-item">${name}</div>`).join('');
        }
        function showActiveListPage() {
            SmartLog.info("Showing Active List Page", "UI.FullPage");
            const container = document.getElementById('list-active-container'); container.innerHTML = '';
            if (viewerState.activeOrders.length === 0) { container.innerHTML = '<div class="text-center p-8 text-gray-500">אין הזמנות.</div>'; } 
            else { viewerState.activeOrders.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)).forEach(order => container.appendChild(createEnhancedOrderCard(order, true))); }
            showFullPageView('list-active');
        }
        function showCompletedTodayListPage() {
             SmartLog.info("Showing Completed Today List Page", "UI.FullPage");
            const container = document.getElementById('list-completed-today-container'); container.innerHTML = '';
            if (viewerState.completedTodayOrders.length === 0) { container.innerHTML = '<div class="text-center p-8 text-gray-500">אין הזמנות.</div>'; } 
            else { viewerState.completedTodayOrders.sort((a,b) => (b.lastModified?.toMillis() || 0) - (a.lastModified?.toMillis() || 0)).forEach(order => container.appendChild(createEnhancedOrderCard(order, true))); }
            showFullPageView('list-completed-today');
        }
        function showFutureListPage() {
             SmartLog.info("Showing Future List Page", "UI.FullPage");
            const container = document.getElementById('list-future-container'); container.innerHTML = '';
            if (viewerState.futureOrders.length === 0) { container.innerHTML = '<div class="text-center p-8 text-gray-500">אין הזמנות.</div>'; } 
            else { viewerState.futureOrders.sort((a,b) => (a.orderDate ? new Date(a.orderDate) : 0) - (b.orderDate ? new Date(b.orderDate) : 0)).forEach(order => container.appendChild(createEnhancedOrderCard(order, true))); }
            showFullPageView('list-future');
        }
        function createEnhancedOrderCard(order, showTime = false) {
            const typeInfo = orderTypeDetails[order.deliveryType] || orderTypeDetails['default'];
            const customerName = order.customer?.name || '...';
            const address = order.address || '...';
            const displayId = order.orderNumber || `#${order.id.slice(-6)}`;
            const createdTime = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '';
            const orderDate = order.orderDate ? new Date(order.orderDate).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' }) : '';
            return `<div class="enhanced-order-card ${typeInfo.className}"><div class="order-card-header"><div class="order-main-info"><div class="flex items-center gap-2 mb-1"><span class="font-bold text-lg">${displayId}</span><span class="order-type-icon text-xl">${typeInfo.icon}</span><span class="order-badge badge-status-${getStatusClass(order.status)}">${order.status}</span></div><div class="font-semibold text-gray-800">${customerName}</div><div class="text-gray-600 text-sm">${address}</div></div></div><div class="order-meta"><span>${order.warehouse || ''}</span>${showTime && orderDate ? `<span>📅 ${orderDate}</span>` : ''}${order.driver?.name ? `<span>👤 ${order.driver.name}</span>` : ''}</div></div>`;
        }
        function getStatusClass(status) {
            const statusMap = { 'חדש': 'new', 'שויך': 'assigned', 'בדרך': 'onway', 'הושלם': 'completed' };
            return statusMap[status] || '';
        }
        
        // --- UI INTERACTIONS ---
        window.filterViewerLists = filterViewerLists;
        function filterViewerLists() {
            const query = document.getElementById('viewer-search-input').value.toLowerCase();
            const activeList = document.querySelector('.panel-list.active');
            if (activeList) {
                const itemsToFilter = activeList.querySelectorAll('.order-card');
                itemsToFilter.forEach(card => {
                    const search = card.getAttribute('data-search') || '';
                    card.style.display = search.includes(query) ? 'block' : 'none';
                });
            }
        }
        function focusViewerMapItem(id, type) {
            let marker, card, listId;
             document.querySelectorAll('.order-card').forEach(c => c.classList.remove('active'));
            if (type === 'driver') {
                marker = viewerDriverMarkers[id];
            } else { 
                marker = viewerOrderMarkers[id];
                 card = document.getElementById(`viewer-order-card-${id}`);
                 listId = 'viewer-orders-active-list';
                const order = viewerState.activeOrders.find(o => o.id === id);
                const updatePopupDistance = (message) => {
                     if (marker && marker.getPopup()) {
                        const content = marker.getPopup().getContent();
                        const newContent = content.replace(/<p id="popup-dist-.*?".*?<\/p>/, `<p id="popup-dist-${id}" class="font-semibold text-blue-600">${message}</p>`);
                        marker.getPopup().setContent(newContent);
                     }
                };
                updatePopupDistance('...מחפש נהג');
                if (order && order.driver && order.driver.id) {
                    const driverLoc = viewerState.liveLocations[order.driver.id];
                    if (driverLoc && driverLoc.latitude && driverLoc.longitude) {
                        const dist = calculateDistance(driverLoc.latitude, driverLoc.longitude, order.latitude, order.longitude);
                        updatePopupDistance(dist ? `מרחק מהנהג: ${dist} ק"מ` : '...');
                    } else { updatePopupDistance('מיקום נהג לא זמין'); }
                } else { updatePopupDistance('אין נהג משויך'); }
            }
            if (marker) { viewerMap.setView(marker.getLatLng(), 15); marker.openPopup(); }
             if (card) { card.classList.add('active'); const listEl = document.getElementById(listId); if(listEl) { const cRect = listEl.getBoundingClientRect(); const eRect = card.getBoundingClientRect(); listEl.scrollTop += (eRect.top - cRect.top) - 10; }}
        }
        window.focusViewerMapItem = focusViewerMapItem;

        // --- HELPERS ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            if (!lat1 || !lon1 || !lat2 || !lon2) return null;
            const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); const d = R * c; return d.toFixed(1);
        }
        async function playNotificationSound(note = "C5", duration = "8n") {
            try {
                if (!window.Tone) { SmartLog.warn("Tone.js not loaded", "Notifications"); return; }
                await Tone.start(); const synth = new Tone.Synth().toDestination();
                synth.triggerAttackRelease(note, duration, Tone.now());
                 if (note !== "C5") { synth.triggerAttackRelease(note, duration, Tone.now() + 0.2); }
                SmartLog.info("Notification sound played.", 'Notifications');
            } catch (e) { SmartLog.error(e, "Notifications.Sound"); }
        }
        function showLoader(elementId, show) {
            const container = document.getElementById(elementId); if (!container) return;
            let loader = container.querySelector('.loader-container');
            if (show) {
                if (!loader && !container.querySelector('.loader')) { 
                    loader = document.createElement('div'); loader.className = 'loader-container'; loader.innerHTML = `<div class="loader"></div>`;
                    if (elementId !== 'viewer-map-loader') { container.prepend(loader); } else { container.style.display = 'flex'; }
                } else if (loader) { loader.style.display = 'flex'; }
            } else {
                if (loader) { loader.style.display = 'none'; }
                 if (elementId === 'viewer-map-loader') { container.style.display = 'none'; }
            }
        }
        function showToast(message, type = 'info') {
             console.log(`[Toast-${type.toUpperCase()}]: ${message}`);
            const container = document.getElementById('toast-container'); if (!container) { console.error("Toast container not found!"); return; }
            const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => { if (container.contains(toast)) container.removeChild(toast); }, 300);
            }, 5000); 
        }

        // --- ********** פונקציות חדשות לתקשורת ********** ---
        
        function updateMessageBadge() {
            const badge = document.getElementById('message-alert-badge');
            if (!badge) return;
            
            if (viewerState.unreadMessages.size > 0) {
                badge.classList.add('active');
                // badge.innerText = viewerState.unreadMessages.size; // אפשר להוסיף ספירה
            } else {
                badge.classList.remove('active');
            }
        }
        
        function showMessagesPage() {
            SmartLog.info("Showing Messages Page", "UI.FullPage.Messages");
            showFullPageView('messages');
            renderMessagesPage();
        }
        
        function renderMessagesPage() {
            const container = document.getElementById('message-list-container');
            if (!container) return;
            
            showLoader('message-list-container', false); // כבה טעינה אם הייתה
            
            if (viewerState.unreadMessages.size === 0) {
                container.innerHTML = '<div class="text-center p-8 text-gray-500">אין הודעות חדשות מלקוחות.</div>';
                return;
            }
            
            container.innerHTML = ''; // נקה
            viewerState.unreadMessages.forEach((msgInfo, orderId) => {
                // ניצור כרטיס דומה ל-enhanced-order-card
                const card = document.createElement('div');
                card.className = 'enhanced-order-card border-l-4 border-blue-500'; // הדגשה
                card.onclick = () => openChatModal(orderId, msgInfo.customerName);
                
                card.innerHTML = `
                    <div class="order-card-header">
                        <div class="order-main-info">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-lg">${msgInfo.customerName}</span>
                                <span class="order-badge badge-status-new">${msgInfo.count} הודעות חדשות</span>
                            </div>
                            <div class="text-gray-600 text-sm">הזמנה: ${msgInfo.orderId}</div>
                        </div>
                        <i data-feather="chevron-left" class="text-gray-400"></i>
                    </div>
                `;
                container.appendChild(card);
            });
            feather.replace();
        }
        
        async function openChatModal(orderId, customerName) {
            SmartLog.info(`Opening chat for order ${orderId}`, "Chat");
            
            // 1. סמן הודעות כנקראו
            await updateMessagesAsRead(orderId);
            
            // 2. הצג את מודל הצ'אט
            document.getElementById('chat-modal-title').innerText = `שיחה (לקוח: ${customerName})`;
            const chatButton = document.getElementById('admin-reply-button');
            // נקה מאזין קודם אם היה
            const newChatButton = chatButton.cloneNode(true);
            chatButton.parentNode.replaceChild(newChatButton, chatButton);
            newChatButton.onclick = () => sendAdminReply(orderId); // חבר את הכפתור להזמנה הנכונה
            
            showFullPageView('chat-modal');
            const chatHistoryEl = document.getElementById('chat-history-modal');
            chatHistoryEl.innerHTML = '<div class="loader-container"><div class="loader"></div></div>'; // הצג טעינה
            
            // 3. נתק מאזין קודם אם קיים
            if (unsubscribeModalChat) unsubscribeModalChat();
            
            // 4. האזן להודעות של הזמנה זו
            const q = query(
                collection(db, "orders", orderId, "messages"),
                orderBy("timestamp", "asc")
            );
            
            unsubscribeModalChat = onSnapshot(q, (snapshot) => {
                chatHistoryEl.innerHTML = ''; // נקה
                if (snapshot.empty) {
                    chatHistoryEl.innerHTML = '<p class="text-center text-gray-500">אין הודעות להזמנה זו.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    chatHistoryEl.appendChild(createMessageBubble(doc.data()));
                });
                // גלול לתחתית
                chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
            }, (error) => {
                SmartLog.error(error, "Chat.ListenFailed", { orderId });
                chatHistoryEl.innerHTML = '<p class="text-center text-red-500">שגיאה בטעינת הודעות.</p>';
            });
        }
        
        async function updateMessagesAsRead(orderId) {
            SmartLog.info(`Marking messages as read for order ${orderId}`, "Chat.Update");
            
            const q = query(
                collection(db, "orders", orderId, "messages"),
                where('type', '==', 'message_to_admin'),
                where('readByViewer', '==', false)
            );
            
            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) return; // אין מה לעדכן
                
                const batch = writeBatch(db);
                snapshot.docs.forEach(docRef => {
                    batch.update(docRef.ref, { readByViewer: true });
                });
                
                await batch.commit();
                SmartLog.info(`Marked ${snapshot.size} messages as read`, "Chat.Update");
            } catch (error) {
                SmartLog.error(error, "Chat.UpdateFailed", { orderId });
            }
        }
        
        function createMessageBubble(msg) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex flex-col';
            let bubbleClass = '';
            let senderName = '';
            
            if (msg.type === 'message_to_admin') {
                bubbleClass = 'chat-bubble chat-bubble-customer';
                senderName = msg.senderName || 'לקוח';
                wrapper.classList.add('items-end'); // ימין
            } else { // 'notification_to_customer'
                bubbleClass = 'chat-bubble chat-bubble-admin';
                senderName = msg.senderName || 'מנהל';
                wrapper.classList.add('items-start'); // שמאל
            }
            
            const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleString('he-IL') : '...';
            
            wrapper.innerHTML = `
                <div class="${bubbleClass}">
                    <strong class="block font-semibold">${senderName}</strong>
                    <p class="mt-1">${msg.text}</p>
                    <span class="chat-timestamp text-right mt-2">${time}</span>
                </div>
            `;
            return wrapper;
        }

        async function sendAdminReply(orderId) {
            const input = document.getElementById('admin-reply-text');
            const text = input.value.trim();
            if (!text || !orderId) return;

            const messageData = {
                text: text,
                senderName: "מנהל", // או שם המנהל אם יש
                timestamp: serverTimestamp(),
                type: 'notification_to_customer',
                readByViewer: true
            };

            try {
                const messagesColRef = collection(db, 'orders', orderId, 'messages');
                await addDoc(messagesColRef, messageData);
                input.value = ''; // נקה את התיבה
                SmartLog.info("Admin reply sent", "Chat.Send", { orderId });
            } catch (error) {
                SmartLog.error(error, "Chat.SendFailed", { orderId });
                showToast("שגיאה בשליחת התגובה", "error");
            }
        }

        // --- חשיפה גלובלית לפונקציות ---
        window.showMaterialsPage = showMaterialsPage;
        window.showContainersPage = showContainersPage;
        window.showReportsPage = showReportsPage;
        window.renderReports = renderReports;
        window.hideFullPageView = hideFullPageView;
        window.showActiveListPage = showActiveListPage;
        window.showCompletedTodayListPage = showCompletedTodayListPage;
        window.showFutureListPage = showFutureListPage;
        window.showMessagesPage = showMessagesPage; // --- חדש
        window.openChatModal = openChatModal; // --- חדש
        window.sendAdminReply = sendAdminReply; // --- חדש

    </script>
</body>
</html>
