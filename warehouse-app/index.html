<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מחסן - DeliveryMaster</title>
    <!-- 
       אפליקציית מחסן v1.0
       - יישום חלק 4, סעיף 3 באפיון
      - מאזין ל-onSnapshot לקולקציית 'orders'
      - מציג הזמנות שרלוונטיות למחסן (סטטוס "חדש", "בטיפול")
      - מאפשר למחסנאי לשנות סטטוס ל-"מוכן לטעינה"
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Rubik', sans-serif; background-color: #f1f5f9; }
        .order-card { background-color: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .btn-ready { background-color: #10b981; color: white; transition: background-color 0.2s; }
        .btn-ready:hover { background-color: #059669; }
        .btn-ready:disabled { background-color: #9ca3af; }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="flex justify-between items-center mb-6 pb-4 border-b">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">מערכת מחסן</h1>
            <p class="text-gray-600">הזמנות חדשות לליקוט</p>
        </div>
        <div id="auth-status" class="text-sm text-gray-500">
            <span id="auth-text">מתחבר...</span>
            <span id="ping-dot" class="inline-block w-3 h-3 bg-gray-400 rounded-full ml-2"></span>
        </div>
    </header>

    <main id="orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        <!-- Loader -->
        <div id="loader" class="text-center p-8 col-span-full">
            <p class="text-gray-500">טוען הזמנות רלוונטיות...</p>
        </div>
        <!-- Orders will be injected here -->
    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, query, where, orderBy, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", authDomain: "saban94-78949.firebaseapp.com", projectId: "saban94-78949",
          storageBucket: "saban94-78949.appspot.com",
          messagingSenderId: "41553157903", appId: "1:41553157903:web:cc33d2cff023be97a87a"
        };

        let db;
        
        // --- App Object ---
        const app = {
            init: () => {
                try {
                    const fbApp = initializeApp(firebaseConfig);
                    db = getFirestore(fbApp);
                    const auth = getAuth(fbApp);
                    
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            document.getElementById('auth-text').innerText = "מחובר";
                            document.getElementById('ping-dot').classList.replace('bg-gray-400', 'bg-green-500');
                            app.listenToWarehouseOrders();
                        } else {
                            signInAnonymously(auth);
                        }
                    });
                } catch (e) {
                    console.error("Firebase init failed", e);
                    document.getElementById('auth-text').innerText = "שגיאת התחברות";
                    document.getElementById('ping-dot').classList.replace('bg-gray-400', 'bg-red-500');
                }
            },
            
            listenToWarehouseOrders: () => {
                const container = document.getElementById('orders-container');
                const loader = document.getElementById('loader');
                
                // מאזין להזמנות שהסדרן אישר (בטיפול) או שהגיעו ישירות מהלקוח
                const relevantStatuses = ["חדש", "חדש (מלקוח)", "בטיפול"];
                
                const q = query(
                    collection(db, "orders"),
                    where("status", "in", relevantStatuses),
                    orderBy("createdAt", "asc")
                );

                onSnapshot(q, (snapshot) => {
                    loader.style.display = 'none';
                    
                    if (snapshot.empty) {
                        container.innerHTML = '<p class="text-center p-8 col-span-full text-gray-500">אין הזמנות חדשות שממתינות לליקוט.</p>';
                        return;
                    }
                    
                    container.innerHTML = ''; // Clear container
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const orderId = doc.id;
                        
                        const card = document.createElement('div');
                        card.className = "order-card flex flex-col p-4";
                        card.innerHTML = `
                            <div class="flex-grow">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-bold text-blue-600">${order.order_id || orderId.slice(-6)}</span>
                                    <span class="text-xs font-medium text-gray-500">${order.orderDate || new Date(order.createdAt?.seconds * 1000).toLocaleDateString('he-IL')}</span>
                                </div>
                                <h3 class="font-semibold text-lg text-gray-800">${order.customer?.name || 'לקוח לא ידוע'}</h3>
                                <p class="text-sm text-gray-600 mb-1">${order.projectName || 'ללא פרויקט'}</p>
                                <p class="text-sm text-gray-500 mb-3">${order.address || 'לא צוינה כתובת'}</p>
                                
                                <div class="bg-gray-50 p-3 rounded-md border max-h-32 overflow-y-auto">
                                    <pre class="text-sm text-gray-700 whitespace-pre-wrap font-sans">${order.notes || order.rawText || 'אין פירוט פריטים'}</pre>
                                </div>
                            </div>
                            
                            <button id="btn-${orderId}" class="btn-ready w-full font-bold py-3 px-4 rounded-md mt-4" onclick="app.markAsReady('${orderId}')">
                                <i data-feather="check-circle" class="inline-block w-5 h-5 ml-2"></i>
                                סמן כ"מוכן לטעינה"
                            </button>
                        `;
                        container.appendChild(card);
                    });
                    
                    feather.replace();
                    
                }, (error) => {
                    console.error("Error listening to orders:", error);
                    container.innerHTML = '<p class="text-center p-8 col-span-full text-red-500">שגיאה בטעינת הזמנות.</p>';
                });
            },
            
            markAsReady: async (orderId) => {
                const btn = document.getElementById(`btn-${orderId}`);
                if (!btn) return;
                
                btn.disabled = true;
                btn.innerText = "מעדכן...";
                
                try {
                    const orderRef = doc(db, "orders", orderId);
                    await updateDoc(orderRef, {
                        status: "מוכן לטעינה",
                        lastModified: serverTimestamp(),
                        warehouse_marked_at: serverTimestamp()
                    });
                    // ההאזנה תגרום לכרטיס להיעלם אוטומטית
                } catch (error) {
                    console.error("Failed to update status:", error);
                    alert("שגיאה בעדכון הסטטוס.");
                    btn.disabled = false;
                    btn.innerText = "סמן כ'מוכן לטעינה'";
                }
            }
        };

        window.app = app; // Expose to global scope for onclick events
        app.init();
    </script>
</body>
</html>
